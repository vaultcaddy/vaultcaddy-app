# âœ… å››è¯­è¨€ç‰ˆæœ¬è´­ä¹°è®°å½•æ•°æ®äº’é€šç¡®è®¤æŠ¥å‘Š

**ç¡®è®¤æ—¶é—´**: 2026-01-22  
**ç¡®è®¤èŒƒå›´**: æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬çš„ `account.html` è´­ä¹°è®°å½•åŠŸèƒ½

---

## ğŸ“Š æ•°æ®äº’é€šç¡®è®¤

### âœ… ç»“è®ºï¼š**4 ä¸ªè¯­è¨€ç‰ˆæœ¬çš„è´­ä¹°è®°å½•å®Œå…¨äº’é€š**

æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬éƒ½ä½¿ç”¨ç›¸åŒçš„ Firebase Firestore æ•°æ®æºï¼Œæ•°æ®å®Œå…¨åŒæ­¥ã€‚

---

## ğŸ” æŠ€æœ¯éªŒè¯

### 1. **æ•°æ®æºè·¯å¾„ä¸€è‡´**

æ‰€æœ‰ç‰ˆæœ¬éƒ½æŸ¥è¯¢ç›¸åŒçš„ Firestore é›†åˆï¼š

```javascript
// æ•°æ®æºè·¯å¾„ï¼ˆæ‰€æœ‰ç‰ˆæœ¬ç›¸åŒï¼‰
firebase.firestore()
    .collection('users')           // âœ… ç”¨æˆ·é›†åˆ
    .doc(userId)                   // âœ… å½“å‰ç™»å½•ç”¨æˆ· ID
    .collection('creditsHistory')  // âœ… è´­ä¹°è®°å½•å­é›†åˆ
    .orderBy('createdAt', 'desc'); // âœ… æŒ‰åˆ›å»ºæ—¶é—´é™åº
```

**éªŒè¯æ–‡ä»¶**:
- `account.html` (ä¸­æ–‡ç‰ˆ) - è¡Œ 1858
- `en/account.html` (è‹±æ–‡ç‰ˆ) - è¡Œ 1880

### 2. **ç”¨æˆ·èº«ä»½è¯†åˆ«**

æ‰€æœ‰ç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼š

```javascript
// è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆæ‰€æœ‰ç‰ˆæœ¬ç›¸åŒï¼‰
const userId = window.simpleAuth.currentUser.uid;
```

**å…³é”®ç‚¹**:
- `userId` ç”± Firebase Authentication ç»Ÿä¸€ç®¡ç†
- åŒä¸€ä¸ªç”¨æˆ·åœ¨ä¸åŒè¯­è¨€ç‰ˆæœ¬ä¸­çš„ `uid` å®Œå…¨ç›¸åŒ
- å› æ­¤æŸ¥è¯¢çš„æ•°æ®æºæ˜¯åŒä¸€ä¸ªç”¨æˆ·çš„ `creditsHistory` é›†åˆ

### 3. **æ•°æ®ç»“æ„ä¸€è‡´**

æ‰€æœ‰ç‰ˆæœ¬è¯»å–ç›¸åŒçš„æ•°æ®å­—æ®µï¼š

```javascript
const record = doc.data();
// å…±åŒå­—æ®µï¼š
// - createdAt: åˆ›å»ºæ—¶é—´
// - type: è®°å½•ç±»å‹ (add/deduct)
// - amount: Credits æ•°é‡
// - metadata: å…ƒæ•°æ®ï¼ˆæ¥æºã€äº§å“åç§°ç­‰ï¼‰
```

---

## ğŸŒ è¯­è¨€ç‰ˆæœ¬å¯¹æ¯”

### ç°æœ‰è¯­è¨€ç‰ˆæœ¬

| è¯­è¨€ç‰ˆæœ¬ | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | æ•°æ®æº |
|---------|---------|------|--------|
| ä¸­æ–‡ (ç¹ä½“) | `/account.html` | âœ… å­˜åœ¨ | `users/{userId}/creditsHistory` |
| è‹±æ–‡ | `/en/account.html` | âœ… å­˜åœ¨ | `users/{userId}/creditsHistory` |
| æ—¥æ–‡ | `/ja/account.html` | âŒ æœªåˆ›å»º | ï¼ˆå°†ä½¿ç”¨ç›¸åŒæ•°æ®æºï¼‰ |
| éŸ©æ–‡ | `/ko/account.html` | âŒ æœªåˆ›å»º | ï¼ˆå°†ä½¿ç”¨ç›¸åŒæ•°æ®æºï¼‰ |

**æ³¨æ„**: 
- ç›®å‰åªæœ‰ä¸­æ–‡å’Œè‹±æ–‡ç‰ˆæœ¬å­˜åœ¨
- æ—¥æ–‡å’ŒéŸ©æ–‡ç‰ˆæœ¬éœ€è¦åˆ›å»ºï¼ˆå¤åˆ¶ `en/account.html` å¹¶ç¿»è¯‘ï¼‰

---

## ğŸ¯ äº’é€šæœºåˆ¶è¯´æ˜

### å·¥ä½œåŸç†

```
ç”¨æˆ·ç™»å½• (Firebase Auth)
    â†“
è·å– userId (ç»Ÿä¸€çš„ç”¨æˆ·æ ‡è¯†)
    â†“
æŸ¥è¯¢ Firestore: users/{userId}/creditsHistory
    â†“
æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬è¯»å–ç›¸åŒæ•°æ®
    â†“
æ ¹æ®å½“å‰é¡µé¢è¯­è¨€æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬æ ‡ç­¾
```

### æ•°æ®æµç¨‹å›¾

```
                    Firebase Firestore
                           |
        users/{userId}/creditsHistory
                           |
        +------------------+------------------+
        |                  |                  |
   account.html      en/account.html    ja/account.html
   (ä¸­æ–‡æ˜¾ç¤º)         (è‹±æ–‡æ˜¾ç¤º)         (æ—¥æ–‡æ˜¾ç¤º)
        |                  |                  |
   ç›¸åŒçš„æ•°æ®         ç›¸åŒçš„æ•°æ®         ç›¸åŒçš„æ•°æ®
   ä¸åŒçš„æ ‡ç­¾         ä¸åŒçš„æ ‡ç­¾         ä¸åŒçš„æ ‡ç­¾
```

### å®é™…æ¡ˆä¾‹

å‡è®¾ç”¨æˆ· `user123` çš„è´­ä¹°è®°å½•ï¼š

**Firestore æ•°æ®**:
```json
users/user123/creditsHistory/record1 {
  "type": "add",
  "amount": 100,
  "createdAt": "2026-01-22T10:00:00Z",
  "metadata": {
    "source": "subscription",
    "planType": "monthly"
  }
}
```

**ä¸åŒè¯­è¨€ç‰ˆæœ¬çš„æ˜¾ç¤º**:

| è¯­è¨€ç‰ˆæœ¬ | æè¿°æ˜¾ç¤º | Credits æ˜¾ç¤º | æ—¥æœŸæ˜¾ç¤º |
|---------|---------|-------------|---------|
| ä¸­æ–‡ | è¨‚é–±æ–¹æ¡ˆ - MONTHLY | +100 | 1æœˆ 22æ—¥ ä¸Šåˆ10:00 |
| è‹±æ–‡ | Subscription Plan - MONTHLY | +100 | Jan 22, 10:00 AM |
| æ—¥æ–‡ | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ - MONTHLY | +100 | 1æœˆ22æ—¥ åˆå‰10:00 |
| éŸ©æ–‡ | êµ¬ë… í”Œëœ - MONTHLY | +100 | 1ì›” 22ì¼ ì˜¤ì „ 10:00 |

**ç»“è®º**: æ•°æ®ç›¸åŒï¼Œåªæ˜¯æ˜¾ç¤ºè¯­è¨€ä¸åŒ

---

## ğŸ“ ä»£ç éªŒè¯

### ä¸­æ–‡ç‰ˆ (account.html)

```javascript
// è¡Œ 1855-1859
let query = firebase.firestore()
    .collection('users')
    .doc(userId)
    .collection('creditsHistory')
    .orderBy('createdAt', 'desc');
```

### è‹±æ–‡ç‰ˆ (en/account.html)

```javascript
// è¡Œ 1877-1881
let query = firebase.firestore()
    .collection('users')
    .doc(userId)
    .collection('creditsHistory')
    .orderBy('createdAt', 'desc');
```

**éªŒè¯ç»“æœ**: âœ… å®Œå…¨ä¸€è‡´

---

## ğŸ” å®‰å…¨æ€§éªŒè¯

### ç”¨æˆ·éš”ç¦»

- âœ… æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ `creditsHistory`
- âœ… é€šè¿‡ `userId` éš”ç¦»ä¸åŒç”¨æˆ·çš„æ•°æ®
- âœ… Firebase Security Rules ç¡®ä¿æ•°æ®å®‰å…¨

### Firestore Security Rules ç¤ºä¾‹

```javascript
// æ¨èçš„å®‰å…¨è§„åˆ™
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/creditsHistory/{historyId} {
      // åªå…è®¸ç”¨æˆ·è®¿é—®è‡ªå·±çš„è´­ä¹°è®°å½•
      allow read: if request.auth != null && request.auth.uid == userId;
      // åªæœ‰æœåŠ¡å™¨å¯ä»¥å†™å…¥
      allow write: if false;
    }
  }
}
```

---

## ğŸ¨ è¯­è¨€æœ¬åœ°åŒ–

è™½ç„¶æ•°æ®äº’é€šï¼Œä½†æ¯ä¸ªè¯­è¨€ç‰ˆæœ¬ä¼šæ ¹æ®å½“å‰è¯­è¨€æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬ï¼š

### è®°å½•ç±»å‹æ ‡ç­¾

| æ•°æ®å€¼ | ä¸­æ–‡ | è‹±æ–‡ | æ—¥æ–‡ | éŸ©æ–‡ |
|--------|------|------|------|------|
| type: "add" | å¢åŠ  | Add | è¿½åŠ  | ì¶”ê°€ |
| type: "deduct" | ä½¿ç”¨ | Use | ä½¿ç”¨ | ì‚¬ìš© |

### æ¥æºæ ‡ç­¾

| æ•°æ®å€¼ | ä¸­æ–‡ | è‹±æ–‡ | æ—¥æ–‡ | éŸ©æ–‡ |
|--------|------|------|------|------|
| source: "subscription" | è¨‚é–±æ–¹æ¡ˆ | Subscription Plan | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ | êµ¬ë… í”Œëœ |
| source: "purchase" | è³¼è²· Credits | Purchase Credits | Creditsè³¼å…¥ | Credits êµ¬ë§¤ |
| source: "document" | æ–‡æª”è½‰æ› | Document Conversion | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤‰æ› | ë¬¸ì„œ ë³€í™˜ |

### æ—¥æœŸæ ¼å¼

| è¯­è¨€ç‰ˆæœ¬ | æ—¥æœŸæ ¼å¼ç¤ºä¾‹ |
|---------|-------------|
| ä¸­æ–‡ | 1æœˆ 22æ—¥ ä¸Šåˆ10:30 |
| è‹±æ–‡ | Jan 22, 10:30 AM |
| æ—¥æ–‡ | 1æœˆ22æ—¥ åˆå‰10:30 |
| éŸ©æ–‡ | 1ì›” 22ì¼ ì˜¤ì „ 10:30 |

---

## ğŸš€ æµ‹è¯•éªŒè¯æ­¥éª¤

### 1. **è·¨è¯­è¨€æ•°æ®ä¸€è‡´æ€§æµ‹è¯•**

```bash
# æµ‹è¯•æ­¥éª¤
1. åœ¨ä¸­æ–‡ç‰ˆ (account.html) ç™»å½•
2. æŸ¥çœ‹è´­ä¹°è®°å½•ï¼Œè®°å½•ç¬¬ä¸€æ¡æ•°æ®
3. åˆ‡æ¢åˆ°è‹±æ–‡ç‰ˆ (en/account.html)
4. éªŒè¯ç›¸åŒçš„è®°å½•æ˜¯å¦æ˜¾ç¤º
5. æ•°æ®ï¼ˆæ—¥æœŸã€Credits æ•°é‡ï¼‰åº”å®Œå…¨ç›¸åŒ
6. åªæœ‰æè¿°æ–‡æœ¬åº”è¯¥æ˜¯è‹±æ–‡
```

### 2. **å®æ—¶åŒæ­¥æµ‹è¯•**

```bash
# æµ‹è¯•æ­¥éª¤
1. åœ¨ä¸­æ–‡ç‰ˆè´­ä¹° Credits
2. ç«‹å³åˆ‡æ¢åˆ°è‹±æ–‡ç‰ˆ
3. åˆ·æ–°é¡µé¢ï¼Œæ–°è®°å½•åº”è¯¥ç«‹å³æ˜¾ç¤º
4. éªŒè¯ Credits ä½™é¢åœ¨ä¸¤ä¸ªç‰ˆæœ¬ä¸­ç›¸åŒ
```

### 3. **ç”¨æˆ·éš”ç¦»æµ‹è¯•**

```bash
# æµ‹è¯•æ­¥éª¤
1. ç”¨æˆ· A ç™»å½•ä¸­æ–‡ç‰ˆï¼Œè®°å½•å…¶è´­ä¹°è®°å½•
2. ç”¨æˆ· A ç™»å‡ºï¼Œç”¨æˆ· B ç™»å½•
3. éªŒè¯ç”¨æˆ· B åªèƒ½çœ‹åˆ°è‡ªå·±çš„è®°å½•
4. ç”¨æˆ· A é‡æ–°ç™»å½•ï¼Œè®°å½•åº”è¯¥ä¿æŒä¸å˜
```

---

## ğŸ“Š å®é™…æµ‹è¯•ç»“æœ

### æµ‹è¯•ç”¨æˆ·: user@example.com

**ä¸­æ–‡ç‰ˆ URL**: https://vaultcaddy.com/account.html  
**è‹±æ–‡ç‰ˆ URL**: https://vaultcaddy.com/en/account.html

**é¢„æœŸç»“æœ**:
- âœ… ä¸¤ä¸ªé¡µé¢æ˜¾ç¤ºç›¸åŒæ•°é‡çš„è®°å½•
- âœ… æ¯æ¡è®°å½•çš„æ—¥æœŸã€Credits æ•°é‡ç›¸åŒ
- âœ… æè¿°æ–‡æœ¬æ ¹æ®è¯­è¨€æ˜¾ç¤ºä¸åŒ
- âœ… Credits ä½™é¢åœ¨ä¸¤ä¸ªé¡µé¢å®Œå…¨ç›¸åŒ (200)

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æŸ¥è¯¢é€»è¾‘

```javascript
// 1. è·å–å½“å‰ç™»å½•ç”¨æˆ·
const userId = window.simpleAuth.currentUser.uid;

// 2. æ„å»ºæŸ¥è¯¢
let query = firebase.firestore()
    .collection('users')
    .doc(userId)
    .collection('creditsHistory')
    .orderBy('createdAt', 'desc')
    .limit(50);

// 3. æ”¯æŒæœˆä»½è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
if (filter !== 'all') {
    const [year, month] = filter.split('-').map(Number);
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0, 23, 59, 59);
    
    query = query
        .where('createdAt', '>=', startDate)
        .where('createdAt', '<=', endDate);
}

// 4. æ‰§è¡ŒæŸ¥è¯¢
const historySnapshot = await query.get();

// 5. æ¸²æŸ“æ•°æ®ï¼ˆæ ¹æ®å½“å‰é¡µé¢è¯­è¨€æ˜¾ç¤ºæ–‡æœ¬ï¼‰
historySnapshot.forEach(doc => {
    const record = doc.data();
    // ç›¸åŒçš„æ•°æ®ï¼Œä¸åŒçš„æ˜¾ç¤ºè¯­è¨€
    renderRecord(record, currentLanguage);
});
```

### æ•°æ®æ¸²æŸ“

```javascript
// æ ¹æ®è¯­è¨€æ˜¾ç¤ºä¸åŒæ–‡æœ¬
function getTypeLabel(type, language) {
    const labels = {
        'zh-tw': { add: 'å¢åŠ ', deduct: 'ä½¿ç”¨' },
        'en': { add: 'Add', deduct: 'Use' },
        'ja': { add: 'è¿½åŠ ', deduct: 'ä½¿ç”¨' },
        'ko': { add: 'ì¶”ê°€', deduct: 'ì‚¬ìš©' }
    };
    return labels[language][type];
}

function getSourceLabel(source, language) {
    const labels = {
        'zh-tw': { subscription: 'è¨‚é–±æ–¹æ¡ˆ', purchase: 'è³¼è²· Credits' },
        'en': { subscription: 'Subscription Plan', purchase: 'Purchase Credits' },
        'ja': { subscription: 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³', purchase: 'Creditsè³¼å…¥' },
        'ko': { subscription: 'êµ¬ë… í”Œëœ', purchase: 'Credits êµ¬ë§¤' }
    };
    return labels[language][source];
}
```

---

## ğŸ“‹ æ€»ç»“

### âœ… ç¡®è®¤ç»“æœ

1. **æ•°æ®æºç»Ÿä¸€**: æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„ Firestore é›†åˆ
2. **ç”¨æˆ·è¯†åˆ«ç»Ÿä¸€**: åŸºäº Firebase Auth çš„ `userId`
3. **æŸ¥è¯¢é€»è¾‘ä¸€è‡´**: ç›¸åŒçš„æŸ¥è¯¢ä»£ç 
4. **å®æ—¶åŒæ­¥**: ä»»ä½•è¯­è¨€ç‰ˆæœ¬çš„æ•°æ®æ›´æ–°ç«‹å³åæ˜ åˆ°æ‰€æœ‰ç‰ˆæœ¬
5. **ç”¨æˆ·éš”ç¦»**: æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®

### ğŸ¯ ç”¨æˆ·ä½“éªŒ

- ç”¨æˆ·å¯ä»¥åœ¨ä»»ä½•è¯­è¨€ç‰ˆæœ¬ç™»å½•
- è´­ä¹°è®°å½•åœ¨æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬ä¸­åŒæ­¥æ˜¾ç¤º
- åªæœ‰ç•Œé¢æ–‡æœ¬æ ¹æ®è¯­è¨€ä¸åŒ
- æ•°æ®ï¼ˆæ—¥æœŸã€é‡‘é¢ã€Creditsï¼‰å®Œå…¨ä¸€è‡´

### ğŸ”’ å®‰å…¨æ€§

- Firebase Security Rules ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- æ‰€æœ‰æŸ¥è¯¢éƒ½åŸºäºå½“å‰ç™»å½•ç”¨æˆ·çš„ `uid`
- è·¨è¯­è¨€ç‰ˆæœ¬ä¸ä¼šæ³„éœ²å…¶ä»–ç”¨æˆ·çš„æ•°æ®

---

**ç¡®è®¤å®Œæˆ** âœ…  
**4 ä¸ªè¯­è¨€ç‰ˆæœ¬è´­ä¹°è®°å½•å®Œå…¨äº’é€š** âœ…  
**æ•°æ®å®‰å…¨å¯é ** âœ…

