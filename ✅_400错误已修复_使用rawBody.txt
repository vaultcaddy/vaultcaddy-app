# âœ… 400é”™è¯¯å·²ä¿®å¤ - ä½¿ç”¨ req.rawBody

## ğŸ¯ **é—®é¢˜æ ¹æº**

Firebase Functions (1st Gen) è‡ªåŠ¨å°† JSON è¯·æ±‚ä½“è§£ææˆ JavaScript Objectï¼Œå¯¼è‡´ Stripe ç­¾åéªŒè¯å¤±è´¥ï¼Œå› ä¸ºç­¾åéªŒè¯éœ€è¦åŸå§‹çš„æœªè§£æçš„è¯·æ±‚ä½“ï¼ˆBufferï¼‰ã€‚

**é”™è¯¯æ—¥å¿—**ï¼š
```
ğŸ“¦ Payload type: Object
ğŸ“¦ Payload length: undefined
âŒ Webhook payload must be provided as a string or a Buffer
```

---

## ğŸ”§ **è§£å†³æ–¹æ¡ˆ**

### **ä½¿ç”¨ `req.rawBody`**

Firebase Functions åœ¨å†…éƒ¨ä¿ç•™äº†åŸå§‹è¯·æ±‚ä½“çš„å‰¯æœ¬åœ¨ `req.rawBody` ä¸­ã€‚æˆ‘å·²ç»æ›´æ–°ä»£ç ä½¿ç”¨è¿™ä¸ªï¼š

```javascript
exports.stripeWebhook = functions.https.onRequest(async (req, res) => {
    const sig = req.headers['stripe-signature'];
    // Use req.rawBody which is available in Firebase Functions
    const payload = req.rawBody || req.body;
    
    console.log('ğŸ“¦ Payload type:', payload ? payload.constructor.name : 'undefined');
    console.log('ğŸ“¦ Payload length:', payload ? payload.length : 0);
    
    // Now Stripe can verify the signature
    event = stripe.webhooks.constructEvent(payload, sig, stripeConfig.webhook_secret);
    // ...
});
```

**ä¸ºä»€ä¹ˆè¿™æ ·æœ‰æ•ˆ**ï¼š
- Firebase Functions åœ¨è§£æ JSON ä¹‹å‰ä¼šå°†åŸå§‹è¯·æ±‚ä½“ä¿å­˜åˆ° `req.rawBody`
- `req.rawBody` æ˜¯ä¸€ä¸ª Bufferï¼Œæ­£æ˜¯ Stripe ç­¾åéªŒè¯æ‰€éœ€è¦çš„
- ç­¾åéªŒè¯ç°åœ¨åº”è¯¥ä¼šæˆåŠŸ

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

è¯·è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜ï¼š

1. **åˆ·æ–°** https://vaultcaddy.com/billing.html
2. **ç‚¹å‡»** "ğŸ§ª æ¸¬è©¦ Get Started"
3. **ä½¿ç”¨æµ‹è¯•å¡**ï¼š`4242 4242 4242 4242`
4. **å®Œæˆæ”¯ä»˜**

---

## âœ… **é¢„æœŸç»“æœ**

è¿™æ¬¡åº”è¯¥ä¼šæˆåŠŸï¼š

- âœ… **Webhook ä¸å†è¿”å› 400 é”™è¯¯**
- âœ… **ç­¾åéªŒè¯æˆåŠŸ**
- âœ… **Credits ä» 0 å¢åŠ åˆ° 1200**
- âœ… **Plan ä» "Free Plan" å˜ä¸º "Pro Plan"**
- âœ… **Stripe Webhook æ˜¾ç¤ºæˆåŠŸ**

---

## ğŸ“Š **æŠ€æœ¯ç»†èŠ‚**

### **ä¹‹å‰çš„é—®é¢˜**
- å°è¯•ä½¿ç”¨ Express.js çš„ `express.raw()` ä¸­é—´ä»¶
- Firebase Functions åœ¨æˆ‘ä»¬çš„ä»£ç è¿è¡Œä¹‹å‰å°±è§£æäº†è¯·æ±‚ä½“
- `req.body` å·²ç»æ˜¯ä¸€ä¸ª Objectï¼Œä¸æ˜¯ Buffer

### **å½“å‰è§£å†³æ–¹æ¡ˆ**
- ä½¿ç”¨ Firebase Functions å†…ç½®çš„ `req.rawBody`
- è¿™æ˜¯ Firebase Functions (1st Gen) æä¾›çš„åŸå§‹è¯·æ±‚ä½“å‰¯æœ¬
- å®Œå…¨ç¬¦åˆ Stripe çš„ç­¾åéªŒè¯è¦æ±‚

### **ä¸ºä»€ä¹ˆæ²¡æœ‰å‡çº§åˆ° v2**
- Firebase ä¸æ”¯æŒä» 1st Gen ç›´æ¥å‡çº§åˆ° 2nd Gen
- éœ€è¦å…ˆåˆ é™¤æ—§å‡½æ•°ï¼Œä¼šå¯¼è‡´åœæœºæ—¶é—´
- ä½¿ç”¨ `req.rawBody` æ˜¯æ›´å®‰å…¨ã€æ›´å¿«é€Ÿçš„è§£å†³æ–¹æ¡ˆ

---

## ğŸ” **å¦‚ä½•éªŒè¯**

### 1. è¿›è¡Œæµ‹è¯•æ”¯ä»˜

### 2. æ£€æŸ¥ Stripe Dashboard
- è¿›å…¥ Stripe Test Mode
- æŸ¥çœ‹ Webhooks é¡µé¢
- åº”è¯¥çœ‹åˆ° 200 æˆåŠŸçŠ¶æ€ï¼Œè€Œä¸æ˜¯ 400 é”™è¯¯

### 3. æ£€æŸ¥ Firebase ç”¨æˆ·æ•°æ®
- è¿›å…¥ Firebase Console
- æ£€æŸ¥ç”¨æˆ·çš„ `credits` å­—æ®µ
- åº”è¯¥ä» 0 å¢åŠ åˆ° 1200

### 4. æ£€æŸ¥ Firebase Functions æ—¥å¿—
```bash
firebase functions:log
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… ç”Ÿäº§æ¨¡å¼webhookç­¾åéªŒè¯æˆåŠŸ
æˆ–
âœ… æµ‹è¯•æ¨¡å¼webhookç­¾åéªŒè¯æˆåŠŸ
```

---

## ğŸ“ **éƒ¨ç½²æ—¶é—´**

- **éƒ¨ç½²å®Œæˆæ—¶é—´**ï¼š2025-12-11 12:17 (UTC)
- **å‡½æ•° URL**ï¼šhttps://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook

---

## ğŸ‰ **æ€»ç»“**

ä½¿ç”¨ `req.rawBody` æ˜¯åœ¨ Firebase Functions (1st Gen) ä¸­å¤„ç† Stripe Webhook çš„æœ€ä½³å®è·µã€‚è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼š

âœ… **ä¿ç•™äº†ç­¾åéªŒè¯** - å®‰å…¨æ€§å¾—åˆ°ä¿éšœ
âœ… **ç®€å•å¯é ** - ä¸éœ€è¦å¤æ‚çš„ Express é…ç½®
âœ… **æ— éœ€å‡çº§** - é¿å…äº†å‡çº§åˆ° v2 çš„å¤æ‚æ€§
âœ… **é›¶åœæœº** - ç›´æ¥æ›´æ–°ç°æœ‰å‡½æ•°

è¯·ç«‹å³æµ‹è¯•å¹¶åé¦ˆç»“æœï¼

