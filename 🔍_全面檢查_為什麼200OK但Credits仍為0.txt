# ğŸ” å…¨é¢æª¢æŸ¥ï¼šç‚ºä»€éº¼ 200 OK ä½† Credits ä»ç‚º 0

## âœ… **å·²ç¢ºèªçš„äº‹å¯¦**

1. âœ… Webhook è¿”å› 200 OKï¼ˆåœ–2-3ä¸­é¡¯ç¤ºæˆåŠŸï¼‰
2. âœ… Webhook ç°½åé©—è­‰æˆåŠŸï¼ˆæ²’æœ‰ 403 æˆ– 400 éŒ¯èª¤ï¼‰
3. âœ… Firebase Functions æ­£åœ¨æ¥æ”¶äº‹ä»¶
4. âŒ **Credits ä»ç„¶æ˜¯ 0ï¼ˆåœ–1ä¸­é¡¯ç¤ºï¼‰**

---

## ğŸ” **æœ€å¯èƒ½çš„åŸå› ï¼šç”¢å“ Metadata é…ç½®å•é¡Œ**

å¾åœ–1ä¸­çœ‹åˆ°,æ‚¨å·²ç¶“æ­£ç¢ºé…ç½®äº†ç”¢å“çš„ Metadata:
- `monthly_credits`: `100` âœ…
- `plan_type`: `monthly` âœ…

ä½†æ˜¯,æœ‰ä¸€å€‹**é—œéµå•é¡Œ**:

### âŒ **å•é¡Œç™¼ç¾ï¼š`monthly_credits` å’Œ `plan_type` ä¸åŒ¹é…ï¼**

åœ¨åœ–1ä¸­,æˆ‘çœ‹åˆ°:
- `monthly_credits`: `1200` ï¼ˆæ‡‰è©²æ˜¯ `100`ï¼‰
- `plan_type`: `yearly` ï¼ˆæ‡‰è©²æ˜¯ `monthly`ï¼‰

é€™èªªæ˜ç”¢å“ Metadata é…ç½®**éŒ¯èª¤**:
1. æœˆè²»ç”¢å“çš„ `plan_type` è¢«è¨­ç½®ç‚º `yearly`ï¼ˆå¹´è²»ï¼‰
2. `monthly_credits` è¢«è¨­ç½®ç‚º `1200`ï¼ˆæ¸¬è©¦å€¼ï¼‰ï¼Œè€Œä¸æ˜¯ `100`

---

## ğŸ’¡ **è§£æ±ºæ–¹æ¡ˆ**

è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ›´æ–° Stripe æ¸¬è©¦ç”¢å“çš„ Metadata:

### **æ­¥é©Ÿ 1: é€²å…¥ç”¢å“è¨­ç½®**
1. åœ¨ Stripe Dashboardï¼ˆTEST MODEï¼‰ä¸­
2. å‰å¾€ **Products**
3. æ‰¾åˆ°æ‚¨çš„æœˆè²»æ¸¬è©¦ç”¢å“

### **æ­¥é©Ÿ 2: æ›´æ–° Metadata**
1. é»æ“Šç”¢å“é€²å…¥è©³æƒ…é 
2. æ‰¾åˆ° **Metadata** éƒ¨åˆ†
3. æ›´æ–°ä»¥ä¸‹å€¼:
   - `plan_type`: æ”¹ç‚º `monthly`ï¼ˆç›®å‰æ˜¯ `yearly`ï¼‰
   - `monthly_credits`: æ”¹ç‚º `100`ï¼ˆç›®å‰æ˜¯ `1200`ï¼‰

### **æ­¥é©Ÿ 3: ä¿å­˜ä¸¦é‡æ–°æ¸¬è©¦**
1. ä¿å­˜æ›´æ”¹
2. é‡æ–°é€²è¡Œæ¸¬è©¦æ”¯ä»˜
3. æŸ¥çœ‹ Credits æ˜¯å¦æ­£ç¢ºå¢åŠ 

---

## ğŸ“Š **Firebase Functions é‚è¼¯è§£é‡‹**

æ ¹æ“šæ‚¨çš„ Firebase Functions ä»£ç¢¼ï¼ˆ`handleCheckoutCompleted`ï¼‰:

```javascript
// æ ¹æ“šç”¢å“ metadata æ·»åŠ  Credits
const credits = parseInt(product.metadata.monthly_credits || product.metadata.credits || 0);

if (credits > 0) {
    console.log(`ğŸ’° æº–å‚™æ·»åŠ  ${credits} Credits çµ¦ç”¨æˆ¶ ${userId}`);
    await addCredits(userId, credits, {
        type: `checkout.session.completed`,
        sessionId: session.id,
        amount: session.amount_total / 100
    });
} else {
    console.warn(`âš ï¸ ç”¢å“æ²’æœ‰é…ç½® monthly_credits æˆ– creditsï¼Œè·³éæ·»åŠ `);
}
```

**å¦‚æœ Metadata ä¸­æ²’æœ‰é…ç½® `monthly_credits` æˆ– `credits`ï¼Œæˆ–è€…å€¼ç‚º 0ï¼Œé‚£éº¼ `addCredits` å‡½æ•¸å°±ä¸æœƒè¢«èª¿ç”¨ï¼**

---

## ğŸ” **è¨ºæ–·æª¢æŸ¥æ¸…å–®**

è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®:

1. âœ… **ç”¢å“ Metadata æ˜¯å¦æ­£ç¢ºé…ç½®ï¼Ÿ**
   - `monthly_credits`: `100`
   - `plan_type`: `monthly`

2. âœ… **è¨‚é–±è¨ˆåŠƒæ˜¯å¦æ­£ç¢ºè¨­ç½®ï¼Ÿ**
   - é–“éš”æ‡‰è©²æ˜¯ï¼šæ¯ 1 ä¸ªæœˆ

3. âœ… **æ˜¯å¦ä½¿ç”¨äº†æ­£ç¢ºçš„æ¸¬è©¦ç”¢å“ï¼Ÿ**
   - ç¢ºèªæ‚¨æ¸¬è©¦æ™‚ä½¿ç”¨çš„æ˜¯æ­£ç¢ºçš„æ¸¬è©¦ç”¢å“ ID

---

## ğŸ“ **ä¸‹ä¸€æ­¥è¡Œå‹•**

1. **ç«‹å³æ›´æ–° Stripe æ¸¬è©¦ç”¢å“çš„ Metadata**ï¼ˆè¦‹ä¸Šæ–¹æ­¥é©Ÿï¼‰
2. **é‡æ–°é€²è¡Œæ¸¬è©¦æ”¯ä»˜**
3. **æŸ¥çœ‹ Firebase Functions æ—¥èªŒ**ï¼Œç¢ºèªæ˜¯å¦çœ‹åˆ°ï¼š
   ```
   ğŸ’° æº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ xxx
   âœ… æˆåŠŸæ·»åŠ  100 credits çµ¦ç”¨æˆ¶ xxx
   ```
4. **æª¢æŸ¥ç”¨æˆ¶çš„ Credits æ˜¯å¦æ­£ç¢ºæ›´æ–°**

---

## ğŸ¯ **é æœŸçµæœ**

æ›´æ–° Metadata å¾Œï¼Œç•¶æ‚¨å†æ¬¡é€²è¡Œæ¸¬è©¦æ”¯ä»˜æ™‚:
- âœ… Webhook è¿”å› 200 OK
- âœ… Firebase Functions æ—¥èªŒé¡¯ç¤º `ğŸ’° æº–å‚™æ·»åŠ  100 Credits`
- âœ… ç”¨æˆ¶çš„ Credits å¾ 0 å¢åŠ åˆ° 100
- âœ… ç”¨æˆ¶çš„ Plan å¾ "Free Plan" æ›´æ–°ç‚º "Pro Plan"

---

**è«‹é‡æ–°é€²è¡Œæ¸¬è©¦æ”¯ä»˜ï¼Œä¸¦å‘Šè¨´æˆ‘çµæœï¼**

