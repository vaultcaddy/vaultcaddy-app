# ğŸš¨ ç´§æ€¥æ’æŸ¥ï¼šCredits æœªå¢åŠ 

## âœ… **å·²ç¡®è®¤çš„é…ç½®**
1. âœ… Stripe äº§å“ Metadata å·²é…ç½®ï¼š
   - `monthly_credits`: `100`
   - `plan_type`: `monthly`
2. âœ… Webhook è¿”å› 200 OK
3. âœ… ä»£ç å·²ä¿®å¤ï¼ˆ500 é”™è¯¯å·²è§£å†³ï¼‰
4. âŒ Credits ä»ç„¶æ˜¯ 0

---

## ğŸ” **æœ€å¯èƒ½çš„åŸå› ï¼šWebhook æ²¡æœ‰è¢«è§¦å‘**

### **æ£€æŸ¥ 1ï¼šWebhook ç«¯ç‚¹æ˜¯å¦æ­£ç¡®ï¼Ÿ**

è¯·ç¡®è®¤æµ‹è¯•æ¨¡å¼çš„ Webhook ç«¯ç‚¹ URL æ˜¯å¦ä¸ºï¼š
```
https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook
```

**å¦‚ä½•æ£€æŸ¥ï¼š**
1. æ‰“å¼€ Stripe Dashboardï¼ˆTEST MODEï¼‰
2. å‰å¾€ **Developers** â†’ **Webhooks**
3. æ‰¾åˆ°æ‚¨çš„æµ‹è¯• Webhook
4. ç¡®è®¤ **ç«¯ç‚¹ URL** æ˜¯ä¸Šé¢çš„åœ°å€

---

## ğŸ” **æ£€æŸ¥ 2ï¼šFirebase Functions æ˜¯å¦æ”¶åˆ° Webhookï¼Ÿ**

### **æ–¹æ³• 1ï¼šæŸ¥çœ‹ Firebase Console æ—¥å¿—**
1. æ‰“å¼€ Firebase Console: https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions
2. ç‚¹å‡» **Logs** æ ‡ç­¾
3. æŸ¥æ‰¾æœ€è¿‘çš„ **stripeWebhook** å‡½æ•°è°ƒç”¨
4. æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
   - `ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: checkout.session.completed`
   - `âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼)`
   - `ğŸ“¦ ç”¢å“ä¿¡æ¯`

### **æ–¹æ³• 2ï¼šæŸ¥çœ‹ Stripe Workbench çš„å“åº”ä½“**
1. åœ¨ Stripe Workbench ä¸­ï¼Œç‚¹å‡» `checkout.session.completed` äº‹ä»¶
2. æŸ¥çœ‹ **å‘é€åˆ° Webhook ç«¯ç‚¹** éƒ¨åˆ†
3. ç‚¹å‡» **200 OK** æŸ¥çœ‹è¯¦ç»†å“åº”
4. å¦‚æœå“åº”ä½“ä¸ºç©ºæˆ–åªæœ‰ `"Webhook received"`ï¼Œè¯´æ˜å‡½æ•°æ‰§è¡Œäº†ä½†æ²¡æœ‰æ·»åŠ  Credits

---

## ğŸ¯ **æœ€å…³é”®çš„è¯Šæ–­æ­¥éª¤**

### **æ·»åŠ è¯¦ç»†æ—¥å¿—åˆ°ä»£ç **

æˆ‘æ€€ç–‘ä»£ç æ‰§è¡Œåˆ°äº† `handleCheckoutCompleted`ï¼Œä½†å¯èƒ½åœ¨æŸä¸ªæ­¥éª¤å¤±è´¥äº†ã€‚

è®©æˆ‘ä¿®æ”¹ä»£ç æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ï¼š

```javascript
async function handleCheckoutCompleted(session, isTestMode = false) {
    console.log(`âœ… çµå¸³å®Œæˆ (${isTestMode ? 'æ¸¬è©¦æ¨¡å¼' : 'ç”Ÿç”¢æ¨¡å¼'}):`, session.id);
    console.log(`ğŸ“‹ Session è¯¦æƒ…:`, JSON.stringify(session, null, 2));  // â† æ–°å¢
    
    // é¸æ“‡æ­£ç¢ºçš„ Stripe å®¢æˆ¶ç«¯
    const stripeClient = isTestMode ? stripeTest : stripeLive;
    if (!stripeClient) {
        console.error(`âŒ Stripe å®¢æˆ¶ç«¯æœªé…ç½® (${isTestMode ? 'æ¸¬è©¦æ¨¡å¼' : 'ç”Ÿç”¢æ¨¡å¼'})`);
        throw new Error('Stripe client not configured');
    }
    
    console.log(`ğŸ”§ ä½¿ç”¨çš„ Stripe å®¢æˆ¶ç«¯: ${isTestMode ? 'stripeTest' : 'stripeLive'}`);  // â† æ–°å¢
    
    // ... å…¶ä»–ä»£ç  ...
    
    // ç²å–è³¼è²·çš„ç”¢å“ä¿¡æ¯
    console.log(`ğŸ” é–‹å§‹ç²å–ç”¢å“ä¿¡æ¯...`);  // â† æ–°å¢
    const lineItems = await stripeClient.checkout.sessions.listLineItems(session.id);
    console.log(`ğŸ“¦ LineItems:`, JSON.stringify(lineItems, null, 2));  // â† æ–°å¢
    
    for (const item of lineItems.data) {
        const productId = item.price.product;
        console.log(`ğŸ” æ­£åœ¨ç²å–ç”¢å“: ${productId}`);  // â† æ–°å¢
        const product = await stripeClient.products.retrieve(productId);
        
        console.log(`ğŸ“¦ ç”¢å“ä¿¡æ¯:`, {
            productId: product.id,
            name: product.name,
            metadata: product.metadata
        });
        
        // æ ¹æ“šç”¢å“ metadata æ·»åŠ  Credits
        const credits = parseInt(product.metadata.monthly_credits || product.metadata.credits || 0);
        console.log(`ğŸ”¢ è¨ˆç®—å¾—åˆ°çš„ Credits: ${credits}`);  // â† æ–°å¢
        
        if (credits > 0) {
            console.log(`ğŸ’° æº–å‚™æ·»åŠ  ${credits} Credits çµ¦ç”¨æˆ¶ ${userId}`);
            await addCredits(userId, credits, {
                source: 'purchase',
                stripeSessionId: session.id,
                productName: product.name,
                amount: session.amount_total / 100,
                currency: session.currency,
                planType: product.metadata.plan_type || 'unknown'
            });
            console.log(`âœ… æˆåŠŸæ·»åŠ  ${credits} Credits`);
        } else {
            console.log(`âš ï¸ ç”¢å“æ²’æœ‰é…ç½® Credits: ${product.name}`);
            console.log(`âš ï¸ product.metadata:`, JSON.stringify(product.metadata, null, 2));  // â† æ–°å¢
        }
    }
}
```

---

## ğŸ› ï¸ **ç«‹å³ä¿®å¤æ–¹æ¡ˆ**

æˆ‘ç°åœ¨å°†ä¿®æ”¹ä»£ç æ·»åŠ è¿™äº›è¯¦ç»†æ—¥å¿—ï¼Œç„¶åæ‚¨å†è¿›è¡Œä¸€æ¬¡æµ‹è¯•æ”¯ä»˜ã€‚

è¿™æ ·æˆ‘ä»¬å°±èƒ½å‡†ç¡®çŸ¥é“é—®é¢˜å‡ºåœ¨å“ªé‡Œäº†ï¼

---

## ğŸ“‹ **å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨æ·»åŠ  Credits**

å¦‚æœæ€¥éœ€æµ‹è¯•ï¼Œå¯ä»¥æš‚æ—¶æ‰‹åŠ¨æ·»åŠ  Creditsï¼š

1. æ‰“å¼€ Firebase Console: https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore
2. å‰å¾€ **Firestore Database**
3. æ‰¾åˆ° `users` é›†åˆ
4. æ‰¾åˆ°æ‚¨çš„ç”¨æˆ·ï¼ˆvaultcaddy@gmail.comï¼‰
5. ç¼–è¾‘ `credits` å­—æ®µï¼Œæ”¹ä¸º `100`

ä½†è¿™åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œæˆ‘ä»¬éœ€è¦ä¿®å¤ Webhook çš„é—®é¢˜ã€‚

