# ğŸ” æ£€æŸ¥è¶…é¢è®¡è´¹æ—¥å¿— - è¯Šæ–­æŒ‡å—

## âš ï¸ é—®é¢˜æè¿°

**ç°è±¡ï¼š**
- ç”¨æˆ· 1234@gmail.com çš„ Credits ä¸º -51
- å·²ç»å–æ¶ˆè®¢é˜…
- ä½† Stripe ç”Ÿæˆçš„è´¦å•æ˜¯ HK$0.00ï¼ˆåº”è¯¥æ˜¯ HK$25.50ï¼‰

**å¯èƒ½åŸå› ï¼š**
1. âŒ `customer.subscription.deleted` webhook äº‹ä»¶æ²¡æœ‰è¢«è§¦å‘
2. âŒ `handleSubscriptionCancelled` å‡½æ•°æ‰§è¡Œå¤±è´¥
3. âŒ æŠ¥å‘ŠæˆåŠŸä½† Stripe è¿˜æ²¡æœ‰æ›´æ–°è´¦å•

---

## ğŸ“‹ è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šæŸ¥çœ‹ Firebase Functions æ—¥å¿—

#### æ–¹æ³• 1ï¼šåœ¨ Firebase Console ä¸­æŸ¥çœ‹

```bash
1. æ‰“å¼€ Firebase Consoleï¼š
   https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions

2. ç‚¹å‡»ã€Œæ—¥å¿—ã€æ ‡ç­¾

3. æœç´¢å…³é”®å­—ï¼š
   - "âŒ è¨‚é–±å·²å–æ¶ˆ"
   - "1234@gmail.com"
   - "customer.subscription.deleted"
   - "ğŸ’° æª¢æ¸¬åˆ°è¶…é¡ä½¿ç”¨"

4. æŸ¥çœ‹æ—¶é—´èŒƒå›´ï¼š
   - æœ€è¿‘ 1 å°æ—¶
   - æˆ–è€…ä» 2025å¹´12æœˆ15æ—¥ ä¸‹åˆ5:19 å¼€å§‹
```

#### æ–¹æ³• 2ï¼šä½¿ç”¨å‘½ä»¤è¡ŒæŸ¥çœ‹

```bash
# åœ¨ç»ˆç«¯è¿è¡Œ
firebase functions:log --only stripeWebhook --limit 50
```

---

### æ­¥éª¤ 2ï¼šæŸ¥çœ‹ Stripe Webhook æ—¥å¿—

```bash
1. æ‰“å¼€ Stripe Dashboardï¼š
   https://dashboard.stripe.com/test/webhooks

2. ç‚¹å‡»ä½ çš„ Webhook endpoint

3. æŸ¥æ‰¾ "customer.subscription.deleted" äº‹ä»¶ï¼š
   - æ—¶é—´ï¼š2025å¹´12æœˆ15æ—¥ ä¸‹åˆ5:19 å·¦å³
   - è®¢é˜… IDï¼šsub_1SeXwdJmiQ31C0GTEBs...

4. æ£€æŸ¥ï¼š
   âœ… äº‹ä»¶æ˜¯å¦å‘é€æˆåŠŸï¼Ÿ
   âœ… HTTP çŠ¶æ€ç æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆåº”è¯¥æ˜¯ 200ï¼‰
   âœ… æœ‰æ²¡æœ‰é”™è¯¯ä¿¡æ¯ï¼Ÿ
```

---

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹ Firestore `processedStripeEvents` é›†åˆ

```bash
1. æ‰“å¼€ Firestoreï¼š
   https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. å¯¼èˆªåˆ° processedStripeEvents é›†åˆ

3. æŸ¥æ‰¾æœ€è¿‘çš„ "customer.subscription.deleted" äº‹ä»¶ï¼š
   - æœç´¢å­—æ®µï¼štype = "customer.subscription.deleted"
   - æ—¶é—´ï¼š2025å¹´12æœˆ15æ—¥ ä¸‹åˆ5:19 å·¦å³

4. æ£€æŸ¥ï¼š
   âœ… äº‹ä»¶æ˜¯å¦å­˜åœ¨ï¼Ÿ
   âœ… æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ï¼Ÿ
```

---

## ğŸ”§ å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šWebhook äº‹ä»¶æ²¡æœ‰è§¦å‘

**åŸå› ï¼š**
- Stripe çš„è®¢é˜…å–æ¶ˆæ–¹å¼å¯èƒ½ä¸ä¼šç«‹å³è§¦å‘ webhook
- å¦‚æœé€‰æ‹©ã€Œæœ¬æœŸç»“æŸã€å–æ¶ˆï¼Œwebhook ä¼šå»¶è¿Ÿåˆ° 2026å¹´1æœˆ15æ—¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
æ£€æŸ¥å–æ¶ˆè®¢é˜…æ—¶é€‰æ‹©çš„æ–¹å¼ï¼š
- âœ… ç«‹å³å–æ¶ˆ â†’ åº”è¯¥ç«‹å³è§¦å‘ webhook
- âŒ æœ¬æœŸç»“æŸ â†’ ä¼šå»¶è¿Ÿåˆ° 2026å¹´1æœˆ15æ—¥
- âŒ è‡ªå®šä¹‰æ—¥æœŸ â†’ ä¼šå»¶è¿Ÿåˆ°æŒ‡å®šæ—¥æœŸ

å¦‚æœé€‰æ‹©äº†å»¶è¿Ÿå–æ¶ˆï¼Œéœ€è¦é‡æ–°å–æ¶ˆï¼š
1. Stripe Dashboard â†’ è®¢é˜… â†’ Cancel immediately
2. æˆ–è€…æ‰‹åŠ¨æŠ¥å‘Šè¶…é¢ä½¿ç”¨ï¼ˆè§ä¸‹æ–‡ï¼‰
```

---

### é—®é¢˜ 2ï¼šhandleSubscriptionCancelled æ‰§è¡Œå¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- æ— æ³•è¯»å–ç”¨æˆ·æ•°æ®
- æ— æ³•è¯»å–è®¢é˜…ä¿¡æ¯
- Stripe API è°ƒç”¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
æŸ¥çœ‹ Firebase Functions æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯ï¼š
- æœç´¢ï¼š"âŒ è™•ç†è¨‚é–±å–æ¶ˆå¤±æ•—"
- æœç´¢ï¼š"âŒ å ±å‘Šè¶…é¡ä½¿ç”¨å¤±æ•—"

æ ¹æ®é”™è¯¯ä¿¡æ¯è¿›è¡Œä¿®å¤
```

---

### é—®é¢˜ 3ï¼šStripe è¿˜æ²¡æœ‰æ›´æ–°è´¦å•

**åŸå› ï¼š**
- Stripe çš„è®¡è´¹å‘¨æœŸå¯èƒ½æœ‰å»¶è¿Ÿ
- Usage records å·²æŠ¥å‘Šï¼Œä½†è´¦å•è¿˜æ²¡æœ‰ç”Ÿæˆ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
1. æŸ¥çœ‹ Stripe Usage Recordsï¼š
   Stripe Dashboard â†’ Subscriptions â†’ sub_1SeXwdJmiQ31C0GTEBs...
   â†’ Usage-based items
   
   åº”è¯¥æ˜¾ç¤ºï¼š151 units

2. æ‰‹åŠ¨åˆ›å»ºå‘ç¥¨ï¼š
   Stripe Dashboard â†’ Customers â†’ 1234@gmail.com
   â†’ Create invoice
   
   åº”è¯¥è‡ªåŠ¨åŒ…å«è¶…é¢ä½¿ç”¨è´¹ç”¨
```

---

## ğŸš€ å¿«é€Ÿä¿®å¤ï¼šæ‰‹åŠ¨æŠ¥å‘Šè¶…é¢ä½¿ç”¨

å¦‚æœ `handleSubscriptionCancelled` æ²¡æœ‰è¢«è§¦å‘æˆ–æ‰§è¡Œå¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æŠ¥å‘Šï¼š

### æ–¹æ³• 1ï¼šä½¿ç”¨è¯Šæ–­å·¥å…·

```bash
1. æ‰“å¼€ overage-diagnostic.html

2. æ»šåŠ¨åˆ°ã€Œ2. æ‰‹åŠ¨æŠ¥å‘Šè¶…é¢ä½¿ç”¨ã€

3. è¾“å…¥ï¼š
   - é‚®ç®±ï¼š1234@gmail.com
   - è¶…é¢æ•°é‡ï¼š51

4. ç‚¹å‡»ã€ŒğŸ“¡ æ‰‹åŠ¨æŠ¥å‘Šã€

5. æŸ¥çœ‹ç»“æœ
```

### æ–¹æ³• 2ï¼šåœ¨ Firebase Console ä¸­æ‰‹åŠ¨è§¦å‘

```bash
1. æ‰“å¼€ Firebase Consoleï¼š
   https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions

2. æ‰¾åˆ° manualReportOverage å‡½æ•°

3. ç‚¹å‡»ã€Œæµ‹è¯•å‡½æ•°ã€

4. è¾“å…¥å‚æ•°ï¼š
   {
     "data": {
       "userEmail": "1234@gmail.com",
       "overageAmount": 51
     }
   }

5. ç‚¹å‡»ã€Œè¿è¡Œã€
```

---

## âœ… éªŒè¯ä¿®å¤

### æ£€æŸ¥ 1ï¼šFirebase Functions æ—¥å¿—

```bash
åº”è¯¥çœ‹åˆ°ï¼š
âœ… "ğŸ’° æª¢æ¸¬åˆ°è¶…é¡ä½¿ç”¨: -51 Credits"
âœ… "ğŸ“¡ å‘ Stripe å ±å‘Šç¸½ä½¿ç”¨é‡..."
âœ… "ç¸½ä½¿ç”¨é‡: 151"
âœ… "âœ… ç¸½ä½¿ç”¨é‡å·²å ±å‘Šçµ¦ Stripe"
âœ… "é æœŸæ”¶è²»: HK$25.50"
```

### æ£€æŸ¥ 2ï¼šStripe Usage Records

```bash
Stripe Dashboard â†’ Subscriptions â†’ Usage-based items
åº”è¯¥æ˜¾ç¤ºï¼š151 units âœ…
```

### æ£€æŸ¥ 3ï¼šStripe å‘ç¥¨

```bash
Stripe Dashboard â†’ Customers â†’ Create invoice
å‘ç¥¨é‡‘é¢åº”è¯¥æ˜¯ï¼šHK$25.50 âœ…

è®¡ç®—ï¼š
- å‰ 100 ä¸ª Credits: HK$0.00ï¼ˆå…è´¹ï¼‰
- ç¬¬ 101-151 ä¸ª: 51 Ã— HK$0.50 = HK$25.50
```

---

## ğŸ“ å¦‚æœè¿˜æ˜¯ä¸è¡Œ

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **Firebase Functions æ—¥å¿—æˆªå›¾**
   - æœç´¢ï¼š"customer.subscription.deleted"
   - æ—¶é—´ï¼š2025å¹´12æœˆ15æ—¥ ä¸‹åˆ5:19 å‰å

2. **Stripe Webhook æ—¥å¿—æˆªå›¾**
   - customer.subscription.deleted äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯

3. **Firestore ç”¨æˆ·æ•°æ®æˆªå›¾**
   - users â†’ 3bLhZuU9HOb3ExhwFCJuN4vZeGb2
   - å®Œæ•´æ•°æ®

4. **Stripe è®¢é˜…è¯¦æƒ…æˆªå›¾**
   - è®¢é˜…çš„ Usage-based items
   - è®¢é˜…çš„çŠ¶æ€å’Œå†å²

---

**ç°åœ¨å…ˆå»æŸ¥çœ‹ Firebase Functions æ—¥å¿—ï¼Œçœ‹çœ‹ `handleSubscriptionCancelled` æ˜¯å¦è¢«è§¦å‘äº†ï¼** ğŸ”

