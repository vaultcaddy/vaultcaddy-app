# ğŸš¨ å‘ç¥¨æ”¯ä»˜æ—¶åºé—®é¢˜ - å·²ä¿®å¤

## ğŸ› é—®é¢˜å‘ç°

**å‘ç°æ—¶é—´ï¼š** 2025-12-15 ä¸‹åˆ6:23  
**ä¸¥é‡ç¨‹åº¦ï¼š** ğŸ”´ ä¸¥é‡ - è¶…é¢ä½¿ç”¨æ— æ³•æ”¶è´¹

---

## ğŸ“Š é—®é¢˜æè¿°

### ç°è±¡

1. ç”¨æˆ·å–æ¶ˆè®¢é˜…æ—¶ï¼ŒCredits ä¸º -50ï¼ˆè¶…é¢ä½¿ç”¨ 50 ä¸ªï¼‰
2. Firebase Functions æ—¥å¿—æ˜¾ç¤ºæˆåŠŸåˆ›å»ºå‘ç¥¨é¡¹ç›®ï¼ˆHK$25.00ï¼‰å’Œå‘ç¥¨
3. ä½† Stripe Dashboard æ˜¾ç¤ºæ”¯ä»˜é‡‘é¢ä¸º HK$0.00
4. å‘ç¥¨é¡¹ç›®ï¼ˆHK$25.00ï¼‰å­˜åœ¨ï¼Œä½†æœªå…³è”åˆ°ä»»ä½•å‘ç¥¨

### æ ¹æœ¬åŸå› 

**æ—¶åºé—®é¢˜ï¼š**

```
æ—¶é—´è½´ï¼š
2025-12-15 ä¸‹åˆ6:21:20 - Stripe å¤„ç†è®¢é˜…å–æ¶ˆ
                         â†“
                      ç”Ÿæˆæœ€ç»ˆå‘ç¥¨ï¼ˆHK$0.00ï¼‰
                         â†“
                      å®Œæˆå¹¶æ”¯ä»˜å‘ç¥¨
                         â†“
2025-12-15 ä¸‹åˆ6:21:22 - è§¦å‘ webhookï¼Œæˆ‘ä»¬çš„ä»£ç è¿è¡Œ
                         â†“
                      åˆ›å»ºå‘ç¥¨é¡¹ç›®ï¼ˆHK$25.00ï¼‰
                         â†“
                      âŒ ä½†æœ€ç»ˆå‘ç¥¨å·²ç»æ”¯ä»˜å®Œæˆï¼
```

**é—®é¢˜ 1ï¼šæ—¶åºé—®é¢˜**
- Stripe åœ¨è§¦å‘ webhook ä¹‹å‰å°±å·²ç»ç”Ÿæˆå¹¶æ”¯ä»˜äº†æœ€ç»ˆå‘ç¥¨
- æˆ‘ä»¬çš„ä»£ç è¿è¡Œæ—¶ï¼Œå·²ç»å¤ªæ™šäº†

**é—®é¢˜ 2ï¼šauto_advance ä¸ä¼šç«‹å³æ”¯ä»˜**
```javascript
const invoice = await stripeClient.invoices.create({
    auto_advance: true, // â† è¿™ä¸ªä¸ä¼šç«‹å³æ”¯ä»˜ï¼
    collection_method: 'charge_automatically',
});

await stripeClient.invoices.finalizeInvoice(invoice.id); // â† å‘ç¥¨å˜ä¸º "open"ï¼Œä½†ä¸ä¼šè‡ªåŠ¨æ”¯ä»˜
```

`auto_advance: true` çš„è¡Œä¸ºï¼š
- ä¸ä¼šç«‹å³æ”¯ä»˜å‘ç¥¨
- åªæ˜¯è®¾ç½®å‘ç¥¨åœ¨åˆ°æœŸæ—¶è‡ªåŠ¨å°è¯•æ”¶æ¬¾
- æ–°åˆ›å»ºçš„å‘ç¥¨ä¼šä¿æŒ "open" çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªè®¡è´¹å‘¨æœŸ

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ï¼šæ˜¾å¼è°ƒç”¨ invoices.pay()

```javascript
// âŒ ä¿®å¤å‰
const invoice = await stripeClient.invoices.create({
    customer: subscription.customer,
    auto_advance: true,
    collection_method: 'charge_automatically',
});

await stripeClient.invoices.finalizeInvoice(invoice.id);
// å‘ç¥¨ä¿æŒ "open" çŠ¶æ€ï¼Œæ²¡æœ‰æ”¯ä»˜ âŒ

// âœ… ä¿®å¤å
const invoice = await stripeClient.invoices.create({
    customer: subscription.customer,
    auto_advance: false, // æ‰‹åŠ¨æ§åˆ¶æ”¯ä»˜æµç¨‹
    collection_method: 'charge_automatically',
});

// æ­¥éª¤ 1ï¼šå®Œæˆå‘ç¥¨
await stripeClient.invoices.finalizeInvoice(invoice.id);

// æ­¥éª¤ 2ï¼šç«‹å³æ”¯ä»˜å‘ç¥¨
const paidInvoice = await stripeClient.invoices.pay(invoice.id, {
    paid_out_of_band: false,
});
// å‘ç¥¨ç«‹å³å˜ä¸º "paid" çŠ¶æ€ âœ…
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–‡ä»¶ï¼š`firebase-functions/index.js`

#### ä¿®æ”¹ 1ï¼šhandleSubscriptionCancelled å‡½æ•°

```javascript
// è¡Œå·ï¼š730-762

// åˆ›å»ºå‘ç¥¨é¡¹ç›®
const invoiceItem = await stripeClient.invoiceItems.create({
    customer: subscription.customer,
    amount: totalAmount,
    currency: 'hkd',
    description: `è¶…é¡ä½¿ç”¨ ${overageAmount} Creditsï¼ˆè¨‚é–±å–æ¶ˆå¾Œçµç®—ï¼‰`,
    ...
});

// åˆ›å»ºæ–°å‘ç¥¨
const invoice = await stripeClient.invoices.create({
    customer: subscription.customer,
    collection_method: 'charge_automatically',
    description: `VaultCaddy è¶…é¡ä½¿ç”¨è²»ç”¨`,
    auto_advance: false, // â† ä¿®æ”¹
});

// æ­¥éª¤ 1ï¼šå®Œæˆå‘ç¥¨
const finalizedInvoice = await stripeClient.invoices.finalizeInvoice(invoice.id);

// æ­¥éª¤ 2ï¼šç«‹å³æ”¯ä»˜å‘ç¥¨ï¼ˆæ–°å¢ï¼‰
const paidInvoice = await stripeClient.invoices.pay(invoice.id, {
    paid_out_of_band: false,
});

console.log(`âœ… ç™¼ç¥¨å·²æˆåŠŸæ”¯ä»˜: ${paidInvoice.id}`);
console.log(`ğŸ’µ æ”¯ä»˜é‡‘é¡: HK$${(paidInvoice.amount_paid / 100).toFixed(2)}`);
console.log(`ğŸ’³ æ”¯ä»˜ç‹€æ…‹: ${paidInvoice.status}`);
```

#### ä¿®æ”¹ 2ï¼šmanualReportOverage å‡½æ•°

```javascript
// è¡Œå·ï¼š2611-2633

// åŒæ ·çš„ä¿®æ”¹é€»è¾‘
const invoice = await stripeClient.invoices.create({
    customer: customerId,
    collection_method: 'charge_automatically',
    description: `VaultCaddy è¶…é¡ä½¿ç”¨è²»ç”¨ï¼ˆæ‰‹å‹•å ±å‘Šï¼‰`,
    auto_advance: false, // â† ä¿®æ”¹
});

const finalizedInvoice = await stripeClient.invoices.finalizeInvoice(invoice.id);

// ç«‹å³æ”¯ä»˜å‘ç¥¨ï¼ˆæ–°å¢ï¼‰
const paidInvoice = await stripeClient.invoices.pay(invoice.id, {
    paid_out_of_band: false,
});
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ¸…ç†ä¹‹å‰çš„å­¤ç«‹å‘ç¥¨é¡¹ç›®

```bash
1. æ‰“å¼€ Stripe Dashboardï¼š
   https://dashboard.stripe.com/test/customers/cus_TbmSD2DgeKdNtW

2. æŸ¥æ‰¾ "Unused invoice items"

3. å¦‚æœçœ‹åˆ° HK$25.00 çš„é¡¹ç›®ï¼Œç‚¹å‡»åˆ é™¤
```

### æ­¥éª¤ 2ï¼šé‡æ–°æµ‹è¯•æ‰‹åŠ¨æŠ¥å‘Š

```bash
1. æ‰“å¼€è¯Šæ–­å·¥å…·ï¼š
   file:///Users/cavlinyeung/ai-bank-parser/overage-diagnostic.html

2. è¾“å…¥ï¼š
   - é‚®ç®±ï¼š1234@gmail.com
   - è¶…é¢æ•°é‡ï¼š50

3. ç‚¹å‡»ã€ŒğŸ“¡ æ‰‹åŠ¨æŠ¥å‘Šã€

4. é¢„æœŸç»“æœï¼š
   âœ… billingMethod: "invoice"
   âœ… invoiceId: "in_xxxxx..."
   âœ… åœ¨ Stripe ä¸­çœ‹åˆ°å·²æ”¯ä»˜çš„ HK$25.00 å‘ç¥¨
```

### æ­¥éª¤ 3ï¼šéªŒè¯ Stripe

```bash
1. æ‰“å¼€ Stripe Dashboard - å‘ç¥¨é¡µé¢ï¼š
   https://dashboard.stripe.com/test/invoices

2. æœç´¢æœ€æ–°çš„å‘ç¥¨

3. éªŒè¯ï¼š
   âœ… é‡‘é¢ï¼šHK$25.00
   âœ… çŠ¶æ€ï¼šPaidï¼ˆå·²æ”¯ä»˜ï¼‰
   âœ… å®¢æˆ·ï¼š1234@gmail.com
   âœ… æè¿°ï¼šVaultCaddy è¶…é¡ä½¿ç”¨è²»ç”¨
```

---

## ğŸ“Š é¢„æœŸçš„æ­£ç¡®æ—¥å¿—

### Firebase Functions æ—¥å¿—

```
âœ… è¨‚é–±å·²å–æ¶ˆ: sub_xxxxx
âœ… æª¢æ¸¬åˆ°è¶…é¡ä½¿ç”¨: -50 Credits
âœ… è¶…é¡æ•¸é‡: 50 Credits
âŒ å ±å‘Šè¶…é¡ä½¿ç”¨å¤±æ•—: Cannot create a usage record...
ğŸ’¡ å˜—è©¦å‰µå»ºç¨ç«‹ç™¼ç¥¨ä¾†æ”¶å–è¶…é¡è²»ç”¨...
ğŸ“ å‰µå»ºç™¼ç¥¨é …ç›®:
   - è¶…é¡æ•¸é‡: 50 Credits
   - å–®åƒ¹: HK$0.50
   - ç¸½é‡‘é¡: HK$25.00
âœ… ç™¼ç¥¨é …ç›®å·²å‰µå»º: ii_xxxxx
âœ… ç™¼ç¥¨å·²å‰µå»º: in_xxxxx
ğŸ“‹ ç™¼ç¥¨åŒ…å«é …ç›®: ii_xxxxxï¼Œé‡‘é¡: HK$25.00
âœ… ç™¼ç¥¨å·²å®Œæˆ: in_xxxxx
âœ… ç™¼ç¥¨å·²æˆåŠŸæ”¯ä»˜: in_xxxxx     â† æ–°å¢ï¼
ğŸ’µ æ”¯ä»˜é‡‘é¡: HK$25.00            â† æ–°å¢ï¼
ğŸ’³ æ”¯ä»˜ç‹€æ…‹: paid                â† æ–°å¢ï¼
```

### Stripe Eventsï¼ˆé¢„æœŸï¼‰

```
âœ… å‰µå»ºäº† invoice item: ii_xxxxx (HK$25.00)
âœ… å‰µå»ºäº† invoice: in_xxxxx
âœ… å®Œæˆäº† invoice: in_xxxxx
âœ… æ”¯ä»˜äº† invoice: in_xxxxx (HK$25.00)    â† æ–°å¢ï¼
âœ… æ”¯ä»˜æˆåŠŸ: HK$25.00                    â† æ–°å¢ï¼
```

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. æ˜ç¡®çš„æ”¯ä»˜æ§åˆ¶ âœ…

- **ä¹‹å‰ï¼š** ä¾èµ– `auto_advance: true`ï¼ŒæœŸæœ›è‡ªåŠ¨æ”¯ä»˜
- **ç°åœ¨ï¼š** ä½¿ç”¨ `auto_advance: false` + `invoices.pay()`ï¼Œæ˜ç¡®æ§åˆ¶æ”¯ä»˜æ—¶æœº

### 2. ç«‹å³æ”¯ä»˜ âœ…

- **ä¹‹å‰ï¼š** å‘ç¥¨ä¿æŒ "open" çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªè®¡è´¹å‘¨æœŸ
- **ç°åœ¨ï¼š** ç«‹å³æ”¯ä»˜ï¼Œå‘ç¥¨çŠ¶æ€å˜ä¸º "paid"

### 3. å®Œæ•´çš„æ—¥å¿—è®°å½• âœ…

- **ä¹‹å‰ï¼š** åªè®°å½•å‘ç¥¨åˆ›å»º
- **ç°åœ¨ï¼š** è®°å½•æ”¯ä»˜é‡‘é¢ã€æ”¯ä»˜çŠ¶æ€

---

## ğŸ’¡ å­¦åˆ°çš„ç»éªŒ

### 1. Stripe API çš„è¡Œä¸º

```
auto_advance: true çš„çœŸæ­£å«ä¹‰ï¼š
- ä¸æ˜¯"ç«‹å³æ”¯ä»˜"
- è€Œæ˜¯"åˆ°æœŸæ—¶è‡ªåŠ¨å°è¯•æ”¶æ¬¾"
- å¯¹äºæ–°åˆ›å»ºçš„å‘ç¥¨ï¼Œä¸ä¼šç«‹å³æ”¯ä»˜
```

### 2. æ—¶åºé—®é¢˜çš„é‡è¦æ€§

```
Stripe çš„è®¢é˜…å–æ¶ˆæµç¨‹ï¼š
1. ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
2. Stripe ç«‹å³ç”Ÿæˆå¹¶æ”¯ä»˜æœ€ç»ˆå‘ç¥¨ï¼ˆå‡ æ¯«ç§’å†…å®Œæˆï¼‰
3. è§¦å‘ webhook
4. æˆ‘ä»¬çš„ä»£ç è¿è¡Œï¼ˆå·²ç»å¤ªæ™šäº†ï¼‰

è§£å†³æ–¹æ¡ˆï¼š
- ä¸è¦è¯•å›¾ä¿®æ”¹å·²å®Œæˆçš„å‘ç¥¨
- åˆ›å»ºæ–°çš„ç‹¬ç«‹å‘ç¥¨
- ç«‹å³æ”¯ä»˜æ–°å‘ç¥¨
```

### 3. æµ‹è¯•çš„é‡è¦æ€§

```
ä¸èƒ½åªçœ‹æ—¥å¿—æ˜¾ç¤º"æˆåŠŸåˆ›å»ºå‘ç¥¨"å°±è®¤ä¸ºä¸€åˆ‡æ­£å¸¸
å¿…é¡»éªŒè¯ï¼š
1. å‘ç¥¨çŠ¶æ€æ˜¯å¦ä¸º "paid"
2. Stripe Dashboard æ˜¯å¦æ˜¾ç¤ºæ­£ç¡®çš„é‡‘é¢
3. ç”¨æˆ·æ˜¯å¦çœŸçš„è¢«æ”¶è´¹
```

---

## ğŸ“… éƒ¨ç½²ä¿¡æ¯

```
éƒ¨ç½²æ—¶é—´ï¼š2025-12-15 ä¸‹åˆ6:23
Git commitï¼šc1be7f3
éƒ¨ç½²å‘½ä»¤ï¼šfirebase deploy --only functions:stripeWebhook,functions:manualReportOverage
éƒ¨ç½²çŠ¶æ€ï¼šâœ… æˆåŠŸ

æ›´æ–°çš„å‡½æ•°ï¼š
âœ… stripeWebhook
âœ… manualReportOverage
```

---

## ğŸ‰ æ€»ç»“

âœ… **é—®é¢˜å·²ä¿®å¤**  
âœ… **ä»£ç å·²éƒ¨ç½²**  
âœ… **æµ‹è¯•å°±ç»ª**  

**å…³é”®ä¿®å¤ï¼š**
- æ·»åŠ æ˜¾å¼çš„ `invoices.pay()` è°ƒç”¨
- ä½¿ç”¨ `auto_advance: false` æ˜ç¡®æ§åˆ¶æ”¯ä»˜æµç¨‹
- ç¡®ä¿å‘ç¥¨ç«‹å³è¢«æ”¯ä»˜ï¼Œè€Œä¸æ˜¯ç­‰å¾…ä¸‹ä¸€ä¸ªè®¡è´¹å‘¨æœŸ

**ä¸‹ä¸€æ­¥ï¼š**
ä½¿ç”¨è¯Šæ–­å·¥å…·é‡æ–°æµ‹è¯•ï¼ŒéªŒè¯å‘ç¥¨è¢«æ­£ç¡®æ”¯ä»˜ï¼ğŸš€

