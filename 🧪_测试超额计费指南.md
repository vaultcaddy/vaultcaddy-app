# 🧪 测试超额计费指南

## 📊 **测试目标**

验证当 Pro Plan 用户使用超过 100 Credits（月费）或 1200 Credits（年费）后：
1. ✅ 系统允许继续上传文档
2. ✅ Credits 变为负数
3. ✅ 使用量正确报告给 Stripe
4. ✅ 下个账期会收取超额费用（HK$0.50/Credit）

---

## 🔧 **方法 A：手动修改 Credits（推荐）**

### **步骤 1：订阅月费计划**
1. 访问 https://vaultcaddy.com/billing.html
2. 点击 "開始使用"（月费 HK$58）
3. 完成支付
4. 确认收到 100 Credits

### **步骤 2：手动减少 Credits**
1. 访问 Firebase Console
   🔗 https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. 导航到 `users` 集合

3. 找到你的测试账号

4. 修改字段：
   ```
   credits: 2
   currentCredits: 2
   totalCreditsUsed: 98
   ```

### **步骤 3：测试超额使用**
1. 访问 https://vaultcaddy.com
2. 上传一份 5 页的银行对账单
3. 观察：
   - ✅ 应该成功处理
   - ✅ Credits 变为 -3（2 - 5 = -3）
   - ✅ `totalCreditsUsed` 变为 103

### **步骤 4：验证 Stripe 使用量报告**
1. 访问 Stripe Dashboard
   🔗 https://dashboard.stripe.com/subscriptions

2. 找到你的测试订阅

3. 点击订阅 ID 查看详情

4. 查看 "使用量" 标签：
   - ✅ 应该显示 3 个超额 Credits（103 - 100 = 3）
   - ✅ 下个账期会收取：3 × HK$0.50 = HK$1.50

---

## 🔧 **方法 B：真实上传测试（更准确）**

### **准备工作**
1. 订阅月费（HK$58，获得 100 Credits）
2. 准备 101 页的测试文档：
   - 可以分多个文件上传
   - 例如：5个 20 页的文档 + 1个 1 页的文档

### **测试步骤**
1. 逐个上传文档，监控 Credits：
   ```
   上传第1个（20页）：100 → 80
   上传第2个（20页）：80 → 60
   上传第3个（20页）：60 → 40
   上传第4个（20页）：40 → 20
   上传第5个（20页）：20 → 0
   上传第6个（1页）：0 → -1 ✅ 超额！
   ```

2. 检查 Stripe 使用量：
   - 应该报告 1 个超额 Credit
   - 下个账期收取 HK$0.50

---

## 🔧 **方法 C：使用测试模式（最安全）**

### **优点**
- ✅ 不会产生真实费用
- ✅ 可以使用测试卡 4242 4242 4242 4242
- ✅ 可以自由测试

### **步骤**

#### **1. 临时启用测试按钮**

在 `billing.html` 中临时添加测试按钮（测试完后删除）：

```html
<!-- 临时测试按钮 -->
<button onclick="createCheckoutSession('monthly', event, true)" 
        style="background: #fbbf24; color: #78350f; padding: 1rem;">
    🧪 测试订阅（不产生真实费用）
</button>
```

#### **2. 使用测试卡订阅**
- 卡号：4242 4242 4242 4242
- 日期：任意未来日期
- CVC：任意 3 位数

#### **3. 修改 Credits 并测试**
按照方法 A 的步骤进行

#### **4. 检查 Stripe 测试模式**
🔗 https://dashboard.stripe.com/test/subscriptions

---

## 📊 **验证清单**

### **Firebase 检查**
- [ ] `credits` 和 `currentCredits` 都变为负数
- [ ] `totalCreditsUsed` 正确增加
- [ ] `creditsHistory` 记录了所有使用

### **Stripe 检查**
- [ ] 订阅详情页显示使用量
- [ ] 使用量 = `totalCreditsUsed` - `includedCredits`
- [ ] 下个账期的发票预览显示超额费用

### **用户体验检查**
- [ ] Pro Plan 用户即使 Credits 为 0 也能上传
- [ ] Free Plan 用户 Credits 为 0 时被阻止上传
- [ ] Credits 显示正确（可以为负数）

---

## 🧪 **模拟完整生命周期**

### **第 1 个月**
1. **Day 1**：订阅月费，获得 100 Credits
2. **Day 15**：使用了 120 Credits
   - Credits: -20
   - 累计使用：120
   - 超额：20

3. **Day 30**（续费日）：
   - 收取月费：HK$58
   - 收取超额费：20 × HK$0.50 = HK$10
   - **总计：HK$68**
   - Credits 重置为：100
   - `totalCreditsUsed` 重置为：0

### **第 2 个月**
1. **Day 31**：新的 100 Credits
2. **Day 45**：使用了 80 Credits
   - Credits: 20
   - 累计使用：80

3. **Day 60**（续费日）：
   - 收取月费：HK$58
   - 无超额费用
   - **总计：HK$58**
   - Credits 重置为：100

---

## 💡 **快速测试脚本**

### **在 Firebase Console 中运行**

```javascript
// 1. 设置测试用户为接近用完 Credits 的状态
db.collection('users').doc('你的用户ID').update({
  credits: 2,
  currentCredits: 2,
  totalCreditsUsed: 98,
  includedCredits: 100
});

// 2. 上传 5 页文档后，验证状态
db.collection('users').doc('你的用户ID').get().then(doc => {
  const data = doc.data();
  console.log('Credits:', data.credits); // 应该是 -3
  console.log('Total Used:', data.totalCreditsUsed); // 应该是 103
  console.log('Overage:', data.totalCreditsUsed - data.includedCredits); // 应该是 3
});
```

---

## 🎯 **测试成功标准**

### **✅ 通过测试**
- Pro Plan 用户 Credits 为 0 时仍可上传
- Credits 可以变为负数
- `totalCreditsUsed` 正确累加
- Stripe 收到使用量报告
- 下个账期发票包含超额费用

### **❌ 失败场景**
- Credits 为 0 时无法上传
- Credits 不会变负数
- Stripe 未收到使用量
- 超额不收费

---

## 📞 **如果出现问题**

### **问题 1：Credits 为 0 时无法上传**
**原因**：`credits-manager.js` 的检查逻辑错误  
**解决**：检查 `checkCredits` 函数是否正确识别 Pro Plan

### **问题 2：使用量未报告给 Stripe**
**原因**：`reportCreditsUsage` 函数未被调用  
**解决**：检查 Firebase Functions 日志

### **问题 3：超额费用未收取**
**原因**：Metered Price 配置错误  
**解决**：检查 Stripe Price 的 tiers 配置

---

## 📋 **测试记录模板**

```
测试日期：____年____月____日
测试账号：____________________
测试计划：[ ] 月费  [ ] 年费

初始状态：
- Credits: _______
- Total Used: _______

测试操作：
1. 上传 _____ 页文档
2. Credits 变为：_______
3. Total Used 变为：_______

Stripe 验证：
- 使用量记录：[ ] 有  [ ] 无
- 超额计量：_______
- 预计费用：HK$ _______

测试结果：[ ] ✅ 通过  [ ] ❌ 失败
```

---

**推荐测试顺序**：
1. 先用**方法 C（测试模式）**验证逻辑
2. 确认无误后用**方法 A（手动修改）**快速测试生产环境
3. 最后用**方法 B（真实上传）**做最终验证

**预计测试时间**：30-60 分钟

