# ğŸ” è¨ºæ–·ï¼šCredits æœªå¢åŠ çš„åŸå› 

## âœ… **å·²ç¢ºèªçš„äº‹å¯¦**

1. âœ… Webhook è¿”å› 200 OKï¼ˆåœ–2-3ä¸­é¡¯ç¤ºæˆåŠŸï¼‰
2. âœ… ç”¢å“ Metadata é…ç½®æ­£ç¢ºï¼š
   - `monthly_credits`: `100`
   - `plan_type`: `monthly`
3. âŒ **Credits ä»ç„¶æ˜¯ 0ï¼ˆåœ–1ä¸­é¡¯ç¤ºï¼‰**

---

## ğŸ” **å•é¡ŒåŸå› ï¼šè¨‚é–±ç‹€æ…‹ç‚º "incomplete"**

å¾ Stripe Webhook æ—¥èªŒä¸­ç™¼ç¾ï¼Œæ”¶åˆ°çš„äº‹ä»¶é¡å‹æ˜¯ **`customer.subscription.created`**ï¼Œè€Œä¸æ˜¯ **`checkout.session.completed`**ï¼

æ›´é‡è¦çš„æ˜¯ï¼Œè¨‚é–±çš„ç‹€æ…‹ç‚ºï¼š
```json
"status": "incomplete"
```

**é€™èªªæ˜ï¼š**
- æ¸¬è©¦æ”¯ä»˜é‚„æ²’æœ‰å®Œæˆ
- è¨‚é–±é‚„è™•æ–¼ "incomplete" ç‹€æ…‹
- `checkout.session.completed` äº‹ä»¶é‚„æ²’æœ‰è¢«è§¸ç™¼
- å› æ­¤ï¼ŒCredits æ·»åŠ çš„é‚è¼¯æ²’æœ‰åŸ·è¡Œ

---

## ğŸ’¡ **è§£æ±ºæ–¹æ¡ˆ**

### **æ­¥é©Ÿ 1: ç¢ºèªæ”¯ä»˜æ˜¯å¦å®Œæˆ**
1. æ‰“é–‹ Stripe Dashboardï¼ˆTEST MODEï¼‰
2. å‰å¾€ **Payments** é é¢
3. æŸ¥çœ‹æœ€è¿‘çš„æ”¯ä»˜æ˜¯å¦é¡¯ç¤ºç‚º "Succeeded"

### **æ­¥é©Ÿ 2: é‡æ–°é€²è¡Œæ¸¬è©¦æ”¯ä»˜**
å¦‚æœæ”¯ä»˜æ²’æœ‰å®Œæˆï¼š
1. æ‰“é–‹ https://vaultcaddy.com/billing.html
2. é»æ“Š **"ğŸ§ª æ¸¬è©¦ Get Started"** æŒ‰éˆ•
3. ä½¿ç”¨æ¸¬è©¦å¡ï¼š**4242 4242 4242 4242**
4. å®Œæ•´å¡«å¯«è¡¨å–®ä¸¦æäº¤
5. ç¢ºä¿çœ‹åˆ° "æ”¯ä»˜æˆåŠŸ" çš„æ¶ˆæ¯

### **æ­¥é©Ÿ 3: æŸ¥çœ‹ Webhook äº‹ä»¶**
æ”¯ä»˜å®Œæˆå¾Œï¼Œæ‡‰è©²æœƒè§¸ç™¼ä»¥ä¸‹ Webhook äº‹ä»¶ï¼š
1. `checkout.session.completed` - **é€™å€‹äº‹ä»¶æœƒè§¸ç™¼ Credits æ·»åŠ **
2. `customer.subscription.created`
3. `invoice.payment_succeeded`

---

## ğŸ“‹ **æª¢æŸ¥æ¸…å–®**

è«‹æŒ‰é †åºæª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š

- [ ] æ¸¬è©¦æ”¯ä»˜æ˜¯å¦å·²ç¶“å®Œæˆï¼Ÿ
- [ ] Stripe Dashboardï¼ˆTEST MODEï¼‰ä¸­æ˜¯å¦é¡¯ç¤º "Succeeded" ç‹€æ…‹ï¼Ÿ
- [ ] Webhook æ˜¯å¦æ”¶åˆ° `checkout.session.completed` äº‹ä»¶ï¼Ÿ
- [ ] Firebase Functions æ—¥èªŒä¸­æ˜¯å¦æœ‰ "âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼)" çš„æ¶ˆæ¯ï¼Ÿ
- [ ] Firebase Functions æ—¥èªŒä¸­æ˜¯å¦æœ‰ "ğŸ’° æº–å‚™æ·»åŠ  XXX Credits" çš„æ¶ˆæ¯ï¼Ÿ

---

## ğŸš¨ **å¦‚æœä¸Šè¿°æ­¥é©Ÿéƒ½å®Œæˆäº†ï¼Œä½† Credits ä»ç„¶æ˜¯ 0**

è«‹åŸ·è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è©³ç´°æ—¥èªŒï¼š

```bash
firebase functions:log --only stripeWebhook
```

ç„¶å¾Œå°‡æ—¥èªŒå…§å®¹ç™¼çµ¦æˆ‘ï¼Œæˆ‘æœƒå¹«æ‚¨é€²ä¸€æ­¥è¨ºæ–·ã€‚

---

## ğŸ“ **å‚™è¨»**

Stripe æ¸¬è©¦æ¨¡å¼çš„æ”¯ä»˜é€šå¸¸æœƒç«‹å³å®Œæˆï¼Œä½†æœ‰æ™‚å¯èƒ½éœ€è¦å¹¾ç§’é˜ã€‚å¦‚æœæ‚¨åœ¨æ”¯ä»˜å¾Œç«‹å³æŸ¥çœ‹ Firebaseï¼Œå¯èƒ½é‚„æ²’æœ‰æ”¶åˆ° Webhook äº‹ä»¶ã€‚è«‹ç¨ç­‰ç‰‡åˆ»å¾Œå†æŸ¥çœ‹ã€‚
