# ğŸ” è¯Šæ–­ï¼šCredits æœªå¢åŠ çš„åŸå› 

## âœ… **å·²ç¡®è®¤çš„äº‹å®**
1. Stripe Webhook è¿”å› **200 OK** - å‡½æ•°æ‰§è¡Œå®Œæˆ
2. Credits ä»ç„¶æ˜¯ **0** - æœªå¢åŠ 
3. ç­¾åéªŒè¯å·²é€šè¿‡ï¼ˆä» 403 â†’ 500 â†’ 200ï¼‰
4. Stripe å®¢æˆ·ç«¯é€‰æ‹©é—®é¢˜å·²ä¿®å¤ï¼ˆä½¿ç”¨æ­£ç¡®çš„æµ‹è¯•å®¢æˆ·ç«¯ï¼‰

---

## â“ **å¯èƒ½çš„åŸå› **

### **åŸå›  1ï¼šStripe æµ‹è¯•äº§å“ Metadata æœªé…ç½® `monthly_credits`**

**å…³é”®ç‚¹ï¼š**
- `handleCheckoutCompleted` å‡½æ•°ä¼šè¯»å–äº§å“çš„ `metadata.monthly_credits` æˆ– `metadata.credits`
- å¦‚æœè¿™äº›å­—æ®µä¸ºç©ºæˆ–ä¸º 0ï¼Œ**ä¸ä¼šè°ƒç”¨ `addCredits`**

**ä»£ç é€»è¾‘ï¼š**
```javascript
// æ ¹æ“šç”¢å“ metadata æ·»åŠ  Credits
const credits = parseInt(product.metadata.monthly_credits || product.metadata.credits || 0);

if (credits > 0) {
    // åªæœ‰å½“ credits > 0 æ—¶æ‰ä¼šæ·»åŠ 
    console.log(`ğŸ’° æº–å‚™æ·»åŠ  ${credits} Credits çµ¦ç”¨æˆ¶ ${userId}`);
    await addCredits(userId, credits, {...});
} else {
    console.log(`âš ï¸ ç”¢å“æ²’æœ‰é…ç½® Credits: ${product.name}`);
}
```

**æ£€æŸ¥æ–¹æ³•ï¼š**
1. æ‰“å¼€ Stripe Dashboardï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
2. å‰å¾€ **Products** â†’ **ä½ çš„æµ‹è¯•æœˆè´¹äº§å“**ï¼ˆprice_1Scj13JmiQ31C0GT4TJsWzFgï¼‰
3. æŸ¥çœ‹ **Metadata** æ˜¯å¦åŒ…å«ï¼š
   - `monthly_credits: 100`ï¼ˆæˆ– `credits: 100`ï¼‰
   - `plan_type: pro`

---

### **åŸå›  2ï¼šFirebase Functions æ—¥å¿—æœªæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯**

**å¯èƒ½åŸå› ï¼š**
- æ—¥å¿—å»¶è¿Ÿï¼ˆFirebase æ—¥å¿—æœ‰æ—¶ä¼šå»¶è¿Ÿå‡ åˆ†é’Ÿï¼‰
- æ—¥å¿—çº§åˆ«è¿‡æ»¤

**æ£€æŸ¥æ–¹æ³•ï¼š**
1. å‰å¾€ Firebase Console
2. æ‰“å¼€ **Functions** â†’ **Logs**
3. æŸ¥çœ‹ **stripeWebhook** å‡½æ•°çš„æœ€æ–°æ—¥å¿—
4. æœç´¢å…³é”®è¯ï¼š
   - `âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼)`
   - `ğŸ’° æº–å‚™æ·»åŠ  ... Credits`
   - `âš ï¸ ç”¢å“æ²’æœ‰é…ç½® Credits`

---

### **åŸå›  3ï¼šç”¨æˆ· ID æœªæ‰¾åˆ°**

**å¯èƒ½åŸå› ï¼š**
- Stripe Checkout Session çš„ `metadata` æˆ– `client_reference_id` æœªä¼ é€’ `userId`
- ç”¨æˆ·é‚®ç®±åœ¨ Firebase ä¸­ä¸å­˜åœ¨

**æ£€æŸ¥æ–¹æ³•ï¼š**
- æŸ¥çœ‹ Firebase Functions æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
  - `âŒ ç„¡æ³•ç²å–ç”¨æˆ¶ ID`
  - `ğŸ” å˜—è©¦é€šé email æŸ¥æ‰¾ç”¨æˆ¶`

---

## ğŸ“‹ **ä¸‹ä¸€æ­¥æ’æŸ¥**

### **æ­¥éª¤ 1ï¼šæ£€æŸ¥ Stripe æµ‹è¯•äº§å“ Metadata**
1. æ‰“å¼€ Stripe Dashboardï¼ˆç¡®è®¤åœ¨ **TEST MODE**ï¼‰
2. å‰å¾€ **Products** é¡µé¢
3. æ‰¾åˆ°æ‚¨çš„æµ‹è¯•æœˆè´¹äº§å“ï¼ˆåº”è¯¥æ˜¯ä¸ `price_1Scj13JmiQ31C0GT4TJsWzFg` å…³è”çš„äº§å“ï¼‰
4. ç‚¹å‡»è¿›å…¥äº§å“è¯¦æƒ…é¡µ
5. æ»šåŠ¨åˆ° **Metadata** éƒ¨åˆ†
6. ç¡®è®¤æ˜¯å¦åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
   - **monthly_credits**: `100`ï¼ˆæˆ–æ‚¨æƒ³è¦çš„æ•°å€¼ï¼‰
   - **plan_type**: `pro`

**å¦‚æœ Metadata ä¸ºç©ºæˆ–æ²¡æœ‰ `monthly_credits` å­—æ®µï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼**

---

### **æ­¥éª¤ 2ï¼šæŸ¥çœ‹ Firebase Functions è¯¦ç»†æ—¥å¿—**
1. å‰å¾€ Firebase Console: https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions
2. ç‚¹å‡» **Logs** æ ‡ç­¾
3. æœç´¢æœ€è¿‘çš„ **stripeWebhook** å‡½æ•°æ‰§è¡Œè®°å½•
4. æŸ¥æ‰¾ä»¥ä¸‹å…³é”®æ—¥å¿—ï¼š
   - `ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: checkout.session.completed`
   - `âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼)`
   - `ğŸ“¦ ç”¢å“ä¿¡æ¯` - æ˜¾ç¤ºäº§å“çš„ metadata
   - `ğŸ’° æº–å‚™æ·»åŠ  ... Credits` - å¦‚æœçœ‹åˆ°è¿™ä¸ªï¼Œè¯´æ˜å‡†å¤‡æ·»åŠ  Credits
   - `âš ï¸ ç”¢å“æ²’æœ‰é…ç½® Credits` - å¦‚æœçœ‹åˆ°è¿™ä¸ªï¼Œè¯´æ˜ metadata æœªé…ç½®

---

## ğŸ¯ **æœ€å¯èƒ½çš„åŸå› **

æ ¹æ®ç»éªŒï¼Œ**æœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š**

âœ… **Stripe æµ‹è¯•äº§å“çš„ Metadata æœªé…ç½® `monthly_credits` å­—æ®µ**

å› ä¸ºï¼š
1. Webhook è¿”å› 200 OKï¼Œè¯´æ˜ä»£ç æ‰§è¡Œå®Œæˆ
2. Credits æœªå¢åŠ ï¼Œè¯´æ˜ `addCredits` æœªè¢«è°ƒç”¨
3. ä»£ç é€»è¾‘ä¸­ï¼Œåªæœ‰ `credits > 0` æ—¶æ‰ä¼šè°ƒç”¨ `addCredits`

---

## ğŸ› ï¸ **å¿«é€Ÿè§£å†³æ–¹æ¡ˆ**

### å¦‚æœ Metadata æœªé…ç½®ï¼š

1. æ‰“å¼€ Stripe Dashboardï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
2. å‰å¾€ **Products**
3. æ‰¾åˆ°æ‚¨çš„æµ‹è¯•æœˆè´¹äº§å“
4. ç¼–è¾‘äº§å“ï¼Œæ·»åŠ  **Metadata**ï¼š
   - Key: `monthly_credits`
   - Value: `100`ï¼ˆæˆ–æ‚¨æƒ³è¦çš„æ•°å€¼ï¼‰
5. å†æ·»åŠ ä¸€ä¸ªï¼š
   - Key: `plan_type`
   - Value: `pro`
6. ä¿å­˜

**ç„¶åé‡æ–°è¿›è¡Œæµ‹è¯•æ”¯ä»˜ï¼**

---

## ğŸ“ **è¯·æ‚¨ç¡®è®¤**

è¯·æ‚¨ç¡®è®¤ä»¥ä¸‹å†…å®¹ï¼š

1. âœ… Stripe æµ‹è¯•äº§å“çš„ **Metadata** æ˜¯å¦åŒ…å« `monthly_credits` å­—æ®µï¼Ÿ
2. âœ… Firebase Functions æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `ğŸ“¦ ç”¢å“ä¿¡æ¯` çš„è¾“å‡ºï¼Ÿå¦‚æœæœ‰ï¼Œmetadata çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ
3. âœ… Firebase Functions æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `ğŸ’° æº–å‚™æ·»åŠ  ... Credits` æˆ– `âš ï¸ ç”¢å“æ²’æœ‰é…ç½® Credits` çš„è¾“å‡ºï¼Ÿ

è¯·æä¾›ä»¥ä¸Šä¿¡æ¯ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨è¿›ä¸€æ­¥è¯Šæ–­ï¼

---

## âœ… **é—®é¢˜å·²æ‰¾åˆ°ï¼**

ç”¨æˆ·å·²ç¡®è®¤ Metadata é…ç½®å¦‚ä¸‹ï¼š
- `monthly_credits`: `1200`
- `plan_type`: `yearly`

**é—®é¢˜ï¼š**
1. è¿™æ˜¯ä¸€ä¸ª**æœˆè´¹**äº§å“ï¼ˆé—´éš”ï¼šæ¯ 1 ä¸ªæœˆï¼‰ï¼Œä½† `plan_type` è®¾ç½®ä¸º `yearly`
2. `monthly_credits` è®¾ç½®ä¸º `1200`ï¼ˆå¹´è´¹æ•°é‡ï¼‰ï¼Œåº”è¯¥æ˜¯ `100`ï¼ˆæœˆè´¹æ•°é‡ï¼‰
3. **ä¹‹å‰çš„æµ‹è¯•æ”¯ä»˜æ˜¯åœ¨æ·»åŠ  Metadata ä¹‹å‰å®Œæˆçš„ï¼Œæ‰€ä»¥æ²¡æœ‰ Credits**

**è§£å†³æ–¹æ¡ˆï¼š**
1. å°† `plan_type` æ”¹ä¸º `monthly`
2. å°† `monthly_credits` æ”¹ä¸º `100`
3. **é‡æ–°è¿›è¡Œæµ‹è¯•æ”¯ä»˜**

