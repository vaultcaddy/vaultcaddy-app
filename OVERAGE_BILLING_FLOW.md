# ğŸ”„ è¶…é¡è¨ˆè²»å®Œæ•´æµç¨‹èªªæ˜
**æ—¥æœŸ**: 2026-01-29  
**ç”¨é€”**: æ¾„æ¸…è‡ªå‹•è¶…é¡è¨ˆè²»çš„å·¥ä½œåŸç†

---

## ğŸ’° è¨ˆè²»é‚è¼¯ç¸½è¦½

### æ ¸å¿ƒåŸå‰‡
1. âœ… **å®Œå…¨è‡ªå‹•** - ç„¡éœ€ä»»ä½•æ‰‹å‹•æ“ä½œ
2. âœ… **å¯¦æ™‚å ±å‘Š** - æ¯æ¬¡æ‰£é™¤ Credits æ™‚ç«‹å³å ±å‘Šè¶…é¡åˆ° Stripe
3. âœ… **æœˆåº¦çµç®—** - Stripe åœ¨è¨ˆè²»æ—¥è‡ªå‹•æ”¶å–ç´¯ç©çš„è¶…é¡è²»ç”¨

---

## ğŸ“… æœˆä»˜ç”¨æˆ¶ç¯„ä¾‹

**è¨‚é–±æ—¥æœŸ**: 2026å¹´1æœˆ10æ—¥  
**è¨ˆåŠƒ**: æœˆä»˜ HKD $38/æœˆï¼ŒåŒ…å« 100 Credits

### æ™‚é–“è»¸

| æ—¥æœŸ | äº‹ä»¶ | Credits | è¶…é¡ | è²»ç”¨ |
|------|------|---------|------|------|
| **1æœˆ10æ—¥** | è¨‚é–±æˆåŠŸ | +100 â†’ 100 | 0 | -$38ï¼ˆæœˆè²»ï¼‰ |
| 1æœˆ15æ—¥ | ä¸Šå‚³ 50 é  | -50 â†’ 50 | 0 | $0 |
| 1æœˆ20æ—¥ | ä¸Šå‚³ 60 é  | -60 â†’ -10 | +10 é  | $0ï¼ˆè¨˜éŒ„åˆ° Stripeï¼‰ |
| 1æœˆ25æ—¥ | ä¸Šå‚³ 40 é  | -40 â†’ -50 | +40 é  | $0ï¼ˆè¨˜éŒ„åˆ° Stripeï¼‰ |
| **2æœˆ10æ—¥** | è‡ªå‹•çºŒè²» | é‡ç½® â†’ 100 | æ¸…é›¶ | **-$53** (æœˆè²» $38 + è¶…é¡ 50Ã—$0.3=$15) |
| 2æœˆ15æ—¥ | ä¸Šå‚³ 120 é  | -120 â†’ -20 | +20 é  | $0ï¼ˆè¨˜éŒ„åˆ° Stripeï¼‰ |
| **3æœˆ10æ—¥** | è‡ªå‹•çºŒè²» | é‡ç½® â†’ 100 | æ¸…é›¶ | **-$44** (æœˆè²» $38 + è¶…é¡ 20Ã—$0.3=$6) |

**é—œéµé»**:
- æ¯æœˆ10æ—¥æ”¶è²»ï¼ˆè¨‚é–±æ—¥ï¼‰
- ä¸€æ¬¡æ”¶å–ï¼šç•¶æœˆæœˆè²» + ä¸Šæœˆè¶…é¡è²»ç”¨
- Credits é‡ç½®ç‚º 100

---

## ğŸ“… å¹´ä»˜ç”¨æˆ¶ç¯„ä¾‹

**è¨‚é–±æ—¥æœŸ**: 2026å¹´1æœˆ10æ—¥  
**è¨ˆåŠƒ**: å¹´ä»˜ HKD $336/å¹´ï¼ŒåŒ…å« 1200 Credits (100/æœˆ)

### æ™‚é–“è»¸

| æ—¥æœŸ | äº‹ä»¶ | Credits | è¶…é¡ | è²»ç”¨ |
|------|------|---------|------|------|
| **1æœˆ10æ—¥** | è¨‚é–±æˆåŠŸ | +1200 â†’ 1200 | 0 | -$336ï¼ˆ**å¹´è²»ï¼Œä¸€æ¬¡æ€§**ï¼‰ |
| 1æœˆ15æ—¥ | ä¸Šå‚³ 50 é  | -50 â†’ 1150 | 0 | $0 |
| 1æœˆ20æ—¥ | ä¸Šå‚³ 100 é  | -100 â†’ 1050 | 0 | $0 |
| 1æœˆ31æ—¥ | æœˆåº¦çµ±è¨ˆ | - | 1æœˆè¶…é¡ 0 | $0 |
| **2æœˆ10æ—¥** | è¶…é¡çµç®— | 1050 | 0 | **$0**ï¼ˆ1æœˆç„¡è¶…é¡ï¼‰ |
| 2æœˆ15æ—¥ | ä¸Šå‚³ 1100 é  | -1100 â†’ -50 | +50 é  | $0ï¼ˆè¨˜éŒ„åˆ° Stripeï¼‰ |
| **3æœˆ10æ—¥** | è¶…é¡çµç®— | -50 | æ¸…é›¶ | **-$15** (2æœˆè¶…é¡ 50Ã—$0.3) |
| 3æœˆ15æ—¥ | ä¸Šå‚³ 200 é  | -200 â†’ -250 | +200 é  | $0ï¼ˆè¨˜éŒ„åˆ° Stripeï¼‰ |
| **4æœˆ10æ—¥** | è¶…é¡çµç®— | -250 | æ¸…é›¶ | **-$60** (3æœˆè¶…é¡ 200Ã—$0.3) |
| ... | ... | ... | ... | ... |
| **2027å¹´1æœˆ10æ—¥** | å¹´åº¦çºŒè²» | é‡ç½® â†’ 1200 | æ¸…é›¶ | -$336ï¼ˆå¹´è²»ï¼‰ + 12æœˆè¶…é¡ |

**é—œéµé»**:
- **1æœˆ10æ—¥**: ä¸€æ¬¡æ€§æ”¯ä»˜å¹´è²» $336
- **æ¯æœˆ10æ—¥**: åƒ…æ”¶å–ä¸Šæœˆè¶…é¡è²»ç”¨ï¼ˆå¦‚æœæœ‰ï¼‰
- **ä¸‹å¹´1æœˆ10æ—¥**: çºŒè¨‚å¹´è²» + æœ€å¾Œä¸€å€‹æœˆçš„è¶…é¡

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾æµç¨‹

### ç”¨æˆ¶ä¸Šå‚³æ–‡ä»¶æ™‚

```javascript
// 1ï¸âƒ£ å‰ç«¯æª¢æŸ¥ Credits
window.creditsManager.checkCredits(10) 
// Pro Plan å…è¨±è² æ•¸ï¼Œè¿”å› true

// 2ï¸âƒ£ è™•ç†å®Œæˆå¾Œæ‰£é™¤ Credits
window.creditsManager.deductCredits(10)
// èª¿ç”¨ Firebase Function: deductCreditsClient

// 3ï¸âƒ£ å¾Œç«¯ deductCreditsClient åŸ·è¡Œ
async deductCreditsClient(userId, amount=10) {
    // ç•¶å‰ Credits: 5
    // æ–° Credits: 5 - 10 = -5
    const overagePages = 5; // è¶…é¡ 5 é 
    
    // âœ… è‡ªå‹•å ±å‘Šåˆ° Stripe
    await reportUsageToStripe(subscriptionId, 5, planType);
    
    // æ›´æ–° Firestore
    updateUser({
        credits: -5,
        'usageThisPeriod.totalPages': +10,
        'usageThisPeriod.overagePages': +5
    });
}

// 4ï¸âƒ£ reportUsageToStripe åŸ·è¡Œ
async reportUsageToStripe(subscriptionId, quantity=5, planType) {
    // æŸ¥æ‰¾æˆ–å‰µå»ºè¶…é¡è¨ˆè²»è¨‚é–±é …
    const subscriptionItem = findOrCreateOverageItem(subscriptionId, planType);
    
    // å ±å‘Šä½¿ç”¨é‡åˆ° Stripe
    stripe.subscriptionItems.createUsageRecord(subscriptionItem.id, {
        quantity: 5,
        timestamp: now()
    });
    
    // âœ… Stripe è¨˜éŒ„: +5 é 
}
```

### Stripe è¨ˆè²»æ—¥

```javascript
// æœˆä»˜ç”¨æˆ¶ï¼šæ¯æœˆè¨ˆè²»æ—¥ï¼ˆä¾‹å¦‚ï¼š2æœˆ10æ—¥ï¼‰
Stripe è‡ªå‹•åŸ·è¡Œï¼š
1. è¨ˆç®—åŸºç¤æœˆè²»: $38
2. æŸ¥è©¢ä¸Šæœˆä½¿ç”¨é‡è¨˜éŒ„: 50 é 
3. è¨ˆç®—è¶…é¡è²»ç”¨: 50 Ã— $0.3 = $15
4. ç¸½è²»ç”¨: $38 + $15 = $53
5. æ‰£æ¬¾ä¸¦ç™¼é€ç™¼ç¥¨

// è§¸ç™¼ Webhook: invoice.payment_succeeded
stripeWebhook åŸ·è¡Œï¼š
1. é‡ç½® Credits ç‚º 100
2. æ¸…ç©º usageThisPeriod
3. è¨˜éŒ„æ­·å²

// å¹´ä»˜ç”¨æˆ¶ï¼šæ¯æœˆè¨ˆè²»æ—¥ï¼ˆä¾‹å¦‚ï¼š2æœˆ10æ—¥ï¼‰
Stripe è‡ªå‹•åŸ·è¡Œï¼š
1. ä¸æ”¶æœˆè²»ï¼ˆå·²åœ¨å¹´åˆæ”¶å–ï¼‰
2. æŸ¥è©¢ä¸Šæœˆä½¿ç”¨é‡è¨˜éŒ„: 50 é 
3. è¨ˆç®—è¶…é¡è²»ç”¨: 50 Ã— $0.3 = $15
4. ç¸½è²»ç”¨: $15ï¼ˆåƒ…è¶…é¡ï¼‰
5. æ‰£æ¬¾ä¸¦ç™¼é€ç™¼ç¥¨

// è§¸ç™¼ Webhook: invoice.payment_succeeded
stripeWebhook åŸ·è¡Œï¼š
1. ä¸é‡ç½® Creditsï¼ˆå¹´ä»˜ä¸æŒ‰æœˆé‡ç½®ï¼‰
2. æ¸…ç©º usageThisPeriodï¼ˆåƒ…æ¸…è¶…é¡çµ±è¨ˆï¼‰
3. è¨˜éŒ„æ­·å²
```

---

## âš™ï¸ Stripe é…ç½®è¦æ±‚

### é—œéµé…ç½®

#### æœˆä»˜è¶…é¡è¨ˆè²»
```
Price ID: price_1SfZQQJmiQ31C0GTeUu6TSXE
Billing scheme: Per unit
Unit amount: $0.30
Usage type: Metered
Billing interval: Monthly
Billing anchor: è·Ÿéš¨è¨‚é–±é€±æœŸ
```

#### å¹´ä»˜è¶…é¡è¨ˆè²»
```
Price ID: price_1SfZQVJmiQ31C0GTOYgabmaJ
Billing scheme: Per unit
Unit amount: $0.30
Usage type: Metered
Billing interval: Monthly  âš ï¸ é‡è¦ï¼šè¨­ç‚º Monthlyï¼Œä¸æ˜¯ Yearlyï¼
Billing anchor: æ¯æœˆå›ºå®šæ—¥æœŸï¼ˆè¨‚é–±æ—¥ï¼‰
```

---

## ğŸ” é©—è­‰è¶…é¡è¨ˆè²»æ˜¯å¦æ­£å¸¸

### æª¢æŸ¥ Firestore

```javascript
users/{userId}
{
    "credits": -50,  // å¯ä»¥æ˜¯è² æ•¸ï¼ˆPro Planï¼‰
    "planType": "Pro Plan",
    "subscription": {
        "stripeSubscriptionId": "sub_xxx",
        "planType": "monthly" or "yearly",
        "currentPeriodStart": "2026-01-10",
        "currentPeriodEnd": "2026-02-10"
    },
    "usageThisPeriod": {
        "totalPages": 150,     // æœ¬é€±æœŸç¸½ä½¿ç”¨
        "overagePages": 50     // è¶…å‡ºå…è²»é¡åº¦çš„é æ•¸
    }
}
```

### æª¢æŸ¥ Stripe Dashboard

1. **è¨‚é–±é é¢**:
   - https://dashboard.stripe.com/subscriptions
   - æŸ¥çœ‹ç”¨æˆ¶è¨‚é–±
   - é»æ“Šã€ŒUsageã€æ¨™ç±¤

2. **æ‡‰è©²çœ‹åˆ°**:
   ```
   Usage records for this billing period:
   - 2026-01-20: +10 pages
   - 2026-01-25: +40 pages
   Total: 50 pages Ã— $0.30 = $15.00
   ```

3. **ç™¼ç¥¨é è¦½**:
   - æœˆè²»: $38.00
   - Overage (50 pages): $15.00
   - **Total: $53.00**

---

## ğŸ’¡ å¸¸è¦‹å•é¡Œ

### Q: ç‚ºä»€éº¼æœ‰å…©å€‹ reportStripeUsageï¼Ÿ

**A**: 
- `reportUsageToStripe()`ï¼ˆå…§éƒ¨å‡½æ•¸ï¼‰- ç”± `deductCreditsClient` **è‡ªå‹•èª¿ç”¨**
- `reportStripeUsage`ï¼ˆCloud Functionï¼‰- åƒ…ç”¨æ–¼**èª¿è©¦/ä¿®å¾©**

### Q: å¦‚æœè‡ªå‹•å ±å‘Šå¤±æ•—æ€éº¼è¾¦ï¼Ÿ

**A**: 
1. æŸ¥çœ‹ Firebase Functions æ—¥èªŒ
2. ä½¿ç”¨ Cloud Function `reportStripeUsage` æ‰‹å‹•è£œå ±
3. æˆ–åœ¨ Stripe Dashboard æ‰‹å‹•æ·»åŠ ä½¿ç”¨è¨˜éŒ„

### Q: å¹´ä»˜ç”¨æˆ¶ä½•æ™‚æ”¶å–è¶…é¡è²»ç”¨ï¼Ÿ

**A**: 
- **æ¯æœˆè¨‚é–±æ—¥**ï¼ˆä¾‹å¦‚ï¼š1æœˆ10æ—¥è¨‚é–±ï¼Œå‰‡æ¯æœˆ10æ—¥æ”¶å–è¶…é¡ï¼‰
- **ä¸æ˜¯**æœˆåˆæˆ–æœˆåº•
- é…ç½®æ™‚ç¢ºä¿è¶…é¡è¨ˆè²»çš„ `billing_interval` è¨­ç‚º `monthly`

### Q: Credits ä½•æ™‚é‡ç½®ï¼Ÿ

**A**: 
- **æœˆä»˜**: æ¯æœˆè¨ˆè²»æ—¥é‡ç½®ç‚º 100
- **å¹´ä»˜**: ä¸é‡ç½®ï¼ŒæŒçºŒä½¿ç”¨ 1200ï¼ˆæˆ–è² æ•¸ï¼‰

---

## âœ… ç¸½çµ

| ç‰¹æ€§ | æœˆä»˜ | å¹´ä»˜ |
|------|------|------|
| **åŸºç¤è²»ç”¨** | æ¯æœˆæ”¶å– $38 | æ¯å¹´æ”¶å– $336 |
| **åŒ…å« Credits** | 100/æœˆ | 1200/å¹´ (100/æœˆ) |
| **è¶…é¡è¨ˆè²»æ™‚é–“** | æ¯æœˆè¨ˆè²»æ—¥ä¸€æ¬¡æ”¶å– | æ¯æœˆè¨ˆè²»æ—¥ä¸€æ¬¡æ”¶å– |
| **æ”¶è²»å…§å®¹** | æœˆè²» + ä¸Šæœˆè¶…é¡ | åƒ…ä¸Šæœˆè¶…é¡ |
| **Credits é‡ç½®** | âœ… æ¯æœˆé‡ç½®ç‚º 100 | âŒ ä¸é‡ç½® |
| **è¶…é¡çµ±è¨ˆé‡ç½®** | âœ… æ¯æœˆæ¸…é›¶ | âœ… æ¯æœˆæ¸…é›¶ |

**ä¸€åˆ‡éƒ½æ˜¯è‡ªå‹•çš„ï¼ç„¡éœ€æ‰‹å‹•æ“ä½œï¼** ğŸ‰


