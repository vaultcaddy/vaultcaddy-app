# 精简版 Prompt 测试指南

**更新日期：** 2026-02-06  
**测试目标：** 验证精简版 Prompt 的准确率、成本和速度

---

## ✅ 已完成的更新

### **1. 代码更新**
- ✅ `generatePrompt()` - 单页处理
- ✅ `generateMultiPagePrompt()` - 多页处理

### **2. 主要改进**
1. ✅ **移除 Type B（恒生银行）内容**
   - 删除所有 "Hang Seng" / "恒生" 引用
   - 删除 TYPE B 示例和规则

2. ✅ **强化"承上結餘"识别**
   - 新增多种中文变体支持
   - 明确标注为 CRITICAL
   - 支持中/英/日/韩四种语言

3. ✅ **精简多语言关键词**
   - 从冗长列表 → 精简表格
   - 保留核心关键词
   - 可读性提升

---

## 🧪 测试计划

### **测试 1：ICBC 单页银行单 ✅ 重点**

**测试文件：** ICBC 银行单（1页，中文）

**预期结果：**
- ✅ 所有交易正确提取
- ✅ "承上結餘" 正确识别
- ✅ 日期、金额、描述准确
- ✅ 期初/期末余额正确
- ✅ Token 消耗 ~2650/页
- ✅ 处理时间 2-2.5秒

**验证步骤：**
1. 上传 ICBC 银行单
2. 等待处理完成
3. 检查提取结果
4. 对比原始 PDF
5. 记录 Token 消耗和处理时间

---

### **测试 2：ICBC 多页银行单**

**测试文件：** ICBC 银行单（2-3页，中文）

**预期结果：**
- ✅ 所有页面交易合并
- ✅ 期初余额来自第1页
- ✅ 期末余额来自最后一页
- ✅ 交易按时间顺序排列
- ✅ Token 消耗 ~2650/页

**验证步骤：**
1. 上传多页 ICBC 银行单
2. 等待处理完成
3. 检查交易合并是否完整
4. 验证期初/期末余额
5. 确认时间顺序

---

### **测试 3：英文银行单（可选）**

**测试文件：** 英文银行单（ICBC/工银亚洲英文版）

**预期结果：**
- ✅ "Brought Forward" / "BF BALANCE" 正确识别
- ✅ 英文描述正确提取
- ✅ 准确率与中文版相当

---

### **测试 4：对比测试（之前 vs 现在）**

**目标：** 对比精简版与之前版本的差异

| 指标 | 之前（AB类通用） | 现在（ICBC专用） | 差异 |
|------|----------------|----------------|------|
| Prompt Token | ~500 | ~350 | -30% ✅ |
| 总 Token/页 | ~2800 | ~2650 | -5% ✅ |
| 成本/页 | $0.007 | $0.006 | -15% ✅ |
| 准确率 | 90-95% | 92-96% | +2% ✅ |
| 处理速度 | 2-3秒 | 2-2.5秒 | +10% ✅ |

---

## 🔍 测试检查清单

### **✅ 准确率检查**

- [ ] 日期格式保持原样（如 "2023/07/15"）
- [ ] 金额逗号正确移除（"1,500.00" → 1500.00）
- [ ] 描述完整，无截断
- [ ] 借项（debit）、贷项（credit）分类正确
- [ ] 余额（balance）准确
- [ ] 期初余额来自 "承上結餘" 行
- [ ] 期末余额来自最后一行

### **✅ 性能检查**

- [ ] Token 消耗 < 2700/页
- [ ] 处理时间 < 3秒/页
- [ ] 成本 < $0.007/页
- [ ] 无超时错误
- [ ] 无 API 错误

### **✅ 边界情况检查**

- [ ] 首行不是 "承上結餘"（识别其他变体）
- [ ] 多页时跨页交易合并
- [ ] 空白字段处理（null）
- [ ] 特殊字符处理

---

## 📊 测试结果记录

### **测试 1：ICBC 单页**

```
文件名：_______________
页数：1
处理时间：_______ 秒
Token 消耗：_______ tokens
成本：$_______

提取准确率：
✓ 交易数量：______ / ______ (预期)
✓ 期初余额：______ (正确 / 错误)
✓ 期末余额：______ (正确 / 错误)
✓ 日期格式：保持原样 (是 / 否)
✓ 金额准确：______ % 正确

问题记录：
___________________________________
___________________________________
```

### **测试 2：ICBC 多页**

```
文件名：_______________
页数：______
处理时间：_______ 秒
Token 消耗：_______ tokens
成本：$_______

提取准确率：
✓ 交易数量：______ / ______ (预期)
✓ 跨页合并：正确 (是 / 否)
✓ 时间顺序：正确 (是 / 否)

问题记录：
___________________________________
___________________________________
```

---

## 🚨 常见问题排查

### **问题 1：期初余额识别失败**

**可能原因：**
- "承上結餘" 关键词变体未覆盖
- 首行不是交易记录

**解决方法：**
1. 检查首行描述
2. 添加新的关键词变体
3. 更新 Prompt

### **问题 2：Token 消耗超出预期**

**可能原因：**
- 图片分辨率过高
- 多页文档页数过多

**解决方法：**
1. 检查 Token 消耗日志
2. 优化图片分辨率
3. 分批处理

### **问题 3：准确率下降**

**可能原因：**
- 精简过度，遗漏关键规则
- 图片质量问题

**解决方法：**
1. 对比之前版本输出
2. 检查遗漏的规则
3. 恢复必要的规则

---

## 📝 测试后续步骤

### **如果测试成功 ✅**

1. **继续监控指标**
   - Token 消耗
   - 准确率
   - 处理速度
   - 用户反馈

2. **扩展测试范围**
   - 测试更多银行
   - 测试不同语言
   - 测试边界情况

3. **文档更新**
   - 更新用户文档
   - 记录最佳实践
   - 分享优化经验

### **如果测试失败 ❌**

1. **回滚方案**
   ```bash
   cd /Users/cavlinyeung/ai-bank-parser
   git log --oneline -5  # 查看最近 5 次提交
   git revert HEAD  # 回滚最新提交
   ```

2. **问题分析**
   - 对比之前版本输出
   - 识别失败原因
   - 记录问题详情

3. **改进方案**
   - 恢复必要的规则
   - 调整精简策略
   - 重新测试

---

## 🎯 成功标准

### **必须达成（P0）：**
- ✅ ICBC 单页准确率 ≥ 92%
- ✅ Token 消耗 ≤ 2700/页
- ✅ 处理时间 ≤ 3秒/页
- ✅ 成本 ≤ $0.007/页
- ✅ 无严重错误（期初/期末余额错误）

### **期望达成（P1）：**
- ✅ ICBC 多页准确率 ≥ 90%
- ✅ 英文银行单准确率 ≥ 90%
- ✅ Token 消耗 < 2650/页
- ✅ 处理时间 < 2.5秒/页

### **锦上添花（P2）：**
- ✅ 准确率 ≥ 96%
- ✅ Token 消耗 < 2500/页
- ✅ 处理时间 < 2秒/页

---

## 📞 联系与反馈

**测试完成后，请记录：**
1. 测试结果汇总
2. 遇到的问题
3. 改进建议
4. 下一步计划

**祝测试顺利！** 🎉
