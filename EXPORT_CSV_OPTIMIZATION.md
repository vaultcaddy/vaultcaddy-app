# 📊 CSV 導出優化說明

## 🎯 問題分析

### 圖1-2：當前項目列表 CSV 導出問題

**問題：**
1. ❌ 很多空白欄位（文檔類型、發票號碼等）
2. ❌ 只有一行數據，沒有顯示項目明細
3. ❌ 欄位設計不符合實際需求
4. ❌ 所有文檔類型使用相同格式

**示例（當前）：**
```csv
文檔名稱,文檔類型,發票號碼,日期,供應商/來源,...
3ef20519-4ddf-4a06-bf3b-edf062eb5ae2.JPG,,,,海之廉(香港)食品有限公司,...
```

---

### 圖3：當前文檔詳情 CSV 導出問題

**問題：**
1. ❌ 只有基本信息，缺少明細項目
2. ❌ 沒有顯示圖3中的詳細項目列表：
   - 1LB Fresh CLAW Crab Meat 6PK × 6 @ $141 = $846
   - 1KG日本廣島肉(GL) × 1 @ $148 = $148
   - ... 等 16 個項目

---

## ✅ 解決方案

### 核心理念

**不同文檔類型 → 不同 CSV 格式**

根據圖5（文檔類型選擇）和圖7（導出按鈕），我們需要：

1. **Receipts（收據）** → 商家、項目、金額
2. **Invoices（發票）** → 供應商、客戶、發票號、項目明細
3. **Bank Statements（銀行對帳單）** → 銀行、期間、交易記錄
4. **General（通用）** → 基本信息和提取的數據

---

## 📋 優化後的 CSV 格式

### 1. Receipts（收據）CSV 格式

**適用於：圖3 的文檔（海之廉食品）**

```csv
文檔名稱,收據編號,日期,時間,商家名稱,商家地址,商家電話,項目代碼,項目描述,項目類別,數量,單價,金額,小計,服務費,稅額,稅率,總金額,幣別,付款方式,卡號後4位,備註,上傳日期
"3ef20519-4ddf-4a06-bf3b-edf062eb5ae2.JPG","A0127005","2025-11-05","","海之廉(香港)食品有限公司","","","","1LB Fresh CLAW Crab Meat 6PK","",6,141,846,4291.4,"","","","4291.4","HKD","","","","2025/11/13"
"3ef20519-4ddf-4a06-bf3b-edf062eb5ae2.JPG","A0127005","2025-11-05","","海之廉(香港)食品有限公司","","","","1KG日本廣島肉(GL)","",1,148,148,"","","","","","","","","",""
"3ef20519-4ddf-4a06-bf3b-edf062eb5ae2.JPG","A0127005","2025-11-05","","海之廉(香港)食品有限公司","","","","500G橙色細粒子","",1,105,105,"","","","","","","","","",""
"3ef20519-4ddf-4a06-bf3b-edf062eb5ae2.JPG","A0127005","2025-11-05","","海之廉(香港)食品有限公司","","","","巴西雞中翼(30g+)","",0,18.5,116.55,"","","","","","","","","",""
"3ef20519-4ddf-4a06-bf3b-edf062eb5ae2.JPG","A0127005","2025-11-05","","海之廉(香港)食品有限公司","","","","豬頭肉","",8.8,24,211.2,"","","","","","","","","",""
... （每個項目一行）
```

**特點：**
- ✅ 每個項目一行（共 16 行）
- ✅ 顯示數量、單價、金額
- ✅ 總金額只在第一行顯示（避免重複）
- ✅ 適合導入會計軟件

---

### 2. Invoices（發票）CSV 格式

```csv
文檔名稱,發票號碼,發票日期,到期日,供應商名稱,供應商地址,供應商電話,供應商電郵,供應商稅號,客戶名稱,客戶地址,客戶電話,客戶電郵,項目代碼,項目描述,數量,單位,單價,項目小計,小計,稅額,稅率,總金額,幣別,付款條款,付款方式,銀行賬號,備註,上傳日期
"invoice-001.pdf","INV-2025-001","2025-01-12","2025-02-12","ABC Company","123 Main St","12345678","","","XYZ Corp","456 Market St","","","PRD-001","Product A",10,"件",100.50,1005.00,1005.00,80.40,"8%",1085.40,"HKD","Net 30","","","","2025/11/13"
"invoice-001.pdf","INV-2025-001","2025-01-12","2025-02-12","ABC Company","123 Main St","12345678","","","XYZ Corp","456 Market St","","","PRD-002","Product B",5,"件",200.00,1000.00,"","","",""," ","","","","",""
```

**特點：**
- ✅ 包含供應商和客戶信息
- ✅ 每個項目一行
- ✅ 項目代碼、描述、數量、單價、小計
- ✅ 適合 QuickBooks/Xero 導入

---

### 3. Bank Statements（銀行對帳單）CSV 格式

```csv
文檔名稱,銀行名稱,賬戶號碼,賬戶名稱,對帳單期間,期初餘額,期末餘額,交易日期,交易描述,交易類型,金額,餘額,參考號碼,備註,上傳日期
"statement-2025-01.pdf","HSBC","1234567890","ABC Company Ltd","2025-01-01 to 2025-01-31",50000.00,48500.00,"2025-01-05","Payment to Supplier A","Debit",-1500.00,48500.00,"TXN-001","","2025/11/13"
"statement-2025-01.pdf","HSBC","1234567890","ABC Company Ltd","2025-01-01 to 2025-01-31",50000.00,48500.00,"2025-01-10","Received from Customer B","Credit",5000.00,53500.00,"TXN-002","","2025/11/13"
```

**特點：**
- ✅ 每筆交易一行
- ✅ 包含日期、描述、金額、餘額
- ✅ 適合對帳和分析

---

### 4. General（通用文檔）CSV 格式

```csv
文檔名稱,文檔類型,標題,文檔編號,日期,實體名稱,實體類型,金額,幣別,摘要,關鍵詞,語言,備註,上傳日期
"contract-2025.pdf","contract","Service Agreement","CON-2025-001","2025-01-15","ABC Company (organization); John Doe (person); 123 Main St (address)","","50000; 10000","HKD","This is a service agreement...","payment; terms; delivery","en","","2025/11/13"
```

**特點：**
- ✅ 提取實體（公司、人名、地址）
- ✅ 識別金額和日期
- ✅ 生成摘要和關鍵詞
- ✅ 適合文檔管理

---

## 🔧 實施方案

### 步驟 1：在 `firstproject.html` 中引入優化模塊

```html
<!-- 在 </body> 前添加 -->
<script src="export-optimizer.js"></script>
```

---

### 步驟 2：修改導出按鈕事件

**找到當前的導出代碼：**
```javascript
// 當前（約在 2342 行）
function generateCSV(docs) {
    // ... 舊代碼
}
```

**替換為：**
```javascript
// 使用優化版
function generateCSV(docs) {
    return ExportOptimizer.generateCSV(docs);
}
```

---

### 步驟 3：測試不同文檔類型

**測試清單：**
- [ ] 上傳收據（Receipts）→ 導出 CSV → 檢查項目明細
- [ ] 上傳發票（Invoices）→ 導出 CSV → 檢查供應商/客戶
- [ ] 上傳銀行對帳單（Bank Statements）→ 導出 CSV → 檢查交易記錄
- [ ] 上傳通用文檔（General）→ 導出 CSV → 檢查提取數據

---

## 📊 對比示例

### 圖3 文檔（海之廉食品收據）

#### 優化前（當前）
```csv
文檔名稱,文檔類型,發票號碼,日期,供應商/來源,...
3ef20519-4ddf-4a06-bf3b-edf062eb5ae2.JPG,,,,海之廉(香港)食品有限公司,...
```
- ❌ 只有 1 行
- ❌ 缺少項目明細
- ❌ 很多空白欄位

---

#### 優化後（新版）
```csv
文檔名稱,收據編號,日期,商家名稱,項目描述,數量,單價,金額,總金額
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","1LB Fresh CLAW Crab Meat 6PK",6,141,846,4291.4
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","1KG日本廣島肉(GL)",1,148,148,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","500G橙色細粒子",1,105,105,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","巴西雞中翼(30g+)",0,18.5,116.55,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","豬頭肉",8.8,24,211.2,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","金絲脆皮芝士腸",4,24.5,69,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","粗鹿肉卷",2,34.5,58.5,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","日本仿鱈魚肉蟹柳(200g)",3,19.5,216.75,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","按礦 雞腳",25.5,8.5,216.75,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","雞殼骨",15.5,6.8,105.4,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","沙嗲鳳爪",5.5,16.5,90.75,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","紐西蘭銀壓單棒肉",8,61,488,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","沙嗲 熟雞腸",5.5,33,181.5,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","魚皮",22.1,11,243.1,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","特級肥牛肉片",4.5,38.5,173.25,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","烏頭肥牛",14,71,994,""
"3ef20519...JPG","A0127005","2025-11-05","海之廉(香港)食品有限公司","沙嗲 牛根",5.6,19,106.4,""
```
- ✅ 共 17 行（16 個項目 + 標題）
- ✅ 包含所有項目明細
- ✅ 數量、單價、金額清晰
- ✅ 總金額只在第一行（避免重複計算）

---

## 🎯 用戶場景

### 場景 1：個人/自由工作者

**需求：** 整理收據報稅

**導出：** Receipts CSV
```csv
商家名稱,日期,項目描述,金額,總金額
"海之廉食品","2025-11-05","1LB Fresh CLAW Crab Meat 6PK",846,4291.4
"海之廉食品","2025-11-05","1KG日本廣島肉(GL)",148,""
...
```

**用途：**
- ✅ 導入 Excel 分類整理
- ✅ 計算總支出
- ✅ 報稅時提供明細

---

### 場景 2：小型企業

**需求：** 管理供應商發票

**導出：** Invoices CSV
```csv
發票號碼,供應商名稱,項目描述,數量,單價,總金額
"INV-001","ABC Company","Product A",10,100.50,1085.40
"INV-001","ABC Company","Product B",5,200.00,""
```

**用途：**
- ✅ 導入 QuickBooks
- ✅ 對帳和付款
- ✅ 成本分析

---

### 場景 3：會計事務所

**需求：** 處理客戶銀行對帳單

**導出：** Bank Statements CSV
```csv
交易日期,交易描述,金額,餘額
"2025-01-05","Payment to Supplier A",-1500.00,48500.00
"2025-01-10","Received from Customer B",5000.00,53500.00
```

**用途：**
- ✅ 對帳
- ✅ 現金流分析
- ✅ 審計追蹤

---

## 🚀 下一步

### 立即執行（今天）

1. **在 `firstproject.html` 中引入優化模塊**
   ```html
   <script src="export-optimizer.js"></script>
   ```

2. **替換 `generateCSV` 函數**
   ```javascript
   function generateCSV(docs) {
       return ExportOptimizer.generateCSV(docs);
   }
   ```

3. **測試導出**
   - 上傳圖3的收據
   - 點擊 Export → CSV
   - 檢查是否有 16 行項目明細

---

### 進一步優化（本週）

4. **添加導出選項**
   - 讓用戶選擇：「詳細版」vs「摘要版」
   - 詳細版：每個項目一行
   - 摘要版：每個文檔一行

5. **優化 IIF/QBO 導出**
   - 同樣根據文檔類型生成不同格式
   - 確保 QuickBooks 可以正確導入

---

## 💡 關鍵理解

### Q1: 為什麼要根據文檔類型生成不同 CSV？

**A:** 因為不同文檔的數據結構完全不同！

**示例：**
- **收據：** 商家 + 項目列表 + 總額
- **發票：** 供應商 + 客戶 + 項目列表 + 稅額
- **銀行對帳單：** 銀行 + 期間 + 交易列表
- **通用文檔：** 標題 + 實體 + 摘要

**如果用同一格式：**
- ❌ 收據的「商家」放在「供應商」欄位（不準確）
- ❌ 銀行對帳單的「交易」無法顯示（缺少欄位）
- ❌ 很多空白欄位（浪費空間）

---

### Q2: 為什麼每個項目一行？

**A:** 這是會計軟件的標準格式！

**QuickBooks 導入格式：**
```csv
發票號碼,項目描述,數量,單價,金額
INV-001,Product A,10,100,1000
INV-001,Product B,5,200,1000
```

**如果所有項目在一行：**
```csv
發票號碼,項目明細,總金額
INV-001,"Product A x10; Product B x5",2000
```
- ❌ QuickBooks 無法識別
- ❌ 無法自動分類
- ❌ 無法計算成本

---

### Q3: 圖1-2 的空白欄位問題？

**A:** 因為當前使用「通用格式」，包含所有可能欄位！

**當前格式（22 個欄位）：**
```
文檔名稱,文檔類型,發票號碼,日期,供應商/來源,供應商地址,供應商電話,供應商電郵,客戶名稱,客戶地址,項目明細,小計,稅額,稅率,總金額,幣別,付款條款,付款方式,銀行賬號,備註,狀態,上傳日期
```

**問題：**
- 收據沒有「客戶名稱」→ 空白
- 收據沒有「付款條款」→ 空白
- 收據沒有「銀行賬號」→ 空白

**優化後（收據專用格式，15 個欄位）：**
```
文檔名稱,收據編號,日期,商家名稱,項目描述,數量,單價,金額,總金額,幣別,付款方式,備註,上傳日期
```
- ✅ 只包含收據相關欄位
- ✅ 沒有空白欄位
- ✅ 數據更清晰

---

**準備好測試了嗎？** 🚀

1. 引入 `export-optimizer.js`
2. 替換 `generateCSV` 函數
3. 上傳圖3的收據測試
4. 檢查是否有 16 行項目明細

請告訴我測試結果！📊

