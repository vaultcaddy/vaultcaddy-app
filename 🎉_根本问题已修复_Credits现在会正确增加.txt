# ğŸ‰ æ ¹æœ¬é—®é¢˜å·²ä¿®å¤ï¼Credits ç°åœ¨ä¼šæ­£ç¡®å¢åŠ 

## ğŸš¨ **é—®é¢˜æ ¹æœ¬åŸå› **

### **å‘ç°çš„æ ¸å¿ƒé—®é¢˜**

`addCredits` å‡½æ•°**åªæ›´æ–°äº† `credits` å­—æ®µï¼Œæ²¡æœ‰æ›´æ–° `currentCredits` å­—æ®µ**ï¼

**åŸä»£ç ï¼š**
```javascript
transaction.update(userRef, {
    credits: newCredits,  // âœ… åªæ›´æ–°äº†è¿™ä¸ªå­—æ®µ
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
});
```

**é—®é¢˜ï¼š**
- Firebase ç”¨æˆ·æ–‡æ¡£æœ‰ä¸¤ä¸ªå­—æ®µï¼š`credits` å’Œ `currentCredits`
- å‰ç«¯æ˜¾ç¤ºçš„æ˜¯ `currentCredits` å­—æ®µ
- ä½† `addCredits` å‡½æ•°åªæ›´æ–°äº† `credits` å­—æ®µ
- æ‰€ä»¥å‰ç«¯ä¸€ç›´æ˜¾ç¤º `currentCredits: 0`

---

## âœ… **ä¿®å¤å†…å®¹**

### **æ–‡ä»¶**: `firebase-functions/index.js`
### **å‡½æ•°**: `addCredits`ï¼ˆç¬¬ 420 è¡Œï¼‰

**ä¿®å¤åçš„ä»£ç ï¼š**
```javascript
async function addCredits(userId, amount, metadata = {}) {
    console.log(`ğŸ” addCredits è¢«è°ƒç”¨: userId=${userId}, amount=${amount}, metadata=`, metadata);
    const userRef = db.collection('users').doc(userId);
    
    await db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userRef);
        
        if (!userDoc.exists) {
            console.error(`âŒ ç”¨æˆ·æ–‡æ¡£ä¸å­˜åœ¨: ${userId}`);
            throw new Error(`User document not found: ${userId}`);
        }
        
        const userData = userDoc.data();
        console.log(`ğŸ“Š å½“å‰ç”¨æˆ·æ•°æ®:`, userData);
        
        const currentCredits = userData?.credits || 0;
        const newCredits = currentCredits + amount;
        
        console.log(`ğŸ’° Credits æ›´æ–°: ${currentCredits} + ${amount} = ${newCredits}`);
        
        // âœ… åŒæ—¶æ›´æ–° credits å’Œ currentCredits å­—æ®µ
        transaction.update(userRef, {
            credits: newCredits,
            currentCredits: newCredits,  // âœ… æ–°å¢ï¼šä¹Ÿæ›´æ–° currentCredits
            updatedAt: admin.firestore.FieldValue.serverTimestamp()
        });
        
        // è¨˜éŒ„ Credits æ­·å²
        const historyRef = userRef.collection('creditsHistory').doc();
        transaction.set(historyRef, {
            type: 'add',
            amount: amount,
            before: currentCredits,
            after: newCredits,
            metadata: metadata,
            createdAt: admin.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`âœ… Credits å·²æ·»åŠ : ${userId} +${amount} = ${newCredits}`);
        console.log(`âœ… credits å’Œ currentCredits å‡å·²æ›´æ–°ä¸º: ${newCredits}`);
    });
}
```

---

## ğŸ“Š **ä¿®å¤æ¸…å•**

### **1. Email æ³¨å†Œæ—¶åˆ›å»º email å­—æ®µ** âœ…
- **æ–‡ä»¶**: `simple-auth.js`
- **çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•é€šè¿‡
- **æ•ˆæœ**: æ–°ç”¨æˆ·æ³¨å†Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»º `email` å­—æ®µï¼ˆå°å†™ï¼‰

### **2. addCredits åŒæ—¶æ›´æ–°ä¸¤ä¸ªå­—æ®µ** âœ…
- **æ–‡ä»¶**: `firebase-functions/index.js`
- **çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶éƒ¨ç½²
- **æ•ˆæœ**: ç°åœ¨ä¼šåŒæ—¶æ›´æ–° `credits` å’Œ `currentCredits` å­—æ®µ

---

## ğŸ§ª **ç°åœ¨è¯·é‡æ–°æµ‹è¯•**

### **æµ‹è¯• 1ï¼šEmail éªŒè¯åå¢åŠ  20 Credits**

1. ä½¿ç”¨å½“å‰ç”¨æˆ· `vaultcaddy@gmail.com`ï¼ˆæœªéªŒè¯çš„ï¼‰
2. è®¿é—® verify-email.htmlï¼ˆå¦‚æœéœ€è¦é‡æ–°å‘é€éªŒè¯ç ï¼‰
3. è¾“å…¥éªŒè¯ç 
4. éªŒè¯æˆåŠŸåï¼Œæ£€æŸ¥ Firebase Console

**é¢„æœŸç»“æœï¼š**
```
ç”¨æˆ·: PxOIosAk2nUmi6x647YIdniiuFC3
â”œâ”€â”€ credits: 20  â† ä» 0 å¢åŠ åˆ° 20
â”œâ”€â”€ currentCredits: 20  â† ä» 0 å¢åŠ åˆ° 20
â””â”€â”€ emailVerified: true  â† ä» false å˜ä¸º true
```

---

### **æµ‹è¯• 2ï¼šStripe æ”¯ä»˜åå¢åŠ  100 Credits**

1. è®¿é—® https://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. ä½¿ç”¨æµ‹è¯•å¡ï¼š**4242 4242 4242 4242**
4. å®Œæˆæ”¯ä»˜

**é¢„æœŸç»“æœï¼š**
```
ç”¨æˆ·: PxOIosAk2nUmi6x647YIdniiuFC3
â”œâ”€â”€ credits: 120  â† ä» 20 å¢åŠ åˆ° 120
â””â”€â”€ currentCredits: 120  â† ä» 20 å¢åŠ åˆ° 120
```

**å‰ç«¯æ˜¾ç¤ºï¼š**
```
Credits: 120
```

---

## ğŸ” **å¦‚ä½•ç¡®è®¤ä¿®å¤æˆåŠŸ**

### **æ­¥éª¤ 1ï¼šæŸ¥çœ‹ Firebase Functions æ—¥å¿—**

è¿è¡Œï¼š
```bash
firebase functions:log --only verifyCode 2>&1 | tail -50
```

**é¢„æœŸæ—¥å¿—ï¼ˆEmail éªŒè¯ï¼‰ï¼š**
```
ğŸ” addCredits è¢«è°ƒç”¨: userId=PxOIosAk2nUmi6x647YIdniiuFC3, amount=20, metadata=...
ğŸ“Š å½“å‰ç”¨æˆ·æ•°æ®: { email: "vaultcaddy@gmail.com", credits: 0, currentCredits: 0, ... }
ğŸ’° Credits æ›´æ–°: 0 + 20 = 20
âœ… Credits å·²æ·»åŠ : PxOIosAk2nUmi6x647YIdniiuFC3 +20 = 20
âœ… credits å’Œ currentCredits å‡å·²æ›´æ–°ä¸º: 20
```

---

### **æ­¥éª¤ 2ï¼šæŸ¥çœ‹ Firebase Console**

åœ¨ Firebase Console ä¸­åˆ·æ–°ç”¨æˆ·æ–‡æ¡£ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
- âœ… `credits` å­—æ®µæ›´æ–°
- âœ… `currentCredits` å­—æ®µæ›´æ–°
- âœ… ä¸¤ä¸ªå­—æ®µçš„å€¼ç›¸åŒ

---

### **æ­¥éª¤ 3ï¼šæŸ¥çœ‹å‰ç«¯æ˜¾ç¤º**

åˆ·æ–° VaultCaddy å‰ç«¯é¡µé¢ï¼ˆhttps://vaultcaddy.com/dashboard.htmlï¼‰ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
- âœ… `Credits: 20`ï¼ˆemail éªŒè¯åï¼‰
- âœ… `Credits: 120`ï¼ˆæµ‹è¯•æ”¯ä»˜åï¼‰

---

## ğŸ“ **å®Œæˆæµ‹è¯•åè¯·å‘Šè¯‰æˆ‘**

1. âœ… Email éªŒè¯å Credits æ˜¯å¦ä» 0 å¢åŠ åˆ° 20ï¼Ÿ
2. âœ… Firebase Console ä¸­ `credits` å’Œ `currentCredits` æ˜¯å¦éƒ½æ›´æ–°äº†ï¼Ÿ
3. âœ… å‰ç«¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤º Creditsï¼Ÿ
4. âœ… æµ‹è¯•æ”¯ä»˜å Credits æ˜¯å¦ä» 20 å¢åŠ åˆ° 120ï¼Ÿ

**å¦‚æœä»¥ä¸Šéƒ½æˆåŠŸï¼Œè¯´æ˜é—®é¢˜å·²å®Œå…¨è§£å†³ï¼** ğŸ‰

---

## ğŸ“ **é—®é¢˜æ€»ç»“**

### **æ ¹æœ¬åŸå› **
- ç”¨æˆ·æ–‡æ¡£æœ‰ä¸¤ä¸ª Credits å­—æ®µï¼š`credits` å’Œ `currentCredits`
- `addCredits` å‡½æ•°åªæ›´æ–°äº† `credits`
- å‰ç«¯æ˜¾ç¤ºçš„æ˜¯ `currentCredits`
- æ‰€ä»¥å³ä½¿ Credits å¢åŠ äº†ï¼Œå‰ç«¯ä¹Ÿä¸ä¼šæ˜¾ç¤º

### **è§£å†³æ–¹æ¡ˆ**
- âœ… ä¿®æ”¹ `addCredits` å‡½æ•°ï¼ŒåŒæ—¶æ›´æ–°ä¸¤ä¸ªå­—æ®µ
- âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- âœ… éªŒè¯ç”¨æˆ·æ–‡æ¡£å­˜åœ¨

### **å½±å“èŒƒå›´**
- âœ… Email éªŒè¯çš„ 20 Credits ç°åœ¨ä¼šæ­£ç¡®å¢åŠ 
- âœ… Stripe æ”¯ä»˜çš„ 100 Credits ç°åœ¨ä¼šæ­£ç¡®å¢åŠ 
- âœ… å‰ç«¯ä¼šæ­£ç¡®æ˜¾ç¤º Credits

---

## ğŸš€ **ä¸‹ä¸€æ­¥**

**è¯·ç«‹å³é‡æ–°æµ‹è¯•ï¼**

1. é‡æ–°éªŒè¯ emailï¼ˆå¦‚æœè¿˜æœªéªŒè¯ï¼‰
2. æˆ–è€…è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜

**å®Œæˆåå‘Šè¯‰æˆ‘ç»“æœï¼** ğŸ™

