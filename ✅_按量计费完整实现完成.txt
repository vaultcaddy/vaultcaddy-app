# âœ… æŒ‰é‡è®¡è´¹å®Œæ•´å®ç°å®Œæˆï¼

## ğŸ‰ **ä¿®å¤å®Œæˆï¼**

æ‰€æœ‰ä»£ç å·²æˆåŠŸéƒ¨ç½²åˆ° Firebaseï¼

---

## ğŸ“‹ **å®Œæˆçš„ä¿®æ”¹**

### **1. åç«¯ Firebase Functions (`index.js`)**

#### **âœ… `handleCheckoutCompleted` å‡½æ•°**
- åœ¨è®¢é˜…åˆ›å»ºåï¼Œè‡ªåŠ¨æŸ¥æ‰¾å¹¶ä¿å­˜ `meteredSubscriptionItemId`
- åˆå§‹åŒ– `includedCredits`ï¼ˆè®¢é˜…åŒ…å«çš„ Credits æ•°é‡ï¼‰
- åˆå§‹åŒ– `totalCreditsUsed = 0`ï¼ˆç´¯è®¡ä½¿ç”¨é‡ï¼‰

**ä¿å­˜çš„å­—æ®µ**ï¼š
```javascript
{
  includedCredits: 100 or 1200,  // è®¢é˜…åŒ…å«çš„ Credits
  totalCreditsUsed: 0,            // ç´¯è®¡ä½¿ç”¨é‡
  subscription: {
    meteredSubscriptionItemId: "si_xxx", // â† æŒ‰é‡è®¡è´¹ item ID
    stripeSubscriptionId: "sub_xxx"
  }
}
```

#### **âœ… `handleSubscriptionChange` å‡½æ•°**
- è®¢é˜…æ›´æ–°æ—¶ï¼Œä¹ŸæŸ¥æ‰¾å¹¶ä¿å­˜ `meteredSubscriptionItemId`
- ç¡®ä¿å³ä½¿ç”¨æˆ·å–æ¶ˆåé‡æ–°è®¢é˜…ï¼Œä¹Ÿèƒ½æ­£ç¡®ä¿å­˜

#### **âœ… æ–°å¢ `reportCreditsUsage` Cloud Function**
- æ¥æ”¶å‰ç«¯è¯·æ±‚ï¼ŒæŠ¥å‘Šä½¿ç”¨é‡åˆ° Stripe
- éªŒè¯ç”¨æˆ·èº«ä»½å’Œè®¢é˜…çŠ¶æ€
- è®¡ç®—è¶…é¢ä½¿ç”¨é‡ï¼ˆtotalCreditsUsed - includedCreditsï¼‰
- ä½¿ç”¨ Stripe API æŠ¥å‘Šä½¿ç”¨é‡

**Cloud Function URL**ï¼š
```
https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/reportCreditsUsage
```

---

### **2. å‰ç«¯ `credits-manager.js`**

#### **âœ… `loadUserCredits` å‡½æ•°**
- å·²åŠ è½½ `planType`ï¼ˆPro Plan / Free Planï¼‰

#### **âœ… `checkCredits` å‡½æ•°**
- Pro Plan ç”¨æˆ·ï¼šå…è®¸è´Ÿæ•° Credits âœ…
- Free Plan ç”¨æˆ·ï¼šæ£€æŸ¥ Credits æ˜¯å¦è¶³å¤Ÿ âœ…

#### **âœ… `deductCredits` å‡½æ•°ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰**
- åŠ è½½ `totalCreditsUsed` å’Œ `includedCredits`
- æ‰£é™¤ Credits æ—¶ï¼ŒåŒæ—¶æ›´æ–° `totalCreditsUsed`
- æ‰£é™¤åï¼Œå¦‚æœæ˜¯ Pro Plan ä¸”è¶…é¢ï¼Œè‡ªåŠ¨è°ƒç”¨åç«¯ Cloud Function æŠ¥å‘Šä½¿ç”¨é‡
- è¯¦ç»†çš„ Console æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

---

## ğŸ“Š **å®Œæ•´æµç¨‹ç¤ºä¾‹**

### **åœºæ™¯ï¼šå¹´è´¹ç”¨æˆ·ï¼ˆ1,200 Creditsï¼‰è¶…é¢ä½¿ç”¨**

#### **æ­¥éª¤ 1ï¼šç”¨æˆ·è®¢é˜…å¹´è´¹**
```
ç”¨æˆ·æ”¯ä»˜ HK$552 â†’ checkout.session.completed
  â†“
handleCheckoutCompleted:
  - æ·»åŠ  1,200 Credits
  - ä¿å­˜ includedCredits: 1200
  - ä¿å­˜ totalCreditsUsed: 0
  - ä¿å­˜ meteredSubscriptionItemId: "si_xxx"
  â†“
Firestore:
{
  credits: 1200,
  currentCredits: 1200,
  totalCreditsUsed: 0,
  includedCredits: 1200,
  planType: "Pro Plan",
  subscription: {
    meteredSubscriptionItemId: "si_xxx"
  }
}
```

#### **æ­¥éª¤ 2ï¼šç”¨æˆ·ä½¿ç”¨ 1,200 ä¸ª Credits**
```
ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£ 1,200 æ¬¡
  â†“
deductCredits è¢«è°ƒç”¨ 1,200 æ¬¡
  â†“
Firestore:
{
  credits: 0,
  currentCredits: 0,
  totalCreditsUsed: 1200,  // ç´¯è®¡ä½¿ç”¨é‡
  includedCredits: 1200
}
  â†“
æ£€æŸ¥ï¼štotalCreditsUsed (1200) <= includedCredits (1200)
  â†“
âœ… ä¸è¶…é¢ï¼Œä¸æŠ¥å‘Š
```

#### **æ­¥éª¤ 3ï¼šç”¨æˆ·ç»§ç»­ä½¿ç”¨ 1 ä¸ª Creditï¼ˆè¶…é¢ï¼‰**
```
ç”¨æˆ·ä¸Šä¼  1 é¡µæ–‡æ¡£
  â†“
å‰ç«¯ deductCredits:
  - credits: 0 â†’ -1
  - totalCreditsUsed: 1200 â†’ 1201
  â†“
Firestore æ›´æ–°:
{
  credits: -1,
  currentCredits: -1,
  totalCreditsUsed: 1201
}
  â†“
æ£€æŸ¥ï¼štotalCreditsUsed (1201) > includedCredits (1200)
  â†“
ğŸ”” è¶…é¢ï¼è°ƒç”¨ reportCreditsUsage()
  â†“
åç«¯ Cloud Function:
  - è®¡ç®—è¶…é¢: 1201 - 1200 = 1
  - è°ƒç”¨ Stripe API: createUsageRecord(si_xxx, quantity=1)
  â†“
Stripe è®°å½•:
  - ä½¿ç”¨é‡: 1 credit
  - è´¹ç”¨: 1 Ã— HK$0.50 = HK$0.50
  â†“
ä¸‹æ¬¡è´¦å•ï¼ˆ2026å¹´12æœˆ13æ—¥ï¼‰:
  - è®¢é˜…è´¹: HK$552.00
  - è¶…é¢è´¹: HK$0.50
  - æ€»è®¡: HK$552.50
```

#### **æ­¥éª¤ 4ï¼šç”¨æˆ·å†ä½¿ç”¨ 10 ä¸ª Credits**
```
ç”¨æˆ·ä¸Šä¼  10 é¡µæ–‡æ¡£
  â†“
totalCreditsUsed: 1201 â†’ 1211
  â†“
è¶…é¢: 1211 - 1200 = 11
  â†“
æŠ¥å‘Šç»™ Stripe: quantity=11 (ä½¿ç”¨ 'set'ï¼Œä¸æ˜¯ 'increment')
  â†“
Stripe è®°å½•æ›´æ–°:
  - ä½¿ç”¨é‡: 11 credits
  - è´¹ç”¨: 11 Ã— HK$0.50 = HK$5.50
  â†“
ä¸‹æ¬¡è´¦å•:
  - è®¢é˜…è´¹: HK$552.00
  - è¶…é¢è´¹: HK$5.50
  - æ€»è®¡: HK$557.50
```

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

### **æµ‹è¯• 1ï¼šé¦–æ¬¡è®¢é˜…ï¼ˆä¿å­˜ metered item IDï¼‰**

1. **æ¸…ç©ºç°æœ‰è®¢é˜…**
   - Firebase Console â†’ Firestore â†’ users â†’ æ‚¨çš„ç”¨æˆ· ID
   - åˆ é™¤ `subscription` å­—æ®µ

2. **é‡æ–°è®¢é˜…å¹´è´¹**
   - è®¿é—®ï¼šhttps://vaultcaddy.com/billing.html
   - ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started (å¹´è´¹)"**
   - ä½¿ç”¨æµ‹è¯•å¡å·ï¼š`4242 4242 4242 4242`
   - å®Œæˆæ”¯ä»˜

3. **éªŒè¯ Firestore**
   - Firebase Console â†’ Firestore â†’ users â†’ æ‚¨çš„ç”¨æˆ· ID
   - åº”è¯¥çœ‹åˆ°ï¼š
     ```json
     {
       "credits": 1200,
       "currentCredits": 1200,
       "totalCreditsUsed": 0,
       "includedCredits": 1200,
       "planType": "Pro Plan",
       "subscription": {
         "meteredSubscriptionItemId": "si_xxxxx",  // â† åº”è¯¥å­˜åœ¨ï¼
         "stripeSubscriptionId": "sub_xxxxx"
       }
     }
     ```

4. **å¦‚æœ `meteredSubscriptionItemId` ä¸å­˜åœ¨**
   - æŸ¥çœ‹ Cloud Functions æ—¥å¿—
   - Firebase Console â†’ Functions â†’ reportCreditsUsage â†’ Logs
   - æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯

---

### **æµ‹è¯• 2ï¼šè¶…é¢ä½¿ç”¨ï¼ˆæŠ¥å‘Šç»™ Stripeï¼‰**

1. **æ‰‹åŠ¨ä¿®æ”¹ Credits**
   - Firebase Console â†’ Firestore â†’ users â†’ æ‚¨çš„ç”¨æˆ· ID
   - ä¿®æ”¹ï¼š
     ```json
     {
       "credits": 0,
       "currentCredits": 0,
       "totalCreditsUsed": 1200  // â† å·²ç”¨å®ŒåŒ…å«çš„ Credits
     }
     ```

2. **ä¸Šä¼  1 é¡µæ–‡æ¡£**
   - è®¿é—®ï¼šhttps://vaultcaddy.com/firstproject.html
   - æŒ‰ `F12` æ‰“å¼€ Console
   - ä¸Šä¼  1 é¡µæ–‡æ¡£

3. **æŸ¥çœ‹ Console æ—¥å¿—ï¼ˆå‰ç«¯ï¼‰**
   åº”è¯¥çœ‹åˆ°ï¼š
   ```
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ğŸ’° æ‰£é™¤ Credits (credits-manager.js v3.0)
      ç•¶å‰ Credits: 0
      æ‰£é™¤é æ•¸: 1
      è¨ˆåŠƒé¡å‹: Pro Plan
      ç´¯è¨ˆä½¿ç”¨: 1200
      åŒ…å« Credits: 1200
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      æ–° Credits: -1
      æ–°ç´¯è¨ˆä½¿ç”¨: 1201
   âœ… Credits å·²æ‰£é™¤: 1 é ï¼Œå‰©é¤˜: -1
   
   ğŸ”” Pro Plan ç”¨æˆ¶è¶…é¡ä½¿ç”¨ï¼Œæº–å‚™å ±å‘Šçµ¦ Stripe
      ç´¯è¨ˆä½¿ç”¨: 1201
      åŒ…å« Credits: 1200
      è¶…é¡: 1
   âœ… ä½¿ç”¨é‡å·²å ±å‘Šçµ¦ Stripe: { success: true, overage: 1, ... }
   ```

4. **éªŒè¯ Firestore**
   ```json
   {
     "credits": -1,
     "currentCredits": -1,
     "totalCreditsUsed": 1201
   }
   ```

5. **æŸ¥çœ‹ Cloud Functions æ—¥å¿—**
   - Firebase Console â†’ Functions â†’ reportCreditsUsage â†’ Logs
   åº”è¯¥çœ‹åˆ°ï¼š
   ```
   ğŸ“¡ å ±å‘Š Credits ä½¿ç”¨é‡: userId=xxx
   ğŸ“Š ç”¨æˆ¶æ•¸æ“š: { totalCreditsUsed: 1201, includedCredits: 1200, ... }
   ğŸ“Š è¨ˆç®—è¶…é¡: totalCreditsUsed=1201, includedCredits=1200, overage=1
   ğŸ”§ ä½¿ç”¨ æ¸¬è©¦ æ¨¡å¼çš„ Stripe å®¢æˆ¶ç«¯
   âœ… ä½¿ç”¨é‡å·²å ±å‘Šçµ¦ Stripe: { id: 'mbur_xxx', quantity: 1, ... }
   ```

6. **æŸ¥çœ‹ Stripe Dashboard**
   - è®¿é—®ï¼šhttps://dashboard.stripe.com/test/subscriptions
   - æ‰¾åˆ°æ‚¨çš„è®¢é˜…
   - ç‚¹å‡» **"Usage"** æ ‡ç­¾
   - åº”è¯¥çœ‹åˆ°ï¼š
     ```
     vaultcaddy_credit_usage: 1
     Amount: HK$0.50
     ```

---

### **æµ‹è¯• 3ï¼šç»§ç»­è¶…é¢ä½¿ç”¨ï¼ˆç´¯è®¡æŠ¥å‘Šï¼‰**

1. **ä¸Šä¼  5 é¡µæ–‡æ¡£**
   - totalCreditsUsed: 1201 â†’ 1206
   - è¶…é¢: 1206 - 1200 = 6

2. **æŸ¥çœ‹ Stripe Dashboard**
   - Usage åº”è¯¥æ›´æ–°ä¸ºï¼š
     ```
     vaultcaddy_credit_usage: 6
     Amount: HK$3.00
     ```

---

## ğŸ” **æ•…éšœæ’é™¤**

### **é—®é¢˜ 1ï¼š`meteredSubscriptionItemId` æœªä¿å­˜**

**ç—‡çŠ¶**ï¼š
- Firestore ä¸­æ²¡æœ‰ `subscription.meteredSubscriptionItemId` å­—æ®µ

**åŸå› **ï¼š
- è®¢é˜…åˆ›å»ºæ—¶ï¼ŒStripe æ²¡æœ‰è¿”å› metered item
- æˆ–è€…ä»£ç æ²¡æœ‰æ­£ç¡®æŸ¥æ‰¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Stripe Dashboard â†’ Products â†’ VaultCaddy Yearly
2. ç¡®è®¤æœ‰ 2 ä¸ª Pricesï¼š
   - å›ºå®šä»·æ ¼ï¼ˆHK$552/yearï¼‰
   - æŒ‰é‡ä»·æ ¼ï¼ˆHK$0.50/creditï¼Œusage_type: meteredï¼‰
3. é‡æ–°è®¢é˜…
4. æŸ¥çœ‹ Cloud Functions æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æ‰¾åˆ° metered item

---

### **é—®é¢˜ 2ï¼šå‰ç«¯æ²¡æœ‰è°ƒç”¨ `reportCreditsUsage`**

**ç—‡çŠ¶**ï¼š
- Credits å˜æˆè´Ÿæ•°ï¼Œä½† Stripe æ²¡æœ‰ä½¿ç”¨é‡è®°å½•
- Console æ²¡æœ‰æ˜¾ç¤º "å ±å‘Šçµ¦ Stripe"

**åŸå› **ï¼š
- `totalCreditsUsed` æˆ– `includedCredits` å­—æ®µç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Firestore ç”¨æˆ·æ–‡æ¡£ï¼Œç¡®è®¤æœ‰ï¼š
   ```json
   {
     "totalCreditsUsed": 1201,
     "includedCredits": 1200
   }
   ```
2. å¦‚æœç¼ºå¤±ï¼Œæ‰‹åŠ¨æ·»åŠ è¿™äº›å­—æ®µ
3. é‡æ–°ä¸Šä¼ æ–‡æ¡£æµ‹è¯•

---

### **é—®é¢˜ 3ï¼šStripe API æŠ¥é”™**

**ç—‡çŠ¶**ï¼š
- Cloud Functions æ—¥å¿—æ˜¾ç¤º "å ±å‘Š Stripe ä½¿ç”¨é‡å¤±æ•—"

**å¯èƒ½åŸå› **ï¼š
- `meteredSubscriptionItemId` é”™è¯¯
- Stripe API Key é”™è¯¯
- Meter é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `meteredSubscriptionItemId` æ˜¯å¦æ­£ç¡®
2. åœ¨ Stripe Dashboard æ‰‹åŠ¨æŸ¥æ‰¾è®¢é˜…çš„ Subscription Item ID
3. ç¡®è®¤ Meter å­˜åœ¨ä¸”æ­£ç¡®é…ç½®

---

## ğŸ“Š **è´¹ç”¨è®¡ç®—ç¤ºä¾‹**

### **æœˆè´¹ï¼ˆHK$58/æœˆï¼Œ100 Creditsï¼‰**

| ä½¿ç”¨é‡ | totalCreditsUsed | è¶…é¢ | è¶…é¢è´¹ç”¨ | ä¸‹æ¬¡è´¦å•æ€»é¢ |
|--------|------------------|------|---------|-------------|
| 50 | 50 | 0 | HK$0.00 | HK$58.00 |
| 100 | 100 | 0 | HK$0.00 | HK$58.00 |
| 101 | 101 | 1 | HK$0.50 | HK$58.50 |
| 110 | 110 | 10 | HK$5.00 | HK$63.00 |
| 200 | 200 | 100 | HK$50.00 | HK$108.00 |

### **å¹´è´¹ï¼ˆHK$552/å¹´ï¼Œ1,200 Creditsï¼‰**

| ä½¿ç”¨é‡ | totalCreditsUsed | è¶…é¢ | è¶…é¢è´¹ç”¨ | ä¸‹æ¬¡è´¦å•æ€»é¢ |
|--------|------------------|------|---------|-------------|
| 500 | 500 | 0 | HK$0.00 | HK$552.00 |
| 1,200 | 1,200 | 0 | HK$0.00 | HK$552.00 |
| 1,201 | 1,201 | 1 | HK$0.50 | HK$552.50 |
| 1,250 | 1,250 | 50 | HK$25.00 | HK$577.00 |
| 2,000 | 2,000 | 800 | HK$400.00 | HK$952.00 |

---

## ğŸ¯ **ä¸‹ä¸€æ­¥**

1. âœ… **æµ‹è¯•æµ‹è¯•æ¨¡å¼**ï¼ˆå®Œæˆä¸Šè¿°æµ‹è¯•æ­¥éª¤ï¼‰
2. âœ… **ç¡®è®¤ Stripe ä½¿ç”¨é‡è®°å½•æ­£ç¡®**
3. âœ… **æµ‹è¯•è®¢é˜…ç»­è´¹ï¼ˆCredits æ¸…é›¶é€»è¾‘ï¼‰**
4. âœ… **é…ç½®ç”Ÿäº§æ¨¡å¼**ï¼ˆé‡å¤ç›¸åŒæ­¥éª¤ï¼‰

---

## ğŸ‰ **å®Œæˆï¼**

**æŒ‰é‡è®¡è´¹åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼**

- âœ… è‡ªåŠ¨ä¿å­˜ `meteredSubscriptionItemId`
- âœ… è·Ÿè¸ªç´¯è®¡ä½¿ç”¨é‡ `totalCreditsUsed`
- âœ… è‡ªåŠ¨æŠ¥å‘Šè¶…é¢ä½¿ç”¨ç»™ Stripe
- âœ… Stripe è‡ªåŠ¨è®¡è´¹

**ç«‹å³æµ‹è¯•**ï¼šhttps://vaultcaddy.com/firstproject.html ğŸš€

---

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

å¦‚æœæµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼š
1. æŸ¥çœ‹ Console æ—¥å¿—ï¼ˆå‰ç«¯ï¼‰
2. æŸ¥çœ‹ Cloud Functions æ—¥å¿—ï¼ˆåç«¯ï¼‰
3. æŸ¥çœ‹ Stripe Dashboard â†’ Usage Records
4. æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæˆªå›¾

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸŠ

