# âœ… è‡´å‘½é—®é¢˜å·²ä¿®å¤ï¼Stripe é‡è¯•å¯¼è‡´çš„é‡å¤æ·»åŠ 

## ğŸ‰ **éƒ¨ç½²å®Œæˆï¼**

---

## ğŸ” **æ ¹æœ¬åŸå› **

ä»æ‚¨çš„æˆªå›¾å‘ç°äº†è‡´å‘½é—®é¢˜ï¼š

**Webhook äº‹ä»¶çŠ¶æ€**ï¼š
- âœ… `checkout.session.completed` - **200 OK**
- âŒ `customer.subscription.created` - **500 ERR**ï¼ˆå¤±è´¥ï¼‰
- âŒ `customer.subscription.updated` - **500 ERR**ï¼ˆå¤±è´¥ï¼‰

**Firestore æ•°æ®**ï¼š
- `credits: 79970`ï¼ˆåº”è¯¥åªæœ‰å‡ ç™¾ï¼‰

**é—®é¢˜**ï¼š
1. å½“è®¢é˜…äº‹ä»¶è¿”å› **500 é”™è¯¯**æ—¶ï¼ŒStripe ä¼šè‡ªåŠ¨é‡è¯•
2. é‡è¯•ä¼šå†æ¬¡è§¦å‘æ•´ä¸ª Webhook
3. é‡è¯•æ—¶ä¼šå†æ¬¡æ‰§è¡Œ `checkout.session.completed`
4. **æ¯æ¬¡é‡è¯•éƒ½æ·»åŠ ä¸€æ¬¡ Credits**ï¼

**Stripe é‡è¯•æœºåˆ¶**ï¼š
- ç«‹å³é‡è¯•
- 1å°æ—¶åé‡è¯•
- 3å°æ—¶åé‡è¯•
- 6å°æ—¶åé‡è¯•
- 12å°æ—¶åé‡è¯•
- 24å°æ—¶åé‡è¯•

**ç»“æœ**ï¼šCredits è¢«æ·»åŠ äº†çº¦ 800 æ¬¡ï¼

---

## ğŸ”§ **å·²ä¿®å¤çš„é—®é¢˜**

### **ä¿®å¤ 1ï¼šæ”¹è¿›é”™è¯¯å¤„ç†**

**ä¿®æ”¹å‰**ï¼š
```javascript
try {
    switch (event.type) {
        case 'checkout.session.completed':
            await handleCheckoutCompleted(...);
            break;
        case 'customer.subscription.created':
        case 'customer.subscription.updated':
            await handleSubscriptionChange(...); // âŒ å¦‚æœå¤±è´¥ï¼Œè¿”å› 500
            break;
    }
    res.status(200).json({ received: true });
} catch (error) {
    res.status(500).json({ error: 'Webhook processing failed' }); // âŒ å¯¼è‡´é‡è¯•
}
```

**ä¿®æ”¹å**ï¼š
```javascript
try {
    switch (event.type) {
        case 'checkout.session.completed':
            await handleCheckoutCompleted(...); // ğŸ”¥ å…³é”®äº‹ä»¶ï¼Œå¿…é¡»æˆåŠŸ
            break;
        case 'customer.subscription.created':
        case 'customer.subscription.updated':
            try {
                await handleSubscriptionChange(...);
            } catch (subscriptionError) {
                // âœ… è®¢é˜…äº‹ä»¶å¤±è´¥ä¸å½±å“ Creditsï¼ˆå·²åœ¨ checkout ä¸­æ·»åŠ ï¼‰
                console.error('è®¢é˜…ä¿¡æ¯æ›´æ–°å¤±è´¥ï¼Œä½† Credits å·²æ·»åŠ ');
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
            }
            break;
    }
    
    // âœ… æ€»æ˜¯è¿”å› 200ï¼Œé¿å… Stripe é‡è¯•
    res.status(200).json({ received: true });
} catch (error) {
    // ğŸ”¥ åªæœ‰ checkout.session.completed å¤±è´¥æ—¶æ‰è¿”å› 500
    if (event.type === 'checkout.session.completed') {
        res.status(500).json({ error: 'Checkout processing failed' });
    } else {
        // å…¶ä»–äº‹ä»¶å¤±è´¥ä¹Ÿè¿”å› 200ï¼Œé¿å…é‡è¯•
        res.status(200).json({ received: true, error: error.message });
    }
}
```

### **ä¿®å¤ 2ï¼šå¢å¼º handleSubscriptionChange çš„é”™è¯¯å¤„ç†**

æ·»åŠ äº†å¤šä¸ªæ£€æŸ¥ç‚¹ï¼Œç¡®ä¿å³ä½¿æ•°æ®ä¸å®Œæ•´ä¹Ÿä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼š

```javascript
// âœ… æ£€æŸ¥ç”¨æˆ· ID
if (!userId) {
    console.error('æ— æ³•è·å–ç”¨æˆ· IDï¼Œè·³è¿‡è®¢é˜…ä¿¡æ¯æ›´æ–°');
    return; // ä¸æŠ›å‡ºé”™è¯¯
}

// âœ… æ£€æŸ¥è®¢é˜…æ•°æ®å®Œæ•´æ€§
if (!subscription.items || !subscription.items.data || subscription.items.data.length === 0) {
    console.error('è®¢é˜…æ•°æ®ä¸å®Œæ•´ï¼Œè·³è¿‡è®¢é˜…ä¿¡æ¯æ›´æ–°');
    return; // ä¸æŠ›å‡ºé”™è¯¯
}

// âœ… try-catch è·å–äº§å“ä¿¡æ¯
try {
    product = await stripeClient.products.retrieve(productId);
} catch (productError) {
    console.error('è·å–äº§å“ä¿¡æ¯å¤±è´¥ï¼Œè·³è¿‡è®¢é˜…ä¿¡æ¯æ›´æ–°');
    return; // ä¸æŠ›å‡ºé”™è¯¯
}

// âœ… try-catch æ›´æ–° Firestore
try {
    await db.collection('users').doc(userId).update(...);
} catch (updateError) {
    console.error('æ›´æ–°è®¢é˜…ä¿¡æ¯å¤±è´¥ï¼Œä½†ä¸å½±å“ Credits');
    // ä¸æŠ›å‡ºé”™è¯¯
}
```

---

## ğŸ“‹ **å¿…é¡»æ‰§è¡Œçš„æ¸…ç†æ­¥éª¤**

### **æ­¥éª¤ 1ï¼šç¦ç”¨å¤±è´¥çš„ Webhook é‡è¯•**

1. å‰å¾€ Stripe Dashboardï¼š
   https://dashboard.stripe.com/test/webhooks

2. ç‚¹å‡» `charismatic-serenity` Webhook

3. **é‡è¦**ï¼šæš‚æ—¶ç¦ç”¨ Webhook
   - ç‚¹å‡»å³ä¸Šè§’çš„ **"..."** èœå•
   - é€‰æ‹© **"ç¦ç”¨"**
   - è¿™ä¼šåœæ­¢ Stripe çš„æ‰€æœ‰é‡è¯•

4. **ç­‰å¾… 5 åˆ†é’Ÿ**ï¼Œç¡®ä¿æ‰€æœ‰é‡è¯•éƒ½åœæ­¢

---

### **æ­¥éª¤ 2ï¼šæ¸…ç† Firestore æµ‹è¯•æ•°æ®**

1. å‰å¾€ Firebase Consoleï¼š
   https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. **æ¸…ç†ç”¨æˆ·æ•°æ®**ï¼š
   - æ‰¾åˆ° `users` é›†åˆ
   - æ‰¾åˆ°æµ‹è¯•ç”¨æˆ·ï¼ˆ`vaultcaddy@gmail.com` æˆ–å…¶ä»–æµ‹è¯•è´¦æˆ·ï¼‰
   - å°†ä»¥ä¸‹å­—æ®µè®¾ä¸º **0**ï¼š
     - `credits: 0`
     - `currentCredits: 0`

3. **æ¸…ç†å·²å¤„ç†äº‹ä»¶è®°å½•**ï¼š
   - æ‰¾åˆ° `processedStripeEvents` é›†åˆ
   - **åˆ é™¤æ‰€æœ‰æ–‡æ¡£**ï¼ˆæˆ–åˆ é™¤æ•´ä¸ªé›†åˆï¼‰
   - è¿™ä¼šé‡ç½®å¹‚ç­‰æ€§æ£€æŸ¥

4. **æ¸…ç†è´­ä¹°è®°å½•**ï¼š
   - è¿›å…¥æµ‹è¯•ç”¨æˆ·çš„ `purchaseHistory` å­é›†åˆ
   - **åˆ é™¤æ‰€æœ‰æµ‹è¯•è´­ä¹°è®°å½•**

---

### **æ­¥éª¤ 3ï¼šé‡æ–°å¯ç”¨ Webhook**

1. å‰å¾€ Stripe Dashboardï¼š
   https://dashboard.stripe.com/test/webhooks

2. ç‚¹å‡» `charismatic-serenity` Webhook

3. ç‚¹å‡»å³ä¸Šè§’çš„ **"..."** èœå•

4. é€‰æ‹© **"å¯ç”¨"**

5. **ç¡®è®¤ Webhook é…ç½®**ï¼š
   - åªç›‘å¬ **4 ä¸ªäº‹ä»¶**ï¼š
     - `checkout.session.completed`
     - `customer.subscription.created`
     - `customer.subscription.updated`
     - `customer.subscription.deleted`

---

### **æ­¥éª¤ 4ï¼šé‡æ–°æµ‹è¯•æ”¯ä»˜**

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**

2. **ä½¿ç”¨æ–°çš„æµ‹è¯•è´¦æˆ·**ï¼ˆæˆ–ç¡®ä¿æ—§è´¦æˆ·çš„ Credits å·²æ¸…é›¶ï¼‰

3. **å‰å¾€æ”¯ä»˜é¡µé¢**ï¼š
   https://vaultcaddy.com/billing.html

4. **ç‚¹å‡» "ğŸ§ª æ¸¬è©¦ Get Started"**

5. **å®Œæˆæ”¯ä»˜**ï¼ˆæµ‹è¯•å¡ï¼š`4242 4242 4242 4242`ï¼‰

6. **ç­‰å¾… 10-20 ç§’**

7. **åˆ·æ–°é¡µé¢**

8. **ç¡®è®¤ Credits æ•°é‡**ï¼š
   - âœ… åº”è¯¥åªå¢åŠ  **100 Credits**
   - âŒ ä¸åº”è¯¥æ˜¯ 200, 300, æˆ–æ›´å¤š

---

## ğŸ” **éªŒè¯æ­¥éª¤**

### **éªŒè¯ 1ï¼šæ£€æŸ¥ Stripe Webhook æ—¥å¿—**

1. å‰å¾€ï¼šhttps://dashboard.stripe.com/test/workbench/vaultcaddy

2. ç‚¹å‡»æœ€æ–°çš„æ”¯ä»˜äº‹ä»¶

3. æŸ¥çœ‹ Webhook äº‹ä»¶ï¼š
   - âœ… `checkout.session.completed` - **200 OK**
   - âœ… `customer.subscription.created` - **200 OK**ï¼ˆç°åœ¨åº”è¯¥æˆåŠŸï¼‰
   - âœ… `customer.subscription.updated` - **200 OK**ï¼ˆç°åœ¨åº”è¯¥æˆåŠŸï¼‰

4. **ä¸åº”è¯¥æœ‰ 500 é”™è¯¯**

---

### **éªŒè¯ 2ï¼šæ£€æŸ¥ Firebase Functions æ—¥å¿—**

1. å‰å¾€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions

2. ç‚¹å‡» `stripeWebhook` å‡½æ•°

3. ç‚¹å‡»"æ—¥å¿—"æ ‡ç­¾

4. æŸ¥æ‰¾æœ€æ–°çš„æ”¯ä»˜è®°å½•

5. **åº”è¯¥çœ‹åˆ°**ï¼š
   ```
   âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼): cs_test_xxxxx
   ğŸ’° æº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ xxxxx
   âœ… æˆåŠŸæ·»åŠ  100 Credits
   
   âœ… è¨‚é–±è®Šæ›´ (æ¸¬è©¦æ¨¡å¼): sub_xxxxx
   â„¹ï¸ è¨‚é–±ç‹€æ…‹ç‚º activeï¼ŒCredits å·²åœ¨ checkout.session.completed äº‹ä»¶ä¸­æ·»åŠ 
   âœ… ç”¨æˆ¶è¨‚é–±ä¿¡æ¯å·²æ›´æ–°
   ```

6. **ä¸åº”è¯¥çœ‹åˆ°é”™è¯¯æ¶ˆæ¯**

---

### **éªŒè¯ 3ï¼šæ£€æŸ¥ Firestore æ•°æ®**

1. å‰å¾€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. æ‰¾åˆ° `users` é›†åˆä¸­çš„æµ‹è¯•ç”¨æˆ·

3. **ç¡®è®¤ Credits æ­£ç¡®**ï¼š
   - `credits: 100`
   - `currentCredits: 100`

4. **ç¡®è®¤åªæœ‰ä¸€æ¡è´­ä¹°è®°å½•**ï¼š
   - è¿›å…¥ `purchaseHistory` å­é›†åˆ
   - åº”è¯¥åªæœ‰ **1 æ¡**è´­ä¹°è®°å½•
   - é‡‘é¢ï¼š100 Credits

---

## ğŸ“Š **é¢„æœŸç»“æœ**

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| Credits å¢åŠ  | 79970ï¼ˆ800æ¬¡ï¼‰ | **100**ï¼ˆ1æ¬¡ï¼‰ âœ… |
| Webhook 500 é”™è¯¯ | æ˜¯ | **å¦** âœ… |
| Stripe é‡è¯• | æŒç»­é‡è¯• | **ä¸é‡è¯•** âœ… |
| è®¢é˜…äº‹ä»¶çŠ¶æ€ | 500 ERR | **200 OK** âœ… |

---

## ğŸš¨ **é‡è¦æé†’**

1. **å¿…é¡»å…ˆç¦ç”¨ Webhook**ï¼Œç­‰å¾…æ‰€æœ‰é‡è¯•åœæ­¢åå†é‡æ–°å¯ç”¨
2. **å¿…é¡»æ¸…ç† Firestore æµ‹è¯•æ•°æ®**ï¼Œå¦åˆ™ä¼šçœ‹åˆ°é”™è¯¯çš„ Credits æ•°é‡
3. **ä½¿ç”¨æ–°çš„æµ‹è¯•è´¦æˆ·**æˆ–ç¡®ä¿æ—§è´¦æˆ·çš„ Credits å·²æ¸…é›¶
4. **æ£€æŸ¥ Firebase Functions æ—¥å¿—**ï¼Œç¡®ä¿æ²¡æœ‰ 500 é”™è¯¯

---

## ğŸ¯ **ä¸ºä»€ä¹ˆè¿™ä¸ªä¿®å¤æœ‰æ•ˆï¼Ÿ**

**å…³é”®æ”¹è¿›**ï¼š

1. **è®¢é˜…äº‹ä»¶å¤±è´¥ä¸å†å¯¼è‡´æ•´ä¸ª Webhook å¤±è´¥**
   - å³ä½¿è®¢é˜…ä¿¡æ¯æ›´æ–°å¤±è´¥ï¼Œä¹Ÿè¿”å› 200
   - Credits å·²åœ¨ `checkout.session.completed` ä¸­æ·»åŠ ï¼Œä¸å—å½±å“

2. **Stripe ä¸ä¼šé‡è¯•**
   - è¿”å› 200 åï¼ŒStripe è®¤ä¸ºäº‹ä»¶å·²æˆåŠŸå¤„ç†
   - ä¸ä¼šè§¦å‘é‡è¯•æœºåˆ¶

3. **å¹‚ç­‰æ€§æ£€æŸ¥ä»ç„¶æœ‰æ•ˆ**
   - å¦‚æœæ‰‹åŠ¨é‡è¯•ï¼Œå¹‚ç­‰æ€§æ£€æŸ¥ä¼šé˜²æ­¢é‡å¤æ·»åŠ  Credits

---

## ğŸ™ **è¯·æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤æ“ä½œ**

1. âœ… ç¦ç”¨ Webhookï¼ˆåœæ­¢é‡è¯•ï¼‰
2. âœ… æ¸…ç† Firestore æ•°æ®
3. âœ… é‡æ–°å¯ç”¨ Webhook
4. âœ… é‡æ–°æµ‹è¯•æ”¯ä»˜
5. âœ… éªŒè¯ç»“æœ

å®Œæˆåï¼Œå‘Šè¯‰æˆ‘æµ‹è¯•ç»“æœï¼å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š
- Stripe Webhook æ—¥å¿—æˆªå›¾
- Firebase Functions æ—¥å¿—æˆªå›¾
- Firestore ç”¨æˆ·æ•°æ®æˆªå›¾

ğŸ’ª è¿™æ¬¡åº”è¯¥å®Œå…¨ä¿®å¤äº†ï¼

