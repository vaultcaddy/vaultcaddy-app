# 🔄 银行对账单转换流程摘要

> **快速参考** - 完整版请见 `CURRENT_WORKFLOW_EXPLANATION.md`  
> **最后更新：** 2026-02-03（🆕 千问AI优化版）  
> **文档版本：** 2.0

## 🆕 重要更新（2026-02-03）

根据千问AI建议优化：
- ✅ Prompt升级：**"VISUAL TEXT EXTRACTOR"模式**
- ✅ 规则引擎增强：**空日期填充 + 余额校验**
- ✅ 职责分离：**AI提取 vs. 规则处理**

---

## 📊 10步流程

| 步骤 | 操作 | 关键点 | 文件/函数 |
|------|------|--------|-----------|
| 1️⃣ | **用户上传文件 + 创建文档** | 立即创建"processing"状态的文档 | `firstproject.html` → `handleUpload()` |
| 2️⃣ | **检查Credits余额** | 验证是否足够，不足则停止 | `credits-manager.js` → `checkCredits()` |
| 3️⃣ | **文件类型判断** | 检查是否为PDF | `pdfToImageConverter.isPDF()` |
| 4️⃣ | **上传Firebase Storage** | PDF先转图片（300 DPI），并行上传 | `pdf-to-image-converter.js` |
| 5️⃣ | **扣除Credits（真正扣除）** | 上传成功后，按实际页数扣除 | `credits-manager.js` → `deductCredits()` |
| 6️⃣ | **🆕 调用千问AI（优化版）** | "VISUAL TEXT EXTRACTOR"模式 | `qwen-vl-max-processor.js` |
| 7️⃣ | **解析AI响应** | 清理markdown，验证JSON | `parseJSON()` |
| 8️⃣ | **🔥 规则引擎后处理（增强）** | 规则1: 空日期填充 + 规则2: 余额校验 | `postProcessTransactions()` |
| 9️⃣ | **保存到Firestore** | 更新状态：processing → completed | `simple-data-manager.js` |
| 🔟 | **刷新UI显示** | 读取数据，渲染表格 | `loadDocuments()` |

---

## 🔑 关键机制

### Credits两步处理

```
步骤2：检查余额 ──┐
                   ├─ 为什么分两步？
步骤5：真正扣除 ──┘
```

**原因：**
- ✅ 避免提前扣费（PDF转换可能失败）
- ✅ 按实际页数扣费（更准确）
- ✅ 失败时可退回Credits

---

### 🆕 规则引擎后处理（千问AI优化版）

**职责分离：**
```
┌─────────────────────────────────────────────────────────┐
│  AI的职责              规则引擎的职责                    │
│  ──────────────────   ─────────────────────────────── │
│  ✅ 视觉提取           ✅ 空日期填充（规则1）           │
│  ✅ 表格识别           ✅ 余额校验（规则2）             │
│  ✅ 文本复制           ✅ 异常检测                      │
│  ❌ 不推理             （确定性算法，100%可靠）          │
│  ❌ 不计算                                              │
└─────────────────────────────────────────────────────────┘
```

**示例：**
```
AI提取（原始数据）：
[
  {date: "10 Mar", debit: 500, balance: 30218.39},
  {date: "",       debit: 200, balance: 30018.39},  ← 空白日期
  {date: "",       debit: 150, balance: 29868.39}   ← 空白日期
]

规则引擎处理后：
[
  {date: "10 Mar", debit: 500, balance: 30218.39},
  {date: "10 Mar", debit: 200, balance: 30018.39},  ← 规则1填充
  {date: "10 Mar", debit: 150, balance: 29868.39}   ← 规则1填充
]
```

**规则1算法：空日期填充**
```javascript
lastValidDate = null
for each transaction:
    if (date为空):
        transaction.date = lastValidDate  // 继承上一行
    else:
        lastValidDate = transaction.date  // 更新基准
```

**🆕 规则2算法：余额校验**
```javascript
if (上一笔余额存在 && 当前余额存在):
    delta = abs(当前余额 - 上一笔余额)
    if (delta > max(debit, credit) * 1.5):
        transaction.warning = "balance_jump"  // 异常预警
```

---

## 📁 核心文件

| 文件 | 作用 |
|------|------|
| `firstproject.html` | 主页面，处理上传队列 |
| `qwen-vl-max-processor.js` | AI处理 + 前端后处理 |
| `credits-manager.js` | Credits管理（检查+扣除） |
| `pdf-to-image-converter.js` | PDF转图片（300 DPI） |
| `simple-data-manager.js` | Firestore数据管理 |

---

## 🎯 用户体验亮点

1. **立即反馈** - 上传后马上看到"处理中"状态
2. **Credits保护** - 先检查余额，避免浪费
3. **失败重试** - 失败时自动退回Credits
4. **队列处理** - 多文件顺序处理，不阻塞
5. **进度提示** - 清晰的处理状态和警告
6. **🆕 数据校验** - 余额跳变自动预警
7. **🆕 多语言支持** - 支持全球银行

---

## 🆕 千问AI优化总结

| 方面 | 旧版 | 新版（千问优化） |
|------|------|------------------|
| **AI定位** | "OCR COPY MACHINE" | **"VISUAL TEXT EXTRACTOR"** |
| **处理逻辑** | 单一空日期填充 | **规则引擎系统（规则1+2）** |
| **职责分离** | 混合处理 | **AI提取 + 规则处理** |
| **语言支持** | 单一语言 | **多语言关键词映射** |
| **数据校验** | 无 | **余额跳变预警** |
| **可扩展性** | 低 | **高（轻松添加新规则）** |

---

**最后更新：** 2026-02-03  
**版本：** 2.0（千问AI优化版）
