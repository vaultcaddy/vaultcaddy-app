# 🔴 AI混淆了"金额"和"结余" - 关键修复

**发现日期**: 2026-01-10  
**严重程度**: 🔴 **极高** - 数据完全错误  
**问题根源**: Prompt指示不清楚

---

## 📋 问题描述

用户发现的具体错误：

### **图1（银行单原始数据）**：
```
日期       描述       支出      存入     结余
2021-07-06  CQW 000012  25,655.00         15,531.71
```

### **图2（系统显示）**：
```
日期       描述       金额      结余
2021-07-06  CQW 000012  +15,531.71  56,718.42
```

### **🚨 严重错误**：
- ❌ AI把"结余"当成了"金额"（15,531.71）
- ❌ "结余"也完全错误（56,718.42）
- ❌ 完全忽略了"支出"列的真实金额（25,655.00）

---

## 🔍 根本原因分析

### **问题：Prompt指示不够清晰**

**旧的Prompt**（不够具体）：
```
"debit": 支出金額（從「支出/借項/DEBIT」欄位提取）
"credit": 收入金額（從「存款/入賬/貸項/CREDIT」欄位提取）
"amount": 交易金額（正數表示，不帶正負號）
"balance": 餘額（數字）
```

**问题**：
- ❌ 没有明确说明哪一列是哪一列
- ❌ 没有提供具体示例
- ❌ 没有说明常见错误
- ❌ AI容易混淆"金额"和"结余"

---

## ✅ 修复方案

### **新的Prompt**（增加详细说明和示例）

```javascript
2. **🔴 關鍵：正確識別銀行對賬單的列結構**：
   銀行對賬單的交易記錄部分通常有以下列：
   | 日期 | 描述 | 支出(Debit) | 存入(Credit) | 結餘(Balance) |
   
   **示例1（支出交易）**：
   | 2021-07-06 | CQW 000012 | 25,655.00 |           | 15,531.71 |
   解析為：
   - date: "2021-07-06"
   - description: "CQW 000012"
   - debit: 25655.00 （支出列的數字）
   - credit: 0 （存入列為空）
   - amount: 25655.00 （交易金額 = debit）
   - balance: 15531.71 （結餘列的數字）
   - transactionSign: "expense" （因為有debit）
   
   **示例2（收入交易）**：
   | 2021-07-01 | 利息支出 |          | 5.06      | 59,417.89 |
   解析為：
   - date: "2021-07-01"
   - description: "利息支出"
   - debit: 0 （支出列為空）
   - credit: 5.06 （存入列的數字）
   - amount: 5.06 （交易金額 = credit）
   - balance: 59417.89 （結餘列的數字）
   - transactionSign: "income" （因為有credit）

3. **🔴 常見錯誤（必須避免）**：
   ❌ 錯誤：把"結餘"列的數字當成"金額"
   ❌ 錯誤：忽略"支出"或"存入"列，只看"結餘"
   ❌ 錯誤：把所有交易都標記為同一類型
   ✅ 正確：根據"支出"和"存入"列判斷交易類型
   ✅ 正確：amount = debit（如果有支出）或 credit（如果有存入）
   ✅ 正確：balance 永遠是"結餘"列的數字，不是"支出"或"存入"

4. **識別列的方法**：
   - 看表頭：通常有"支出/借項/DEBIT"、"存入/貸項/CREDIT"、"結餘/余額/BALANCE"
   - 看位置：通常支出在中間偏左，存入在中間偏右，結餘在最右邊
   - 看數據：每行只有一個金額（在支出或存入列），結餘列總是有數字
```

---

## 🎯 关键改进

### **1. 提供具体示例**
- ✅ 用实际数据展示如何解析
- ✅ 明确每一列对应的JSON字段
- ✅ 展示支出和收入两种情况

### **2. 明确常见错误**
- ✅ 列举AI容易犯的错误
- ✅ 说明正确的做法
- ✅ 使用❌和✅符号强调

### **3. 说明识别方法**
- ✅ 教AI如何识别列
- ✅ 提供多种识别线索
- ✅ 强调列的位置关系

---

## 📊 预期效果

### **修复前（错误）**：
```
CQW 000012:
- amount: 15531.71 （❌ 这是结余，不是金额！）
- balance: 56718.42 （❌ 完全错误的数字）
- transactionSign: "income" （❌ 应该是expense）
```

### **修复后（正确）**：
```
CQW 000012:
- debit: 25655.00 （✅ 从支出列提取）
- credit: 0 （✅ 存入列为空）
- amount: 25655.00 （✅ = debit）
- balance: 15531.71 （✅ 从结余列提取）
- transactionSign: "expense" （✅ 因为有debit）
```

---

## 🧪 测试计划

### **测试重点**
1. ✅ 验证AI是否正确识别"支出"列
2. ✅ 验证AI是否正确识别"存入"列
3. ✅ 验证AI是否正确识别"结余"列
4. ✅ 验证amount字段是否等于debit或credit
5. ✅ 验证balance字段是否等于结余列

### **测试数据**
使用`eStatement-CIF-20210731.pdf`，重点检查：
- CQW 000012（支出25,655.00，结余15,531.71）
- 利息支出（存入5.06，结余59,412.83）
- SIC ALIPAY HK LTD（支出21.62，结余59,434.45）

---

## 📝 用户问题回答

**问题**：是我们的指示不清楚？还是其他原因？

**答案**：✅ **是指示不够清楚**

**原因**：
1. ❌ 旧的Prompt没有提供具体示例
2. ❌ 没有说明银行对账单的列结构
3. ❌ 没有明确指出常见错误
4. ❌ AI容易混淆"金额"和"结余"这两个概念

**不是图片质量问题**：
- ✅ AI能清楚看到数字
- ✅ 问题在于AI不知道哪一列是哪一列
- ✅ 通过改进Prompt可以解决

---

## 🚀 下一步行动

1. ⚠️ **删除所有旧的银行对账单记录**（数据完全不可信）
2. ✅ **重新上传所有文件**
3. ✅ **验证新的提取结果**：
   - 检查amount是否等于debit或credit
   - 检查balance是否是结余列的数字
   - 检查transactionSign是否正确

---

**修复状态**: ✅ 已完成  
**需要测试**: 是  
**影响文件**:
- `qwen-vl-max-processor.js` ✅ 已修复（Prompt）

**重要提醒**: 所有旧数据都不可信，必须重新上传！

