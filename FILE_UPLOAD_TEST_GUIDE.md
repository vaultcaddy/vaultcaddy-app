# 📤 文件上传测试指南
**任务 2**: 验证文件处理功能

---

## 🎯 测试目标

验证以下功能正常工作：
1. ✅ 文件上传和处理
2. ✅ Credits 自动扣除
3. ✅ 数据提取准确
4. ✅ 超额自动记录（可选）

---

## 📋 准备工作

### 需要的材料：
- ✅ 一个 5-10 页的 PDF 文件（银行对账单、收据等）
- ✅ 浏览器（Chrome、Safari 等）
- ✅ VaultCaddy 账号

---

## 🔍 测试步骤 1：基本上传测试（5 分钟）

### 步骤 1.1：检查当前 Credits

1. ✅ 打开浏览器
2. ✅ 访问：https://vaultcaddy.com
3. ✅ 登录您的账号
4. ✅ 查看顶部的 Credits 显示
5. ✅ **记录当前 Credits 数量**：______

**范例**：当前 Credits = 95

---

### 步骤 1.2：上传文件

1. ✅ 点击 **"上传文件"** 或 **"Upload"** 按钮
2. ✅ 选择准备好的 PDF 文件（建议 5 页）
3. ✅ 确认文件信息
4. ✅ 点击 **"开始处理"** 或 **"Process"**

---

### 步骤 1.3：观察处理过程

**预期时间**：约 50-60 秒（5 页文件）

**预期显示**：
```
⏳ 上传中... (5秒)
⏳ 分析文件... (5秒)
✅ 检测到 5 页
⏳ 处理中... (40-50秒)
✅ 完成！
```

**如果超过 2 分钟**：
- 查看 Firebase 日志
- 检查网络连接
- 联系技术支持

---

### 步骤 1.4：验证结果

#### ✅ 检查项 1：Credits 扣除

**计算**：
- 上传前 Credits：95
- 文件页数：5
- **预期上传后**：95 - 5 = **90**

**实际上传后 Credits**：______

**是否正确**：[ ] 是  [ ] 否

---

#### ✅ 检查项 2：数据提取

查看提取的数据：
- [ ] 账户信息正确
- [ ] 交易记录完整
- [ ] 日期格式正确
- [ ] 金额准确
- [ ] 交易类型（收入/支出）正确

---

#### ✅ 检查项 3：处理时间

- **预期时间**：5 页 × 10 秒 = 50 秒左右
- **实际时间**：______ 秒
- **是否合理**：[ ] 是  [ ] 否

---

## 🧪 测试步骤 2：超额计费测试（可选，15 分钟）

### 什么时候做这个测试？

**条件**：
- 您想验证超额计费功能
- 您有足够的测试文件
- 您的当前 Credits < 100

---

### 步骤 2.1：准备超额场景

**计算**：
- 当前 Credits：例如 90
- 需要上传：110 页（超额 20 页）
- 可以分多个文件上传

---

### 步骤 2.2：上传超过剩余 Credits 的文件

1. ✅ 准备一个大文件（例如 110 页）
2. ✅ 或者连续上传多个小文件（总计 110 页）
3. ✅ 处理完成后，检查 Credits

**预期结果**：
- Credits 变为负数：**-20**
- 系统允许继续使用（Pro Plan）

---

### 步骤 2.3：验证 Stripe 记录

1. ✅ 访问：https://dashboard.stripe.com/test/subscriptions
2. ✅ 找到您的测试订阅
3. ✅ 点击订阅详情
4. ✅ 点击 **"Usage"** 或 **"使用量"** 标签

**预期看到**：
```
Usage records:
- 2026-01-29: 20 pages
Total: 20 pages × $0.3 = $6.00
```

---

### 步骤 2.4：检查 Firestore 数据

访问：https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

找到您的用户文档：

**预期数据**：
```json
{
  "credits": -20,
  "usageThisPeriod": {
    "totalPages": 110,
    "overagePages": 20
  }
}
```

---

## 📊 测试记录表

### 基本测试

| 项目 | 预期 | 实际 | 通过 |
|------|------|------|------|
| 上传成功 | ✅ | _____ | [ ] |
| 处理时间 | ~50秒 | _____秒 | [ ] |
| Credits 扣除 | -5 | _____ | [ ] |
| 数据准确性 | ✅ | _____ | [ ] |

### 超额测试（可选）

| 项目 | 预期 | 实际 | 通过 |
|------|------|------|------|
| Credits 为负 | -20 | _____ | [ ] |
| Stripe 记录 | 20 pages | _____ | [ ] |
| Firestore 更新 | ✅ | _____ | [ ] |

---

## 🚨 常见问题

### Q: 上传失败或超时

**检查**：
1. Firebase Functions 日志
2. 网络连接
3. PDF 文件是否损坏

**解决**：
```bash
# 查看日志
firebase functions:log --only qwenProxy

# 重新部署（如果需要）
firebase deploy --only functions:qwenProxy
```

---

### Q: Credits 没有扣除

**检查**：
1. deductCreditsClient 函数日志
2. Firestore 写入权限
3. 前端调用是否成功

**解决**：
- 查看浏览器控制台错误
- 查看 Firebase Functions 日志

---

### Q: 数据提取不准确

**可能原因**：
1. PDF 质量问题（图片模糊）
2. 格式不符合预期
3. Qwen API 临时问题

**解决**：
- 使用更清晰的 PDF
- 检查 PDF 格式
- 重试上传

---

## ✅ 完成检查清单

### 任务 2 完成标准：

- [ ] 文件上传成功
- [ ] 处理时间合理（~10秒/页）
- [ ] Credits 扣除正确
- [ ] 数据提取准确
- [ ] （可选）超额计费记录到 Stripe

---

## 🎉 完成后

**恭喜！** 如果以上测试都通过，说明：

✅ Firebase Functions 正常工作  
✅ Qwen API 集成成功  
✅ Credits 管理功能正常  
✅ 超额计费系统就绪  

**您的 VaultCaddy 系统已完全就绪！** 🚀

---

## 📸 建议截图保存

- [ ] 上传前的 Credits 余额
- [ ] 文件处理界面
- [ ] 处理完成后的结果
- [ ] 上传后的 Credits 余额
- [ ] 提取的数据详情页面
- [ ] （可选）Stripe Usage 记录


