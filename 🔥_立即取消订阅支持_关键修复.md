# ğŸ”¥ ç«‹å³å–æ¶ˆè®¢é˜…æ”¯æŒ - å…³é”®ä¿®å¤

## ğŸ’¡ ä½ çš„é—®é¢˜

> **ä¸ºä»€ä¹ˆä¸è¦ä½¿ç”¨"ç«‹å³å–æ¶ˆ"ï¼Ÿç”¨æˆ·ä¹Ÿæœ‰æœºä¼šç‚¹é€‰"ç«‹å³å–æ¶ˆ"ï¼Ÿ**
> **å›¾1ä¸­è¶…é¢è´¹ç”¨åº”è¯¥å·²ç»åœ¨ invoice.created webhook ä¸­æŠ¥å‘Šç»™ Stripeä½†ä¸ºä»€ä¹ˆæ²¡æœ‰ï¼Ÿ**

---

## ğŸ¯ ä½ å®Œå…¨æ­£ç¡®ï¼

### ç”¨æˆ·ç¡®å®ä¼šç‚¹å‡»"ç«‹å³å–æ¶ˆ"

ç”¨æˆ·åœ¨ Stripe Customer Portal ä¸­æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š
- âŒ **ç«‹å³å–æ¶ˆ**ï¼ˆCancel immediatelyï¼‰â† å¤§å¤šæ•°ç”¨æˆ·ä¼šé€‰è¿™ä¸ªï¼
- â¸ï¸ **æœŸæœ«å–æ¶ˆ**ï¼ˆCancel at period endï¼‰

**æˆ‘ä»¬ä¸èƒ½å‡è®¾ç”¨æˆ·ä¼šé€‰æ‹©"æœŸæœ«å–æ¶ˆ"ï¼**

---

## ğŸ› é—®é¢˜æ ¹æºï¼šWebhook æ—¶åºé—®é¢˜

### âŒ ä¹‹å‰çš„é€»è¾‘

```javascript
// handleInvoiceCreated å‡½æ•°
const currentCredits = userData.currentCredits || 0;

if (currentCredits >= 0) {
    console.log(`âœ… æ²’æœ‰è¶…é¡ä½¿ç”¨ï¼Œç„¡éœ€å ±å‘Š`);
    return; // â† é”™è¯¯ï¼é€€å‡ºå‡½æ•°
}
```

### ğŸ” å®é™…å‘ç”Ÿçš„æ—¶åº

```
ç”¨æˆ·ç‚¹å‡»"ç«‹å³å–æ¶ˆ"
    â†“
Stripe å¼€å§‹å¤„ç†...
    â†“
ã€1. customer.subscription.deleted webhookã€‘â† å…ˆè§¦å‘ï¼
    â”œâ”€ è§¦å‘æˆ‘ä»¬çš„ handleSubscriptionCancelled
    â”œâ”€ æ£€æµ‹åˆ° credits = -50
    â”œâ”€ é‡ç½® credits = 0 âœ…
    â””â”€ ä¿å­˜åˆ° Firestore
    â†“
ã€2. invoice.created webhookã€‘â† åè§¦å‘ï¼
    â”œâ”€ è§¦å‘æˆ‘ä»¬çš„ handleInvoiceCreated
    â”œâ”€ æŸ¥è¯¢ Firestore
    â”œâ”€ å‘ç° currentCredits = 0 â† å·²ç»è¢«é‡ç½®äº†ï¼
    â”œâ”€ åˆ¤æ–­ï¼šæ²¡æœ‰è¶…é¢ä½¿ç”¨
    â””â”€ returnï¼ˆé€€å‡ºï¼‰â† é”™è¯¯ï¼
    â†“
ç»“æœï¼šè¶…é¢è´¹ç”¨æ²¡æœ‰è¢«æŠ¥å‘Š âŒ
```

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `totalCreditsUsed`

### æ ¸å¿ƒæ€æƒ³

**ä¸è¦åªçœ‹ `currentCredits`ï¼Œè¿˜è¦çœ‹ `totalCreditsUsed`ï¼**

å³ä½¿ `currentCredits` å·²è¢«é‡ç½®ä¸º 0ï¼Œ`totalCreditsUsed` ä»ç„¶è®°å½•äº†ç”¨æˆ·çš„æ€»ä½¿ç”¨é‡ã€‚

### ä¿®å¤åçš„é€»è¾‘

```javascript
// handleInvoiceCreated å‡½æ•°
const currentCredits = userData.currentCredits || 0;
const totalCreditsUsed = userData.totalCreditsUsed || 0;  // â† æ–°å¢ï¼
const monthlyCredits = userData?.subscription?.monthlyCredits || 100;

// è®¡ç®—è¶…é¢ä½¿ç”¨é‡
let overageAmount = 0;

if (currentCredits < 0) {
    // æƒ…å†µ 1ï¼šcredits è¿˜æ˜¯è´Ÿæ•°ï¼ˆwebhook é¡ºåºæ­£å¸¸ï¼‰
    overageAmount = Math.abs(currentCredits);
    console.log(`âœ… ä» currentCredits æ£€æµ‹åˆ°è¶…é¢: ${overageAmount}`);
    
} else if (totalCreditsUsed > monthlyCredits) {
    // æƒ…å†µ 2ï¼šcredits å·²è¢«é‡ç½®ï¼Œä½† totalCreditsUsed æ˜¾ç¤ºæœ‰è¶…é¢
    overageAmount = totalCreditsUsed - monthlyCredits;  // â† å…³é”®ï¼
    console.log(`âœ… ä» totalCreditsUsed æ£€æµ‹åˆ°è¶…é¢: ${overageAmount}`);
    console.log(`   ï¼ˆcurrentCredits å·²è¢«é‡ç½®ï¼Œä½†ä»å†å²ä½¿ç”¨é‡è®¡ç®—å‡ºè¶…é¢ï¼‰`);
}

if (overageAmount === 0) {
    console.log(`âœ… æ²¡æœ‰è¶…é¢ä½¿ç”¨ï¼Œæ— éœ€æŠ¥å‘Š`);
    return;
}

// ç»§ç»­æŠ¥å‘Šè¶…é¢ä½¿ç”¨ç»™ Stripe...
```

---

## ğŸ“Š ä¸¤ç§åœºæ™¯çš„å¤„ç†

### åœºæ™¯ 1ï¼šWebhook é¡ºåºæ­£å¸¸

```
ã€invoice.createdã€‘å…ˆè§¦å‘
    â”œâ”€ currentCredits = -50
    â”œâ”€ æ£€æµ‹åˆ°è¶…é¢ï¼š50 Credits âœ…
    â””â”€ æŠ¥å‘Šç»™ Stripe
    â†“
ã€customer.subscription.deletedã€‘åè§¦å‘
    â”œâ”€ currentCredits = -50
    â”œâ”€ é‡ç½® credits = 0
    â””â”€ å®Œæˆ

ç»“æœï¼šâœ… è¶…é¢è´¹ç”¨å·²æŠ¥å‘Š
```

### åœºæ™¯ 2ï¼šWebhook é¡ºåºé¢ å€’ï¼ˆä½ é‡åˆ°çš„æƒ…å†µï¼‰

```
ã€customer.subscription.deletedã€‘å…ˆè§¦å‘
    â”œâ”€ currentCredits = -50
    â”œâ”€ é‡ç½® credits = 0
    â””â”€ totalCreditsUsed = 150ï¼ˆä¿æŒä¸å˜ï¼‰
    â†“
ã€invoice.createdã€‘åè§¦å‘
    â”œâ”€ currentCredits = 0ï¼ˆå·²é‡ç½®ï¼‰
    â”œâ”€ totalCreditsUsed = 150
    â”œâ”€ monthlyCredits = 100
    â”œâ”€ è®¡ç®—ï¼š150 - 100 = 50
    â”œâ”€ æ£€æµ‹åˆ°è¶…é¢ï¼š50 Credits âœ…
    â””â”€ æŠ¥å‘Šç»™ Stripe

ç»“æœï¼šâœ… è¶…é¢è´¹ç”¨å·²æŠ¥å‘Šï¼ˆé€šè¿‡ totalCreditsUsedï¼‰
```

---

## ğŸ¯ ä¿®å¤çš„å…³é”®ç‚¹

### 1. âœ… åŒé‡æ£€æŸ¥æœºåˆ¶

```javascript
// ä¼˜å…ˆä½¿ç”¨ currentCredits
if (currentCredits < 0) {
    overageAmount = Math.abs(currentCredits);
}
// å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ totalCreditsUsed
else if (totalCreditsUsed > monthlyCredits) {
    overageAmount = totalCreditsUsed - monthlyCredits;
}
```

### 2. âœ… æ”¯æŒ"ç«‹å³å–æ¶ˆ"

ç°åœ¨æ— è®ºç”¨æˆ·é€‰æ‹©å“ªç§å–æ¶ˆæ–¹å¼ï¼Œéƒ½èƒ½æ­£ç¡®æ£€æµ‹å¹¶æŠ¥å‘Šè¶…é¢ä½¿ç”¨ã€‚

### 3. âœ… ä¸ä¾èµ– Webhook é¡ºåº

æ— è®º Webhook ä»¥ä»€ä¹ˆé¡ºåºåˆ°è¾¾ï¼Œéƒ½èƒ½æ­£ç¡®å¤„ç†ã€‚

---

## ğŸ“ æµ‹è¯•éªŒè¯

### ä½ çš„æ—¥å¿—ï¼ˆå›¾1ï¼‰æ˜¾ç¤º

ä¿®å¤å‰çš„æ—¥å¿—ï¼š
```
âœ… æ£€æµ‹åˆ° invoice.created webhook ä¸­æœŸåæŠ¥ Stripe
âœ… Stripe å°†è‡ªåŠ¨å°†è´¹ç”¨åœ¨åç»­è´¦å•ä¸­åŒ…å«è¿›å»
ğŸ“Š è®¢é˜…å–æ¶ˆæ—¶çš„ç”¨æˆ·æ•°æ®ï¼š{ credits: -50, totalCreditsUsed: 150 ...
ğŸ’° Credits ä¸ºè´Ÿæ•° (-50)ï¼Œå·²æ£€æµ‹è¶…é¢ä½¿ç”¨ï¼Œé‡ç½®ä¸º 0

âŒ ç¼ºå°‘ï¼šâš ï¸ æ£€æµ‹åˆ°è¶…é¢ä½¿ç”¨: 50 Credits
âŒ ç¼ºå°‘ï¼šâœ… æˆåŠŸæŠ¥å‘Šæ€»ä½¿ç”¨é‡ç»™ Stripe: 150
```

**é—®é¢˜åŸå› ï¼š**
- `customer.subscription.deleted` å…ˆè§¦å‘ï¼Œé‡ç½®äº† credits
- `invoice.created` åè§¦å‘ï¼Œä½†æ£€æŸ¥ `currentCredits = 0`ï¼Œåˆ¤æ–­æ²¡æœ‰è¶…é¢

ä¿®å¤åçš„é¢„æœŸæ—¥å¿—ï¼š
```
âœ… invoice.created webhook è§¦å‘
ğŸ“Š Credits çŠ¶æ€:
   - currentCredits: 0
   - totalCreditsUsed: 150
   - monthlyCredits: 100
âœ… ä» totalCreditsUsed æ£€æµ‹åˆ°è¶…é¢: 50 Credits
   ï¼ˆcurrentCredits å·²è¢«é‡ç½®ï¼Œä½†ä»å†å²ä½¿ç”¨é‡è®¡ç®—å‡ºè¶…é¢ï¼‰
âœ… æˆåŠŸæŠ¥å‘Šæ€»ä½¿ç”¨é‡ç»™ Stripe: 150
ğŸ’µ é¢„æœŸ Stripe ä¼šåœ¨æ­¤å‘ç¥¨ä¸­æ”¶å–: HK$25.00
```

---

## ğŸ§ª ç«‹å³é‡æ–°æµ‹è¯•

### æ­¥éª¤ 1ï¼šå‡†å¤‡æµ‹è¯•æ•°æ®

```bash
Firestore â†’ users â†’ 1234@gmail.com

è®¾ç½®ï¼š
- currentCredits: -50
- credits: -50
- totalCreditsUsed: 150  â† å…³é”®ï¼
```

### æ­¥éª¤ 2ï¼šé‡æ–°å–æ¶ˆè®¢é˜…

```bash
1. åœ¨ Stripe Dashboard ä¸­é‡æ–°åˆ›å»ºè®¢é˜…ï¼ˆå¦‚æœéœ€è¦ï¼‰
2. ç‚¹å‡»ã€Œå–æ¶ˆè®¢é˜…ã€
3. è¿™æ¬¡å¯ä»¥é€‰æ‹©ã€Œç«‹å³å–æ¶ˆã€ï¼â† ç°åœ¨æ”¯æŒäº†ï¼
4. ç¡®è®¤å–æ¶ˆ
```

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹æ—¥å¿—

<function_calls>
<invoke name="run_terminal_cmd">
<parameter name="command">open "https://console.cloud.google.com/logs/query;query=resource.type%3D%22cloud_function%22%0Aresource.labels.function_name%3D%22stripeWebhook%22%0Atextpayload%3D~%22totalCreditsUsed%22%20OR%20jsonpayload.message%3D~%22è¶…é¢%22?project=vaultcaddy-production-cbbe2"



