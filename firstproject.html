<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    
    <!-- ğŸ”’ é é¢ä¿è­·ï¼šç«‹å³éš±è—å…§å®¹ï¼Œç­‰å¾… Auth æª¢æŸ¥ -->
    <style>
        body.auth-checking {
            visibility: hidden !important;
        }
        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: visible !important;
        }
        body.auth-ready .auth-loading {
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        document.documentElement.classList.add('auth-checking');
        if (document.body) {
            document.body.classList.add('auth-checking');
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.classList.add('auth-checking');
            });
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="page_title_dashboard">å„€è¡¨æ¿ - VaultCaddy</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="pages.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- âœ… æ ¸å¿ƒé…ç½® -->
    <script src="config.js"></script>
    <script src="translations.js?v=20251102"></script>
    
    <!-- âœ… UI çµ„ä»¶ -->
    <script src="navbar-component.js?v=20251102-cleanup2"></script>
    <script src="sidebar-component.js?v=20251102-cleanup2"></script>
    
    <!-- âœ… Firebase SDKï¼ˆCDN ç‰ˆæœ¬ï¼‰-->
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    
    <!-- âœ… Firebase åˆå§‹åŒ–å’Œèº«ä»½é©—è­‰ -->
    <script defer src="firebase-config.js?v=20251102"></script>
    <script defer src="simple-auth.js?v=20251102"></script>
    <script defer src="simple-data-manager.js?v=20251102"></script>
    
    <!-- âœ… AI è™•ç†å™¨ -->
    <script src="hybrid-vision-deepseek.js?v=20251102"></script>
    
    <!-- âœ… æ–‡æª”è™•ç†å’Œå°å‡º -->
    <script src="export-manager.js?v=20251102"></script>
    <script src="batch-upload-processor.js?v=20251102"></script>
    
    
    <style>
        /* ç™½è‰²ä¸»é¡Œæ¨£å¼ */
        body {
            background: #ffffff !important;
            color: #1f2937 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            background: #ffffff;
            padding-top: 60px; /* ç‚ºå°èˆªæ¬„ç•™å‡ºç©ºé–“ */
        }
        
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            flex-shrink: 0;
            position: fixed;
            top: 60px;
            bottom: 0;
            left: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }
        
        .sidebar-header {
            padding: 1.5rem 1rem 1rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sidebar-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
        }
        
        .sidebar-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .sidebar-nav .nav-item {
            margin: 0;
        }
        
        .sidebar-nav .nav-item a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #6b7280;
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-nav .nav-item.active a {
            background: #eff6ff;
            color: #2563eb;
            border-left-color: #2563eb;
        }
        
        .sidebar-nav .nav-item a:hover {
            background: #f1f5f9;
            color: #374151;
        }
        
        .sidebar-nav .nav-item a i {
            width: 20px;
            margin-right: 0.75rem;
            font-size: 1rem;
        }
        
        .sidebar-section {
            padding: 1rem 0;
            border-top: 1px solid #e2e8f0;
        }
        
        .sidebar-section h3 {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0 0 0.5rem 1rem;
        }
        
        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: #ffffff;
        }
        
        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        
        .stat-item:last-child {
            margin-bottom: 0;
        }
        
        .stat-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .stat-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .main-content {
            flex: 1;
            background: #ffffff;
            margin-left: 280px;
            overflow-y: auto;
            min-height: calc(100vh - 60px);
            display: block !important;
            visibility: visible !important;
        }
        
        .page-header {
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
        }
        
        .team-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .team-icon {
            width: 48px;
            height: 48px;
            background: #fbbf24;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .team-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .team-details h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .subscription-badge {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            width: fit-content;
        }
        
        .subscription-badge::after {
            content: 'â–¼';
            font-size: 0.6rem;
            opacity: 0.8;
        }
        
        .project-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .project-btn:hover {
            background: #2563eb;
        }
        
        .controls-bar {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            background: #ffffff;
        }
        
        .filter-input {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #1f2937;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            width: 300px;
            font-size: 14px;
        }
        
        .filter-input::placeholder {
            color: #9ca3af;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .actions {
            display: flex;
            gap: 1rem;
        }
        
        .upload-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .upload-btn:hover {
            background: #4f46e5;
        }
        
        .view-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .view-btn:hover {
            background: #e5e7eb;
        }
        
        .documents-table-container {
            padding: 2rem;
            background: #ffffff;
            flex: 1;
            overflow-x: auto;
        }
        
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 1200px;
        }
        
        .folder-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 180px;
            justify-content: center;
        }
        
        .folder-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }
        
        .folder-icon {
            width: 64px;
            height: 64px;
            background: #f3f4f6;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .folder-icon i {
            font-size: 2rem;
            color: #6b7280;
        }
        
        .folder-icon::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 8px;
            width: 20px;
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px 4px 0 0;
        }
        
        .folder-name {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .folder-files-count {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .folder-updated {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            color: #d1d5db;
            margin-bottom: 1rem;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .empty-state p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .documents-table {
            width: 100%;
            min-width: 1200px; /* ç¢ºä¿è¡¨æ ¼æœ€å°å¯¬åº¦ï¼Œè§¸ç™¼æ°´å¹³æ»¾å‹• */
            border-collapse: collapse;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .documents-table thead th {
            background: #f8fafc;
            color: #374151;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap; /* é˜²æ­¢æ¨™é¡Œæ–‡å­—æ›è¡Œ */
            font-size: 14px;
        }
        
        .documents-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .documents-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .documents-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .documents-table tbody td {
            padding: 1rem;
            color: #374151;
            vertical-align: middle;
            white-space: nowrap; /* é˜²æ­¢å–®å…ƒæ ¼å…§å®¹æ›è¡Œ */
            font-size: 14px;
        }
        
        .document-cell {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .file-icon {
            color: #ef4444;
            font-size: 1.5rem;
        }
        
        .doc-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .doc-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .period-info {
            color: #6b7280;
        }
        
        .reconciliation {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .reconciliation-text {
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }
        
        .progress-percentage {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .reconciliation-status {
            font-size: 0.75rem;
            color: #fbbf24;
        }
        
        .balance-info {
            font-size: 0.875rem;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-badge.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .review-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .review-badge.review {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .pagination-info {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #6b7280;
            border-top: 1px solid #e2e8f0;
            background: #ffffff;
            font-size: 14px;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .rows-per-page {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .rows-per-page:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .pagination-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .page-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .page-btn:hover:not(:disabled) {
            background: #e5e7eb;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* å¯ç·¨è¼¯è¼¸å…¥æ¡†æ¨£å¼ */
        .editable-input {
            border: 1px solid transparent;
            background: transparent;
            padding: 0.5rem;
            font-size: 14px;
            color: #374151;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        
        .editable-input:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #6366f1;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .editable-input[readonly] {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }
        
        .editable-input[readonly]:hover {
            border-color: transparent;
            background: #f3f4f6;
        }
        
        .date-input {
            min-width: 140px;
        }
        
        .description-input {
            min-width: 200px;
        }
        
        .amount-input,
        .balance-input {
            min-width: 100px;
            text-align: right;
        }
        
        .delete-transaction-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .delete-transaction-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* æ–‡æª”è©³ç´°è¦–åœ–æ¨£å¼ */
        .back-navigation {
            padding: 1rem 2rem;
            border-bottom: 1px solid #334155;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .back-btn:hover {
            color: #e2e8f0;
        }
        
        .document-detail-container {
            display: flex;
            min-height: calc(100vh - 200px);
            height: auto;
        }
        
        .pdf-preview-container {
            width: 40%;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }
        
        .pdf-controls {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: #f8fafc;
        }
        
        .pdf-control-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pdf-control-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }
        
        .page-info {
            color: #64748b;
            font-weight: 500;
        }
        
        .pdf-viewer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            padding: 2rem;
        }
        
        .pdf-placeholder {
            text-align: center;
            color: #64748b;
            padding: 2rem;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .pdf-placeholder i {
            font-size: 3rem;
            color: #3b82f6;
            margin-bottom: 1rem;
        }
        
        .pdf-placeholder h3 {
            color: #1f2937;
            margin: 0 0 0.5rem 0;
        }
        
        .pdf-placeholder p {
            color: #6b7280;
            margin: 0;
        }
        
        .pdf-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .data-extraction-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .extraction-header {
            padding: 1rem 2rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .extraction-header h2 {
            font-size: 1.5rem;
            color: #e2e8f0;
            margin: 0;
        }
        
        .extraction-tabs {
            display: flex;
            gap: 1rem;
        }
        
        .tab-btn {
            background: none;
            border: none;
            color: #94a3b8;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
        }
        
        .document-actions {
            display: flex;
            gap: 1rem;
        }
        
        .save-btn, .download-btn, .more-actions-btn {
            background: #475569;
            border: none;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .reconciliation-status {
            padding: 1rem 2rem;
            border-bottom: 1px solid #334155;
        }
        
        .reconciliation-status h3 {
            color: #e2e8f0;
            margin: 0 0 0.5rem 0;
        }
        
        .completion-status {
            color: #fbbf24;
            font-weight: 600;
        }
        
        .bank-statement-details {
            padding: 1rem 2rem;
            border-bottom: 1px solid #334155;
        }
        
        .bank-statement-details h3 {
            color: #e2e8f0;
            margin: 0;
        }
        
        .transactions-section {
            flex: 1;
            padding: 1rem 2rem;
        }
        
        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .transactions-header h3 {
            color: #e2e8f0;
            margin: 0;
        }
        
        .transaction-controls {
            display: flex;
            gap: 1rem;
        }
        
        .control-btn {
            background: #475569;
            border: none;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .add-btn {
            background: #8b5cf6;
        }
        
        .transaction-info {
            margin-bottom: 1rem;
            color: #94a3b8;
        }
        
        .transactions-table-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
        }
        
        .transactions-table thead th {
            background: #f8fafc;
            color: #374151;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .transactions-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        
        .transactions-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .transactions-table tbody td {
            padding: 0.75rem;
            color: #374151;
        }
        
        .transaction-checkbox {
            margin: 0;
        }
        
        .delete-transaction-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .delete-transaction-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .view-container {
            height: 100%;
            display: block !important;
            visibility: visible !important;
        }
        
        /* å¯ç·¨è¼¯è¡¨æ ¼æ¨£å¼ */
        .editable-input {
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            padding: 0.5rem;
            font-size: 14px;
            color: #374151;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #6366f1;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .editable-input:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .date-input {
            min-width: 140px;
        }
        
        .description-input {
            min-width: 200px;
        }
        
        .amount-input, .balance-input {
            min-width: 100px;
            text-align: right;
        }
        
        .transaction-row:hover .editable-input {
            border-color: #d1d5db;
        }
        
        .delete-transaction-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .delete-transaction-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        /* å´é‚Šæ¬„æœç´¢æ¬„ */
        .sidebar-search {
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        .search-input::placeholder {
            color: #9ca3af;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* é …ç›®å€å¡Š */
        .project-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .project-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }
        
        .add-project-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .add-project-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .project-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .project-item:hover {
            color: #374151;
        }
        
        .project-item i {
            margin-right: 0.75rem;
            width: 16px;
        }
        
        /* é…ç½®å€å¡Š */
        .config-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .config-item:hover {
            color: #374151;
        }
        
        .config-item i {
            margin-right: 0.75rem;
            width: 16px;
        }
        
        /* å´é‚Šæ¬„é …ç›®hoveræ•ˆæœ */
        .nav-item:hover {
            background: #f1f5f9 !important;
        }
        
        .nav-item.active {
            background: #eff6ff !important;
            color: #2563eb !important;
        }
    </style>
</head>
<body class="auth-checking">
    <!-- ğŸ”’ Auth åŠ è¼‰å‹•ç•« -->
    <div class="auth-loading">
        <div style="text-align: center;">
            <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <p style="color: #6b7280; font-size: 0.875rem;">æ­£åœ¨é©—è­‰èº«ä»½...</p>
        </div>
    </div>
    
    <!-- âœ… çµ±ä¸€å°èˆªæ¬„å®¹å™¨ -->
    <div id="navbar-placeholder"></div>
    
    <!-- AI ä¸Šå‚³æ¨¡æ…‹æ¡† - æ”¾åœ¨ body æœ€å‰é¢ç¢ºä¿ç«‹å³è¼‰å…¥ -->
    <div id="aiUploadModal" class="ai-upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; align-items: center; justify-content: center;">
        <div class="ai-upload-overlay" onclick="closeAIUploadModal()" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);"></div>
        <div class="ai-upload-container" style="position: relative; background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <!-- é—œé–‰æŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ -->
            <button class="ai-close-btn" onclick="closeAIUploadModal()" style="position: absolute; top: 1rem; right: 1rem; background: #f3f4f6; border: none; color: #6b7280; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#e5e7eb'; this.style.color='#1f2937'" onmouseout="this.style.background='#f3f4f6'; this.style.color='#6b7280'">
                <i class="fas fa-times"></i>
            </button>

            <!-- ä¸Šå‚³å€åŸŸ -->
            <div class="ai-upload-content" style="padding: 2rem; overflow-y: auto; flex: 1;">
                <!-- æ–‡æª”é¡å‹é¸æ“‡å™¨ -->
                <div class="document-type-selector" style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; color: #1f2937; margin: 0 0 1rem 0; font-weight: 600;">é¸æ“‡æ–‡æª”é¡å‹</h3>
                    <div class="document-types-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <!-- Bank statements -->
                        <div class="doc-type-card" data-type="bank_statement" onclick="selectDocumentType('bank_statement')" style="background: #ffffff; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="font-size: 1.5rem;">ğŸ¦</div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 1rem;">Bank statements</div>
                                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.4;">Convert bank statements to excel and csv</div>
                            </div>
                            <div class="selected-indicator" style="display: none; position: absolute; top: 0.75rem; right: 0.75rem; width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; color: white; align-items: center; justify-content: center; font-size: 0.875rem;">âœ“</div>
                        </div>
                        
                        <!-- Invoices -->
                        <div class="doc-type-card" data-type="invoice" onclick="selectDocumentType('invoice')" style="background: #ffffff; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="font-size: 1.5rem;">ğŸ“„</div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 1rem;">Invoices</div>
                                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.4;">Extract numbers, dates, item details, prices, and vendor information</div>
                            </div>
                            <div class="selected-indicator" style="display: none; position: absolute; top: 0.75rem; right: 0.75rem; width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; color: white; align-items: center; justify-content: center; font-size: 0.875rem;">âœ“</div>
                        </div>
                        
                        <!-- Receipts -->
                        <div class="doc-type-card" data-type="receipt" onclick="selectDocumentType('receipt')" style="background: #ffffff; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="font-size: 1.5rem;">ğŸ§¾</div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 1rem;">Receipts</div>
                                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.4;">Classify dates, items, prices, and totals for financial management</div>
                            </div>
                            <div class="selected-indicator" style="display: none; position: absolute; top: 0.75rem; right: 0.75rem; width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; color: white; align-items: center; justify-content: center; font-size: 0.875rem;">âœ“</div>
                        </div>
                        
                        <!-- General -->
                        <div class="doc-type-card" data-type="general" onclick="selectDocumentType('general')" style="background: #ffffff; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="font-size: 1.5rem;">ğŸ“‹</div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 1rem;">General</div>
                                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.4;">Extract text, tables, and other data from any document</div>
                            </div>
                            <div class="selected-indicator" style="display: none; position: absolute; top: 0.75rem; right: 0.75rem; width: 24px; height: 24px; background: #3b82f6; border-radius: 50%; color: white; align-items: center; justify-content: center; font-size: 0.875rem;">âœ“</div>
                        </div>
                    </div>
                </div>
                
                <!-- ä¸Šå‚³å€åŸŸ -->
                <div id="aiUploadArea" class="ai-upload-area" style="border: 3px dashed #d1d5db; border-radius: 12px; padding: 3rem 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #fafafa;">
                    <div class="ai-upload-icon" style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“„</div>
                    <div class="ai-upload-text" style="font-size: 1.2rem; color: #374151; margin-bottom: 0.5rem; font-weight: 600;">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤è™•æˆ–é»æ“Šä¸Šå‚³</div>
                    <div class="ai-upload-hint" style="color: #6b7280; font-size: 0.9rem;">æ”¯æ´ PDFã€JPGã€PNG æ ¼å¼ (æœ€å¤§ 10MB)ï½œâœ¨ æ”¯æŒæ‰¹é‡ä¸Šå‚³</div>
                    <input type="file" id="aiFileInput" class="ai-file-input" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp" multiple style="display: none;">
                </div>

                <!-- è™•ç†é€²åº¦ -->
                <div id="aiProgressContainer" class="ai-progress-container" style="display: none; margin-top: 2rem;">
                    <div class="ai-progress-steps" style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                        <div class="ai-step" data-step="1" style="flex: 1; text-align: center; opacity: 0.4; transition: all 0.3s ease;">
                            <div class="ai-step-icon" style="font-size: 2.5rem; margin-bottom: 0.5rem; position: relative; display: inline-block;">ğŸ“¤</div>
                            <div class="ai-step-text" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">æ–‡ä»¶ä¸Šå‚³</div>
                        </div>
                        <div class="ai-step" data-step="2" style="flex: 1; text-align: center; opacity: 0.4; transition: all 0.3s ease;">
                            <div class="ai-step-icon" style="font-size: 2.5rem; margin-bottom: 0.5rem; position: relative; display: inline-block;">ğŸ¤–</div>
                            <div class="ai-step-text" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">AI åˆ†æ</div>
                        </div>
                        <div class="ai-step" data-step="3" style="flex: 1; text-align: center; opacity: 0.4; transition: all 0.3s ease;">
                            <div class="ai-step-icon" style="font-size: 2.5rem; margin-bottom: 0.5rem; position: relative; display: inline-block;">ğŸ“Š</div>
                            <div class="ai-step-text" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">æ•¸æ“šæå–</div>
                        </div>
                        <div class="ai-step" data-step="4" style="flex: 1; text-align: center; opacity: 0.4; transition: all 0.3s ease;">
                            <div class="ai-step-icon" style="font-size: 2.5rem; margin-bottom: 0.5rem; position: relative; display: inline-block;">â˜ï¸</div>
                            <div class="ai-step-text" style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">é›²ç«¯å­˜å„²</div>
                        </div>
                    </div>
                    <div class="ai-progress-bar" style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div class="ai-progress-fill" id="aiProgressFill" style="height: 100%; background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%); transition: width 0.5s ease; width: 0%;"></div>
                    </div>
                </div>

                <!-- æ‰¹é‡è™•ç†é€²åº¦åˆ—è¡¨ -->
                <div id="batchProgressContainer" class="batch-progress-container" style="display: none; margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="font-size: 1rem; color: #1f2937; margin: 0; font-weight: 600;">è™•ç†é€²åº¦</h4>
                        <div id="batchProgressSummary" style="font-size: 0.875rem; color: #6b7280;">
                            <span id="batchCompletedCount">0</span> / <span id="batchTotalCount">0</span> å®Œæˆ
                        </div>
                    </div>
                    <div id="batchFilesList" class="batch-files-list" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 400px; overflow-y: auto;">
                        <!-- æ–‡ä»¶é …ç›®å°‡å‹•æ…‹æ·»åŠ åˆ°é€™è£¡ -->
                    </div>
                </div>

                <!-- è™•ç†æ—¥èªŒ -->
                <div id="aiLogContainer" class="ai-log-container" style="display: none; margin-top: 1.5rem; background: #1f2937; border-radius: 8px; padding: 1rem; max-height: 200px; overflow-y: auto;">
                    <div class="ai-log-header" style="color: #9ca3af; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">è™•ç†æ—¥èªŒ</div>
                    <div id="aiLogContent" class="ai-log-content" style="font-family: 'Monaco', 'Courier New', monospace; font-size: 0.75rem; color: #d1d5db; line-height: 1.6;"></div>
                </div>

                <!-- æå–çµæœ -->
                <div id="aiResultsContainer" class="ai-results-container" style="display: none; margin-top: 1.5rem; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div class="ai-results-header" style="background: #f9fafb; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">ğŸ“Š æå–çš„æ•¸æ“š</div>
                    <div id="aiResultsContent" class="ai-results-content" style="padding: 1.5rem; max-height: 300px; overflow-y: auto;"></div>
                    <div class="ai-results-actions" style="display: flex; gap: 1rem; padding: 1rem; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                        <button class="ai-btn ai-btn-primary" onclick="saveAIResults()" style="flex: 1; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; background: #4f46e5; color: white;">
                            <i class="fas fa-save"></i> ä¿å­˜åˆ°é …ç›®
                        </button>
                        <button class="ai-btn ai-btn-secondary" onclick="resetAIUpload()" style="flex: 1; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; background: #f3f4f6; color: #374151;">
                            <i class="fas fa-redo"></i> è™•ç†å¦ä¸€å€‹æ–‡ä»¶
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== ğŸ”§ ç«‹å³å®šç¾©å…¨å±€å‡½æ•¸ï¼ˆç°¡åŒ–ç‰ˆï¼Œç„¡å ä½ç¬¦ï¼‰ ==========
        console.log('ğŸš€ é–‹å§‹å®šç¾©å…¨å±€å‡½æ•¸...');
        
        // 1. Upload files æŒ‰éˆ•
        window.openUploadModal = function() {
            console.log('ğŸ”µ openUploadModal è¢«èª¿ç”¨');
            
            // ç­‰å¾… DOM åŠ è¼‰å®Œæˆ
            if (document.readyState === 'loading') {
                console.log('â³ DOM å°šæœªè¼‰å…¥ï¼Œç­‰å¾… DOMContentLoaded...');
                document.addEventListener('DOMContentLoaded', window.openUploadModal);
                return;
            }
            
            // æ‰“é–‹æ¨¡æ…‹æ¡†
            const modal = document.getElementById('aiUploadModal');
            if (modal) {
                console.log('âœ… æ‰¾åˆ°æ¨¡æ…‹æ¡†ï¼Œæ­£åœ¨æ‰“é–‹...');
                modal.style.display = 'flex';
                
                // å»¶é²åˆå§‹åŒ–ä¸Šå‚³åŠŸèƒ½
                setTimeout(() => {
                    if (typeof window.initializeAIUpload === 'function') {
                        window.initializeAIUpload();
                    } else {
                        console.warn('âš ï¸ initializeAIUpload å°šæœªå®šç¾©ï¼Œç¨å¾Œé‡è©¦...');
                        setTimeout(() => {
                            if (typeof window.initializeAIUpload === 'function') {
                                window.initializeAIUpload();
                            }
                        }, 500);
                    }
                }, 100);
            } else {
                console.error('âŒ æ‰¾ä¸åˆ° aiUploadModal å…ƒç´ ');
                alert('ä¸Šå‚³åŠŸèƒ½åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        };
        
        // 2. Close upload modal
        window.closeAIUploadModal = function() {
            console.log('ğŸ”µ closeAIUploadModal è¢«èª¿ç”¨');
            const modal = document.getElementById('aiUploadModal');
            if (modal) {
                modal.style.display = 'none';
                if (typeof window.resetAIUpload === 'function') {
                    window.resetAIUpload();
                }
            }
        };
        
        // 3. Delete æŒ‰éˆ•
        window.confirmDeleteProject = function() {
            console.log('ğŸ”µ confirmDeleteProject è¢«èª¿ç”¨');
            
            const confirmed = confirm('æ˜¯å¦åˆªé™¤æ­¤é é¢ï¼Ÿ');
            if (!confirmed) {
                console.log('âŒ ç”¨æˆ¶å–æ¶ˆåˆªé™¤');
                return;
            }
            
            // ç²å–é …ç›® ID
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project') || urlParams.get('projectId');
            
            if (!projectId) {
                console.error('âŒ ç„¡æ³•ç²å–é …ç›® ID');
                alert('ç„¡æ³•åˆªé™¤é …ç›®ï¼šé …ç›® ID ä¸å­˜åœ¨');
                return;
            }
            
            console.log('ğŸ—‘ï¸ æº–å‚™åˆªé™¤é …ç›®:', projectId);
            
            // èª¿ç”¨åˆªé™¤å‡½æ•¸
            if (typeof window.deleteProject === 'function') {
                window.deleteProject(projectId);
            } else {
                console.error('âŒ deleteProject å‡½æ•¸å°šæœªå®šç¾©');
                alert('åˆªé™¤åŠŸèƒ½å°šæœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        };
        
        // 4. Toggle project name edit
        window.toggleProjectNameEdit = function() {
            console.log('ğŸ”µ toggleProjectNameEdit è¢«èª¿ç”¨');
            if (typeof window.updateProjectTitle === 'function') {
                window.updateProjectTitle();
            } else {
                console.warn('âš ï¸ updateProjectTitle å°šæœªå®šç¾©');
            }
        };
        
        // 5. Toggle export menu
        window.toggleExportMenu = function() {
            console.log('ğŸ”µ toggleExportMenu è¢«èª¿ç”¨');
            const menu = document.getElementById('export-menu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        };
        
        // 6. Export documents
        window.exportDocuments = function(format) {
            console.log('ğŸ”µ exportDocuments è¢«èª¿ç”¨ï¼Œæ ¼å¼:', format);
            alert(`å°å‡ºåŠŸèƒ½é–‹ç™¼ä¸­ï¼š${format}`);
        };
        
        console.log('âœ… å…¨å±€å‡½æ•¸å·²å®šç¾©ï¼ˆç°¡åŒ–ç‰ˆï¼‰');
        console.log('   - openUploadModal');
        console.log('   - closeAIUploadModal');
        console.log('   - confirmDeleteProject');
        console.log('   - toggleProjectNameEdit');
        console.log('   - toggleExportMenu');
        console.log('   - exportDocuments');
        
        // ========== ğŸ”§ å®šç¾©ä¾è³´å‡½æ•¸ï¼ˆDelete åŠŸèƒ½ï¼‰ ==========
        window.deleteProject = async function(projectId) {
            try {
                console.log('ğŸ—‘ï¸ é–‹å§‹åˆªé™¤é …ç›®:', projectId);
                
                // å¾ Firebase åˆªé™¤
                const dataManager = window.simpleDataManager || window.firebaseDataManager;
                if (dataManager && dataManager.initialized) {
                    await dataManager.deleteProject(projectId);
                    console.log('âœ… é …ç›®å·²å¾ Firebase åˆªé™¤');
                } else {
                    console.warn('âš ï¸ Firebase æœªåˆå§‹åŒ–ï¼Œåƒ…å¾ LocalStorage åˆªé™¤');
                }
                
                // å¾ LocalStorage åˆªé™¤ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                try {
                    const projects = JSON.parse(localStorage.getItem('vaultcaddy_projects') || '[]');
                    const updatedProjects = projects.filter(p => p.id !== projectId);
                    localStorage.setItem('vaultcaddy_projects', JSON.stringify(updatedProjects));
                    console.log('âœ… é …ç›®å·²å¾ LocalStorage åˆªé™¤');
                } catch (error) {
                    console.error('âŒ LocalStorage åˆªé™¤å¤±æ•—:', error);
                }
                
                // è§¸ç™¼äº‹ä»¶ï¼Œæ›´æ–°å´é‚Šæ¬„
                window.dispatchEvent(new CustomEvent('project-deleted', { 
                    detail: { projectId } 
                }));
                
                // é‡å®šå‘åˆ° dashboard
                console.log('ğŸ”„ é‡å®šå‘åˆ° dashboard.html');
                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error('âŒ åˆªé™¤é …ç›®å¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        };
        
        // ========== ğŸ”§ å®šç¾©ä¾è³´å‡½æ•¸ï¼ˆUpload åŠŸèƒ½ï¼‰ ==========
        
        // å…¨å±€è®Šé‡
        window.selectedDocumentType = 'bank_statement'; // é»˜èªé¡å‹
        window.aiCurrentFile = null;
        window.aiIsProcessing = false;
        
        // åˆå§‹åŒ–ä¸Šå‚³åŠŸèƒ½
        window.initializeAIUpload = function() {
            console.log('ğŸ¬ initializeAIUpload è¢«èª¿ç”¨');
            
            const uploadArea = document.getElementById('aiUploadArea');
            const fileInput = document.getElementById('aiFileInput');
            
            if (!uploadArea || !fileInput) {
                console.error('âŒ æ‰¾ä¸åˆ°ä¸Šå‚³å…ƒç´ ');
                console.error('   uploadArea:', !!uploadArea);
                console.error('   fileInput:', !!fileInput);
                return;
            }
            
            console.log('âœ… æ‰¾åˆ°ä¸Šå‚³å…ƒç´ ï¼Œé–‹å§‹ç¶å®šäº‹ä»¶');
            
            // æ‹–æ”¾äº‹ä»¶
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#3b82f6';
                uploadArea.style.background = '#eff6ff';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.background = '#ffffff';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.background = '#ffffff';
                const file = e.dataTransfer.files[0];
                if (file) {
                    console.log('ğŸ“ æ‹–æ”¾æ–‡ä»¶:', file.name);
                    window.handleAIFileUpload(file);
                }
            });
            
            // é»æ“Šä¸Šå‚³
            uploadArea.addEventListener('click', () => {
                console.log('ğŸ–±ï¸ é»æ“Šä¸Šå‚³å€åŸŸ');
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('ğŸ“ é¸æ“‡æ–‡ä»¶:', file.name);
                    window.handleAIFileUpload(file);
                }
            });
            
            console.log('âœ… AI ä¸Šå‚³å·²åˆå§‹åŒ–');
        };
        
        // é¸æ“‡æ–‡æª”é¡å‹
        window.selectDocumentType = function(type) {
            console.log('ğŸ“„ é¸æ“‡æ–‡æª”é¡å‹:', type);
            window.selectedDocumentType = type;
            
            // æ›´æ–° UIï¼ˆé«˜äº®é¸ä¸­çš„é¡å‹ï¼‰
            document.querySelectorAll('.document-type-card').forEach(card => {
                card.classList.remove('selected');
                card.style.borderColor = '#e5e7eb';
                card.style.background = '#ffffff';
            });
            
            const selectedCard = document.querySelector(`[data-type="${type}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedCard.style.borderColor = '#3b82f6';
                selectedCard.style.background = '#eff6ff';
            }
            
            console.log('âœ… æ–‡æª”é¡å‹å·²é¸æ“‡:', type);
        };
        
        // è™•ç†æ–‡ä»¶ä¸Šå‚³
        window.handleAIFileUpload = async function(file) {
            console.log('ğŸ“¤ é–‹å§‹è™•ç†æ–‡ä»¶:', file.name);
            console.log('   æ–‡ä»¶å¤§å°:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            console.log('   æ–‡ä»¶é¡å‹:', file.type);
            console.log('   æ–‡æª”é¡å‹:', window.selectedDocumentType);
            
            if (window.aiIsProcessing) {
                alert('æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            
            window.aiIsProcessing = true;
            window.aiCurrentFile = file;
            
            try {
                // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
                const uploadArea = document.getElementById('aiUploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div style="text-align: center;">
                            <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                            <p style="color: #6b7280;">æ­£åœ¨è™•ç†æ–‡ä»¶...</p>
                            <p style="color: #9ca3af; font-size: 0.875rem;">${file.name}</p>
                        </div>
                    `;
                }
                
                // AI è™•ç†
                const result = await window.processWithAI(file, window.selectedDocumentType);
                console.log('âœ… AI è™•ç†å®Œæˆ:', result);
                
                // ä¿å­˜åˆ° Firebase
                const savedDoc = await window.saveDocumentToFirebase(result);
                console.log('âœ… æ–‡æª”å·²ä¿å­˜:', savedDoc);
                
                // é—œé–‰æ¨¡æ…‹æ¡†
                window.closeAIUploadModal();
                
                // ç›´æ¥åœ¨å‰ç«¯æ·»åŠ è¡¨æ ¼è¡Œï¼ˆä¸åˆ·æ–°é é¢ï¼‰
                window.addDocumentToTable(savedDoc);
                
                // é¡¯ç¤ºæˆåŠŸæç¤º
                alert('âœ… æ–‡æª”ä¸Šå‚³æˆåŠŸï¼');
                
            } catch (error) {
                console.error('âŒ è™•ç†å¤±æ•—:', error);
                alert('è™•ç†å¤±æ•—ï¼š' + error.message);
                
                // é‡ç½®ä¸Šå‚³å€åŸŸ
                window.resetAIUpload();
            } finally {
                window.aiIsProcessing = false;
            }
        };
        
        // AI è™•ç†æ–‡ä»¶
        window.processWithAI = async function(file, documentType) {
            console.log('ğŸ¤– é–‹å§‹ AI è™•ç†...');
            console.log('   æ–‡æª”é¡å‹:', documentType);
            
            // æª¢æŸ¥è™•ç†å™¨é¡æ˜¯å¦å­˜åœ¨
            if (typeof window.HybridVisionDeepSeekProcessor === 'undefined') {
                throw new Error('HybridVisionDeepSeekProcessor é¡åˆ¥æœªåŠ è¼‰ï¼Œè«‹ç¢ºä¿ hybrid-vision-deepseek.js å·²åŠ è¼‰');
            }
            
            // å¦‚æœå¯¦ä¾‹ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸€å€‹
            if (!window.hybridVisionDeepSeekProcessor) {
                console.log('ğŸ”§ å‰µå»º HybridVisionDeepSeekProcessor å¯¦ä¾‹...');
                window.hybridVisionDeepSeekProcessor = new window.HybridVisionDeepSeekProcessor();
            }
            
            const processor = window.hybridVisionDeepSeekProcessor;
            
            // æ˜ å°„æ–‡æª”é¡å‹ï¼ˆå‰ç«¯ â†’ è™•ç†å™¨ï¼‰
            const typeMap = {
                'bank_statement': 'bank-statement',
                'invoice': 'invoice',
                'receipt': 'receipt',
                'general': 'general'
            };
            
            const processorType = typeMap[documentType] || documentType;
            console.log('   æ˜ å°„é¡å‹:', documentType, 'â†’', processorType);
            
            // è™•ç†æ–‡æª”
            const result = await processor.processDocument(file, processorType);
            console.log('âœ… AI è™•ç†å®Œæˆ');
            
            return result;
        };
        
        // ä¿å­˜åˆ° Firebase
        window.saveDocumentToFirebase = async function(documentData) {
            console.log('ğŸ’¾ ä¿å­˜åˆ° Firebase...');
            
            // ç²å–é …ç›® ID
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project') || urlParams.get('projectId');
            
            if (!projectId) {
                throw new Error('ç„¡æ³•ç²å–é …ç›® ID');
            }
            
            // æº–å‚™æ–‡æª”æ•¸æ“š
            const doc = {
                id: Date.now().toString(),
                name: documentData.fileName || documentData.name || 'æœªå‘½åæ–‡æª”',
                type: window.selectedDocumentType || 'general',
                uploadDate: new Date().toISOString(),
                processedData: documentData,
                status: 'completed'
            };
            
            // ä¿å­˜åˆ° Firebase
            const dataManager = window.simpleDataManager || window.firebaseDataManager;
            if (dataManager && dataManager.initialized) {
                await dataManager.createDocument(projectId, doc);
                console.log('âœ… å·²ä¿å­˜åˆ° Firebase');
            } else {
                console.warn('âš ï¸ Firebase æœªåˆå§‹åŒ–ï¼Œä¿å­˜åˆ° LocalStorage');
                // ä¿å­˜åˆ° LocalStorageï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                const documents = JSON.parse(localStorage.getItem(`vaultcaddy_documents_${projectId}`) || '[]');
                documents.push(doc);
                localStorage.setItem(`vaultcaddy_documents_${projectId}`, JSON.stringify(documents));
            }
            
            return doc;
        };
        
        // é‡ç½®ä¸Šå‚³ç‹€æ…‹
        window.resetAIUpload = function() {
            console.log('ğŸ”„ é‡ç½®ä¸Šå‚³ç‹€æ…‹');
            
            window.selectedDocumentType = 'bank_statement';
            window.aiCurrentFile = null;
            window.aiIsProcessing = false;
            
            const fileInput = document.getElementById('aiFileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            
            const uploadArea = document.getElementById('aiUploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                        <h3 style="color: #374151; margin-bottom: 0.5rem;">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡</h3>
                        <p style="color: #6b7280; font-size: 0.875rem;">æ”¯æŒ PDFã€JPGã€PNG æ ¼å¼ï¼ˆæœ€å¤§ 10MBï¼‰</p>
                    </div>
                `;
            }
        };
        
        // æ·»åŠ æ–‡æª”åˆ°è¡¨æ ¼
        window.addDocumentToTable = function(doc) {
            console.log('ğŸ“„ æ·»åŠ æ–‡æª”åˆ°è¡¨æ ¼:', doc);
            
            const tbody = document.getElementById('documents-tbody');
            if (!tbody) {
                console.error('âŒ æ‰¾ä¸åˆ°è¡¨æ ¼ tbody');
                return;
            }
            
            // ç§»é™¤ "No results." æç¤º
            const noResults = tbody.querySelector('tr td[colspan]');
            if (noResults) {
                tbody.innerHTML = '';
            }
            
            // æå–æ•¸æ“š
            const data = doc.processedData || {};
            const invoiceDate = data.invoiceDate || data.date || '-';
            const items = data.lineItems || data.items || [];
            const itemsCount = items.length || 0;
            const total = data.totalAmount || data.total || '-';
            
            // å‰µå»ºæ–°è¡Œ
            const newRow = document.createElement('tr');
            newRow.style.cssText = 'border-bottom: 1px solid #e5e7eb;';
            newRow.innerHTML = `
                <td style="padding: 1rem 1.5rem;">
                    <input type="checkbox" class="document-checkbox">
                </td>
                <td style="padding: 1rem 1.5rem;">
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-file-alt" style="color: #3b82f6; margin-right: 0.75rem; font-size: 1.25rem;"></i>
                        <a href="document-detail.html?project=${new URLSearchParams(window.location.search).get('project')}&document=${doc.id}" style="color: #2563eb; text-decoration: none; font-weight: 500;">${doc.name}</a>
                    </div>
                </td>
                <td style="padding: 1rem 1.5rem; color: #6b7280;">${invoiceDate}</td>
                <td style="padding: 1rem 1.5rem; color: #6b7280;">${itemsCount} é …</td>
                <td style="padding: 1rem 1.5rem; color: #6b7280;">${total}</td>
                <td style="padding: 1rem 1.5rem;">
                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">å·²å®Œæˆ</span>
                </td>
                <td style="padding: 1rem 1.5rem;">
                    <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">å¾…å¯©æ ¸</span>
                </td>
                <td style="padding: 1rem 1.5rem; color: #6b7280;">-</td>
                <td style="padding: 1rem 1.5rem; color: #6b7280;">${new Date(doc.uploadDate).toLocaleDateString()}</td>
                <td style="padding: 1rem 1.5rem;">
                    <button onclick="deleteDocument('${doc.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.5rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.insertBefore(newRow, tbody.firstChild);
            console.log('âœ… æ–‡æª”å·²æ·»åŠ åˆ°è¡¨æ ¼');
        };
        
        console.log('âœ… æ‰€æœ‰ä¾è³´å‡½æ•¸å·²å®šç¾©');
        console.log('   - deleteProject');
        console.log('   - initializeAIUpload');
        console.log('   - selectDocumentType');
        console.log('   - handleAIFileUpload');
        console.log('   - processWithAI');
        console.log('   - saveDocumentToFirebase');
        console.log('   - resetAIUpload');
        console.log('   - addDocumentToTable');
        
        // ç«‹å³åŸ·è¡Œçš„é é¢å¯è¦‹æ€§è…³æœ¬
        (function() {
            document.documentElement.style.cssText = 'display: block !important; visibility: visible !important;';
            document.body.style.cssText = 'display: block !important; visibility: visible !important; background: #ffffff;';
            
            // ç«‹å³ç¢ºèªæ¨¡æ…‹æ¡†å­˜åœ¨
            console.log('ğŸš€ Body é–‹å§‹è¼‰å…¥ï¼Œç«‹å³æª¢æŸ¥æ¨¡æ…‹æ¡†');
            const immediateCheck = document.getElementById('aiUploadModal');
            console.log('âš¡ ç«‹å³æª¢æŸ¥çµæœ:', immediateCheck ? 'âœ… æ¨¡æ…‹æ¡†å·²åœ¨ DOM ä¸­' : 'âŒ æ¨¡æ…‹æ¡†ä¸å­˜åœ¨');
        })();
    </script>

    <!-- å°èˆªæ¬„ï¼ˆç”± navbar-component.js å‹•æ…‹ç”Ÿæˆï¼‰-->
    <div id="navbar-placeholder"></div>

    <!-- Dashboard å®¹å™¨ -->
    <div class="dashboard-container" style="display: flex !important; min-height: calc(100vh - 60px); background: #ffffff; padding-top: 60px; visibility: visible !important;">
        <!-- å·¦å´é‚Šæ¬„ (ç”± sidebar-component.js å‹•æ…‹ç”Ÿæˆ) -->
        <aside class="sidebar"></aside>

        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <main class="main-content" id="main-content" style="flex: 1; background: #ffffff; overflow-y: auto; min-height: calc(100vh - 60px); display: block !important; visibility: visible !important;">
            <!-- Team Project è¦–åœ– -->
            <div id="team-project-view" class="view-container" style="display: block !important; visibility: visible !important; padding: 2rem 3rem; background: #ffffff;">
                <!-- é é¢æ¨™é¡Œ -->
                <header style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <h1 id="team-project-title" contenteditable="false" style="font-size: 2rem; font-weight: 700; color: #1f2937; margin: 0; outline: none; border: 2px solid transparent; padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.2s;">Project</h1>
                            <button id="edit-project-name-btn" onclick="toggleProjectNameEdit()" style="background: transparent; border: none; cursor: pointer; color: #6b7280; padding: 0.5rem; border-radius: 4px; transition: all 0.2s;" title="ç·¨è¼¯é …ç›®åç¨±">
                                <i class="fas fa-pen" style="font-size: 1.25rem;"></i>
                            </button>
                        </div>
                        <p style="color: #6b7280; font-size: 1rem; margin: 0;">Manage and view your documents</p>
                    </div>
                    <button onclick="confirmDeleteProject()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </button>
                </header>

                <!-- æ§åˆ¶æ¬„ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div style="flex: 1; max-width: 300px;">
                        <input type="text" placeholder="Filter document name..." style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; background: #ffffff; color: #1f2937; font-size: 0.875rem;">
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button onclick="openUploadModal()" style="background: #8b5cf6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                            <span>Upload files</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <div class="dropdown" style="position: relative;">
                            <button onclick="toggleExportMenu()" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-download"></i>
                                <span>Export</span>
                                <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                            </button>
                            <div id="exportMenu" class="export-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 200px; z-index: 1000;">
                                <div style="padding: 0.5rem 0;">
                                    <button onclick="exportDocuments('csv')" class="export-menu-item" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: #374151; transition: background 0.2s;">
                                        <i class="fas fa-file-csv" style="color: #10b981; width: 20px;"></i>
                                        <div>
                                            <div style="font-weight: 500;">CSV</div>
                                            <div style="font-size: 0.75rem; color: #6b7280;">é€šç”¨æ ¼å¼</div>
                                        </div>
                                    </button>
                                    <button onclick="exportDocuments('iif')" class="export-menu-item" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: #374151; transition: background 0.2s;">
                                        <i class="fas fa-file-alt" style="color: #3b82f6; width: 20px;"></i>
                                        <div>
                                            <div style="font-weight: 500;">IIF</div>
                                            <div style="font-size: 0.75rem; color: #6b7280;">QuickBooks Desktop</div>
                                        </div>
                                    </button>
                                    <button onclick="exportDocuments('qbo')" class="export-menu-item" style="width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: #374151; transition: background 0.2s;">
                                        <i class="fas fa-cloud" style="color: #8b5cf6; width: 20px;"></i>
                                        <div>
                                            <div style="font-weight: 500;">QBO</div>
                                            <div style="font-size: 0.75rem; color: #6b7280;">QuickBooks Online</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.75rem 1rem; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <i class="fas fa-sliders-h"></i>
                            <span>View</span>
                        </button>
                        <button style="background: transparent; border: none; color: #6b7280; padding: 0.5rem; cursor: pointer; font-size: 1.25rem;">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </div>
                </div>

                <!-- æ–‡æª”è¡¨æ ¼ -->
                <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8fafc;">
                            <tr>
                                <!-- Checkbox åˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; width: 50px;">
                                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()">
                                </th>
                                <!-- æ–‡æª”åˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="document">Document</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- å¸³å–®æ—¥æœŸåˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="invoice_date">Invoice Date</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- å•†å“åˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="items_count">Items</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- é¤˜é¡ä¿¡æ¯åˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="balance_info">Balance Info</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- ç‹€æ…‹åˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="status">Status</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- å¯©æ ¸ç‹€æ…‹åˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="review_status">Review Status</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- å‚™è¨»åˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="notes">Notes</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- ä¸Šå‚³æ—¥æœŸåˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="date_uploaded">Date Uploaded</span>
                                    <i class="fas fa-sort" style="margin-left: 0.5rem; color: #9ca3af;"></i>
                                </th>
                                <!-- æ“ä½œåˆ— -->
                                <th style="text-align: left; padding: 1rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">
                                    <span data-translate="actions">Actions</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="team-project-tbody">
                            <!-- ç©ºç‹€æ…‹ -->
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 4rem 2rem;">
                                    <div style="color: #6b7280;">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; color: #d1d5db;"></i>
                                        <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #374151;">No results.</h3>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é æ§åˆ¶ -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; margin-top: 1rem;">
                    <div>
                        <span style="color: #6b7280; font-size: 0.875rem;">0 of 0 row(s) selected.</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: #6b7280; font-size: 0.875rem;">Rows per page</span>
                            <select style="background: #ffffff; border: 1px solid #d1d5db; color: #1f2937; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div>
                            <span style="color: #374151; font-size: 0.875rem;">Page 1 of 0</span>
                        </div>
                        <div style="display: flex; gap: 0.25rem;">
                            <button disabled style="background: transparent; border: 1px solid #d1d5db; color: #9ca3af; padding: 0.5rem; border-radius: 4px; cursor: not-allowed;">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button disabled style="background: transparent; border: 1px solid #d1d5db; color: #9ca3af; padding: 0.5rem; border-radius: 4px; cursor: not-allowed;">
                                <i class="fas fa-angle-left"></i>
                            </button>
                            <button disabled style="background: transparent; border: 1px solid #d1d5db; color: #9ca3af; padding: 0.5rem; border-radius: 4px; cursor: not-allowed;">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button disabled style="background: transparent; border: 1px solid #d1d5db; color: #9ca3af; padding: 0.5rem; border-radius: 4px; cursor: not-allowed;">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            </main>
    </div>

    <!-- ä¸Šå‚³æ–‡ä»¶æ¨¡æ…‹æ¡† -->
    <div id="upload-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ä¸Šå‚³æ–‡ä»¶</h2>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="file-drop-area">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡</h3>
                    <p>æ”¯æ´ PDF, PNG, JPG æ ¼å¼</p>
                    <input type="file" id="file-input" multiple accept=".pdf,.png,.jpg,.jpeg" style="display: none;">
                    <button class="upload-file-btn" onclick="document.getElementById('file-input').click()">é¸æ“‡æ–‡ä»¶</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // âœ… ç°¡åŒ–ï¼šç›´æ¥ä½¿ç”¨ SimpleAuth
        function checkLoginStatus() {
            return window.simpleAuth && window.simpleAuth.isLoggedIn();
        }

        // æ–‡æª”é¡å‹é…ç½®
        const documentTypes = {
            'bank-statement': {
                titleKey: 'bank_statement_processor',
                subtitleKey: 'manage_view_documents',
                title: 'éŠ€è¡Œå°å¸³å–®è™•ç†å™¨',
                subtitle: 'ç®¡ç†å’ŒæŸ¥çœ‹æ‚¨çš„æ–‡æª”',
                icon: 'fas fa-university'
            }
        };

        // è¨‚é–±æ–¹æ¡ˆé…ç½®
        const subscriptionPlans = {
            'free': {
                name: 'Free',
                color: '#6b7280',
                features: ['åŸºç¤æ–‡æª”è™•ç†', 'æ¯æœˆ10å€‹æ–‡æª”']
            },
            'basic': {
                name: 'Basic',
                color: '#10b981',
                features: ['é€²éšæ–‡æª”è™•ç†', 'æ¯æœˆ100å€‹æ–‡æª”']
            },
            'professional': {
                name: 'Professional',
                color: '#3b82f6',
                features: ['AIæ™ºèƒ½è™•ç†', 'ç„¡é™æ–‡æª”', 'å„ªå…ˆæ”¯æ´']
            },
            'business': {
                name: 'Business',
                color: '#8b5cf6',
                features: ['ä¼æ¥­ç´šåŠŸèƒ½', 'åœ˜éšŠå”ä½œ', 'APIå­˜å–']
            }
        };

        // ========== ğŸ”§ å…¨å±€å‡½æ•¸å ä½ç¬¦å·²åœ¨ç¬¬ 1338 è¡Œå®šç¾© ==========
        // ä¸éœ€è¦é‡è¤‡å®šç¾©
        
        // é é¢åˆå§‹åŒ–
        // ç«‹å³åŸ·è¡Œï¼šç¢ºä¿é é¢å¯è¦‹
        (function() {
            console.log('ğŸš€ ç«‹å³åˆå§‹åŒ–é é¢...');
            
            // ç¢ºä¿bodyå¯è¦‹
            document.body.style.display = 'block';
            document.body.style.visibility = 'visible';
            
            // ç¢ºä¿dashboardå®¹å™¨å¯è¦‹
            const dashboardContainer = document.querySelector('.dashboard-container');
            if (dashboardContainer) {
                dashboardContainer.style.display = 'flex';
                dashboardContainer.style.visibility = 'visible';
            }
            
            // ç¢ºä¿å´é‚Šæ¬„å¯è¦‹
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
            }
            
            // ç¢ºä¿ä¸»å…§å®¹å¯è¦‹
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.style.display = 'block';
                mainContent.style.visibility = 'visible';
            }
            
            console.log('âœ… é é¢ç«‹å³åˆå§‹åŒ–å®Œæˆ');
        })();

        // ç²å–ç•¶å‰é …ç›® ID
        function getCurrentProjectId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('project');
        }

        // ç²å–ç•¶å‰é …ç›®ä¿¡æ¯
        async function getCurrentProject() {
            const projectId = getCurrentProjectId();
            if (!projectId) return null;
            
            // ğŸ”¥ å„ªå…ˆå¾ Firebase ç²å–
            const dataManager = window.simpleDataManager || window.firebaseDataManager;
            if (dataManager && dataManager.initialized) {
                try {
                    const projects = await dataManager.getProjects();
                    return projects.find(p => p.id === projectId);
                } catch (error) {
                    console.error('âŒ å¾ Firebase ç²å–é …ç›®å¤±æ•—:', error);
                }
            }
            
            console.warn('âš ï¸ SimpleDataManager æœªåˆå§‹åŒ–ï¼Œç„¡æ³•ç²å–é …ç›®');
            return null;
        }

        // æ›´æ–°é é¢æ¨™é¡Œç‚ºé …ç›®åç¨±
        async function updateProjectTitle() {
            const project = await getCurrentProject();
            if (project) {
                // æ›´æ–° document-list-view ä¸­çš„æ¨™é¡Œ
                const projectTitle = document.getElementById('project-title');
                if (projectTitle) {
                    projectTitle.textContent = project.name;
                }
                
                // æ›´æ–° team-project-view ä¸­çš„æ¨™é¡Œ
                const teamProjectTitle = document.getElementById('team-project-title');
                if (teamProjectTitle) {
                    teamProjectTitle.textContent = project.name;
                }
                
                console.log('âœ… é …ç›®æ¨™é¡Œå·²æ›´æ–°:', project.name);
            }
        }

        // ç¢ºèªåˆªé™¤é …ç›®
        // åˆ‡æ›é …ç›®åç¨±ç·¨è¼¯æ¨¡å¼
        function toggleProjectNameEdit() {
            const titleElement = document.getElementById('team-project-title');
            const btnElement = document.getElementById('edit-project-name-btn');
            const isEditable = titleElement.getAttribute('contenteditable') === 'true';
            
            if (!isEditable) {
                // é€²å…¥ç·¨è¼¯æ¨¡å¼
                titleElement.setAttribute('contenteditable', 'true');
                titleElement.style.border = '2px solid #3b82f6';
                titleElement.style.background = '#f0f9ff';
                titleElement.focus();
                
                // é¸ä¸­æ–‡å­—
                const range = document.createRange();
                range.selectNodeContents(titleElement);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // æ›´æ”¹æŒ‰éˆ•åœ–æ¨™ç‚ºä¿å­˜
                btnElement.innerHTML = '<i class="fas fa-check" style="font-size: 1.25rem; color: #10b981;"></i>';
                btnElement.title = 'ä¿å­˜é …ç›®åç¨±';
            } else {
                // ä¿å­˜ä¸¦é€€å‡ºç·¨è¼¯æ¨¡å¼
                saveProjectName();
            }
        }
        
        // ç¢ºä¿å‡½æ•¸å…¨å±€å¯ç”¨
        window.toggleProjectNameEdit = toggleProjectNameEdit;
        
        // ä¿å­˜é …ç›®åç¨±
        async function saveProjectName() {
            const titleElement = document.getElementById('team-project-title');
            const btnElement = document.getElementById('edit-project-name-btn');
            const newName = titleElement.textContent.trim();
            
            if (!newName) {
                alert('é …ç›®åç¨±ä¸èƒ½ç‚ºç©º');
                return;
            }
            
            const project = await getCurrentProject();
            if (!project) {
                alert('ç„¡æ³•æ‰¾åˆ°ç•¶å‰é …ç›®');
                return;
            }
            
            try {
                // ğŸ”¥ å„ªå…ˆä¿å­˜åˆ° Firebase
                const dataManager = window.simpleDataManager || window.firebaseDataManager;
                if (dataManager && dataManager.initialized) {
                    await dataManager.updateProject(project.id, { name: newName });
                    console.log('âœ… é …ç›®åç¨±å·²ä¿å­˜åˆ° Firebase');
                    
                    // æ›´æ–°å´é‚Šæ¬„
                    if (window.dashboardSidebar) {
                        await window.dashboardSidebar.render();
                    }
                    
                    console.log('âœ… é …ç›®åç¨±å·²æ›´æ–°:', newName);
                } else {
                    throw new Error('SimpleDataManager æœªåˆå§‹åŒ–');
                }
                
            } catch (error) {
                console.error('âŒ ä¿å­˜é …ç›®åç¨±å¤±æ•—:', error);
                alert('ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
            
            // é€€å‡ºç·¨è¼¯æ¨¡å¼
            titleElement.setAttribute('contenteditable', 'false');
            titleElement.style.border = '2px solid transparent';
            titleElement.style.background = 'transparent';
            
            // æ¢å¾©æŒ‰éˆ•åœ–æ¨™
            btnElement.innerHTML = '<i class="fas fa-pen" style="font-size: 1.25rem;"></i>';
            btnElement.title = 'ç·¨è¼¯é …ç›®åç¨±';
        }
        
        // âœ… confirmDeleteProject å·²åœ¨ç¬¬ 1391-1419 è¡Œå®šç¾©
        // é€™è£¡ä¸å†é‡è¤‡å®šç¾©ï¼Œé¿å…è¡çª

        // åˆªé™¤é …ç›®
        async function deleteProject(projectId) {
            try {
                // ğŸ”¥ å„ªå…ˆå¾ Firebase åˆªé™¤
                const dataManager = window.simpleDataManager || window.firebaseDataManager;
                if (dataManager && dataManager.initialized) {
                    await dataManager.deleteProject(projectId);
                    console.log('âœ… é …ç›®å·²å¾ Firebase åˆªé™¤');
                    
                    // è§¸ç™¼é …ç›®åˆªé™¤äº‹ä»¶ï¼Œè®“å´é‚Šæ¬„æ›´æ–°
                    window.dispatchEvent(new CustomEvent('projectDeleted', { 
                        detail: { projectId } 
                    }));
                    
                    console.log('âœ… é …ç›®å·²åˆªé™¤:', projectId);
                    
                    // è¿”å›åˆ° dashboard
                    window.location.href = 'dashboard.html';
                } else {
                    throw new Error('SimpleDataManager æœªåˆå§‹åŒ–');
                }
            } catch (error) {
                console.error('âŒ åˆªé™¤é …ç›®å¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ Dashboard é é¢è¼‰å…¥ä¸­...');
            
            // ========== ğŸ¤– åˆå§‹åŒ– DeepSeek Vision Client ==========
            console.log('ğŸ¤– åˆå§‹åŒ– DeepSeek Vision Client...');
            console.log('   window.DeepSeekVisionClient:', typeof window.DeepSeekVisionClient);
            
            if (typeof window.DeepSeekVisionClient === 'function') {
                try {
                    // âœ… ä½¿ç”¨ Cloudflare Worker URLï¼ˆAPI Key å·²å®‰å…¨å­˜å„²åœ¨ Worker ä¸­ï¼‰
                    const deepseekWorkerUrl = 'https://deepseek-proxy.vaultcaddy.workers.dev';
                    
                    const deepseekClient = new window.DeepSeekVisionClient(deepseekWorkerUrl);
                    window.deepseekVisionClient = deepseekClient;
                    console.log('âœ… DeepSeek Vision Client å·²åˆå§‹åŒ–');
                    console.log('   Worker URL:', deepseekClient.workerUrl);
                    console.log('   Model:', deepseekClient.model);
                    console.log('   Client å¯¦ä¾‹:', deepseekClient);
                } catch (error) {
                    console.error('âŒ DeepSeek Vision Client åˆå§‹åŒ–å¤±æ•—:', error);
                }
            } else {
                console.error('âŒ DeepSeekVisionClient é¡åˆ¥æœªæ‰¾åˆ°ï¼Œè«‹ç¢ºä¿ deepseek-vision-client.js å·²è¼‰å…¥');
            }
            
            // ========== ğŸ¤– åˆå§‹åŒ– OpenAI Vision Clientï¼ˆå‚™ç”¨ï¼‰ ==========
            console.log('ğŸ¤– åˆå§‹åŒ– OpenAI Vision Clientï¼ˆå‚™ç”¨ï¼‰...');
            console.log('   window.OpenAIVisionClient:', typeof window.OpenAIVisionClient);
            
            if (typeof window.OpenAIVisionClient === 'function') {
                try {
                    // âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ OpenAI API Key
                    const openaiApiKey = 'YOUR_OPENAI_API_KEY_HERE'; // âš ï¸ è«‹æ›¿æ›ç‚ºä½ çš„ API Key
                    
                    if (openaiApiKey === 'YOUR_OPENAI_API_KEY_HERE') {
                        console.warn('âš ï¸ OpenAI API Key å°šæœªè¨­ç½®ï¼Œè«‹åœ¨ firstproject.html ä¸­å¡«å…¥ä½ çš„ API Key');
                    } else {
                        const openaiClient = new window.OpenAIVisionClient(openaiApiKey);
                        window.openaiVisionClient = openaiClient;
                        console.log('âœ… OpenAI Vision Client å·²åˆå§‹åŒ–');
                        console.log('   Model:', openaiClient.model);
                        console.log('   Client å¯¦ä¾‹:', openaiClient);
                    }
                } catch (error) {
                    console.error('âŒ OpenAI Vision Client åˆå§‹åŒ–å¤±æ•—:', error);
                }
            } else {
                console.error('âŒ OpenAIVisionClient é¡åˆ¥æœªæ‰¾åˆ°ï¼Œè«‹ç¢ºä¿ openai-vision-client.js å·²è¼‰å…¥');
            }
            
            // ========== ğŸ¤– åˆå§‹åŒ– Gemini Worker Clientï¼ˆå‚™ç”¨ï¼‰ ==========
            console.log('ğŸ¤– åˆå§‹åŒ– Gemini Worker Clientï¼ˆå‚™ç”¨ï¼‰...');
            console.log('   window.GeminiWorkerClient:', typeof window.GeminiWorkerClient);
            
            if (typeof window.GeminiWorkerClient === 'function') {
                try {
                    // âœ… åªå‚³å…¥ Worker åŸºç¤ URLï¼Œä¸è¦åŒ…å« API è·¯å¾‘
                    const geminiClient = new window.GeminiWorkerClient(
                        'https://gemini-proxy.vaultcaddy.workers.dev'
                    );
                    window.geminiWorkerClient = geminiClient;
                    console.log('âœ… Gemini Worker Client å·²åˆå§‹åŒ–');
                    console.log('   Worker URL:', geminiClient.workerUrl);
                    console.log('   Client å¯¦ä¾‹:', geminiClient);
                } catch (error) {
                    console.error('âŒ Gemini Worker Client åˆå§‹åŒ–å¤±æ•—:', error);
                }
            } else {
                console.error('âŒ GeminiWorkerClient é¡åˆ¥æœªæ‰¾åˆ°ï¼Œè«‹ç¢ºä¿ gemini-worker-client.js å·²è¼‰å…¥');
                console.error('   window.GeminiWorkerClient é¡å‹:', typeof window.GeminiWorkerClient);
                console.error('   å¯ç”¨çš„ window å±¬æ€§:', Object.keys(window).filter(k => k.toLowerCase().includes('gemini')));
            }
            
            // ========== ğŸ” èº«ä»½é©—è­‰æª¢æŸ¥ï¼ˆç”± SimpleAuth è™•ç†ï¼‰ ==========
            // SimpleAuth å·²ç¶“åœ¨ simple-auth.js ä¸­è™•ç†é é¢ä¿è­·
            // å¦‚æœç”¨æˆ¶æœªç™»å…¥ï¼ŒSimpleAuth æœƒè‡ªå‹•é‡å®šå‘åˆ° index.html
            console.log('ğŸ” èº«ä»½é©—è­‰ç”± SimpleAuth è™•ç†');
            
            // æª¢æŸ¥æ¨¡æ…‹æ¡†æ˜¯å¦å­˜åœ¨
            const modalCheck = document.getElementById('aiUploadModal');
            console.log('ğŸ” DOMContentLoaded æ™‚æ¨¡æ…‹æ¡†æª¢æŸ¥:', modalCheck ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
            if (modalCheck) {
                console.log('ğŸ“‹ æ¨¡æ…‹æ¡†è©³æƒ…:', {
                    id: modalCheck.id,
                    display: modalCheck.style.display,
                    ä½ç½®: modalCheck.getBoundingClientRect()
                });
            } else {
                console.error('âŒ åš´é‡éŒ¯èª¤ï¼šæ¨¡æ…‹æ¡†åœ¨ DOMContentLoaded å¾Œä»ä¸å­˜åœ¨');
                console.error('ğŸ“Š DOM çµ±è¨ˆ:', {
                    ç¸½å…ƒç´ æ•¸: document.getElementsByTagName('*').length,
                    bodyå­˜åœ¨: !!document.body,
                    æ‰€æœ‰divæ•¸é‡: document.getElementsByTagName('div').length
                });
            }
            
            // âœ… æ¥µç°¡åˆå§‹åŒ–ï¼šç­‰å¾… SimpleDataManager å°±ç·’
            console.log('ğŸ¨ ç«‹å³å‰µå»ºå´é‚Šæ¬„');
            window.unifiedSidebar = new VaultCaddySidebar();
            
            // å®šç¾©æ›´æ–°å‡½æ•¸
            const updateContent = async () => {
                console.log('ğŸ“Š æ›´æ–°å…§å®¹ï¼šå´é‚Šæ¬„ + é …ç›®æ¨™é¡Œ');
                if (window.unifiedSidebar) {
                    await window.unifiedSidebar.render();
                }
                await updateProjectTitle();
            };
            
            // ç›£è½ SimpleDataManager åˆå§‹åŒ–å®Œæˆ
            const checkDataManager = setInterval(async () => {
                if (window.simpleDataManager && window.simpleDataManager.initialized) {
                    clearInterval(checkDataManager);
                    console.log('âœ… SimpleDataManager å·²å°±ç·’');
                    await updateContent();
                }
            }, 100);
            
            // è¶…æ™‚ä¿è­·ï¼ˆ5ç§’ï¼‰
            setTimeout(() => {
                clearInterval(checkDataManager);
            }, 5000);
            
            // åˆå§‹åŒ–ç”¨æˆ¶åœ˜éšŠä¿¡æ¯
            initializeUserTeamInfo();
            
            // è™•ç† hash è·¯ç”±
            handleHashRouting();
            
            // ç¢ºä¿é é¢å…§å®¹å¯è¦‹
            ensurePageContentVisible();
            
            // ç›£è½ hash è®ŠåŒ–
            window.addEventListener('hashchange', handleHashRouting);
            
            // ç›£è½èªè¨€è®Šæ›´äº‹ä»¶
            window.addEventListener('languageChanged', function(e) {
                console.log('Dashboard: èªè¨€å·²è®Šæ›´ç‚º', e.detail.language);
                // èªè¨€è®Šæ›´æ™‚é‡æ–°æ‡‰ç”¨ç•¶å‰æ–‡æª”é¡å‹çš„ç¿»è­¯
                const hash = window.location.hash.substring(1);
                const docType = hash || 'bank-statement';
                if (documentTypes[docType]) {
                    updatePageForDocumentType(docType);
                }
                // æ³¨æ„ï¼šå´é‚Šæ¬„çš„èªè¨€æ›´æ–°ç”± VaultCaddySidebar çš„ setupLanguageListener è™•ç†
            });
            
            console.log('âœ… Unified Dashboard åˆå§‹åŒ–å®Œæˆ');
        });

        // åˆå§‹åŒ–ç”¨æˆ¶åœ˜éšŠä¿¡æ¯
        function initializeUserTeamInfo() {
            console.log('ğŸ‘¥ åˆå§‹åŒ–ç”¨æˆ¶åœ˜éšŠä¿¡æ¯...');
            
            // ç²å–ç”¨æˆ¶åç¨±
            let userName = '1æ‰­æ‰­æ‰¹'; // é»˜èªåç¨±
            
            if (window.GlobalAuthSync) {
                const authState = window.GlobalAuthSync.getCurrentAuthState();
                if (authState.userName && !authState.userName.includes('{"uid"')) {
                    userName = authState.userName;
                }
            } else {
                // å¾localStorageç²å–
                const storedName = localStorage.getItem('google_user_name') || localStorage.getItem('user_name');
                if (storedName && !storedName.includes('{"uid"')) {
                    userName = storedName;
                }
            }
            
            // ç”Ÿæˆåœ˜éšŠåç¨±
            const teamName = `${userName}'s team`;
            
            // æ›´æ–°åœ˜éšŠåç¨±é¡¯ç¤º
            const teamNameElement = document.getElementById('team-name');
            if (teamNameElement) {
                teamNameElement.textContent = teamName;
                console.log('âœ… åœ˜éšŠåç¨±å·²æ›´æ–°:', teamName);
            }
            
            // ç²å–ä¸¦è¨­ç½®è¨‚é–±æ–¹æ¡ˆ
            let subscriptionPlan = 'free'; // é»˜èªç‚ºå…è²»ç‰ˆ
            
            if (window.GlobalAuthSync) {
                const authState = window.GlobalAuthSync.getCurrentAuthState();
                subscriptionPlan = authState.subscriptionPlan || 'free';
            } else {
                subscriptionPlan = localStorage.getItem('vaultcaddy_subscription') || 'free';
            }
            
            // æ›´æ–°è¨‚é–±æ–¹æ¡ˆé¡¯ç¤º
            updateSubscriptionBadge(subscriptionPlan);
            
            console.log('âœ… ç”¨æˆ¶åœ˜éšŠä¿¡æ¯åˆå§‹åŒ–å®Œæˆ:', { teamName, subscriptionPlan });
        }
        
        // æ›´æ–°è¨‚é–±æ–¹æ¡ˆæ¨™ç±¤
        function updateSubscriptionBadge(planKey) {
            const badgeElement = document.getElementById('subscription-badge');
            if (!badgeElement) return;
            
            const plan = subscriptionPlans[planKey];
            if (plan) {
                badgeElement.textContent = plan.name;
                badgeElement.style.background = plan.color;
                console.log('âœ… è¨‚é–±æ–¹æ¡ˆå·²æ›´æ–°:', plan.name);
            }
        }
        
        // å‰µå»ºæ–°é …ç›®
        function createNewProject() {
            console.log('ğŸ“ å‰µå»ºæ–°é …ç›®...');
            // é€™è£¡å¯ä»¥å¯¦ç¾å‰µå»ºæ–°é …ç›®çš„é‚è¼¯
            alert('å‰µå»ºæ–°é …ç›®åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...');
        }

        // è™•ç† hash è·¯ç”±
        function handleHashRouting() {
            console.log('ğŸ”„ handleHashRouting è¢«èª¿ç”¨');
            console.log('ğŸ“ ç•¶å‰ URL:', window.location.href);
            console.log('ğŸ“ Hash:', window.location.hash);
            
            const hash = window.location.hash.substring(1); // ç§»é™¤ #
            const docType = hash || 'bank-statement'; // é»˜èªç‚ºéŠ€è¡Œå°å¸³å–®
            
            console.log('ğŸ“ è§£æçµæœ:', { hash, docType });
            console.log('ğŸ“ documentTypes:', documentTypes);
            console.log('ğŸ“ documentTypes[docType]:', documentTypes[docType]);
            
            if (documentTypes[docType]) {
                console.log('âœ… æ‰¾åˆ°æ–‡æª”é¡å‹ï¼Œèª¿ç”¨ updatePageForDocumentType');
                updatePageForDocumentType(docType);
            } else {
                console.error('âŒ documentTypes ä¸­æ‰¾ä¸åˆ°:', docType);
            }
        }

        // æ›´æ–°é é¢ç‚ºæŒ‡å®šæ–‡æª”é¡å‹
        function updatePageForDocumentType(docType) {
            const config = documentTypes[docType];
            
            // ç¢ºä¿é¡¯ç¤ºæ–‡æª”åˆ—è¡¨è¦–åœ–ï¼Œéš±è—è©³ç´°è¦–åœ–
            const listView = document.getElementById('document-list-view');
            const detailView = document.getElementById('document-detail-view');
            
            if (listView && detailView) {
                listView.style.display = 'block';
                detailView.style.display = 'none';
            }
            
            // æ›´æ–°é é¢æ¨™é¡Œ - æ”¯æŒå¤šèªè¨€
            const titleElement = document.getElementById('page-title');
            const subtitleElement = document.getElementById('page-subtitle');
            
            if (titleElement) {
                titleElement.textContent = config.title;
                titleElement.setAttribute('data-translate', config.titleKey);
            }
            if (subtitleElement) {
                subtitleElement.textContent = config.subtitle;
                subtitleElement.setAttribute('data-translate', config.subtitleKey);
            }
            
            // æ›´æ–°ç€è¦½å™¨æ¨™é¡Œ
            document.title = `${config.title} - VaultCaddy`;
            
            // æ›´æ–°å´é‚Šæ¬„æ´»èºç‹€æ…‹
            if (window.unifiedSidebar) {
                window.unifiedSidebar.updateActivePage(docType);
            }
            
            // è¼‰å…¥è©²æ–‡æª”é¡å‹çš„æ–‡ä»¶
            loadFilesForDocumentType(docType);
            
            // å¦‚æœèªè¨€ç®¡ç†å™¨å­˜åœ¨ï¼Œé‡æ–°æ‡‰ç”¨ç¿»è­¯
            if (window.languageManager) {
                window.languageManager.loadLanguage(window.languageManager.currentLanguage);
            }
            
            console.log('âœ… æ›´æ–°é é¢é¡å‹:', docType, config.title);
        }
        
        // è¼‰å…¥æŒ‡å®šæ–‡æª”é¡å‹çš„æ–‡ä»¶å¤¾
        function loadFilesForDocumentType(docType) {
            const documentsTable = document.querySelector('#team-project-view table');
            const documentsTbody = document.getElementById('team-project-tbody');
            const emptyState = document.querySelector('#team-project-tbody tr td[colspan="9"]')?.parentElement;
            
            if (!documentsTable || !documentsTbody) {
                console.error('æ‰¾ä¸åˆ°æ–‡æª”è¡¨æ ¼å®¹å™¨');
                return;
            }
            
            // æ¸…ç©ºç¾æœ‰å…§å®¹
            documentsTbody.innerHTML = '';
            
            // ç²å–ç•¶å‰é …ç›® ID
            const projectId = getCurrentProjectId();
            if (!projectId) {
                console.warn('âš ï¸ ç„¡æ³•ç²å–é …ç›® IDï¼Œç„¡æ³•è¼‰å…¥æ–‡ä»¶');
                // è¡¨æ ¼å§‹çµ‚é¡¯ç¤º
                documentsTable.style.display = 'table';
                if (emptyState) emptyState.style.display = 'block';
                updatePaginationInfo(0);
                return;
            }
            
            // å¾ç•¶å‰é …ç›®çš„å­˜å„²è¼‰å…¥æ–‡ä»¶
            let storedFiles = [];
            const projectStorageKey = `vaultcaddy_project_${projectId}_documents`;
            
            console.log(`ğŸ“‚ å¾é …ç›® ${projectId} è¼‰å…¥æ–‡ä»¶`);
            const projectDocuments = JSON.parse(localStorage.getItem(projectStorageKey) || '[]');
            
            // è½‰æ›ç‚ºé¡¯ç¤ºæ ¼å¼ï¼ˆä¿ç•™æ‰€æœ‰åŸå§‹æ•¸æ“šï¼‰
            storedFiles = projectDocuments.map(doc => ({
                id: doc.id,
                name: doc.fileName || doc.name || 'æœªå‘½åæ–‡ä»¶',
                size: doc.fileSize || doc.size || 0,
                documentType: doc.documentType || docType,
                uploadDate: doc.createdAt,
                createdAt: doc.createdAt,
                isProcessing: doc.isProcessing || false,
                processingProgress: doc.processingProgress || 0,
                status: doc.status || 'completed',
                // ä¿ç•™æ‰€æœ‰åŸå§‹æ•¸æ“šä½œç‚º processedData
                processedData: doc,
                // åŒæ™‚ä¹Ÿåœ¨é ‚å±¤æš´éœ²é—œéµå­—æ®µä»¥ä¾¿è¨ªå•
                ...doc
            }));
            
            console.log(`ğŸ“ é …ç›® ${projectId} è¼‰å…¥æ–‡ä»¶:`, storedFiles.length, 'å€‹æ–‡ä»¶');
            console.log('ğŸ“„ æ–‡ä»¶è©³æƒ…:', storedFiles);
            
            // è¡¨æ ¼å§‹çµ‚é¡¯ç¤º
            documentsTable.style.display = 'table';
            
            // å¦‚æœæ²’æœ‰æ–‡ä»¶ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
            if (storedFiles.length === 0) {
                console.log('âš ï¸ æ²’æœ‰æ–‡ä»¶ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹');
                if (emptyState) emptyState.style.display = 'block';
                updatePaginationInfo(0);
                return;
            }
            
            // éš±è—ç©ºç‹€æ…‹
            if (emptyState) emptyState.style.display = 'none';
            
            console.log('âœ… é–‹å§‹å‰µå»ºè¡¨æ ¼è¡Œ...');
            // å‰µå»ºè¡¨æ ¼è¡Œ
            storedFiles.forEach((file, index) => {
                try {
                    console.log(`ğŸ“ å‰µå»ºç¬¬ ${index + 1} è¡Œ:`, {
                        name: file.name,
                        fileName: file.fileName,
                        accountHolder: file.accountHolder,
                        accountNumber: file.accountNumber,
                        isProcessing: file.isProcessing,
                        status: file.status
                    });
                    createDocumentRow(documentsTbody, file);
                    console.log(`âœ… ç¬¬ ${index + 1} è¡Œå‰µå»ºæˆåŠŸ`);
                } catch (error) {
                    console.error(`âŒ å‰µå»ºç¬¬ ${index + 1} è¡Œæ™‚å‡ºéŒ¯:`, error);
                    console.error(`âŒ æ–‡ä»¶æ•¸æ“š:`, file);
                }
            });
            console.log('âœ… è¡¨æ ¼è¡Œå‰µå»ºå®Œæˆ');
            
            // æ›´æ–°çµ±è¨ˆä¿¡æ¯å’Œåˆ†é 
            updateDocumentStats();
            updatePaginationInfo(storedFiles.length);
        }
        
        // å‰µå»ºç©ºæ–‡ä»¶å¤¾
        function createEmptyFolder(container, docType) {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';
            folderItem.innerHTML = `
                <div class="folder-icon">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="folder-name">${documentTypes[docType]?.title || docType}</div>
                <div class="folder-files-count">0 files</div>
                <div class="folder-updated">å‰›å‰›å‰µå»º</div>
            `;
            folderItem.onclick = () => {
                console.log('ğŸ“ é»æ“Šç©ºæ–‡ä»¶å¤¾:', docType);
                // å¯ä»¥å¯¦ç¾æ‰“é–‹æ–‡ä»¶å¤¾æˆ–ä¸Šå‚³æ–‡ä»¶çš„é‚è¼¯
            };
            container.appendChild(folderItem);
        }
        
        // å°‡æ–‡ä»¶åˆ†çµ„åˆ°æ–‡ä»¶å¤¾ä¸­
        function groupFilesIntoFolders(files, docType) {
            const folders = [];
            
            // æŒ‰æœˆä»½åˆ†çµ„
            const groupedByMonth = {};
            files.forEach(file => {
                const date = new Date(file.uploadDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!groupedByMonth[monthKey]) {
                    groupedByMonth[monthKey] = [];
                }
                groupedByMonth[monthKey].push(file);
            });
            
            // å‰µå»ºæ–‡ä»¶å¤¾
            Object.keys(groupedByMonth).forEach(monthKey => {
                const filesInMonth = groupedByMonth[monthKey];
                const date = new Date(monthKey + '-01');
                
                folders.push({
                    id: `folder_${monthKey}`,
                    name: `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`,
                    filesCount: filesInMonth.length,
                    files: filesInMonth,
                    updated: filesInMonth[0].uploadDate,
                    type: docType
                });
            });
            
            // å¦‚æœæ²’æœ‰æ–‡ä»¶ï¼Œå‰µå»ºä¸€å€‹ç©ºæ–‡ä»¶å¤¾
            if (folders.length === 0) {
                folders.push({
                    id: `folder_empty_${docType}`,
                    name: documentTypes[docType]?.title || docType,
                    filesCount: 0,
                    files: [],
                    updated: 'å‰›å‰›å‰µå»º',
                    type: docType
                });
            }
            
            return folders;
        }
        
        // å‰µå»ºæ–‡ä»¶å¤¾é …ç›®
        function createFolderItem(container, folder) {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';
            folderItem.innerHTML = `
                <div class="folder-icon">
                    <i class="fas fa-folder${folder.filesCount > 0 ? '-open' : ''}"></i>
                </div>
                <div class="folder-name">${folder.name}</div>
                <div class="folder-files-count">${folder.filesCount} files</div>
                <div class="folder-updated">${folder.updated}</div>
            `;
            folderItem.onclick = () => {
                console.log('ğŸ“ é»æ“Šæ–‡ä»¶å¤¾:', folder.name, folder.filesCount, 'å€‹æ–‡ä»¶');
                openFolder(folder);
            };
            container.appendChild(folderItem);
        }
        
        // æ‰“é–‹æ–‡ä»¶å¤¾
        function openFolder(folder) {
            console.log('ğŸ“‚ æ‰“é–‹æ–‡ä»¶å¤¾:', folder);
            if (folder.filesCount === 0) {
                alert('æ–‡ä»¶å¤¾ç‚ºç©ºï¼Œè«‹å…ˆä¸Šå‚³æ–‡ä»¶');
                return;
            }
            
            // é€™è£¡å¯ä»¥å¯¦ç¾æ‰“é–‹æ–‡ä»¶å¤¾çš„é‚è¼¯
            // ä¾‹å¦‚é¡¯ç¤ºæ–‡ä»¶å¤¾å…§å®¹æˆ–è·³è½‰åˆ°æ–‡ä»¶åˆ—è¡¨
            alert(`æ‰“é–‹æ–‡ä»¶å¤¾: ${folder.name} (${folder.filesCount} å€‹æ–‡ä»¶)`);
        }

        // æ‰“é–‹æ–‡æª”è©³ç´°è¦–åœ–
        function openDocumentDetail(documentId) {
            document.getElementById('document-list-view').style.display = 'none';
            document.getElementById('document-detail-view').style.display = 'block';
            
            // å„ªå…ˆä½¿ç”¨LedgerBoxè™•ç†å™¨çš„æ•¸æ“š
            if (window.ledgerBoxProcessor) {
                window.ledgerBoxProcessor.openDocumentDetail(documentId);
                return;
            }
            
            // å…œåº•ï¼šå¾localStorageç²å–æ–‡ä»¶ä¿¡æ¯
            const fileInfo = getFileInfoById(documentId);
            
            if (fileInfo) {
                // æ›´æ–°æ–‡æª”æ¨™é¡Œç‚ºå¯¦éš›æ–‡ä»¶å
                document.getElementById('document-title').textContent = fileInfo.name;
                
                // æ›´æ–°PDFé è¦½å€åŸŸ
                updatePDFPreview(fileInfo);
                
                console.log('ğŸ“„ æ‰“é–‹æ–‡æª”è©³ç´°è¦–åœ–:', fileInfo.name, fileInfo.documentType);
            } else {
                // å…œåº•ï¼šä½¿ç”¨æ–‡æª”ID
                document.getElementById('document-title').textContent = documentId + '.pdf';
                console.warn('âš ï¸ æ‰¾ä¸åˆ°æ–‡æª”ä¿¡æ¯:', documentId);
            }
        }
        
        // æ ¹æ“šæ–‡æª”IDç²å–æ–‡ä»¶ä¿¡æ¯
        function getFileInfoById(documentId) {
            // æª¢æŸ¥æ‰€æœ‰æ–‡æª”é¡å‹çš„å­˜å„²
            const docTypes = ['bank-statement', 'general'];
            
            for (const docType of docTypes) {
                const storageKey = `vaultcaddy_files_${docType}`;
                const storedFiles = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                const fileInfo = storedFiles.find(file => file.id === documentId);
                if (fileInfo) {
                    return fileInfo;
                }
            }
            
            return null;
        }
        
        // æ›´æ–°PDFé è¦½å€åŸŸ
        function updatePDFPreview(fileInfo) {
            const pdfPlaceholder = document.querySelector('.pdf-placeholder');
            if (pdfPlaceholder) {
                pdfPlaceholder.innerHTML = `
                    <i class="fas fa-file-pdf"></i>
                    <h3>PDF Preview</h3>
                    <p>Document: ${fileInfo.name}</p>
                    <p style="color: #6b7280; font-size: 0.875rem;">Type: ${fileInfo.documentType}</p>
                    <p style="color: #6b7280; font-size: 0.875rem;">Size: ${(fileInfo.size / 1024 / 1024).toFixed(2)} MB</p>
                    <small style="display: block; margin-top: 1rem; color: #9ca3af;">
                        å¯¦éš›æ–‡ä»¶é è¦½åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œç›®å‰é¡¯ç¤ºæ–‡ä»¶ä¿¡æ¯
                    </small>
                `;
            }
        }

        // è¿”å›æ–‡æª”åˆ—è¡¨
        function backToDocumentList() {
            document.getElementById('document-detail-view').style.display = 'none';
            document.getElementById('document-list-view').style.display = 'block';
            
            // æ¸…é™¤ç•¶å‰æ–‡æª”
            if (window.ledgerBoxProcessor) {
                window.ledgerBoxProcessor.currentDocument = null;
            }
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•¸
        function showHelp() {
            alert('Document processing help will be shown here.');
        }

        // âœ… openUploadModal å’Œ closeAIUploadModal å·²åœ¨ç¬¬ 1343-1388 è¡Œå®šç¾©
        // é€™è£¡ä¸å†é‡è¤‡å®šç¾©ï¼Œé¿å…è¡çª
        
        // AI ä¸Šå‚³è™•ç†å™¨
        let aiCurrentFile = null;
        let aiIsProcessing = false;
        let aiProcessingResults = {};
        let selectedDocumentType = 'bank_statement'; // é»˜èªé¸æ“‡éŠ€è¡Œå°å¸³å–®
        
        function initializeAIUpload() {
            console.log('');
            console.log('========================================');
            console.log('ğŸ¬ initializeAIUpload è¢«èª¿ç”¨');
            console.log('   èª¿ç”¨æ™‚é–“:', new Date().toISOString());
            console.log('========================================');
            
            const uploadArea = document.getElementById('aiUploadArea');
            const fileInput = document.getElementById('aiFileInput');
            
            console.log('   uploadArea å…ƒç´ :', uploadArea ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°');
            console.log('   fileInput å…ƒç´ :', fileInput ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°');
            
            if (!uploadArea || !fileInput) {
                console.error('âŒ é—œéµå…ƒç´ ç¼ºå¤±ï¼Œç„¡æ³•åˆå§‹åŒ–ä¸Šå‚³');
                return;
            }
            
            // åˆå§‹åŒ–é»˜èªé¸æ“‡ï¼ˆBank statementsï¼‰
            console.log('ğŸ”§ è¨­ç½®é»˜èªæ–‡æª”é¡å‹...');
            selectDocumentType('bank_statement');
            
            // é»æ“Šä¸Šå‚³å€åŸŸè§¸ç™¼æ–‡ä»¶é¸æ“‡
            uploadArea.onclick = () => {
                console.log('');
                console.log('========================================');
                console.log('ğŸ–±ï¸ ä¸Šå‚³å€åŸŸè¢«é»æ“Š');
                console.log('   æ™‚é–“:', new Date().toISOString());
                console.log('========================================');
                fileInput.click();
            };
            
            // æ–‡ä»¶é¸æ“‡äº‹ä»¶ï¼ˆæ”¯æŒæ‰¹é‡ä¸Šå‚³ï¼‰
            fileInput.onchange = (e) => {
                console.log('');
                console.log('========================================');
                console.log('ğŸ“ fileInput.onchange äº‹ä»¶è§¸ç™¼');
                console.log('   æ™‚é–“:', new Date().toISOString());
                const files = Array.from(e.target.files);
                console.log('   é¸æ“‡çš„æ–‡ä»¶æ•¸é‡:', files.length);
                
                if (files.length > 0) {
                    if (files.length === 1) {
                        // å–®æ–‡ä»¶ä¸Šå‚³
                        console.log('   æ–‡ä»¶å:', files[0].name);
                        console.log('   æ–‡ä»¶å¤§å°:', files[0].size, 'bytes');
                        console.log('   æ–‡ä»¶é¡å‹:', files[0].type);
                        console.log('ğŸ”œ å³å°‡èª¿ç”¨ handleAIFileUpload...');
                        console.log('========================================');
                        handleAIFileUpload(files[0]);
                    } else {
                        // æ‰¹é‡ä¸Šå‚³
                        console.log('   ğŸ“¦ æ‰¹é‡ä¸Šå‚³æ¨¡å¼');
                        console.log('   æ–‡ä»¶åˆ—è¡¨:', files.map(f => f.name).join(', '));
                        console.log('ğŸ”œ å³å°‡èª¿ç”¨ handleBatchFileUpload...');
                        console.log('========================================');
                        handleBatchFileUpload(files);
                    }
                } else {
                    console.log('   âš ï¸ æ²’æœ‰é¸æ“‡æ–‡ä»¶');
                    console.log('========================================');
                }
            };
            
            console.log('âœ… AI ä¸Šå‚³åˆå§‹åŒ–å®Œæˆ');
            console.log('   uploadArea.onclick å·²ç¶å®š:', typeof uploadArea.onclick === 'function');
            console.log('   fileInput.onchange å·²ç¶å®š:', typeof fileInput.onchange === 'function');
            console.log('========================================');
            
            // æ‹–æ”¾äº‹ä»¶
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            };
            
            uploadArea.ondragleave = () => {
                uploadArea.classList.remove('dragover');
            };
            
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    handleAIFileUpload(files[0]);
                }
            };
        }
        
        async function handleAIFileUpload(file) {
            console.log('');
            console.log('========================================');
            console.log('ğŸ”µ handleAIFileUpload è¢«èª¿ç”¨');
            console.log('ğŸ“„ æ–‡ä»¶å:', file.name);
            console.log('ğŸ“ æ–‡ä»¶å¤§å°:', file.size, 'bytes');
            console.log('ğŸ“‹ æ–‡ä»¶é¡å‹:', file.type);
            console.log('========================================');
            
            if (aiIsProcessing) {
                console.log('âš ï¸ æ­£åœ¨è™•ç†ä¸­ï¼Œå¿½ç•¥æ–°ä¸Šå‚³');
                return;
            }
            
            // é©—è­‰æ–‡ä»¶
            console.log('ğŸ” é©—è­‰æ–‡ä»¶...');
            if (!validateAIFile(file)) {
                console.log('âŒ æ–‡ä»¶é©—è­‰å¤±æ•—');
                return;
            }
            console.log('âœ… æ–‡ä»¶é©—è­‰é€šé');
            
            aiCurrentFile = file;
            aiIsProcessing = true;
            
            try {
                console.log('');
                console.log('ğŸ“‚ === é–‹å§‹ç¬¬ä¸€éƒ¨åˆ†ï¼šå‰µå»ºæ–‡ä»¶è¡Œ ===');
                
                // 1. ç«‹å³é—œé–‰æ¨¡æ…‹æ¡†
                console.log('1ï¸âƒ£ é—œé–‰ä¸Šå‚³æ¨¡æ…‹æ¡†...');
                closeAIUploadModal();
                console.log('   âœ… æ¨¡æ…‹æ¡†å·²é—œé–‰');
                
                // 2. ç²å–é …ç›® ID
                console.log('');
                console.log('2ï¸âƒ£ ç²å–ç•¶å‰é …ç›® ID...');
                const projectId = getCurrentProjectId();
                console.log('   é …ç›® ID:', projectId);
                
                if (!projectId) {
                    console.error('   âŒ ç„¡æ³•ç²å–é …ç›® ID');
                    throw new Error('ç„¡æ³•ç¢ºå®šç•¶å‰é …ç›®');
                }
                console.log('   âœ… é …ç›® ID ç²å–æˆåŠŸ');
                
                // 3. å‰µå»ºæ–‡ä»¶è¨˜éŒ„ï¼ˆåªåŒ…å«åŸºæœ¬ä¿¡æ¯ï¼Œä¸æ¶‰åŠ AIï¼‰
                console.log('');
                console.log('3ï¸âƒ£ å‰µå»ºæ–‡ä»¶è¨˜éŒ„...');
                
                const currentDate = new Date();
                const documentId = Date.now().toString();
                
                console.log('   å‰µå»ºæ–‡ä»¶ ID:', documentId);
                console.log('   ç•¶å‰æ™‚é–“:', currentDate.toISOString());
                
                // å°‡æ–‡ä»¶è½‰æ›ç‚º Data URL ä»¥ä¾¿é è¦½
                console.log('   è½‰æ›æ–‡ä»¶ç‚º Data URL...');
                const fileDataURL = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                console.log('   âœ… Data URL è½‰æ›å®Œæˆ');
                
                // å‰µå»ºæ–‡ä»¶è¨˜éŒ„ï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼šåªåŒ…å«åŸºæœ¬ä¿¡æ¯ï¼‰
                const processingDocument = {
                    id: documentId,
                    name: file.name,
                    fileName: file.name,
                    size: file.size,
                    fileSize: file.size,
                    type: file.type,
                    fileType: file.type,
                    uploadTime: currentDate.toISOString(),
                    uploadDate: currentDate.toISOString(),
                    projectId: projectId,
                    createdAt: currentDate.toISOString(),
                    status: 'Processing',
                    processingProgress: 0,
                    isProcessing: true,
                    // å­˜å„²æ–‡ä»¶çš„ Data URL ä»¥ä¾¿é è¦½
                    fileDataURL: fileDataURL,
                    // é è¨­æ•¸æ“šï¼ˆé¿å… undefined éŒ¯èª¤ï¼‰
                    processedData: {
                        fileName: file.name,
                        accountHolder: 'è™•ç†ä¸­...',
                        accountNumber: '',
                        startDate: 'â€”',
                        endDate: 'â€”',
                        transactions: [],
                        startBalance: 0,
                        endBalance: 0
                    }
                };
                
                console.log('   âœ… æ–‡ä»¶è¨˜éŒ„å‰µå»ºå®Œæˆ');
                console.log('   æ–‡ä»¶è¨˜éŒ„:', JSON.stringify(processingDocument, null, 2));
                
                // 4. ä¿å­˜åˆ° localStorage
                console.log('');
                console.log('4ï¸âƒ£ ä¿å­˜åˆ° localStorage...');
                const storageKey = `vaultcaddy_project_${projectId}_documents`;
                console.log('   å­˜å„²éµ:', storageKey);
                
                let existingDocs = [];
                try {
                    const stored = localStorage.getItem(storageKey);
                    existingDocs = stored ? JSON.parse(stored) : [];
                    console.log('   ç¾æœ‰æ–‡æª”æ•¸é‡:', existingDocs.length);
                } catch (e) {
                    console.error('   âš ï¸ è®€å–ç¾æœ‰æ–‡æª”å¤±æ•—:', e);
                    existingDocs = [];
                }
                
                existingDocs.push(processingDocument);
                localStorage.setItem(storageKey, JSON.stringify(existingDocs));
                console.log('   âœ… ä¿å­˜æˆåŠŸï¼Œç¾åœ¨æœ‰', existingDocs.length, 'å€‹æ–‡æª”');
                
                // 5. åœ¨é é¢ä¸­é¡¯ç¤ºæ–‡ä»¶è¡Œ
                console.log('');
                console.log('5ï¸âƒ£ åœ¨é é¢ä¸­å‰µå»ºæ–‡ä»¶è¡Œ...');
                const documentsTbody = document.getElementById('team-project-tbody');
                const emptyState = document.querySelector('#team-project-tbody tr td[colspan="9"]')?.parentElement;
                
                console.log('   team-project-tbody å…ƒç´ :', documentsTbody ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°');
                console.log('   empty-state å…ƒç´ :', emptyState ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°');
                
                if (!documentsTbody) {
                    throw new Error('æ‰¾ä¸åˆ° team-project-tbody å…ƒç´ ');
                }
                
                // éš±è—ç©ºç‹€æ…‹
                if (emptyState) {
                    emptyState.style.display = 'none';
                    console.log('   âœ… ç©ºç‹€æ…‹å·²éš±è—');
                }
                
                // å‰µå»ºæ–°çš„è¡¨æ ¼è¡Œ
                console.log('   æ­£åœ¨èª¿ç”¨ createDocumentRow...');
                createDocumentRow(documentsTbody, processingDocument);
                console.log('   âœ… æ–‡ä»¶è¡Œå·²æ·»åŠ åˆ°è¡¨æ ¼');
                
                // æ›´æ–°åˆ†é ä¿¡æ¯
                console.log('   æ›´æ–°åˆ†é ä¿¡æ¯...');
                updatePaginationInfo(existingDocs.length);
                console.log('   âœ… åˆ†é ä¿¡æ¯å·²æ›´æ–°');
                
                // å®Œæˆç¬¬ä¸€éƒ¨åˆ†
                console.log('');
                console.log('âœ…âœ…âœ… ç¬¬ä¸€éƒ¨åˆ†å®Œæˆï¼æ–‡ä»¶å·²æˆåŠŸé¡¯ç¤º âœ…âœ…âœ…');
                console.log('========================================');
                
                // 6. é–‹å§‹ç¬¬äºŒéƒ¨åˆ†ï¼šå¾Œå° AI æ•¸æ“šæå–
                try {
                    console.log('');
                    console.log('ğŸ¤– === é–‹å§‹ç¬¬äºŒéƒ¨åˆ†ï¼šAI æ•¸æ“šæå– ===');
                    console.log('   æ–‡ä»¶å°è±¡é¡å‹:', file.constructor.name);
                    console.log('   æ˜¯å¦ç‚º File å°è±¡:', file instanceof File);
                    console.log('   æ˜¯å¦ç‚º Blob å°è±¡:', file instanceof Blob);
                    console.log('   æ–‡ä»¶å:', file.name);
                    console.log('   æ–‡ä»¶å¤§å°:', file.size);
                    console.log('   documentId:', documentId);
                    console.log('   projectId:', projectId);
                    
                    console.log('');
                    console.log('ğŸ”œ å³å°‡èª¿ç”¨ startBackgroundAIProcessing...');
                    
                    startBackgroundAIProcessing(file, documentId, projectId).catch(err => {
                        console.error('');
                        console.error('========================================');
                        console.error('âŒ å¾Œå° AI è™•ç†å¤±æ•— (.catch)');
                        console.error('   éŒ¯èª¤é¡å‹:', err.name);
                        console.error('   éŒ¯èª¤æ¶ˆæ¯:', err.message);
                        console.error('   éŒ¯èª¤å †æ£§:', err.stack);
                        console.error('========================================');
                        
                        // æ›´æ–°æ–‡æª”ç‹€æ…‹ç‚ºå¤±æ•—
                        const storageKey = `vaultcaddy_project_${projectId}_documents`;
                        const docs = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        const doc = docs.find(d => d.id === documentId);
                        if (doc) {
                            doc.status = 'Failed';
                            doc.error = err.message;
                            doc.isProcessing = false;
                            localStorage.setItem(storageKey, JSON.stringify(docs));
                        }
                    });
                    
                    console.log('âœ… startBackgroundAIProcessing å·²èª¿ç”¨ï¼ˆç•°æ­¥åŸ·è¡Œä¸­ï¼‰');
                    
                } catch (err) {
                    console.error('');
                    console.error('========================================');
                    console.error('âŒ èª¿ç”¨ AI è™•ç†æ™‚ç™¼ç”ŸåŒæ­¥éŒ¯èª¤');
                    console.error('   éŒ¯èª¤é¡å‹:', err.name);
                    console.error('   éŒ¯èª¤æ¶ˆæ¯:', err.message);
                    console.error('   éŒ¯èª¤å †æ£§:', err.stack);
                    console.error('========================================');
                }
                
                // é‡ç½®è™•ç†æ¨™èªŒï¼ˆç¬¬ä¸€éƒ¨åˆ†å®Œæˆï¼‰
                console.log('ğŸ”„ é‡ç½® aiIsProcessing = false');
                aiIsProcessing = false;
                
            } catch (error) {
                console.error('âŒ æ–‡ä»¶ä¸Šå‚³éŒ¯èª¤:', error);
                console.error('âŒ éŒ¯èª¤å †æ£§:', error.stack);
                console.error('âŒ éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    name: error.name
                });
                alert('æ–‡ä»¶ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦\n\néŒ¯èª¤è©³æƒ…: ' + error.message);
                aiIsProcessing = false;
            }
        }
        
        // è‡ªå‹•ä¿å­˜åˆ°é …ç›®çš„å‡½æ•¸
        async function autoSaveToProject() {
            if (!aiProcessingResults.extractedData) {
                throw new Error('æ²’æœ‰å¯ä¿å­˜çš„æ•¸æ“š');
            }
            
            try {
                // ç²å–ç•¶å‰é …ç›® ID
                const projectId = getCurrentProjectId();
                console.log('ğŸ’¾ è‡ªå‹•ä¿å­˜æ–‡ä»¶åˆ°é …ç›®:', projectId);
                
                if (!projectId) {
                    throw new Error('ç„¡æ³•ç¢ºå®šç•¶å‰é …ç›®');
                }
                
                // ä¿å­˜åˆ° localStorage
                const storageKey = `vaultcaddy_project_${projectId}_documents`;
                const existingDocs = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                console.log('ğŸ“‚ ç¾æœ‰æ–‡æª”æ•¸é‡:', existingDocs.length);
                
                const newDocument = {
                    id: Date.now().toString(),
                    ...aiProcessingResults.extractedData,
                    projectId: projectId,
                    createdAt: new Date().toISOString()
                };
                
                existingDocs.push(newDocument);
                localStorage.setItem(storageKey, JSON.stringify(existingDocs));
                
                console.log('âœ… æ–‡æª”å·²è‡ªå‹•ä¿å­˜ï¼Œæ–°æ–‡æª”æ•¸é‡:', existingDocs.length);
                console.log('ğŸ’¾ å­˜å„²éµ:', storageKey);
                console.log('ğŸ“„ æ–‡æª”è©³æƒ…:', newDocument);
                
                // é—œé–‰æ¨¡æ…‹æ¡†ä¸¦åˆ·æ–°é é¢
                closeAIUploadModal();
                location.reload();
                
            } catch (error) {
                console.error('ä¿å­˜å¤±æ•—:', error);
                throw error;
            }
        }
        
        // å¾Œå° AI æ•¸æ“šæå–ï¼ˆä¸é˜»å¡ UIï¼‰
        async function startBackgroundAIProcessing(file, documentId, projectId) {
            console.log('');
            console.log('================================================================================');
            console.log('ğŸ¤– é–‹å§‹å¾Œå° AI è™•ç†');
            console.log('   æ–‡ä»¶å:', file.name);
            console.log('   æ–‡ä»¶é¡å‹:', file.type);
            console.log('   æ–‡ä»¶å¤§å°:', file.size, 'bytes');
            console.log('   æ–‡æª” ID:', documentId);
            console.log('   é …ç›® ID:', projectId);
            console.log('================================================================================');
            console.log('');
            
            try {
                // æ›´æ–°é€²åº¦åˆ° 10%
                console.log('ğŸ“Š æ­¥é©Ÿ 0: æ›´æ–°é€²åº¦åˆ° 10%...');
                updateDocumentProgress(documentId, projectId, 10);
                
                // æ­¥é©Ÿ 1 & 2: ä½¿ç”¨ Google Smart Processor è™•ç†æ–‡ä»¶
                console.log('');
                console.log('ğŸ§  === ä½¿ç”¨ Google AI è™•ç†å™¨è™•ç†æ–‡ä»¶ ===');
                console.log('   æ–‡ä»¶å:', file.name);
                console.log('   æ–‡ä»¶é¡å‹:', file.type);
                
                updateDocumentProgress(documentId, projectId, 30);
                
                // èª¿ç”¨ processWithGoogleAIï¼ˆå·²ç¶“é›†æˆäº† Google Smart Processorï¼‰
                const aiResult = await processWithGoogleAI(file);
                
                console.log('âœ… Google AI è™•ç†å®Œæˆ');
                console.log('   è™•ç†å™¨:', aiResult.processor || aiResult.engine || 'Unknown');
                console.log('   æˆåŠŸç‹€æ…‹:', aiResult.success);
                console.log('   æå–çš„åŸå§‹æ•¸æ“š (aiResult.data):', JSON.stringify(aiResult.data, null, 2));
                console.log('   æå–çš„åŸå§‹æ•¸æ“š (aiResult.extractedData):', JSON.stringify(aiResult.extractedData, null, 2));
                updateDocumentProgress(documentId, projectId, 70);
                
                // æ­¥é©Ÿ 3: è§£æä¸¦ä¿å­˜æ•¸æ“š
                console.log('');
                console.log('ğŸ’¾ === æ­¥é©Ÿ 3: è§£æä¸¦ä¿å­˜æ•¸æ“š ===');
                const parsedData = parseAIResponse(aiResult, file);
                console.log('âœ… æ•¸æ“šè§£æå®Œæˆ');
                console.log('   éŠ€è¡Œåç¨±:', parsedData.bankName);
                console.log('   å¸³æˆ¶æŒæœ‰äºº:', parsedData.accountHolder);
                console.log('   å¸³æˆ¶è™Ÿç¢¼:', parsedData.accountNumber);
                console.log('   å°å¸³æœŸé–“:', parsedData.startDate, 'to', parsedData.endDate);
                console.log('   æœŸåˆé¤˜é¡:', parsedData.startBalance);
                console.log('   æœŸæœ«é¤˜é¡:', parsedData.endBalance);
                console.log('   äº¤æ˜“æ•¸é‡:', parsedData.transactionCount);
                console.log('   äº¤æ˜“è©³æƒ…:', parsedData.transactions);
                
                // æ›´æ–° localStorage ä¸­çš„æ–‡æª”
                console.log('');
                console.log('ğŸ’¾ === æ­¥é©Ÿ 4: ä¿å­˜åˆ° localStorage ===');
                updateDocumentWithExtractedData(documentId, projectId, parsedData);
                updateDocumentProgress(documentId, projectId, 100);
                console.log('âœ… æ•¸æ“šå·²ä¿å­˜åˆ° localStorage');
                
                // é©—è­‰ä¿å­˜
                const storageKey = `vaultcaddy_project_${projectId}_documents`;
                const savedDocs = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const savedDoc = savedDocs.find(doc => doc.id === documentId);
                console.log('');
                console.log('ğŸ” === é©—è­‰ä¿å­˜çš„æ•¸æ“š ===');
                console.log('   å­˜å„²éµ:', storageKey);
                console.log('   ä¿å­˜çš„æ–‡æª”:', savedDoc);
                console.log('   äº¤æ˜“æ•¸é‡ (processedData):', savedDoc?.processedData?.transactions?.length);
                console.log('   äº¤æ˜“æ•¸é‡ (é ‚å±¤):', savedDoc?.transactions?.length);
                
                console.log('');
                console.log('ğŸ‰ AI æ•¸æ“šæå–å®Œæˆï¼');
                console.log('================================================================================');
                console.log('');
                
                // æš«æ™‚è¨»é‡‹æ‰è‡ªå‹•åˆ·æ–°ï¼Œä»¥ä¾¿æŸ¥çœ‹æ—¥èªŒ
                console.log('âš ï¸ è‡ªå‹•åˆ·æ–°å·²ç¦ç”¨ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰');
                console.log('ğŸ“Š AI è™•ç†å®Œæˆï¼Œæ•¸æ“šå·²ä¿å­˜åˆ° localStorage');
                console.log('ğŸ’¡ è«‹æ‰‹å‹•åˆ·æ–°é é¢ï¼ˆCommand + Rï¼‰æŸ¥çœ‹æå–çš„æ•¸æ“š');
                
                // å»¶é² 1 ç§’å¾Œåˆ·æ–°é é¢ï¼Œè®“ç”¨æˆ¶çœ‹åˆ° 100% é€²åº¦
                // setTimeout(() => {
                //     console.log('ğŸ”„ åˆ·æ–°é é¢ä»¥é¡¯ç¤ºæå–çš„æ•¸æ“š...');
                //     location.reload();
                // }, 1500);
                
            } catch (error) {
                console.error('');
                console.error('================================================================================');
                console.error('âŒ å¾Œå° AI è™•ç†å¤±æ•—');
                console.error('   éŒ¯èª¤é¡å‹:', error.name);
                console.error('   éŒ¯èª¤æ¶ˆæ¯:', error.message);
                console.error('   éŒ¯èª¤å †æ£§:', error.stack);
                console.error('================================================================================');
                console.error('');
                
                // æ›´æ–°æ–‡æª”ç‹€æ…‹ç‚ºéŒ¯èª¤
                updateDocumentStatus(documentId, projectId, 'Error', error.message);
                
                // é¡¯ç¤ºéŒ¯èª¤æ¶ˆæ¯çµ¦ç”¨æˆ¶
                alert(`AI è™•ç†å¤±æ•—: ${error.message}\n\nè«‹æŸ¥çœ‹æ§åˆ¶å°äº†è§£è©³æƒ…ã€‚`);
            }
        }
        
        // æ³¨æ„ï¼šfileToBase64ã€extractDataWithGeminiã€parseBankStatementData å‡½æ•¸å·²åˆªé™¤
        // ç¾åœ¨çµ±ä¸€ä½¿ç”¨ processWithGoogleAI (ç¬¬3080è¡Œ) å’Œ parseAIResponse (ç¬¬3133è¡Œ)
        
        // æ›´æ–°æ–‡æª”è™•ç†é€²åº¦
        function updateDocumentProgress(documentId, projectId, progress) {
            const storageKey = `vaultcaddy_project_${projectId}_documents`;
            const documents = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            const docIndex = documents.findIndex(doc => doc.id === documentId);
            if (docIndex !== -1) {
                documents[docIndex].processingProgress = progress;
                localStorage.setItem(storageKey, JSON.stringify(documents));
                console.log(`ğŸ“Š æ›´æ–°é€²åº¦: ${progress}%`);
            }
        }
        
        // æ›´æ–°æ–‡æª”ç‹€æ…‹
        function updateDocumentStatus(documentId, projectId, status, errorMessage = '') {
            const storageKey = `vaultcaddy_project_${projectId}_documents`;
            const documents = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            const docIndex = documents.findIndex(doc => doc.id === documentId);
            if (docIndex !== -1) {
                documents[docIndex].status = status;
                documents[docIndex].isProcessing = false;
                if (errorMessage) {
                    documents[docIndex].errorMessage = errorMessage;
                }
                localStorage.setItem(storageKey, JSON.stringify(documents));
                console.log(`ğŸ“ æ›´æ–°ç‹€æ…‹: ${status}`);
            }
        }
        
        // æ›´æ–°æ–‡æª”çš„æå–æ•¸æ“š
        function updateDocumentWithExtractedData(documentId, projectId, extractedData) {
            const storageKey = `vaultcaddy_project_${projectId}_documents`;
            const documents = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            const docIndex = documents.findIndex(doc => doc.id === documentId);
            if (docIndex !== -1) {
                documents[docIndex].isProcessing = false;
                documents[docIndex].status = 'Success';
                documents[docIndex].processedData = extractedData;
                
                // åŒæ™‚å°‡æå–çš„æ•¸æ“šè¤‡è£½åˆ°é ‚å±¤ï¼Œæ–¹ä¾¿è¨ªå•
                Object.assign(documents[docIndex], extractedData);
                
                localStorage.setItem(storageKey, JSON.stringify(documents));
                console.log('ğŸ’¾ æå–çš„æ•¸æ“šå·²ä¿å­˜');
            }
        }
        
        function validateAIFile(file) {
            const maxSize = 20 * 1024 * 1024; // 20MB
            if (file.size > maxSize) {
                logAI(`âŒ æ–‡ä»¶éå¤§: ${(file.size/1024/1024).toFixed(2)}MB (æœ€å¤§ 20MB)`, 'error');
                alert('æ–‡ä»¶éå¤§ï¼Œæœ€å¤§æ”¯æ´ 20MB');
                return false;
            }
            
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                logAI(`âŒ ä¸æ”¯æ´çš„æ–‡ä»¶é¡å‹: ${file.type}`, 'error');
                alert('ä¸æ”¯æ´çš„æ–‡ä»¶é¡å‹ï¼Œè«‹ä¸Šå‚³ PDFã€JPG æˆ– PNG æ–‡ä»¶');
                return false;
            }
            
            return true;
        }
        
        async function processAIStep(stepNumber, message, processor) {
            updateAIStep(stepNumber, 'active');
            updateAIProgress((stepNumber - 1) * 25);
            logAI(message, 'info');
            
            try {
                const result = await processor();
                updateAIStep(stepNumber, 'completed');
                updateAIProgress(stepNumber * 25);
                return result;
            } catch (error) {
                logAI(`âŒ æ­¥é©Ÿ ${stepNumber} å¤±æ•—: ${error.message}`, 'error');
                throw error;
            }
        }
        
        function updateAIStep(stepNumber, status) {
            const step = document.querySelector(`.ai-step[data-step="${stepNumber}"]`);
            if (step) {
                step.classList.remove('active', 'completed');
                if (status) {
                    step.classList.add(status);
                }
            }
        }
        
        function updateAIProgress(percentage) {
            const progressFill = document.getElementById('aiProgressFill');
            if (progressFill) {
                progressFill.style.width = `${percentage}%`;
            }
        }
        
        function logAI(message, type = 'info') {
            const logContent = document.getElementById('aiLogContent');
            if (logContent) {
                const entry = document.createElement('div');
                entry.className = `ai-log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContent.appendChild(entry);
                logContent.scrollTop = logContent.scrollHeight;
            }
            console.log(message);
        }
        
        async function processWithGoogleAI(file) {
            try {
                logAI('ğŸ§  ä½¿ç”¨ Google AI è™•ç†å™¨...', 'info');
                
                // æª¢æŸ¥ Google Smart Processor
                if (window.googleSmartProcessor) {
                    const documentType = determineDocumentType(file);
                    logAI(`ğŸ“‹ æ–‡æª”é¡å‹: ${documentType}`, 'info');
                    
                    const result = await window.googleSmartProcessor.processDocumentOptimized(file, documentType);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'AI è™•ç†å¤±æ•—');
                    }
                    
                    logAI(`âœ… ${result.processor} è™•ç†æˆåŠŸ`, 'success');
                    return result;
                    
                } else if (window.googleAIProcessor) {
                    const documentType = determineDocumentType(file);
                    const result = await window.googleAIProcessor.processDocument(file, documentType);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'AI è™•ç†å¤±æ•—');
                    }
                    
                    logAI(`âœ… Gemini AI åˆ†æå®Œæˆ`, 'success');
                    return result;
                    
                } else {
                    throw new Error('æ²’æœ‰å¯ç”¨çš„ Google AI è™•ç†å™¨');
                }
                
            } catch (error) {
                logAI(`âŒ Google AI è™•ç†å¤±æ•—: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // é¸æ“‡æ–‡æª”é¡å‹
        function selectDocumentType(type) {
            console.log('ğŸ“‹ ç”¨æˆ¶é¸æ“‡æ–‡æª”é¡å‹:', type);
            
            // æ›´æ–°å…¨å±€è®Šé‡
            selectedDocumentType = type;
            
            // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.doc-type-card').forEach(card => {
                card.style.borderColor = '#e5e7eb';
                card.style.background = '#ffffff';
                const indicator = card.querySelector('.selected-indicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            });
            
            // æ·»åŠ é¸ä¸­ç‹€æ…‹åˆ°ç•¶å‰å¡ç‰‡
            const selectedCard = document.querySelector(`.doc-type-card[data-type="${type}"]`);
            if (selectedCard) {
                selectedCard.style.borderColor = '#3b82f6';
                selectedCard.style.background = '#eff6ff';
                const indicator = selectedCard.querySelector('.selected-indicator');
                if (indicator) {
                    indicator.style.display = 'flex';
                }
            }
            
            console.log('âœ… æ–‡æª”é¡å‹å·²æ›´æ–°ç‚º:', selectedDocumentType);
        }
        window.selectDocumentType = selectDocumentType;
        
        function determineDocumentType(file) {
            // å„ªå…ˆä½¿ç”¨ç”¨æˆ¶é¸æ“‡çš„é¡å‹
            if (selectedDocumentType) {
                console.log('âœ… ä½¿ç”¨ç”¨æˆ¶é¸æ“‡çš„æ–‡æª”é¡å‹:', selectedDocumentType);
                return selectedDocumentType;
            }
            
            // å‚™ç”¨ï¼šåŸºæ–¼æ–‡ä»¶åè‡ªå‹•æª¢æ¸¬
            const fileName = file.name.toLowerCase();
            console.log('ğŸ” åŸºæ–¼æ–‡ä»¶åè‡ªå‹•æª¢æ¸¬æ–‡æª”é¡å‹:', fileName);
            
            if (fileName.includes('receipt') || fileName.includes('æ”¶æ“š') || 
                fileName.includes('å°ç¥¨') || fileName.includes('æ†‘è­‰')) {
                console.log('   æª¢æ¸¬çµæœ: receipt');
                return 'receipt';
            } else if (fileName.includes('invoice') || fileName.includes('ç™¼ç¥¨') || 
                       fileName.includes('å¸³å–®') || fileName.includes('bill')) {
                console.log('   æª¢æ¸¬çµæœ: invoice');
                return 'invoice';
            } else if (fileName.includes('statement') || fileName.includes('å°å¸³å–®') || 
                       fileName.includes('æœˆçµå–®') || fileName.includes('bank') ||
                       fileName.includes('éŠ€è¡Œ') || fileName.includes('eStatement')) {
                console.log('   æª¢æ¸¬çµæœ: bank_statement');
                return 'bank_statement';
            } else {
                console.log('   æª¢æ¸¬çµæœ: general');
                return 'general';
            }
        }
        
        function parseAIResponse(aiResult, file) {
            try {
                logAI('ğŸ“‹ è§£æ AI æå–çš„æ•¸æ“š...', 'info');
                
                // âœ… å…¼å®¹ä¸åŒ AI è™•ç†å™¨çš„è¿”å›æ ¼å¼
                // Vision AI è¿”å›: { success, data, processingTime, engine }
                // Gemini AI è¿”å›: { success, extractedData, processingTime }
                const data = aiResult.data || aiResult.extractedData || {};
                
                console.log('ğŸ” parseAIResponse èª¿è©¦:');
                console.log('   aiResult keys:', Object.keys(aiResult));
                console.log('   aiResult.data:', aiResult.data);
                console.log('   aiResult.extractedData:', aiResult.extractedData);
                console.log('   æœ€çµ‚ä½¿ç”¨çš„ data:', data);
                
                // ç¢ºå®šæ–‡æª”é¡å‹ï¼ˆå„ªå…ˆä½¿ç”¨ç”¨æˆ¶é¸æ“‡çš„é¡å‹ï¼‰
                const docType = determineDocumentType(file);
                logAI(`ğŸ“„ æ–‡æª”é¡å‹: ${docType}`, 'info');
                
                // æ ¹æ“šæ–‡æª”é¡å‹è¿”å›ä¸åŒçš„æ•¸æ“šçµæ§‹
                if (docType === 'invoice') {
                    return parseInvoiceData(data, file, aiResult);
                } else if (docType === 'receipt') {
                    return parseReceiptData(data, file, aiResult);
                } else if (docType === 'bank_statement') {
                    return parseBankStatementData(data, file, aiResult);
                } else {
                    return parseGeneralData(data, file, aiResult);
                }
                
            } catch (error) {
                logAI(`âŒ æ•¸æ“šè§£æå¤±æ•—: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // è§£æç™¼ç¥¨æ•¸æ“š
        function parseInvoiceData(data, file, aiResult) {
            const standardizedData = {
                // åŸºæœ¬ä¿¡æ¯
                documentType: 'Invoice',
                fileName: file?.name || 'æœªå‘½åæ–‡ä»¶',
                fileSize: file?.size || 0,
                extractedAt: new Date().toISOString(),
                
                // ç™¼ç¥¨ä¿¡æ¯
                invoiceNumber: data.invoiceNumber || data.number || data.documentNumber || '',
                issueDate: data.issueDate || data.invoiceDate || data.date || '',
                dueDate: data.dueDate || data.paymentDue || '',
                deliveryDate: data.deliveryDate || data.shippingDate || '',
                
                // ä¾›æ‡‰å•†ä¿¡æ¯
                vendor: {
                    name: data.vendor?.name || data.vendorName || data.supplier || data.from || '',
                    address: data.vendor?.address || data.vendorAddress || '',
                    phone: data.vendor?.phone || data.vendorPhone || '',
                    email: data.vendor?.email || data.vendorEmail || '',
                    taxId: data.vendor?.taxId || data.vendorTaxId || '',
                    companyRegNo: data.vendor?.companyRegNo || ''
                },
                
                // å®¢æˆ¶ä¿¡æ¯
                customer: {
                    name: data.customer?.name || data.customerName || data.billTo || data.to || '',
                    address: data.customer?.address || data.customerAddress || data.shippingAddress || '',
                    phone: data.customer?.phone || data.customerPhone || '',
                    email: data.customer?.email || data.customerEmail || ''
                },
                
                // å•†å“é …ç›®
                lineItems: (data.lineItems || data.items || []).map(item => ({
                    itemCode: item.itemCode || item.code || item.sku || '',
                    description: item.description || item.name || item.product || '',
                    quantity: parseFloat(item.quantity || item.qty || 0),
                    unit: item.unit || item.uom || 'ä»¶',
                    unitPrice: parseFloat(item.unitPrice || item.price || 0),
                    amount: parseFloat(item.amount || item.total || (item.quantity * item.unitPrice) || 0),
                    taxRate: parseFloat(item.taxRate || 0),
                    taxAmount: parseFloat(item.taxAmount || 0)
                })),
                
                // é‡‘é¡ä¿¡æ¯
                subtotal: parseFloat(data.subtotal || data.subTotal || 0),
                discount: parseFloat(data.discount || 0),
                discountPercent: parseFloat(data.discountPercent || 0),
                taxAmount: parseFloat(data.taxAmount || data.tax || 0),
                taxRate: parseFloat(data.taxRate || 0),
                totalAmount: parseFloat(data.totalAmount || data.total || data.grandTotal || 0),
                currency: data.currency || 'HKD',
                
                // ä»˜æ¬¾ä¿¡æ¯
                paymentMethod: data.paymentMethod || data.payment || '',
                paymentTerms: data.paymentTerms || data.terms || '',
                paymentStatus: data.paymentStatus || 'Unpaid',
                paidDate: data.paidDate || '',
                paidAmount: parseFloat(data.paidAmount || 0),
                
                // ç‹€æ…‹
                status: 'Success',
                reviewStatus: 'Review',
                notes: data.notes || data.remarks || '',
                
                // å…¶ä»–ä¿¡æ¯
                rawText: aiResult.text || '',
                confidence: aiResult.confidence || 0
            };
            
            // è¨ˆç®—é …ç›®æ•¸é‡
            standardizedData.itemCount = standardizedData.lineItems.length;
            
            // å¦‚æœæ²’æœ‰æ˜ç¢ºçš„ç¸½é‡‘é¡ï¼Œè¨ˆç®—å®ƒ
            if (!standardizedData.totalAmount && standardizedData.lineItems.length > 0) {
                const itemsTotal = standardizedData.lineItems.reduce((sum, item) => sum + item.amount, 0);
                standardizedData.subtotal = itemsTotal;
                standardizedData.totalAmount = itemsTotal - standardizedData.discount + standardizedData.taxAmount;
            }
            
            logAI(`ğŸ“Š ç™¼ç¥¨æ•¸æ“šè§£æå®Œæˆ`, 'success');
            logAI(`ğŸ“„ ç™¼ç¥¨è™Ÿç¢¼: ${standardizedData.invoiceNumber}`, 'info');
            logAI(`ğŸ“… ç™¼ç¥¨æ—¥æœŸ: ${standardizedData.issueDate}`, 'info');
            logAI(`ğŸ¢ ä¾›æ‡‰å•†: ${standardizedData.vendor.name}`, 'info');
            logAI(`ğŸ‘¤ å®¢æˆ¶: ${standardizedData.customer.name}`, 'info');
            logAI(`ğŸ“¦ é …ç›®æ•¸é‡: ${standardizedData.itemCount}`, 'info');
            logAI(`ğŸ’° ç¸½é‡‘é¡: ${standardizedData.currency} $${standardizedData.totalAmount.toFixed(2)}`, 'info');
            
            return standardizedData;
        }
        
        // è§£ææ”¶æ“šæ•¸æ“š
        function parseReceiptData(data, file, aiResult) {
            const standardizedData = {
                // åŸºæœ¬ä¿¡æ¯
                documentType: 'Receipt',
                fileName: file?.name || 'æœªå‘½åæ–‡ä»¶',
                fileSize: file?.size || 0,
                extractedAt: new Date().toISOString(),
                
                // æ”¶æ“šä¿¡æ¯
                receiptNumber: data.receiptNumber || data.number || '',
                receiptDate: data.receiptDate || data.date || '',
                
                // å•†æˆ¶ä¿¡æ¯
                merchant: {
                    name: data.merchant?.name || data.merchantName || data.store || data.vendor || '',
                    address: data.merchant?.address || data.merchantAddress || data.location || '',
                    phone: data.merchant?.phone || data.merchantPhone || ''
                },
                
                // é …ç›®æ˜ç´°
                items: (data.items || data.lineItems || []).map(item => ({
                    description: item.description || item.name || item.product || '',
                    quantity: parseFloat(item.quantity || item.qty || 1),
                    unitPrice: parseFloat(item.unitPrice || item.price || 0),
                    amount: parseFloat(item.amount || item.total || 0)
                })),
                
                // é‡‘é¡ä¿¡æ¯
                subtotal: parseFloat(data.subtotal || data.subTotal || 0),
                tax: parseFloat(data.tax || data.taxAmount || 0),
                tip: parseFloat(data.tip || 0),
                totalAmount: parseFloat(data.totalAmount || data.total || 0),
                currency: data.currency || 'HKD',
                
                // ä»˜æ¬¾ä¿¡æ¯
                paymentMethod: data.paymentMethod || data.payment || '',
                cardLastFour: data.cardLastFour || '',
                
                // ç‹€æ…‹
                status: 'Success',
                reviewStatus: 'Review',
                notes: data.notes || '',
                
                // å…¶ä»–ä¿¡æ¯
                rawText: aiResult.text || '',
                confidence: aiResult.confidence || 0
            };
            
            standardizedData.itemCount = standardizedData.items.length;
            
            logAI(`ğŸ“Š æ”¶æ“šæ•¸æ“šè§£æå®Œæˆ`, 'success');
            logAI(`ğŸ§¾ æ”¶æ“šè™Ÿç¢¼: ${standardizedData.receiptNumber}`, 'info');
            logAI(`ğŸ“… æ—¥æœŸ: ${standardizedData.receiptDate}`, 'info');
            logAI(`ğŸª å•†æˆ¶: ${standardizedData.merchant.name}`, 'info');
            logAI(`ğŸ“¦ é …ç›®æ•¸é‡: ${standardizedData.itemCount}`, 'info');
            logAI(`ğŸ’° ç¸½é‡‘é¡: ${standardizedData.currency} $${standardizedData.totalAmount.toFixed(2)}`, 'info');
            
            return standardizedData;
        }
        
        // è§£æéŠ€è¡Œå°å¸³å–®æ•¸æ“š
        function parseBankStatementData(data, file, aiResult) {
            const standardizedData = {
                // åŸºæœ¬ä¿¡æ¯
                documentType: 'Bank Statement',
                fileName: file?.name || 'æœªå‘½åæ–‡ä»¶',
                fileSize: file?.size || 0,
                extractedAt: new Date().toISOString(),
                
                // éŠ€è¡Œè³¬æˆ¶ä¿¡æ¯
                accountHolder: data.accountHolder || data.accountName || data.name || '',
                accountNumber: data.accountNumber || data.account || '',
                bankName: data.bankName || data.bank || '',
                
                // å°è³¬å–®æœŸé–“
                startDate: data.startDate || data.statementStartDate || data.periodStart || '',
                endDate: data.endDate || data.statementEndDate || data.periodEnd || '',
                
                // é¤˜é¡ä¿¡æ¯
                startBalance: parseFloat(data.startBalance || data.openingBalance || data.beginningBalance || 0),
                endBalance: parseFloat(data.endBalance || data.closingBalance || data.endingBalance || 0),
                
                // äº¤æ˜“ä¿¡æ¯
                transactions: (data.transactions || []).map(tx => ({
                    date: tx.date || '',
                    description: tx.description || tx.memo || '',
                    debit: parseFloat(tx.debit || 0),
                    credit: parseFloat(tx.credit || 0),
                    balance: parseFloat(tx.balance || 0),
                    reference: tx.reference || tx.refNo || '',
                    category: tx.category || ''
                })),
                transactionCount: (data.transactions || []).length || data.transactionCount || 0,
                reconciledTransactions: data.reconciledTransactions || 0,
                
                // ç‹€æ…‹
                status: 'Success',
                reviewStatus: 'Review',
                notes: data.notes || '',
                
                // å…¶ä»–ä¿¡æ¯
                currency: data.currency || 'HKD',
                rawText: aiResult.text || '',
                confidence: aiResult.confidence || 0
            };
            
            logAI(`ğŸ“Š éŠ€è¡Œå°å¸³å–®æ•¸æ“šè§£æå®Œæˆ`, 'success');
            logAI(`ğŸ‘¤ è³¬æˆ¶æŒæœ‰äºº: ${standardizedData.accountHolder}`, 'info');
            logAI(`ğŸ¦ è³¬è™Ÿ: ${standardizedData.accountNumber}`, 'info');
            logAI(`ğŸ“… æœŸé–“: ${standardizedData.startDate} è‡³ ${standardizedData.endDate}`, 'info');
            logAI(`ğŸ“‹ äº¤æ˜“æ•¸é‡: ${standardizedData.transactionCount}`, 'info');
            logAI(`ğŸ’° èµ·å§‹é¤˜é¡: $${standardizedData.startBalance.toFixed(2)}`, 'info');
            logAI(`ğŸ’° çµæŸé¤˜é¡: $${standardizedData.endBalance.toFixed(2)}`, 'info');
            
            return standardizedData;
        }
        
        // è§£æé€šç”¨æ–‡æª”æ•¸æ“š
        function parseGeneralData(data, file, aiResult) {
            const standardizedData = {
                // åŸºæœ¬ä¿¡æ¯
                documentType: 'General',
                fileName: file?.name || 'æœªå‘½åæ–‡ä»¶',
                fileSize: file?.size || 0,
                extractedAt: new Date().toISOString(),
                
                // é€šç”¨å­—æ®µ
                date: data.date || new Date().toISOString().split('T')[0],
                title: data.title || data.subject || '',
                description: data.description || data.content || '',
                entities: data.entities || [],
                keywords: data.keywords || [],
                
                // ç‹€æ…‹
                status: 'Success',
                reviewStatus: 'Review',
                notes: data.notes || '',
                
                // å…¶ä»–ä¿¡æ¯
                rawText: aiResult.text || '',
                confidence: aiResult.confidence || 0
            };
            
            logAI(`ğŸ“Š é€šç”¨æ–‡æª”æ•¸æ“šè§£æå®Œæˆ`, 'success');
            logAI(`ğŸ“„ æ¨™é¡Œ: ${standardizedData.title}`, 'info');
            logAI(`ğŸ“… æ—¥æœŸ: ${standardizedData.date}`, 'info');
            
            return standardizedData;
        }
        
        function displayAIResults(data) {
            const resultsContainer = document.getElementById('aiResultsContainer');
            const resultsContent = document.getElementById('aiResultsContent');
            
            if (!resultsContainer || !resultsContent) return;
            
            // æ ¹æ“šæ–‡æª”é¡å‹é¡¯ç¤ºä¸åŒçš„å­—æ®µ
            const isBankStatement = data.documentType === 'Bank Statement' || data.accountNumber;
            
            let resultHTML = `
                <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                    <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ“„ æ–‡æª”é¡å‹</span>
                    <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.documentType}</span>
                </div>
                <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                    <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ“ æ–‡ä»¶åç¨±</span>
                    <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.fileName}</span>
                </div>
            `;
            
            if (isBankStatement) {
                resultHTML += `
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ‘¤ è³¬æˆ¶æŒæœ‰äºº</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.accountHolder || 'â€”'}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ¦ è³¬è™Ÿ</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.accountNumber || 'â€”'}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ›ï¸ éŠ€è¡Œåç¨±</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.bankName || 'â€”'}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ“… å°è³¬å–®æœŸé–“</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.startDate || 'â€”'} è‡³ ${data.endDate || 'â€”'}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ’° èµ·å§‹é¤˜é¡</span>
                        <span class="ai-result-value" style="color: #10b981; font-weight: 600;">$${data.startBalance?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ’° çµæŸé¤˜é¡</span>
                        <span class="ai-result-value" style="color: #10b981; font-weight: 600;">$${data.endBalance?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ“Š äº¤æ˜“æ•¸é‡</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.transactionCount || 0} ç­†</span>
                    </div>
                `;
            } else {
                // é¡¯ç¤ºé€šç”¨å­—æ®µ
                resultHTML += `
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ“… æ—¥æœŸ</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.date}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ¢ å•†æˆ¶/å…¬å¸</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.merchant || 'â€”'}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ’° é‡‘é¡</span>
                        <span class="ai-result-value" style="color: #10b981; font-weight: 600;">${data.currency} ${data.amount}</span>
                    </div>
                    <div class="ai-result-item" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                        <span class="ai-result-label" style="font-weight: 500; color: #6b7280;">ğŸ“ æè¿°</span>
                        <span class="ai-result-value" style="color: #1f2937; font-weight: 600;">${data.description || 'ç„¡'}</span>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = resultHTML;
            resultsContainer.style.display = 'block';
        }
        
        function saveAIResults() {
            if (!aiProcessingResults.extractedData) {
                alert('æ²’æœ‰å¯ä¿å­˜çš„æ•¸æ“š');
                return;
            }
            
            try {
                // ç²å–ç•¶å‰é …ç›® ID
                const projectId = getCurrentProjectId();
                console.log('ğŸ’¾ æº–å‚™ä¿å­˜æ–‡ä»¶åˆ°é …ç›®:', projectId);
                
                if (!projectId) {
                    alert('ç„¡æ³•ç¢ºå®šç•¶å‰é …ç›®');
                    return;
                }
                
                // ä¿å­˜åˆ° localStorage
                const storageKey = `vaultcaddy_project_${projectId}_documents`;
                const existingDocs = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                console.log('ğŸ“‚ ç¾æœ‰æ–‡æª”æ•¸é‡:', existingDocs.length);
                
                const newDocument = {
                    id: Date.now().toString(),
                    ...aiProcessingResults.extractedData,
                    projectId: projectId,
                    createdAt: new Date().toISOString()
                };
                
                existingDocs.push(newDocument);
                localStorage.setItem(storageKey, JSON.stringify(existingDocs));
                
                console.log('âœ… æ–‡æª”å·²ä¿å­˜ï¼Œæ–°æ–‡æª”æ•¸é‡:', existingDocs.length);
                console.log('ğŸ’¾ å­˜å„²éµ:', storageKey);
                console.log('ğŸ“„ æ–‡æª”è©³æƒ…:', newDocument);
                
                logAI('âœ… æ•¸æ“šå·²ä¿å­˜åˆ°é …ç›® ' + projectId, 'success');
                alert(`æ–‡æª”å·²æˆåŠŸä¿å­˜åˆ°é …ç›® ${projectId}ï¼`);
                
                // é—œé–‰æ¨¡æ…‹æ¡†ä¸¦åˆ·æ–°é é¢
                closeAIUploadModal();
                location.reload();
                
            } catch (error) {
                logAI(`âŒ ä¿å­˜å¤±æ•—: ${error.message}`, 'error');
                alert('ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }
        window.saveAIResults = saveAIResults;
        
        // æ‰¹é‡ä¸Šå‚³è™•ç†å‡½æ•¸
        async function handleBatchFileUpload(files) {
            console.log('ğŸ“¦ é–‹å§‹æ‰¹é‡ä¸Šå‚³è™•ç†:', files.length, 'å€‹æ–‡ä»¶');
            
            // éš±è—ä¸Šå‚³å€åŸŸï¼Œé¡¯ç¤ºæ‰¹é‡è™•ç†é€²åº¦
            document.getElementById('aiUploadArea').style.display = 'none';
            document.getElementById('batchProgressContainer').style.display = 'block';
            
            // æ›´æ–°ç¸½æ•¸
            document.getElementById('batchTotalCount').textContent = files.length;
            document.getElementById('batchCompletedCount').textContent = '0';
            
            // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
            const filesList = document.getElementById('batchFilesList');
            filesList.innerHTML = '';
            
            // ç‚ºæ¯å€‹æ–‡ä»¶å‰µå»ºé€²åº¦é …
            const fileProgressItems = {};
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.id = `batch-file-${index}`;
                fileItem.style.cssText = 'background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; transition: all 0.3s;';
                fileItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="flex-shrink: 0; width: 40px; height: 40px; background: #e5e7eb; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            ğŸ“„
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; color: #1f2937; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                <span class="file-status">ç­‰å¾…è™•ç†...</span>
                            </div>
                            <div class="file-progress-bar" style="display: none; width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
                                <div class="file-progress-fill" style="height: 100%; background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%); width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div class="file-status-icon" style="flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                            â³
                        </div>
                    </div>
                `;
                filesList.appendChild(fileItem);
                fileProgressItems[index] = fileItem;
            });
            
            // ç²å–ç•¶å‰é …ç›® ID
            const projectId = getCurrentProjectId();
            if (!projectId) {
                alert('ç„¡æ³•ç¢ºå®šç•¶å‰é …ç›®');
                return;
            }
            
            // ä½¿ç”¨æ‰¹é‡è™•ç†å™¨è™•ç†æ–‡ä»¶
            let completedCount = 0;
            
            await window.batchUploadProcessor.processBatch(
                files,
                selectedDocumentType,
                projectId,
                // é€²åº¦å›èª¿
                (progress) => {
                    const fileItem = fileProgressItems[Array.from(files).findIndex(f => f.name === progress.fileName)];
                    if (!fileItem) return;
                    
                    const statusEl = fileItem.querySelector('.file-status');
                    const statusIcon = fileItem.querySelector('.file-status-icon');
                    const progressBar = fileItem.querySelector('.file-progress-bar');
                    const progressFill = fileItem.querySelector('.file-progress-fill');
                    
                    if (progress.status === 'processing') {
                        statusEl.textContent = progress.message || 'è™•ç†ä¸­...';
                        statusIcon.textContent = 'ğŸ”„';
                        statusIcon.style.background = '#dbeafe';
                        progressBar.style.display = 'block';
                        progressFill.style.width = `${progress.progress}%`;
                    } else if (progress.status === 'completed') {
                        completedCount++;
                        document.getElementById('batchCompletedCount').textContent = completedCount;
                        statusEl.textContent = 'âœ… å®Œæˆ';
                        statusIcon.textContent = 'âœ“';
                        statusIcon.style.background = '#dcfce7';
                        statusIcon.style.color = '#16a34a';
                        fileItem.style.background = '#f0fdf4';
                        fileItem.style.borderColor = '#86efac';
                        progressBar.style.display = 'none';
                    } else if (progress.status === 'failed') {
                        completedCount++;
                        document.getElementById('batchCompletedCount').textContent = completedCount;
                        statusEl.textContent = progress.message || 'âŒ å¤±æ•—';
                        statusIcon.textContent = 'âœ•';
                        statusIcon.style.background = '#fee2e2';
                        statusIcon.style.color = '#dc2626';
                        fileItem.style.background = '#fef2f2';
                        fileItem.style.borderColor = '#fca5a5';
                        progressBar.style.display = 'none';
                    }
                },
                // å®Œæˆå›èª¿
                (result) => {
                    console.log('âœ… æ‰¹é‡è™•ç†å®Œæˆ:', result);
                    
                    // é¡¯ç¤ºå®Œæˆæ¶ˆæ¯
                    setTimeout(() => {
                        alert(`æ‰¹é‡ä¸Šå‚³å®Œæˆï¼\næˆåŠŸ: ${result.completed}\nå¤±æ•—: ${result.failed}`);
                        
                        // âœ… é—œé–‰ä¸Šå‚³æ¨¡æ…‹æ¡†
                        closeUploadModal();
                        
                        // âœ… é‡æ–°åŠ è¼‰æ–‡ä»¶åˆ—è¡¨ï¼Œè€Œä¸æ˜¯åˆ·æ–°æ•´å€‹é é¢
                        const currentHash = window.location.hash;
                        const currentDocType = currentHash ? currentHash.substring(1) : 'bank-statement';
                        
                        // é‡æ–°åŠ è¼‰ç•¶å‰æ–‡æª”é¡å‹çš„æ–‡ä»¶
                        if (typeof loadFilesForDocumentType === 'function') {
                            console.log('ğŸ”„ é‡æ–°åŠ è¼‰æ–‡ä»¶åˆ—è¡¨...');
                            loadFilesForDocumentType(currentDocType);
                        } else {
                            // å¦‚æœå‡½æ•¸ä¸å¯ç”¨ï¼Œæ‰ä½¿ç”¨ location.reload()
                            console.warn('âš ï¸  loadFilesForDocumentType å‡½æ•¸ä¸å¯ç”¨ï¼Œåˆ·æ–°é é¢');
                            location.reload();
                        }
                    }, 1000);
                }
            );
        }
        window.handleBatchFileUpload = handleBatchFileUpload;
        
        function resetAIUpload() {
            // é‡ç½®æ‰€æœ‰ç‹€æ…‹
            aiCurrentFile = null;
            aiIsProcessing = false;
            aiProcessingResults = {};
            
            // é‡ç½®æ‰¹é‡ä¸Šå‚³ç‹€æ…‹
            document.getElementById('aiUploadArea').style.display = 'block';
            document.getElementById('batchProgressContainer').style.display = 'none';
            
            // é‡ç½® UI
            document.getElementById('aiUploadArea').style.display = 'block';
            document.getElementById('aiProgressContainer').style.display = 'none';
            document.getElementById('aiLogContainer').style.display = 'none';
            document.getElementById('aiResultsContainer').style.display = 'none';
            
            // æ¸…ç©ºå…§å®¹
            document.getElementById('aiLogContent').innerHTML = '';
            document.getElementById('aiResultsContent').innerHTML = '';
            document.getElementById('aiFileInput').value = '';
            
            // é‡ç½®é€²åº¦
            updateAIProgress(0);
            for (let i = 1; i <= 4; i++) {
                updateAIStep(i, '');
            }
        }
        window.resetAIUpload = resetAIUpload;
        
        function closeUploadModal() {
            const modal = document.getElementById('upload-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                // æ¸…ç†æ–‡ä»¶è¼¸å…¥
                const fileInput = document.getElementById('modal-file-input');
                if (fileInput) {
                    fileInput.value = '';
                }
                clearFilePreview();
            }
        }
        
        function clearFilePreview() {
            const preview = document.getElementById('file-preview-area');
            if (preview) {
                preview.innerHTML = '<p>æ‹–æ”¾æ–‡ä»¶åˆ°é€™è£¡æˆ–é»æ“Šé¸æ“‡æ–‡ä»¶</p>';
                preview.className = 'file-drop-area';
            }
        }
        
        function handleModalFileSelect() {
            const fileInput = document.getElementById('modal-file-input');
            if (fileInput) {
                fileInput.click();
            }
        }
        
        function handleFileInputChange(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                displayFilePreview(files);
            }
        }
        
        function displayFilePreview(files) {
            const preview = document.getElementById('file-preview-area');
            if (!preview) return;
            
            let html = '<div class="file-list"><h4>é¸ä¸­çš„æ–‡ä»¶:</h4>';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                html += `
                    <div class="file-item">
                        <i class="fas fa-file-pdf"></i>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize} MB</div>
                        </div>
                        <button onclick="removeFile(${i})" class="remove-file-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
            html += '</div>';
            preview.innerHTML = html;
            preview.className = 'file-drop-area has-files';
        }
        
        async function processSelectedFiles() {
            console.log('ğŸš€ é–‹å§‹è™•ç†é¸ä¸­çš„æ–‡ä»¶...');
            
            const fileInput = document.getElementById('modal-file-input');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                console.error('âŒ æ²’æœ‰é¸ä¸­çš„æ–‡ä»¶');
                alert('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æ–‡ä»¶');
                return;
            }
            
            console.log(`ğŸ“ æ‰¾åˆ° ${fileInput.files.length} å€‹æ–‡ä»¶:`, Array.from(fileInput.files).map(f => f.name));
            
            // è½‰æ›ç‚ºæ•¸çµ„ä¸¦è¨˜éŒ„è©³ç´°ä¿¡æ¯
            const files = Array.from(fileInput.files);
            console.log('ğŸ“„ æ–‡ä»¶è©³æƒ…:', files.map(f => ({
                name: f.name,
                size: f.size,
                type: f.type,
                lastModified: f.lastModified
            })));
            
            // ç²å–ç•¶å‰æ–‡æª”é¡å‹
            const hash = window.location.hash.substring(1);
            const currentDocType = hash || 'bank-statement';
            
            closeUploadModal();
            showProcessingStatus(files);
            
            try {
                // ä½¿ç”¨çµ±ä¸€è™•ç†å™¨è™•ç†æ–‡ä»¶
                if (window.UnifiedDocumentProcessor) {
                    console.log('ğŸ¯ ä½¿ç”¨çµ±ä¸€è™•ç†å™¨è™•ç†æ–‡ä»¶...');
                    
                    const processingResults = await window.UnifiedDocumentProcessor.processUploadedFiles(files, currentDocType);
                    
                    console.log('âœ… çµ±ä¸€è™•ç†å™¨è™•ç†å®Œæˆ:', processingResults);
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰è™•ç†å¤±æ•—çš„æ–‡ä»¶
                    const failedFiles = processingResults.filter(r => r.status === 'error');
                    if (failedFiles.length > 0) {
                        console.error('âŒ éƒ¨åˆ†æ–‡ä»¶è™•ç†å¤±æ•—:', failedFiles);
                        alert(`${failedFiles.length} å€‹æ–‡ä»¶è™•ç†å¤±æ•—ï¼š${failedFiles.map(f => f.error).join(', ')}`);
                    }
                    
                    // åªæ·»åŠ æˆåŠŸè™•ç†çš„æ–‡ä»¶åˆ°è¡¨æ ¼
                    const successfulFiles = files.filter((_, index) => 
                        processingResults[index] && processingResults[index].status === 'success'
                    );
                    
                    if (successfulFiles.length > 0) {
                        addProcessedFilesToTable(successfulFiles);
                        
                        // ä¿å­˜è™•ç†çµæœåˆ°çµ±ä¸€å­˜å„²
                        saveUnifiedProcessingResults(processingResults, currentDocType);
                        
                        showSuccessNotification(successfulFiles.length);
                    }
                } else {
                    // å…œåº•ï¼šä½¿ç”¨åŸæœ‰çš„æ¨¡æ“¬è™•ç†
                    console.log('âš ï¸ çµ±ä¸€è™•ç†å™¨æœªè¼‰å…¥ï¼Œä½¿ç”¨æ¨¡æ“¬è™•ç†');
                    setTimeout(() => {
                        addProcessedFilesToTable(files);
                        showSuccessNotification(files.length);
                        hideProcessingStatus();
                    }, 2000);
                    return;
                }
                
                // æ›´æ–°çµ±è¨ˆ
                updateDocumentStats();
                
            } catch (error) {
                console.error('âŒ è™•ç†æ–‡ä»¶æ™‚å‡ºéŒ¯:', error);
                alert(`è™•ç†æ–‡ä»¶æ™‚å‡ºç¾éŒ¯èª¤ï¼š${error.message}`);
            } finally {
                hideProcessingStatus();
            }
        }
        
        // ä¿å­˜è™•ç†çµæœåˆ°localStorageï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
        function saveProcessingResults(results, documentType) {
            const storageKey = `vaultcaddy_processing_results_${documentType}`;
            const existingResults = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // æ·»åŠ æ–°çš„è™•ç†çµæœ
            results.forEach(result => {
                if (result.status === 'success') {
                    existingResults.push(result);
                }
            });
            
            localStorage.setItem(storageKey, JSON.stringify(existingResults));
            console.log(`ğŸ’¾ å·²ä¿å­˜ ${results.length} å€‹è™•ç†çµæœåˆ° ${storageKey}`);
        }
        
        // ä¿å­˜çµ±ä¸€è™•ç†å™¨çµæœ
        function saveUnifiedProcessingResults(results, documentType) {
            console.log(`ğŸ’¾ çµ±ä¸€è™•ç†å™¨çµæœå·²è‡ªå‹•ä¿å­˜åˆ°çµ±ä¸€å­˜å„²ç³»çµ±`);
            
            // çµ±ä¸€è™•ç†å™¨æœƒè‡ªå‹•ä¿å­˜ï¼Œé€™è£¡åªéœ€è¦è§¸ç™¼UIæ›´æ–°
            results.forEach(result => {
                if (result.status === 'success') {
                    // è§¸ç™¼UIæ›´æ–°äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('vaultcaddy:document:added', {
                        detail: { 
                            documentType: documentType,
                            fileName: result.fileName,
                            data: result.data
                        }
                    }));
                }
            });
        }
        
        function showSuccessNotification(fileCount) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 1rem; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <i class="fas fa-check-circle"></i> æˆåŠŸè™•ç† ${fileCount} å€‹æ–‡ä»¶ï¼
                </div>
            `;
            document.body.appendChild(notification);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showProcessingStatus(files) {
            // å¯ä»¥é¡¯ç¤ºä¸€å€‹è™•ç†ä¸­çš„é€šçŸ¥
            const notification = document.createElement('div');
            notification.id = 'processing-notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 1rem; border-radius: 8px; z-index: 1000;">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è™•ç† ${files.length} å€‹æ–‡ä»¶...
                </div>
            `;
            document.body.appendChild(notification);
        }
        
        function hideProcessingStatus() {
            const notification = document.getElementById('processing-notification');
            if (notification) {
                notification.remove();
            }
        }
        
        function addProcessedFilesToTable(files) {
            console.log('ğŸ“‹ æ·»åŠ æ–‡ä»¶åˆ°æ–‡ä»¶å¤¾è¦–åœ–ï¼Œæ–‡ä»¶æ•¸é‡:', files.length);
            
            // ç²å–ç•¶å‰æ–‡æª”é¡å‹
            const hash = window.location.hash.substring(1);
            const currentDocType = hash || 'bank-statement';
            
            console.log('ğŸ“Š ç•¶å‰æ–‡ä»¶å¤¾ç‹€æ…‹:', {
                documentType: currentDocType,
                filesToAdd: files.length
            });
            
            // å¾localStorageç²å–ç•¶å‰æ–‡æª”é¡å‹çš„æ–‡ä»¶åˆ—è¡¨
            const storageKey = `vaultcaddy_files_${currentDocType}`;
            let existingFiles = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileId = `${currentDocType}_${Date.now()}_${i}`;
                const currentDate = new Date().toLocaleDateString('zh-TW');
                
                console.log(`ğŸ“„ è™•ç†æ–‡ä»¶ ${i + 1}/${files.length}:`, {
                    name: file.name,
                    size: file.size,
                    fileId: fileId,
                    documentType: currentDocType
                });
                
                // ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°localStorageï¼ˆæŒ‰æ–‡æª”é¡å‹åˆ†é›¢ï¼‰
                const fileInfo = {
                    id: fileId,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    documentType: currentDocType,
                    uploadDate: currentDate,
                    status: 'processing'
                };
                existingFiles.push(fileInfo);
                
                console.log(`âœ… æ–‡ä»¶ ${file.name} å·²æ·»åŠ åˆ°å­˜å„² (${currentDocType})`);
            }
            
            // ä¿å­˜æ›´æ–°å¾Œçš„æ–‡ä»¶åˆ—è¡¨åˆ°localStorage
            localStorage.setItem(storageKey, JSON.stringify(existingFiles));
            
            console.log(`ğŸ‰ æ‰€æœ‰ ${files.length} å€‹æ–‡ä»¶å·²æˆåŠŸæ·»åŠ åˆ°å­˜å„² (${currentDocType})`);
            console.log('ğŸ“Š å­˜å„²æœ€çµ‚ç‹€æ…‹:', {
                storageKey: storageKey,
                totalStoredFiles: existingFiles.length
            });
            
            // é‡æ–°è¼‰å…¥æ–‡ä»¶å¤¾è¦–åœ–
            loadFilesForDocumentType(currentDocType);
            
            // æ›´æ–°çµ±è¨ˆ
            updateDocumentStats();
        }
        
        function updateDocumentStats() {
            // æ›´æ–°æ–‡æª”è™•ç†çµ±è¨ˆ
            const documentRows = document.querySelectorAll('.document-row');
            const processedCount = documentRows.length;
            const statsElement = document.querySelector('[data-stat="processed-docs"]');
            if (statsElement) {
                statsElement.textContent = processedCount;
            }
            
            // æ›´æ–°å´é‚Šæ¬„çµ±è¨ˆ
            console.log(`ğŸ“Š æ›´æ–°æ–‡æª”çµ±è¨ˆ: ${processedCount} å€‹æ–‡æª”`);
        }
        
        function updateSidebarStats(newFileCount) {
            // æ›´æ–°å´é‚Šæ¬„çš„è™•ç†æ–‡æª”æ•¸é‡
            const processedElement = document.querySelector('.stat-value');
            if (processedElement && processedElement.textContent.includes('Processed Documents')) {
                const currentCount = parseInt(processedElement.textContent) || 0;
                processedElement.textContent = currentCount + newFileCount;
                console.log(`ğŸ“Š å´é‚Šæ¬„çµ±è¨ˆå·²æ›´æ–°: +${newFileCount} å€‹æ–‡æª”`);
            }
        }
        
        function showLoginPromptInDashboard() {
            console.log('ğŸ’¡ åœ¨ Dashboard ä¸­é¡¯ç¤ºç™»å…¥æç¤ºè€Œä¸æ˜¯é‡å®šå‘');
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨æç¤º
            const existing = document.getElementById('dashboard-login-prompt');
            if (existing) return;
            
            // åœ¨é é¢é ‚éƒ¨é¡¯ç¤ºä¸€å€‹æº«å’Œçš„ç™»å…¥æç¤º
            const notification = document.createElement('div');
            notification.id = 'dashboard-login-prompt';
            notification.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; background: #fef3c7; border-bottom: 1px solid #f59e0b; padding: 0.75rem; z-index: 1000; text-align: center;">
                    <p style="margin: 0; color: #92400e;">
                        <i class="fas fa-info-circle"></i> 
                        ç‚ºäº†ç²å¾—å®Œæ•´åŠŸèƒ½ï¼Œè«‹ <a href="auth.html" style="color: #b45309; text-decoration: underline;">é‡æ–°ç™»å…¥</a> æˆ– 
                        <button onclick="window.location.reload()" style="background: #f59e0b; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">é‡æ–°è¼‰å…¥é é¢</button>
                        <button onclick="document.getElementById('dashboard-login-prompt').remove(); adjustPageMargin(false);" style="background: transparent; border: none; color: #92400e; margin-left: 1rem;">âœ•</button>
                    </p>
                </div>
            `;
            document.body.insertBefore(notification, document.body.firstChild);
            
            // èª¿æ•´é é¢å…§å®¹å‘ä¸‹åç§»
            adjustPageMargin(true);
        }
        
        function hideLoginPromptInDashboard() {
            const existing = document.getElementById('dashboard-login-prompt');
            if (existing) {
                existing.remove();
                adjustPageMargin(false);
                console.log('âœ… Dashboard ç™»å…¥æç¤ºå·²ç§»é™¤');
            }
        }
        
        function adjustPageMargin(hasPrompt) {
            const mainContent = document.querySelector('.dashboard-container');
            if (mainContent) {
                mainContent.style.marginTop = hasPrompt ? '60px' : '0px';
            }
        }
        
        // æ›´æ–° Dashboard èº«ä»½é©—è­‰ç‹€æ…‹
        function updateDashboardAuthState(authState) {
            console.log('ğŸ”„ æ›´æ–° Dashboard èº«ä»½é©—è­‰ç‹€æ…‹:', authState);
            
            if (authState.isAuthenticated) {
                // ç”¨æˆ¶å·²ç™»å…¥ï¼Œç§»é™¤ç™»å…¥æç¤º
                hideLoginPromptInDashboard();
                
                // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º
                updateUserInfoDisplay(authState);
                
                console.log('âœ… Dashboard èªè­‰ç‹€æ…‹: å·²ç™»å…¥');
            } else {
                // ç”¨æˆ¶æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æç¤º
                showLoginPromptInDashboard();
                console.log('âš ï¸ Dashboard èªè­‰ç‹€æ…‹: æœªç™»å…¥');
            }
        }
        
        function updateUserInfoDisplay(authState) {
            // æ›´æ–°é é¢ä¸­çš„ç”¨æˆ¶ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (authState.userEmail || authState.credits) {
                console.log('ğŸ“Š æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º:', {
                    email: authState.userEmail,
                    credits: authState.credits
                });
                
                // è§¸ç™¼å°èˆªæ¬„æ›´æ–°
                if (window.VaultCaddyNavbar && window.VaultCaddyNavbar.loadUserState) {
                    window.VaultCaddyNavbar.loadUserState();
                }
            }
        }

        function toggleView() {
            alert('View toggle functionality will be implemented.');
        }

        function showActionMenu(event, documentId) {
            alert(`Action menu for ${documentId} will be shown here.`);
        }

        // åˆªé™¤äº¤æ˜“è¡Œ
        function deleteTransaction(button) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“å—ï¼Ÿ')) {
                const row = button.closest('tr');
                row.remove();
                
                // é‡æ–°è¨ˆç®—é¤˜é¡
                recalculateBalances();
            }
        }
        
        // é‡æ–°è¨ˆç®—æ‰€æœ‰é¤˜é¡
        function recalculateBalances() {
            const rows = document.querySelectorAll('#transactions-tbody tr');
            let runningBalance = 0;
            
            rows.forEach((row, index) => {
                const amountInput = row.querySelector('.amount-input');
                const balanceInput = row.querySelector('.balance-input');
                
                if (amountInput && balanceInput) {
                    const amount = parseFloat(amountInput.value) || 0;
                    runningBalance += amount;
                    balanceInput.value = runningBalance.toFixed(2);
                }
            });
        }
        
        // ç›£è½é‡‘é¡è®ŠåŒ–ä¸¦è‡ªå‹•é‡æ–°è¨ˆç®—é¤˜é¡
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('amount-input')) {
                recalculateBalances();
            }
        });
        
        // æ¨™ç±¤åˆ‡æ›
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-btn')) {
                // ç§»é™¤æ‰€æœ‰æ´»èºç‹€æ…‹
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                // æ·»åŠ æ´»èºç‹€æ…‹åˆ°é»æ“Šçš„æ¨™ç±¤
                e.target.classList.add('active');
            }
        });
    </script>

    <!-- åŸå§‹ä¸Šå‚³æ¨¡æ…‹æ¡†å·²ç§»é™¤ï¼Œçµ±ä¸€ä½¿ç”¨LedgerBoxé¢¨æ ¼æ¨¡æ…‹æ¡† -->

    <style>
        /* ä¸Šå‚³æ¨¡æ…‹æ¡†æ¨£å¼ */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .modal-content {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .modal-close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .file-drop-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
            background: #f9fafb;
        }
        
        .file-drop-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .file-drop-area.has-files {
            border-style: solid;
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .file-list h4 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            text-align: left;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .file-item i {
            color: #ef4444;
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            color: #1f2937;
        }
        
        .file-size {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .remove-file-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .remove-file-btn:hover {
            background: #fef2f2;
            color: #ef4444;
        }
        
        .upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .file-types ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.5rem;
            color: #6b7280;
        }
        
        .processing-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .processing-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151;
            cursor: pointer;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        /* ç‹€æ…‹å¾½ç« æ¨£å¼ */
        .status-badge.processing {
            background: #fef3c7;
            color: #92400e;
        }
        
        .review-badge.pending {
            background: #fee2e2;
            color: #991b1b;
        }
        
        @media (max-width: 768px) {
            .upload-options {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // å‰µå»ºæ–‡æª”è¡¨æ ¼è¡Œ
        function createDocumentRow(tbody, file) {
            const row = document.createElement('tr');
            row.className = 'document-row';
            row.setAttribute('data-file-id', file.id);
            row.style.cssText = 'background: #ffffff; border-bottom: 1px solid #e5e7eb;';
            
            // å®‰å…¨åœ°ç²å–æ—¥æœŸï¼Œé¿å… Invalid Date
            let uploadDate = 'â€”';
            try {
                const dateValue = file.uploadTime || file.uploadDate || file.createdAt;
                if (dateValue) {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        uploadDate = date.toLocaleDateString('zh-TW');
                    }
                }
            } catch (e) {
                console.error('æ—¥æœŸè§£æéŒ¯èª¤:', e);
            }
            
            const fileSize = formatFileSize(file.size || file.fileSize || 0);
            
            // å¾ processedData ä¸­æå–çœŸå¯¦æ•¸æ“šï¼Œç¢ºä¿ä¸æœƒæ˜¯ undefined
            const data = file.processedData || {};
            
            // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è™•ç†ä¸­
            const isProcessing = file.isProcessing || file.status === 'Processing';
            const processingProgress = file.processingProgress || 0;
            
            // ç¢ºå®šæ–‡æª”é¡å‹
            const docType = data.documentType || 'Bank Statement';
            
            // Status
            const status = isProcessing ? 'In Progress' : (data.status || 'Success');
            const statusColor = status === 'Success' || status === 'Completed' ? '#10b981' : '#f59e0b';
            const statusIcon = status === 'Success' || status === 'Completed' ? 'âœ“' : 'â—';
            
            // Review Status
            const reviewStatus = isProcessing ? 'Processing' : (data.reviewStatus || 'Review');
            const reviewColor = reviewStatus === 'Approved' ? '#10b981' : '#f59e0b';
            
            // æ ¹æ“šæ–‡æª”é¡å‹ç”Ÿæˆä¸åŒçš„è¡Œå…§å®¹
            let rowHTML = '';
            if (docType === 'Invoice') {
                rowHTML = createInvoiceRowHTML(file, data, isProcessing, status, statusColor, statusIcon, reviewStatus, reviewColor, uploadDate);
            } else {
                // éŠ€è¡Œå°å¸³å–®å’Œå…¶ä»–é¡å‹ä½¿ç”¨åŸæœ‰çš„é¡¯ç¤ºæ ¼å¼
                // Statement Period
                const startDate = data.startDate || data.statementStartDate || 'â€”';
                const endDate = data.endDate || data.statementEndDate || 'â€”';
                const periodText = (startDate !== 'â€”' && endDate !== 'â€”') 
                    ? `${startDate} to ${endDate}` 
                    : isProcessing ? 'è™•ç†ä¸­...' : 'â€”';
                const transactionCount = data.transactions?.length || data.transactionCount || 0;
                const transactionsText = transactionCount > 0 
                    ? `${transactionCount} transactions` 
                    : isProcessing ? '' : 'â€”';
                
                // Reconciliation - å¦‚æœæ­£åœ¨è™•ç†ï¼Œåªé¡¯ç¤ºé€²åº¦ç™¾åˆ†æ¯”
                let reconciliationHTML;
                if (isProcessing) {
                    reconciliationHTML = `
                        <div>
                            <div style="font-weight: 500; color: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                                <span>${processingProgress}%</span>
                            </div>
                            <div style="margin-top: 0.25rem; background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #f59e0b; height: 100%; width: ${processingProgress}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `;
                } else {
                    const reconciledCount = data.reconciledTransactions || 0;
                    const totalTransactions = transactionCount;
                    const reconciledPercent = totalTransactions > 0 
                        ? Math.round((reconciledCount / totalTransactions) * 100) 
                        : 0;
                    reconciliationHTML = `
                        <div>
                            <div style="font-weight: 500; color: #1f2937;">${reconciledCount}/${totalTransactions}</div>
                            <div style="margin-top: 0.25rem; background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #3b82f6; height: 100%; width: ${reconciledPercent}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `;
                }
                
                // Balance Info
                const startBalance = data.startBalance || data.openingBalance || data.beginningBalance || 0;
                const endBalance = data.endBalance || data.closingBalance || data.endingBalance || 0;
                const formattedStartBalance = typeof startBalance === 'number' 
                    ? `$${startBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` 
                    : isProcessing ? 'â€”' : startBalance;
                const formattedEndBalance = typeof endBalance === 'number' 
                    ? `$${endBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` 
                    : isProcessing ? 'â€”' : endBalance;
                
                rowHTML = `
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <input type="checkbox" class="file-checkbox" onchange="updateSelection()">
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
                        <div>
                            <div style="font-weight: 500; color: #1f2937;">
                                <a href="javascript:void(0)" onclick="viewDocument('${file.id}')" style="color: #1f2937; text-decoration: none; cursor: pointer;">
                                    ${file.name || file.fileName || data.fileName || 'æœªå‘½åæ–‡ä»¶'}
                                </a>
                            </div>
                            <div style="font-size: 0.875rem; color: #6b7280;">${data.accountHolder || data.accountName || (isProcessing ? 'è™•ç†ä¸­...' : '')}</div>
                            <div style="font-size: 0.75rem; color: #9ca3af;">${data.accountNumber || ''}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">ğŸ“… ${periodText}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${transactionsText}</div>
                    </div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    ${reconciliationHTML}
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Start: ${formattedStartBalance}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">End: ${formattedEndBalance}</div>
                    </div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background: ${statusColor}15; color: ${statusColor};">
                        ${statusIcon} ${status}
                    </span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background: ${reviewColor}15; color: ${reviewColor};">
                        â— ${reviewStatus}
                    </span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="color: #6b7280; font-size: 0.875rem;">${data.notes || 'â€”'}</span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="color: #6b7280; font-size: 0.875rem;">${uploadDate}</span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="viewDocument('${file.id}')" style="padding: 0.5rem; background: transparent; border: none; color: #6b7280; cursor: pointer; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'; this.style.color='#1f2937'" onmouseout="this.style.background='transparent'; this.style.color='#6b7280'" title="æŸ¥çœ‹">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteDocument('${file.id}')" style="padding: 0.5rem; background: transparent; border: none; color: #6b7280; cursor: pointer; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2'; this.style.color='#ef4444'" onmouseout="this.style.background='transparent'; this.style.color='#6b7280'" title="åˆªé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="openActionMenu('${file.id}', event)" style="padding: 0.5rem; background: transparent; border: none; color: #6b7280; cursor: pointer; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'; this.style.color='#1f2937'" onmouseout="this.style.background='transparent'; this.style.color='#6b7280'" title="æ›´å¤š">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </td>
            `;
            }
            
            row.innerHTML = rowHTML;
            tbody.appendChild(row);
            console.log('âœ… æ–‡ä»¶è¡Œå·²æ·»åŠ åˆ°è¡¨æ ¼:', file.name || file.fileName, 'é¡å‹:', docType);
        }
        
        // å‰µå»ºç™¼ç¥¨è¡Œ
        function createInvoiceRowHTML(file, data, isProcessing, status, statusColor, statusIcon, reviewStatus, reviewColor, uploadDate) {
            // å¾ AI æå–çš„æ•¸æ“šä¸­ç²å–æ¬„ä½ï¼ˆå„ªå…ˆä½¿ç”¨ snake_caseï¼Œå› ç‚º DeepSeek è¿”å›çš„æ˜¯é€™ç¨®æ ¼å¼ï¼‰
            const invoiceNumber = data.invoice_number || data.invoiceNumber || 'â€”';
            const issueDate = data.date || data.invoice_date || data.issueDate || (isProcessing ? 'è™•ç†ä¸­...' : 'â€”');
            const vendorName = data.supplier || data.vendor?.name || data.vendor || (isProcessing ? 'è™•ç†ä¸­...' : 'â€”');
            const customerName = data.customer || data.customer?.name || (isProcessing ? 'è™•ç†ä¸­...' : 'â€”');
            const items = data.items || data.lineItems || [];
            const itemCount = items.length || data.itemCount || 0;
            const subtotal = parseFloat(data.subtotal) || 0;
            const discount = parseFloat(data.discount) || 0;
            const totalAmount = parseFloat(data.total) || parseFloat(data.totalAmount) || 0;
            const currency = data.currency || 'HKD';
            const paymentMethod = data.payment_method || data.paymentMethod || 'â€”';
            
            return `
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <input type="checkbox" class="file-checkbox" onchange="updateSelection()">
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-file-invoice" style="color: #3b82f6;"></i>
                        <div>
                            <div style="font-weight: 500; color: #1f2937;">
                                <a href="javascript:void(0)" onclick="viewDocument('${file.id}')" style="color: #1f2937; text-decoration: none; cursor: pointer;">
                                    ğŸ“„ Invoice â€”
                                </a>
                            </div>
                            <div style="font-size: 0.875rem; color: #6b7280;">ä¾›æ‡‰å•†: ${vendorName}</div>
                            <div style="font-size: 0.75rem; color: #9ca3af;">å®¢æˆ¶: ${customerName}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">ğŸ“… ${issueDate}</div>
                    </div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="font-weight: 500; color: #1f2937;">${itemCount} é …å•†å“</div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div>
                        <div style="font-size: 0.875rem; color: #6b7280;">å°è¨ˆ: ${currency} $${subtotal.toFixed(2)}</div>
                        ${discount > 0 ? `<div style="font-size: 0.875rem; color: #10b981;">æŠ˜æ‰£: -$${discount.toFixed(2)}</div>` : ''}
                        <div style="font-weight: 500; color: #1f2937;">ç¸½é¡: ${currency} $${totalAmount.toFixed(2)}</div>
                    </div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background: ${statusColor}15; color: ${statusColor};">
                        ${statusIcon} ${status}
                    </span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background: ${reviewColor}15; color: ${reviewColor};">
                        â— ${reviewStatus}
                    </span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="color: #6b7280; font-size: 0.875rem;">${paymentMethod}</span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <span style="color: #6b7280; font-size: 0.875rem;">${uploadDate}</span>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="viewDocument('${file.id}')" style="padding: 0.5rem; background: transparent; border: none; color: #6b7280; cursor: pointer; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'; this.style.color='#1f2937'" onmouseout="this.style.background='transparent'; this.style.color='#6b7280'" title="æŸ¥çœ‹">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteDocument('${file.id}')" style="padding: 0.5rem; background: transparent; border: none; color: #6b7280; cursor: pointer; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2'; this.style.color='#ef4444'" onmouseout="this.style.background='transparent'; this.style.color='#6b7280'" title="åˆªé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="openActionMenu('${file.id}', event)" style="padding: 0.5rem; background: transparent; border: none; color: #6b7280; cursor: pointer; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'; this.style.color='#1f2937'" onmouseout="this.style.background='transparent'; this.style.color='#6b7280'" title="æ›´å¤š">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </td>
            `;
        }
        
        // æ›´æ–°åˆ†é ä¿¡æ¯
        function updatePaginationInfo(totalRows) {
            const selectionInfo = document.getElementById('selection-info');
            const pageInfo = document.getElementById('page-info');
            
            if (selectionInfo) {
                selectionInfo.textContent = `0 of ${totalRows} row(s) selected.`;
            }
            
            if (pageInfo) {
                const totalPages = Math.ceil(totalRows / 10);
                pageInfo.textContent = `Page 1 of ${totalPages}`;
            }
        }
        
        // åˆ†é æ§åˆ¶å‡½æ•¸
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const fileCheckboxes = document.querySelectorAll('.file-checkbox');
            
            fileCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelection();
        }
        
        function updateSelection() {
            const fileCheckboxes = document.querySelectorAll('.file-checkbox');
            const checkedBoxes = document.querySelectorAll('.file-checkbox:checked');
            const selectionInfo = document.getElementById('selection-info');
            
            if (selectionInfo) {
                selectionInfo.textContent = `${checkedBoxes.length} of ${fileCheckboxes.length} row(s) selected.`;
            }
        }
        
        function changeRowsPerPage() {
            const rowsPerPage = document.getElementById('rows-per-page').value;
            console.log('æ›´æ”¹æ¯é è¡Œæ•¸:', rowsPerPage);
            // é‡æ–°è¼‰å…¥ç•¶å‰æ–‡æª”é¡å‹
            const currentDocType = getCurrentDocumentType();
            loadFilesForDocumentType(currentDocType);
        }
        
        function goToFirstPage() {
            console.log('å‰å¾€ç¬¬ä¸€é ');
        }
        
        function goToPreviousPage() {
            console.log('å‰å¾€ä¸Šä¸€é ');
        }
        
        function goToNextPage() {
            console.log('å‰å¾€ä¸‹ä¸€é ');
        }
        
        function goToLastPage() {
            console.log('å‰å¾€æœ€å¾Œä¸€é ');
        }
        
        // æ–‡æª”æ“ä½œå‡½æ•¸
        function viewDocument(fileId) {
            console.log('æŸ¥çœ‹æ–‡æª”:', fileId);
            // è·³è½‰åˆ°æ–‡æª”è©³æƒ…é é¢
            const projectId = getCurrentProjectId();
            window.location.href = `document-detail.html?id=${fileId}&project=${projectId}`;
        }
        
        function downloadDocument(fileId) {
            console.log('ä¸‹è¼‰æ–‡æª”:', fileId);
            // å¯¦ç¾ä¸‹è¼‰åŠŸèƒ½
        }
        
        function deleteDocument(fileId) {
            console.log('ğŸ—‘ï¸ æº–å‚™åˆªé™¤æ–‡æª”:', fileId);
            
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ–‡æª”å—ï¼Ÿ')) {
                console.log('âŒ ç”¨æˆ¶å–æ¶ˆåˆªé™¤');
                return;
            }
            
            try {
                // 1. ç²å–ç•¶å‰é …ç›® ID
                const projectId = getCurrentProjectId();
                if (!projectId) {
                    console.error('âŒ ç„¡æ³•ç²å–é …ç›® ID');
                    alert('ç„¡æ³•åˆªé™¤æ–‡æª”ï¼šæ‰¾ä¸åˆ°é …ç›® ID');
                    return;
                }
                
                console.log('ğŸ“‚ é …ç›® ID:', projectId);
                
                // 2. å¾ localStorage ä¸­åˆªé™¤æ–‡æª”
                const storageKey = `vaultcaddy_project_${projectId}_documents`;
                const documents = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                console.log('ğŸ“„ åˆªé™¤å‰æ–‡æª”æ•¸é‡:', documents.length);
                
                // æ‰¾åˆ°ä¸¦åˆªé™¤æ–‡æª”
                const filteredDocuments = documents.filter(doc => doc.id !== fileId);
                
                if (filteredDocuments.length === documents.length) {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°è¦åˆªé™¤çš„æ–‡æª”:', fileId);
                    alert('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„æ–‡æª”');
                    return;
                }
                
                // ä¿å­˜æ›´æ–°å¾Œçš„æ–‡æª”åˆ—è¡¨
                localStorage.setItem(storageKey, JSON.stringify(filteredDocuments));
                console.log('âœ… æ–‡æª”å·²å¾å­˜å„²ä¸­åˆªé™¤ï¼Œå‰©é¤˜æ–‡æª”æ•¸é‡:', filteredDocuments.length);
                
                // 3. å¾ DOM ä¸­ç§»é™¤è¡Œ
                const row = document.querySelector(`[data-file-id="${fileId}"]`);
                if (row) {
                    row.remove();
                    console.log('âœ… æ–‡æª”è¡Œå·²å¾ DOM ä¸­ç§»é™¤');
                }
                
                // 4. æ›´æ–°çµ±è¨ˆå’Œç©ºç‹€æ…‹
                updateDocumentStats();
                updatePaginationInfo(filteredDocuments.length);
                
                // 5. å¦‚æœæ²’æœ‰æ–‡æª”äº†ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
                if (filteredDocuments.length === 0) {
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) {
                        emptyState.style.display = 'block';
                        console.log('ğŸ“­ é¡¯ç¤ºç©ºç‹€æ…‹');
                    }
                }
                
                console.log('ğŸ‰ æ–‡æª”åˆªé™¤æˆåŠŸï¼');
                
            } catch (error) {
                console.error('âŒ åˆªé™¤æ–‡æª”æ™‚å‡ºéŒ¯:', error);
                alert('åˆªé™¤æ–‡æª”å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // èª¿è©¦å‡½æ•¸ï¼šç¢ºä¿é é¢å…§å®¹å¯è¦‹
        function ensurePageContentVisible() {
            console.log('ğŸ” æª¢æŸ¥é é¢å…§å®¹å¯è¦‹æ€§...');
            
            const mainContent = document.getElementById('main-content');
            const listView = document.getElementById('document-list-view');
            const documentsTable = document.getElementById('documents-table');
            const emptyState = document.getElementById('empty-state');
            
            console.log('ä¸»å…§å®¹å€åŸŸ:', mainContent ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            console.log('åˆ—è¡¨è¦–åœ–:', listView ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            console.log('æ–‡æª”è¡¨æ ¼:', documentsTable ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            console.log('ç©ºç‹€æ…‹:', emptyState ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            
            if (mainContent) {
                mainContent.style.display = 'block';
                mainContent.style.visibility = 'visible';
            }
            
            if (listView) {
                listView.style.display = 'block';
                listView.style.visibility = 'visible';
            }
            
            // ç¢ºä¿è‡³å°‘é¡¯ç¤ºç©ºç‹€æ…‹
            if (emptyState) {
                emptyState.style.display = 'block';
                emptyState.style.visibility = 'visible';
            }
            
            console.log('âœ… é é¢å…§å®¹å¯è¦‹æ€§æª¢æŸ¥å®Œæˆ');
        }

        // å°èˆªåˆ°Team Projectè¦–åœ–
        function navigateToTeamProject() {
            console.log('ğŸ”„ åˆ‡æ›åˆ°Team Projectè¦–åœ–');
            
            // éš±è—æ‰€æœ‰è¦–åœ–
            const allViews = document.querySelectorAll('.view-container');
            allViews.forEach(view => {
                view.style.display = 'none';
            });
            
            // é¡¯ç¤ºTeam Projectè¦–åœ–
            const teamProjectView = document.getElementById('team-project-view');
            if (teamProjectView) {
                teamProjectView.style.display = 'block';
            }
            
            // æ›´æ–°å´é‚Šæ¬„æ´»èºç‹€æ…‹
            updateSidebarActiveState('team-project');
            
            // æ›´æ–°å°èˆªæ¬„æ¨™é¡Œ
            updateNavbarTitle('Team Project');
            
            console.log('âœ… å·²åˆ‡æ›åˆ°Team Projectè¦–åœ–');
        }
        
        // å°èˆªåˆ°éŠ€è¡Œå°å¸³å–®è¦–åœ–
        function navigateToBankStatement() {
            console.log('ğŸ”„ åˆ‡æ›åˆ°éŠ€è¡Œå°å¸³å–®è¦–åœ–');
            
            // éš±è—æ‰€æœ‰è¦–åœ–
            const allViews = document.querySelectorAll('.view-container');
            allViews.forEach(view => {
                view.style.display = 'none';
            });
            
            // é¡¯ç¤ºéŠ€è¡Œå°å¸³å–®è¦–åœ–
            const bankStatementView = document.getElementById('bank-statement-view');
            if (bankStatementView) {
                bankStatementView.style.display = 'block';
            }
            
            // æ›´æ–°å´é‚Šæ¬„æ´»èºç‹€æ…‹
            updateSidebarActiveState('bank-statement');
            
            // æ›´æ–°å°èˆªæ¬„æ¨™é¡Œ
            updateNavbarTitle('å„€è¡¨æ¿');
            
            console.log('âœ… å·²åˆ‡æ›åˆ°éŠ€è¡Œå°å¸³å–®è¦–åœ–');
        }
        
        // æ›´æ–°å´é‚Šæ¬„æ´»èºç‹€æ…‹
        function updateSidebarActiveState(activeView) {
            // ç§»é™¤æ‰€æœ‰æ´»èºç‹€æ…‹
            const allItems = document.querySelectorAll('.project-item, .config-item');
            allItems.forEach(item => {
                item.style.background = 'transparent';
                item.style.color = '#6b7280';
            });
            
            // è¨­ç½®ç•¶å‰æ´»èºé …ç›®
            if (activeView === 'team-project') {
                const teamProjectItem = document.getElementById('team-project-item');
                if (teamProjectItem) {
                    teamProjectItem.style.background = '#eff6ff';
                    teamProjectItem.style.color = '#3b82f6';
                }
            }
        }
        
        // æ›´æ–°å°èˆªæ¬„æ¨™é¡Œ
        function updateNavbarTitle(title) {
            const navbarTitle = document.getElementById('navbar-page-title');
            if (navbarTitle) {
                navbarTitle.textContent = title;
            }
        }
        
    </script>

    <script>
        // åœ¨çª—å£å®Œå…¨è¼‰å…¥å¾Œæª¢æŸ¥æ¨¡æ…‹æ¡†
        window.addEventListener('load', function() {
            console.log('ğŸ¯ Window Load äº‹ä»¶è§¸ç™¼ - é é¢å®Œå…¨è¼‰å…¥');
            const modalCheck = document.getElementById('aiUploadModal');
            console.log('ğŸ” Window Load æ™‚æ¨¡æ…‹æ¡†æª¢æŸ¥:', modalCheck ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
            
            if (!modalCheck) {
                console.error('âŒâŒâŒ åš´é‡å•é¡Œï¼šçª—å£å®Œå…¨è¼‰å…¥å¾Œæ¨¡æ…‹æ¡†ä»ä¸å­˜åœ¨ï¼');
                console.error('ğŸ“Š DOM å®Œæ•´çµ±è¨ˆ:', {
                    ç¸½å…ƒç´ æ•¸: document.getElementsByTagName('*').length,
                    æ‰€æœ‰divæ•¸é‡: document.getElementsByTagName('div').length,
                    bodyå­å…ƒç´ æ•¸: document.body.children.length
                });
                console.error('ğŸ” å˜—è©¦æŸ¥æ‰¾æ‰€æœ‰ id åŒ…å« Upload çš„å…ƒç´ :');
                const allElements = document.querySelectorAll('[id*="pload"], [id*="Upload"]');
                console.error('æ‰¾åˆ°çš„å…ƒç´ :', allElements.length);
                allElements.forEach(el => console.error('  - ID:', el.id, 'Tag:', el.tagName));
                
                // åˆ—å‡º body çš„æœ€å¾Œ 10 å€‹å­å…ƒç´ 
                console.error('ğŸ“‹ Body çš„æœ€å¾Œ 10 å€‹å­å…ƒç´ :');
                const bodyChildren = Array.from(document.body.children);
                bodyChildren.slice(-10).forEach((el, i) => {
                    console.error(`  ${i}: <${el.tagName}> id="${el.id}" class="${el.className}"`);
                });
            } else {
                console.log('âœ…âœ…âœ… æ¨¡æ…‹æ¡†åœ¨ Window Load å¾Œç¢ºèªå­˜åœ¨ï¼');
                console.log('ğŸ“‹ æ¨¡æ…‹æ¡†å®Œæ•´ä¿¡æ¯:', {
                    id: modalCheck.id,
                    tagName: modalCheck.tagName,
                    className: modalCheck.className,
                    display: window.getComputedStyle(modalCheck).display,
                    visibility: window.getComputedStyle(modalCheck).visibility,
                    zIndex: window.getComputedStyle(modalCheck).zIndex
                });
            }
        });
        
        // ========== å‰µå»ºé …ç›®æ¨¡æ…‹æ¡†å‡½æ•¸ ==========
        
        // æ‰“é–‹å‰µå»ºé …ç›®æ¨¡æ…‹æ¡†
        function openCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            if (!modal) {
                console.error('âŒ æ‰¾ä¸åˆ°å‰µå»ºé …ç›®æ¨¡æ…‹æ¡†');
                // å¦‚æœåœ¨ firstproject.htmlï¼Œè·³è½‰åˆ° dashboard.html
                if (window.location.pathname.includes('firstproject.html')) {
                    window.location.href = 'dashboard.html';
                }
                return;
            }
            const input = document.getElementById('projectName');
            modal.classList.add('active');
            if (input) {
                input.value = '';
                input.focus();
            }
        }
        
        // é—œé–‰å‰µå»ºé …ç›®æ¨¡æ…‹æ¡†
        function closeCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // å‰µå»ºæ–°é …ç›®
        function createProject() {
            const input = document.getElementById('projectName');
            if (!input) return;
            
            const projectName = input.value.trim();
            
            if (!projectName) {
                alert('è«‹è¼¸å…¥é …ç›®åç¨±');
                return;
            }
            
            // å‰µå»ºæ–°é …ç›®å°è±¡
            const newProject = {
                id: 'project-' + Date.now(),
                name: projectName,
                thumbnail: null,
                lastModified: new Date().toISOString(),
                created: new Date().toISOString()
            };
            
            // ç²å–ç¾æœ‰é …ç›®
            const projects = JSON.parse(localStorage.getItem('vaultcaddy_projects') || '[]');
            
            // æ·»åŠ æ–°é …ç›®åˆ°åˆ—è¡¨é–‹é ­
            projects.unshift(newProject);
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('vaultcaddy_projects', JSON.stringify(projects));
            
            console.log('âœ… æ–°é …ç›®å·²å‰µå»º:', newProject);
            
            // è§¸ç™¼é …ç›®å‰µå»ºäº‹ä»¶ï¼Œè®“å´é‚Šæ¬„æ›´æ–°
            window.dispatchEvent(new CustomEvent('projectCreated', { 
                detail: newProject 
            }));
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            closeCreateProjectModal();
            
            // è·³è½‰åˆ°æ–°é …ç›®é é¢
            window.location.href = `firstproject.html?project=${newProject.id}`;
        }
        
        // ä½¿å‡½æ•¸å…¨å±€å¯ç”¨
        window.openCreateProjectModal = openCreateProjectModal;
        window.closeCreateProjectModal = closeCreateProjectModal;
        window.createProject = createProject;
    </script>
    
    <!-- å‰µå»ºé …ç›®æ¨¡æ…‹æ¡† -->
    <div class="modal-overlay" id="createProjectModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <h2 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin: 0;">Create New Project</h2>
                <button class="modal-close" onclick="closeCreateProjectModal()" style="background: none; border: none; color: #6b7280; cursor: pointer; font-size: 1.5rem; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" for="projectName" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Project Name</label>
                    <input 
                        type="text" 
                        id="projectName" 
                        class="form-input" 
                        placeholder="Enter project name..."
                        onkeypress="if(event.key === 'Enter') createProject()"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; transition: border-color 0.2s;"
                    >
                </div>
                <div class="modal-actions" style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button onclick="closeCreateProjectModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background 0.2s;">
                        Cancel
                    </button>
                    <button onclick="createProject()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background 0.2s;">
                        Create
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        .modal-overlay.active {
            display: flex !important;
        }
        
        .modal-close:hover {
            background: #f3f4f6;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        /* å°å‡ºèœå–®æ¨£å¼ */
        .export-menu-item:hover {
            background: #f9fafb !important;
        }
    </style>
    
    <script>
        // ==================== å°å‡ºåŠŸèƒ½ ====================
        
        /**
         * åˆ‡æ›å°å‡ºèœå–®
         */
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                // é»æ“Šå¤–éƒ¨é—œé–‰èœå–®
                setTimeout(() => {
                    document.addEventListener('click', closeExportMenuOnClickOutside);
                }, 0);
            } else {
                menu.style.display = 'none';
                document.removeEventListener('click', closeExportMenuOnClickOutside);
            }
        }
        
        /**
         * é»æ“Šå¤–éƒ¨é—œé–‰èœå–®
         */
        function closeExportMenuOnClickOutside(event) {
            const menu = document.getElementById('exportMenu');
            const button = event.target.closest('button[onclick="toggleExportMenu()"]');
            
            if (!menu.contains(event.target) && !button) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeExportMenuOnClickOutside);
            }
        }
        
        /**
         * å°å‡ºæ–‡æª”
         */
        async function exportDocuments(format) {
            console.log(`ğŸ“¤ é–‹å§‹å°å‡º (${format})...`);
            
            // é—œé–‰èœå–®
            document.getElementById('exportMenu').style.display = 'none';
            document.removeEventListener('click', closeExportMenuOnClickOutside);
            
            try {
                // ç²å–ç•¶å‰é …ç›®çš„æ‰€æœ‰æ–‡æª”
                const projectId = new URLSearchParams(window.location.search).get('project');
                if (!projectId) {
                    alert('ç„¡æ³•ç²å–é …ç›® ID');
                    return;
                }
                
                const storageKey = `vaultcaddy_project_${projectId}_documents`;
                const documents = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                // éæ¿¾å‡ºç™¼ç¥¨å’Œæ”¶æ“š
                const invoices = documents.filter(doc => {
                    const docType = doc.processedData?.documentType || '';
                    return docType === 'Invoice' || docType === 'Receipt';
                });
                
                if (invoices.length === 0) {
                    alert('æ²’æœ‰å¯å°å‡ºçš„ç™¼ç¥¨æˆ–æ”¶æ“š');
                    return;
                }
                
                console.log(`   æ‰¾åˆ° ${invoices.length} å¼µç™¼ç¥¨/æ”¶æ“š`);
                
                // ä½¿ç”¨ ExportManager å°å‡º
                const blob = await window.exportManager.exportInvoices(invoices, format);
                
                // ç”Ÿæˆæ–‡ä»¶å
                const projectName = getProjectName(projectId);
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `${projectName}_invoices_${timestamp}.${format}`;
                
                // ä¸‹è¼‰æ–‡ä»¶
                window.exportManager.downloadFile(blob, filename);
                
                // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`âœ… æˆåŠŸå°å‡º ${invoices.length} å¼µç™¼ç¥¨ï¼\n\næ–‡ä»¶: ${filename}\næ ¼å¼: ${format.toUpperCase()}`);
                
            } catch (error) {
                console.error('âŒ å°å‡ºå¤±æ•—:', error);
                alert(`å°å‡ºå¤±æ•—: ${error.message}`);
            }
        }
        
        /**
         * ç²å–é …ç›®åç¨±
         */
        function getProjectName(projectId) {
            const projects = JSON.parse(localStorage.getItem('vaultcaddy_projects') || '[]');
            const project = projects.find(p => p.id === projectId);
            return project ? project.name : 'project';
        }
        
        // ç¢ºä¿å°å‡ºåŠŸèƒ½å…¨å±€å¯ç”¨
        window.toggleExportMenu = toggleExportMenu;
        window.exportDocuments = exportDocuments;
    </script>

</body>
</html>
