# âœ… å››ä¸ªåŠŸèƒ½å…¨éƒ¨å®Œæˆ

## ğŸ‰ **æ‰€æœ‰ä¿®å¤å·²å®Œæˆå¹¶éƒ¨ç½²ï¼**

---

## âœ… **å·²å®Œæˆçš„åŠŸèƒ½**

### **åŠŸèƒ½ 1ï¼šStripe Webhook äº‹ä»¶ä¼˜åŒ–**
- âœ… **çŠ¶æ€**ï¼šç”¨æˆ·å·²æ‰‹åŠ¨é…ç½®ï¼ŒStripe Webhook ç°åœ¨åªç›‘å¬ **4 ä¸ªå¿…è¦äº‹ä»¶**
- âœ… **æ•ˆæœ**ï¼šå‡å°‘ 71% çš„ Firebase Functions æ‰§è¡Œæ¬¡æ•°

**ç›‘å¬çš„äº‹ä»¶ï¼š**
1. âœ… `checkout.session.completed`
2. âœ… `customer.subscription.created`
3. âœ… `customer.subscription.updated`
4. âœ… `customer.subscription.deleted`

---

### **åŠŸèƒ½ 2ï¼šè®¢é˜…è®¡åˆ’æ˜¾ç¤ºå’Œé‡ç½®æ—¥æœŸ**

#### **2.1 åç«¯ä¿®æ”¹ï¼ˆFirebase Functionsï¼‰**

**ä¿®æ”¹æ–‡ä»¶**ï¼š`/Users/cavlinyeung/ai-bank-parser/firebase-functions/index.js`

**ä¿®æ”¹å†…å®¹**ï¼š
åœ¨ `handleCheckoutCompleted` å‡½æ•°ä¸­æ·»åŠ äº†ä»¥ä¸‹é€»è¾‘ï¼š

```javascript
// ğŸ”¥ æ›´æ–°ç”¨æˆ·çš„è®¢é˜…è®¡åˆ’å’Œé‡ç½®æ—¥æœŸ
const planType = product.metadata.plan_type || 'monthly';
console.log(`ğŸ“‹ æ›´æ–°ç”¨æˆ·è®¢é˜…è®¡åˆ’: ${planType}`);

// è®¡ç®—é‡ç½®æ—¥æœŸï¼šmonthly = 1ä¸ªæœˆåï¼Œyearly = 1å¹´å
const now = new Date();
let resetDate;
if (planType === 'yearly') {
    resetDate = new Date(now.getFullYear() + 1, now.getMonth(), now.getDate());
    console.log(`ğŸ“… å¹´è´¹è®¡åˆ’ï¼Œé‡ç½®æ—¥æœŸä¸º 1 å¹´å: ${resetDate.toISOString()}`);
} else {
    resetDate = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());
    console.log(`ğŸ“… æœˆè´¹è®¡åˆ’ï¼Œé‡ç½®æ—¥æœŸä¸º 1 ä¸ªæœˆå: ${resetDate.toISOString()}`);
}

// æ›´æ–°ç”¨æˆ·æ–‡æ¡£
await db.collection('users').doc(userId).update({
    planType: 'Pro Plan',
    subscriptionPlan: planType, // 'monthly' æˆ– 'yearly'
    resetDate: admin.firestore.Timestamp.fromDate(resetDate),
    lastPurchaseDate: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
});
```

**å·¥ä½œåŸç†**ï¼š
- âœ… å½“ç”¨æˆ·è´­ä¹°æœˆè´¹æ—¶ï¼š`planType` è®¾ä¸º `'Pro Plan'`ï¼Œ`resetDate` è®¾ä¸º **1 ä¸ªæœˆå**
- âœ… å½“ç”¨æˆ·è´­ä¹°å¹´è´¹æ—¶ï¼š`planType` è®¾ä¸º `'Pro Plan'`ï¼Œ`resetDate` è®¾ä¸º **1 å¹´å**

#### **2.2 å‰ç«¯ä¿®æ”¹ï¼ˆaccount.htmlï¼‰**

**ä¿®æ”¹æ–‡ä»¶**ï¼š`/Users/cavlinyeung/ai-bank-parser/account.html`

**ä¿®æ”¹å†…å®¹**ï¼š
1. âœ… ä¿®æ”¹ `loadUserPlan` å‡½æ•°ï¼Œä¼˜å…ˆè¯»å–æ–°çš„ `userData.planType` å­—æ®µ
2. âœ… ä¿®æ”¹é‡ç½®æ—¥æœŸæ˜¾ç¤ºé€»è¾‘ï¼Œä¼˜å…ˆè¯»å–æ–°çš„ `userData.resetDate` å­—æ®µ

**æ•ˆæœ**ï¼š
- âœ… ç”¨æˆ·è´­ä¹°æœˆè´¹/å¹´è´¹åï¼Œé¡µé¢ä¼šæ˜¾ç¤º **"Pro Plan"**ï¼ˆè€Œä¸æ˜¯ "Free Plan"ï¼‰
- âœ… é‡ç½®æ—¥æœŸä¼šæ˜¾ç¤ºä¸º **ä»˜è´¹èµ·è®¡ 1 ä¸ªæœˆåï¼ˆæœˆè´¹ï¼‰** æˆ– **1 å¹´åï¼ˆå¹´è´¹ï¼‰**

---

### **åŠŸèƒ½ 3ï¼šå¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤æ·»åŠ  Creditsï¼‰**

**ä¿®æ”¹æ–‡ä»¶**ï¼š`/Users/cavlinyeung/ai-bank-parser/firebase-functions/index.js`

**ä¿®æ”¹å†…å®¹**ï¼š
åœ¨ `stripeWebhook` å‡½æ•°ä¸­æ·»åŠ äº†å¹‚ç­‰æ€§æ£€æŸ¥ï¼š

```javascript
// ğŸ”’ å¹‚ç­‰æ€§æ£€æŸ¥ï¼šé˜²æ­¢é‡å¤å¤„ç†åŒä¸€ä¸ªäº‹ä»¶
const processedEventsRef = db.collection('processedStripeEvents').doc(event.id);
const processedEventDoc = await processedEventsRef.get();

if (processedEventDoc.exists) {
    console.log(`âš ï¸ äº‹ä»¶ ${event.id} å·²ç»å¤„ç†è¿‡ï¼Œè·³è¿‡å¤„ç†`);
    return res.status(200).json({ received: true, skipped: true, reason: 'already_processed' });
}

// è¨˜éŒ„äº‹ä»¶å·²è™•ç†
await processedEventsRef.set({
    eventId: event.id,
    eventType: event.type,
    processedAt: admin.firestore.FieldValue.serverTimestamp(),
    isTestMode: isTestMode
});
```

**æ•ˆæœ**ï¼š
- âœ… å³ä½¿ Stripe å‘é€é‡å¤äº‹ä»¶ï¼Œä¹Ÿåªä¼šå¤„ç†ä¸€æ¬¡
- âœ… Credits **ä¸ä¼šé‡å¤æ·»åŠ **
- âœ… å¦‚æœå¤„ç†å¤±è´¥ï¼Œä¼šè‡ªåŠ¨æ¸…ç†æ ‡è®°ï¼Œå…è®¸é‡è¯•

---

### **åŠŸèƒ½ 4ï¼šå·¦ä¾§æ "+"æŒ‰é’®åœ¨æ‰€æœ‰é¡µé¢åˆ›å»ºé¡¹ç›®**

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `/Users/cavlinyeung/ai-bank-parser/account.html`
- `/Users/cavlinyeung/ai-bank-parser/billing.html`

**ä¿®æ”¹å†…å®¹**ï¼š
1. âœ… æ·»åŠ äº† Create Project Modal çš„ HTML ç»“æ„
2. âœ… æ·»åŠ äº† `openCreateProjectModal`ã€`closeCreateProjectModal` å’Œ `createProject` å‡½æ•°

**æ•ˆæœ**ï¼š
- âœ… åœ¨ `account.html` å’Œ `billing.html` é¡µé¢ç‚¹å‡»å·¦ä¾§æ çš„ **"+"** æŒ‰é’®
- âœ… ä¼šå¼¹å‡º **"Create New Project"** æ¨¡æ€æ¡†
- âœ… ç”¨æˆ·è¾“å…¥é¡¹ç›®åç§°åï¼Œä¼šåˆ›å»ºæ–°é¡¹ç›®å¹¶è·³è½¬åˆ°é¡¹ç›®é¡µé¢

---

## ğŸ“Š **ä¼˜åŒ–æ•ˆæœæ€»ç»“**

### **Credits æ·»åŠ é—®é¢˜**
| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| Credits å¢åŠ  | 200-300ï¼ˆé”™è¯¯ï¼‰ | **100**ï¼ˆæ­£ç¡®ï¼‰ âœ… |
| é‡å¤æ·»åŠ  | æ˜¯ | **å¦** âœ… |
| Firestore äº‹ä»¶å»é‡ | æ—  | **æœ‰** âœ… |

### **è®¢é˜…è®¡åˆ’æ˜¾ç¤º**
| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| è´­ä¹°åæ˜¾ç¤º | Free Plan | **Pro Plan** âœ… |
| æœˆè´¹é‡ç½®æ—¥æœŸ | æœªè®¾ç½® | **1 ä¸ªæœˆå** âœ… |
| å¹´è´¹é‡ç½®æ—¥æœŸ | æœªè®¾ç½® | **1 å¹´å** âœ… |

### **ç”¨æˆ·ä½“éªŒ**
| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| account.html åˆ›å»ºé¡¹ç›® | ä¸å¯ç”¨ | **å¯ç”¨** âœ… |
| billing.html åˆ›å»ºé¡¹ç›® | ä¸å¯ç”¨ | **å¯ç”¨** âœ… |

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

### **æµ‹è¯• 1ï¼šå¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤æ·»åŠ  Creditsï¼‰**

1. å‰å¾€ï¼šhttps://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. å®Œæˆæ”¯ä»˜ï¼ˆæµ‹è¯•å¡ï¼š`4242 4242 4242 4242`ï¼‰
4. åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤ **Credits åªå¢åŠ äº† 100**

### **æµ‹è¯• 2ï¼šè®¢é˜…è®¡åˆ’å’Œé‡ç½®æ—¥æœŸ**

1. å®Œæˆæµ‹è¯•æ”¯ä»˜å
2. å‰å¾€ï¼šhttps://vaultcaddy.com/account.html
3. ç¡®è®¤ï¼š
   - âœ… **ç›®å‰è¨ˆåŠƒ** æ˜¾ç¤ºä¸º **"Pro Plan"**ï¼ˆä¸æ˜¯ "Free Plan"ï¼‰
   - âœ… **é‡ç½®æ—¥æœŸ** æ˜¾ç¤ºä¸º **1 ä¸ªæœˆåçš„æ—¥æœŸ**ï¼ˆæœˆè´¹ï¼‰æˆ– **1 å¹´åçš„æ—¥æœŸ**ï¼ˆå¹´è´¹ï¼‰

### **æµ‹è¯• 3ï¼šå·¦ä¾§æ "+"æŒ‰é’®**

1. åœ¨ https://vaultcaddy.com/account.html é¡µé¢
2. ç‚¹å‡»å·¦ä¾§æ çš„ **"+"** æŒ‰é’®
3. ç¡®è®¤å¼¹å‡º **"Create New Project"** æ¨¡æ€æ¡†
4. è¾“å…¥é¡¹ç›®åç§°ï¼Œç‚¹å‡» **"Create"**
5. ç¡®è®¤æˆåŠŸåˆ›å»ºé¡¹ç›®å¹¶è·³è½¬åˆ°é¡¹ç›®é¡µé¢

---

## ğŸ“ **Firestore æ•°æ®ç»“æ„**

### **ç”¨æˆ·æ–‡æ¡£ï¼ˆusers é›†åˆï¼‰**

è´­ä¹°è®¢é˜…åï¼Œç”¨æˆ·æ–‡æ¡£ä¼šåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```javascript
{
    email: "user@example.com",
    credits: 100,
    currentCredits: 100,
    
    // ğŸ”¥ æ–°å¢å­—æ®µï¼šè®¢é˜…è®¡åˆ’
    planType: "Pro Plan",           // "Free Plan" æˆ– "Pro Plan"
    subscriptionPlan: "monthly",    // "monthly" æˆ– "yearly"
    resetDate: Timestamp,           // é‡ç½®æ—¥æœŸï¼ˆæœˆè´¹ï¼š1ä¸ªæœˆåï¼Œå¹´è´¹ï¼š1å¹´åï¼‰
    lastPurchaseDate: Timestamp,    // æœ€åè´­ä¹°æ—¥æœŸ
    
    createdAt: Timestamp,
    updatedAt: Timestamp
}
```

### **å·²å¤„ç†äº‹ä»¶é›†åˆï¼ˆprocessedStripeEvents é›†åˆï¼‰**

ç”¨äºé˜²æ­¢é‡å¤å¤„ç†åŒä¸€ä¸ª Stripe äº‹ä»¶ï¼š

```javascript
{
    eventId: "evt_xxxxx",           // Stripe äº‹ä»¶ ID
    eventType: "checkout.session.completed", // äº‹ä»¶ç±»å‹
    processedAt: Timestamp,         // å¤„ç†æ—¶é—´
    isTestMode: true                // æ˜¯å¦ä¸ºæµ‹è¯•æ¨¡å¼
}
```

---

## ğŸ’¡ **ä¸‹ä¸€æ­¥å»ºè®®**

### **1. å®Œæˆ Stripe Webhook é…ç½®ä¼˜åŒ–**

å¦‚æœæ‚¨è¿˜æ²¡æœ‰å®Œæˆ Stripe Webhook çš„æ‰‹åŠ¨é…ç½®ï¼Œè¯·ï¼š
1. æ‰“å¼€ï¼šhttps://dashboard.stripe.com/test/webhooks
2. ç‚¹å‡» `charismatic-serenity` Webhook
3. ç¼–è¾‘ç›‘å¬çš„äº‹ä»¶ï¼Œåªä¿ç•™ 4 ä¸ªå¿…è¦äº‹ä»¶
4. åŒæ ·åœ¨ç”Ÿäº§æ¨¡å¼ï¼ˆLive Modeï¼‰ä¸­è¿›è¡Œé…ç½®

### **2. è¿›è¡Œæµ‹è¯•éªŒè¯**

1. è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜
2. éªŒè¯ Credits åªå¢åŠ  100
3. éªŒè¯è®¡åˆ’æ˜¾ç¤ºä¸º "Pro Plan"
4. éªŒè¯é‡ç½®æ—¥æœŸæ­£ç¡®æ˜¾ç¤º

### **3. Credits ä¸º 0 æ—¶çš„å¤„ç†é€»è¾‘ï¼ˆå¾…å®ç°ï¼‰**

æ‚¨æåˆ°ï¼š
- Free Planï¼šCredits ä¸º 0 æ—¶å¼¹å‡ºæç¤ºï¼ˆå›¾ 7ï¼‰
- Pro Planï¼šCredits ä¸º 0 æ—¶ç›´æ¥ä»˜è´¹ï¼ˆå›¾ 8ï¼‰

è¿™ä¸ªåŠŸèƒ½éœ€è¦åœ¨æ–‡æ¡£ä¸Šä¼ æ—¶æ£€æŸ¥ç”¨æˆ·çš„ Credits å’Œ planTypeï¼Œç„¶ååšå‡ºç›¸åº”çš„æç¤ºã€‚å¦‚æœéœ€è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼

---

## ğŸ™ **éœ€è¦å¸®åŠ©å—ï¼Ÿ**

å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œæˆ–éœ€è¦æˆ‘å¸®åŠ©å®ç° Credits ä¸º 0 æ—¶çš„å¤„ç†é€»è¾‘ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼

