# âœ… ä¸¤ä¸ªå…³é”®é—®é¢˜å·²ä¿®å¤

## é—®é¢˜ 1ï¼šé€šè¿‡ Stripe æ”¯ä»˜åˆ›å»ºçš„ç”¨æˆ·ç¼ºå°‘å…³é”®å­—æ®µ

### **é—®é¢˜æè¿°**

ä» Firebase Console æˆªå›¾å‘ç°ï¼š

| ç”¨æˆ·ç±»å‹ | åˆ›å»ºæ–¹å¼ | email | displayName | Credits | é—®é¢˜ |
|---------|---------|-------|-------------|---------|------|
| å›¾1-2 (90zYYa7y...) | Stripe æ”¯ä»˜ | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | 100 | æ— æ³•æ­£å¸¸ä½¿ç”¨ |
| å›¾3-4 (AZ55k5F...) | Stripe æ”¯ä»˜ | âŒ ç¼ºå¤± | âŒ ç¼ºå¤± | 80070 | æ— æ³•æ­£å¸¸ä½¿ç”¨ |
| å›¾5-6 (PxOIosAk...) | æ­£å¸¸æ³¨å†Œ/Google | âœ… å®Œæ•´ | âœ… å®Œæ•´ | -1 | æ­£å¸¸ |

### **æ ¹æœ¬åŸå› **

åœ¨ `firebase-functions/index.js` çš„ `handleCheckoutCompleted` å‡½æ•°ä¸­ï¼Œå½“ç”¨æˆ·é€šè¿‡ Stripe æ”¯ä»˜åˆ›å»ºè´¦æˆ·æ—¶ï¼Œä»£ç åªåˆ›å»ºäº†æœ€åŸºæœ¬çš„å­—æ®µï¼š

```javascript
// âŒ æ—§ä»£ç ï¼ˆä¸å®Œæ•´ï¼‰
const newUserRef = await db.collection('users').add({
    email: session.customer_email,
    credits: 0,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    source: 'stripe_payment'
});
```

**ç¼ºå°‘çš„å­—æ®µ**ï¼š
- `displayName` - ç”¨æˆ·æ˜¾ç¤ºåç§°
- `currentCredits` - å½“å‰å¯ç”¨ Credits
- `planType` - è®¢é˜…è®¡åˆ’ç±»å‹
- `emailVerified` - Email éªŒè¯çŠ¶æ€
- `stripeCustomerId` - Stripe å®¢æˆ· ID

### **ä¿®å¤æ–¹æ¡ˆ**

æ›´æ–° `handleCheckoutCompleted` å‡½æ•°ï¼Œåˆ›å»ºæ–°ç”¨æˆ·æ—¶åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µï¼š

```javascript
// âœ… æ–°ä»£ç ï¼ˆå®Œæ•´ï¼‰
const customerName = session.customer_details?.name || 
                    session.customer_details?.email?.split('@')[0] || 
                    'VaultCaddy User';

console.log(`ğŸ“ æ–°ç”¨æˆ¶è³‡æ–™: email=${session.customer_email}, displayName=${customerName}`);

const newUserRef = await db.collection('users').add({
    email: session.customer_email,
    displayName: customerName,
    credits: 0,
    currentCredits: 0,
    planType: 'Free Plan', // åˆå§‹ç‚º Free Planï¼Œç¨å¾Œæœƒæ›´æ–°ç‚º Pro Plan
    emailVerified: false,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    source: 'stripe_payment',
    stripeCustomerId: session.customer
});
```

### **ä¿®å¤æ•ˆæœ**

**ä¿®å¤å‰**ï¼š
```json
{
  "credits": 0,
  "createdAt": "2025-12-14T15:13:45Z",
  "updatedAt": "2025-12-14T15:13:45Z",
  "source": "stripe_payment"
}
```

**ä¿®å¤å**ï¼š
```json
{
  "email": "user@example.com",
  "displayName": "John Doe",
  "credits": 0,
  "currentCredits": 0,
  "planType": "Free Plan",
  "emailVerified": false,
  "stripeCustomerId": "cus_xxx",
  "createdAt": "2025-12-14T15:13:45Z",
  "updatedAt": "2025-12-14T15:13:45Z",
  "source": "stripe_payment"
}
```

---

## é—®é¢˜ 2ï¼šåˆ›å»ºé¡¹ç›®åæ— æ³•è‡ªåŠ¨è·³è½¬åˆ°æ–°é¡¹ç›®é¡µé¢

### **é—®é¢˜æè¿°**

åœ¨ä»¥ä¸‹é¡µé¢ç‚¹å‡»å·¦ä¾§ "+" å·åˆ›å»ºé¡¹ç›®åï¼Œæ— æ³•è‡ªåŠ¨è·³è½¬åˆ°æ–°åˆ›å»ºçš„é¡¹ç›®é¡µé¢ï¼š
- `account.html`
- `billing.html`
- `dashboard.html`

### **æ ¹æœ¬åŸå› **

`simple-data-manager.js` çš„ `createProject` å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª**å¯¹è±¡**ï¼š

```javascript
// simple-data-manager.js
async createProject(name) {
    // ...
    return {
        id: docRef.id,      // â† é¡¹ç›® ID åœ¨è¿™é‡Œ
        ...projectData
    };
}
```

ä½†åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œé”™è¯¯åœ°å°†æ•´ä¸ªå¯¹è±¡å½“ä½œå­—ç¬¦ä¸²ä½¿ç”¨ï¼š

```javascript
// âŒ æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
const projectId = await window.simpleDataManager.createProject(projectName);
// projectId æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼š{ id: 'xxx', name: 'xxx', createdAt: ... }

window.location.href = `firstproject.html?project=${projectId}`;
// è·³è½¬å¤±è´¥ï¼šURL å˜æˆ firstproject.html?project=[object Object]
```

### **ä¿®å¤æ–¹æ¡ˆ**

ä¿®æ”¹æ‰€æœ‰ä¸‰ä¸ªé¡µé¢ï¼Œæ­£ç¡®æå– `projectId`ï¼š

```javascript
// âœ… æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
const projectData = await window.simpleDataManager.createProject(projectName);
console.log('âœ… é …ç›®å·²ä¿å­˜åˆ° Firebase:', projectData);

// ğŸ”¥ å…³é”®ï¼šæå– id å±æ€§
const projectId = projectData.id;
console.log('ğŸš€ è·³è½‰åˆ°æ–°é …ç›®é é¢:', projectId);

// è·³è½‰åˆ°æ–°é …ç›®é é¢
window.location.href = `firstproject.html?project=${projectId}`;
```

### **ä¿®å¤çš„æ–‡ä»¶**

1. **account.html** (ç¬¬ 2067-2079 è¡Œ)
2. **billing.html** (ç¬¬ 2143-2157 è¡Œ)
3. **dashboard.html** (ç¬¬ 1218-1235 è¡Œ)

### **ä¿®å¤æ•ˆæœ**

**ä¿®å¤å‰**ï¼š
```
ç‚¹å‡» "åˆ›å»º" æŒ‰é’®
â†’ é¡¹ç›®åœ¨ Firebase ä¸­åˆ›å»ºæˆåŠŸ
â†’ æ¨¡æ€æ¡†å…³é—­
â†’ åœç•™åœ¨å½“å‰é¡µé¢ âŒ
```

**ä¿®å¤å**ï¼š
```
ç‚¹å‡» "åˆ›å»º" æŒ‰é’®
â†’ é¡¹ç›®åœ¨ Firebase ä¸­åˆ›å»ºæˆåŠŸ
â†’ æ¨¡æ€æ¡†å…³é—­
â†’ è‡ªåŠ¨è·³è½¬åˆ° firstproject.html?project=xxx âœ…
â†’ æ˜¾ç¤ºæ–°åˆ›å»ºçš„é¡¹ç›®é¡µé¢ âœ…
```

---

## ğŸš€ **éƒ¨ç½²è®°å½•**

### **Cloud Functions**
```bash
firebase deploy --only functions:stripeWebhook
```
âœ… **å·²éƒ¨ç½²** - 2025å¹´12æœˆ14æ—¥

### **Hostingï¼ˆå‰ç«¯ï¼‰**
```bash
firebase deploy --only hosting
```
âœ… **å·²éƒ¨ç½²** - 2025å¹´12æœˆ14æ—¥

---

## ğŸ“‹ **æµ‹è¯•æ¸…å•**

### **é—®é¢˜ 1 æµ‹è¯•**

- [ ] 1. ä½¿ç”¨æ–° Email åœ°å€åœ¨ `billing.html` å®Œæˆæ”¯ä»˜
- [ ] 2. æŸ¥çœ‹ Firebase Console â†’ users é›†åˆ
- [ ] 3. éªŒè¯æ–°ç”¨æˆ·åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  - [ ] `email` âœ…
  - [ ] `displayName` âœ…
  - [ ] `credits` âœ…
  - [ ] `currentCredits` âœ…
  - [ ] `planType` âœ…
  - [ ] `stripeCustomerId` âœ…
- [ ] 4. è®¿é—® `account.html` éªŒè¯ç”¨æˆ·ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

### **é—®é¢˜ 2 æµ‹è¯•**

- [ ] 1. è®¿é—® `account.html`
- [ ] 2. ç‚¹å‡»å·¦ä¾§ "+" å·
- [ ] 3. è¾“å…¥é¡¹ç›®åç§°ï¼ˆä¾‹å¦‚ï¼š"æµ‹è¯•é¡¹ç›® 123"ï¼‰
- [ ] 4. ç‚¹å‡»"åˆ›å»º"
- [ ] 5. **éªŒè¯**ï¼šè‡ªåŠ¨è·³è½¬åˆ° `firstproject.html?project=xxx`
- [ ] 6. **éªŒè¯**ï¼šæ–°é¡¹ç›®é¡µé¢æ­£ç¡®æ˜¾ç¤º

**é‡å¤ä»¥ä¸Šæ­¥éª¤æµ‹è¯•ï¼š**
- [ ] `billing.html`
- [ ] `dashboard.html`

---

## ğŸ” **å…³äº 80070 Credits å¼‚å¸¸çš„è¯´æ˜**

å›¾3-4 ä¸­çš„ç”¨æˆ· (AZ55k5F...) æ˜¾ç¤º **80070 Credits**ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„ bugã€‚

### **å¯èƒ½çš„åŸå› **

1. **Idempotency æ£€æŸ¥å¤±æ•ˆ**ï¼ˆæœ€å¯èƒ½ï¼‰
   - å¤šä¸ª `checkout.session.completed` äº‹ä»¶è¢«é‡å¤å¤„ç†
   - `processedStripeEvents` çš„åŸå­æ€§æ£€æŸ¥å¤±è´¥

2. **Stripe Webhook é‡è¯•**
   - Cloud Function è¿”å› 500 é”™è¯¯
   - Stripe è‡ªåŠ¨é‡è¯•å¯¼è‡´é‡å¤æ·»åŠ  Credits

### **è¯Šæ–­æ­¥éª¤**

1. **ä½¿ç”¨è¯Šæ–­å·¥å…·**ï¼ˆå·²éƒ¨ç½²ï¼‰
   - è®¿é—® `account.html` â†’ æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
   - è¿è¡Œï¼š
     ```javascript
     const f = firebase.functions().httpsCallable('queryUserCredits');
     const result = await f({ email: 'AZ55k5F å¯¹åº”çš„ email' });
     console.log(result.data);
     ```
   - æŸ¥çœ‹ `addCount`ï¼ˆåº”è¯¥æ˜¯ 1ï¼Œå¦‚æœæ˜¯ 800+ è¯´æ˜é‡å¤æ·»åŠ ï¼‰

2. **æŸ¥çœ‹ Firestore**
   - `processedStripeEvents` é›†åˆ
   - ç»Ÿè®¡ `checkout.session.completed` äº‹ä»¶æ•°é‡
   - æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ event ID

3. **æŸ¥çœ‹ Stripe Dashboard**
   - Webhook æ—¥å¿—
   - æ£€æŸ¥æ˜¯å¦æœ‰ 500 é”™è¯¯
   - æ£€æŸ¥æ˜¯å¦æœ‰å¤šæ¬¡é‡è¯•

### **ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**

1. **æ‰‹åŠ¨ä¿®æ­£ Credits**
   - Firebase Console â†’ users â†’ AZ55k5F...
   - credits: 80070 â†’ **100**
   - currentCredits: 80070 â†’ **100**

2. **æ¸…ç©ºæµ‹è¯•æ•°æ®**
   - åˆ é™¤ `processedStripeEvents` é›†åˆä¸­çš„æµ‹è¯•äº‹ä»¶
   - é¿å…æ±¡æŸ“ç”Ÿäº§æ•°æ®

---

## ğŸ“ **éœ€è¦è¿›ä¸€æ­¥è¯Šæ–­**

å¦‚æœ 80070 Credits é—®é¢˜å†æ¬¡å‡ºç°ï¼Œè¯·æä¾›ï¼š

1. **æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º**
   - è¿è¡Œ `queryUserCredits` å‡½æ•°çš„ç»“æœ

2. **Firebase Console æˆªå›¾**
   - `processedStripeEvents` é›†åˆï¼ˆæœ€è¿‘ 20 æ¡ï¼‰
   - ç”¨æˆ·çš„ `creditsHistory` å­é›†åˆ

3. **Stripe Dashboard æˆªå›¾**
   - Webhook æ—¥å¿—ï¼ˆæœ€è¿‘çš„ checkout äº‹ä»¶ï¼‰
   - Webhook é…ç½®é¡µé¢

---

## âœ… **ä¿®å¤å®Œæˆ**

- [x] é—®é¢˜ 1ï¼šStripe ç”¨æˆ·ç¼ºå°‘å­—æ®µ â†’ **å·²ä¿®å¤å¹¶éƒ¨ç½²**
- [x] é—®é¢˜ 2ï¼šåˆ›å»ºé¡¹ç›®æ— æ³•è·³è½¬ â†’ **å·²ä¿®å¤å¹¶éƒ¨ç½²**
- [ ] é—®é¢˜ 3ï¼š80070 Credits å¼‚å¸¸ â†’ **å¾…è¿›ä¸€æ­¥è¯Šæ–­**

**ä¸‹ä¸€æ­¥**ï¼š
1. æ¸…ç©ºæµ‹è¯•æ•°æ®ï¼ˆ`processedStripeEvents`ï¼‰
2. ä½¿ç”¨æ–°è´¦æˆ·æµ‹è¯• Stripe æ”¯ä»˜
3. éªŒè¯ç”¨æˆ·å­—æ®µå®Œæ•´æ€§
4. éªŒè¯åˆ›å»ºé¡¹ç›®è·³è½¬åŠŸèƒ½
5. ç›‘æ§æ˜¯å¦å†æ¬¡å‡ºç° Credits å¼‚å¸¸


