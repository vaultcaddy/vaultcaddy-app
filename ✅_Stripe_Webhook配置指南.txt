# ✅ Stripe Webhook 配置指南

## 已完成的配置

✅ Stripe Secret Key 已配置
✅ Firebase Functions 已部署

## 需要完成的步骤

### 1️⃣ 创建 Webhook 端点

您当前正在 Stripe Dashboard 的创建 Webhook 页面：
https://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/workbench/webhooks/create

#### 步骤 A：选择事件

1. 确保选择了"所选事件"标签页（您当前已选择）

2. 向下滚动页面，找到并展开以下事件类别，然后勾选这些事件：

   **Checkout 类别**
   - ✅ `checkout.session.completed` (当支付成功时)

   **Customer 类别**
   - ✅ `customer.subscription.created` (当订阅创建时)
   - ✅ `customer.subscription.updated` (当订阅更新时)
   - ✅ `customer.subscription.deleted` (当订阅取消时)

   **Invoice 类别**
   - ✅ `invoice.payment_succeeded` (当发票支付成功时)

3. 点击页面底部的"继续"按钮

#### 步骤 B：配置端点 URL

1. 在"端点 URL"字段中输入：
   ```
   https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook
   ```

2. 确保选择"您的账户"作为事件来源

3. 点击"添加端点"按钮

### 2️⃣ 获取 Webhook Signing Secret

创建成功后：

1. 在 Webhook 列表中点击您刚创建的 Webhook

2. 找到"Signing secret"部分

3. 点击"显示"按钮

4. 复制以 `whsec_` 开头的密钥

### 3️⃣ 配置 Firebase Functions

在终端中运行以下命令（将 `您的_Webhook_Signing_Secret` 替换为步骤 2 中复制的密钥）：

```bash
cd /Users/cavlinyeung/ai-bank-parser
firebase functions:config:set stripe.webhook_secret="您的_Webhook_Signing_Secret"
firebase deploy --only functions
```

### 4️⃣ 测试 Webhook

1. 在 Stripe Dashboard 的 Webhook 详情页面，点击"发送测试 webhook"

2. 选择 `checkout.session.completed` 事件

3. 点击"发送测试 webhook"按钮

4. 检查响应是否成功（应该返回 200 状态码）

## 验证配置

### 测试支付流程

1. 访问 https://vaultcaddy.com/billing.html

2. 登录您的测试账户

3. 点击"Get Started"按钮

4. 应该能够成功跳转到 Stripe 支付页面

5. 使用 Stripe 测试卡号完成支付：
   - 卡号: 4242 4242 4242 4242
   - 到期日: 任何未来日期
   - CVC: 任何3位数字

6. 支付成功后，检查：
   - ✅ 用户订阅状态已更新
   - ✅ Credits 已正确添加

## 当前配置状态

✅ Stripe Secret Key: 已配置
⏳ Webhook Secret: 需要您手动配置
⏳ Webhook 端点: 需要您手动创建

## Firebase Functions 配置

当前 Firebase Functions 配置：
```
email.password: (已配置)
email.service: (已配置)
email.user: (已配置)
stripe.secret_key: (已配置)
stripe.webhook_secret: (需要配置)
```

## Webhook URL

您的 Firebase Functions Webhook URL:
```
https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook
```

## 注意事项

1. Webhook Secret 必须在创建 Webhook 端点后才能获取
2. 每次更新 Firebase Functions 配置后，都需要重新部署
3. 测试时请使用 Stripe 测试模式
4. 确保 Firebase Functions 有足够的权限访问 Firestore

## 故障排除

### 如果支付后 Credits 没有添加：

1. 检查 Firebase Functions 日志：
   ```bash
   firebase functions:log
   ```

2. 确认 Webhook Secret 配置正确

3. 检查 Stripe Dashboard 的 Webhook 日志

### 如果无法创建支付会话：

1. 确认 Stripe Secret Key 配置正确

2. 检查 Firebase Functions 部署状态

3. 查看浏览器控制台错误信息

## 下一步

完成以上步骤后，您的 Stripe 集成就完全配置好了！

如果遇到任何问题，请检查：
1. Firebase Functions 日志
2. Stripe Dashboard 的 Webhook 日志
3. 浏览器控制台错误信息

