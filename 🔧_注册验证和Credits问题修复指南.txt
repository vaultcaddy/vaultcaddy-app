# ğŸ”§ æ³¨å†ŒéªŒè¯å’Œ20ä¸ªCreditsé—®é¢˜ - å®Œæ•´ä¿®å¤æŒ‡å—

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. âœ… æ–‡æ¡ˆä¿®æ”¹
**æ–‡ä»¶ï¼š** `auth.html`

**ä¿®æ”¹å†…å®¹ï¼š**
```html
ä¿®æ”¹å‰ï¼š<div><strong>è¨»å†Šå³é€10å€‹Creditsï¼</strong></div>
ä¿®æ”¹åï¼š<div><strong>è¨»å†ŠåŠé©—è­‰å³é€20å€‹Creditsï¼</strong></div>
```

**æ•ˆæœï¼š**
- âœ… æ˜ç¡®è¯´æ˜éœ€è¦éªŒè¯åæ‰èƒ½è·å¾—Credits
- âœ… Creditsæ•°é‡ä»10ä¸ªæ”¹ä¸º20ä¸ª

---

## ğŸ” é—®é¢˜è¯Šæ–­

### é—®é¢˜1ï¼šæ³¨å†Œåè‡ªåŠ¨å‘é€éªŒè¯ç Email

**å½“å‰ä»£ç é€»è¾‘ï¼š** âœ… æ­£å¸¸
```javascript
// auth.html ç¬¬664-667è¡Œ
// ç™¼é€é©—è­‰ç¢¼
const functions = firebase.functions();
const sendCodeFunc = functions.httpsCallable('sendVerificationCode');
await sendCodeFunc({ email: email, displayName: displayName });
```

**å¯èƒ½çš„é—®é¢˜ï¼š**
1. âŒ Firebase Functions æœªéƒ¨ç½²
2. âŒ Email é…ç½®æœªè®¾ç½®
3. âŒ Gmail SMTP æƒé™é—®é¢˜

---

### é—®é¢˜2ï¼šå®ŒæˆéªŒè¯ç éªŒè¯åæ²¡æœ‰æˆåŠŸé€20ä¸ªCredits

**å½“å‰ä»£ç é€»è¾‘ï¼š** âœ… æ­£å¸¸
```javascript
// firebase-functions/index.js ç¬¬623-659è¡Œ
// ğŸ é©—è­‰æˆåŠŸå¾Œè´ˆé€ 20 å€‹ Credits
const newCredits = currentCredits + 20;
transaction.update(userRef, {
    credits: newCredits,
    currentCredits: newCredits,
    emailVerified: true,
    ...
});
```

**å¯èƒ½çš„é—®é¢˜ï¼š**
1. âŒ Firebase Functions æœªéƒ¨ç½²
2. âŒ ç”¨æˆ·æ–‡æ¡£æœªåˆ›å»º
3. âŒ Transaction å¤±è´¥ä½†æœªæŠ¥é”™

---

## ğŸ”§ ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ Firebase Functions éƒ¨ç½²çŠ¶æ€

**ç™»å½• Firebase Consoleï¼š**
```
1. è®¿é—®ï¼šhttps://console.firebase.google.com/
2. é€‰æ‹©é¡¹ç›®
3. å·¦ä¾§èœå• â†’ Functions
4. æ£€æŸ¥æ˜¯å¦æœ‰ä»¥ä¸‹å‡½æ•°ï¼š
   - sendVerificationCode
   - verifyCode
```

**å¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼š**
```bash
cd firebase-functions
firebase deploy --only functions
```

---

### æ­¥éª¤2ï¼šé…ç½® Email å‘é€ï¼ˆGmail SMTPï¼‰

**è®¾ç½® Firebase Configï¼š**
```bash
cd firebase-functions

# è®¾ç½® Gmail ç”¨æˆ·åå’Œå¯†ç 
firebase functions:config:set email.user="vaultcaddy@gmail.com"
firebase functions:config:set email.password="your-app-password"

# æŸ¥çœ‹é…ç½®
firebase functions:config:get

# é‡æ–°éƒ¨ç½²
firebase deploy --only functions
```

**è·å– Gmail App Passwordï¼š**
```
1. è®¿é—®ï¼šhttps://myaccount.google.com/apppasswords
2. é€‰æ‹©åº”ç”¨ï¼šMail
3. é€‰æ‹©è®¾å¤‡ï¼šOther (Custom name)
4. è¾“å…¥åç§°ï¼šVaultCaddy
5. ç‚¹å‡»ç”Ÿæˆ
6. å¤åˆ¶16ä½å¯†ç ï¼ˆä¸åŒ…å«ç©ºæ ¼ï¼‰
7. ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤è®¾ç½®
```

---

### æ­¥éª¤3ï¼šä¿®å¤ Credits èµ é€é€»è¾‘ï¼ˆå·²ä¼˜åŒ–ï¼‰

**æ£€æŸ¥ç”¨æˆ·åˆ›å»ºé€»è¾‘ï¼š**

å½“å‰ä»£ç åœ¨ `verifyCode` å‡½æ•°ä¸­ï¼š
```javascript
// æŸ¥æ‰¾ç”¨æˆ·
const usersSnapshot = await db.collection('users')
    .where('email', '==', email)
    .limit(1)
    .get();

if (!usersSnapshot.empty) {
    // èµ é€ Credits
    ...
}
```

**å¯èƒ½çš„é—®é¢˜ï¼š**
- ç”¨æˆ·åˆ›å»ºæ—¶æ²¡æœ‰åœ¨ Firestore ä¸­åˆ›å»ºæ–‡æ¡£
- åªåœ¨ Firebase Auth åˆ›å»ºäº†ç”¨æˆ·ï¼Œä½†æ²¡æœ‰åœ¨ Firestore åˆ›å»º

**è§£å†³æ–¹æ¡ˆï¼š** ç¡®ä¿æ³¨å†Œæ—¶åˆ›å»º Firestore ç”¨æˆ·æ–‡æ¡£

---

### æ­¥éª¤4ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

**ä¿®æ”¹ auth.html æ³¨å†Œé€»è¾‘ï¼ˆæ·»åŠ è¯¦ç»†æ—¥å¿—ï¼‰ï¼š**

åœ¨ auth.html çš„æ³¨å†ŒæˆåŠŸåæ·»åŠ ï¼š
```javascript
// ç™¼é€é©—è­‰ç¢¼
console.log('ğŸ“§ å‡†å¤‡å‘é€éªŒè¯ç åˆ°:', email);
const functions = firebase.functions();
const sendCodeFunc = functions.httpsCallable('sendVerificationCode');
const result = await sendCodeFunc({ email: email, displayName: displayName });
console.log('âœ… éªŒè¯ç å‘é€ç»“æœ:', result);
```

---

### æ­¥éª¤5ï¼šä¿®å¤ Firestore ç”¨æˆ·åˆ›å»º

**æ£€æŸ¥ simple-auth.js çš„ registerWithEmail æ–¹æ³•ï¼š**

åº”è¯¥åŒ…å«åˆ›å»º Firestore ç”¨æˆ·æ–‡æ¡£çš„é€»è¾‘ï¼š
```javascript
async registerWithEmail(email, password, displayName) {
    // åˆ›å»º Firebase Auth ç”¨æˆ·
    const userCredential = await firebase.auth()
        .createUserWithEmailAndPassword(email, password);
    
    // åˆ›å»º Firestore ç”¨æˆ·æ–‡æ¡£
    await firebase.firestore().collection('users').doc(userCredential.user.uid).set({
        email: email,
        displayName: displayName,
        credits: 0,  // åˆå§‹ä¸º0ï¼ŒéªŒè¯åä¼šåŠ 20
        currentCredits: 0,
        emailVerified: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    return userCredential;
}
```

---

## ğŸ“‹ å®Œæ•´æµ‹è¯•æµç¨‹

### æµ‹è¯•æ­¥éª¤ï¼š

1. **æ³¨å†Œæ–°è´¦å·**
   ```
   è®¿é—®ï¼šhttps://vaultcaddy.com/auth.html
   å¡«å†™æ³¨å†Œè¡¨å•
   ç‚¹å‡»"åˆ›å»ºè´¦æˆ·"
   ```

2. **æ£€æŸ¥æ§åˆ¶å°**
   ```
   æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   åº”è¯¥çœ‹åˆ°ï¼š
   âœ… æ³¨å†ŒæˆåŠŸï¼éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±
   ```

3. **æ£€æŸ¥é‚®ç®±**
   ```
   æ£€æŸ¥æ³¨å†Œé‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶ï¼‰
   åº”è¯¥æ”¶åˆ°éªŒè¯ç é‚®ä»¶
   ```

4. **è¾“å…¥éªŒè¯ç **
   ```
   è¾“å…¥6ä½éªŒè¯ç 
   ç‚¹å‡»"éªŒè¯"
   ```

5. **æ£€æŸ¥ Credits**
   ```
   éªŒè¯æˆåŠŸåè·³è½¬åˆ°é¦–é¡µ
   ç™»å½•è´¦å·
   æŸ¥çœ‹ Credits ä½™é¢
   åº”è¯¥æ˜¾ç¤ºï¼š20
   ```

---

## ğŸ” è°ƒè¯•æ£€æŸ¥æ¸…å•

### Firebase Console æ£€æŸ¥ï¼š

- [ ] Functions å·²éƒ¨ç½²
  - sendVerificationCode å­˜åœ¨
  - verifyCode å­˜åœ¨

- [ ] Email é…ç½®å·²è®¾ç½®
  - email.user å·²é…ç½®
  - email.password å·²é…ç½®

- [ ] Authentication å·²å¯ç”¨
  - Email/Password æä¾›å•†å·²å¯ç”¨

- [ ] Firestore è§„åˆ™å…è®¸å†™å…¥
  - users é›†åˆå¯å†™
  - verificationCodes é›†åˆå¯å†™

---

### æ§åˆ¶å°æ—¥å¿—æ£€æŸ¥ï¼š

**æ³¨å†Œæ—¶åº”è¯¥çœ‹åˆ°ï¼š**
```
âœ… æ³¨å†ŒæˆåŠŸï¼éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±
ğŸ“§ å‡†å¤‡å‘é€éªŒè¯ç åˆ°: user@example.com
âœ… éªŒè¯ç å‘é€ç»“æœ: { success: true }
```

**éªŒè¯æ—¶åº”è¯¥çœ‹åˆ°ï¼š**
```
ğŸ” é–‹å§‹é©—è­‰...
ğŸ“§ é©—è­‰ç¢¼: 123456 | Email: user@example.com
âœ… é©—è­‰çµæœ: { success: true, message: 'é©—è­‰æˆåŠŸï¼å·²è´ˆé€ 20 å€‹ Credits' }
é©—è­‰æˆåŠŸï¼æ­£åœ¨è·³è½‰...
```

---

### Firestore æ•°æ®æ£€æŸ¥ï¼š

**éªŒè¯å‰ - users é›†åˆï¼š**
```json
{
  "email": "user@example.com",
  "displayName": "User Name",
  "credits": 0,
  "currentCredits": 0,
  "emailVerified": false,
  "createdAt": "2025-12-06T..."
}
```

**éªŒè¯å - users é›†åˆï¼š**
```json
{
  "email": "user@example.com",
  "displayName": "User Name",
  "credits": 20,  // â† åº”è¯¥æ˜¯ 20
  "currentCredits": 20,  // â† åº”è¯¥æ˜¯ 20
  "emailVerified": true,  // â† åº”è¯¥æ˜¯ true
  "emailVerifiedAt": "2025-12-06T...",
  "createdAt": "2025-12-06T...",
  "updatedAt": "2025-12-06T..."
}
```

**éªŒè¯å - creditsHistory å­é›†åˆï¼š**
```json
{
  "type": "bonus",
  "amount": 20,
  "reason": "email_verification",
  "description": "å®Œæˆ Email é©—è­‰çå‹µ",
  "createdAt": "2025-12-06T...",
  "balanceAfter": 20
}
```

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

**éƒ¨ç½² Firebase Functionsï¼š**
```bash
cd firebase-functions

# å®‰è£…ä¾èµ–
npm install

# éƒ¨ç½²æ‰€æœ‰å‡½æ•°
firebase deploy --only functions

# æˆ–åªéƒ¨ç½²éªŒè¯ç›¸å…³å‡½æ•°
firebase deploy --only functions:sendVerificationCode,functions:verifyCode
```

**æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—ï¼š**
```bash
firebase functions:log
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1ï¼šéªŒè¯ç é‚®ä»¶æ²¡æœ‰æ”¶åˆ°ï¼Ÿ

**æ£€æŸ¥ï¼š**
1. æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹
2. ç¡®è®¤ Email é…ç½®æ­£ç¡®
3. æŸ¥çœ‹ Firebase Functions æ—¥å¿—

**è°ƒè¯•ï¼š**
```bash
firebase functions:log --only sendVerificationCode
```

---

### Q2ï¼šéªŒè¯æˆåŠŸä½†æ²¡æœ‰ Creditsï¼Ÿ

**æ£€æŸ¥ï¼š**
1. Firestore ä¸­æ˜¯å¦æœ‰ç”¨æˆ·æ–‡æ¡£
2. Firebase Functions æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
3. Transaction æ˜¯å¦æˆåŠŸ

**è°ƒè¯•ï¼š**
```bash
firebase functions:log --only verifyCode
```

---

### Q3ï¼šå¦‚ä½•æ‰‹åŠ¨æ·»åŠ  Creditsï¼Ÿ

**Firebase Consoleï¼š**
```
1. Firestore Database â†’ users â†’ é€‰æ‹©ç”¨æˆ·æ–‡æ¡£
2. ç¼–è¾‘å­—æ®µï¼š
   - credits: 20
   - currentCredits: 20
   - emailVerified: true
3. ä¿å­˜
```

---

## ğŸ“„ ç›¸å…³æ–‡ä»¶

**éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶ï¼š**
1. `auth.html` - æ³¨å†Œè¡¨å•
2. `verify-email.html` - éªŒè¯ç è¾“å…¥é¡µé¢
3. `firebase-functions/index.js` - åç«¯é€»è¾‘
4. `simple-auth.js` - è®¤è¯é€»è¾‘

**éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼š**
1. `auth.html` - æ–‡æ¡ˆå·²ä¿®æ”¹
2. `firebase-functions/` - å¦‚æœä¿®æ”¹äº†Functionsä»£ç 

---

ğŸ¯ **ä¸‹ä¸€æ­¥ï¼š**
1. ä¸Šä¼ ä¿®æ”¹åçš„ auth.html
2. æ£€æŸ¥ Firebase Functions éƒ¨ç½²
3. é…ç½® Email SMTP
4. æµ‹è¯•å®Œæ•´æ³¨å†Œæµç¨‹
