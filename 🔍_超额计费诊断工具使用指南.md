# ğŸ” è¶…é¢è®¡è´¹è¯Šæ–­å·¥å…·ä½¿ç”¨æŒ‡å—

## é—®é¢˜è¯´æ˜

ç”¨æˆ· `1234@gmail.com` å–æ¶ˆè®¢é˜…åï¼ŒFirestore ä¸­ Credits ä» `-6` æ¢å¤ä¸º `0`ï¼Œä½†åœ¨ Stripe ä¸­æ‰¾ä¸åˆ° `HK$3.00` çš„è¶…é¢è´¹ç”¨æ”¶å–è®°å½•ã€‚

## å¯èƒ½åŸå› 

### 1. meteredSubscriptionItemId æœªä¿å­˜ âŒ

å½“ç”¨æˆ·è®¢é˜…æ—¶ï¼Œç³»ç»Ÿéœ€è¦ä¿å­˜ `meteredSubscriptionItemId`ï¼ˆStripe è®¢é˜…é¡¹ IDï¼‰åˆ° Firestoreï¼š

```javascript
// åœ¨ handleSubscriptionChange å‡½æ•°ä¸­ï¼ˆindex.js ç¬¬545-595è¡Œï¼‰
const meteredItemId = usageBasedItem?.id;

await db.collection('users').doc(userId).update({
    subscription: {
        meteredSubscriptionItemId: meteredItemId  // â† å…³é”®ï¼
    }
});
```

**å¦‚æœè¿™ä¸ª ID æ²¡æœ‰ä¿å­˜**ï¼Œå–æ¶ˆè®¢é˜…æ—¶ç³»ç»Ÿæ— æ³•å‘ Stripe æŠ¥å‘Šè¶…é¢ä½¿ç”¨ï¼

### 2. å–æ¶ˆè®¢é˜…æ—¶æŠ¥å‘Šå¤±è´¥ âŒ

åœ¨ `handleSubscriptionCancelled` å‡½æ•°ä¸­ï¼ˆindex.js ç¬¬654-703è¡Œï¼‰ï¼š

```javascript
if (currentCredits < 0) {
    const meteredItemId = userData?.meteredSubscriptionItemId;  // â† å¦‚æœæ˜¯ null
    const stripeSubscriptionId = userData?.stripeSubscriptionId;
    
    if (meteredItemId && stripeSubscriptionId) {
        // æŠ¥å‘Šè¶…é¢ä½¿ç”¨
        await stripeClient.subscriptionItems.createUsageRecord(...);
    } else {
        // âŒ æ— æ³•æŠ¥å‘Šï¼
        console.warn(`âš ï¸ ç¼ºå°‘ Stripe è®¢é˜…ä¿¡æ¯ï¼Œæ— æ³•æŠ¥å‘Šè¶…é¢ä½¿ç”¨`);
    }
}
```

### 3. Stripe è®¢é˜…å·²å–æ¶ˆï¼Œæ— æ³•å†æŠ¥å‘Šä½¿ç”¨é‡ âš ï¸

ä¸€æ—¦è®¢é˜…è¢«å–æ¶ˆï¼ˆ`customer.subscription.deleted` äº‹ä»¶è§¦å‘ï¼‰ï¼Œè¯¥è®¢é˜…çš„ Subscription Items å°±ä¼šå¤±æ•ˆï¼Œæ— æ³•å†æ·»åŠ ä½¿ç”¨è®°å½•ã€‚

## è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤ 1ï¼šä½¿ç”¨è¯Šæ–­å·¥å…·æ£€æŸ¥ ğŸ”

1. **æ‰“å¼€è¯Šæ–­å·¥å…·**ï¼š
   ```bash
   # æ–¹æ³•Aï¼šç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€æœ¬åœ°æ–‡ä»¶
   æ‰“å¼€æ–‡ä»¶ï¼šoverage-diagnostic.html
   
   # æ–¹æ³•Bï¼šä¸Šä¼ åˆ°ç½‘ç«™
   å°† overage-diagnostic.html ä¸Šä¼ åˆ°ï¼š
   https://vaultcaddy.com/admin/overage-diagnostic.html
   ```

2. **è¯Šæ–­ç”¨æˆ·è´¦æˆ·**ï¼š
   - è¾“å…¥é‚®ç®±ï¼š`1234@gmail.com`
   - ç‚¹å‡»ã€ŒğŸ” å¼€å§‹è¯Šæ–­ã€
   - æŸ¥çœ‹ç»“æœï¼š
     ```json
     {
       "checks": {
         "hasMeteredItem": true/false,  â† æ£€æŸ¥è¿™ä¸ªï¼
         "hasSubscriptionId": true/false,
         "canReportUsage": true/false  â† å¦‚æœæ˜¯ falseï¼Œæ— æ³•æŠ¥å‘Š
       },
       "meteredItemId": "si_xxxxx" or null,  â† æ£€æŸ¥è¿™ä¸ªï¼
       "stripeUsageRecords": [...],  â† æŸ¥çœ‹æ˜¯å¦æœ‰ä½¿ç”¨è®°å½•
       "totalStripeUsage": 0  â† å½“å‰ Stripe è®°å½•çš„æ€»ä½¿ç”¨é‡
     }
     ```

### æ­¥éª¤ 2ï¼šæ ¹æ®è¯Šæ–­ç»“æœé‡‡å–è¡ŒåŠ¨ ğŸ”§

#### æƒ…å†µ Aï¼š`canReportUsage: true` ä½† `totalStripeUsage: 0`

è¯´æ˜ï¼šç”¨æˆ·æœ‰å¿…è¦ä¿¡æ¯ï¼Œä½†ä¹‹å‰æŠ¥å‘Šå¤±è´¥äº†ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨è¯Šæ–­å·¥å…·æ‰‹åŠ¨æŠ¥å‘Š

1. åœ¨è¯Šæ–­å·¥å…·ä¸­ï¼Œæ»šåŠ¨åˆ°ã€Œ2. æ‰‹åŠ¨æŠ¥å‘Šè¶…é¢ä½¿ç”¨ã€éƒ¨åˆ†
2. è¾“å…¥é‚®ç®±ï¼š`1234@gmail.com`
3. è¾“å…¥è¶…é¢æ•°é‡ï¼š`6`
4. ç‚¹å‡»ã€ŒğŸ“¡ æ‰‹åŠ¨æŠ¥å‘Šã€
5. ç­‰å¾…æˆåŠŸæ¶ˆæ¯ï¼š`âœ… å·²å‘ Stripe æŠ¥å‘Š 6 Credits çš„è¶…é¢ä½¿ç”¨`

#### æƒ…å†µ Bï¼š`canReportUsage: false`ï¼ˆç¼ºå°‘ meteredItemIdï¼‰

è¯´æ˜ï¼šç”¨æˆ·è®¢é˜…æ—¶ `meteredSubscriptionItemId` æ²¡æœ‰æ­£ç¡®ä¿å­˜ã€‚

**è§£å†³æ–¹æ¡ˆ 1ï¼š** æ‰‹åŠ¨æŸ¥æ‰¾å¹¶è¡¥å……ï¼ˆæ¨èï¼‰

1. æ‰“å¼€ Stripe Dashboard â†’ Subscriptions
2. æ‰¾åˆ°ç”¨æˆ· `1234@gmail.com` çš„è®¢é˜…ï¼š`sub_1SeBs9JmiQ31C0GTBKgiZ2xX`
3. åœ¨è®¢é˜…è¯¦æƒ…ä¸­ï¼Œæ‰¾åˆ° "Items" éƒ¨åˆ†
4. å¤åˆ¶ metered item çš„ IDï¼ˆæ ¼å¼ï¼š`si_xxxxx`ï¼‰
5. æ‰“å¼€ Firebase Console â†’ Firestore â†’ users â†’ `1234@gmail.com` æ–‡æ¡£
6. æ·»åŠ /æ›´æ–°å­—æ®µï¼š
   ```
   meteredSubscriptionItemId: "si_xxxxx"  â† å¡«å…¥å¤åˆ¶çš„ ID
   stripeSubscriptionId: "sub_1SeBs9JmiQ31C0GTBKgiZ2xX"
   ```
7. ç„¶åä½¿ç”¨è¯Šæ–­å·¥å…·æ‰‹åŠ¨æŠ¥å‘Šè¶…é¢ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ 2ï¼š** Stripe Dashboard æ‰‹åŠ¨ç”Ÿæˆå‘ç¥¨

å¦‚æœè®¢é˜…å·²ç»å–æ¶ˆï¼Œæ— æ³•å†æŠ¥å‘Šä½¿ç”¨é‡ï¼Œå¯ä»¥ç›´æ¥åœ¨ Stripe ä¸­æ‰‹åŠ¨åˆ›å»ºå‘ç¥¨ï¼š

1. æ‰“å¼€ Stripe Dashboard â†’ Customers â†’ `1234@gmail.com`
2. ç‚¹å‡»å³ä¸Šè§’ã€ŒCreate invoiceã€
3. æ·»åŠ å‘ç¥¨é¡¹ç›®ï¼š
   - Description: `è¶…é¢ä½¿ç”¨ Credits`
   - Amount: `HK$3.00`ï¼ˆ6 Credits Ã— HK$0.5/Creditï¼‰
4. ç‚¹å‡»ã€ŒFinalize and sendã€

#### æƒ…å†µ Cï¼š`totalStripeUsage: 6`ï¼ˆå·²æˆåŠŸæŠ¥å‘Šï¼‰

è¯´æ˜ï¼šä½¿ç”¨è®°å½•å·²ç»åœ¨ Stripe ä¸­ï¼Œä½†è¿˜æ²¡æœ‰ç”Ÿæˆå‘ç¥¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** æ‰‹åŠ¨ç”Ÿæˆå‘ç¥¨

1. æ‰“å¼€ Stripe Dashboard â†’ Customers â†’ `1234@gmail.com`
2. ç‚¹å‡»å³ä¸Šè§’ã€ŒCreate invoiceã€
3. Stripe ä¼šè‡ªåŠ¨åŒ…å«æœªè®¡è´¹çš„ä½¿ç”¨é‡
4. å‘ç¥¨é‡‘é¢åº”è¯¥æ˜¯ `HK$3.00`
5. ç‚¹å‡»ã€ŒFinalize and sendã€

### æ­¥éª¤ 3ï¼šéªŒè¯ä¿®å¤ âœ…

1. **æ£€æŸ¥ Stripe ä½¿ç”¨è®°å½•**ï¼š
   ```
   Stripe Dashboard â†’ Subscriptions â†’ sub_1SeBs9JmiQ31C0GTBKgiZ2xX
   â†’ Usage-based items
   â†’ åº”è¯¥æ˜¾ç¤º 6 units
   ```

2. **æ£€æŸ¥å‘ç¥¨**ï¼š
   ```
   Stripe Dashboard â†’ Customers â†’ 1234@gmail.com
   â†’ Invoices
   â†’ åº”è¯¥æœ‰ä¸€å¼  HK$3.00 çš„å‘ç¥¨
   ```

3. **æ£€æŸ¥äº¤æ˜“è®°å½•**ï¼š
   ```
   Stripe Dashboard â†’ Payments â†’ All transactions
   â†’ åº”è¯¥æœ‰ä¸€æ¡ HK$3.00 çš„æ‰£æ¬¾è®°å½•
   ```

## é¢„é˜²æªæ–½ï¼ˆé¿å…æœªæ¥å†æ¬¡å‘ç”Ÿï¼‰

### 1. ç¡®ä¿ meteredSubscriptionItemId æ­£ç¡®ä¿å­˜ âœ…

åœ¨ `handleSubscriptionChange` å‡½æ•°ä¸­ï¼ˆå·²å®ç°ï¼‰ï¼š

```javascript
// ç¬¬545-595è¡Œ
const usageBasedItem = subscription.items.data.find(...);

if (usageBasedItem) {
    subscriptionData.meteredSubscriptionItemId = usageBasedItem.id;
    console.log(`âœ… ä¿å­˜ metered subscription item ID: ${usageBasedItem.id}`);
} else {
    console.warn(`âš ï¸ è®¢é˜…ä¸­æ²¡æœ‰ä½¿ç”¨é‡è®¡è´¹é¡¹ç›®`);
}
```

### 2. æ·»åŠ æ—¥å¿—ç›‘æ§ ğŸ“Š

åœ¨ Firebase Console â†’ Functions â†’ Logs ä¸­ç›‘æ§ä»¥ä¸‹æ—¥å¿—ï¼š

```
âœ… "âœ… è¶…é¢ä½¿ç”¨å·²æŠ¥å‘Šç»™ Stripe:"  â† æˆåŠŸ
âŒ "âš ï¸ ç¼ºå°‘ Stripe è®¢é˜…ä¿¡æ¯ï¼Œç„¡æ³•å ±å‘Šè¶…é¡ä½¿ç”¨"  â† å¤±è´¥ï¼ˆéœ€è¦ç«‹å³ä¿®å¤ï¼‰
âŒ "âŒ å ±å‘Šè¶…é¡ä½¿ç”¨å¤±æ•—:"  â† å¤±è´¥ï¼ˆéœ€è¦ç«‹å³ä¿®å¤ï¼‰
```

### 3. å®šæœŸæ£€æŸ¥æœªè®¡è´¹çš„è¶…é¢ä½¿ç”¨ ğŸ””

åˆ›å»ºä¸€ä¸ªå®šæœŸä»»åŠ¡ï¼ˆæ¯å¤©è¿è¡Œï¼‰ï¼š

```javascript
// ä¼ªä»£ç 
exports.checkUnreportedOverage = functions.pubsub.schedule('0 2 * * *').onRun(async (context) => {
    // æŸ¥æ‰¾æ‰€æœ‰ Credits < 0 çš„ç”¨æˆ·
    const usersWithOverage = await db.collection('users')
        .where('currentCredits', '<', 0)
        .get();
    
    // æŠ¥å‘Šè¶…é¢ä½¿ç”¨
    for (const userDoc of usersWithOverage.docs) {
        // æ£€æŸ¥æ˜¯å¦å·²æŠ¥å‘Š
        // å¦‚æœæœªæŠ¥å‘Šï¼Œå‘é€è­¦æŠ¥é‚®ä»¶ç»™ç®¡ç†å‘˜
    }
});
```

## è¯Šæ–­å·¥å…· API

### diagnoseOverageCharging

**åŠŸèƒ½**ï¼šè¯Šæ–­ç”¨æˆ·çš„è¶…é¢è®¡è´¹é—®é¢˜

**è°ƒç”¨æ–¹å¼**ï¼š
```javascript
const diagnoseOverageCharging = functions.httpsCallable('diagnoseOverageCharging');
const result = await diagnoseOverageCharging({ email: '1234@gmail.com' });
```

**è¿”å›ç»“æœ**ï¼š
```json
{
  "userId": "xxxxx",
  "email": "1234@gmail.com",
  "currentCredits": 0,
  "planType": "Free Plan",
  "meteredItemId": "si_xxxxx" or null,
  "stripeSubscriptionId": "sub_xxxxx" or null,
  "checks": {
    "hasMeteredItem": true,
    "hasSubscriptionId": true,
    "canReportUsage": true
  },
  "stripeUsageRecords": [...],
  "totalStripeUsage": 6,
  "creditsHistory": [...]
}
```

### manualReportOverage

**åŠŸèƒ½**ï¼šæ‰‹åŠ¨å‘ Stripe æŠ¥å‘Šè¶…é¢ä½¿ç”¨ï¼ˆä»…ç”¨äºä¿®å¤ï¼‰

**è°ƒç”¨æ–¹å¼**ï¼š
```javascript
const manualReportOverage = functions.httpsCallable('manualReportOverage');
const result = await manualReportOverage({ 
    email: '1234@gmail.com',
    overageAmount: 6
});
```

**è¿”å›ç»“æœ**ï¼š
```json
{
  "success": true,
  "usageRecordId": "mbur_xxxxx",
  "overageAmount": 6,
  "message": "âœ… å·²å‘ Stripe æŠ¥å‘Š 6 Credits çš„è¶…é¢ä½¿ç”¨"
}
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ Stripe ä¸­çœ‹ä¸åˆ°è¶…é¢è´¹ç”¨ï¼Ÿ

**A**: Stripe æŒ‰é‡è®¡è´¹ä¸æ˜¯ç«‹å³æ”¶è´¹ï¼Œè€Œæ˜¯åœ¨è®¡è´¹å‘¨æœŸç»“æŸæ—¶ç”Ÿæˆå‘ç¥¨ã€‚å¦‚æœè®¢é˜…å·²å–æ¶ˆï¼Œéœ€è¦æ‰‹åŠ¨ç”Ÿæˆå‘ç¥¨ã€‚

### Q2: è®¢é˜…å–æ¶ˆåè¿˜èƒ½æŠ¥å‘Šè¶…é¢ä½¿ç”¨å—ï¼Ÿ

**A**: 
- âœ… å¦‚æœåœ¨ `customer.subscription.deleted` äº‹ä»¶ä¸­æŠ¥å‘Šï¼Œå¯ä»¥ã€‚
- âŒ å¦‚æœè®¢é˜…å·²å®Œå…¨å–æ¶ˆï¼Œsubscription items å¤±æ•ˆï¼Œæ— æ³•å†æŠ¥å‘Šã€‚
- ğŸ”§ è§£å†³æ–¹æ¡ˆï¼šåœ¨ Stripe Dashboard ä¸­æ‰‹åŠ¨åˆ›å»ºå‘ç¥¨ã€‚

### Q3: å¦‚ä½•éªŒè¯è¶…é¢ä½¿ç”¨å·²æŠ¥å‘Šï¼Ÿ

**A**: 
1. ä½¿ç”¨è¯Šæ–­å·¥å…·æŸ¥çœ‹ `totalStripeUsage`
2. åœ¨ Stripe Dashboard â†’ Subscriptions â†’ Usage-based items ä¸­æŸ¥çœ‹
3. æŸ¥çœ‹ Firebase Functions æ—¥å¿—ï¼š`âœ… è¶…é¡ä½¿ç”¨å·²å ±å‘Šçµ¦ Stripe:`

### Q4: æ‰‹åŠ¨æŠ¥å‘Šåï¼Œè´¹ç”¨ä»€ä¹ˆæ—¶å€™æ”¶å–ï¼Ÿ

**A**: æ‰‹åŠ¨æŠ¥å‘Šåªæ˜¯æ·»åŠ ä½¿ç”¨è®°å½•ï¼Œè¿˜éœ€è¦ï¼š
1. ç­‰å¾…ä¸‹ä¸€ä¸ªè®¡è´¹å‘¨æœŸï¼ˆå¦‚æœè®¢é˜…è¿˜æ´»è·ƒï¼‰
2. æˆ–åœ¨ Stripe Dashboard ä¸­æ‰‹åŠ¨ "Create Invoice"

## æ€»ç»“

### âœ… ç«‹å³è¡ŒåŠ¨æ¸…å•

1. [ ] ä½¿ç”¨è¯Šæ–­å·¥å…·æ£€æŸ¥ `1234@gmail.com`
2. [ ] ç¡®è®¤ `meteredItemId` æ˜¯å¦å­˜åœ¨
3. [ ] å¦‚æœå­˜åœ¨ä¸” `totalStripeUsage: 0`ï¼Œä½¿ç”¨æ‰‹åŠ¨æŠ¥å‘ŠåŠŸèƒ½
4. [ ] åœ¨ Stripe Dashboard ä¸­åˆ›å»ºå‘ç¥¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
5. [ ] éªŒè¯å‘ç¥¨é‡‘é¢ä¸º HK$3.00
6. [ ] æ£€æŸ¥å…¶ä»–å¯èƒ½å—å½±å“çš„ç”¨æˆ·

### ğŸ“‹ é•¿æœŸæ”¹è¿›

1. [ ] æ·»åŠ æ—¥å¿—ç›‘æ§
2. [ ] åˆ›å»ºå®šæœŸæ£€æŸ¥ä»»åŠ¡
3. [ ] æ”¹è¿›é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
4. [ ] æ·»åŠ ç®¡ç†å‘˜è­¦æŠ¥

---

**åˆ›å»ºæ—¶é—´ï¼š** 2025-12-15  
**è¯Šæ–­å·¥å…·ï¼š** `overage-diagnostic.html`  
**Cloud Functionsï¼š** `diagnoseOverageCharging`, `manualReportOverage`

