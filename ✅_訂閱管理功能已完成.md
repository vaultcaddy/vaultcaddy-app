# ✅ 訂閱管理功能已完成

## 🎯 **問題**

用戶的 Credits 顯示為 `-1`（超額使用），想要取消訂閱，但沒有入口。

---

## ✅ **解決方案**

在 `account.html` 頁面添加了完整的**訂閱管理**功能，包括：

1. ✅ 顯示訂閱狀態（活躍/已取消）
2. ✅ 顯示訂閱週期（月付/年付）
3. ✅ 顯示下次計費日期
4. ✅ "管理訂閱"按鈕（跳轉到 Stripe Customer Portal）

---

## 📸 **新功能預覽**

### **Pro Plan 用戶看到的內容**

```
┌────────────────────────────────────────┐
│ 目前計劃                                │
│ ┌────────────────────────────────────┐ │
│ │ 👑 Pro Plan                         │ │
│ └────────────────────────────────────┘ │
│                                        │
│ ● 訂閱活躍 (月付)                       │
│ 📅 下次計費：2026年1月13日               │
│                                        │
│ ┌────────────────────────────────────┐ │
│ │ ⚙️  管理訂閱                         │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
```

### **Free Plan 用戶看到的內容**

```
┌────────────────────────────────────────┐
│ 目前計劃                                │
│ ┌────────────────────────────────────┐ │
│ │ 🎁 Free Plan                        │ │
│ └────────────────────────────────────┘ │
│                                        │
│ 升級計劃 →                              │
└────────────────────────────────────────┘
```

---

## 🔧 **功能詳情**

### **1. 訂閱狀態顯示**

#### **活躍訂閱**
- 🟢 綠色圓點 + "訂閱活躍"
- 顯示週期：(月付) 或 (年付)
- 顯示下次計費日期

#### **已取消訂閱（但仍在有效期內）**
- 🟡 橙色三角警告 + "訂閱將於期末取消"
- **不顯示**下次計費日期

---

### **2. 管理訂閱按鈕**

點擊"管理訂閱"按鈕後，會跳轉到 **Stripe Customer Portal**，用戶可以：

1. ✅ **取消訂閱**
   - 立即取消（不退款）
   - 或在期末取消（繼續使用到期末）

2. ✅ **更新支付方式**
   - 更換信用卡
   - 更改帳單信息

3. ✅ **查看發票歷史**
   - 下載所有發票
   - 查看付款記錄

4. ✅ **查看訂閱詳情**
   - 查看當前計劃
   - 查看下次計費金額
   - 查看使用量（超額計費）

---

## 💡 **關於 Credits: -1**

### **為什麼會是負數？**

```
Pro Plan（月費）包含：100 Credits
實際使用：101 Credits
結果：Credits = -1（超額 1 個）
```

### **超額計費**

```
超額 Credits：1 個
單價：HK$0.50/Credit
超額費用：HK$0.50

會在下次計費時自動扣除
```

### **如何避免超額？**

1. **方法 1：取消訂閱**
   - 點擊"管理訂閱"
   - 在 Stripe Portal 中取消訂閱
   - 訂閱會在期末自動取消

2. **方法 2：控制使用量**
   - 密切關注 Credits 餘額
   - 在 Credits 用完前停止上傳

3. **方法 3：升級計劃**
   - 如果經常超額，考慮年付計劃
   - 年付包含 1200 Credits（省 21%）

---

## 🔐 **Stripe Customer Portal**

### **什麼是 Customer Portal？**

Stripe Customer Portal 是 Stripe 官方提供的**安全自助服務頁面**，用戶可以：

- 🔒 **安全**：完全由 Stripe 託管，我們無法訪問
- 🌐 **官方**：Stripe 官方工具，非第三方
- 🎨 **品牌化**：可以自定義顏色和 Logo

### **用戶體驗**

1. 點擊"管理訂閱"按鈕
2. 跳轉到 Stripe 頁面（`https://billing.stripe.com/...`）
3. 自動登入（基於 Stripe Customer ID）
4. 管理訂閱後，點擊"返回 VaultCaddy"
5. 自動跳回 `account.html`

---

## 📊 **訂閱取消流程**

### **場景 1：用戶在期中取消訂閱**

```
1. 用戶點擊"管理訂閱"
2. 在 Stripe Portal 中選擇"取消訂閱"
3. 選擇"在期末取消"（推薦）或"立即取消"
4. 訂閱狀態變為"將於期末取消"
5. 用戶可以繼續使用到期末
6. 到期後，Credits 重置為 50（根據之前的規則）
7. 如果有超額費用，需要先支付
```

### **場景 2：用戶立即取消訂閱**

```
1. 用戶選擇"立即取消"
2. 訂閱立即終止
3. 如果有超額費用，會立即收取
4. Credits 重置為 50（正數）或 0（負數支付後）
5. 用戶降級為 Free Plan
```

---

## 🧪 **測試步驟**

### **測試 1：查看訂閱狀態（Pro Plan 用戶）**

1. 訪問 https://vaultcaddy.com/account.html
2. 使用 Pro Plan 帳號登入（如 `vaultcaddy@gmail.com`）
3. 查看"目前計劃"區域
4. 應該看到：
   - 👑 Pro Plan（紫色漸變）
   - ● 訂閱活躍 (月付/年付)
   - 📅 下次計費：[日期]
   - ⚙️ 管理訂閱按鈕

### **測試 2：打開 Stripe Customer Portal**

1. 點擊"管理訂閱"按鈕
2. 按鈕應顯示"載入中..."
3. 自動跳轉到 Stripe 頁面
4. 應該看到：
   - 當前訂閱詳情
   - 取消訂閱選項
   - 更新支付方式選項
   - 發票歷史

### **測試 3：取消訂閱**

1. 在 Stripe Portal 中點擊"取消訂閱"
2. 選擇"在期末取消"
3. 返回 VaultCaddy
4. 刷新 `account.html`
5. 應該看到：
   - ⚠️ 訂閱將於期末取消
   - 橙色警告圖標
   - **不顯示**下次計費日期

### **測試 4：Free Plan 用戶**

1. 使用 Free Plan 帳號登入
2. 應該看到：
   - 🎁 Free Plan（灰色漸變）
   - "升級計劃 →" 鏈接
   - **不顯示**"管理訂閱"按鈕

---

## 💻 **技術實現**

### **前端（account.html）**

#### **1. 新增 HTML 結構**

```html
<!-- 訂閱管理按鈕（Pro Plan 用戶才顯示）-->
<div id="subscription-management" style="display: none;">
    <!-- 訂閱狀態 -->
    <div id="subscription-status">
        <i class="fas fa-circle" style="color: #10b981;"></i>
        <span id="subscription-status-text">訂閱活躍</span>
    </div>
    
    <!-- 下次計費日期 -->
    <div id="next-billing-date" style="display: none;">
        下次計費：<span id="next-billing-date-text"></span>
    </div>
    
    <!-- 管理訂閱按鈕 -->
    <button onclick="openStripeCustomerPortal()">
        <i class="fas fa-cog"></i>
        管理訂閱
    </button>
</div>
```

#### **2. JavaScript 邏輯**

```javascript
// 加載訂閱詳情
async function loadSubscriptionDetails() {
    const userData = ...;
    
    // 顯示訂閱週期
    if (userData.subscriptionPeriod) {
        const periodText = userData.subscriptionPeriod === 'monthly' ? '(月付)' : '(年付)';
        subscriptionPeriodText.textContent = periodText;
    }
    
    // 檢查是否已取消
    if (userData.subscriptionCancelAtPeriodEnd) {
        subscriptionStatusText.innerHTML = '⚠️ 訂閱將於期末取消';
    }
    
    // 顯示下次計費日期
    if (userData.resetDate && !userData.subscriptionCancelAtPeriodEnd) {
        nextBillingDateText.textContent = resetDate.toLocaleDateString();
    }
}

// 打開 Stripe Customer Portal
async function openStripeCustomerPortal() {
    const functions = firebase.functions();
    const createPortalSession = functions.httpsCallable('createStripeCustomerPortalSession');
    
    const result = await createPortalSession({
        returnUrl: window.location.href
    });
    
    window.location.href = result.data.url;
}
```

---

### **後端（firebase-functions/index.js）**

#### **新增 Cloud Function**

```javascript
exports.createStripeCustomerPortalSession = functions.https.onCall(async (data, context) => {
    // 檢查用戶是否已登入
    if (!context.auth) {
        throw new functions.https.HttpsError('unauthenticated', '請先登入');
    }
    
    const userId = context.auth.uid;
    const { returnUrl } = data;
    
    // 從 Firestore 獲取 Stripe Customer ID
    const userDoc = await admin.firestore().collection('users').doc(userId).get();
    const stripeCustomerId = userDoc.data().stripeCustomerId;
    
    if (!stripeCustomerId) {
        throw new functions.https.HttpsError('failed-precondition', '您還沒有訂閱記錄');
    }
    
    // 創建 Customer Portal Session
    const session = await stripeLive.billingPortal.sessions.create({
        customer: stripeCustomerId,
        return_url: returnUrl || 'https://vaultcaddy.com/account.html'
    });
    
    return { url: session.url };
});
```

---

## 📁 **修改的文件**

### **1. `account.html`**
- **行數**：1016-1028（HTML 結構）
- **行數**：1318-1329（`loadUserPlan` 函數）
- **行數**：1331-1427（新增函數）
  - `loadSubscriptionDetails()`
  - `openStripeCustomerPortal()`

### **2. `firebase-functions/index.js`**
- **行數**：2045-2103（新增 Cloud Function）
  - `createStripeCustomerPortalSession`

---

## 🚀 **部署狀態**

- **部署時間**：2025-12-14 13:40
- **URL**：https://vaultcaddy.com/account.html
- **狀態**：✅ 已部署（前端 + 後端）
- **Cloud Function**：`createStripeCustomerPortalSession` ✅ 已創建

---

## 📋 **重要提醒**

### **1. Stripe Customer Portal 配置**

需要在 Stripe Dashboard 中配置 Customer Portal：

1. 訪問：https://dashboard.stripe.com/settings/billing/portal
2. 啟用 Customer Portal
3. 配置允許的操作：
   - ✅ 取消訂閱
   - ✅ 更新支付方式
   - ✅ 查看發票
4. 設置品牌：
   - 上傳 Logo
   - 設置品牌顏色

### **2. 測試模式 vs 生產模式**

- **測試模式**：不支持 Customer Portal（Stripe 限制）
- **生產模式**：完整支持所有功能
- 測試時請使用**生產模式**測試（可以立即取消，不會產生費用）

### **3. Credits: -1 的處理**

- 負數 Credits 表示超額使用
- 超額費用會在下次 `invoice.paid` 時自動收取
- 如果用戶取消訂閱，超額費用會在最後一次發票中收取

---

## 🎯 **下一步建議**

### **可選優化（未實現）**

1. **訂閱升級/降級**
   - 允許用戶在月付/年付之間切換
   - 需要在 Stripe Portal 中配置

2. **優惠碼**
   - 允許用戶應用優惠碼
   - 已在 Checkout Session 中啟用

3. **暫停訂閱**
   - 允許用戶暫停訂閱（保留 Credits）
   - 需要額外邏輯

4. **訂閱通知**
   - Email 提醒：訂閱即將到期
   - Email 提醒：訂閱已取消

---

## ✅ **總結**

### **問題**
- Credits 顯示 -1（超額使用）
- 沒有取消訂閱的入口

### **解決方案**
- 在 `account.html` 添加訂閱管理功能
- 集成 Stripe Customer Portal
- 用戶可以自助管理訂閱

### **功能**
- ✅ 顯示訂閱狀態和下次計費日期
- ✅ 取消訂閱
- ✅ 更新支付方式
- ✅ 查看發票歷史

---

**🎉 訂閱管理功能已完成並部署！**  
**請訪問 https://vaultcaddy.com/account.html 測試！**

