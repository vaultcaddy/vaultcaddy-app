# âœ… åªæŠ¥å‘Šè¶…é¢ä½¿ç”¨é‡ï¼ˆè´Ÿæ•°æ‰è®¡è´¹ï¼‰

## ğŸ¯ éœ€æ±‚

ç”¨æˆ·æœ‰ **120 ä¸ªå…è´¹ Credits**ï¼š
- æœˆè´¹åŒ…å«ï¼š100 Credits
- Email éªŒè¯èµ é€ï¼š20 Credits

**è¦æ±‚**ï¼šåªæœ‰å½“ Credits å˜æˆ**è´Ÿæ•°**æ—¶ï¼Œæ‰å‘ Stripe æŠ¥å‘Šè¶…é¢ä½¿ç”¨é‡ã€‚

---

## âœ… å®ç°é€»è¾‘

### ä¿®æ”¹ä½ç½®
`firebase-functions/index.js` - `deductCredits` å‡½æ•°ï¼ˆç¬¬1138-1175è¡Œï¼‰

### æ ¸å¿ƒé€»è¾‘

```javascript
// äº‹åŠ¡è¿”å›æ‰£é™¤å‰åçš„ credits
return { previousCredits: currentCredits, newCredits: newCredits };

// äº‹åŠ¡å®Œæˆååˆ¤æ–­
if (newCredits < 0) {
    // Credits ä¸ºè´Ÿæ•°ï¼Œå·²è¶…è¿‡å…è´¹é¢åº¦
    
    if (previousCredits >= 0) {
        // ğŸ”¥ é¦–æ¬¡è¶…é¢ï¼šä»æ­£æ•°å˜æˆè´Ÿæ•°
        // æŠ¥å‘Šæ•´ä¸ªè´Ÿæ•°éƒ¨åˆ†
        reportAmount = Math.abs(newCredits);
    } else {
        // ğŸ”¥ ç»§ç»­è¶…é¢ï¼šå·²ç»æ˜¯è´Ÿæ•°
        // åªæŠ¥å‘Šæœ¬æ¬¡æ‰£é™¤çš„æ•°é‡
        reportAmount = amount;
    }
    
    await reportUsageToStripe(userId, reportAmount);
} else {
    // Credits è¿˜ä¸ºæ­£æ•°ï¼Œåœ¨å…è´¹é¢åº¦å†…ï¼Œè·³è¿‡æŠ¥å‘Š
}
```

---

## ğŸ“Š ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡è¶…é¢

| æ“ä½œ | Credits å˜åŒ– | å‘ Stripe æŠ¥å‘Š |
|------|-------------|---------------|
| åˆå§‹ | 120 | - |
| ä¸Šä¼  50 é¡µ | 70 | **ä¸æŠ¥å‘Š**ï¼ˆè¿˜ä¸ºæ­£æ•°ï¼‰|
| ä¸Šä¼  80 é¡µ | -10 | **æŠ¥å‘Š 10**ï¼ˆé¦–æ¬¡è¶…é¢ï¼ŒæŠ¥å‘Šæ•´ä¸ªè´Ÿæ•°éƒ¨åˆ†ï¼‰|

### åœºæ™¯2ï¼šç»§ç»­è¶…é¢

| æ“ä½œ | Credits å˜åŒ– | å‘ Stripe æŠ¥å‘Š |
|------|-------------|---------------|
| å½“å‰ | -10 | - |
| ä¸Šä¼  5 é¡µ | -15 | **æŠ¥å‘Š 5**ï¼ˆç»§ç»­è¶…é¢ï¼ŒåªæŠ¥å‘Šæœ¬æ¬¡ä½¿ç”¨ï¼‰|
| ä¸Šä¼  3 é¡µ | -18 | **æŠ¥å‘Š 3**ï¼ˆç»§ç»­è¶…é¢ï¼ŒåªæŠ¥å‘Šæœ¬æ¬¡ä½¿ç”¨ï¼‰|

### åœºæ™¯3ï¼šåœ¨å…è´¹é¢åº¦å†…

| æ“ä½œ | Credits å˜åŒ– | å‘ Stripe æŠ¥å‘Š |
|------|-------------|---------------|
| åˆå§‹ | 120 | - |
| ä¸Šä¼  30 é¡µ | 90 | **ä¸æŠ¥å‘Š** âœ… |
| ä¸Šä¼  40 é¡µ | 50 | **ä¸æŠ¥å‘Š** âœ… |
| ä¸Šä¼  20 é¡µ | 30 | **ä¸æŠ¥å‘Š** âœ… |

---

## ğŸ” æ—¥å¿—ç¤ºä¾‹

### åœ¨å…è´¹é¢åº¦å†…
```
âš ï¸ Credits è¿˜ä¸ºæ­£æ•° (30)ï¼Œåœ¨å…è´¹é¢åº¦å†…ï¼Œè·³è¿‡ Stripe æŠ¥å‘Š
```

### é¦–æ¬¡è¶…é¢
```
ğŸ’° é¦–æ¬¡è¶…é¢ï¼šCredits ä» 10 é™è‡³ -5
   æŠ¥å‘Šè¶…é¢ä½¿ç”¨: 5 Credits
âœ… è¶…é¢ä½¿ç”¨é‡å·²æŠ¥å‘Šç»™ Stripe Billing Meter
```

### ç»§ç»­è¶…é¢
```
ğŸ’° ç»§ç»­è¶…é¢ï¼šCredits ä» -5 é™è‡³ -8
   æŠ¥å‘Šæœ¬æ¬¡ä½¿ç”¨: 3 Credits
âœ… è¶…é¢ä½¿ç”¨é‡å·²æŠ¥å‘Šç»™ Stripe Billing Meter
```

---

## ğŸ‰ Stripe Billing é…ç½®

### ä¿æŒåŸæœ‰çš„æ¢¯åº¦å®šä»·
- **1-100 = $0**
- **101+ = $0.5/Credit**

### å·¥ä½œåŸç†
1. ç”¨æˆ·åœ¨å…è´¹é¢åº¦å†…ï¼ˆCredits > 0ï¼‰ï¼š**ä¸å‘ Stripe æŠ¥å‘Š**
2. ç”¨æˆ·é¦–æ¬¡è¶…é¢ï¼ˆCredits å˜æˆè´Ÿæ•°ï¼‰ï¼š**æŠ¥å‘Šè¶…é¢éƒ¨åˆ†**
3. Stripe ä» **1 å¼€å§‹ç´¯è®¡**æ”¶åˆ°çš„ä½¿ç”¨é‡
4. å‰ 100 ä¸ªä¸º $0ï¼Œ101+ æŒ‰ $0.5/Credit è®¡è´¹

---

## âœ… ä¼˜ç‚¹

1. âœ… **ç²¾ç¡®æ§åˆ¶**ï¼šå®Œå…¨æŒæ¡ä½•æ—¶å¼€å§‹å‘ Stripe æŠ¥å‘Š
2. âœ… **å…è´¹é¢åº¦ä¿æŠ¤**ï¼šç¡®ä¿ç”¨æˆ·çš„ 120 ä¸ªå…è´¹ Credits ä¸ä¼šè¢«æ”¶è´¹
3. âœ… **ç®€åŒ– Stripe é…ç½®**ï¼šä¿æŒåŸæœ‰çš„æ¢¯åº¦å®šä»·ä¸å˜
4. âœ… **çµæ´»æ€§**ï¼šå¦‚æœä»¥åè¦æ”¹å…è´¹é¢åº¦ï¼Œåªéœ€ä¿®æ”¹åç«¯é€»è¾‘

---

## ğŸš€ å·²éƒ¨ç½²

```bash
âœ”  functions[deductCreditsClient(us-central1)] Successful update operation.
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æ‰‹åŠ¨è®¾ç½® Credits ä¸ºæ¥è¿‘ 0 çš„å€¼
åœ¨ Firestore ä¸­è®¾ç½®ï¼š`credits: 5`

### 2. ä¸Šä¼  10 é¡µæ–‡æ¡£
- Credits: 5 â†’ -5
- é¢„æœŸï¼šå‘ Stripe æŠ¥å‘Š 5 Credits

### 3. å†ä¸Šä¼  3 é¡µæ–‡æ¡£
- Credits: -5 â†’ -8
- é¢„æœŸï¼šå‘ Stripe æŠ¥å‘Š 3 Credits

### 4. æŸ¥çœ‹ Firebase Logs
åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ’° é¦–æ¬¡è¶…é¢ï¼šCredits ä» 5 é™è‡³ -5
   æŠ¥å‘Šè¶…é¢ä½¿ç”¨: 5 Credits
âœ… è¶…é¢ä½¿ç”¨é‡å·²æŠ¥å‘Šç»™ Stripe Billing Meter
```

### 5. æŸ¥çœ‹ Stripe Meter
- ç¬¬ä¸€æ¬¡ï¼šæ˜¾ç¤º 5
- ç¬¬äºŒæ¬¡ï¼šæ˜¾ç¤º 5 + 3 = 8ï¼ˆç´¯è®¡ï¼‰



