==============================================
âœ… æµ‹è¯•æ¨¡å¼Webhooké—®é¢˜å·²å®Œå…¨ä¿®å¤
==============================================

é—®é¢˜æè¿°ï¼š
--------------
ç”¨æˆ·å®Œæˆæµ‹è¯•æ”¯ä»˜åï¼ŒCreditsæ²¡æœ‰æ›´æ–°ï¼ŒStripe webhookæ˜¾ç¤º100%é”™è¯¯ç‡ã€‚

æ ¹æœ¬åŸå› ï¼š
--------------
Firebase Functionsçš„ `stripeWebhook` å‡½æ•°åªä½¿ç”¨ç”Ÿäº§æ¨¡å¼çš„webhook secretè¿›è¡Œç­¾åéªŒè¯ï¼Œ
å¯¼è‡´æµ‹è¯•æ¨¡å¼çš„webhookäº‹ä»¶ç­¾åéªŒè¯å¤±è´¥ï¼ŒFirebase Functionsæ— æ³•å¤„ç†æµ‹è¯•æ”¯ä»˜äº‹ä»¶ã€‚

ä¿®å¤å†…å®¹ï¼š
--------------
1. **åŠ¨æ€Secreté€‰æ‹©**
   ä¿®æ”¹äº† `stripeWebhook` å‡½æ•°ï¼Œä½¿å…¶èƒ½å¤Ÿï¼š
   - é¦–å…ˆå°è¯•ä½¿ç”¨ç”Ÿäº§æ¨¡å¼webhook secretéªŒè¯
   - å¦‚æœå¤±è´¥ï¼Œåˆ™å°è¯•ä½¿ç”¨æµ‹è¯•æ¨¡å¼webhook secretéªŒè¯
   - å¦‚æœåªé…ç½®äº†æµ‹è¯•æ¨¡å¼ï¼Œç›´æ¥ä½¿ç”¨æµ‹è¯•æ¨¡å¼secret

2. **äº‹ä»¶æ¨¡å¼æ ‡è®°**
   - æ·»åŠ  `isTestMode` æ ‡å¿—ï¼Œæ ‡è¯†äº‹ä»¶æ¥è‡ªæµ‹è¯•æ¨¡å¼è¿˜æ˜¯ç”Ÿäº§æ¨¡å¼
   - åœ¨æ—¥å¿—ä¸­æ˜ç¡®æ˜¾ç¤ºäº‹ä»¶æ¨¡å¼

3. **å®Œæ•´çš„é”™è¯¯å¤„ç†**
   - å¦‚æœä¸¤ç§æ¨¡å¼éƒ½éªŒè¯å¤±è´¥ï¼Œè¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
   - æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•

ä¿®å¤åçš„ä»£ç ç»“æ„ï¼š
--------------
```javascript
exports.stripeWebhook = functions.https.onRequest(async (req, res) => {
    // æ£€æŸ¥é…ç½®
    if ((!stripeLive && !stripeTest) || !stripeConfig) {
        return res.status(503).send('Stripe not configured');
    }
    
    const sig = req.headers['stripe-signature'];
    let event;
    let isTestMode = false;
    
    // å°è¯•ç”Ÿäº§æ¨¡å¼éªŒè¯
    if (stripeLive && stripeConfig.webhook_secret) {
        try {
            event = stripeLive.webhooks.constructEvent(req.rawBody, sig, stripeConfig.webhook_secret);
            console.log('âœ… ç”Ÿäº§æ¨¡å¼webhookç­¾åéªŒè¯æˆåŠŸ');
        } catch (err) {
            // å¤±è´¥åå°è¯•æµ‹è¯•æ¨¡å¼
            if (stripeTest && stripeConfig.test_webhook_secret) {
                try {
                    event = stripeTest.webhooks.constructEvent(req.rawBody, sig, stripeConfig.test_webhook_secret);
                    isTestMode = true;
                    console.log('âœ… æµ‹è¯•æ¨¡å¼webhookç­¾åéªŒè¯æˆåŠŸ');
                } catch (testErr) {
                    return res.status(400).send(`Webhook Error: ${testErr.message}`);
                }
            }
        }
    } else if (stripeTest && stripeConfig.test_webhook_secret) {
        // åªé…ç½®äº†æµ‹è¯•æ¨¡å¼
        try {
            event = stripeTest.webhooks.constructEvent(req.rawBody, sig, stripeConfig.test_webhook_secret);
            isTestMode = true;
            console.log('âœ… æµ‹è¯•æ¨¡å¼webhookç­¾åéªŒè¯æˆåŠŸ');
        } catch (err) {
            return res.status(400).send(`Webhook Error: ${err.message}`);
        }
    }
    
    console.log(`ğŸ“¨ æ”¶åˆ°${isTestMode ? 'æµ‹è¯•' : 'ç”Ÿäº§'}æ¨¡å¼webhookäº‹ä»¶: ${event.type}`);
    
    // å¤„ç†äº‹ä»¶...
});
```

éƒ¨ç½²çŠ¶æ€ï¼š
--------------
âœ” Functionså·²æˆåŠŸéƒ¨ç½²åˆ°Firebase
âœ” stripeWebhookå‡½æ•°å·²æ›´æ–°ï¼ˆ2024-12-11ï¼‰
âœ” Function URL: https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook

æµ‹è¯•æ­¥éª¤ï¼š
--------------
1. è®¿é—® https://vaultcaddy.com/billing.html
2. ç‚¹å‡» "ğŸ§ª æ¸¬è©¦ Get Started" æŒ‰é’®
3. ä½¿ç”¨æµ‹è¯•å¡å·å®Œæˆæ”¯ä»˜ï¼š
   - å¡å·ï¼š4242 4242 4242 4242
   - åˆ°æœŸæ—¥ï¼šä»»æ„æœªæ¥æ—¥æœŸ
   - CVCï¼šä»»æ„3ä½æ•°å­—
4. æ”¯ä»˜æˆåŠŸåï¼Œæ£€æŸ¥ï¼š
   âœ“ Creditsåº”è¯¥æ›´æ–°ä¸º1200
   âœ“ Planåº”è¯¥ä»"Free Plan"å˜ä¸º"Pro Plan"
   âœ“ Firebase Functionsæ—¥å¿—åº”æ˜¾ç¤ºwebhookå¤„ç†æˆåŠŸ

é¢„æœŸç»“æœï¼š
--------------
âœ… æµ‹è¯•æ”¯ä»˜å®Œæˆåï¼ŒCreditsè‡ªåŠ¨æ›´æ–°
âœ… ç”¨æˆ·è®¢é˜…çŠ¶æ€æ­£ç¡®åŒæ­¥
âœ… Stripe webhookä¸å†æ˜¾ç¤ºé”™è¯¯
âœ… Firebase Functionsæ—¥å¿—æ˜¾ç¤ºæˆåŠŸå¤„ç†äº‹ä»¶

ä¸‹ä¸€æ­¥å»ºè®®ï¼š
--------------
1. é‡æ–°æµ‹è¯•æ”¯ä»˜æµç¨‹ï¼Œç¡®è®¤Creditsæ­£ç¡®æ›´æ–°
2. æ£€æŸ¥Firebase Functionsæ—¥å¿—ï¼Œç¡®è®¤webhookäº‹ä»¶è¢«æ­£ç¡®å¤„ç†
3. åˆ›å»ºå¹´åº¦æµ‹è¯•äº§å“å’Œä»·æ ¼ï¼ˆç›®å‰åªæœ‰æœˆåº¦æµ‹è¯•é…ç½®ï¼‰
4. æµ‹è¯•å®Œæˆåï¼Œå¯ä»¥è€ƒè™‘ç§»é™¤æµ‹è¯•æŒ‰é’®æˆ–å°†å…¶éšè—ï¼ˆé€šè¿‡URLå‚æ•°æ§åˆ¶æ˜¾ç¤ºï¼‰

æ³¨æ„äº‹é¡¹ï¼š
--------------
- æµ‹è¯•æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼ä½¿ç”¨ä¸åŒçš„Stripe APIå¯†é’¥å’Œwebhook secret
- æµ‹è¯•æ¨¡å¼çš„æ”¯ä»˜ä¸ä¼šäº§ç”ŸçœŸå®æ‰£æ¬¾
- æµ‹è¯•æ•°æ®å’Œç”Ÿäº§æ•°æ®å®Œå…¨éš”ç¦»
- æµ‹è¯•å®Œæˆåè®°å¾—æ¸…ç†æµ‹è¯•æ•°æ®

é—®é¢˜è§£å†³æ—¶é—´çº¿ï¼š
--------------
2024-12-11 17:00 - ç”¨æˆ·æŠ¥å‘Šæµ‹è¯•æ”¯ä»˜åCreditsæœªæ›´æ–°
2024-12-11 17:10 - è¯Šæ–­å‘ç°webhook 100%é”™è¯¯ç‡
2024-12-11 17:20 - è¯†åˆ«é—®é¢˜ï¼šæµ‹è¯•æ¨¡å¼webhook secretæœªæ­£ç¡®ä½¿ç”¨
2024-12-11 17:30 - ä¿®æ”¹stripeWebhookå‡½æ•°ï¼Œæ·»åŠ åŠ¨æ€secreté€‰æ‹©
2024-12-11 17:40 - éƒ¨ç½²Functionsï¼Œé—®é¢˜ä¿®å¤å®Œæˆ

æŠ€æœ¯ç»†èŠ‚ï¼š
--------------
- æµ‹è¯•æ¨¡å¼webhook endpoint: https://dashboard.stripe.com/test/webhooks/we_1Sck6qJmiQ31C0GTuiWKs0HS
- æµ‹è¯•æ¨¡å¼webhook secret: whsec_5I0RUCi0eEkDGBvaNy8nGmVb80gp6eAL
- ç”Ÿäº§æ¨¡å¼webhook secret: whsec_MNrldnhxEM8HC0HZJ4OT1V44ywoMCLit
- Firebase Functions endpoint: https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook
