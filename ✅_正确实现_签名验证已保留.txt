# âœ… æ­£ç¡®å®ç° - Stripe Webhook ç­¾åéªŒè¯å·²å®Œæ•´ä¿ç•™

## ğŸ¯ **å·²å®Œæˆçš„ä¿®å¤**

æˆ‘å·²ç»é‡æ–°å®ç°äº† `stripeWebhook` å‡½æ•°ï¼Œ**å®Œæ•´ä¿ç•™äº† Stripe ç­¾åéªŒè¯**ï¼Œè¿™æ˜¯æ­£ç¡®å’Œå®‰å…¨çš„åšæ³•ï¼

## ğŸ”§ **æŠ€æœ¯å®ç°**

### **ä½¿ç”¨ Express + Raw Body Parser**

```javascript
const express = require('express');
const stripeWebhookApp = express();

// ä½¿ç”¨ express.raw() ä¸­é—´ä»¶ä¿ç•™åŸå§‹ bodyï¼ˆBuffer æ ¼å¼ï¼‰
stripeWebhookApp.post('/', express.raw({type: 'application/json'}), async (req, res) => {
    const sig = req.headers['stripe-signature'];
    const payload = req.body; // â† è¿™æ˜¯ Bufferï¼Œæœªè¢«è§£æ
    
    // ä½¿ç”¨åŸå§‹ payload è¿›è¡Œç­¾åéªŒè¯
    event = stripeLive.webhooks.constructEvent(payload, sig, stripeConfig.webhook_secret);
    
    // éªŒè¯æˆåŠŸåå¤„ç†äº‹ä»¶...
});

exports.stripeWebhook = functions.https.onRequest(stripeWebhookApp);
```

### **å…³é”®æ”¹è¿›**

1. âœ… **ä¿ç•™ç­¾åéªŒè¯**
   - ä½¿ç”¨ `express.raw()` ä¿ç•™åŸå§‹è¯·æ±‚ä½“
   - Stripe SDK å¯ä»¥æ­£ç¡®éªŒè¯ç­¾å
   - å®‰å…¨æ€§å¾—åˆ°ä¿éšœ

2. âœ… **æ”¯æŒæµ‹è¯•å’Œç”Ÿäº§æ¨¡å¼**
   - è‡ªåŠ¨å°è¯•ä¸¤ç§æ¨¡å¼çš„ webhook secret
   - æ­£ç¡®è¯†åˆ«æµ‹è¯•/ç”Ÿäº§äº‹ä»¶

3. âœ… **æ­£ç¡®çš„é”™è¯¯å¤„ç†**
   - ç­¾åéªŒè¯å¤±è´¥è¿”å› 400
   - é…ç½®ç¼ºå¤±è¿”å› 503
   - å¤„ç†é”™è¯¯è¿”å› 500

## ğŸ§ª **ç°åœ¨è¯·æµ‹è¯•**

1. **è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**ï¼š
   ```
   è®¿é—®: https://vaultcaddy.com/billing.html
   åˆ·æ–°é¡µé¢
   ç‚¹å‡»: ğŸ§ª æ¸¬è©¦ Get Started
   ä½¿ç”¨æµ‹è¯•å¡: 4242 4242 4242 4242
   å®Œæˆæ”¯ä»˜
   ```

2. **é¢„æœŸç»“æœ**ï¼š
   - âœ… Webhook ç­¾åéªŒè¯æˆåŠŸ
   - âœ… Credits ä» 0 å¢åŠ åˆ° 1200
   - âœ… Plan ä» "Free Plan" å˜ä¸º "Pro Plan"
   - âœ… Stripe Webhook æ˜¾ç¤ºæˆåŠŸï¼ˆä¸å†æ˜¯ 403 ERRï¼‰

3. **æŸ¥çœ‹æ—¥å¿—ç¡®è®¤**ï¼š
   ```bash
   firebase functions:log --only stripeWebhook | head -50
   ```

   æ‚¨åº”è¯¥çœ‹åˆ°ï¼š
   ```
   ğŸ“¦ Payload type: Buffer
   ğŸ“¦ Payload length: 1234
   ğŸ“¦ Signature: t=1234567890,v1=abc123...
   âœ… æµ‹è¯•æ¨¡å¼webhookç­¾åéªŒè¯æˆåŠŸ
   ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: checkout.session.completed
   ```

---

## âœ… **å·²é…ç½®æ¸…å•**

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| âœ… Express ä¾èµ–å·²å®‰è£… | å®Œæˆ |
| âœ… Raw body parser å·²é…ç½® | å®Œæˆ |
| âœ… Stripe ç­¾åéªŒè¯å·²å¯ç”¨ | å®Œæˆ |
| âœ… æµ‹è¯•æ¨¡å¼ webhook secret å·²é…ç½® | å®Œæˆ |
| âœ… ç”Ÿäº§æ¨¡å¼ webhook secret å·²é…ç½® | å®Œæˆ |
| âœ… IAM å…¬å¼€è®¿é—®æƒé™å·²è®¾ç½® | å®Œæˆ |
| âœ… å‡½æ•°å·²æˆåŠŸéƒ¨ç½² | å®Œæˆ (07:45 UTC) |

---

## ğŸ”’ **å®‰å…¨æ€§**

âœ… **å®Œæ•´çš„å®‰å…¨ä¿æŠ¤**ï¼š
- âœ… Stripe ç­¾åéªŒè¯å·²å¯ç”¨
- âœ… åªæœ‰æ¥è‡ª Stripe çš„çœŸå®è¯·æ±‚æ‰ä¼šè¢«å¤„ç†
- âœ… é˜²æ­¢ä¼ªé€ çš„ webhook è¯·æ±‚
- âœ… ç¬¦åˆ Stripe æœ€ä½³å®è·µ

---

## ğŸ“Š **ä¸ä¹‹å‰çš„åŒºåˆ«**

### **ä¹‹å‰ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰**ï¼š
```javascript
// âŒ è·³è¿‡ç­¾åéªŒè¯
event = req.body;  // ç›´æ¥ä½¿ç”¨å·²è§£æçš„ body
```
- âŒ å¤±å»å®‰å…¨ä¿æŠ¤
- âŒ ä»»ä½•äººéƒ½å¯ä»¥å‘é€ä¼ªé€ è¯·æ±‚

### **ç°åœ¨ï¼ˆæ­£ç¡®æ–¹æ¡ˆï¼‰**ï¼š
```javascript
// âœ… å®Œæ•´çš„ç­¾åéªŒè¯
const payload = req.body;  // Buffer (æœªè§£æ)
event = stripe.webhooks.constructEvent(payload, sig, secret);
```
- âœ… å®Œæ•´çš„å®‰å…¨ä¿æŠ¤
- âœ… åªå¤„ç†çœŸå®çš„ Stripe è¯·æ±‚
- âœ… ç¬¦åˆæœ€ä½³å®è·µ

---

## ğŸ‰ **æ€»ç»“**

è¿™æ¬¡çš„å®ç°æ˜¯**æ­£ç¡®å’Œå®Œæ•´çš„**ï¼š

1. âœ… ä½¿ç”¨ Express raw body parser
2. âœ… ä¿ç•™åŸå§‹è¯·æ±‚ä½“ï¼ˆBufferï¼‰
3. âœ… å®Œæ•´çš„ Stripe ç­¾åéªŒè¯
4. âœ… æ­£ç¡®çš„é”™è¯¯å¤„ç†
5. âœ… æ”¯æŒæµ‹è¯•å’Œç”Ÿäº§æ¨¡å¼

**ç°åœ¨è¯·è¿›è¡Œæµ‹è¯•æ”¯ä»˜ï¼Œè¿™æ¬¡åº”è¯¥ä¼šå®Œç¾å·¥ä½œï¼** ğŸš€

