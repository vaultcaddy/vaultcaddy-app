# ğŸ’¡ æŒ‰é‡è®¡è´¹è¯´æ˜ï¼ˆé‡è¦ï¼‰

## â“ **æ‚¨çš„é—®é¢˜**

> "è½¬æ¢å Credits ç”± 0 æ”¹ä¸º -1ï¼Œæˆ‘ä»¬æ˜¯å¦ä¼šæ”¶åˆ° 0.5 å…ƒï¼Ÿ"

---

## âœ… **ç®€çŸ­å›ç­”**

**ç›®å‰è¿˜ä¸ä¼šè‡ªåŠ¨æ”¶è´¹ï¼** 

è™½ç„¶ Credits å·²ç»å¯ä»¥å˜ä¸ºè´Ÿæ•°ï¼ˆ-1ï¼‰ï¼Œä½†è¿˜éœ€è¦å®Œæˆæœ€åä¸€æ­¥é…ç½®ï¼Œæ‰èƒ½å®ç°è‡ªåŠ¨å‘ Stripe æŠ¥å‘Šä½¿ç”¨é‡å¹¶æ”¶è´¹ã€‚

---

## ğŸ“Š **æŒ‰é‡è®¡è´¹çš„å®Œæ•´æµç¨‹**

### **å·²å®Œæˆçš„éƒ¨åˆ†** âœ…ï¼š

1. âœ… **Stripe äº§å“é…ç½®**
   - å·²åˆ›å»ºæœˆè´¹äº§å“ï¼ˆHK$58/æœˆï¼ŒåŒ…å« 100 Creditsï¼‰
   - å·²åˆ›å»ºå¹´è´¹äº§å“ï¼ˆHK$552/å¹´ï¼ŒåŒ…å« 1,200 Creditsï¼‰
   - å·²åˆ›å»ºæŒ‰é‡è®¡è´¹ä»·æ ¼ï¼ˆHK$0.50/ä¸ª Creditï¼‰
   - å·²åˆ›å»º Stripe Meterï¼ˆ`vaultcaddy_credit_usage`ï¼‰

2. âœ… **å‰ç«¯é€»è¾‘**
   - Pro Plan ç”¨æˆ·å¯ä»¥åœ¨ Credits = 0 æ—¶ç»§ç»­ä½¿ç”¨
   - Credits å¯ä»¥å˜ä¸ºè´Ÿæ•°ï¼ˆ0 â†’ -1 â†’ -2 ...ï¼‰
   - Free Plan ç”¨æˆ· Credits ä¸è¶³æ—¶ä¼šè¢«é˜»æ­¢

3. âœ… **åç«¯é€»è¾‘**
   - è®¢é˜…åˆ›å»ºæ—¶åŒ…å«å›ºå®šä»·æ ¼ + æŒ‰é‡ä»·æ ¼
   - è®¢é˜…ç»­è´¹æ—¶æ¸…é›¶æ—§ Creditsï¼Œæ·»åŠ æ–° Credits
   - å·²æœ‰ `reportUsageToStripe` å‡½æ•°

---

### **æœªå®Œæˆçš„éƒ¨åˆ†** âŒï¼š

4. âŒ **å…³é”®æ­¥éª¤ï¼šä¿å­˜ `meteredSubscriptionItemId`**
   - å½“ç”¨æˆ·è®¢é˜…æ—¶ï¼ŒStripe ä¼šè¿”å›è®¢é˜…çš„è¯¦ç»†ä¿¡æ¯
   - è®¢é˜…åŒ…å«å¤šä¸ª `subscription_item`ï¼ˆä¸€ä¸ªå›ºå®šä»·æ ¼ï¼Œä¸€ä¸ªæŒ‰é‡ä»·æ ¼ï¼‰
   - æˆ‘ä»¬éœ€è¦æŠŠ**æŒ‰é‡ä»·æ ¼çš„ `subscription_item_id`** ä¿å­˜åˆ° Firestore
   - è¿™æ ·åç«¯æ‰èƒ½å‘ Stripe æŠ¥å‘Šä½¿ç”¨é‡

5. âŒ **è§¦å‘è‡ªåŠ¨è®¡è´¹**
   - å½“ Credits å˜ä¸ºè´Ÿæ•°æ—¶ï¼Œåç«¯éœ€è¦è°ƒç”¨ `reportUsageToStripe`
   - ç›®å‰å‰ç«¯åªåœ¨ Firestore ä¸­æ‰£é™¤ Creditsï¼Œä½†æ²¡æœ‰è°ƒç”¨åç«¯ Cloud Function

---

## ğŸ”§ **éœ€è¦ä¿®å¤çš„ä»£ç **

### **é—®é¢˜ 1ï¼š`handleSubscriptionChange` æ²¡æœ‰ä¿å­˜ `meteredSubscriptionItemId`**

**å½“å‰ä»£ç **ï¼ˆç¬¬ 480-493 è¡Œï¼‰ï¼š
```javascript
await db.collection('users').doc(userId).update({
    subscription: {
        stripeSubscriptionId: subscription.id,
        stripeCustomerId: subscription.customer,
        status: subscription.status,
        planType: planType,
        monthlyCredits: monthlyCredits,
        currentPeriodStart: ...,
        currentPeriodEnd: ...,
        cancelAtPeriodEnd: subscription.cancel_at_period_end
    },
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
});
```

**éœ€è¦æ·»åŠ **ï¼š
```javascript
// ğŸ” æŸ¥æ‰¾ metered subscription item
let meteredItemId = null;
for (const item of subscription.items.data) {
    const price = await stripeClient.prices.retrieve(item.price.id);
    if (price.recurring && price.recurring.usage_type === 'metered') {
        meteredItemId = item.id; // â† è¿™ä¸ª ID éœ€è¦ä¿å­˜ï¼
        break;
    }
}

await db.collection('users').doc(userId).update({
    subscription: {
        ...
        meteredSubscriptionItemId: meteredItemId // â† ä¿å­˜è¿™ä¸ª ID
    }
});
```

### **é—®é¢˜ 2ï¼šå‰ç«¯æ‰£é™¤ Credits åæ²¡æœ‰è§¦å‘åç«¯æŠ¥å‘Š**

**å½“å‰é€»è¾‘**ï¼š
1. å‰ç«¯è°ƒç”¨ `creditsManager.deductCredits(1)`
2. å‰ç«¯ç›´æ¥æ›´æ–° Firestore: `credits: 0 - 1 = -1`
3. **ç»“æŸ**ï¼ˆæ²¡æœ‰é€šçŸ¥åç«¯ï¼‰

**åº”è¯¥çš„é€»è¾‘**ï¼š
1. å‰ç«¯è°ƒç”¨ `creditsManager.deductCredits(1)`
2. å‰ç«¯ç›´æ¥æ›´æ–° Firestore: `credits: 0 - 1 = -1`
3. **è§¦å‘ Firestore Triggerï¼ˆCloud Functionï¼‰**
4. åç«¯æ£€æµ‹åˆ° Pro Plan ç”¨æˆ· Credits < 0
5. åç«¯è°ƒç”¨ `reportUsageToStripe(userId, 1)`
6. Stripe è®°å½•ä½¿ç”¨é‡ï¼š+1 credit Ã— HK$0.50 = HK$0.50
7. ä¸‹æ¬¡è´¦å•å‘¨æœŸè‡ªåŠ¨æ”¶è´¹

---

## ğŸ¯ **ä¸¤ç§å®ç°æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ 1ï¼šç®€å•æ–¹æ¡ˆï¼ˆæ¨èï¼‰**
- åœ¨å‰ç«¯ `deductCredits` æˆåŠŸåï¼Œå¦‚æœ Credits < 0ï¼Œè°ƒç”¨åç«¯ Cloud Function
- åç«¯ Cloud Function è´Ÿè´£å‘ Stripe æŠ¥å‘Šä½¿ç”¨é‡

**ä¼˜ç‚¹**ï¼š
- å®æ—¶æŠ¥å‘Šä½¿ç”¨é‡
- ä¸éœ€è¦å®šæ—¶ä»»åŠ¡

**ç¼ºç‚¹**ï¼š
- æ¯æ¬¡æ‰£é™¤éƒ½è¦è°ƒç”¨ Cloud Functionï¼ˆå¯èƒ½å¢åŠ æˆæœ¬ï¼‰

### **æ–¹æ¡ˆ 2ï¼šæ‰¹é‡æŠ¥å‘Šæ–¹æ¡ˆ**
- å‰ç«¯åªè´Ÿè´£æ‰£é™¤ Creditsï¼ˆä¸è°ƒç”¨åç«¯ï¼‰
- ä½¿ç”¨ Firestore Trigger ç›‘å¬ `users/{userId}` çš„ `credits` å­—æ®µå˜åŒ–
- å½“ Credits < 0 æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ Cloud Function æŠ¥å‘Šä½¿ç”¨é‡
- æˆ–è€…ä½¿ç”¨å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æ¯å°æ—¶ï¼‰æ‰¹é‡æŠ¥å‘Šæ‰€æœ‰è´Ÿæ•° Credits ç”¨æˆ·

**ä¼˜ç‚¹**ï¼š
- å‡å°‘ Cloud Function è°ƒç”¨æ¬¡æ•°
- æ›´é«˜æ•ˆ

**ç¼ºç‚¹**ï¼š
- éœ€è¦é…ç½® Firestore Trigger æˆ–å®šæ—¶ä»»åŠ¡
- æŠ¥å‘Šæœ‰å»¶è¿Ÿ

---

## ğŸ“ **å½“å‰çŠ¶æ€æ€»ç»“**

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Pro Plan ç”¨æˆ·å¯ä»¥ä½¿ç”¨è´Ÿæ•° Credits | âœ… å®Œæˆ | Credits: 0 â†’ -1 æ­£å¸¸å·¥ä½œ |
| Firestore è®°å½•è´Ÿæ•° Credits | âœ… å®Œæˆ | `currentCredits: -1` å·²ä¿å­˜ |
| è´­ä¹°è®°å½•æ˜¾ç¤ºæ‰£é™¤ | âœ… å®Œæˆ | "æ–‡ä»¶è½¬æ¢ -1" å·²æ˜¾ç¤º |
| ä¿å­˜ `meteredSubscriptionItemId` | âŒ æœªå®Œæˆ | è®¢é˜…æ—¶æ²¡æœ‰ä¿å­˜è¿™ä¸ª ID |
| å‘ Stripe æŠ¥å‘Šä½¿ç”¨é‡ | âŒ æœªå®Œæˆ | åç«¯å‡½æ•°å­˜åœ¨ï¼Œä½†æ²¡æœ‰è¢«è°ƒç”¨ |
| è‡ªåŠ¨æ”¶è´¹ | âŒ æœªå®Œæˆ | Stripe æ— æ³•è®¡è´¹ï¼ˆæ²¡æœ‰ä½¿ç”¨é‡æ•°æ®ï¼‰ |

---

## ğŸ’° **è´¹ç”¨è®¡ç®—ç¤ºä¾‹**

### **ç¤ºä¾‹ 1ï¼šæœˆè´¹ç”¨æˆ·ï¼ˆåŒ…å« 100 Creditsï¼‰**

**åœºæ™¯**ï¼š
- 2025å¹´12æœˆ13æ—¥ï¼šè®¢é˜…æœˆè´¹ï¼ˆHK$58ï¼‰ï¼Œè·å¾— 100 Credits
- 2025å¹´12æœˆ20æ—¥ï¼šä½¿ç”¨å®Œ 100 Credits
- 2025å¹´12æœˆ21æ—¥ï¼šç»§ç»­ä½¿ç”¨ 10 ä¸ª Creditsï¼ˆCredits å˜ä¸º -10ï¼‰

**è´¹ç”¨**ï¼š
- è®¢é˜…è´¹ï¼šHK$58.00ï¼ˆå·²æ”¯ä»˜ï¼‰
- è¶…é¢è´¹ï¼š10 Ã— HK$0.50 = **HK$5.00**
- **ä¸‹æ¬¡è´¦å•ï¼ˆ2026å¹´1æœˆ13æ—¥ï¼‰æ€»è´¹ç”¨ï¼šHK$58.00 + HK$5.00 = HK$63.00**

### **ç¤ºä¾‹ 2ï¼šå¹´è´¹ç”¨æˆ·ï¼ˆåŒ…å« 1,200 Creditsï¼‰**

**åœºæ™¯**ï¼š
- 2025å¹´12æœˆ13æ—¥ï¼šè®¢é˜…å¹´è´¹ï¼ˆHK$552ï¼‰ï¼Œè·å¾— 1,200 Credits
- 2026å¹´11æœˆ1æ—¥ï¼šä½¿ç”¨å®Œ 1,200 Credits
- 2026å¹´11æœˆ1æ—¥ - 12æœˆ12æ—¥ï¼šç»§ç»­ä½¿ç”¨ 50 ä¸ª Creditsï¼ˆCredits å˜ä¸º -50ï¼‰

**è´¹ç”¨**ï¼š
- è®¢é˜…è´¹ï¼šHK$552.00ï¼ˆå·²æ”¯ä»˜ï¼‰
- è¶…é¢è´¹ï¼š50 Ã— HK$0.50 = **HK$25.00**
- **ä¸‹æ¬¡è´¦å•ï¼ˆ2026å¹´12æœˆ13æ—¥ï¼‰æ€»è´¹ç”¨ï¼šHK$552.00 + HK$25.00 = HK$577.00**

---

## ğŸ”„ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

### **ç«‹å³éœ€è¦åšçš„**ï¼š
1. âœ… **ä¿®æ”¹ `handleSubscriptionChange` å‡½æ•°**
   - æŸ¥æ‰¾å¹¶ä¿å­˜ `meteredSubscriptionItemId`
   - æµ‹è¯•ï¼šæ–°è®¢é˜…ç”¨æˆ·çš„ Firestore æ–‡æ¡£åº”è¯¥åŒ…å«è¿™ä¸ª ID

2. âœ… **å®ç°è‡ªåŠ¨æŠ¥å‘Šä½¿ç”¨é‡**
   - æ–¹æ¡ˆ 1ï¼šå‰ç«¯è°ƒç”¨åç«¯ Cloud Function
   - æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Firestore Trigger

3. âœ… **æµ‹è¯•å®Œæ•´æµç¨‹**
   - è®¢é˜… â†’ ä½¿ç”¨ Credits åˆ°è´Ÿæ•° â†’ æŸ¥çœ‹ Stripe ä½¿ç”¨é‡ â†’ ç¡®è®¤ä¸‹æ¬¡è´¦å•åŒ…å«è¶…é¢è´¹ç”¨

### **æµ‹è¯•ç¯å¢ƒ**ï¼š
- âœ… ä½¿ç”¨ Stripe æµ‹è¯•æ¨¡å¼
- âœ… ä½¿ç”¨æµ‹è¯•å¡å·ï¼š`4242 4242 4242 4242`
- âœ… æŸ¥çœ‹ Stripe Dashboard â†’ Billing â†’ Usage Records

---

## ğŸ¯ **æ€»ç»“**

**æ‚¨çš„é—®é¢˜**ï¼š"è½¬æ¢å Credits ç”± 0 æ”¹ä¸º -1ï¼Œæˆ‘ä»¬æ˜¯å¦ä¼šæ”¶åˆ° 0.5 å…ƒï¼Ÿ"

**ç­”æ¡ˆ**ï¼š
- âœ… **æŠ€æœ¯ä¸Š**ï¼šç³»ç»Ÿå·²ç»è®°å½•äº† Credits = -1
- âŒ **å®é™…ä¸Š**ï¼šStripe **è¿˜æ²¡æœ‰**æ”¶åˆ°ä½¿ç”¨é‡æŠ¥å‘Šï¼Œæ‰€ä»¥**ä¸ä¼šæ”¶è´¹**
- ğŸ”§ **éœ€è¦**ï¼šå®Œæˆ `meteredSubscriptionItemId` é…ç½®å’Œè‡ªåŠ¨æŠ¥å‘Šé€»è¾‘

**å®Œæˆé…ç½®å**ï¼š
- âœ… Credits: 0 â†’ -1 æ—¶ï¼ŒStripe ä¼šæ”¶åˆ°ä½¿ç”¨é‡æŠ¥å‘Š
- âœ… ä¸‹æ¬¡è´¦å•ä¼šåŒ…å«ï¼šHK$58ï¼ˆæœˆè´¹ï¼‰+ HK$0.50ï¼ˆè¶…é¢ï¼‰= **HK$58.50**

---

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

æ˜¯å¦éœ€è¦æˆ‘ç«‹å³ä¿®å¤è¿™äº›ä»£ç ï¼Œå®ŒæˆæŒ‰é‡è®¡è´¹çš„é…ç½®ï¼Ÿ

1. âœ… ä¿®æ”¹ `handleSubscriptionChange` ä¿å­˜ `meteredSubscriptionItemId`
2. âœ… åˆ›å»º Cloud Function æˆ– Firestore Trigger è‡ªåŠ¨æŠ¥å‘Šä½¿ç”¨é‡
3. âœ… æµ‹è¯•å®Œæ•´çš„æŒ‰é‡è®¡è´¹æµç¨‹

**å›å¤ "æ˜¯" æˆ– "ç«‹å³ä¿®å¤"ï¼Œæˆ‘ä¼šé©¬ä¸Šå¼€å§‹ï¼** ğŸš€

