# ğŸ“ ä»£ç ä¿®æ”¹å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. ä¿®æ”¹ `reportUsageToStripe` å‡½æ•°
**ä½ç½®**: `firebase-functions/index.js` (è¡Œ1242)

**æ—§æ–¹æ³•**ï¼ˆUsage Records APIï¼‰ï¼š
```javascript
await stripeClient.subscriptionItems.createUsageRecord(
    meteredItemId,
    {
        quantity: quantity,
        timestamp: Math.floor(Date.now() / 1000),
        action: 'increment'
    }
);
```

**æ–°æ–¹æ³•**ï¼ˆBilling Meter Events APIï¼‰ï¼š
```javascript
await stripeClient.billing.meterEvents.create({
    event_name: 'vaultcaddy_credit_usage',
    payload: {
        stripe_customer_id: stripeCustomerId,
        value: quantity.toString()
    },
    timestamp: Math.floor(Date.now() / 1000)
});
```

**æ”¹è¿›**ï¼š
- âœ… å®æ—¶æŠ¥å‘Šä½¿ç”¨é‡
- âœ… ä¸å†éœ€è¦ `meteredSubscriptionItemId`
- âœ… ç›´æ¥ä½¿ç”¨ `stripeCustomerId`
- âœ… è‡ªåŠ¨è®°å½•é”™è¯¯åˆ° Firestore

---

### 2. ç®€åŒ– `handleInvoiceCreated` å‡½æ•°
**ä½ç½®**: `firebase-functions/index.js` (è¡Œ759)

**æ—§é€»è¾‘**ï¼š
- æ£€æŸ¥è¶…é¢ä½¿ç”¨
- æ‰‹åŠ¨è°ƒç”¨ `createUsageRecord` æŠ¥å‘Šä½¿ç”¨é‡
- è®¡ç®—é¢„æœŸæ”¶è´¹
- è®°å½•åˆ° Firestore

**æ–°é€»è¾‘**ï¼ˆç®€åŒ–ï¼‰ï¼š
- åªè®°å½•å‘ç¥¨ä¿¡æ¯åˆ° Firestore
- ä½¿ç”¨é‡å·²é€šè¿‡ Meter Events å®æ—¶æŠ¥å‘Š
- Stripe è‡ªåŠ¨åœ¨å‘ç¥¨ä¸­åŒ…å«è¶…é¢è´¹ç”¨

**æ”¹è¿›**ï¼š
- âœ… ç§»é™¤å¤æ‚çš„è¶…é¢æ£€æµ‹é€»è¾‘
- âœ… ç§»é™¤æ‰‹åŠ¨æŠ¥å‘Šä½¿ç”¨é‡çš„ä»£ç 
- âœ… ç®€åŒ–ä¸ºçº¯æ—¥å¿—å’Œç›‘æ§åŠŸèƒ½

---

### 3. `handleSubscriptionCancelled` å‡½æ•°
**ä½ç½®**: `firebase-functions/index.js` (è¡Œ610)

**ç°çŠ¶**ï¼š
- å·²ç»åœ¨ä¹‹å‰çš„ä¿®æ”¹ä¸­ç®€åŒ–è¿‡
- ä¸å†åˆ›å»ºç‹¬ç«‹å‘ç¥¨
- åªé‡ç½® Credits å’Œæ›´æ–°ç”¨æˆ·çŠ¶æ€

**æ— éœ€ä¿®æ”¹**ï¼šè¿™ä¸ªå‡½æ•°å·²ç»ç¬¦åˆæ–°æ¶æ„ã€‚

---

## âš ï¸ å·²å¼ƒç”¨çš„å‡½æ•°

ä»¥ä¸‹å‡½æ•°æ˜¯ä¸ºæ—§ API è®¾è®¡çš„è¯Šæ–­å·¥å…·ï¼Œç°åœ¨å·²ä¸å†éœ€è¦ï¼š

### 1. `diagnoseOverageCharging`ï¼ˆè¡Œ2319ï¼‰
**ç”¨é€”**ï¼šè¯Šæ–­è¶…é¢è®¡è´¹é—®é¢˜ï¼ˆæ—§ç³»ç»Ÿï¼‰

**çŠ¶æ€**ï¼šğŸ—‘ï¸ å¯ä»¥åˆ é™¤ï¼ˆä½†æš‚æ—¶ä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰

---

### 2. `manualReportOverage`ï¼ˆè¡Œ2448ï¼‰
**ç”¨é€”**ï¼šæ‰‹åŠ¨æŠ¥å‘Šè¶…é¢ä½¿ç”¨ï¼ˆæ—§ç³»ç»Ÿï¼‰

**çŠ¶æ€**ï¼šğŸ—‘ï¸ å¯ä»¥åˆ é™¤ï¼ˆä½†æš‚æ—¶ä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰

---

## â³ å¾…å®Œæˆçš„ä¿®æ”¹

### 1. æ›´æ–° `billing.html`
**éœ€è¦æ–°çš„ Price ID**ï¼ˆç”¨æˆ·æ­£åœ¨åˆ›å»ºä¸­ï¼‰

**ä¿®æ”¹ä½ç½®**ï¼š
```javascript
// billing.html ä¸­çš„ Stripe Checkout é…ç½®
lineItems: [
    {
        price: 'price_1SeCWBJmiQ31C0GTmZ1gxqXa', // å›ºå®šæœˆè´¹ï¼ˆä¿æŒä¸å˜ï¼‰
        quantity: 1
    },
    {
        price: 'price_NEW_METER_PRICE_ID', // ğŸ”¥ æ–°çš„ Meter ä»·æ ¼ IDï¼ˆå¾…æ›´æ–°ï¼‰
    }
]
```

---

### 2. æ›´æ–° `handleCheckoutCompleted` å‡½æ•°
**éœ€è¦ç§»é™¤çš„å­—æ®µ**ï¼š
- `meteredSubscriptionItemId`ï¼ˆä¸å†éœ€è¦ï¼‰
- `totalCreditsUsed`ï¼ˆä¸å†éœ€è¦ï¼‰

**ä¿ç•™çš„å­—æ®µ**ï¼š
- `stripeSubscriptionId`ï¼ˆéœ€è¦ï¼‰
- `stripeCustomerId`ï¼ˆéœ€è¦ï¼‰
- `monthlyCredits`ï¼ˆéœ€è¦ï¼‰

---

## ğŸ“Š æ–°æ—§ç³»ç»Ÿå¯¹æ¯”

| ç‰¹æ€§ | æ—§ç³»ç»Ÿï¼ˆUsage Records APIï¼‰ | æ–°ç³»ç»Ÿï¼ˆBilling Meter Events APIï¼‰ |
|------|----------------------------|----------------------------------|
| **æŠ¥å‘Šæ—¶æœº** | æ‰¹é‡æŠ¥å‘Šï¼ˆåœ¨ webhook ä¸­ï¼‰ | å®æ—¶æŠ¥å‘Šï¼ˆæ¯æ¬¡æ‰£é™¤ Creditsï¼‰ |
| **éœ€è¦å­—æ®µ** | `meteredSubscriptionItemId` | `stripeCustomerId` |
| **å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦å¤„ç† webhook æ—¶åºï¼‰ | ä½ï¼ˆå®æ—¶è‡ªåŠ¨èšåˆï¼‰ |
| **å¯é æ€§** | ä¸­ï¼ˆå®¹æ˜“å‡ºç°æ—¶åºé—®é¢˜ï¼‰ | é«˜ï¼ˆäº‹ä»¶é©±åŠ¨ï¼Œè‡ªåŠ¨é‡è¯•ï¼‰ |
| **æ‰‹åŠ¨ä¿®å¤** | éœ€è¦è¯Šæ–­å·¥å…· | ä¸éœ€è¦ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰ |
| **å‘ç¥¨ç”Ÿæˆ** | æ‰‹åŠ¨åœ¨ webhook ä¸­æŠ¥å‘Š | Stripe è‡ªåŠ¨åŒ…å« |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ç­‰å¾…ç”¨æˆ·æä¾›æ–°çš„ Price ID**
2. **æ›´æ–° `billing.html` é…ç½®**
3. **éƒ¨ç½² Firebase Functions**
4. **æµ‹è¯•æ–°ç³»ç»Ÿ**

---

## ğŸ“ éƒ¨ç½²å‘½ä»¤

```bash
cd firebase-functions
firebase deploy --only functions
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

1. âœ… åˆ›å»ºæµ‹è¯•è®¢é˜…
2. âœ… ä¸Šä¼ æ–‡æ¡£ï¼ˆè§¦å‘ Credits æ‰£é™¤ï¼‰
3. âœ… åœ¨ Stripe Dashboard æŸ¥çœ‹ Meter Events
4. âœ… æ¨¡æ‹Ÿè¶…é¢ä½¿ç”¨ï¼ˆä¿®æ”¹ Firestore æ•°æ®ï¼‰
5. âœ… è§¦å‘è®¡è´¹å‘¨æœŸï¼Œç¡®è®¤å‘ç¥¨é‡‘é¢æ­£ç¡®
6. âœ… æµ‹è¯•è®¢é˜…å–æ¶ˆï¼Œç¡®è®¤è¶…é¢è´¹ç”¨å·²æ”¶å–

