# âœ… Stripe ä¸ Firebase è¿æ¥è¯Šæ–­æŠ¥å‘Š

## ğŸ“‹ **è¿æ¥è¦æ±‚**

Stripe å’Œ Firebase ä¹‹é—´éœ€è¦ä»¥ä¸‹è¿æ¥ï¼š

### **1. Stripe â†’ Firebase (Webhook)**
âœ… **Stripe Webhook Endpoint**: https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook
âœ… **Webhook Signing Secret (Test)**: whsec_hK6JuCnJTKmB4CD6q9ohYzrQbXhjGYpa
âœ… **Webhook Signing Secret (Live)**: whsec_MNrldnhxEM8HC0HZJ4OT1V44ywoMCLit

**é…ç½®çŠ¶æ€ï¼š** âœ… å·²æ­£ç¡®é…ç½®

### **2. Firebase â†’ Stripe (API è°ƒç”¨)**
âœ… **Stripe Secret Key (Test)**: sk_test_51S6Qv3JmiQ31C0GT... (å·²é…ç½®)
âœ… **Stripe Secret Key (Live)**: sk_live_51S6Qv3JmiQ31C0GT... (å·²é…ç½®)

**é…ç½®çŠ¶æ€ï¼š** âœ… å·²æ­£ç¡®é…ç½®

---

## ğŸ” **å½“å‰é—®é¢˜åˆ†æ**

### **é—®é¢˜ï¼šæ”¯ä»˜å®Œæˆå Credits ä»ä¸º 0**

**å¯èƒ½åŸå› ï¼š**

### **1. Webhook æœªç›‘å¬æ­£ç¡®çš„äº‹ä»¶**

æµ‹è¯• Webhook `charismatic-serenity` å¯èƒ½æœªç›‘å¬ä»¥ä¸‹äº‹ä»¶ï¼š
- `checkout.session.completed`
- `customer.subscription.updated`

**éªŒè¯æ–¹æ³•ï¼š**
1. æ‰“å¼€ï¼šhttps://dashboard.stripe.com/test/webhooks/we_1Sck6qJmiQ31C0GTuiWKs0HS
2. æŸ¥çœ‹ "Events to send" éƒ¨åˆ†
3. ç¡®è®¤æ˜¯å¦é€‰ä¸­äº†ä»¥ä¸‹äº‹ä»¶ï¼š
   - âœ… `checkout.session.completed`
   - âœ… `customer.subscription.updated`
   - âœ… `customer.subscription.created`

---

### **2. ç”¨æˆ·å°šæœªè¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**

æœ€è¿‘çš„ä»£ç ä¿®æ”¹å·²éƒ¨ç½²ï¼Œä½†å¦‚æœç”¨æˆ·è¿˜æ²¡æœ‰è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜ï¼ŒCredits ä»ç„¶ä¸ä¼šå¢åŠ ã€‚

**ç¡®è®¤ï¼š**
- ç”¨æˆ·æ˜¯å¦åœ¨ä»£ç éƒ¨ç½²åï¼ˆ2025-12-12T06:50:00ä¹‹åï¼‰è¿›è¡Œäº†æ–°çš„æµ‹è¯•æ”¯ä»˜ï¼Ÿ

---

### **3. Firestore å®‰å…¨è§„åˆ™é™åˆ¶**

Firebase Firestore çš„å®‰å…¨è§„åˆ™å¯èƒ½é˜»æ­¢äº† `addCredits` å‡½æ•°æ›´æ–°ç”¨æˆ·çš„ Creditsã€‚

**éªŒè¯æ–¹æ³•ï¼š**
1. æ‰“å¼€ Firebase Console: https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore/rules
2. æŸ¥çœ‹å®‰å…¨è§„åˆ™
3. ç¡®è®¤ Cloud Functions æœ‰æƒé™æ›´æ–° `users` é›†åˆ

**é¢„æœŸè§„åˆ™ï¼š**
```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Cloud Functions åº”è¯¥æœ‰æƒé™æ›´æ–°
      allow write: if request.auth == null; // å…è®¸ Cloud Functions å†™å…¥
    }
  }
}
```

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤ï¼ˆè¯·æŒ‰é¡ºåºæ‰§è¡Œï¼‰**

### **æ­¥éª¤ 1ï¼šéªŒè¯ Webhook äº‹ä»¶é…ç½®**

1. æ‰“å¼€ Stripe Webhook é…ç½®é¡µé¢
2. ç¡®è®¤ç›‘å¬äº†ä»¥ä¸‹äº‹ä»¶ï¼š
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.created`

### **æ­¥éª¤ 2ï¼šè¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**

1. æ‰“å¼€ https://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. ä½¿ç”¨æµ‹è¯•å¡ï¼š**4242 4242 4242 4242**
4. å¡«å†™ä»»æ„æœªæ¥æ—¥æœŸå’Œ CVC
5. å®Œæˆæ”¯ä»˜

### **æ­¥éª¤ 3ï¼šæ£€æŸ¥ Firebase æ—¥å¿—**

ç­‰å¾… 10 ç§’åï¼Œè¿è¡Œï¼š

```bash
firebase functions:log --only stripeWebhook 2>&1 | grep -A 10 "è¨‚é–±è®Šæ›´\|è¨‚é–±å·²æ¿€æ´»\|WEBHOOK START" | tail -50
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… è¨‚é–±è®Šæ›´ (æ¸¬è©¦æ¨¡å¼): sub_xxx
ğŸ“‹ Subscription è©³æƒ…: {...}
ğŸ‰ è¨‚é–±å·²æ¿€æ´»ï¼Œæº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ xxx
âœ… å·²æˆåŠŸæ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ xxx
```

### **æ­¥éª¤ 4ï¼šæ£€æŸ¥ Firestore æ•°æ®**

1. æ‰“å¼€ Firebase Console: https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore/data
2. å¯¼èˆªåˆ° `users` â†’ `vaultcaddy@gmail.com çš„ userId` â†’ `credits`
3. ç¡®è®¤ `credits` å­—æ®µæ˜¯å¦å·²æ›´æ–°

---

## ğŸš¨ **å¦‚æœä»ç„¶å¤±è´¥**

### **ç´§æ€¥è°ƒè¯•æ­¥éª¤ï¼š**

1. **æ£€æŸ¥ Webhook æ˜¯å¦æ”¶åˆ°äº‹ä»¶ï¼š**
   - æ‰“å¼€ Stripe Workbench
   - æŸ¥çœ‹æœ€è¿‘çš„äº‹ä»¶
   - ç¡®è®¤ `customer.subscription.updated` äº‹ä»¶æ˜¯å¦è¿”å› 200 OK

2. **æ‰‹åŠ¨è§¦å‘ Webhook æµ‹è¯•ï¼š**
   - åœ¨ Stripe Dashboard æ‰¾åˆ°æœ€è¿‘çš„ `customer.subscription.updated` äº‹ä»¶
   - ç‚¹å‡» "é‡æ–°å‘é€åˆ°ç«¯ç‚¹"
   - è§‚å¯Ÿ Firebase æ—¥å¿—

3. **æ£€æŸ¥ Firestore è§„åˆ™ï¼š**
   - ç¡®è®¤ Cloud Functions æœ‰æƒé™å†™å…¥ `users` é›†åˆ
   - å¦‚æœè§„åˆ™å¤ªä¸¥æ ¼ï¼Œä¸´æ—¶æ”¾å®½ä»¥è¿›è¡Œæµ‹è¯•

---

## ğŸ“ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

è¯·å‘Šè¯‰æˆ‘ï¼š
1. æ‚¨æ˜¯å¦åœ¨æœ€è¿‘ï¼ˆä»£ç éƒ¨ç½²åï¼‰è¿›è¡Œäº†æ–°çš„æµ‹è¯•æ”¯ä»˜ï¼Ÿ
2. Stripe Webhook æ˜¯å¦ç›‘å¬äº† `customer.subscription.updated` äº‹ä»¶ï¼Ÿ
3. æ‰§è¡Œæ­¥éª¤ 2-3 åï¼Œæ—¥å¿—ä¸­æ˜¯å¦æœ‰ "è¨‚é–±å·²æ¿€æ´»" çš„æ¶ˆæ¯ï¼Ÿ

**åªæœ‰è¿™æ ·æˆ‘æ‰èƒ½å‡†ç¡®è¯Šæ–­é—®é¢˜ï¼** ğŸ™

