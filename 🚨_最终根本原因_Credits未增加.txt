# ğŸš¨ æœ€ç»ˆæ ¹æœ¬åŸå› ï¼šCredits æœªå¢åŠ 

## ğŸ“Š **é—®é¢˜ç¡®è®¤**

ç»è¿‡å¤šæ¬¡æµ‹è¯•å’Œæ—¥å¿—åˆ†æï¼Œç°åœ¨ç¡®è®¤é—®é¢˜ï¼š

âœ… Stripe æ˜¾ç¤ºï¼š`checkout.session.completed` äº‹ä»¶è¿”å› **200 OK**
âŒ Firebase Functions æ—¥å¿—ï¼š**æ²¡æœ‰å¤„ç† `checkout.session.completed` äº‹ä»¶çš„ä»»ä½•è®°å½•**
âœ… Firebase Functions åªå¤„ç†äº†ï¼š`customer.subscription.created/updated` äº‹ä»¶

---

## ğŸ” **æ ¹æœ¬åŸå› åˆ†æ**

### **åŸå›  1ï¼šWebhook ç›‘å¬äº‹ä»¶æœªé…ç½®**

Stripe Test Mode Webhook å¯èƒ½æ²¡æœ‰ç›‘å¬ `checkout.session.completed` äº‹ä»¶ï¼

**éªŒè¯æ­¥éª¤ï¼š**
1. æ‰“å¼€ï¼šhttps://dashboard.stripe.com/test/webhooks
2. ç‚¹å‡» `charismatic-serenity` webhook
3. æŸ¥çœ‹ "Events to send"
4. ç¡®è®¤ `checkout.session.completed` æ˜¯å¦å·²é€‰ä¸­

---

### **åŸå›  2ï¼šSession ç±»å‹é—®é¢˜**

å½“å‰ä½¿ç”¨çš„ Stripe Checkout Session åˆ›å»ºæ–¹å¼å¯èƒ½æ˜¯ **Subscription æ¨¡å¼**ï¼Œè€Œä¸æ˜¯ **Payment æ¨¡å¼**ã€‚

**åœ¨ Subscription æ¨¡å¼ä¸‹ï¼š**
- Stripe ä¸ä¼šå‘é€ `checkout.session.completed` äº‹ä»¶ï¼ˆæˆ–è€…å‘é€æ—¶é—´å»¶è¿Ÿï¼‰
- Stripe ä¼šå…ˆå‘é€ `customer.subscription.created` äº‹ä»¶ï¼ˆçŠ¶æ€ä¸º `incomplete`ï¼‰
- å½“æ”¯ä»˜å®Œæˆåï¼Œå‘é€ `customer.subscription.updated` äº‹ä»¶ï¼ˆçŠ¶æ€å˜ä¸º `active`ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
ä¿®æ”¹ `/Users/cavlinyeung/ai-bank-parser/firebase-functions/index.js` ä¸­çš„ `handleSubscriptionChange` å‡½æ•°ï¼Œå½“è®¢é˜…çŠ¶æ€ä» `incomplete` å˜ä¸º `active` æ—¶ï¼Œä¹Ÿè¦æ·»åŠ  Creditsã€‚

---

## âœ… **ç«‹å³ä¿®å¤æ­¥éª¤**

### **æ­¥éª¤ 1ï¼šä¿®æ”¹ä»£ç é€»è¾‘**

åœ¨ `handleSubscriptionChange` å‡½æ•°ä¸­æ·»åŠ  Credits é€»è¾‘ï¼š

```javascript
async function handleSubscriptionChange(subscription, isTestMode = false) {
    console.log(`âœ… è¨‚é–±è®Šæ›´ (${isTestMode ? 'æ¸¬è©¦æ¨¡å¼' : 'ç”Ÿç”¢æ¨¡å¼'}):`, subscription.id);
    console.log(`ğŸ“‹ Subscription è©³æƒ…:`, JSON.stringify(subscription, null, 2));

    // é¸æ“‡æ­£ç¢ºçš„ Stripe å®¢æˆ¶ç«¯
    const stripeClient = isTestMode ? stripeTest : stripeLive;
    if (!stripeClient) {
        console.error(`âŒ Stripe å®¢æˆ¶ç«¯æœªé…ç½® (${isTestMode ? 'æ¸¬è©¦æ¨¡å¼' : 'ç”Ÿç”¢æ¨¡å¼'})`);
        throw new Error('Stripe client not configured');
    }

    // âœ¨ æ–°å¢é‚è¼¯ï¼šç•¶è¨‚é–±è®Šç‚º active æ™‚ï¼Œæ·»åŠ  Credits
    if (subscription.status === 'active') {
        console.log('ğŸ‰ è¨‚é–±å·²æ¿€æ´»ï¼Œæº–å‚™æ·»åŠ  Credits');

        // å˜—è©¦ç²å–ç”¨æˆ¶ID
        const customer = await stripeClient.customers.retrieve(subscription.customer);
        console.log(`ğŸ“§ Customer email: ${customer.email}`);

        if (!customer.email) {
            console.error('âŒ ç„¡æ³•ç²å–å®¢æˆ¶ email');
            return;
        }

        // é€šé email æŸ¥æ‰¾ç”¨æˆ¶
        const usersRef = admin.firestore().collection('users');
        const snapshot = await usersRef.where('email', '==', customer.email).limit(1).get();

        if (snapshot.empty) {
            console.error(`âŒ æœªæ‰¾åˆ°ç”¨æˆ¶: ${customer.email}`);
            return;
        }

        const userId = snapshot.docs[0].id;
        console.log(`âœ… æ‰¾åˆ°ç”¨æˆ¶: ${userId}`);

        // ç²å–ç”¢å“ä¿¡æ¯ä¸¦æ·»åŠ  Credits
        for (const item of subscription.items.data) {
            const priceId = item.price.id;
            const productId = item.price.product;

            console.log(`ğŸ” æ­£åœ¨ç²å–ç”¢å“: ${productId}`);
            const product = await stripeClient.products.retrieve(productId);

            console.log(`ğŸ“¦ ç”¢å“ä¿¡æ¯:`, {
                productId: product.id,
                name: product.name,
                metadata: product.metadata
            });

            // æ ¹æ“šç”¢å“ metadata æ·»åŠ  Credits
            const credits = parseInt(product.metadata.monthly_credits || product.metadata.credits || 0);
            console.log(`ğŸ”¢ è¨ˆç®—å¾—åˆ°çš„ Credits: ${credits}`);

            if (credits > 0) {
                console.log(`ğŸ’° æº–å‚™æ·»åŠ  ${credits} Credits çµ¦ç”¨æˆ¶ ${userId}`);
                await addCredits(userId, credits, {
                    type: 'subscription_activated',
                    subscriptionId: subscription.id,
                    planType: product.metadata.plan_type || 'unknown',
                    productName: product.name
                });
                console.log(`âœ… å·²æˆåŠŸæ·»åŠ  ${credits} Credits çµ¦ç”¨æˆ¶ ${userId}`);
            } else {
                console.warn(`âš ï¸ ç”¢å“ ${product.name} (${product.id}) æ²’æœ‰é…ç½® creditsï¼Œè·³éæ·»åŠ `);
            }
        }

        // æ›´æ–°ç”¨æˆ¶çš„è¨‚é–±ç‹€æ…‹
        await admin.firestore().collection('users').doc(userId).update({
            subscriptionId: subscription.id,
            planType: subscription.items.data[0]?.price?.metadata?.plan_type || 'monthly',
            status: 'active',
            lastPaymentDate: admin.firestore.FieldValue.serverTimestamp()
        });
        console.log(`âœ… ç”¨æˆ¶ ${userId} çš„è¨‚é–±ç‹€æ…‹å·²æ›´æ–°`);
    }
}
```

### **æ­¥é©Ÿ 2ï¼šé‡æ–°éƒ¨ç½²**

```bash
cd /Users/cavlinyeung/ai-bank-parser
firebase deploy --only functions:stripeWebhook
```

### **æ­¥é©Ÿ 3ï¼šé‡æ–°æ¸¬è©¦**

1. æ‰“é–‹ https://vaultcaddy.com/billing.html
2. é»æ“Š **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. ä½¿ç”¨æ¸¬è©¦å¡ï¼š**4242 4242 4242 4242**
4. å®Œæˆæ”¯ä»˜

### **æ­¥é©Ÿ 4ï¼šæª¢æŸ¥çµæœ**

```bash
firebase functions:log --only stripeWebhook 2>&1 | tail -100
```

æŸ¥æ‰¾ï¼š
- `âœ… è¨‚é–±è®Šæ›´ (æ¸¬è©¦æ¨¡å¼)`
- `ğŸ‰ è¨‚é–±å·²æ¿€æ´»ï¼Œæº–å‚™æ·»åŠ  Credits`
- `ğŸ’° æº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶`
- `âœ… å·²æˆåŠŸæ·»åŠ  100 Credits çµ¦ç”¨æˆ¶`

---

## ğŸ¯ **é æœŸçµæœ**

ä¿®æ”¹å¾Œï¼š
1. âœ… æ”¯ä»˜å®Œæˆå¾Œï¼ŒStripe ç™¼é€ `customer.subscription.updated` (status: active)
2. âœ… Firebase Functions è™•ç†è©²äº‹ä»¶
3. âœ… å¾ç”¢å“ metadata è®€å– `monthly_credits`
4. âœ… èª¿ç”¨ `addCredits` å‡½æ•¸æ·»åŠ  Credits
5. âœ… æ›´æ–°ç”¨æˆ¶çš„è¨‚é–±ç‹€æ…‹
6. âœ… ç”¨æˆ¶çš„ Credits å¾ 0 å¢åŠ åˆ° 100

---

## ğŸ“ **å¦‚æœä»ç„¶å¤±æ•—**

å¦‚æœä¿®æ”¹å¾Œä»ç„¶å¤±æ•—ï¼Œå¯èƒ½éœ€è¦ï¼š
1. æª¢æŸ¥ Stripe Webhook é…ç½®ï¼Œç¢ºèªç›£è½äº† `customer.subscription.updated` äº‹ä»¶
2. æª¢æŸ¥ç”¢å“ metadata æ˜¯å¦æ­£ç¢ºé…ç½®äº† `monthly_credits`
3. æª¢æŸ¥ Firestore å®‰å…¨è¦å‰‡æ˜¯å¦å…è¨±æ›´æ–°ç”¨æˆ¶çš„ Credits

**ç¾åœ¨è«‹åŸ·è¡Œæ­¥é©Ÿ 1-4ï¼Œç„¶å¾Œå‘Šè¨´æˆ‘çµæœï¼** ğŸ™

