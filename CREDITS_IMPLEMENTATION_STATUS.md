# Credits ç®¡ç†ç³»çµ±å¯¦ç¾é€²åº¦

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. Cloud Functions è‡ªå‹•è™•ç† Credits âœ…

**æ–‡ä»¶ï¼š** `firebase-functions/index.js`

**å¯¦ç¾åŠŸèƒ½ï¼š**
- âœ… Stripe Webhook è™•ç†ï¼ˆæ”¯ä»˜æˆåŠŸã€è¨‚é–±è®Šæ›´ï¼‰
- âœ… è‡ªå‹•æ·»åŠ  Creditsï¼ˆè³¼è²·å¾Œï¼‰
- âœ… è‡ªå‹•æ‰£é™¤ Creditsï¼ˆä½¿ç”¨æ™‚ï¼‰
- âœ… è¨‚é–±è¨ˆåŠƒç®¡ç†
- âœ… æ¯æœˆ Credits é‡ç½®ï¼ˆå®šæ™‚ä»»å‹™ï¼‰
- âœ… æª¢æŸ¥éæœŸè¨‚é–±ï¼ˆæ¯6å°æ™‚ï¼‰
- âœ… Credits æ­·å²è¨˜éŒ„

**éƒ¨ç½²æŒ‡å—ï¼š** `CLOUD_FUNCTIONS_SETUP.md`

---

### 2. Credits è³¼è²·è¨˜éŒ„ UI âœ…

**æ–‡ä»¶ï¼š** `billing.html`

**å¯¦ç¾åŠŸèƒ½ï¼š**
- âœ… è³¼è²·è¨˜éŒ„è¡¨æ ¼ï¼ˆæ—¥æœŸã€æè¿°ã€é¡å‹ã€Creditsã€é¤˜é¡ï¼‰
- âœ… æŒ‰æœˆä»½éæ¿¾åŠŸèƒ½
- âœ… ç™½è‰²èƒŒæ™¯è¨­è¨ˆ

---

## ğŸ”„ å¾…å¯¦ç¾åŠŸèƒ½

### 3. Credits éæœŸæ©Ÿåˆ¶é¡¯ç¤º - account.html

**éœ€è¦å¯¦ç¾ï¼š**
- [ ] åœ¨ account.html çš„ã€Œç›®å‰è¨ˆåŠƒã€å€åŸŸé¡¯ç¤º Credits ä½¿ç”¨æƒ…æ³
- [ ] é¡ä¼¼åœ–ç‰‡ä¸­çš„é€²åº¦æ¢ï¼ˆ500 / 500ï¼‰
- [ ] é¡¯ç¤ºã€ŒIncluded-Request Usageã€
- [ ] é¡¯ç¤ºã€ŒUsage included in your planã€
- [ ] é¡¯ç¤ºé‡ç½®æ—¥æœŸã€ŒResets 2025å¹´11æœˆ4æ—¥ã€
- [ ] ç™½è‰²èƒŒæ™¯è¨­è¨ˆ

**è¨ˆåŠƒå°æ‡‰çš„ Creditsï¼š**
- Free Plan: 0 Credits
- Basic Plan: 200 Credits/æœˆ (2,400 Credits/å¹´)
- Pro Plan: 500 Credits/æœˆ (6,000 Credits/å¹´)  
- Business Plan: 1,200 Credits/æœˆ (14,400 Credits/å¹´)

---

### 4. Stripe å……å€¼åŠŸèƒ½é›†æˆ

**éœ€è¦å¯¦ç¾ï¼š**
- [ ] å°‡ https://buy.stripe.com/aFa3cwga8alc1CSeIOf7i03 é›†æˆåˆ°è³¼è²·æµç¨‹
- [ ] é»æ“Šã€Œè³¼è²· Creditsã€æŒ‰éˆ•æ™‚è·³è½‰åˆ° Stripe Checkout
- [ ] æ”¯ä»˜æˆåŠŸå¾Œè‡ªå‹•æ·»åŠ  Credits
- [ ] ä½¿ç”¨ Stripe Customer Portal ç®¡ç†è¨‚é–±

---

### 5. è¼‰å…¥ Credits æ­·å²è¨˜éŒ„

**éœ€è¦å¯¦ç¾ï¼š**
- [ ] å¾ Firebase Cloud Functions ç²å– Credits æ­·å²
- [ ] åœ¨ billing.html è¡¨æ ¼ä¸­é¡¯ç¤ºè¨˜éŒ„
- [ ] æŒ‰æœˆä»½éæ¿¾åŠŸèƒ½
- [ ] åˆ†é åŠŸèƒ½ï¼ˆå¦‚æœè¨˜éŒ„å¾ˆå¤šï¼‰

---

## ğŸ“‹ å¯¦ç¾å»ºè­°

### å„ªå…ˆç´š 1ï¼šCredits éæœŸæ©Ÿåˆ¶é¡¯ç¤ºï¼ˆaccount.htmlï¼‰

é€™æ˜¯ç”¨æˆ¶æœ€å¸¸çœ‹åˆ°çš„é é¢ï¼Œæ‡‰è©²å„ªå…ˆå¯¦ç¾ã€‚

**å¯¦ç¾æ­¥é©Ÿï¼š**
1. ä¿®æ”¹ account.html çš„ã€Œç›®å‰è¨ˆåŠƒã€å€åŸŸ
2. å¾ Firestore è®€å–ç”¨æˆ¶çš„è¨‚é–±ä¿¡æ¯
3. è¨ˆç®— Credits ä½¿ç”¨ç™¾åˆ†æ¯”
4. é¡¯ç¤ºé€²åº¦æ¢å’Œåˆ°æœŸæ—¥æœŸ
5. æ·»åŠ ã€Œå‡ç´šè¨ˆåŠƒã€æŒ‰éˆ•

**ç¤ºä¾‹ä»£ç¢¼ï¼š**
```javascript
async function loadSubscriptionStatus() {
    const user = firebase.auth().currentUser;
    const userDoc = await firebase.firestore()
        .collection('users')
        .doc(user.uid)
        .get();
    
    const userData = userDoc.data();
    const subscription = userData.subscription || {};
    
    // é¡¯ç¤º Credits ä½¿ç”¨æƒ…æ³
    const credits = userData.credits || 0;
    const monthlyCredits = subscription.monthlyCredits || 0;
    const percentage = (credits / monthlyCredits) * 100;
    
    // æ›´æ–° UI
    document.getElementById('credits-used').textContent = credits;
    document.getElementById('credits-total').textContent = monthlyCredits;
    document.getElementById('credits-progress').style.width = percentage + '%';
    
    // é¡¯ç¤ºé‡ç½®æ—¥æœŸ
    if (subscription.currentPeriodEnd) {
        const resetDate = subscription.currentPeriodEnd.toDate();
        document.getElementById('reset-date').textContent = 
            resetDate.toLocaleDateString('zh-TW', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
    }
}
```

---

### å„ªå…ˆç´š 2ï¼šStripe å……å€¼åŠŸèƒ½

é€™æ˜¯æ”¶å…¥ä¾†æºï¼Œæ‡‰è©²ç›¡å¿«å¯¦ç¾ã€‚

**å¯¦ç¾æ­¥é©Ÿï¼š**
1. åœ¨ Stripe Dashboard å‰µå»ºç”¢å“å’Œåƒ¹æ ¼
2. ç²å– Stripe Checkout URL æˆ– Price ID
3. ä¿®æ”¹ `purchaseCredits()` å‡½æ•¸ï¼Œè·³è½‰åˆ° Stripe
4. è¨­ç½® Stripe Webhook æ¥æ”¶ä»˜æ¬¾æˆåŠŸé€šçŸ¥
5. Cloud Functions è‡ªå‹•æ·»åŠ  Credits

**ç¤ºä¾‹ä»£ç¢¼ï¼š**
```javascript
async function purchaseCredits(credits, price) {
    try {
        const user = firebase.auth().currentUser;
        
        // å‰µå»º Stripe Checkout Session
        const response = await fetch('YOUR_CLOUD_FUNCTION_URL/createCheckoutSession', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: user.uid,
                credits: credits,
                amount: price,
                successUrl: window.location.origin + '/billing.html?success=true',
                cancelUrl: window.location.origin + '/billing.html?cancel=true'
            })
        });
        
        const { sessionId } = await response.json();
        
        // è·³è½‰åˆ° Stripe Checkout
        const stripe = Stripe('YOUR_PUBLISHABLE_KEY');
        await stripe.redirectToCheckout({ sessionId });
        
    } catch (error) {
        console.error('å‰µå»ºæ”¯ä»˜å¤±æ•—:', error);
        alert('å‰µå»ºæ”¯ä»˜å¤±æ•—ï¼Œè«‹é‡è©¦');
    }
}
```

---

### å„ªå…ˆç´š 3ï¼šè¼‰å…¥ Credits æ­·å²è¨˜éŒ„

é€™æ˜¯è£œå……åŠŸèƒ½ï¼Œå¯ä»¥æœ€å¾Œå¯¦ç¾ã€‚

**å¯¦ç¾æ­¥é©Ÿï¼š**
1. èª¿ç”¨ Cloud Functions çš„ `getCreditsHistory`
2. åœ¨ billing.html è¡¨æ ¼ä¸­æ¸²æŸ“æ•¸æ“š
3. å¯¦ç¾æŒ‰æœˆä»½éæ¿¾
4. æ·»åŠ åˆ†é åŠŸèƒ½

**ç¤ºä¾‹ä»£ç¢¼ï¼š**
```javascript
async function loadCreditsHistory() {
    try {
        const getHistory = firebase.functions().httpsCallable('getCreditsHistory');
        const result = await getHistory({ limit: 50 });
        
        const history = result.data.history;
        const tbody = document.getElementById('credits-history-tbody');
        
        if (history.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: #9ca3af;">
                        æš«ç„¡è¨˜éŒ„
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = history.map(record => {
            const date = new Date(record.createdAt).toLocaleDateString('zh-TW');
            const type = record.type === 'add' ? 'å¢åŠ ' : 
                        record.type === 'deduct' ? 'ä½¿ç”¨' : 'é‡ç½®';
            const typeColor = record.type === 'add' ? '#10b981' : 
                            record.type === 'deduct' ? '#ef4444' : '#6b7280';
            const sign = record.type === 'add' ? '+' : 
                        record.type === 'deduct' ? '-' : '';
            
            return `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 1rem; color: #6b7280; font-size: 0.875rem;">${date}</td>
                    <td style="padding: 1rem; color: #1f2937;">
                        ${record.metadata?.source === 'subscription' ? 'è¨‚é–±è¨ˆåŠƒ' : 
                          record.metadata?.source === 'purchase' ? 'è³¼è²· Credits' : 
                          record.metadata?.projectName || 'æ–‡æª”è™•ç†'}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="display: inline-flex; padding: 0.25rem 0.75rem; background: ${typeColor}15; color: ${typeColor}; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">
                            ${type}
                        </span>
                    </td>
                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: ${typeColor};">
                        ${sign}${record.amount}
                    </td>
                    <td style="padding: 1rem; text-align: right; color: #1f2937;">
                        ${record.after}
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:', error);
    }
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡Œå‹•

1. **éƒ¨ç½² Cloud Functions**
   ```bash
   cd firebase-functions
   npm install
   firebase deploy --only functions
   ```

2. **é…ç½® Stripe Webhook**
   - åœ¨ Stripe Dashboard è¨­ç½® Webhook URL
   - ç›£è½å¿…è¦çš„äº‹ä»¶

3. **å¯¦ç¾ account.html çš„ Credits é¡¯ç¤º**
   - æœ€ç›´è§€çš„ç”¨æˆ¶é«”é©—æ”¹é€²

4. **é›†æˆ Stripe æ”¯ä»˜**
   - å¯¦ç¾çœŸå¯¦çš„æ”¶å…¥åŠŸèƒ½

5. **æ¸¬è©¦å®Œæ•´æµç¨‹**
   - è³¼è²· Credits
   - ä½¿ç”¨ Credits
   - è¨‚é–±è¨ˆåŠƒ
   - Credits é‡ç½®

---

## ğŸ“ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœéœ€è¦æˆ‘ç¹¼çºŒå¯¦ç¾å‰©é¤˜åŠŸèƒ½ï¼Œè«‹å‘Šè¨´æˆ‘ï¼š
1. å„ªå…ˆå¯¦ç¾å“ªå€‹åŠŸèƒ½ï¼Ÿ
2. æ˜¯å¦éœ€è¦ä¿®æ”¹è¨­è¨ˆï¼Ÿ
3. æ˜¯å¦æœ‰å…¶ä»–è¦æ±‚ï¼Ÿ

