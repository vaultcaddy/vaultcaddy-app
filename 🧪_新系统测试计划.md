# ğŸ§ª Billing Meter Events API æµ‹è¯•è®¡åˆ’

## âœ… å·²å®Œæˆ
1. âœ… åˆ›å»º Billing Meter (`mtr_test_61TnAddrAuQxlRy7p41JmiQ31C0GTJwG`)
2. âœ… åˆ›å»º Meter ä»·æ ¼ (`price_15dn7pJmiQ31C0GTK1yVopH`)
3. âœ… ä¿®æ”¹ Firebase Functions ä½¿ç”¨ Meter Events API
4. âœ… æ›´æ–°ä»·æ ¼é…ç½®
5. âœ… éƒ¨ç½² Firebase Functions

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### ç¬¬1æ­¥ï¼šåˆ›å»ºæµ‹è¯•è®¢é˜…

1. **è®¿é—® billing é¡µé¢**
   ```
   https://vaultcaddy.com/billing.html
   ```

2. **ç‚¹å‡»"ğŸ§ª æ¸¬è©¦æ¨¡å¼ï¼ˆæ¸¬è©¦è¶…é¡è¨ˆè²»ï¼‰"æŒ‰é’®**
   - è¿™ä¼šä½¿ç”¨æ–°çš„ Meter ä»·æ ¼åˆ›å»ºè®¢é˜…
   - Price ID: `price_15dn7pJmiQ31C0GTK1yVopH`

3. **å®Œæˆæ”¯ä»˜**
   - ä½¿ç”¨æµ‹è¯•å¡ï¼š`4242 4242 4242 4242`
   - ä»»æ„æœªæ¥æ—¥æœŸå’Œ CVC

4. **éªŒè¯è®¢é˜…åˆ›å»ºæˆåŠŸ**
   - åœ¨ Firestore ä¸­æ£€æŸ¥ç”¨æˆ·æ•°æ®ï¼š
     ```
     users/{userId}:
     - planType: "Pro Plan"
     - credits: 100
     - currentCredits: 100
     - stripeCustomerId: "cus_xxxx"
     - subscription.stripeSubscriptionId: "sub_xxxx"
     ```
   - âš ï¸ **å…³é”®å˜åŒ–**ï¼šä¸å†éœ€è¦ `meteredSubscriptionItemId` å­—æ®µï¼

5. **åœ¨ Stripe Dashboard ç¡®è®¤**
   - è®¢é˜…åŒ…å« 2 ä¸ªè®¢é˜…é¡¹ï¼š
     - å›ºå®šæœˆè´¹ï¼šHK$58
     - Meter è®¡è´¹ï¼šå…³è”åˆ° `mtr_test_61TnAddrAuQxlRy7p41JmiQ31C0GTJwG`

---

### ç¬¬2æ­¥ï¼šæµ‹è¯• Credits æ‰£é™¤å’Œ Meter Events

1. **ä¸Šä¼ æ–‡æ¡£åˆ°é¡¹ç›®**
   - é€‰æ‹©ä»»æ„é¡¹ç›®
   - ä¸Šä¼  1-2 ä¸ªæ–‡æ¡£

2. **æŸ¥çœ‹ Firebase Logs**
   - æ‰“å¼€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions/logs
   - æœç´¢ï¼š`reportUsageToStripe`
   - åº”è¯¥çœ‹åˆ°ï¼š
     ```
     âœ… ä½¿ç”¨é‡å·²æŠ¥å‘Šç»™ Stripe Billing Meter:
     {
       meterEventId: "...",
       eventName: "vaultcaddy_credit_usage",
       customerId: "cus_...",
       quantity: 1
     }
     ```

3. **åœ¨ Stripe Dashboard æŸ¥çœ‹ Meter Events**
   - æ‰“å¼€ Billing Meter é¡µé¢ï¼š
     ```
     https://dashboard.stripe.com/test/billing/meters/mtr_test_61TnAddrAuQxlRy7p41JmiQ31C0GTJwG
     ```
   - ç‚¹å‡»"çœŸå®é‡è¡¨äº‹ä»¶"æ ‡ç­¾
   - åº”è¯¥çœ‹åˆ°åˆšæ‰ä¸Šä¼ æ–‡æ¡£æ—¶è®°å½•çš„äº‹ä»¶

4. **éªŒè¯ Firestore æ•°æ®**
   ```
   users/{userId}:
   - credits: 99 (æˆ–æ›´å°‘)
   - currentCredits: 99 (æˆ–æ›´å°‘)
   - usageTracking.lastReportedAt: (æœ€æ–°æ—¶é—´æˆ³)
   - usageTracking.lastReportedQuantity: 1 (æˆ–æ›´å¤š)
   ```

---

### ç¬¬3æ­¥ï¼šæµ‹è¯•è¶…é¢è®¡è´¹

#### 3.1 æ¨¡æ‹Ÿè¶…é¢ä½¿ç”¨

1. **æ‰‹åŠ¨ä¿®æ”¹ Firestore æ•°æ®**
   - åœ¨ Firestore Console ä¸­æ‰¾åˆ°æµ‹è¯•ç”¨æˆ·
   - ä¿®æ”¹å­—æ®µï¼š
     ```
     credits: -50
     currentCredits: -50
     ```

2. **å†æ¬¡ä¸Šä¼ æ–‡æ¡£**
   - ä¸Šä¼  1 ä¸ªæ–‡æ¡£
   - åº”è¯¥ç»§ç»­æˆåŠŸï¼ˆPro Plan å…è®¸è´Ÿæ•°ï¼‰

3. **æŸ¥çœ‹ Firebase Logs**
   - æœç´¢ï¼š`è¶…å‡ºæœˆåº¦é¢åº¦`
   - åº”è¯¥çœ‹åˆ°ï¼š
     ```
     ğŸ’° Pro Plan ç”¨æˆ·è¶…å‡ºæœˆåº¦é¢åº¦ï¼Œå¯åŠ¨æŒ‰é‡æ”¶è´¹
     ğŸ“Š å½“å‰ Credits: -50, æ‰£é™¤: 1, ç»“æœ: -51
     ğŸ“ˆ è¶…å‡ºé¢åº¦: 51 Credits
     ```

4. **æŸ¥çœ‹ Meter Events**
   - åœ¨ Stripe Dashboard æŸ¥çœ‹ Meter
   - åº”è¯¥çœ‹åˆ°ç´¯è®¡çš„ä½¿ç”¨é‡äº‹ä»¶

#### 3.2 æµ‹è¯•è®¢é˜…å–æ¶ˆæ—¶çš„è®¡è´¹

**æ–¹æ³• Aï¼šç­‰å¾…è®¡è´¹å‘¨æœŸï¼ˆæ¨èï¼‰**

1. **åœ¨ Stripe Dashboard æ¨¡æ‹Ÿè®¡è´¹å‘¨æœŸ**
   - æ‰“å¼€è®¢é˜…é¡µé¢
   - ç‚¹å‡»å³ä¸Šè§’ "..."
   - é€‰æ‹© "Advance subscription to next billing period"
   - Stripe ä¼šè‡ªåŠ¨åˆ›å»ºå‘ç¥¨å¹¶åŒ…å«è¶…é¢è´¹ç”¨

2. **æŸ¥çœ‹å‘ç¥¨**
   - åœ¨ Stripe Dashboard æŸ¥çœ‹æ–°åˆ›å»ºçš„å‘ç¥¨
   - åº”è¯¥åŒ…å«ï¼š
     - åŸºç¡€æœˆè´¹ï¼šHK$58
     - è¶…é¢è´¹ç”¨ï¼šHK$25.50 (51 Credits Ã— HK$0.50)
     - **æ€»è®¡**ï¼šHK$83.50

**æ–¹æ³• Bï¼šç«‹å³å–æ¶ˆè®¢é˜…**

1. **åœ¨ Customer Portal å–æ¶ˆè®¢é˜…**
   - ç‚¹å‡» "Manage Subscription"
   - é€‰æ‹© "Cancel immediately"

2. **æŸ¥çœ‹ Firebase Logs**
   - æœç´¢ï¼š`customer.subscription.deleted`
   - åº”è¯¥çœ‹åˆ°ï¼š
     ```
     âŒ è¨‚é–±å·²å–æ¶ˆ: sub_xxx
     ğŸ’° è¨‚é–±å–æ¶ˆæ™‚æª¢æ¸¬åˆ°è¶…é¡ä½¿ç”¨: 51 Credits
     Credits ç‚ºè² æ•¸ï¼ˆ-51ï¼‰ï¼Œé‡ç½®ç‚º 0
     ```

3. **æŸ¥çœ‹å‘ç¥¨**
   - Stripe åº”è¯¥è‡ªåŠ¨åˆ›å»ºæœ€ç»ˆå‘ç¥¨
   - åŒ…å«è¶…é¢è´¹ç”¨ HK$25.50

4. **éªŒè¯ Firestore æ•°æ®**
   ```
   users/{userId}:
   - credits: 0
   - currentCredits: 0
   - planType: "Free Plan"
   - subscription: null
   ```

---

### ç¬¬4æ­¥ï¼šéªŒè¯ Meter Events èšåˆ

1. **åœ¨ Stripe Dashboard æŸ¥çœ‹èšåˆæ•°æ®**
   - æ‰“å¼€ Meter é¡µé¢
   - æŸ¥çœ‹"æ´»åŠ¨"éƒ¨åˆ†
   - åº”è¯¥æ˜¾ç¤ºæ—¶é—´æ®µå†…çš„æ€»ä½¿ç”¨é‡

2. **å¯¹æ¯” Firestore æ•°æ®**
   - ç¡®è®¤ Stripe çš„èšåˆæ•°æ®ä¸ Firestore ä¸­è®°å½•çš„ä½¿ç”¨é‡ä¸€è‡´

---

## âœ… æµ‹è¯•é€šè¿‡æ ‡å‡†

### 1. Meter Events æ­£å¸¸è®°å½•
- âœ… æ¯æ¬¡æ‰£é™¤ Credits éƒ½ä¼šåœ¨ Stripe ä¸­è®°å½• Meter Event
- âœ… Event Name ä¸º `vaultcaddy_credit_usage`
- âœ… Customer ID æ­£ç¡®
- âœ… Value æ­£ç¡®

### 2. å‘ç¥¨åŒ…å«è¶…é¢è´¹ç”¨
- âœ… è®¡è´¹å‘¨æœŸç»“æŸæ—¶ï¼Œå‘ç¥¨åŒ…å«è¶…é¢è´¹ç”¨
- âœ… è¶…é¢è´¹ç”¨è®¡ç®—æ­£ç¡®ï¼ˆåŸºäºæ¢¯åº¦å®šä»·ï¼‰
- âœ… ç«‹å³å–æ¶ˆè®¢é˜…æ—¶ï¼Œä¹Ÿèƒ½æ­£ç¡®æ”¶å–è¶…é¢è´¹ç”¨

### 3. Credits ç®¡ç†æ­£ç¡®
- âœ… Pro Plan ç”¨æˆ·å¯ä»¥ä½¿ç”¨è´Ÿæ•° Credits
- âœ… è®¢é˜…å–æ¶ˆåï¼Œè´Ÿæ•° Credits é‡ç½®ä¸º 0
- âœ… Free Plan ç”¨æˆ·ä¸å…è®¸è´Ÿæ•° Credits

### 4. æ—¥å¿—æ¸…æ™°
- âœ… Firebase Logs æ˜¾ç¤ºè¯¦ç»†çš„ Meter Event æŠ¥å‘Šä¿¡æ¯
- âœ… é”™è¯¯æœ‰æ¸…æ™°çš„æ—¥å¿—è®°å½•
- âœ… å¯ä»¥è¿½è¸ªæ¯æ¬¡ä½¿ç”¨é‡æŠ¥å‘Š

---

## âŒ å¦‚æœæµ‹è¯•å¤±è´¥

### é—®é¢˜ 1ï¼šMeter Events æ²¡æœ‰è®°å½•
**å¯èƒ½åŸå› **ï¼š
- Meter ID ä¸åŒ¹é…
- Customer ID ä¸æ­£ç¡®
- Stripe API å¯†é’¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Firebase Logs ä¸­çš„é”™è¯¯ä¿¡æ¯
2. ç¡®è®¤ `stripeCustomerId` æ­£ç¡®ä¿å­˜åœ¨ Firestore
3. ç¡®è®¤ Meter Event Name ä¸º `vaultcaddy_credit_usage`

### é—®é¢˜ 2ï¼šå‘ç¥¨æ²¡æœ‰åŒ…å«è¶…é¢è´¹ç”¨
**å¯èƒ½åŸå› **ï¼š
- Meter ä»·æ ¼é…ç½®ä¸æ­£ç¡®
- è®¢é˜…æ²¡æœ‰åŒ…å« Meter ä»·æ ¼é¡¹
- Meter Events æœªæ­£ç¡®èšåˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ Stripe Dashboard ç¡®è®¤è®¢é˜…åŒ…å« Meter ä»·æ ¼é¡¹
2. æ£€æŸ¥ Meter é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆæ¢¯åº¦å®šä»·ï¼‰
3. åœ¨ Meter é¡µé¢æŸ¥çœ‹èšåˆæ•°æ®æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 3ï¼šCredits æ‰£é™¤å¤±è´¥
**å¯èƒ½åŸå› **ï¼š
- `reportUsageToStripe` å‡½æ•°å‡ºé”™
- Stripe å®¢æˆ·ç«¯æœªæ­£ç¡®é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æŸ¥çœ‹ Firebase Logs ä¸­çš„è¯¦ç»†é”™è¯¯
2. æ£€æŸ¥ `usageTracking.lastReportError` å­—æ®µ

---

## ğŸ“Š æµ‹è¯•æ•°æ®è®°å½•è¡¨

| æµ‹è¯•é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|----------|----------|------|
| åˆ›å»ºè®¢é˜… | è®¢é˜…åŒ…å« 2 ä¸ªè®¢é˜…é¡¹ | | â³ |
| ä¸Šä¼ æ–‡æ¡£ | Meter Event å·²è®°å½• | | â³ |
| Credits æ‰£é™¤ | Credits æ­£ç¡®å‡å°‘ | | â³ |
| è¶…é¢ä½¿ç”¨ | å…è®¸è´Ÿæ•° Credits | | â³ |
| å‘ç¥¨ç”Ÿæˆ | åŒ…å«è¶…é¢è´¹ç”¨ | | â³ |
| è®¢é˜…å–æ¶ˆ | Credits é‡ç½®ä¸º 0 | | â³ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼š
1. âœ… æ¸…ç†æ—§çš„è¯Šæ–­å·¥å…·ä»£ç 
2. âœ… åœ¨ç”Ÿäº§æ¨¡å¼ä¸­åˆ›å»ºç›¸åŒé…ç½®çš„ Meter
3. âœ… æ›´æ–°ç”Ÿäº§æ¨¡å¼çš„ä»·æ ¼é…ç½®
4. âœ… é€šçŸ¥ç°æœ‰ç”¨æˆ·ç³»ç»Ÿå‡çº§
5. âœ… ç›‘æ§ç”Ÿäº§ç¯å¢ƒè¿è¡Œæƒ…å†µ

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼š
1. æˆªå›¾ç›¸å…³çš„ Stripe Dashboard é¡µé¢
2. å¤åˆ¶ Firebase Logs ä¸­çš„é”™è¯¯ä¿¡æ¯
3. æä¾› Firestore ä¸­çš„ç”¨æˆ·æ•°æ®
4. å‘Šè¯‰æˆ‘å…·ä½“åœ¨å“ªä¸€æ­¥é‡åˆ°é—®é¢˜

æˆ‘ä¼šç«‹å³å¸®ä½ è§£å†³ï¼


