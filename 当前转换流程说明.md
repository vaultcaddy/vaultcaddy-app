# 📖 当前银行对账单转换流程说明

> **回答您的问题："讲解一下现在的转换的工作流程"**  
> **最后更新：** 2026-02-03（🆕 千问AI优化版）  
> **文档版本：** 2.0

## 🆕 重要更新（2026-02-03）

根据千问AI的建议，我们优化了Prompt和规则引擎：

1. **Prompt升级** - "VISUAL TEXT EXTRACTOR"模式
   - 明确禁止合并行（ZERO row merging）
   - 每个视觉行 = 一个transaction
   - 多语言关键词支持

2. **规则引擎增强**
   - 规则1：空日期填充
   - 规则2：余额校验（预警异常）

3. **职责分离**
   - AI：视觉提取
   - 规则引擎：确定性逻辑

详细说明请见：`CURRENT_WORKFLOW_EXPLANATION.md`

---

---

## 🔄 完整流程（10步）

```
┌──────────────────────────────────────────────────────────────┐
│  1️⃣ 用户上传文件 + 创建文档记录                              │
│     • 立即在Firestore创建"processing"状态的文档              │
│     • 用户马上看到"处理中"的文件                             │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  2️⃣ 检查Credits余额                                         │
│     • 计算所有文件的总页数                                   │
│     • creditsManager.checkCredits(totalPages)               │
│     • 不足 → 删除文档 + 停止                                 │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  3️⃣ 文件类型判断                                            │
│     • 检查是否为PDF                                          │
│     • 是 → 需要转换  / 否 → 直接处理                        │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  4️⃣ 上传到Firebase Storage                                  │
│     • 如果是PDF，先用pdf.js转为图片（300 DPI）               │
│     • 并行上传所有图片                                       │
│     • 获取公开URL数组                                        │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  5️⃣ 扣除Credits（真正扣除）                                 │
│     • creditsManager.deductCredits(pages)                   │
│     • 每页扣1 Credit                                         │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  6️⃣ 调用千问AI                                              │
│     • 文件→Base64                                            │
│     • 生成Prompt → 千问VL-Max API                           │
│     • 等待8-15秒                                             │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  7️⃣ 解析AI响应                                              │
│     • 清理markdown标记                                       │
│     • JSON.parse() + 验证                                    │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  8️⃣ 前端后处理（核心）                                      │
│     • postProcessTransactions()                             │
│     • 填充空白日期（同日多笔交易）                           │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  9️⃣ 保存到Firestore                                         │
│     • 更新文档状态：processing → completed                   │
│     • 保存提取的数据                                         │
└────────────────────────┬─────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────┐
│  🔟 刷新UI显示                                               │
│     • 读取最新数据                                           │
│     • 渲染表格，计算汇总                                     │
└──────────────────────────────────────────────────────────────┘
```

**⭐ 关键顺序（您指出的）：**
1. 用户上传文件 + 建立文档
2. 扣除Credits（先检查，后扣除）
3. 文件类型判断
4. 上传到Firebase Storage

---

## 详细步骤

### 1️⃣ 用户上传文件 + 创建文档记录
- **位置：** `firstproject.html` → `handleUpload()` 函数
- **支持格式：** PDF、JPG、PNG
- **触发：** 用户点击"Upload files"或拖拽文件
- **立即创建：** 在Firestore中创建"处理中"状态的文档记录
  ```javascript
  {
    name: file.name,
    status: 'processing',  // 处理中
    pages: 0,  // 暂时为0
    createdAt: now
  }
  ```
- **用户体验：** 立即在列表中看到"处理中"的文件

### 2️⃣ 检查Credits余额
- **工具：** `credits-manager.js`
- **时机：** 在开始处理之前检查
- **计算：** 先计算所有文件的总页数
- **验证：** `creditsManager.checkCredits(totalPages)`
- **不足处理：** 
  - 删除已创建的占位文档
  - 显示充值提示
  - 停止处理

### 3️⃣ 文件类型判断 + PDF转图片
- **工具：** `pdf-to-image-converter.js`
- **库：** pdf.js
- **设置：** 300 DPI（高清）
- **判断：** `pdfToImageConverter.isPDF(file)`
- **转换：** 如果是PDF → 转换为1张或多张图片
- **输出：** 图片文件数组 `[file1.jpg, file2.jpg, ...]`

### 4️⃣ 上传到Firebase Storage
- **路径：** `projects/{projectId}/documents/{docId}/page_1.jpg`
- **方式：** 并行上传所有图片
  ```javascript
  Promise.all(filesToProcess.map(f => uploadFile(projectId, f)))
  ```
- **作用：** 获取公开URL，供AI访问
- **更新文档：** 添加 `imageUrls[]` 到文档记录

### 5️⃣ 扣除Credits（真正扣除）
- **工具：** `credits-manager.js`
- **时机：** 上传Storage成功后
- **规则：** 每页扣1 Credit
- **扣除：** `creditsManager.deductCredits(pages)`
- **注意：** 这是真正从余额中扣除的时刻

### 6️⃣ 调用千问AI（核心步骤）🆕 优化版
**文件：** `qwen-vl-max-processor.js`

```javascript
// 1. 文件→Base64
const base64 = await fileToBase64(file);

// 2. 生成Prompt（千问AI优化版）
const prompt = generatePrompt('bank_statement');

// 3. 构建请求
{
  model: "qwen3-vl-plus-2025-12-19",
  messages: [{
    role: "user",
    content: [
      {type: "image_url", image_url: {url: "data:image/jpeg;base64,..."}},
      {type: "text", text: prompt}
    ]
  }],
  temperature: 0.1,
  max_tokens: 4000
}

// 4. 通过Worker转发
POST → deepseek-proxy.vaultcaddy.workers.dev

// 5. 等待8-15秒
// 6. 接收响应
```

**🆕 Prompt核心内容（千问AI优化版）：**
```
STRICT MODE: You are a VISUAL TEXT EXTRACTOR. 
ZERO calculation. ZERO inference. ZERO row merging.

提取规则：
• date: 复制可见文本，空白 → 输出 "" (空字符串)
• description: 复制所有文本（包括多行）
• debit: 复制数字（去逗号），空白 → 0
• credit: 复制数字（去逗号），空白 → 0
• balance: 复制数字（去逗号），空白/"—"/"N/A" → null

绝对命令：
• EACH VISUAL ROW = ONE transaction object. NEVER merge rows.
• 有Description/Debit/Credit但Date为空 → 仍输出date: ""
• 输出纯JSON，不要解释，不要markdown。

多语言支持：
• Balance / 餘額 / 잔액 / 残高
```

### 7️⃣ 解析响应
- **清理：** 移除markdown标记（```json）
- **解析：** JSON.parse()
- **验证：** 检查必需字段

### 8️⃣ **规则引擎后处理（关键步骤）**🆕 增强版
**函数：** `postProcessTransactions()`

**🆕 设计理念（千问AI建议）：**
- AI负责：视觉提取（"看到什么就复制什么"）
- 规则引擎负责：确定性逻辑（"100%可靠的数据处理"）

**规则1：空日期填充**
```javascript
lastValidDate = null

for each transaction:
    if (date为空):
        transaction.date = lastValidDate  // 继承上一行日期
    else:
        lastValidDate = transaction.date  // 更新基准日期
```

**🆕 规则2：余额校验（预警异常）**
```javascript
if (上一笔余额存在 && 当前余额存在):
    delta = abs(当前余额 - 上一笔余额)
    expected = max(debit, credit)
    if (delta > expected * 1.5):
        transaction.warning = "balance_jump"  // 标记异常跳变
```

**示例：**
```
输入（AI提取）：
[
  {date: "10 Mar", desc: "ATM", debit: 500, balance: 30218.39},
  {date: "",       desc: "转账", debit: 200, balance: 30018.39},  ← 空白日期
  {date: "",       desc: "POS", debit: 150, balance: 29868.39}   ← 空白日期
]

输出（规则引擎处理后）：
[
  {date: "10 Mar", desc: "ATM", debit: 500, balance: 30218.39},
  {date: "10 Mar", desc: "转账", debit: 200, balance: 30018.39},  ← 已填充
  {date: "10 Mar", desc: "POS", debit: 150, balance: 29868.39}   ← 已填充
]
```

**优势：**
- ✅ 确定性算法（100%可靠）
- ✅ 可扩展（轻松添加更多规则）
- ✅ 可追溯（可记录规则应用日志）

### 9️⃣ 保存到Firestore
**路径：** `projects/{projectId}/documents/{docId}`

**更新文档状态：**
```javascript
{
  name: "文档名称",
  status: "completed",  // 从 "processing" 改为 "completed"
  processedData: {处理后的完整数据},
  rawText: {AI原始响应},
  processingTime: 12345,
  processor: "qwen-vl-max",
  model: "qwen3-vl-plus-2025-12-19",
  createdAt: Timestamp
}
```

### 🔟 刷新UI显示
- 从Firestore读取最新数据
- 渲染表格，显示所有交易
- 计算汇总（总收入、总支出、余额）

---

## 🎯 关键技术点

### 1. Credits的两步处理机制

**为什么分两步？**

**步骤2：检查余额（checkCredits）**
- **时机：** 在开始任何处理之前
- **作用：** 确保用户有足够的Credits
- **位置：** `handleUpload()` 函数中
- **代码：**
  ```javascript
  const hasEnoughCredits = await creditsManager.checkCredits(totalPages);
  if (!hasEnoughCredits) {
      // 删除已创建的占位文档
      // 显示充值提示
      return; // 停止处理
  }
  ```

**步骤5：真正扣除（deductCredits）**
- **时机：** 上传Storage成功后，AI处理之前
- **作用：** 从用户余额中扣除Credits
- **位置：** `uploadFileWithExistingDoc()` 函数中
- **代码：**
  ```javascript
  await creditsManager.deductCredits(filesToProcess.length);
  logger.log(`💰 已扣除 ${filesToProcess.length} Credits`);
  ```

**为什么不在步骤2就扣除？**
- ✅ 避免提前扣费（如果PDF转换失败，就不扣费）
- ✅ 按实际处理的页数扣费（更准确）
- ✅ 失败时可以退回Credits

---

### 2. 双重策略（Prompt + 后处理）

**Prompt告诉AI：**
- "如果日期为空，输出空字符串''"
- "不要自己填充日期"

**前端处理：**
- 检测空字符串
- 用确定性算法填充
- 100%可靠

### 3. 为什么不让AI直接填充日期？

**问题：** AI视觉理解不稳定
- 可能把"10 Mar"复制到错误的行
- 可能识别错误的日期文本
- 准确率只有60-70%

**解决：** 前端JavaScript确定性算法
- 确定性逻辑，100%可靠
- 不依赖AI的视觉理解
- 准确率98%+

---

## 📊 多页文档处理

**方式：** 批量模式

```
[图1, 图2, 图3] → 全部Base64 → 一次性发给AI → 
AI看完整上下文 → 返回合并结果
```

**优势：**
- ✅ 只需1次API调用（省钱）
- ✅ AI可以看到完整信息（更准确）
- ✅ 速度更快

---

## ⚠️ 恒生银行问题

您提到"问题无法解决"，让我诊断：

### 可能性1：AI完全不识别日期？
**检查：** 打开控制台，查看AI原始响应
```javascript
// 查看最新文档
const docs = await window.simpleDataManager.getDocuments(currentProjectId);
console.log('AI原始响应:', docs[0].rawText);
```

**如果第一笔的日期也是空，说明AI识别失败。**

### 可能性2：后处理没执行？
**检查：** 在 `qwen-vl-max-processor.js` 第107行添加日志
```javascript
console.log('🔍 后处理前:', extractedData.transactions);
const processedData = this.postProcessTransactions(extractedData);
console.log('✅ 后处理后:', processedData.transactions);
```

### 可能性3：UI不显示？
**检查：** `firstproject.html` 表格渲染代码

---

## 💡 解决方案建议

### 如果AI识别失败
**方案A：** 增强Prompt
- 添加更多示例
- 明确说明表格结构

**方案B：** OCR预处理
- 使用Tesseract.js先识别文本
- 获取坐标信息
- 用规则引擎对齐字段

### 如果后处理有bug
- 检查空白日期的判断条件
- 检查lastValidDate的更新逻辑

---

## 📝 总结

**当前流程（10步）：**
1. ✅ 用户上传文件 → **立即创建文档记录**（状态：processing）
2. ✅ **检查Credits** → 验证余额是否足够
3. ✅ 文件类型判断 → PDF需要转换
4. ✅ PDF转图片 → pdf.js（300 DPI）
5. ✅ 上传Storage → 获取图片URL
6. ✅ **扣除Credits** → 真正从余额中扣除
7. ✅ **AI提取** → 千问VL-Max（8-15秒）
8. ✅ 解析响应 → 清理和验证JSON
9. ✅ **前端后处理** → **填充空白日期**（核心）
10. ✅ 更新文档状态 → completed + 显示结果

**核心创新：**
- ✅ Prompt告诉AI"空白就输出空字符串"
- ✅ 前端用确定性算法填充
- ✅ 不依赖AI的完美理解

**下一步：**
请告诉我具体哪一步有问题，我可以针对性解决！

---

**创建时间：** 2026-02-03  
**回答问题：** "讲解一下现在的转换的工作流程"

