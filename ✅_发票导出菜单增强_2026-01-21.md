# ✅ 发票导出菜单增强 - 添加会计软件CSV格式

## 📋 用户需求
在发票的导出菜单中添加像银行对账单那样的**CSV格式选项**，让用户可以将发票导出到不同的会计软件（Xero、QuickBooks等）。

**之前**：
- 发票只有2个导出选项：
  1. 標準 CSV（總數）
  2. 完整交易數據 CSV

**现在**：
- 发票有4个CSV格式选项：
  1. **Xero CSV** - Xero 發票導入格式
  2. **QuickBooks CSV** - QuickBooks Online 格式
  3. 標準 CSV（總數）
  4. 完整交易數據 CSV

---

## ✅ 已完成的更改

### 修改文件
`firstproject.html`

### 修改位置
1. **菜单内容更新** (第 4146-4165 行) - 添加 Xero 和 QuickBooks 选项
2. **导出函数处理** (第 4771-4815 行) - 添加新格式的导出逻辑
3. **辅助函数处理** (第 4349-4369 行) - 添加辅助函数支持

---

## 🎨 新的发票导出菜单结构

### 修改前：
```
發票
  - 標準 CSV（總數）
  - 完整交易數據 CSV
```

### 修改后：
```
CSV 格式
  - 🌐 Xero CSV (推荐)
    ✨ Xero 發票導入格式
  
  - 📄 QuickBooks CSV
    QuickBooks Online 格式

標準格式
  - 標準 CSV（總數）
    快速對帳
  
  - 完整交易數據 CSV
    詳細記錄
```

---

## 🔧 技术实现

### 1️⃣ 菜单内容更新

**修改前**：
```javascript
if (hasInvoice) {
    menuHTML += `
        <div>發票</div>
        <button onclick="exportDocuments('invoice_summary_csv')">標準 CSV（總數）</button>
        <button onclick="exportDocuments('invoice_detailed_csv')">完整交易數據 CSV</button>
    `;
}
```

**修改后**：
```javascript
if (hasInvoice) {
    menuHTML += `
        <div style="padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">CSV 格式</div>
        
        <button onclick="exportDocuments('invoice_xero_csv')" class="export-menu-item" style="...background: linear-gradient(90deg, rgba(16,185,129,0.05) 0%, transparent 100%);">
            <i class="fas fa-globe" style="color: #10b981; width: 20px;"></i>
            <div>
                <div style="font-weight: 600;">🌐 Xero CSV</div>
                <div style="font-size: 0.75rem; color: #059669; font-weight: 500;">✨ Xero 發票導入格式</div>
            </div>
        </button>
        
        <button onclick="exportDocuments('invoice_quickbooks_csv')" class="export-menu-item" style="...">
            <i class="fas fa-file-csv" style="color: #3b82f6; width: 20px;"></i>
            <div>
                <div style="font-weight: 500;">📄 QuickBooks CSV</div>
                <div style="font-size: 0.75rem; color: #6b7280;">QuickBooks Online 格式</div>
            </div>
        </button>
        
        <div style="padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem;">標準格式</div>
        
        <button onclick="exportDocuments('invoice_summary_csv')" class="export-menu-item" style="...">
            <i class="fas fa-file-invoice" style="color: #f59e0b; width: 20px;"></i>
            <div>
                <div style="font-weight: 500;">標準 CSV（總數）</div>
                <div style="font-size: 0.75rem; color: #6b7280;">快速對帳</div>
            </div>
        </button>
        
        <button onclick="exportDocuments('invoice_detailed_csv')" class="export-menu-item" style="...">
            <i class="fas fa-file-invoice" style="color: #f59e0b; width: 20px;"></i>
            <div>
                <div style="font-weight: 500;">完整交易數據 CSV</div>
                <div style="font-size: 0.75rem; color: #6b7280;">詳細記錄</div>
            </div>
        </button>
    `;
}
```

---

### 2️⃣ 导出函数处理

添加两个新的 case 分支：

```javascript
case 'invoice_xero_csv':
    // Xero 發票 CSV 格式
    if (window.InvoiceExport && window.InvoiceExport.generateXeroCSV) {
        exportContent = window.InvoiceExport.generateXeroCSV(docsToExport);
        fileName = `Invoice_Xero_${new Date().toISOString().split('T')[0]}.csv`;
        mimeType = 'text/csv;charset=utf-8;';
        console.log('✅ Xero 發票 CSV 導出');
    } else {
        alert('Xero 發票導出模塊未載入，請刷新頁面後重試');
        return;
    }
    break;

case 'invoice_quickbooks_csv':
    // QuickBooks 發票 CSV 格式
    if (window.InvoiceExport && window.InvoiceExport.generateQuickBooksCSV) {
        exportContent = window.InvoiceExport.generateQuickBooksCSV(docsToExport);
        fileName = `Invoice_QuickBooks_${new Date().toISOString().split('T')[0]}.csv`;
        mimeType = 'text/csv;charset=utf-8;';
        console.log('✅ QuickBooks 發票 CSV 導出');
    } else {
        alert('QuickBooks 發票導出模塊未載入，請刷新頁面後重試');
        return;
    }
    break;
```

---

### 3️⃣ 辅助函数支持

在 `exportByType()` 函数中添加支持：

```javascript
async function exportByType(docs, format) {
    // ...
    switch(format) {
        case 'bank_statement_csv':
            // ...
            break;
            
        case 'invoice_summary_csv':
            if (window.InvoiceExport) {
                exportContent = window.InvoiceExport.generateInvoiceSummaryCSV(docs);
                fileName = `Invoice_${new Date().toISOString().split('T')[0]}.csv`;
            }
            break;
        
        case 'invoice_xero_csv':
            if (window.InvoiceExport && window.InvoiceExport.generateXeroCSV) {
                exportContent = window.InvoiceExport.generateXeroCSV(docs);
                fileName = `Invoice_Xero_${new Date().toISOString().split('T')[0]}.csv`;
            }
            break;
        
        case 'invoice_quickbooks_csv':
            if (window.InvoiceExport && window.InvoiceExport.generateQuickBooksCSV) {
                exportContent = window.InvoiceExport.generateQuickBooksCSV(docs);
                fileName = `Invoice_QuickBooks_${new Date().toISOString().split('T')[0]}.csv`;
            }
            break;
        
        // ...
    }
}
```

---

## 📊 导出格式说明

### 1️⃣ Xero CSV 格式

**文件名**：`Invoice_Xero_2026-01-21.csv`

**CSV列**：
```csv
*ContactName,*InvoiceNumber,*InvoiceDate,DueDate,*Description,Quantity,UnitAmount,AccountCode,TaxType
```

**说明**：
- 符合 Xero 发票导入官方格式
- 带 `*` 的列为必填项
- 包含联系人、发票号、日期、项目明细
- 支持税务类型和会计科目代码

**用途**：直接导入 Xero 会计系统

---

### 2️⃣ QuickBooks CSV 格式

**文件名**：`Invoice_QuickBooks_2026-01-21.csv`

**CSV列**：
```csv
*Customer,*InvoiceDate,*InvoiceNo,Item(Product/Service),ItemDescription,ItemQuantity,ItemRate,ItemAmount,Taxable,TaxAmount
```

**说明**：
- 符合 QuickBooks Online 发票导入格式
- 包含客户、日期、发票号、项目明细
- 支持税务计算和项目金额

**用途**：直接导入 QuickBooks Online

---

### 3️⃣ 標準 CSV（總數）

**文件名**：`Invoice_Summary_2026-01-21.csv`

**CSV列**：
```csv
發票編號,供應商,日期,總金額,稅額,狀態
```

**说明**：
- 每张发票一行
- 只包含汇总信息
- 适合快速对账

---

### 4️⃣ 完整交易數據 CSV

**文件名**：`Invoice_Detailed_2026-01-21.csv`

**CSV列**：
```csv
發票編號,供應商,電話,Email,日期,項目名稱,數量,單價,小計,總金額
```

**说明**：
- 每个项目一行
- 包含完整的供应商和项目信息
- 适合详细记录和审计

---

## 🧪 测试步骤

### 步骤 1: 强制刷新页面
```bash
Cmd + Shift + R  # Mac
```

打开：`https://vaultcaddy.com/firstproject.html?project=SJJkhY7CFdqh8zyVAM6B`

### 步骤 2: 选择发票文档
1. 勾选至少1个**发票**文档
2. 点击 **Export** 按钮
3. 查看导出菜单

**预期结果**：
- ✅ 看到 "CSV 格式" 分类标题
- ✅ 看到 "🌐 Xero CSV" 选项（带绿色高亮）
- ✅ 看到 "📄 QuickBooks CSV" 选项
- ✅ 看到 "標準格式" 分类标题
- ✅ 看到 "標準 CSV（總數）" 选项
- ✅ 看到 "完整交易數據 CSV" 选项

### 步骤 3: 测试 Xero CSV 导出
1. 点击 "🌐 Xero CSV"
2. 等待下载

**预期结果**：
- ✅ 下载文件：`Invoice_Xero_2026-01-21.csv`
- ✅ 文件格式符合 Xero 导入要求
- ✅ 包含 ContactName, InvoiceNumber, InvoiceDate 等列

### 步骤 4: 测试 QuickBooks CSV 导出
1. 点击 "📄 QuickBooks CSV"
2. 等待下载

**预期结果**：
- ✅ 下载文件：`Invoice_QuickBooks_2026-01-21.csv`
- ✅ 文件格式符合 QuickBooks Online 导入要求
- ✅ 包含 Customer, InvoiceDate, InvoiceNo 等列

---

## 📋 菜单对比总结

### 银行对账单菜单：
```
CSV 格式
  - 🌐 通用 CSV (Xero, Wave, QuickBooks, MYOB)
  - 📄 Sage CSV
  - 📄 Zoho Books CSV

其他格式
  - ☁️ QBO 文件
  - 📊 Excel (.xlsx)
```

### 发票菜单（新）：
```
CSV 格式
  - 🌐 Xero CSV (推荐)
  - 📄 QuickBooks CSV

標準格式
  - 標準 CSV（總數）
  - 完整交易數據 CSV

其他格式
  - ☁️ QBO 文件
  - 📊 Excel (.xlsx)
```

---

## 🎯 优点

### 1️⃣ **与会计软件直接集成**
- Xero 和 QuickBooks 官方格式
- 可以直接导入，无需手动调整

### 2️⃣ **统一的用户体验**
- 发票和银行对账单菜单结构相似
- 便于用户理解和使用

### 3️⃣ **灵活的导出选项**
- 会计软件专用格式（Xero, QuickBooks）
- 标准汇总格式（快速对账）
- 完整详细格式（审计记录）

### 4️⃣ **专业的 UI 设计**
- 推荐选项有绿色高亮
- 清晰的图标和说明文字
- 分类标题便于导航

---

## 📊 导出功能完整对比

| 格式 | 银行对账单 | 发票 |
|-----|----------|-----|
| **Xero CSV** | ✅ 通用CSV | ✅ 发票CSV |
| **QuickBooks CSV** | ✅ 通用CSV | ✅ 发票CSV |
| **Sage CSV** | ✅ | ❌ |
| **Zoho Books CSV** | ✅ | ❌ |
| **標準 CSV** | ✅ | ✅ |
| **詳細 CSV** | ❌ | ✅ |
| **QBO 文件** | ✅ | ✅ |
| **Excel (.xlsx)** | ✅ | ✅ |

---

## 🔗 相关文档
- `✅_发票Excel格式修复_2026-01-21.md` - 发票Excel格式修复
- `✅_导出功能完整检查报告_2026-01-21.md` - 导出功能检查
- `invoice-export.js` - 发票导出模块（包含 Xero 和 QuickBooks 生成函数）

---

## 📝 依赖说明

新增的发票导出格式依赖于 `invoice-export.js` 模块中的以下函数：

```javascript
window.InvoiceExport = {
    generateXeroCSV,           // ✅ 已实现
    generateQuickBooksCSV,     // ✅ 已实现
    generateInvoiceSummaryCSV, // ✅ 已实现
    generateInvoiceDetailedCSV // ✅ 已实现
};
```

所有函数均已在 `invoice-export.js` 中实现，无需额外开发。

---

**创建时间**：2026-01-21  
**作者**：VaultCaddy AI Assistant  
**相关文件**：`firstproject.html`, `invoice-export.js`

