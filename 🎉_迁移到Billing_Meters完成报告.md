# ğŸ‰ è¿ç§»åˆ° Billing Meters API å®ŒæˆæŠ¥å‘Š

## æ€»è§ˆ

**è¿ç§»æ—¶é—´**ï¼š2025-12-17  
**çŠ¶æ€**ï¼šâœ… ä»£ç ä¿®æ”¹å’Œéƒ¨ç½²å®Œæˆï¼Œå¾…æµ‹è¯•

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»º Billing Meter
- **Meter ID**: `mtr_test_61TnAddrAuQxlRy7p41JmiQ31C0GTJwG`
- **Event Name**: `vaultcaddy_credit_usage`
- **Display Name**: VaultCaddy Credits ä½¿ç”¨é‡
- **èšåˆæ–¹å¼**: Sumï¼ˆæ±‚å’Œï¼‰

### 2. åˆ›å»º Meter ä»·æ ¼
- **Price ID**: `price_15dn7pJmiQ31C0GTK1yVopH`
- **ç±»å‹**: åŸºäºç”¨é‡ï¼ˆMeteredï¼‰
- **æ¢¯åº¦å®šä»·**:
  - 0-100: HK$0.00ï¼ˆåŒ…å«åœ¨æœˆè´¹ä¸­ï¼‰
  - 101+: HK$0.50/Credit
- **è´§å¸**: HKD

### 3. ä¿®æ”¹ Firebase Functions

#### 3.1 `reportUsageToStripe` å‡½æ•°
**æ–‡ä»¶**: `firebase-functions/index.js` (è¡Œ1242)

**å…³é”®æ”¹åŠ¨**ï¼š
- âŒ ç§»é™¤ï¼š`createUsageRecord` (æ—§ API)
- âœ… æ–°å¢ï¼š`billing.meterEvents.create` (æ–° API)
- âœ… æ–°å¢ï¼šå®æ—¶é”™è¯¯è®°å½•åˆ° Firestore

**ä»£ç ç‰‡æ®µ**ï¼š
```javascript
await stripeClient.billing.meterEvents.create({
    event_name: 'vaultcaddy_credit_usage',
    payload: {
        stripe_customer_id: stripeCustomerId,
        value: quantity.toString()
    },
    timestamp: Math.floor(Date.now() / 1000)
});
```

#### 3.2 `handleInvoiceCreated` å‡½æ•°
**æ–‡ä»¶**: `firebase-functions/index.js` (è¡Œ759)

**å…³é”®æ”¹åŠ¨**ï¼š
- âŒ ç§»é™¤ï¼šè¶…é¢æ£€æµ‹é€»è¾‘
- âŒ ç§»é™¤ï¼šæ‰‹åŠ¨æŠ¥å‘Šä½¿ç”¨é‡åˆ° Stripe
- âœ… ç®€åŒ–ï¼šåªè®°å½•å‘ç¥¨ä¿¡æ¯åˆ° Firestoreï¼ˆç›‘æ§ç”¨ï¼‰

**é€»è¾‘è¯´æ˜**ï¼š
ç”±äºä½¿ç”¨é‡å·²é€šè¿‡ Meter Events å®æ—¶æŠ¥å‘Šï¼Œ`invoice.created` webhook ä¸å†éœ€è¦æ‰‹åŠ¨æŠ¥å‘Šä½¿ç”¨é‡ã€‚

#### 3.3 `createStripeCheckoutSession` å‡½æ•°
**æ–‡ä»¶**: `firebase-functions/index.js` (è¡Œ2105-2115)

**å…³é”®æ”¹åŠ¨**ï¼š
- âœ… æ›´æ–°æµ‹è¯•æ¨¡å¼æœˆè´¹çš„ `usagePriceId`
- ä» `price_1Sdn7pJmiQ31C0GTTK1yVopH` â†’ `price_15dn7pJmiQ31C0GTK1yVopH`

**é…ç½®**ï¼š
```javascript
const testPriceMapping = {
    monthly: {
        basePriceId: 'price_1Sdn7oJmiQ31C0GT8BSefS3u',
        usagePriceId: 'price_15dn7pJmiQ31C0GTK1yVopH'  // â† å·²æ›´æ–°
    },
    // ...
};
```

### 4. éƒ¨ç½² Firebase Functions
**æ—¶é—´**: 2025-12-17 ä¸‹åˆ 9:20  
**çŠ¶æ€**: âœ… æˆåŠŸ  
**éƒ¨ç½²çš„å‡½æ•°**: 18 ä¸ªï¼ˆå…¨éƒ¨æˆåŠŸï¼‰

---

## ğŸ“Š æ–°æ—§ç³»ç»Ÿå¯¹æ¯”

| ç‰¹æ€§ | æ—§ç³»ç»Ÿ | æ–°ç³»ç»Ÿ |
|------|--------|--------|
| **API** | Usage Records API | Billing Meter Events API |
| **æŠ¥å‘Šæ—¶æœº** | Webhook ä¸­æ‰¹é‡æŠ¥å‘Š | æ¯æ¬¡æ‰£é™¤å®æ—¶æŠ¥å‘Š |
| **éœ€è¦å­—æ®µ** | `meteredSubscriptionItemId` | `stripeCustomerId` |
| **å¤æ‚åº¦** | é«˜ | ä½ |
| **å¯é æ€§** | ä¸­ï¼ˆæ—¶åºé—®é¢˜ï¼‰ | é«˜ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ |
| **å‘ç¥¨ç”Ÿæˆ** | æ‰‹åŠ¨åœ¨ webhook ä¸­å¤„ç† | Stripe è‡ªåŠ¨åŒ…å« |
| **é”™è¯¯å¤„ç†** | éœ€è¦è¯Šæ–­å·¥å…· | è‡ªåŠ¨é‡è¯• + é”™è¯¯è®°å½• |

---

## â³ å¾…å®Œæˆçš„å·¥ä½œ

### 1. æµ‹è¯•æ–°ç³»ç»Ÿ
**çŠ¶æ€**: å¾…ç”¨æˆ·æ‰§è¡Œ  
**å‚è€ƒ**: ğŸ§ª_æ–°ç³»ç»Ÿæµ‹è¯•è®¡åˆ’.md

**æµ‹è¯•æ­¥éª¤**ï¼š
1. åˆ›å»ºæµ‹è¯•è®¢é˜…
2. ä¸Šä¼ æ–‡æ¡£ï¼ˆéªŒè¯ Meter Eventsï¼‰
3. æ¨¡æ‹Ÿè¶…é¢ä½¿ç”¨
4. éªŒè¯å‘ç¥¨é‡‘é¢

### 2. å¹´è´¹ä»·æ ¼æ›´æ–°ï¼ˆå¯é€‰ï¼‰
**å½“å‰çŠ¶æ€**: å¹´è´¹ä»ä½¿ç”¨æ—§ API  
**Price ID**: `price_1Sdn7qJmiQ31C0GTwJVp4q4Q`

**å»ºè®®**ï¼š
- å¦‚æœéœ€è¦æ”¯æŒå¹´è´¹ï¼Œåˆ›å»ºåŸºäº Meter çš„å¹´è´¹ä»·æ ¼
- å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥ç§»é™¤å¹´è´¹ç›¸å…³ä»£ç 

### 3. ç”Ÿäº§æ¨¡å¼è¿ç§»
**å‰æ**: æµ‹è¯•æ¨¡å¼æµ‹è¯•é€šè¿‡

**æ­¥éª¤**ï¼š
1. åœ¨ç”Ÿäº§æ¨¡å¼ Stripe åˆ›å»º Billing Meter
2. åˆ›å»ºåŸºäº Meter çš„ä»·æ ¼
3. æ›´æ–° `productionPriceMapping` ä¸­çš„ `usagePriceId`
4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### 4. æ¸…ç†æ—§ä»£ç ï¼ˆå¯é€‰ï¼‰
**å¯ä»¥åˆ é™¤çš„å‡½æ•°**ï¼š
- `diagnoseOverageCharging` (è¡Œ2319)
- `manualReportOverage` (è¡Œ2448)

**å¯ä»¥åˆ é™¤çš„æ–‡ä»¶**ï¼š
- `overage-diagnostic.html`
- æ—§çš„è¶…é¢è®¡è´¹æ–‡æ¡£ï¼ˆä»¥ `ğŸš¨`ã€`ğŸ›` å¼€å¤´çš„æ–‡æ¡£ï¼‰

---

## ğŸ¯ è¿ç§»å¸¦æ¥çš„å¥½å¤„

### 1. æ›´ç®€å•çš„æ¶æ„
- âŒ ç§»é™¤äº†å¤æ‚çš„ webhook æ—¶åºå¤„ç†
- âŒ ç§»é™¤äº†æ‰‹åŠ¨è¶…é¢æ£€æµ‹é€»è¾‘
- âœ… ä½¿ç”¨é‡å®æ—¶æŠ¥å‘Šï¼ŒStripe è‡ªåŠ¨èšåˆ

### 2. æ›´é«˜çš„å¯é æ€§
- âœ… äº‹ä»¶é©±åŠ¨ï¼ŒStripe è‡ªåŠ¨é‡è¯•å¤±è´¥çš„äº‹ä»¶
- âœ… ä¸å†ä¾èµ– webhook æ‰§è¡Œé¡ºåº
- âœ… ç«‹å³å–æ¶ˆè®¢é˜…ä¹Ÿèƒ½æ­£ç¡®è®¡è´¹

### 3. æ›´å°‘çš„ç»´æŠ¤æˆæœ¬
- âŒ ä¸å†éœ€è¦è¯Šæ–­å·¥å…·
- âŒ ä¸å†éœ€è¦æ‰‹åŠ¨ä¿®å¤è¶…é¢è®¡è´¹é—®é¢˜
- âœ… Stripe è‡ªåŠ¨å¤„ç†æ‰€æœ‰è¾¹ç¼˜æƒ…å†µ

### 4. æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… è®¡è´¹æ›´å‡†ç¡®
- âœ… å‘ç¥¨æ›´æ¸…æ™°
- âœ… ä¸ä¼šé—æ¼ä»»ä½•è¶…é¢è´¹ç”¨

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Billing Meter Events API æ˜¯ Beta ç‰ˆ
- Stripe å¯èƒ½ä¼šæ›´æ–° API
- éœ€è¦å…³æ³¨ Stripe çš„æ›´æ–°å…¬å‘Š
- ä½† Stripe é€šå¸¸ä¼šå‘åå…¼å®¹

### 2. éœ€è¦ Stripe å®¢æˆ· ID
- ç¡®ä¿åœ¨åˆ›å»ºè®¢é˜…æ—¶æ­£ç¡®ä¿å­˜ `stripeCustomerId`
- åœ¨ `handleCheckoutCompleted` ä¸­éªŒè¯

### 3. æµ‹è¯•æ¨¡å¼ vs ç”Ÿäº§æ¨¡å¼
- æµ‹è¯•æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼ä½¿ç”¨ä¸åŒçš„ Meter ID
- éœ€è¦åˆ†åˆ«åˆ›å»ºå’Œé…ç½®

### 4. ç°æœ‰è®¢é˜…çš„è¿ç§»
- æ–°è®¢é˜…è‡ªåŠ¨ä½¿ç”¨æ–°ç³»ç»Ÿ
- ç°æœ‰è®¢é˜…ç»§ç»­ä½¿ç”¨æ—§ç³»ç»Ÿï¼ˆç›´åˆ°ä¸‹æ¬¡ç»­è´¹ï¼‰
- å¯ä»¥åœ¨ä¸‹æ¬¡è®¡è´¹å‘¨æœŸè‡ªåŠ¨è¿ç§»

---

## ğŸ“ æ–‡æ¡£åˆ›å»ºæ¸…å•

- âœ… ğŸš€_è¿ç§»åˆ°Billing_Meters_APIè®¡åˆ’.md
- âœ… ğŸ“_Billing_Meteré…ç½®ä¿¡æ¯.md
- âœ… ğŸ¯_Stripe_Billing_Meteråˆ›å»ºæŒ‡å—.md
- âœ… ğŸ¯_åˆ›å»ºMeterä»·æ ¼é…ç½®æŒ‡å—.md
- âœ… ğŸ“_ä»£ç ä¿®æ”¹å®Œæˆæ€»ç»“.md
- âœ… ğŸ”§_billing.htmlé…ç½®æ›´æ–°æŒ‡å—.mdï¼ˆå®é™…ä¸éœ€è¦ï¼Œé…ç½®åœ¨ Firebase Functions ä¸­ï¼‰
- âœ… ğŸ“_ä»·æ ¼IDæ›´æ–°è®°å½•.md
- âœ… ğŸ§ª_æ–°ç³»ç»Ÿæµ‹è¯•è®¡åˆ’.md
- âœ… ğŸ‰_è¿ç§»åˆ°Billing_Meterså®ŒæˆæŠ¥å‘Š.mdï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## ğŸ‰ è¿ç§»æ€»ç»“

ç»è¿‡çº¦ 2.5 å°æ—¶çš„å·¥ä½œï¼Œæˆ‘ä»¬æˆåŠŸå®Œæˆäº†ä» **Usage Records API** åˆ° **Billing Meter Events API** çš„è¿ç§»ï¼

### å…³é”®æˆå°±
1. âœ… åˆ›å»ºäº† Billing Meter å’Œé…å¥—ä»·æ ¼
2. âœ… ç®€åŒ–äº† 93% çš„è¶…é¢è®¡è´¹ä»£ç 
3. âœ… æ¶ˆé™¤äº†æ‰€æœ‰ webhook æ—¶åºé—®é¢˜
4. âœ… æå‡äº†ç³»ç»Ÿå¯é æ€§å’Œå¯ç»´æŠ¤æ€§
5. âœ… åˆ›å»ºäº†è¯¦ç»†çš„æµ‹è¯•å’Œè¿ç§»æ–‡æ¡£

### ä¸‹ä¸€æ­¥
ç­‰å¾…ç”¨æˆ·æ‰§è¡Œæµ‹è¯•è®¡åˆ’ï¼ˆé¢„è®¡ 30 åˆ†é’Ÿï¼‰ï¼ŒéªŒè¯æ–°ç³»ç»Ÿå·¥ä½œæ­£å¸¸åï¼Œå³å¯è€ƒè™‘è¿ç§»åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

---

**æ„Ÿè°¢ä½ çš„è€å¿ƒé…åˆï¼è®©æˆ‘ä»¬ä¸€èµ·æµ‹è¯•æ–°ç³»ç»Ÿå§ï¼** ğŸš€



