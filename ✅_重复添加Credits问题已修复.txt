# âœ… é‡å¤æ·»åŠ  Credits é—®é¢˜å·²ä¿®å¤

## ğŸ” **é—®é¢˜åŸå› **

æ‚¨çš„ Stripe checkout session ä¸­æœ‰ **2 ä¸ª** line itemsï¼š
- Line item 1: è®¢é˜…äº§å“ï¼ˆrecurringï¼‰
- Line item 2: å¯èƒ½æ˜¯è®¾ç½®è´¹ç”¨æˆ–å…¶ä»–ï¼ˆone_timeï¼‰

æ—§ä»£ç å¯¹æ¯ä¸ª line item éƒ½æ·»åŠ äº† Creditsï¼š
- Line item 1: +100 Credits
- Line item 2: +100 Credits
- **æ€»å…±: 200 Credits** âŒ

---

## âœ… **ä¿®å¤å†…å®¹**

ä¿®æ”¹äº† `handleCheckoutCompleted` å‡½æ•°ï¼š

1. **æ·»åŠ  `creditsAdded` æ ‡å¿—**
   - ç¡®ä¿å³ä½¿æœ‰å¤šä¸ª line itemsï¼ŒCredits ä¹Ÿåªè¢«æ·»åŠ ä¸€æ¬¡

2. **æ£€æŸ¥ `price.type === 'recurring'`**
   - åªå¤„ç†è®¢é˜…ç±»å‹çš„äº§å“
   - è·³è¿‡ä¸€æ¬¡æ€§è´¹ç”¨æˆ–å…¶ä»–ç±»å‹çš„ line items

3. **å¢å¼ºæ—¥å¿—**
   - è®°å½•æ¯ä¸ª line item çš„è¯¦ç»†ä¿¡æ¯
   - æ˜¾ç¤ºæ˜¯å¦ä¸ºè®¢é˜…ç±»å‹
   - æ˜¾ç¤ºæ˜¯å¦è·³è¿‡å¤„ç†

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

### **æ­¥éª¤ 1ï¼šæ¸…ç†æµ‹è¯•æ•°æ®**

1. **åˆ é™¤ processedStripeEvents é›†åˆ**ï¼š
   ```
   Firebase Console â†’ Firestore â†’ processedStripeEvents â†’ åˆ é™¤æ‰€æœ‰æ–‡æ¡£
   ```

2. **å°† Credits è®¾ä¸º 0**ï¼š
   ```
   Firebase Console â†’ Firestore â†’ users â†’ [æ‚¨çš„ç”¨æˆ·] â†’ å°† credits å’Œ currentCredits è®¾ä¸º 0
   ```

---

### **æ­¥éª¤ 2ï¼šé‡æ–°æµ‹è¯•æ”¯ä»˜**

1. è®¿é—®ï¼šhttps://vaultcaddy.com/billing.html

2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**

3. å®Œæˆæ”¯ä»˜

---

### **æ­¥éª¤ 3ï¼šéªŒè¯ç»“æœ**

**âœ… é¢„æœŸç»“æœ**ï¼š
- Credits ä» `0` â†’ `100`ï¼ˆè€Œä¸æ˜¯ 200ï¼‰
- è´­ä¹°è®°å½•ä¸­åªæ˜¾ç¤º **1 æ¡** `+100` çš„è®°å½•
- `planType` æ˜¾ç¤ºä¸º `Pro Plan`
- `resetDate` ä¸º 1 ä¸ªæœˆå

**âŒ å¦‚æœè¿˜æ˜¯ 200**ï¼š
- è¯·æˆªå›¾ Firebase Functions æ—¥å¿—
- æŸ¥çœ‹ `ğŸ“¦ LineItems æ•¸é‡` å’Œ `ğŸ” æ˜¯å¦è®¢é˜…ç±»å‹` çš„æ—¥å¿—

---

## ğŸ“Š **ä¿®å¤å‰åå¯¹æ¯”**

### **ä¿®å¤å‰**ï¼š
```
for (const item of lineItems.data) {
    const credits = parseInt(product.metadata.monthly_credits);
    if (credits > 0) {
        await addCredits(userId, credits); // âŒ æ¯ä¸ª line item éƒ½æ·»åŠ 
    }
}
```

**ç»“æœ**ï¼š
- æœ‰ 2 ä¸ª line items
- Credits è¢«æ·»åŠ  2 æ¬¡
- æ€»å…± 200 Credits âŒ

---

### **ä¿®å¤å**ï¼š
```javascript
let creditsAdded = false;

for (const item of lineItems.data) {
    if (creditsAdded) {
        console.log(`âš ï¸ Credits å·²æ·»åŠ ï¼Œè·³è¿‡æ­¤ line item`);
        continue; // âœ… è·³è¿‡åç»­ line items
    }
    
    const isSubscription = item.price.type === 'recurring';
    const credits = parseInt(product.metadata.monthly_credits);
    
    if (credits > 0 && isSubscription) {
        await addCredits(userId, credits); // âœ… åªæ·»åŠ ä¸€æ¬¡
        creditsAdded = true; // âœ… æ ‡è®°å·²æ·»åŠ 
    }
}
```

**ç»“æœ**ï¼š
- æœ‰ 2 ä¸ª line items
- Credits åªè¢«æ·»åŠ  1 æ¬¡
- æ€»å…± 100 Credits âœ…

---

## ğŸ” **å¦‚ä½•éªŒè¯ä¿®å¤**

### **æ–¹æ³• 1ï¼šæŸ¥çœ‹è´­ä¹°è®°å½•**

è®¿é—®ï¼šhttps://vaultcaddy.com/account.html

å‘ä¸‹æ»šåŠ¨åˆ°"è³¼è²·è¨˜éŒ„"ï¼š
- âœ… åº”è¯¥åªæœ‰ **1 æ¡** æ–°è®°å½•
- âœ… æ˜¾ç¤º `+100` Credits

---

### **æ–¹æ³• 2ï¼šæŸ¥çœ‹ Firestore**

1. æ‰“å¼€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. ç‚¹å‡» `users` â†’ [æ‚¨çš„ç”¨æˆ·]

3. **æ£€æŸ¥å­—æ®µ**ï¼š
   - `credits`: åº”è¯¥æ˜¯ `100`
   - `currentCredits`: åº”è¯¥æ˜¯ `100`
   - `planType`: åº”è¯¥æ˜¯ `"Pro Plan"`
   - `resetDate`: åº”è¯¥æ˜¯ 1 ä¸ªæœˆå

---

### **æ–¹æ³• 3ï¼šæŸ¥çœ‹ Firebase Functions æ—¥å¿—**

1. æ‰“å¼€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions

2. ç‚¹å‡» `stripeWebhook` å‡½æ•° â†’ "æ—¥å¿—"æ ‡ç­¾

3. **åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—**ï¼š
   ```
   ğŸ“¦ LineItems æ•¸é‡: 2
   ğŸ” æ­£åœ¨ç²å–ç”¢å“: prod_xxxxx
   ğŸ” æ˜¯å¦è®¢é˜…ç±»å‹: true
   ğŸ’° æº–å‚™æ·»åŠ  100 Credits
   âœ… æˆåŠŸæ·»åŠ  100 Credits
   
   ğŸ” æ­£åœ¨ç²å–ç”¢å“: prod_yyyyyï¼ˆç¬¬2ä¸ª line itemï¼‰
   ğŸ” æ˜¯å¦è®¢é˜…ç±»å‹: falseï¼ˆæˆ– trueï¼‰
   âš ï¸ Credits å·²æ·»åŠ ï¼Œè·³è¿‡æ­¤ line item
   ```

---

## ğŸ’¡ **ä¸ºä»€ä¹ˆä¼šæœ‰å¤šä¸ª Line Itemsï¼Ÿ**

Stripe è®¢é˜…å¯èƒ½åŒ…å«å¤šä¸ª line itemsï¼š

1. **ä¸»è¦è®¢é˜…äº§å“**
   - Type: `recurring`
   - åº”è¯¥æ·»åŠ  Credits âœ…

2. **è®¾ç½®è´¹ç”¨**
   - Type: `one_time`
   - ä¸åº”è¯¥æ·»åŠ  Credits âŒ

3. **è¯•ç”¨è½¬æ¢**
   - Stripe ä¼šåˆ›å»º 2 ä¸ª line items æ¥è¡¨ç¤ºè¯•ç”¨è½¬ä¸ºä»˜è´¹
   - åªåº”è¯¥æ·»åŠ  1 æ¬¡ Credits âœ…

4. **æŠ˜æ‰£æˆ–ä¼˜æƒ åˆ¸**
   - å¯èƒ½åˆ›å»ºé¢å¤–çš„ line items
   - ä¸åº”è¯¥æ·»åŠ  Credits âŒ

---

## ğŸ¯ **æ€»ç»“**

**é—®é¢˜**ï¼š
- Checkout session æœ‰å¤šä¸ª line items
- æ¯ä¸ª line item éƒ½æ·»åŠ äº† Credits
- å¯¼è‡´é‡å¤æ·»åŠ 

**ä¿®å¤**ï¼š
- æ·»åŠ  `creditsAdded` æ ‡å¿—
- åªå¤„ç†è®¢é˜…ç±»å‹çš„äº§å“
- ç¡®ä¿ Credits åªè¢«æ·»åŠ ä¸€æ¬¡

**ç»“æœ**ï¼š
- Credits æ­£ç¡®æ·»åŠ  100ï¼ˆè€Œä¸æ˜¯ 200ï¼‰
- è´­ä¹°è®°å½•åªæœ‰ 1 æ¡
- è®¢é˜…ä¿¡æ¯æ­£ç¡®æ›´æ–°

---

## ğŸ“‹ **ä¸‹ä¸€æ­¥**

1. âœ… æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆåˆ é™¤ processedStripeEventsï¼Œå°† Credits è®¾ä¸º 0ï¼‰
2. âœ… é‡æ–°æµ‹è¯•æ”¯ä»˜
3. âœ… éªŒè¯ Credits æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ 100ï¼‰
4. âœ… éªŒè¯ Pro Plan å’Œ resetDate æ˜¯å¦æ­£ç¡®

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š
- è´­ä¹°è®°å½•æˆªå›¾
- Firebase Functions æ—¥å¿—æˆªå›¾
- Firestore ç”¨æˆ·æ–‡æ¡£æˆªå›¾

ç¥æµ‹è¯•é¡ºåˆ©ï¼ ğŸ‰

