# 🔍 日志分析步骤

## 📋 已发现的日志信息

从 Google Cloud Logs Explorer 中看到：

```
时间：2025-12-15 17:36:51.078
事件：customer.subscription.deleted
订阅 ID：sub_1SeXwdJmiQ31C0GTEBxxdwNn
用户 ID：3bLhZuU9HOb3ExhwFCJuN4vZeGb2
邮箱：1234@gmail.com
```

**已确认：**
✅ Webhook 事件已触发
✅ 找到了用户
✅ 检测到超额使用：-51 Credits
✅ 超额数量：51 Credits

---

## ❓ 关键问题：日志被截断

日志显示到：
```
"檢查訂閱信息: {"
```

然后就被截断了。我们需要看完整的日志，特别是：

1. **meteredItemId 是否存在？**
   ```javascript
   hasSubscription: true/false?
   meteredItemId: "si_TbITgirZHFvrkY"?
   stripeSubscriptionId: "sub_1SeXwdJmiQ31C0GTEBs..."?
   ```

2. **是否成功向 Stripe 报告？**
   ```javascript
   "✅ 總使用量已報告給 Stripe: mbur_xxxxx"
   或
   "❌ 報告超額使用失敗: ..."
   ```

3. **有没有错误信息？**

---

## 🎯 下一步操作

### 步骤 1：展开完整日志

在 Google Cloud Logs Explorer 中：

```bash
1. 找到这条日志：
   2025-12-15 17:36:51.078 - stripeWebhook

2. 点击左侧的展开箭头「▶」（如果有）

3. 或者点击日志条目，查看完整内容

4. 滚动到底部，看完整的日志输出

5. 截图所有日志内容
```

### 步骤 2：搜索关键字

在日志详情中搜索：

```bash
关键字 1：meteredItemId
→ 应该显示："si_TbITgirZHFvrkY" 或 "si_TbLIJUhaHlTPhB"

关键字 2：報告給 Stripe
→ 应该显示："✅ 總使用量已報告給 Stripe"

关键字 3：失敗 或 錯誤
→ 看看有没有错误信息
```

---

## 📊 预期的完整日志

如果一切正常，应该看到：

```
✅ 收到測試模式webhook事件: customer.subscription.deleted, ID: evt_1SeYCzJmiQ31C0GTPaWhcs81
✅ 訂閱已取消: sub_1SeXwdJmiQ31C0GTEBxxdwNn
✅ 查詢通過 Stripe Customer 查找用戶: cus_TbITMVDgDLqLrR
✅ Customer email: 1234@gmail.com
✅ 通過 customer email 找到用戶: 3bLhZuU9HOb3ExhwFCJuN4vZeGb2
✅ 使用測試模訂閱取消: 3bLhZuU9HOb3ExhwFCJuN4vZeGb2
✅ 訂閱取消時的用戶數據: { credits: -51, totalCreditsUsed: 151, planType: 'Pro Plan' }
✅ 檢測到超額使用: -51 Credits
✅ 超額數量: 51 Credits
✅ 檢查訂閱信息: {
    hasSubscription: true,
    meteredItemId: "si_TbITgirZHFvrkY",
    stripeSubscriptionId: "sub_1SeXwdJmiQ31C0GTEBxxdwNn",
    monthlyCredits: 100,
    overageAmount: 51
}
✅ 📡 向 Stripe 報告總使用量...
✅ - Subscription ID: sub_1SeXwdJmiQ31C0GTEBxxdwNn
✅ - Metered Item ID: si_TbITgirZHFvrkY
✅ - 包含的 Credits: 100
✅ - 超額數量: 51
✅ - 總使用量: 151（這是 Stripe 計費的基礎）
✅ 總使用量已報告給 Stripe: mbur_xxxxxxxxxxxxx
✅ 💵 Stripe 會根據梯度定價計算費用:
✅    - 前 100 個 Credits: HK$0（已包含在訂閱中）
✅    - 第 101 到 151 個: HK$0.50/個
✅    - 預期收費: HK$25.50
```

---

## ❌ 如果有错误

可能看到：

```
❌ 檢查訂閱信息: {
    hasSubscription: false,  ← 问题！
    meteredItemId: undefined,
    stripeSubscriptionId: undefined
}
❌ 無法報告超額使用：缺少必要信息
```

或者：

```
❌ 報告超額使用失敗: Subscription item not found
❌ 錯誤詳情: ...
```

---

## 🚀 临时解决方案

如果日志显示无法报告，可以使用手动报告：

### 方法：使用诊断工具

```bash
1. 在浏览器中打开：
   file:///Users/cavlinyeung/ai-bank-parser/overage-diagnostic.html

2. 滚动到「2. 手动报告超额使用」

3. 输入：
   - 邮箱：1234@gmail.com
   - 超额数量：51

4. 点击「📡 手动报告」

5. 查看结果
```

---

**现在请展开日志，截图完整内容！** 📸

