# ✅ 关键修复：+/- 标记不修改数值

**完成时间**: 2026-01-10  
**问题**: +/- 按钮会重新计算，导致余额错误  
**解决方案**: +/- 只是"标记"，不修改实际数值

---

## 🔍 问题分析

### 用户发现的严重问题

**实例：CQW 000012 交易**
```
PDF 原始数据:
- 支出: 25,655.00
- 银行余额: 15,531.71

之前系统显示:
- 支出: 25,655.00
- 余额: 337.95 ← ❌ 错误！（被重新计算了）

问题原因:
切换 +/- 会执行: transaction.amount = -parseFloat(amount)
这会重新计算余额，导致与银行单不一致
```

---

## ✅ 核心修复

### 新的数据模型

**之前 ❌**:
```javascript
// amount 既表示数值，又表示收入/支出
transaction.amount = -25655.00  // 负数 = 支出
transaction.amount = 59417.89   // 正数 = 收入

// 切换会修改数值
transaction.amount = -transaction.amount  // ❌ 改变了原始数据！
```

**之后 ✅**:
```javascript
// 分离：数值 vs 标记
transaction.amount = 25655.00           // 数值（来自银行单）
transaction.balance = 15531.71          // 余额（来自银行单）
transaction.transactionSign = 'expense' // 标记：'income' 或 'expense'

// 切换只改标记，不改数值
transaction.transactionSign = 'income'  // ✅ 只改标记！
// amount 和 balance 保持不变！
```

---

## 🔧 技术实现

### 1. 初始化标记字段

```javascript
// 在显示交易时，初始化 transactionSign 字段
if (tx.transactionSign === undefined) {
    const amountNum = parseFloat(amountStr.replace(/[^0-9.-]+/g, ''));
    tx.transactionSign = amountNum >= 0 ? 'income' : 'expense';
}

// 使用标记决定显示
const isIncome = tx.transactionSign === 'income';
const amountSign = isIncome ? '+' : '-';
const amountColor = isIncome ? '#10b981' : '#ef4444';
```

**说明**:
- 第一次加载时，根据 amount 正负号设置初始标记
- 之后所有操作只修改标记，不修改 amount

---

### 2. 切换标记（不修改数值）

```javascript
function toggleTransactionType(index) {
    const transaction = currentDocument.processedData.transactions[index];
    
    // ✅ 只切换显示标记
    transaction.transactionSign = 
        transaction.transactionSign === 'income' ? 'expense' : 'income';
    
    // ✅ amount 和 balance 完全不变！
    console.log(`金额和余额保持不变: amount=${transaction.amount}, balance=${transaction.balance}`);
    
    // 更新 UI
    displayDocumentContent();
    
    // 标记为有未保存更改
    markAsChanged();
}
```

**重要**:
- ✅ `transaction.amount` 不变
- ✅ `transaction.balance` 不变
- ✅ 只改 `transaction.transactionSign`
- ✅ 银行单中的计算结果完全保留

---

### 3. 更新金额（不影响标记）

```javascript
function updateTransactionAmount(index, value, wasIncome) {
    const transaction = currentDocument.processedData.transactions[index];
    
    // ✅ 只更新金额数值（保留原格式）
    const cleanValue = value.toString().replace(/,/g, '');
    transaction.amount = cleanValue;
    
    // ✅ transactionSign 标记保持不变
    console.log(`transactionSign 标记保持不变: ${transaction.transactionSign}`);
    
    markAsChanged();
}
```

---

## 📊 修复效果对比

### 之前的错误流程 ❌

```
1. 用户点击 + 按钮（想改为收入）
   ↓
2. 执行: transaction.amount = -transaction.amount
   原值: -25655.00
   新值: +25655.00  ← 数值被修改！
   ↓
3. 重新计算余额
   原余额: 15531.71（银行单正确值）
   新余额: 337.95   ← 错误计算结果！
   ↓
4. 保存到 Firebase
   ✗ 原始数据永久丢失
   ✗ 与银行单不一致
```

---

### 现在的正确流程 ✅

```
1. 用户点击 + 按钮（想改为收入）
   ↓
2. 执行: transaction.transactionSign = 'income'
   amount: 25655.00  ← 保持不变！
   balance: 15531.71 ← 保持不变！
   ↓
3. 只更新 UI 显示
   显示: [+] 25,655.00  $15,531.71
   ↓
4. 保存到 Firebase
   ✓ amount 和 balance 原封不动
   ✓ 只保存 transactionSign 标记
   ✓ 与银行单完全一致
```

---

## 🎯 用户需求实现

### 需求理解

用户说明：
> "就算用戶修改了＋轉成－都不會修改數值，因為銀行單中已經計算好，我們只是錯誤地將＋記錄成－。"

**翻译**:
- ✅ 银行单中的数值和计算是正确的
- ✅ AI 可能错误地识别了收入/支出类型
- ✅ 用户需要能修正这个"标记"
- ✅ 但不应该修改银行单中的任何数值

---

## 📁 数据结构变化

### Firebase 存储格式

**之前**:
```json
{
  "transactions": [
    {
      "date": "2021-07-05",
      "description": "CQW 000012",
      "amount": -25655.00,  // 数值 + 标记混在一起
      "balance": 15531.71
    }
  ]
}
```

**之后**:
```json
{
  "transactions": [
    {
      "date": "2021-07-05",
      "description": "CQW 000012",
      "amount": 25655.00,           // 纯数值（来自银行单）
      "balance": 15531.71,          // 纯数值（来自银行单）
      "transactionSign": "expense"  // 标记（可修正）
    }
  ]
}
```

**优点**:
- ✅ 数据和标记分离
- ✅ 银行单数据不可被破坏
- ✅ AI 识别错误可被修正
- ✅ 兼容旧数据（自动迁移）

---

## 🧪 测试验证

### 测试步骤

1. **清除缓存并刷新**
   ```bash
   Cmd/Ctrl + Shift + R
   ```

2. **验证 +/- 按钮显示**
   - [ ] CQW 000012 显示 [-] 25,655.00
   - [ ] 余额显示 15,531.71（不是 337.95）
   - [ ] 其他交易的 +/- 号都显示

3. **测试切换功能**
   - [ ] 点击 CQW 000012 的 [-] 按钮
   - [ ] 变为 [+] 按钮（绿色）
   - [ ] 金额仍然是 25,655.00
   - [ ] 余额仍然是 15,531.71
   - [ ] **重要**: 再次点击切换回 [-]

4. **验证数据不变**
   - [ ] 打开开发者工具（F12）
   - [ ] Console 执行：
   ```javascript
   console.log(currentDocument.processedData.transactions);
   ```
   - [ ] 检查 CQW 000012 的 amount 和 balance
   - [ ] 应该与银行单完全一致

---

## 🔄 旧数据兼容性

### 自动迁移

**第一次加载旧数据时**:
```javascript
if (tx.transactionSign === undefined) {
    // 根据 amount 正负号设置初始标记
    const amountNum = parseFloat(amountStr.replace(/[^0-9.-]+/g, ''));
    tx.transactionSign = amountNum >= 0 ? 'income' : 'expense';
}
```

**迁移逻辑**:
1. 检查是否有 `transactionSign` 字段
2. 如果没有，根据 `amount` 正负号初始化
3. 之后所有操作只修改 `transactionSign`

---

## ⚠️ 关于已损坏的数据

### CQW 000012 案例

**当前状态**:
```
amount: 25655.00
balance: 337.95  ← ❌ 错误（应该是 15531.71）
```

**原因**: 之前点击 +/- 按钮导致重新计算

**解决方案**:

**选项1: 重新上传文档**（推荐）
- ✅ 最简单可靠
- ✅ 恢复所有原始数据
- ✅ AI 重新提取

**选项2: 手动修正**
- 直接编辑 balance 字段
- 改为 15,531.71
- 保存修改
- ❌ 费时费力

**选项3: 等待下次同步**
- 如果有自动同步功能
- 下次更新会覆盖错误数据

---

## ✅ 修复确认

- [x] +/- 按钮改为只修改标记
- [x] toggleTransactionType 不再修改 amount
- [x] updateTransactionAmount 不再修改 transactionSign
- [x] 添加 transactionSign 字段
- [x] 自动迁移旧数据
- [x] 保留所有银行单原始数值
- [x] 创建详细文档和测试指南

---

## 💡 重要提醒

### VaultCaddy 的数据原则

**永远记住**:
- ✅ PDF/图片中的数据是"真相"
- ✅ 我们只是"提取"和"分类"
- ❌ **绝不**进行任何计算
- ❌ **绝不**修改原始数值
- ✅ 只修正 AI 的识别错误（标记、分类等）

---

**请刷新页面验证：**
1. +/- 号是否显示
2. 余额是否正确（15,531.71 不是 337.95）
3. 切换 +/- 后余额是否保持不变

**如果余额还是 337.95，说明数据已损坏，需要重新上传文档！** ⚠️

