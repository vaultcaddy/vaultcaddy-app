<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    
    <!-- ğŸ”’ é é¢ä¿è­· -->
    <style>
        body.auth-checking { visibility: hidden !important; }
        .auth-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; visibility: visible !important; }
        body.auth-ready .auth-loading { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script>
        document.documentElement.classList.add('auth-checking');
        if (document.body) { document.body.classList.add('auth-checking'); } 
        else { document.addEventListener('DOMContentLoaded', function() { document.body.classList.add('auth-checking'); }); }
    </script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æª”è©³æƒ… - VaultCaddy</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="pages.css">
    <link rel="stylesheet" href="editable-table.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <script src="translations.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase é…ç½®å’Œæ•¸æ“šç®¡ç†å™¨ -->
    <script src="firebase-config.js?v=20251106-old-ui"></script>
    <!-- ğŸ”¥ æ–°çš„ç°¡åŒ–ç³»çµ± -->
    <script src="simple-auth.js?v=20251106-old-ui"></script>
    <script src="simple-data-manager.js?v=20251106-old-ui"></script>
    
    <script src="navbar-component.js?v=20251106-old-ui"></script>
    <script src="sidebar-component.js?v=20251106-old-ui"></script>
    
    <!-- åŠŸèƒ½æ¨¡å— -->
    <script src="editable-table.js?v=20251106-old-ui"></script>
    <script src="export-manager.js?v=20251106-old-ui"></script>
    
    <!-- âœ… æå‰å®šç¾© goBackToDashboard å‡½æ•¸ -->
    <script>
        // è¿”å›å„€è¡¨æ¿ï¼ˆæå‰å®šç¾©ï¼Œé¿å… ReferenceErrorï¼‰
        function goBackToDashboard() {
            const params = new URLSearchParams(window.location.search);
            const projectId = params.get('project');
            if (projectId) {
                window.location.href = `firstproject.html?project=${projectId}`;
            } else {
                window.location.href = 'dashboard.html';
            }
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #1f2937;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* ä½¿ç”¨èˆ‡ firstproject.html ç›¸åŒçš„å¸ƒå±€çµæ§‹ */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            background: #ffffff;
            padding-top: 60px; /* ç‚ºå°èˆªæ¬„ç•™å‡ºç©ºé–“ */
        }
        
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            flex-shrink: 0;
            position: fixed;
            top: 60px;
            bottom: 0;
            left: 0;
            overflow-y: auto;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .saved-indicator {
            color: #10b981;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* ä¸»å…§å®¹å€åŸŸ */
        .main-content {
            margin-left: 10pt; /* åªä¿ç•™ 10pt èˆ‡å·¦å´æ¬„çš„é–“è· */
            flex: 1;
            background: #ffffff;
            min-height: calc(100vh - 60px);
        }
        
        /* è©³æƒ…é é¢é ‚éƒ¨ */
        .detail-header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem 1rem 10pt; /* å·¦é‚Šè·æ”¹ç‚º 10pt */
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 60px;
            z-index: 10;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
            cursor: pointer;
        }
        
        .back-btn:hover {
            color: #1f2937;
        }
        
        .document-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .top-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* è©³æƒ…å…§å®¹å®¹å™¨ */
        .detail-container {
            display: grid;
            grid-template-columns: 550px 1fr;
            gap: 0; /* ç§»é™¤ä¸­é–“ç©ºç™½ */
            height: calc(100vh - 120px);
        }
        
        /* å·¦å´ PDF é è¦½å€ */
        .pdf-preview-panel {
            background: #f9fafb;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .pdf-controls {
            padding: 1rem 1rem 1rem 10pt; /* å·¦å´ padding æ”¹ç‚º 10pt */
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .page-nav-btn {
            background: #ffffff;
            color: #1f2937;
            border: 1px solid #d1d5db;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .page-nav-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .page-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .page-indicator {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .pdf-zoom-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .pdf-viewer {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1rem 1rem 10pt; /* å·¦å´ padding æ”¹ç‚º 10pt */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .pdf-page {
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            max-width: 100%;
        }
        
        .pdf-page img {
            width: 100%;
            display: block;
            border-radius: 4px;
        }
        
        /* å³å´æ•¸æ“šé¢æ¿ */
        .data-panel {
            background: #ffffff;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab:hover {
            color: #1f2937;
        }
        
        /* æ ¸å°ç‹€æ…‹å¡ç‰‡ */
        .reconciliation-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .reconciliation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .reconciliation-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .progress-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .reconciliation-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        /* éŠ€è¡Œå°å¸³å–®è©³æƒ… */
        .bank-details-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .expand-icon {
            color: #6b7280;
            transition: transform 0.2s;
        }
        
        .card-header:hover .expand-icon {
            color: #1f2937;
        }
        
        /* äº¤æ˜“è¡¨æ ¼ */
        .transactions-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .transactions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        
        .transactions-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .transaction-controls {
            display: flex;
            gap: 0.75rem;
        }
        
        .control-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: #e5e7eb;
        }
        
        .control-btn.add {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }
        
        .control-btn.add:hover {
            background: #6d28d9;
        }
        
        .transactions-info {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .transactions-table thead {
            background: #f9fafb;
        }
        
        .transactions-table th {
            padding: 0.75rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .transactions-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background 0.2s;
        }
        
        .transactions-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .transactions-table td {
            padding: 0.75rem;
            font-size: 0.9rem;
            color: #1f2937;
        }
        
        .checkbox-cell {
            width: 40px;
        }
        
        .checkbox-cell input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .amount-cell {
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }
        
        .amount-positive {
            color: #10b981;
        }
        
        .amount-negative {
            color: #ef4444;
        }
        
        .action-cell {
            width: 100px;
        }
        
        .action-btns {
            display: flex;
            gap: 0.5rem;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }
        
        .icon-btn:hover {
            color: #1f2937;
        }
        
        .icon-btn.delete:hover {
            color: #ef4444;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="auth-checking">
    <!-- ğŸ”’ Auth åŠ è¼‰å‹•ç•« -->
    <div class="auth-loading">
        <div style="text-align: center;">
            <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <p style="color: #6b7280; font-size: 0.875rem;">æ­£åœ¨é©—è­‰èº«ä»½...</p>
        </div>
    </div>
    
    <!-- é ‚éƒ¨å°èˆªæ¬„ï¼ˆç”± navbar-component.js å‹•æ…‹ç”Ÿæˆï¼‰ -->
    <div id="navbar-root" style="display: block !important; visibility: visible !important; opacity: 1 !important;"></div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="dashboard-container">
        <!-- å·¦å´é‚Šæ¬„ï¼ˆç”± sidebar-component.js å‹•æ…‹ç”Ÿæˆï¼‰ -->
        <div id="sidebar-root" style="display: block !important; visibility: visible !important; opacity: 1 !important;"></div>
        
        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <div class="main-content">
            <!-- è©³æƒ…é é¢é ‚éƒ¨ -->
            <div class="detail-header">
                <span class="back-btn" onclick="goBackToDashboard()">
                    <i class="fas fa-arrow-left"></i>
                    Back to dashboard
                </span>
                <h1 class="document-title" id="documentTitle">è¼‰å…¥ä¸­...</h1>
                <div class="top-actions">
                    <span class="saved-indicator">
                        <i class="fas fa-cloud-check"></i>
                        Saved
                    </span>
                    <!-- å¯¼å‡ºæŒ‰é’® -->
                    <div class="export-dropdown" style="position: relative;">
                        <button class="btn btn-primary" onclick="toggleExportMenu(event)">
                            <i class="fas fa-download"></i>
                            Export
                            <i class="fas fa-chevron-down" style="margin-left: 0.5rem; font-size: 0.75rem;"></i>
                        </button>
                        <div class="export-menu" id="exportMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 200px; margin-top: 0.5rem; z-index: 1000;">
                            <div class="export-menu-item" onclick="exportDocument('csv')" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                <i class="fas fa-file-csv" style="color: #10b981; width: 20px;"></i>
                                <span>CSV</span>
                            </div>
                            <div class="export-menu-item" onclick="exportDocument('iif')" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                <i class="fas fa-file-invoice" style="color: #3b82f6; width: 20px;"></i>
                                <span>IIF (QuickBooks)</span>
                            </div>
                            <div class="export-menu-item" onclick="exportDocument('qbo')" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                <i class="fas fa-file-invoice-dollar" style="color: #8b5cf6; width: 20px;"></i>
                                <span>QBO (QuickBooks)</span>
                            </div>
                            <div class="export-menu-item" onclick="exportDocument('json')" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; transition: background 0.2s; border-top: 1px solid #e5e7eb;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                <i class="fas fa-file-code" style="color: #f59e0b; width: 20px;"></i>
                                <span>JSON</span>
                            </div>
                        </div>
                    </div>
                    <button class="icon-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            
            <!-- è©³æƒ…å…§å®¹å®¹å™¨ -->
            <div class="detail-container">
        <!-- å·¦å´ PDF é è¦½ -->
        <div class="pdf-preview-panel">
            <div class="pdf-controls">
                <button class="page-nav-btn" id="prevPageBtn" onclick="previousPage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="page-indicator">
                    <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </span>
                <button class="page-nav-btn" id="nextPageBtn" onclick="nextPage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <div class="pdf-zoom-controls">
                    <button class="page-nav-btn" onclick="zoomOut()">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="page-nav-btn" onclick="resetZoom()">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="page-nav-btn" onclick="zoomIn()">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="pdf-viewer" id="pdfViewer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>è¼‰å…¥æ–‡æª”ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- å³å´æ•¸æ“šé¢æ¿ -->
        <div class="data-panel">
            <div class="tabs">
                <button class="tab active">Results</button>
                <button class="tab">Export</button>
                <button class="tab">JSON</button>
            </div>
            
            <!-- æ–‡æª”è©³æƒ…ï¼ˆæ ¹æ“šé¡å‹å‹•æ…‹é¡¯ç¤ºï¼‰ -->
            <div id="documentDetailsSection">
                <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <!-- æ•¸æ“šè¡¨æ ¼ï¼ˆæ ¹æ“šé¡å‹å‹•æ…‹é¡¯ç¤ºï¼‰ -->
            <div id="documentDataSection">
                <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <!-- åŸæœ‰çš„éŠ€è¡Œå°å¸³å–®äº¤æ˜“è¨˜éŒ„è¡¨æ ¼ï¼ˆä¿ç•™ä½œç‚ºå‚™ç”¨ï¼‰ -->
            <div id="bankStatementSection" style="display: none;">
                <div class="bank-details-card">
                    <div class="card-header">
                        <h3 class="card-title">Bank Statement Details & Notes</h3>
                        <i class="fas fa-chevron-down expand-icon"></i>
                    </div>
                </div>
                
                <div class="transactions-section">
                    <div class="transactions-header">
                        <h3 class="transactions-title">Transactions</h3>
                        <div class="transaction-controls">
                            <button class="control-btn">Show Unreconciled</button>
                            <button class="control-btn">Toggle All</button>
                            <button class="control-btn add">Add Item</button>
                        </div>
                    </div>
                    
                    <div class="transactions-info" id="transactionsInfo">
                        Showing 0 to 0 of 0 transactions
                    </div>
                    
                    <table class="transactions-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" onchange="toggleAllTransactions(this)">
                            </th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th class="action-cell">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #94a3b8;">
                                è¼‰å…¥äº¤æ˜“è¨˜éŒ„ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        console.log('ğŸ“„ document-detail.html é–‹å§‹è¼‰å…¥');
        
        // ğŸ”§ èª¿è©¦æ¨¡å¼
        const DEBUG_MODE = false;  // ç”Ÿç”¢æ¨¡å¼ï¼Œè¨­ç½®ç‚º false
        
        // å…¨å±€è®Šé‡
        let currentDocument = null;
        let currentProjectId = null;
        let currentDocumentId = null;
        let currentPageNumber = 1;
        let totalPagesCount = 1;
        let zoomLevel = 100;
        
        // å¾ URL ç²å–åƒæ•¸
        function getDocumentIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        
        function getProjectIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('project');
        }
        
        // è¼‰å…¥æ–‡æª”
        async function loadDocument() {
            console.log('ğŸ“‚ é–‹å§‹è¼‰å…¥æ–‡æª”...');
            
            const documentId = getDocumentIdFromURL();
            const projectId = getProjectIdFromURL();
            
            console.log('ğŸ“‹ URL åƒæ•¸:');
            console.log('   documentId:', documentId);
            console.log('   projectId:', projectId);
            
            if (!documentId || !projectId) {
                console.error('âŒ ç¼ºå°‘å¿…è¦åƒæ•¸');
                alert('ç¼ºå°‘å¿…è¦åƒæ•¸ (documentId æˆ– projectId)');
                goBackToDashboard();
                return;
            }
            
            currentDocumentId = documentId;
            currentProjectId = projectId;
            
            try {
                // ç­‰å¾… SimpleDataManager åˆå§‹åŒ–
                let attempts = 0;
                while (!window.simpleDataManager || !window.simpleDataManager.initialized) {
                    if (attempts++ > 50) {
                        throw new Error('SimpleDataManager åˆå§‹åŒ–è¶…æ™‚');
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('âœ… SimpleDataManager å·²å°±ç·’');
                
                // å¾ Firebase ç²å–æ–‡æª”
                console.log('ğŸ“¥ å¾ Firebase ç²å–æ–‡æª”...');
                const foundDocument = await window.simpleDataManager.getDocument(projectId, documentId);
                
                if (!foundDocument) {
                    alert('æ‰¾ä¸åˆ°æ–‡æª”');
                    goBackToDashboard();
                    return;
                }
                
                console.log('âœ… æ–‡æª”è¼‰å…¥æˆåŠŸ:', foundDocument);
                currentDocument = foundDocument;
                
                // æ›´æ–°é é¢æ¨™é¡Œ
                const titleElement = document.getElementById('documentTitle');
                if (titleElement) {
                    titleElement.textContent = foundDocument.name || foundDocument.fileName || 'æœªå‘½åæ–‡æª”';
                }
                
                // é¡¯ç¤ºæ•¸æ“š
                displayDocumentData(foundDocument);
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥æ–‡æª”å¤±æ•—:', error);
                alert('è¼‰å…¥æ–‡æª”å¤±æ•—: ' + error.message);
            }
        }
        
        // é¡¯ç¤ºæ–‡æª”æ•¸æ“š
        function displayDocumentData(doc) {
            console.log('ğŸ¨ é–‹å§‹é¡¯ç¤ºæ–‡æª”æ•¸æ“š...');
            
            const processedData = doc.processedData || {};
            const docType = doc.type || 'unknown';
            
            console.log('   æ–‡æª”é¡å‹:', docType);
            console.log('   è™•ç†æ•¸æ“š:', processedData);
            
            // æ ¹æ“šæ–‡æª”é¡å‹é¡¯ç¤ºä¸åŒçš„å…§å®¹
            if (docType === 'ç™¼ç¥¨' || processedData.invoice_number) {
                displayInvoiceData(processedData);
            } else if (docType === 'éŠ€è¡Œå°å¸³å–®' || processedData.transactions) {
                displayBankStatementData(processedData);
            } else if (docType === 'æ”¶æ“š' || processedData.receipt_number) {
                displayReceiptData(processedData);
            } else {
                // é€šç”¨é¡¯ç¤º
                displayGenericData(processedData);
            }
            
            console.log('âœ… æ–‡æª”æ•¸æ“šé¡¯ç¤ºå®Œæˆ');
        }
        
        // é¡¯ç¤ºç™¼ç¥¨æ•¸æ“š
        function displayInvoiceData(data) {
            const detailsSection = document.getElementById('documentDetailsSection');
            const dataSection = document.getElementById('documentDataSection');
            
            if (!detailsSection || !dataSection) return;
            
            // è©³æƒ…å¡ç‰‡
            detailsSection.innerHTML = `
                <div style="padding: 1.5rem; background: white; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">ç™¼ç¥¨è©³æƒ…</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">ç™¼ç¥¨è™Ÿç¢¼</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.invoice_number || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">æ—¥æœŸ</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.date || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">ä¾›æ‡‰å•†</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.supplier || data.vendor || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">ç¸½é‡‘é¡</div>
                            <div style="font-weight: 600; color: #059669; font-size: 1.1rem;">$${parseFloat(data.total || 0).toLocaleString('zh-TW', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // é …ç›®åˆ—è¡¨
            const items = data.items || [];
            if (items.length > 0) {
                let itemsHTML = '<div style="padding: 1.5rem;"><h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">é …ç›®æ˜ç´°</h3><table style="width: 100%; border-collapse: collapse;"><thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 600; color: #6b7280;">æè¿°</th><th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #6b7280;">æ•¸é‡</th><th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #6b7280;">å–®åƒ¹</th><th style="padding: 0.75rem; text-align: right; font-size: 0.875rem; font-weight: 600; color: #6b7280;">é‡‘é¡</th></tr></thead><tbody>';
                
                items.forEach(item => {
                    itemsHTML += `<tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 0.75rem; color: #1f2937;">${item.description || '-'}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #1f2937;">${item.quantity || '-'}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #1f2937;">$${parseFloat(item.unit_price || 0).toLocaleString('zh-TW', { minimumFractionDigits: 2 })}</td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 500; color: #1f2937;">$${parseFloat(item.amount || 0).toLocaleString('zh-TW', { minimumFractionDigits: 2 })}</td>
                    </tr>`;
                });
                
                itemsHTML += '</tbody></table></div>';
                dataSection.innerHTML = itemsHTML;
            }
        }
        
        // é¡¯ç¤ºéŠ€è¡Œå°å¸³å–®æ•¸æ“š
        function displayBankStatementData(data) {
            const detailsSection = document.getElementById('documentDetailsSection');
            const dataSection = document.getElementById('documentDataSection');
            
            if (!detailsSection || !dataSection) return;
            
            // è©³æƒ…å¡ç‰‡
            detailsSection.innerHTML = `
                <div style="padding: 1.5rem; background: white; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">éŠ€è¡Œå°å¸³å–®è©³æƒ…</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">éŠ€è¡Œåç¨±</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.bank_name || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">å¸³æˆ¶è™Ÿç¢¼</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.account_number || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">æœŸé–“</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.statement_period || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">æœŸæœ«é¤˜é¡</div>
                            <div style="font-weight: 600; color: #059669; font-size: 1.1rem;">$${parseFloat(data.closing_balance || 0).toLocaleString('zh-TW', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // äº¤æ˜“åˆ—è¡¨
            const transactions = data.transactions || [];
            if (transactions.length > 0) {
                // æ›´æ–°èˆŠçš„äº¤æ˜“è¡¨æ ¼
                const tbody = document.getElementById('transactionsBody');
                if (tbody) {
                    tbody.innerHTML = '';
                    transactions.forEach(tx => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 0.75rem; text-align: center;">
                                <input type="checkbox" onchange="updateReconciliation(this)">
                            </td>
                            <td style="padding: 0.75rem; color: #1f2937;">${tx.date || '-'}</td>
                            <td style="padding: 0.75rem; color: #1f2937;">${tx.description || '-'}</td>
                            <td style="padding: 0.75rem; text-align: right; font-weight: 500; color: ${parseFloat(tx.amount || 0) < 0 ? '#dc2626' : '#059669'};">$${parseFloat(tx.amount || 0).toLocaleString('zh-TW', { minimumFractionDigits: 2 })}</td>
                            <td style="padding: 0.75rem; text-align: right; color: #1f2937;">$${parseFloat(tx.balance || 0).toLocaleString('zh-TW', { minimumFractionDigits: 2 })}</td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <button onclick="editTransaction(this)" style="background: none; border: none; color: #3b82f6; cursor: pointer;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // é¡¯ç¤ºéŠ€è¡Œå°å¸³å–®å€åŸŸ
                    const bankSection = document.getElementById('bankStatementSection');
                    if (bankSection) {
                        bankSection.style.display = 'block';
                    }
                    
                    // æ›´æ–°äº¤æ˜“ä¿¡æ¯
                    const transactionsInfo = document.getElementById('transactionsInfo');
                    if (transactionsInfo) {
                        transactionsInfo.textContent = `Showing 1 to ${transactions.length} of ${transactions.length} transactions`;
                    }
                }
            }
        }
        
        // é¡¯ç¤ºæ”¶æ“šæ•¸æ“š
        function displayReceiptData(data) {
            const detailsSection = document.getElementById('documentDetailsSection');
            
            if (!detailsSection) return;
            
            detailsSection.innerHTML = `
                <div style="padding: 1.5rem; background: white; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">æ”¶æ“šè©³æƒ…</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">æ”¶æ“šè™Ÿç¢¼</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.receipt_number || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">æ—¥æœŸ</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.date || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">å•†å®¶</div>
                            <div style="font-weight: 500; color: #1f2937;">${data.merchant || data.vendor || '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">ç¸½é‡‘é¡</div>
                            <div style="font-weight: 600; color: #059669; font-size: 1.1rem;">$${parseFloat(data.total || 0).toLocaleString('zh-TW', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // é¡¯ç¤ºé€šç”¨æ•¸æ“š
        function displayGenericData(data) {
            const detailsSection = document.getElementById('documentDetailsSection');
            
            if (!detailsSection) return;
            
            let html = '<div style="padding: 1.5rem; background: white;"><h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">æå–çš„æ•¸æ“š</h3><div style="background: #f9fafb; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.875rem; overflow-x: auto;"><pre>' + JSON.stringify(data, null, 2) + '</pre></div></div>';
            
            detailsSection.innerHTML = html;
        }
        
        // PDF æ§åˆ¶å‡½æ•¸ï¼ˆä¿ç•™èˆŠåŠŸèƒ½ï¼‰
        function nextPage() {
            if (currentPageNumber < totalPagesCount) {
                currentPageNumber++;
                updatePageDisplay();
            }
        }
        
        function previousPage() {
            if (currentPageNumber > 1) {
                currentPageNumber--;
                updatePageDisplay();
            }
        }
        
        function zoomIn() {
            zoomLevel += 10;
            updateZoom();
        }
        
        function zoomOut() {
            if (zoomLevel > 50) {
                zoomLevel -= 10;
                updateZoom();
            }
        }
        
        function resetZoom() {
            zoomLevel = 100;
            updateZoom();
        }
        
        function updatePageDisplay() {
            const pageNumElement = document.getElementById('currentPageNum');
            if (pageNumElement) {
                pageNumElement.textContent = currentPageNumber;
            }
        }
        
        function updateZoom() {
            const pdfViewer = document.getElementById('pdfViewer');
            if (pdfViewer) {
                pdfViewer.style.transform = `scale(${zoomLevel / 100})`;
            }
        }
        
        // äº¤æ˜“ç›¸é—œå‡½æ•¸
        function toggleAllTransactions(checkbox) {
            const checkboxes = document.querySelectorAll('#transactionsBody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }
        
        function updateReconciliation(checkbox) {
            console.log('æ›´æ–°å°å¸³ç‹€æ…‹:', checkbox.checked);
        }
        
        function editTransaction(button) {
            console.log('ç·¨è¼¯äº¤æ˜“');
        }
        
        // å°å‡ºåŠŸèƒ½
        function toggleExportMenu(event) {
            event.stopPropagation();
            console.log('åˆ‡æ›å°å‡ºèœå–®');
        }
        
        async function exportDocument(format) {
            if (!currentDocument) {
                alert('æ²’æœ‰å¯å°å‡ºçš„æ–‡æª”');
                return;
            }
            
            console.log('å°å‡ºæ–‡æª”ï¼Œæ ¼å¼:', format);
            // é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„å°å‡ºé‚è¼¯
        }
        
        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–...');
            console.log('ğŸ”§ èª¿è©¦æ¨¡å¼:', DEBUG_MODE ? 'é–‹å•Ÿ' : 'é—œé–‰');
            
            // ç­‰å¾… SimpleAuth åˆå§‹åŒ–
            console.log('â³ æ­¥é©Ÿ 1/3: ç­‰å¾… SimpleAuth åˆå§‹åŒ–...');
            let attempts = 0;
            while (!window.simpleAuth || !window.simpleAuth.initialized) {
                if (attempts++ > 50) {
                    console.error('âŒ èº«ä»½é©—è­‰åˆå§‹åŒ–è¶…æ™‚');
                    if (!DEBUG_MODE) {
                        window.location.href = 'index.html';
                    }
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.log('âœ… SimpleAuth å·²å°±ç·’');
            console.log('   - currentUser:', window.simpleAuth.currentUser);
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            console.log('â³ æ­¥é©Ÿ 2/3: æª¢æŸ¥ç™»å…¥ç‹€æ…‹...');
            
            if (!window.simpleAuth.currentUser) {
                console.log('âŒ ç”¨æˆ¶æœªç™»å…¥');
                if (DEBUG_MODE) {
                    console.log('ğŸ”§ èª¿è©¦æ¨¡å¼ï¼šé˜»æ­¢è·³è½‰');
                    alert('ç”¨æˆ¶æœªç™»å…¥ - èª¿è©¦æ¨¡å¼');
                    return;
                }
                window.location.href = 'index.html';
                return;
            }
            
            console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥:', window.simpleAuth.currentUser.email);
            
            // è¼‰å…¥æ–‡æª”
            console.log('â³ æ­¥é©Ÿ 3/3: è¼‰å…¥æ–‡æª”æ•¸æ“š...');
            await loadDocument();
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
