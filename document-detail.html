<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æª”è©³æƒ… - VaultCaddy</title>
    
    <!-- æ¨£å¼ -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase é…ç½®å’Œç®¡ç†å™¨ -->
    <script defer src="firebase-config.js?v=20251106-rebuild"></script>
    <script defer src="simple-auth.js?v=20251106-rebuild"></script>
    <script defer src="simple-data-manager.js?v=20251106-rebuild"></script>
    
    <!-- UI çµ„ä»¶ -->
    <script defer src="navbar-component.js?v=20251106-rebuild"></script>
    <script defer src="sidebar-component.js?v=20251106-rebuild"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            margin: 0;
            padding: 0;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            padding-top: 60px;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }
        
        .document-header {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .document-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
            color: #1f2937;
        }
        
        .document-meta {
            display: flex;
            gap: 2rem;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .document-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-section {
            margin-bottom: 2rem;
        }
        
        .data-section h2 {
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .data-item {
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
        }
        
        .data-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .data-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .transactions-table th,
        .transactions-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .transactions-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .transactions-table td {
            color: #1f2937;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            transition: background 0.2s;
        }
        
        .back-button:hover {
            background: #4b5563;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- å°èˆªæ¬„ -->
    <div id="navbar-root"></div>
    
    <!-- å´é‚Šæ¬„ -->
    <div id="sidebar-root"></div>
    
    <!-- ä¸»å…§å®¹ -->
    <div class="dashboard-container">
        <div class="main-content">
            <div id="loadingMessage" class="loading">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #8b5cf6;"></i>
                <p style="margin-top: 1rem;">è¼‰å…¥ä¸­...</p>
            </div>
            
            <div id="errorMessage" class="error" style="display: none;"></div>
            
            <div id="documentContainer" style="display: none;">
                <!-- è¿”å›æŒ‰éˆ• -->
                <a href="#" id="backButton" class="back-button" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-arrow-left"></i>
                    è¿”å›é …ç›®
                </a>
                
                <!-- æ–‡æª”æ¨™é¡Œ -->
                <div class="document-header">
                    <h1 id="documentTitle">æ–‡æª”åç¨±</h1>
                    <div class="document-meta">
                        <span><i class="far fa-calendar"></i> <span id="documentDate">-</span></span>
                        <span><i class="far fa-file"></i> <span id="documentType">-</span></span>
                        <span><i class="fas fa-tag"></i> <span id="documentStatus">-</span></span>
                    </div>
                </div>
                
                <!-- æ–‡æª”å…§å®¹ -->
                <div class="document-content">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="data-section" id="basicInfoSection">
                        <h2>åŸºæœ¬ä¿¡æ¯</h2>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">ä¾›æ‡‰å•†/ä¾†æº</div>
                                <div class="data-value" id="vendor">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">é‡‘é¡</div>
                                <div class="data-value" id="amount">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">å¸³å–®æ—¥æœŸ</div>
                                <div class="data-value" id="billDate">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">ä¸Šå‚³æ—¥æœŸ</div>
                                <div class="data-value" id="uploadDate">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- äº¤æ˜“æ˜ç´° -->
                    <div class="data-section" id="transactionsSection" style="display: none;">
                        <h2>äº¤æ˜“æ˜ç´°</h2>
                        <table class="transactions-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æè¿°</th>
                                    <th>é‡‘é¡</th>
                                    <th>é¤˜é¡</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åŸå§‹æ•¸æ“š -->
                    <div class="data-section" id="rawDataSection" style="display: none;">
                        <h2>åŸå§‹æ•¸æ“š</h2>
                        <pre id="rawData" style="background: #f9fafb; padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.85rem;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        console.log('ğŸ“„ document-detail.html é–‹å§‹è¼‰å…¥');
        
        // å…¨å±€è®Šé‡
        let currentDocument = null;
        let currentProjectId = null;
        let currentDocumentId = null;
        
        // å¾ URL ç²å–åƒæ•¸
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            currentProjectId = params.get('project');
            currentDocumentId = params.get('id');
            
            console.log('ğŸ“‹ URL åƒæ•¸:');
            console.log('   projectId:', currentProjectId);
            console.log('   documentId:', currentDocumentId);
            
            return { projectId: currentProjectId, documentId: currentDocumentId };
        }
        
        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            console.error('âŒ', message);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }
        
        // è¼‰å…¥æ–‡æª”
        async function loadDocument() {
            console.log('ğŸ“‚ é–‹å§‹è¼‰å…¥æ–‡æª”...');
            
            const { projectId, documentId } = getUrlParams();
            
            if (!projectId || !documentId) {
                showError('ç¼ºå°‘å¿…è¦åƒæ•¸ (projectId æˆ– documentId)');
                return;
            }
            
            try {
                // ç­‰å¾… SimpleDataManager åˆå§‹åŒ–
                let attempts = 0;
                while (!window.simpleDataManager || !window.simpleDataManager.initialized) {
                    if (attempts++ > 50) {
                        throw new Error('SimpleDataManager åˆå§‹åŒ–è¶…æ™‚');
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('âœ… SimpleDataManager å·²å°±ç·’');
                
                // å¾ Firebase ç²å–æ–‡æª”
                console.log('ğŸ“¥ å¾ Firebase ç²å–æ–‡æª”...');
                const document = await window.simpleDataManager.getDocument(projectId, documentId);
                
                if (!document) {
                    showError('æ‰¾ä¸åˆ°æ–‡æª”');
                    return;
                }
                
                console.log('âœ… æ–‡æª”è¼‰å…¥æˆåŠŸ:', document);
                currentDocument = document;
                
                // é¡¯ç¤ºæ–‡æª”
                displayDocument(document);
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥æ–‡æª”å¤±æ•—:', error);
                showError('è¼‰å…¥æ–‡æª”å¤±æ•—: ' + error.message);
            }
        }
        
        // é¡¯ç¤ºæ–‡æª”
        function displayDocument(doc) {
            console.log('ğŸ¨ é–‹å§‹é¡¯ç¤ºæ–‡æª”...');
            
            // éš±è—è¼‰å…¥æ¶ˆæ¯
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('documentContainer').style.display = 'block';
            
            // è¨­ç½®è¿”å›æŒ‰éˆ•
            document.getElementById('backButton').href = `firstproject.html?project=${currentProjectId}`;
            
            // é¡¯ç¤ºåŸºæœ¬ä¿¡æ¯
            document.getElementById('documentTitle').textContent = doc.name || doc.fileName || 'æœªå‘½åæ–‡æª”';
            document.getElementById('documentType').textContent = doc.type || 'æœªçŸ¥é¡å‹';
            document.getElementById('documentStatus').textContent = doc.status === 'completed' ? 'å·²å®Œæˆ' : 'è™•ç†ä¸­';
            
            // é¡¯ç¤ºæ—¥æœŸ
            if (doc.createdAt) {
                let dateStr = '-';
                if (typeof doc.createdAt === 'object' && doc.createdAt.seconds) {
                    dateStr = new Date(doc.createdAt.seconds * 1000).toLocaleDateString('zh-TW');
                } else if (typeof doc.createdAt === 'string' || typeof doc.createdAt === 'number') {
                    dateStr = new Date(doc.createdAt).toLocaleDateString('zh-TW');
                }
                document.getElementById('documentDate').textContent = dateStr;
                document.getElementById('uploadDate').textContent = dateStr;
            }
            
            // é¡¯ç¤ºæå–çš„æ•¸æ“š
            const processedData = doc.processedData || {};
            
            // ä¾›æ‡‰å•†
            const vendor = processedData.vendor || processedData.supplier || processedData.from || '-';
            document.getElementById('vendor').textContent = vendor;
            
            // é‡‘é¡
            let amount = '-';
            if (processedData.total) {
                amount = `$${parseFloat(processedData.total).toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } else if (processedData.amount) {
                amount = `$${parseFloat(processedData.amount).toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            document.getElementById('amount').textContent = amount;
            
            // å¸³å–®æ—¥æœŸ
            const billDate = processedData.date || processedData.invoiceDate || processedData.statementDate || '-';
            document.getElementById('billDate').textContent = billDate;
            
            // é¡¯ç¤ºäº¤æ˜“æ˜ç´°ï¼ˆå¦‚æœæœ‰ï¼‰
            const transactions = processedData.transactions || [];
            if (transactions.length > 0) {
                document.getElementById('transactionsSection').style.display = 'block';
                const tbody = document.getElementById('transactionsBody');
                tbody.innerHTML = '';
                
                transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tx.date || '-'}</td>
                        <td>${tx.description || tx.desc || '-'}</td>
                        <td>${tx.amount ? '$' + parseFloat(tx.amount).toLocaleString('zh-TW', { minimumFractionDigits: 2 }) : '-'}</td>
                        <td>${tx.balance ? '$' + parseFloat(tx.balance).toLocaleString('zh-TW', { minimumFractionDigits: 2 }) : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log(`âœ… é¡¯ç¤º ${transactions.length} ç­†äº¤æ˜“`);
            }
            
            // é¡¯ç¤ºåŸå§‹æ•¸æ“šï¼ˆèª¿è©¦ç”¨ï¼‰
            if (Object.keys(processedData).length > 0) {
                document.getElementById('rawDataSection').style.display = 'block';
                document.getElementById('rawData').textContent = JSON.stringify(processedData, null, 2);
            }
            
            console.log('âœ… æ–‡æª”é¡¯ç¤ºå®Œæˆ');
        }
        
        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–...');
            
            // ç­‰å¾… Firebase å’Œ Auth åˆå§‹åŒ–
            let attempts = 0;
            while (!window.simpleAuth || !window.simpleAuth.initialized) {
                if (attempts++ > 50) {
                    showError('èº«ä»½é©—è­‰åˆå§‹åŒ–è¶…æ™‚');
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.log('âœ… SimpleAuth å·²å°±ç·’');
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            if (!window.simpleAuth.isLoggedIn()) {
                console.log('âŒ ç”¨æˆ¶æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é ');
                window.location.href = 'index.html';
                return;
            }
            
            console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥');
            
            // è¼‰å…¥æ–‡æª”
            await loadDocument();
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
