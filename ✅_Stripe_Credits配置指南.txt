ğŸ”§ Stripe Credits è‡ªåŠ¨æ·»åŠ é…ç½®æŒ‡å—
================================
æ›´æ–°æ—¶é—´ï¼š2025å¹´12æœˆ9æ—¥

## ğŸ“‹ **é…ç½®æ¸…å•**

è¦è®©ç”¨æˆ·ä»˜è´¹åè‡ªåŠ¨è·å¾—Creditsï¼Œéœ€è¦é…ç½®3ä¸ªåœ°æ–¹ï¼š
1. âœ… Stripe äº§å“ Metadataï¼ˆéœ€è¦æ‰‹åŠ¨é…ç½®ï¼‰
2. âœ… Stripe Webhookï¼ˆéœ€è¦é…ç½®ï¼‰
3. âœ… Payment Link ä¼ é€’ userIdï¼ˆéœ€è¦ä¿®æ”¹ï¼‰

---

## 1ï¸âƒ£ **é…ç½® Stripe äº§å“ Metadata**

### **æœˆè´¹äº§å“é…ç½®ï¼š**

1. è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/products/prod_TZbMNtOqFBHfjl

2. ç‚¹å‡»äº§å“é¡µé¢çš„ **"Edit product"**ï¼ˆç¼–è¾‘äº§å“ï¼‰

3. æ»šåŠ¨åˆ° **"Metadata"** éƒ¨åˆ†ï¼Œæ·»åŠ ï¼š
   ```
   Key: monthly_credits
   Value: 100
   
   Key: plan_type
   Value: monthly
   ```

4. ç‚¹å‡» **"Save"** ä¿å­˜

### **å¹´è´¹äº§å“é…ç½®ï¼š**

1. è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/products/prod_TZbKe7oIo0TX8L

2. åŒæ ·æ·»åŠ  Metadataï¼š
   ```
   Key: monthly_credits
   Value: 1200
   
   Key: plan_type
   Value: yearly
   ```

3. ä¿å­˜

---

## 2ï¸âƒ£ **é…ç½® Stripe Webhook**

### **æ£€æŸ¥ Webhook æ˜¯å¦å·²é…ç½®ï¼š**

1. è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/webhooks

2. æŸ¥çœ‹æ˜¯å¦æœ‰ Webhook æŒ‡å‘ä½ çš„ Firebase Functions

### **å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºæ–° Webhookï¼š**

1. ç‚¹å‡» **"+ Add endpoint"**

2. å¡«å†™ï¼š
   ```
   Endpoint URL: 
   https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook
   
   Description: VaultCaddy Credits Management
   ```

3. é€‰æ‹©è¦ç›‘å¬çš„äº‹ä»¶ï¼š
   - âœ… `checkout.session.completed`
   - âœ… `customer.subscription.created`
   - âœ… `customer.subscription.updated`
   - âœ… `customer.subscription.deleted`
   - âœ… `payment_intent.succeeded`

4. ç‚¹å‡» **"Add endpoint"**

5. **å¤åˆ¶ Webhook Secret**ï¼ˆç±»ä¼¼ `whsec_xxxxx`ï¼‰

### **é…ç½® Firebase Functions ç¯å¢ƒå˜é‡ï¼š**

```bash
cd /Users/cavlinyeung/ai-bank-parser

# è®¾ç½® Stripe Secret Key
firebase functions:config:set stripe.secret_key="sk_live_xxxxx"

# è®¾ç½® Webhook Secret
firebase functions:config:set stripe.webhook_secret="whsec_xxxxx"

# é‡æ–°éƒ¨ç½² Functions
firebase deploy --only functions
```

---

## 3ï¸âƒ£ **Payment Link ä¼ é€’ userIdï¼ˆæœ€å…³é”®ï¼‰**

### **é—®é¢˜ï¼š**
å½“å‰çš„ Payment Link æ— æ³•è‡ªåŠ¨ä¼ é€’ userIdï¼Œå¯¼è‡´ webhook æ— æ³•è¯†åˆ«ç”¨æˆ·ã€‚

### **è§£å†³æ–¹æ¡ˆAï¼šä½¿ç”¨ Stripe Customer Portalï¼ˆæ¨èï¼‰**

ä¿®æ”¹ç½‘ç«™ä»£ç ï¼ŒåŠ¨æ€åˆ›å»º Checkout Sessionï¼Œè€Œä¸æ˜¯ä½¿ç”¨å›ºå®šçš„ Payment Linkã€‚

#### **ä¿®æ”¹ billing.htmlï¼š**

å°† "å¼€å§‹ä½¿ç”¨" æŒ‰é’®æ”¹ä¸ºï¼š

```html
<!-- æœˆè´¹æŒ‰é’® -->
<button onclick="createCheckoutSession('monthly')" 
        class="cta-btn" 
        style="width: 100%; padding: 1rem; ...">
    å¼€å§‹ä½¿ç”¨
</button>

<!-- å¹´è´¹æŒ‰é’® -->
<button onclick="createCheckoutSession('yearly')" 
        class="cta-btn" 
        style="width: 100%; padding: 1rem; ...">
    å¼€å§‹ä½¿ç”¨
</button>
```

#### **æ·»åŠ  JavaScript å‡½æ•°ï¼š**

```javascript
async function createCheckoutSession(planType) {
    // è·å–å½“å‰ç”¨æˆ·
    const user = firebase.auth().currentUser;
    
    if (!user) {
        alert('è¯·å…ˆç™»å½•');
        window.location.href = 'auth.html';
        return;
    }
    
    // è°ƒç”¨ Firebase Function åˆ›å»º Checkout Session
    const createSession = firebase.functions().httpsCallable('createStripeCheckoutSession');
    
    try {
        const result = await createSession({ 
            planType: planType,
            userId: user.uid,
            email: user.email
        });
        
        // è·³è½¬åˆ° Stripe Checkout
        window.location.href = result.data.url;
    } catch (error) {
        console.error('åˆ›å»ºæ”¯ä»˜ä¼šè¯å¤±è´¥:', error);
        alert('åˆ›å»ºæ”¯ä»˜ä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}
```

#### **æ·»åŠ  Firebase Functionï¼š**

åœ¨ `firebase-functions/index.js` ä¸­æ·»åŠ ï¼š

```javascript
/**
 * åˆ›å»º Stripe Checkout Session
 */
exports.createStripeCheckoutSession = functions.https.onCall(async (data, context) => {
    const { planType, userId, email } = data;
    
    if (!userId || !email) {
        throw new functions.https.HttpsError('invalid-argument', 'userId and email are required');
    }
    
    // ç¡®å®šä»·æ ¼ ID
    const priceIds = {
        monthly: 'price_xxxxx', // æ›¿æ¢ä¸ºä½ çš„æœˆè´¹ä»·æ ¼ID
        yearly: 'price_xxxxx'   // æ›¿æ¢ä¸ºä½ çš„å¹´è´¹ä»·æ ¼ID
    };
    
    const priceId = priceIds[planType];
    
    if (!priceId) {
        throw new functions.https.HttpsError('invalid-argument', 'Invalid plan type');
    }
    
    try {
        // åˆ›å»º Checkout Session
        const session = await stripe.checkout.sessions.create({
            mode: 'subscription',
            line_items: [
                {
                    price: priceId,
                    quantity: 1
                }
            ],
            customer_email: email,
            client_reference_id: userId, // â† å…³é”®ï¼šä¼ é€’ç”¨æˆ·ID
            metadata: {
                userId: userId // â† å…³é”®ï¼šä¼ é€’ç”¨æˆ·ID
            },
            success_url: 'https://vaultcaddy.com/billing.html?success=true',
            cancel_url: 'https://vaultcaddy.com/billing.html?canceled=true'
        });
        
        return { url: session.url };
    } catch (error) {
        console.error('åˆ›å»º Checkout Session å¤±è´¥:', error);
        throw new functions.https.HttpsError('internal', error.message);
    }
});
```

---

### **è§£å†³æ–¹æ¡ˆBï¼šä½¿ç”¨ Stripe Customer IDï¼ˆç®€å•ä½†é™åˆ¶å¤šï¼‰**

å¦‚æœç”¨æˆ·å·²ç»æ˜¯ Stripe å®¢æˆ·ï¼Œå¯ä»¥é€šè¿‡ email åŒ¹é…ï¼š

åœ¨ `firebase-functions/index.js` çš„ `handleCheckoutCompleted` ä¸­æ·»åŠ ï¼š

```javascript
async function handleCheckoutCompleted(session) {
    console.log('âœ… çµå¸³å®Œæˆ:', session.id);
    
    // å°è¯•é€šè¿‡ email æŸ¥æ‰¾ç”¨æˆ·
    let userId = session.client_reference_id || session.metadata?.userId;
    
    if (!userId && session.customer_email) {
        // é€šè¿‡ email åœ¨ Firestore ä¸­æŸ¥æ‰¾ç”¨æˆ·
        const usersSnapshot = await db.collection('users')
            .where('email', '==', session.customer_email)
            .limit(1)
            .get();
        
        if (!usersSnapshot.empty) {
            userId = usersSnapshot.docs[0].id;
            console.log(`âœ… é€šè¿‡ email æ‰¾åˆ°ç”¨æˆ·: ${userId}`);
        }
    }
    
    if (!userId) {
        console.error('âŒ ç„¡æ³•ç²å–ç”¨æˆ¶ ID');
        return;
    }
    
    // ... å…¶ä½™ä»£ç ä¸å˜
}
```

---

## ğŸ“Š **å®Œæ•´æµç¨‹ç¤ºæ„å›¾**

```
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ä½¿ç”¨"
    â†“
è°ƒç”¨ createStripeCheckoutSession (ä¼ é€’ userId)
    â†“
Stripe Checkout é¡µé¢ï¼ˆåŒ…å« userId åœ¨ metadata ä¸­ï¼‰
    â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
    â†“
Stripe è§¦å‘ webhook: checkout.session.completed
    â†“
Firebase Functions æ¥æ”¶ webhook
    â†“
ä» session.metadata.userId è·å–ç”¨æˆ·ID
    â†“
ä»äº§å“ metadata è·å– credits æ•°é‡
    â†“
è°ƒç”¨ addCredits() æ·»åŠ åˆ°ç”¨æˆ·è´¦æˆ·
    â†“
âœ… å®Œæˆï¼ç”¨æˆ·è·å¾— Credits
```

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

### **1. æµ‹è¯• Webhook é…ç½®ï¼š**

```bash
# ä½¿ç”¨ Stripe CLI æµ‹è¯• webhook
stripe trigger checkout.session.completed
```

### **2. æµ‹è¯•å®Œæ•´æµç¨‹ï¼š**

1. åœ¨ç½‘ç«™ä¸Šç™»å½•
2. ç‚¹å‡»"å¼€å§‹ä½¿ç”¨"
3. ä½¿ç”¨æµ‹è¯•å¡ï¼š`4242 4242 4242 4242`
4. å®Œæˆæ”¯ä»˜
5. æ£€æŸ¥ Firestore ä¸­ç”¨æˆ·çš„ credits æ˜¯å¦å¢åŠ 
6. æ£€æŸ¥ Firebase Functions æ—¥å¿—

### **3. æŸ¥çœ‹æ—¥å¿—ï¼š**

```bash
firebase functions:log
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… çµå¸³å®Œæˆ: cs_xxxxx
âœ… é€šè¿‡ email æ‰¾åˆ°ç”¨æˆ·: user_id
ğŸ å·²æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶
```

---

## âš ï¸ **å¸¸è§é—®é¢˜**

### **Q1: Webhook æ²¡æœ‰è§¦å‘ï¼Ÿ**
- æ£€æŸ¥ Webhook URL æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ Webhook Secret æ˜¯å¦é…ç½®
- æŸ¥çœ‹ Stripe Dashboard çš„ Webhook logs

### **Q2: æ‰¾ä¸åˆ°ç”¨æˆ·IDï¼Ÿ**
- ç¡®ä¿ Payment Link ä¼ é€’äº† client_reference_id
- æˆ–ç¡®ä¿ç”¨æˆ· email åœ¨ Firestore ä¸­å­˜åœ¨

### **Q3: Credits æ²¡æœ‰å¢åŠ ï¼Ÿ**
- æ£€æŸ¥äº§å“ metadata æ˜¯å¦é…ç½®äº† monthly_credits
- æŸ¥çœ‹ Firebase Functions æ—¥å¿—
- æ£€æŸ¥ addCredits() å‡½æ•°æ˜¯å¦æ‰§è¡ŒæˆåŠŸ

---

## âœ… **é…ç½®å®Œæˆæ£€æŸ¥æ¸…å•**

- [ ] Stripe äº§å“ metadata å·²æ·»åŠ ï¼ˆmonthly_credits, plan_typeï¼‰
- [ ] Stripe Webhook å·²é…ç½®ï¼ˆæŒ‡å‘ Firebase Functionsï¼‰
- [ ] Firebase Functions ç¯å¢ƒå˜é‡å·²è®¾ç½®ï¼ˆstripe.secret_key, stripe.webhook_secretï¼‰
- [ ] billing.html å·²ä¿®æ”¹ä¸ºåŠ¨æ€åˆ›å»º Checkout Session
- [ ] createStripeCheckoutSession Function å·²æ·»åŠ 
- [ ] handleCheckoutCompleted å·²ä¿®æ”¹ä¸ºé€šè¿‡ email æŸ¥æ‰¾ç”¨æˆ·
- [ ] å·²æµ‹è¯•å®Œæ•´æ”¯ä»˜æµç¨‹
- [ ] å·²éªŒè¯ Credits æ­£ç¡®æ·»åŠ 

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹ï¼ˆæ¨èé…ç½®ï¼‰**

å¦‚æœæƒ³å¿«é€Ÿæµ‹è¯•ï¼Œæ¨èä½¿ç”¨ **è§£å†³æ–¹æ¡ˆB**ï¼ˆé€šè¿‡ email åŒ¹é…ï¼‰ï¼Œåªéœ€ï¼š

1. é…ç½® Stripe äº§å“ Metadata
2. é…ç½® Webhook
3. ä¿®æ”¹ handleCheckoutCompleted å‡½æ•°
4. æµ‹è¯•ï¼

æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ï¼Œç”¨æˆ·ä»å¯ä½¿ç”¨ç°æœ‰çš„ Payment Linkã€‚

---

ç¥é…ç½®é¡ºåˆ©ï¼ğŸ‰

