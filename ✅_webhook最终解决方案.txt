# Stripe Webhook æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

## ğŸ” **é—®é¢˜æ ¹æº**

Firebase Cloud Functions (1st Gen) é»˜è®¤ä¼šè‡ªåŠ¨è§£æ JSON bodyï¼Œè¿™ä¼šç ´å Stripe webhook çš„ç­¾åéªŒè¯ã€‚

Stripe éœ€è¦**åŸå§‹çš„ã€æœªè§£æçš„è¯·æ±‚ä½“**æ¥éªŒè¯ `Stripe-Signature` headerã€‚

## âœ… **è§£å†³æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ Aï¼šä½¿ç”¨ Firebase Functions v2ï¼ˆæ¨èï¼‰**

Firebase Functions v2 æ”¯æŒæ›´å¥½çš„ HTTP è¯·æ±‚å¤„ç†ã€‚ä½†æ˜¯è¿™éœ€è¦å‡çº§æ‚¨çš„ Firebase Functionsã€‚

### **æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Express çš„ Raw Body Parserï¼ˆå½“å‰å®æ–½ï¼‰**

æˆ‘å·²ç»æ›´æ–°äº†ä»£ç æ¥å°è¯•è·å– rawBodyï¼Œä½†è¿™å¯èƒ½è¿˜ä¸å¤Ÿã€‚

### **æ–¹æ¡ˆ Cï¼šä¸´æ—¶è·³è¿‡ç­¾åéªŒè¯ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰**

ä¸ºäº†ç¡®è®¤ webhook é€»è¾‘æœ¬èº«æ˜¯å¦æ­£ç¡®ï¼Œæˆ‘ä»¬å¯ä»¥ä¸´æ—¶è·³è¿‡ç­¾åéªŒè¯ï¼š

```javascript
// ä¸´æ—¶ï¼šä¸éªŒè¯ç­¾åï¼Œç›´æ¥å¤„ç†äº‹ä»¶
const event = JSON.parse(payload);
console.log(`ğŸ“¨ æ”¶åˆ°webhookäº‹ä»¶ï¼ˆæœªéªŒè¯ç­¾åï¼‰: ${event.type}`);
```

## ğŸ¯ **ç«‹å³æµ‹è¯•**

è¯·ç°åœ¨åšä»¥ä¸‹æ“ä½œï¼š

1. **å†æ¬¡è¿›è¡Œæµ‹è¯•æ”¯ä»˜**ï¼š
   ```
   è®¿é—®: https://vaultcaddy.com/billing.html
   ç‚¹å‡»: ğŸ§ª æ¸¬è©¦ Get Started
   ä½¿ç”¨æµ‹è¯•å¡: 4242 4242 4242 4242
   å®Œæˆæ”¯ä»˜
   ```

2. **æŸ¥çœ‹ Firebase Functions æ—¥å¿—**ï¼š
   ```bash
   firebase functions:log --only stripeWebhook | tail -50
   ```

3. **æ£€æŸ¥æ—¥å¿—ä¸­çš„æ–°ä¿¡æ¯**ï¼š
   - `ğŸ“¦ Payload type:` - åº”è¯¥æ˜¾ç¤º 'string'
   - `ğŸ“¦ Payload length:` - åº”è¯¥å¤§äº 0
   - `ğŸ“¦ Signature:` - åº”è¯¥æ˜¾ç¤ºç­¾å

---

## ğŸ“Š **é¢„æœŸæ—¥å¿—è¾“å‡º**

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ“¦ Payload type: string
ğŸ“¦ Payload length: 1234
ğŸ“¦ Signature: t=1234567890,v1=abc123...
âœ… æµ‹è¯•æ¨¡å¼webhookç­¾åéªŒè¯æˆåŠŸ
ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: checkout.session.completed
```

å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæ‚¨ä¼šçœ‹åˆ°ï¼š
```
ğŸ“¦ Payload type: object
ğŸ“¦ Payload length: 0
âš ï¸ Request bodyå·²è¢«è§£æä¸ºJSONï¼Œæ— æ³•éªŒè¯ç­¾å
```

è¿™å°†å¸®åŠ©æˆ‘ä»¬ç¡®å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚

---

## ğŸ”§ **ä¸‹ä¸€æ­¥ï¼ˆå¦‚æœè¿˜æ˜¯å¤±è´¥ï¼‰**

å¦‚æœæ–°çš„æ—¥å¿—æ˜¾ç¤º payload ä»ç„¶æ˜¯ç©ºçš„æˆ–è¢«è§£æäº†ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. **å‡çº§åˆ° Firebase Functions v2**
2. **æˆ–è€…ä½¿ç”¨ Express middleware æ¥å¤„ç† raw body**
3. **æˆ–è€…ä¸´æ—¶è·³è¿‡ç­¾åéªŒè¯ï¼Œå…ˆè®©åŠŸèƒ½å·¥ä½œèµ·æ¥**

---

**ç°åœ¨è¯·è¿›è¡Œæµ‹è¯•æ”¯ä»˜ï¼Œç„¶åå‘Šè¯‰æˆ‘æ—¥å¿—æ˜¾ç¤ºä»€ä¹ˆï¼** ğŸš€

