# âœ… ç”¨æˆ·æ•°æ®å®Œæ•´ä¿å­˜æ–¹æ¡ˆ

## ğŸ“Š **å®Œæ•´çš„ç”¨æˆ·å­—æ®µç»“æ„**

ç°åœ¨ï¼Œæ— è®ºç”¨æˆ·é€šè¿‡å“ªç§æ–¹å¼æ³¨å†Œ/ç™»å½•ï¼Œéƒ½ä¼šåœ¨ Firestore `users` é›†åˆä¸­åˆ›å»ºåŒ…å«ä»¥ä¸‹**å®Œæ•´å­—æ®µ**çš„æ–‡æ¡£ï¼š

### **å­—æ®µåˆ—è¡¨**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ¥æº |
|------|------|------|------|
| `email` | string | ç”¨æˆ·é‚®ç®±ï¼ˆç»Ÿä¸€å°å†™ï¼‰ | âœ… å¿…å¡« |
| `displayName` | string | ç”¨æˆ·æ˜¾ç¤ºåç§°ï¼ˆåå­— + å§“æ°ï¼‰ | âœ… Emailæ³¨å†Œ/Googleè‡ªåŠ¨ |
| `company` | string | å…¬å¸åç§°ï¼ˆå¯é€‰ï¼‰ | âœ… Emailæ³¨å†Œå¯å¡«/å…¶ä»–æ–¹å¼ä¸ºç©º |
| `credits` | number | æ€» Credits | âœ… åˆå§‹ä¸º 0 |
| `currentCredits` | number | å½“å‰å¯ç”¨ Credits | âœ… åˆå§‹ä¸º 0 |
| `planType` | string | è®¢é˜…è®¡åˆ’ç±»å‹ | âœ… åˆå§‹ä¸º "Free Plan" |
| `emailVerified` | boolean | Email æ˜¯å¦å·²éªŒè¯ | âœ… Emailæ³¨å†Œä¸ºfalse/Googleè‡ªåŠ¨ |
| `photoURL` | string | ç”¨æˆ·å¤´åƒ URL | âœ… Googleè‡ªåŠ¨/å…¶ä»–ä¸ºç©º |
| `provider` | string | æ³¨å†Œæ–¹å¼ | âœ… email/google/stripe |
| `createdAt` | timestamp | åˆ›å»ºæ—¶é—´ | âœ… è‡ªåŠ¨ç”Ÿæˆ |
| `updatedAt` | timestamp | æ›´æ–°æ—¶é—´ | âœ… è‡ªåŠ¨ç”Ÿæˆ |

### **è®¢é˜…ç›¸å…³å­—æ®µï¼ˆPro Plan ç”¨æˆ·æ‰æœ‰ï¼‰**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `stripeCustomerId` | string | Stripe å®¢æˆ· ID |
| `stripeSubscriptionId` | string | Stripe è®¢é˜… ID |
| `subscriptionPlan` | string | monthly/yearly |
| `resetDate` | timestamp | Credits é‡ç½®æ—¥æœŸ |
| `meteredSubscriptionItemId` | string | ç”¨äºè®¡é‡è®¡è´¹ |
| `totalCreditsUsed` | number | ç´¯è®¡ä½¿ç”¨çš„ Credits |
| `includedCredits` | number | è®¢é˜…åŒ…å«çš„ Credits |

---

## ğŸ”§ **ä¿®æ”¹çš„ä»£ç **

### **1. simple-auth.js - Email æ³¨å†Œ**

**ä¿®æ”¹å‰**ï¼š
```javascript
async registerWithEmail(email, password, displayName = null) {
    // ...
    const userDoc = {
        email: normalizedEmail,
        displayName: displayName || '',
        credits: 0,
        currentCredits: 0,
        emailVerified: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
}
```

**ä¿®æ”¹å**ï¼š
```javascript
async registerWithEmail(email, password, displayName = null, additionalData = {}) {
    // ...
    const userDoc = {
        email: normalizedEmail,
        displayName: displayName || '',
        company: additionalData.company || '',  // ğŸ¢ å…¬å¸åç¨±
        credits: 0,
        currentCredits: 0,
        emailVerified: false,
        planType: 'Free Plan',  // ğŸ“‹ åˆå§‹ç‚º Free Plan
        photoURL: '',  // ğŸ“· Email è¨»å†Šç„¡é ­åƒ
        provider: 'email',  // ğŸ” è¨»å†Šæ–¹å¼
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
}
```

---

### **2. simple-auth.js - Google ç™»å½•**

**ä¿®æ”¹å‰**ï¼š
```javascript
const userData = {
    email: normalizedEmail,
    displayName: result.user.displayName || '',
    credits: 0,
    currentCredits: 0,
    emailVerified: result.user.emailVerified,
    photoURL: result.user.photoURL || '',
    provider: 'google',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
};
```

**ä¿®æ”¹å**ï¼š
```javascript
const userData = {
    email: normalizedEmail,
    displayName: result.user.displayName || '',
    company: '',  // ğŸ¢ Google ç™»å…¥æ™‚ç‚ºç©ºï¼Œå¯å¾ŒçºŒå¡«å¯«
    credits: 0,
    currentCredits: 0,
    emailVerified: result.user.emailVerified,
    planType: 'Free Plan',  // ğŸ“‹ åˆå§‹ç‚º Free Plan
    photoURL: result.user.photoURL || '',
    provider: 'google',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
};
```

---

### **3. auth.html - æ³¨å†Œè¡¨å•æäº¤**

**ä¿®æ”¹å‰**ï¼š
```javascript
const firstName = document.getElementById('register-firstName').value;
const lastName = document.getElementById('register-lastName').value;
const email = document.getElementById('register-email').value;
const displayName = `${firstName} ${lastName}`.trim();

await window.simpleAuth.registerWithEmail(email, password, displayName);
```

**ä¿®æ”¹å**ï¼š
```javascript
const firstName = document.getElementById('register-firstName').value;
const lastName = document.getElementById('register-lastName').value;
const email = document.getElementById('register-email').value;
const company = document.getElementById('register-company').value || '';  // ğŸ¢ å…¬å¸åç¨±
const displayName = `${firstName} ${lastName}`.trim();

const additionalData = {
    company: company.trim()
};

console.log('ğŸ“ è¨»å†Šè³‡æ–™:', { email, displayName, company });

await window.simpleAuth.registerWithEmail(email, password, displayName, additionalData);
```

---

### **4. firebase-functions/index.js - Stripe æ”¯ä»˜åˆ›å»ºç”¨æˆ·**

**ä¿®æ”¹å‰**ï¼š
```javascript
const newUserRef = await db.collection('users').add({
    email: session.customer_email,
    displayName: customerName,
    credits: 0,
    currentCredits: 0,
    planType: 'Free Plan',
    emailVerified: false,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    source: 'stripe_payment',
    stripeCustomerId: session.customer
});
```

**ä¿®æ”¹å**ï¼š
```javascript
const newUserRef = await db.collection('users').add({
    email: session.customer_email,
    displayName: customerName,
    company: '',  // ğŸ¢ Stripe æ”¯ä»˜æ™‚ç‚ºç©ºï¼Œå¯å¾ŒçºŒå¡«å¯«
    credits: 0,
    currentCredits: 0,
    planType: 'Free Plan',
    emailVerified: false,
    photoURL: '',  // ğŸ“· Stripe è¨»å†Šç„¡é ­åƒ
    provider: 'stripe',  // ğŸ” é€šé Stripe æ”¯ä»˜å‰µå»º
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    source: 'stripe_payment',
    stripeCustomerId: session.customer
});
```

---

## ğŸ” **å…³äºå¯†ç çš„è¯´æ˜**

### âŒ **ä¸éœ€è¦åœ¨ Firestore ä¸­ä¿å­˜å¯†ç ï¼**

**åŸå› **ï¼š
1. **å®‰å…¨æ€§**ï¼šFirebase Authentication å·²ç»ä½¿ç”¨è¡Œä¸šæ ‡å‡†åŠ å¯†ç®—æ³•ï¼ˆbcryptï¼‰å®‰å…¨å­˜å‚¨å¯†ç 
2. **åˆè§„æ€§**ï¼šå°†æ˜æ–‡æˆ–åŠ å¯†å¯†ç å­˜å‚¨åœ¨ Firestore è¿åå®‰å…¨æœ€ä½³å®è·µ
3. **å†—ä½™æ€§**ï¼šFirebase Auth æä¾›äº†å®Œæ•´çš„å¯†ç ç®¡ç†åŠŸèƒ½ï¼ˆé‡ç½®ã€ä¿®æ”¹ç­‰ï¼‰
4. **é£é™©æ€§**ï¼šå¦‚æœ Firestore è§„åˆ™é…ç½®é”™è¯¯ï¼Œå¯†ç å¯èƒ½è¢«æ³„éœ²

**å¯†ç å­˜å‚¨åœ¨å“ªé‡Œ**ï¼š
- å¯†ç å­˜å‚¨åœ¨ **Firebase Authentication** æœåŠ¡ä¸­
- åªèƒ½é€šè¿‡ Firebase Auth API è®¿é—®å’ŒéªŒè¯
- Firestore ä¸­åªå­˜å‚¨ **ç”¨æˆ· UID**ï¼ˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼‰ï¼Œé€šè¿‡å®ƒå…³è” Auth å’Œ Firestore æ•°æ®

---

## ğŸ“‹ **æµ‹è¯•æ¸…å•**

### **Email æ³¨å†Œæµ‹è¯•**

- [ ] 1. è®¿é—® https://vaultcaddy.com/auth.html
- [ ] 2. ç‚¹å‡»"ç«‹å³è¨»å†Š"
- [ ] 3. å¡«å†™è¡¨å•ï¼š
  - [ ] åå­—ï¼šæµ‹è¯•
  - [ ] å§“æ°ï¼šç”¨æˆ·
  - [ ] Emailï¼štest123@gmail.com
  - [ ] å…¬å¸åç¨±ï¼šTest Company Ltd.ï¼ˆå¯é€‰ï¼‰
  - [ ] å¯†ç ï¼š********
  - [ ] ç¡®è®¤å¯†ç ï¼š********
- [ ] 4. ç‚¹å‡»"åˆ›å»ºå¸æˆ·"
- [ ] 5. æŸ¥çœ‹ Firebase Console â†’ users é›†åˆ
- [ ] 6. **éªŒè¯æ–°ç”¨æˆ·åŒ…å«ä»¥ä¸‹å­—æ®µ**ï¼š
  - [ ] `email`: test123@gmail.com âœ…
  - [ ] `displayName`: æµ‹è¯• ç”¨æˆ· âœ…
  - [ ] `company`: Test Company Ltd. âœ…
  - [ ] `credits`: 0 âœ…
  - [ ] `currentCredits`: 0 âœ…
  - [ ] `planType`: Free Plan âœ…
  - [ ] `emailVerified`: false âœ…
  - [ ] `photoURL`: '' âœ…
  - [ ] `provider`: email âœ…
  - [ ] `createdAt`: (æ—¶é—´æˆ³) âœ…
  - [ ] `updatedAt`: (æ—¶é—´æˆ³) âœ…

---

### **Google ç™»å½•æµ‹è¯•**

- [ ] 1. è®¿é—® https://vaultcaddy.com/auth.html
- [ ] 2. ç‚¹å‡»"ä½¿ç”¨ Google ç™»å…¥"
- [ ] 3. é€‰æ‹© Google è´¦æˆ·
- [ ] 4. æŸ¥çœ‹ Firebase Console â†’ users é›†åˆ
- [ ] 5. **éªŒè¯æ–°ç”¨æˆ·åŒ…å«ä»¥ä¸‹å­—æ®µ**ï¼š
  - [ ] `email`: (Google email) âœ…
  - [ ] `displayName`: (Google name) âœ…
  - [ ] `company`: '' âœ…
  - [ ] `credits`: 0 âœ…
  - [ ] `currentCredits`: 0 âœ…
  - [ ] `planType`: Free Plan âœ…
  - [ ] `emailVerified`: true âœ…
  - [ ] `photoURL`: (Google photo URL) âœ…
  - [ ] `provider`: google âœ…
  - [ ] `createdAt`: (æ—¶é—´æˆ³) âœ…
  - [ ] `updatedAt`: (æ—¶é—´æˆ³) âœ…

---

### **Stripe æ”¯ä»˜æµ‹è¯•**

- [ ] 1. è®¿é—® https://vaultcaddy.com/billing.html
- [ ] 2. ä½¿ç”¨æ–° email æ³¨å†Œï¼ˆä¾‹å¦‚ï¼šstripe123@gmail.comï¼‰
- [ ] 3. ç‚¹å‡»"Get Started"ï¼ˆæœˆè´¹æˆ–å¹´è´¹ï¼‰
- [ ] 4. å®Œæˆ Stripe æ”¯ä»˜
- [ ] 5. æŸ¥çœ‹ Firebase Console â†’ users é›†åˆ
- [ ] 6. **éªŒè¯æ–°ç”¨æˆ·åŒ…å«ä»¥ä¸‹å­—æ®µ**ï¼š
  - [ ] `email`: stripe123@gmail.com âœ…
  - [ ] `displayName`: (è‡ªåŠ¨ç”Ÿæˆ) âœ…
  - [ ] `company`: '' âœ…
  - [ ] `credits`: 100 âœ…
  - [ ] `currentCredits`: 100 âœ…
  - [ ] `planType`: Pro Plan âœ…
  - [ ] `emailVerified`: false âœ…
  - [ ] `photoURL`: '' âœ…
  - [ ] `provider`: stripe âœ…
  - [ ] `stripeCustomerId`: (Stripe ID) âœ…
  - [ ] `stripeSubscriptionId`: (Subscription ID) âœ…
  - [ ] `createdAt`: (æ—¶é—´æˆ³) âœ…
  - [ ] `updatedAt`: (æ—¶é—´æˆ³) âœ…

---

## ğŸ“ **ä¿®æ”¹çš„æ–‡ä»¶**

1. `simple-auth.js`
   - ä¿®æ”¹ `registerWithEmail` å‡½æ•°
   - ä¿®æ”¹ `loginWithGoogle` å‡½æ•°

2. `auth.html`
   - ä¿®æ”¹æ³¨å†Œè¡¨å•æäº¤é€»è¾‘

3. `firebase-functions/index.js`
   - ä¿®æ”¹ `handleCheckoutCompleted` å‡½æ•°

---

## ğŸš€ **éƒ¨ç½²çŠ¶æ€**

- [x] Cloud Functions å·²éƒ¨ç½² âœ…
- [x] Hostingï¼ˆå‰ç«¯ï¼‰å·²éƒ¨ç½² âœ…

---

## ğŸ¯ **ä¸‹ä¸€æ­¥**

1. âœ… **æ¸…ç©ºæ—§çš„æµ‹è¯•æ•°æ®**
   - åˆ é™¤ `processedStripeEvents` é›†åˆ
   - åˆ é™¤æ—§çš„æµ‹è¯•ç”¨æˆ·

2. âœ… **æµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œ**
   - Email æ³¨å†Œï¼ˆåŒ…å«å…¬å¸åç§°ï¼‰
   - Google ç™»å½•
   - Stripe æ”¯ä»˜

3. âœ… **éªŒè¯æ‰€æœ‰å­—æ®µ**
   - åœ¨ Firebase Console ä¸­æ£€æŸ¥ç”¨æˆ·æ–‡æ¡£
   - ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å­˜åœ¨ä¸”æ­£ç¡®

4. â³ **åç»­å¢å¼º**ï¼ˆå¦‚æœéœ€è¦ï¼‰
   - åœ¨ `account.html` ä¸­æ·»åŠ "ç¼–è¾‘ä¸ªäººèµ„æ–™"åŠŸèƒ½
   - å…è®¸ç”¨æˆ·åç»­å¡«å†™æˆ–ä¿®æ”¹å…¬å¸åç§°
   - æ·»åŠ æ›´å¤šç”¨æˆ·å­—æ®µï¼ˆç”µè¯ã€åœ°å€ç­‰ï¼‰

---

## âœ… **æ€»ç»“**

### **é—®é¢˜**
ç”¨æˆ·æ³¨å†Œ/ç™»å½•åï¼ŒFirestore ä¸­çš„ç”¨æˆ·æ–‡æ¡£ç¼ºå°‘å…³é”®å­—æ®µï¼ˆå¦‚ `company`ã€`planType`ã€`photoURL`ã€`provider`ï¼‰

### **è§£å†³æ–¹æ¡ˆ**
1. ä¿®æ”¹ `simple-auth.js`ï¼Œä¸º Email æ³¨å†Œå’Œ Google ç™»å½•æ·»åŠ å®Œæ•´å­—æ®µ
2. ä¿®æ”¹ `auth.html`ï¼Œè¯»å–å¹¶ä¼ é€’å…¬å¸åç§°
3. ä¿®æ”¹ `firebase-functions/index.js`ï¼Œä¸º Stripe åˆ›å»ºçš„ç”¨æˆ·æ·»åŠ å®Œæ•´å­—æ®µ
4. ç»Ÿä¸€æ‰€æœ‰æ³¨å†Œæ–¹å¼çš„å­—æ®µç»“æ„

### **ç»“æœ**
âœ… ç°åœ¨æ— è®ºç”¨æˆ·é€šè¿‡å“ªç§æ–¹å¼æ³¨å†Œ/ç™»å½•ï¼Œéƒ½ä¼šåœ¨ Firestore ä¸­åˆ›å»ºåŒ…å«**å®Œæ•´å­—æ®µ**çš„ç”¨æˆ·æ–‡æ¡£

---

**ğŸ‰ æ‰€æœ‰ç”¨æˆ·æ•°æ®ç°åœ¨éƒ½ä¼šè¢«æ­£ç¡®ä¿å­˜ï¼**

