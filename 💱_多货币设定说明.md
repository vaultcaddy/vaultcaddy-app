# 💱 Stripe 多货币设定说明

## 🌍 **Stripe Checkout 自动多货币切换**

### **工作原理**

Stripe 会根据以下因素**自动选择货币**：

1. **客户的 IP 地址**（最优先）
   - 香港 IP → HKD
   - 美国 IP → USD
   - 英国 IP → GBP
   - 日本 IP → JPY
   - 韩国 IP → KRW
   - 欧盟 IP → EUR

2. **浏览器语言设置**
   - `zh-HK` → HKD
   - `en-US` → USD
   - `ja-JP` → JPY

3. **客户账单地址**
   - 如果之前有支付记录，使用历史货币

---

## ✅ **我们已经配置好的内容**

### **1. Currency Options 已设置**

在创建 Price 时，我们已经配置了 6 种货币：

```javascript
// 月费 Price
price_1SdpzxJmiQ31C0GTLe5rYQn9

currency_options: {
  'hkd': { unit_amount: 5800 },   // HK$58
  'usd': { unit_amount: 748 },    // $7.48
  'gbp': { unit_amount: 558 },    // £5.58
  'jpy': { unit_amount: 1158 },   // ¥1,158
  'krw': { unit_amount: 10888 },  // ₩10,888
  'eur': { unit_amount: 628 }     // €6.28
}
```

### **2. Checkout Session 自动处理**

我们的代码已经正确配置：

```javascript
const session = await stripeClient.checkout.sessions.create({
    mode: 'subscription',
    line_items: [
        {
            price: 'price_1SdpzxJmiQ31C0GTLe5rYQn9',  // 支持多货币
            quantity: 1
        },
        {
            price: 'price_1SdpzxJmiQ31C0GTAXBa4vHG'  // 按量计费也支持多货币
        }
    ],
    // Stripe 会自动根据用户位置选择货币
});
```

**无需额外配置！** ✅

---

## 🧪 **如何测试多货币**

### **方法 1：使用 VPN（推荐）**

1. **测试 USD（美元）**
   - 连接美国 VPN
   - 访问 https://vaultcaddy.com/billing.html
   - 点击 "開始使用"
   - Checkout 页面应显示 **$7.48**

2. **测试 GBP（英镑）**
   - 连接英国 VPN
   - 应显示 **£5.58**

3. **测试 JPY（日元）**
   - 连接日本 VPN
   - 应显示 **¥1,158**

### **方法 2：手动切换货币**

在 Stripe Checkout 页面上：

1. 查看价格旁边的货币符号
2. 有些情况下，Stripe 会显示货币切换按钮
3. 点击可以切换货币

### **方法 3：使用浏览器开发工具**

```javascript
// 在浏览器控制台运行
// 模拟不同地区
navigator.geolocation.getCurrentPosition = function(success) {
    success({
        coords: {
            latitude: 22.3193,  // 香港坐标
            longitude: 114.1694
        }
    });
};
```

---

## 📋 **验证多货币配置**

### **在 Stripe Dashboard 中验证**

1. **访问 Price 详情**
   🔗 https://dashboard.stripe.com/prices/price_1SdpzxJmiQ31C0GTLe5rYQn9

2. **查看 Currency Options**
   - 应该看到 6 种货币的定价
   - 每种货币都有固定价格

3. **查看截图示例**
   ```
   HKD  $58.00
   USD  $7.48
   GBP  £5.58
   JPY  ¥1,158
   KRW  ₩10,888
   EUR  €6.28
   ```

---

## 🎯 **用户如何看到不同货币**

### **场景 1：香港用户**
- IP：香港
- 浏览器：中文（繁体）
- 看到：**HK$58.00**

### **场景 2：美国用户**
- IP：美国
- 浏览器：英文（美国）
- 看到：**$7.48**

### **场景 3：日本用户**
- IP：日本
- 浏览器：日语
- 看到：**¥1,158**

---

## 💡 **常见问题**

### **Q1：如何强制显示特定货币？**

**A1：不建议强制**。Stripe 的自动选择通常最准确。

如果确实需要，可以在创建 Checkout Session 时指定：

```javascript
const session = await stripeClient.checkout.sessions.create({
    mode: 'subscription',
    currency: 'usd',  // 强制使用 USD
    line_items: [...]
});
```

**但这会失去多货币的优势！**

---

### **Q2：用户可以自己切换货币吗？**

**A2：部分可以**

- Stripe 有时会在 Checkout 页面显示货币切换器
- 显示条件：
  - 用户位置不确定
  - 多种货币都适用
  - Stripe 检测到货币偏好

**不是所有情况都会显示切换器！**

---

### **Q3：如何确认用户最终支付的货币？**

**A3：在 Stripe Dashboard 中查看**

1. 进入订阅详情
2. 查看 "Currency" 字段
3. 发票会显示实际收费货币

---

### **Q4：不同货币的汇率如何更新？**

**A4：我们使用固定价格**

- ✅ 不依赖实时汇率
- ✅ 价格稳定，不会波动
- ✅ 用户体验更好

**如果需要调整价格**：
```bash
# 更新某个货币的价格
stripe prices update price_1SdpzxJmiQ31C0GTLe5rYQn9 \
  --currency-options[usd][unit_amount]=800  # 改为 $8.00
```

---

## 🔍 **调试多货币问题**

### **检查 Price 配置**

```bash
# 查看 Price 详情
stripe prices retrieve price_1SdpzxJmiQ31C0GTLe5rYQn9
```

**预期输出**：
```json
{
  "id": "price_1SdpzxJmiQ31C0GTLe5rYQn9",
  "currency": "hkd",
  "unit_amount": 5800,
  "currency_options": {
    "usd": { "unit_amount": 748 },
    "gbp": { "unit_amount": 558 },
    "jpy": { "unit_amount": 1158 },
    "krw": { "unit_amount": 10888 },
    "eur": { "unit_amount": 628 }
  }
}
```

---

### **检查 Checkout Session**

在 Firebase Functions 日志中：

```
🛒 創建 Checkout Session: {
  planType: 'monthly',
  currency: 'hkd'  // ← 实际使用的货币
}
```

---

## 📊 **多货币转换率表**

我们当前的定价策略（相对于 HKD 基准）：

| 货币 | 月费 | 相对 HKD | 年费 | 相对 HKD |
|------|------|---------|------|---------|
| HKD  | $58  | 1.00x   | $552 | 1.00x   |
| USD  | $7.48| 0.97x   | $71.81| 0.95x  |
| GBP  | £5.58| 0.97x   | £53.57| 0.95x  |
| JPY  | ¥1,158| 1.00x  | ¥11,117| 1.00x |
| KRW  | ₩10,888| 0.98x | ₩104,525| 0.97x|
| EUR  | €6.28| 0.97x   | €60.29| 0.95x  |

**年费有额外折扣！** ✨

---

## 🎨 **改进多货币体验**

### **可选：在前端显示货币切换器**

如果你想让用户主动选择货币：

```html
<!-- 在 billing.html 中添加 -->
<select id="currency-selector">
    <option value="hkd">🇭🇰 HKD - 港幣</option>
    <option value="usd">🇺🇸 USD - 美元</option>
    <option value="gbp">🇬🇧 GBP - 英鎊</option>
    <option value="jpy">🇯🇵 JPY - 日元</option>
    <option value="krw">🇰🇷 KRW - 韓元</option>
    <option value="eur">🇪🇺 EUR - 歐元</option>
</select>
```

**但这需要修改创建 Checkout Session 的代码！**

---

## ✅ **总结**

### **你需要做的**
❌ **什么都不用做！** 多货币已经自动配置好了！

### **Stripe 会自动**
✅ 检测用户位置  
✅ 选择合适货币  
✅ 显示正确价格  
✅ 处理支付  

### **用户会看到**
✅ 本地货币价格  
✅ 熟悉的货币符号  
✅ 更好的支付体验  

---

**测试建议**：
1. 使用 VPN 切换到不同国家
2. 访问 billing 页面
3. 查看 Checkout 显示的货币
4. 验证价格是否正确

**预计测试时间**：15-20 分钟


