# Stripe Webhook é”™è¯¯è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ

## ğŸ“Š **å½“å‰çŠ¶æ€**

âœ… **IAMæƒé™å·²è®¾ç½®**ï¼šå…è®¸å…¬å¼€è®¿é—® stripeWebhook
âœ… **CORS headerså·²è®¾ç½®**
âœ… **åŠ¨æ€ webhook secret é€‰æ‹©å·²å®ç°**
âœ… **å‡½æ•°å·²æˆåŠŸéƒ¨ç½²**

## âŒ **ä»ç„¶å­˜åœ¨çš„é—®é¢˜**

ä» Firebase Functions æ—¥å¿—çœ‹åˆ°ï¼š
```
âš ï¸ ç”Ÿäº§æ¨¡å¼ç­¾åéªŒè¯å¤±è´¥ï¼Œå°è¯•æµ‹è¯•æ¨¡å¼: No webhook payload was provided.
âŒ æµ‹è¯•æ¨¡å¼ç­¾åéªŒè¯ä¹Ÿå¤±è´¥: No webhook payload was provided.
```

**æ ¹æœ¬åŸå› **ï¼š
- Webhook è¯·æ±‚åˆ°è¾¾äº† Firebase Functions
- ä½†æ˜¯ `req.rawBody` æ˜¯ç©ºçš„
- è¿™å¯¼è‡´ Stripe SDK æ— æ³•éªŒè¯ç­¾å

## ğŸ” **ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ**

æŸ¥çœ‹ Stripe Dashboard æˆªå›¾ä¸­çš„é”™è¯¯ï¼š
```json
{
  "error": {
    "code": "invalid_csrf",
    "message": "Something is wrong with your CSRF token..."
  }
}
```

**è¿™ä¸ªé”™è¯¯æ˜¯ Stripe Dashboard UI çš„æ˜¾ç¤ºé—®é¢˜ï¼Œä¸æ˜¯çœŸæ­£çš„ webhook é”™è¯¯ï¼**

## âœ… **è§£å†³æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ1ï¼šç›´æ¥æµ‹è¯•æ”¯ä»˜ï¼ˆæ¨èï¼‰**

ä¸è¦é€šè¿‡ Stripe Dashboard çš„"é‡æ–°å‘é€"æŒ‰é’®æµ‹è¯•ï¼Œè€Œæ˜¯ï¼š

1. è¿”å› https://vaultcaddy.com/billing.html
2. ç‚¹å‡» "ğŸ§ª æ¸¬è©¦ Get Started"
3. ä½¿ç”¨æµ‹è¯•å¡å®Œæˆä¸€æ¬¡çœŸå®çš„æµ‹è¯•æ”¯ä»˜
4. è¿™ä¼šè§¦å‘çœŸæ­£çš„ webhook äº‹ä»¶

### **æ–¹æ¡ˆ2ï¼šæ£€æŸ¥ Stripe Webhook é…ç½®**

å¯èƒ½çš„é—®é¢˜ï¼š
1. Webhook endpoint URL é…ç½®é”™è¯¯
2. Webhook æ²¡æœ‰æ­£ç¡®å‘é€ payload

## ğŸ“‹ **ä¸‹ä¸€æ­¥æ“ä½œ**

è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. **è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**ï¼š
   ```
   è®¿é—®: https://vaultcaddy.com/billing.html
   ç‚¹å‡»: ğŸ§ª æ¸¬è©¦ Get Started
   ä½¿ç”¨æµ‹è¯•å¡: 4242 4242 4242 4242
   ```

2. **è§‚å¯Ÿç»“æœ**ï¼š
   - Credits åº”è¯¥ä» 0 å¢åŠ åˆ° 1200
   - Plan åº”è¯¥ä» "Free Plan" å˜ä¸º "Pro Plan"

3. **å¦‚æœè¿˜æ˜¯å¤±è´¥**ï¼Œè¯·æä¾›ï¼š
   - æ”¯ä»˜å®Œæˆåçš„æˆªå›¾
   - Firebase Functions æ—¥å¿—ï¼š`firebase functions:log --only stripeWebhook | tail -50`

---

## ğŸ”§ **æŠ€æœ¯ç»†èŠ‚**

### Firebase Functions å½“å‰å®ç°ï¼š

```javascript
exports.stripeWebhook = functions.https.onRequest(async (req, res) => {
    res.set('Access-Control-Allow-Origin', '*');
    res.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.set('Access-Control-Allow-Headers', 'Content-Type, stripe-signature');
    
    if (req.method === 'OPTIONS') {
        res.status(204).send('');
        return;
    }
    
    const sig = req.headers['stripe-signature'];
    const payload = req.rawBody || req.body;
    
    // åŠ¨æ€é€‰æ‹© webhook secretï¼ˆç”Ÿäº§/æµ‹è¯•ï¼‰
    // éªŒè¯ç­¾å
    // å¤„ç†äº‹ä»¶
});
```

### IAM æƒé™ï¼š
```bash
gcloud functions add-iam-policy-binding stripeWebhook \
  --region=us-central1 \
  --member=allUsers \
  --role=roles/cloudfunctions.invoker
```

---

## ğŸ“ **æ³¨æ„äº‹é¡¹**

1. **ä¸è¦ä½¿ç”¨ Stripe Dashboard çš„"é‡æ–°å‘é€"æŒ‰é’®**
   - è¿™ä¸ªæŒ‰é’®å¯èƒ½ä¼šå¯¼è‡´ CSRF é”™è¯¯
   - åº”è¯¥ä½¿ç”¨çœŸå®çš„æ”¯ä»˜æµç¨‹æµ‹è¯•

2. **æµ‹è¯•æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼éƒ½å·²é…ç½®**
   - æµ‹è¯• webhook secret: å·²é…ç½®
   - ç”Ÿäº§ webhook secret: å·²é…ç½®

3. **å‡½æ•°å·²ä¼˜åŒ–**
   - æ”¯æŒç”Ÿäº§å’Œæµ‹è¯•æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
   - ä½¿ç”¨ rawBody ç¡®ä¿ç­¾åéªŒè¯æˆåŠŸ

