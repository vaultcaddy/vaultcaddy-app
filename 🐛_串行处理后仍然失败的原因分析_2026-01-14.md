# ğŸ› ä¸²è¡Œå¤„ç†åä»ç„¶å¤±è´¥çš„åŸå› åˆ†æ

## ğŸ“… æ—¥æœŸ
2026-01-14 15:04

---

## ğŸ” é—®é¢˜ç°è±¡

### ç”¨æˆ·æŠ¥å‘Š

**ä¸Šä¼ 6é¡µPDF** â†’ **ä¸²è¡Œå¤„ç†**ï¼š

```
âœ… æ‰¹æ¬¡ 1/3 å®Œæˆï¼ï¼ˆç¬¬ 1-2 é¡µï¼‰
ğŸ“¦ å¤„ç†æ‰¹æ¬¡ 2/3ï¼šç¬¬ 3-4 é¡µ
âŒ æ‰¹æ¬¡ 2/3 å¤±è´¥ï¼šJSONè§£æé”™è¯¯
ğŸ“¦ å¤„ç†æ‰¹æ¬¡ 3/3ï¼šç¬¬ 5-6 é¡µ  
âŒ æ‰¹æ¬¡ 3/3 å¤±è´¥ï¼šJSONè§£æé”™è¯¯
```

**ç»“æœ**ï¼š
- âœ… æ‰¹æ¬¡1æˆåŠŸ
- âŒ æ‰¹æ¬¡2å¤±è´¥
- âŒ æ‰¹æ¬¡3å¤±è´¥
- æ–‡æ¡£çŠ¶æ€ï¼š**å¤±è´¥**ï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼ï¼‰

---

## â“ ä¸¤ä¸ªå…³é”®é—®é¢˜

### é—®é¢˜1ï¼šä¸ºä»€ä¹ˆçŠ¶æ€æ˜¾ç¤º"å¤±è´¥"è€Œä¸æ˜¯"å¤„ç†ä¸­"ï¼Ÿ

**ç­”æ¡ˆ**ï¼š**è¿™æ˜¯æ­£ç¡®çš„è¡Œä¸ºï¼**

**åŸå› **ï¼š
1. æ‰¹æ¬¡2å’Œæ‰¹æ¬¡3éƒ½å¤„ç†å¤±è´¥äº†
2. ç³»ç»Ÿçš„å®¹é”™é€»è¾‘ä¼šç»§ç»­å°è¯•å¤„ç†æ‰€æœ‰æ‰¹æ¬¡
3. æœ€ååªæœ‰æ‰¹æ¬¡1æˆåŠŸï¼Œæ‰¹æ¬¡2å’Œ3å¤±è´¥
4. ç³»ç»Ÿæœ€ç»ˆå°†æ–‡æ¡£æ ‡è®°ä¸º"å¤±è´¥"

**ä»£ç é€»è¾‘**ï¼ˆ`qwen-vl-max-processor.js:340-350`ï¼‰ï¼š

```javascript
} catch (error) {
    failedBatches++;
    console.error(`âŒ æ‰¹æ¬¡ ${batchNum}/${totalBatches} å¤±è´¥:`, error.message);
    
    // âœ… å®¹é”™æ¨¡å¼ï¼šç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡
    console.warn(`âš ï¸  è·³è¿‡æ‰¹æ¬¡ ${batchNum}ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡...`);
    continue;
}

// æœ€åæ£€æŸ¥
if (allResults.length === 0) {
    throw new Error('æ‰€æœ‰æ‰¹æ¬¡éƒ½å¤„ç†å¤±è´¥');
}
```

å› ä¸ºåªæœ‰1ä¸ªæ‰¹æ¬¡æˆåŠŸï¼ˆå…±3ä¸ªæ‰¹æ¬¡ï¼‰ï¼Œè™½ç„¶æ²¡æœ‰å®Œå…¨å¤±è´¥ï¼Œä½†æ–‡æ¡£è¢«æ ‡è®°ä¸º"å¤±è´¥"ã€‚

---

### é—®é¢˜2ï¼šä¸ºä»€ä¹ˆæ‰¹æ¬¡2/3ä¼šå¤±è´¥ï¼ˆJSONè§£æé”™è¯¯ï¼‰ï¼Ÿ

**é”™è¯¯ä¿¡æ¯**ï¼š
```
âŒ æ‰¹æ¬¡ 2/3 å¤±è´¥: JSONè§£æé”™è¯¯
Unexpected end of JSON input
```

**å³ä½¿ä½¿ç”¨ä¸²è¡Œå¤„ç†ï¼Œä»ç„¶å‡ºç°JSONæˆªæ–­ï¼**

---

## ğŸ§ æ·±å…¥åˆ†æåŸå› 

### å¯èƒ½åŸå› 1ï¼š**å›¾ç‰‡æ–‡ä»¶å¤ªå¤§** âš ï¸ **æœ€å¯èƒ½**

#### å½“å‰é…ç½®

**æ–‡ä»¶**ï¼š`pdf-to-image-converter.js`

```javascript
const scale = 1.5;           // 1.5x ç¼©æ”¾
const quality = 0.85;        // 85% è´¨é‡
const format = 'image/webp'; // WebP æ ¼å¼
```

#### é¢„ä¼°æ–‡ä»¶å¤§å°

å‡è®¾PDFé¡µé¢å°ºå¯¸ä¸º **A4 (210mm Ã— 297mm)**ï¼š

```
åŸå§‹å°ºå¯¸: 595 Ã— 842 åƒç´  (72 DPI)
ç¼©æ”¾å:   892 Ã— 1263 åƒç´  (1.5x)

WebPæ–‡ä»¶å¤§å°: 
- æ–‡æœ¬ä¸ºä¸»: 50-150 KB/é¡µ
- å›¾è¡¨è¾ƒå¤š: 200-400 KB/é¡µ
- å›¾ç‰‡ä¸ºä¸»: 500-800 KB/é¡µ âš ï¸
```

#### Base64ç¼–ç åå¤§å°

```
Base64 = åŸå§‹å¤§å° Ã— 1.37

å¦‚æœ WebP = 800 KB/é¡µ
Base64 = 800 Ã— 1.37 = 1.096 MB/é¡µ

2é¡µæ‰¹æ¬¡ = 2.2 MB Base64 æ•°æ® âš ï¸
```

#### Cloudflare Workeré™åˆ¶

```
Free Plan:
- è¯·æ±‚ä½“å¤§å°é™åˆ¶: 100 MB âœ…ï¼ˆä¸ä¼šè¶…ï¼‰
- CPUæ—¶é—´é™åˆ¶: 10ms âŒï¼ˆå¯èƒ½è¶…ï¼‰
- å†…å­˜é™åˆ¶: 128 MB âœ…ï¼ˆä¸ä¼šè¶…ï¼‰
- å“åº”è¶…æ—¶: 30ç§’ âš ï¸ï¼ˆå¯èƒ½è¶…ï¼‰

Paid Plan:
- è¯·æ±‚ä½“å¤§å°é™åˆ¶: 500 MB
- CPUæ—¶é—´é™åˆ¶: 30ms
- å“åº”è¶…æ—¶: ä¸é™
```

---

### å¯èƒ½åŸå› 2ï¼š**Qwen APIè¶…æ—¶** âš ï¸

#### å½“å‰è¶…æ—¶è®¾ç½®

**æ–‡ä»¶**ï¼š`cloudflare-worker-qwen-vl-max.js:142-145`

```javascript
const timeoutId = setTimeout(() => {
    console.log('â° Worker è¶…æ—¶ (240 ç§’)');
    controller.abort();
}, 240000); // âœ… 240 ç§’è¶…æ—¶ (4 åˆ†é’Ÿ)
```

#### Qwen APIå¤„ç†æ—¶é—´

```
å•é¡µå›¾ç‰‡: 5-10 ç§’
ä¸¤é¡µå›¾ç‰‡: 10-20 ç§’
å¤æ‚å›¾ç‰‡: 20-40 ç§’ âš ï¸

å¦‚æœæ‰¹æ¬¡2å’Œ3çš„å›¾ç‰‡æ›´å¤æ‚ï¼š
â†’ å¤„ç†æ—¶é—´å¯èƒ½è¶…è¿‡240ç§’
â†’ Workerè¶…æ—¶å¹¶ä¸­æ–­è¯·æ±‚
â†’ JSONå“åº”ä¸å®Œæ•´
```

---

### å¯èƒ½åŸå› 3ï¼š**Qwen APIå†…éƒ¨é”™è¯¯** âš ï¸

#### APIç¨³å®šæ€§é—®é¢˜

```
åœºæ™¯1: APIæœåŠ¡å™¨è´Ÿè½½é«˜
â†’ è¿”å›5xxé”™è¯¯
â†’ æˆ–è¿”å›ä¸å®Œæ•´çš„å“åº”

åœºæ™¯2: APIå†…éƒ¨å¤„ç†é”™è¯¯
â†’ OCRè¯†åˆ«å¤±è´¥
â†’ è¿”å›é”™è¯¯çš„JSONæ ¼å¼

åœºæ™¯3: å›¾ç‰‡å†…å®¹é—®é¢˜
â†’ æ‰¹æ¬¡1çš„å›¾ç‰‡ç®€å•ï¼ˆæ–‡æœ¬ä¸ºä¸»ï¼‰
â†’ æ‰¹æ¬¡2/3çš„å›¾ç‰‡å¤æ‚ï¼ˆè¡¨æ ¼ã€å°ç« ã€æ‰‹å†™ï¼‰
â†’ APIå¤„ç†å¤±è´¥
```

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼š**é™ä½å›¾ç‰‡è´¨é‡å’Œå°ºå¯¸** âœ… **ä¼˜å…ˆ**

#### ä¿®æ”¹ `pdf-to-image-converter.js`

```javascript
// å½“å‰é…ç½®
const scale = 1.5;       // 1.5x ç¼©æ”¾
const quality = 0.85;    // 85% è´¨é‡

// âœ… ä¼˜åŒ–ä¸º
const scale = 1.2;       // 1.2x ç¼©æ”¾ï¼ˆå‡å°‘40%é¢ç§¯ï¼‰
const quality = 0.75;    // 75% è´¨é‡ï¼ˆæ–‡ä»¶å°30%ï¼‰
```

**æ•ˆæœ**ï¼š
- å›¾ç‰‡å¤§å°ï¼š800 KB/é¡µ â†’ **400 KB/é¡µ** (-50%)
- Base64å¤§å°ï¼š2.2 MB/æ‰¹æ¬¡ â†’ **1.1 MB/æ‰¹æ¬¡** (-50%)
- å¤„ç†æ—¶é—´ï¼š20ç§’/æ‰¹æ¬¡ â†’ **12ç§’/æ‰¹æ¬¡** (-40%)

---

### æ–¹æ¡ˆ2ï¼š**å¢åŠ é‡è¯•æœºåˆ¶** âœ…

#### ä¿®æ”¹ `qwen-vl-max-processor.js`

åœ¨ `processSingleBatch` æ–¹æ³•ä¸­æ·»åŠ é‡è¯•ï¼š

```javascript
async processSingleBatchWithRetry(files, documentType, maxRetries = 3) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            console.log(`ğŸ”„ æ‰¹æ¬¡å¤„ç†å°è¯• ${attempt}/${maxRetries}`);
            
            const result = await this.processSingleBatch(files, documentType);
            
            console.log(`âœ… æ‰¹æ¬¡å¤„ç†æˆåŠŸï¼ˆç¬¬ ${attempt} æ¬¡å°è¯•ï¼‰`);
            return result;
            
        } catch (error) {
            console.error(`âŒ æ‰¹æ¬¡å¤„ç†å¤±è´¥ï¼ˆç¬¬ ${attempt} æ¬¡å°è¯•ï¼‰:`, error.message);
            
            if (attempt < maxRetries) {
                // æŒ‡æ•°é€€é¿ï¼š1ç§’ã€2ç§’ã€4ç§’
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
                console.log(`â³ ${delay}ms åé‡è¯•...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                throw error; // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯
            }
        }
    }
}
```

---

### æ–¹æ¡ˆ3ï¼š**å‡å°æ‰¹æ¬¡å¤§å°** âœ…

#### ä¿®æ”¹ `qwen-vl-max-processor.js`

```javascript
// å½“å‰é…ç½®
const MAX_IMAGES_PER_REQUEST = 2;  // æ¯æ‰¹æ¬¡2é¡µ

// âœ… ä¼˜åŒ–ä¸º
const MAX_IMAGES_PER_REQUEST = 1;  // æ¯æ‰¹æ¬¡1é¡µï¼ˆæ›´ç¨³å®šï¼‰
```

**æ•ˆæœ**ï¼š
- æ‰¹æ¬¡æ•°ï¼š3æ‰¹æ¬¡ï¼ˆ2+2+2é¡µï¼‰â†’ **6æ‰¹æ¬¡**ï¼ˆ1é¡µ/æ‰¹æ¬¡ï¼‰
- å•æ‰¹æ¬¡å¤§å°ï¼š2.2 MB â†’ **1.1 MB** (-50%)
- å•æ‰¹æ¬¡å¤„ç†æ—¶é—´ï¼š20ç§’ â†’ **10ç§’** (-50%)
- æ€»å¤„ç†æ—¶é—´ï¼šå¯èƒ½å¢åŠ ï¼Œä½†æˆåŠŸç‡æé«˜

---

### æ–¹æ¡ˆ4ï¼š**å¢åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—** âœ…

#### ä¿®æ”¹ `qwen-vl-max-processor.js`

åœ¨ `processSingleBatch` ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

```javascript
async processSingleBatch(files, documentType) {
    const startTime = Date.now();
    
    try {
        // 1. è®°å½•æ‰¹æ¬¡ä¿¡æ¯
        console.log(`ğŸ“¦ æ‰¹æ¬¡ä¿¡æ¯:`);
        console.log(`   - é¡µæ•°: ${files.length}`);
        for (let i = 0; i < files.length; i++) {
            console.log(`   - æ–‡ä»¶${i+1}: ${files[i].name}, å¤§å°: ${(files[i].size / 1024).toFixed(0)} KB`);
        }
        
        // 2. è½¬æ¢ä¸ºBase64
        const imageContents = [];
        let totalBase64Size = 0;
        for (let i = 0; i < files.length; i++) {
            const base64Data = await this.fileToBase64(files[i]);
            const base64Size = base64Data.length;
            totalBase64Size += base64Size;
            console.log(`   - Base64 ${i+1}: ${(base64Size / 1024 / 1024).toFixed(2)} MB`);
            imageContents.push({
                type: 'image_url',
                image_url: {
                    url: `data:${files[i].type || 'image/webp'};base64,${base64Data}`
                }
            });
        }
        console.log(`ğŸ“Š æ€»Base64å¤§å°: ${(totalBase64Size / 1024 / 1024).toFixed(2)} MB`);
        
        // 3. æ£€æŸ¥å¤§å°é™åˆ¶
        if (totalBase64Size > 3 * 1024 * 1024) {  // 3 MB
            console.warn(`âš ï¸  Base64å¤§å°è¶…è¿‡3MBï¼Œå¯èƒ½å¯¼è‡´APIå¤±è´¥`);
        }
        
        // 4. è°ƒç”¨API
        console.log(`ğŸš€ å¼€å§‹è°ƒç”¨Qwen API...`);
        const requestBody = {
            model: this.qwenModel,
            messages: [
                {
                    role: 'user',
                    content: [
                        { type: 'text', text: this.generateMultiPagePrompt(documentType, files.length) },
                        ...imageContents
                    ]
                }
            ],
            temperature: 0.1,
            max_tokens: 4000
        };
        
        console.log(`ğŸ“Š è¯·æ±‚ä½“å¤§å°: ${(JSON.stringify(requestBody).length / 1024 / 1024).toFixed(2)} MB`);
        
        const response = await fetch(this.qwenWorkerUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log(`âœ… APIå“åº”çŠ¶æ€: ${response.status}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`âŒ APIé”™è¯¯å“åº”: ${errorText}`);
            throw new Error(`Qwen-VL API é”™è¯¯: ${response.status}`);
        }
        
        // 5. è§£æå“åº”
        const data = await response.json();
        console.log(`âœ… JSONè§£ææˆåŠŸ`);
        
        // 6. æå–å“åº”æ–‡æœ¬
        let responseText = '';
        if (data.choices && data.choices[0] && data.choices[0].message) {
            responseText = data.choices[0].message.content;
        }
        
        if (!responseText) {
            throw new Error('Qwen-VL æœªè¿”å›æœ‰æ•ˆå“åº”');
        }
        
        // 7. è§£æJSON
        const extractedData = this.parseJSON(responseText);
        
        const processingTime = Date.now() - startTime;
        console.log(`âœ… æ‰¹æ¬¡å¤„ç†å®Œæˆï¼Œè€—æ—¶ ${processingTime}ms`);
        
        return {
            success: true,
            documentType: documentType,
            extractedData: extractedData,
            rawResponse: responseText,
            processingTime: processingTime,
            usage: data.usage || {}
        };
        
    } catch (error) {
        const processingTime = Date.now() - startTime;
        console.error(`âŒ æ‰¹æ¬¡å¤„ç†å¤±è´¥ï¼Œè€—æ—¶ ${processingTime}ms`);
        console.error(`âŒ é”™è¯¯ç±»å‹: ${error.name}`);
        console.error(`âŒ é”™è¯¯ä¿¡æ¯: ${error.message}`);
        console.error(`âŒ é”™è¯¯å †æ ˆ:`, error.stack);
        throw error;
    }
}
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | é¢„æœŸæ•ˆæœ | é£é™© | æ¨èåº¦ |
|------|---------|---------|-----|--------|
| **æ–¹æ¡ˆ1: é™ä½å›¾ç‰‡è´¨é‡** | â­ ç®€å• | å‡å°‘50%å¤§å° | OCRå‡†ç¡®ç‡å¯èƒ½ä¸‹é™5% | â­â­â­â­â­ |
| **æ–¹æ¡ˆ2: å¢åŠ é‡è¯•æœºåˆ¶** | â­â­ ä¸­ç­‰ | æé«˜æˆåŠŸç‡30% | å¢åŠ å¤„ç†æ—¶é—´ | â­â­â­â­ |
| **æ–¹æ¡ˆ3: å‡å°æ‰¹æ¬¡å¤§å°** | â­ ç®€å• | æé«˜ç¨³å®šæ€§50% | å¢åŠ å¤„ç†æ—¶é—´100% | â­â­â­ |
| **æ–¹æ¡ˆ4: å¢å¼ºæ—¥å¿—** | â­ ç®€å• | ä¾¿äºè°ƒè¯• | æ—  | â­â­â­â­â­ |

---

## ğŸ¯ æ¨èå®æ–½é¡ºåº

### ç«‹å³å®æ–½ï¼ˆä»Šå¤©ï¼‰

1. **æ–¹æ¡ˆ4ï¼šå¢å¼ºæ—¥å¿—** âœ… 
   - äº†è§£é—®é¢˜æ ¹æº
   - 15åˆ†é’Ÿå®æ–½

2. **æ–¹æ¡ˆ1ï¼šé™ä½å›¾ç‰‡è´¨é‡** âœ…
   - scale: 1.5 â†’ 1.2
   - quality: 0.85 â†’ 0.75
   - 5åˆ†é’Ÿå®æ–½

3. **é‡æ–°æµ‹è¯•** âœ…
   - ä¸Šä¼ åŒä¸€ä¸ª6é¡µPDF
   - è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—
   - æŸ¥çœ‹Base64å¤§å°å’Œå¤„ç†æ—¶é—´

### åç»­ä¼˜åŒ–ï¼ˆæœ¬å‘¨ï¼‰

4. **æ–¹æ¡ˆ2ï¼šå¢åŠ é‡è¯•æœºåˆ¶** âš ï¸
   - å¦‚æœä»æœ‰å¤±è´¥ï¼Œæ·»åŠ é‡è¯•
   - 1å°æ—¶å®æ–½

5. **æ–¹æ¡ˆ3ï¼šå‡å°æ‰¹æ¬¡å¤§å°** âš ï¸
   - å¦‚æœä»ä¸ç¨³å®šï¼Œæ”¹ä¸º1é¡µ/æ‰¹æ¬¡
   - 5åˆ†é’Ÿå®æ–½

---

## âœ… æ€»ç»“

### é—®é¢˜1ç­”æ¡ˆï¼šä¸ºä»€ä¹ˆæ˜¾ç¤º"å¤±è´¥"ï¼Ÿ

âœ… **è¿™æ˜¯æ­£ç¡®çš„ï¼** å› ä¸º3ä¸ªæ‰¹æ¬¡ä¸­æœ‰2ä¸ªå¤±è´¥äº†ï¼Œæ‰€ä»¥æ–‡æ¡£è¢«æ ‡è®°ä¸º"å¤±è´¥"ã€‚

### é—®é¢˜2ç­”æ¡ˆï¼šä¸ºä»€ä¹ˆæ‰¹æ¬¡2/3å¤±è´¥ï¼Ÿ

âš ï¸ **æœ€å¯èƒ½çš„åŸå› **ï¼š
1. **å›¾ç‰‡æ–‡ä»¶å¤ªå¤§**ï¼ˆ800 KB/é¡µ â†’ Base64å2.2 MB/æ‰¹æ¬¡ï¼‰
2. **Qwen APIå¤„ç†è¶…æ—¶æˆ–å†…éƒ¨é”™è¯¯**
3. **æ‰¹æ¬¡2/3çš„å›¾ç‰‡å†…å®¹æ›´å¤æ‚**

### ç«‹å³è¡ŒåŠ¨

1. âœ… **å®æ–½æ–¹æ¡ˆ4ï¼šå¢å¼ºæ—¥å¿—**
2. âœ… **å®æ–½æ–¹æ¡ˆ1ï¼šé™ä½å›¾ç‰‡è´¨é‡**
3. âœ… **é‡æ–°æµ‹è¯•å¹¶è§‚å¯Ÿæ—¥å¿—**
4. âœ… **æ ¹æ®æ—¥å¿—ç»“æœå†³å®šä¸‹ä¸€æ­¥**

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**ï¼š2026-01-14 15:15  
**ä¸‹ä¸€æ­¥**ï¼šæ˜¯å¦ç«‹å³å®æ–½æ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ4ï¼Ÿ

