<!-- Exit Intent Popup - æŒ½ç•™è®¿å®¢ -->
<div id="exit-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 3rem; border-radius: 16px; max-width: 500px; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease-out;">
        <!-- å…³é—­æŒ‰é’® -->
        <button onclick="closeExitPopup()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 2rem; color: #9ca3af; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        
        <!-- å†…å®¹ -->
        <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ</div>
            <h2 style="font-size: 1.75rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">
                ç­‰ç­‰ï¼åˆ«é”™è¿‡è¿™ä¸ªä¼˜æƒ 
            </h2>
            <p style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1.5rem;">
                é¦–æ¬¡æ³¨å†Œç«‹äº« <strong style="color: #667eea; font-size: 1.5rem;">20%æŠ˜æ‰£</strong>
                <br>
                + å…è´¹è¯•ç”¨ <strong>20é¡µ</strong>
            </p>
            
            <!-- Emailè¾“å…¥ -->
            <form id="exit-email-form" style="margin-bottom: 1rem;" onsubmit="handleExitEmail(event)">
                <input 
                    type="email" 
                    id="exit-email" 
                    placeholder="è¾“å…¥æ‚¨çš„é‚®ç®±è·å–æŠ˜æ‰£ç "
                    required
                    style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; margin-bottom: 1rem;"
                >
                <button 
                    type="submit"
                    style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.125rem; font-weight: 700; cursor: pointer; transition: transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.02)'"
                    onmouseout="this.style.transform='scale(1)'"
                >
                    è·å–20%æŠ˜æ‰£ç  â†’
                </button>
            </form>
            
            <div id="exit-success" style="display: none; padding: 1rem; background: #d1fae5; border-radius: 8px; color: #065f46;">
                âœ… æŠ˜æ‰£ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼
            </div>
            
            <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 1rem;">
                ä¼˜æƒ ç æœ‰æ•ˆæœŸ24å°æ—¶ | ä»…é™é¦–æ¬¡æ³¨å†Œç”¨æˆ·
            </p>
        </div>
    </div>
</div>

<style>
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
// Exit Intent Detection
let exitPopupShown = false;

document.addEventListener('mouseleave', function(e) {
    // æ£€æµ‹é¼ æ ‡ç¦»å¼€é¡¶éƒ¨ï¼ˆå‡†å¤‡å…³é—­æ ‡ç­¾é¡µï¼‰
    if (e.clientY < 10 && !exitPopupShown && !localStorage.getItem('exitPopupShown')) {
        showExitPopup();
    }
});

function showExitPopup() {
    const popup = document.getElementById('exit-popup');
    if (popup) {
        popup.style.display = 'flex';
        exitPopupShown = true;
        
        // è®°å½•å·²æ˜¾ç¤ºï¼Œ24å°æ—¶å†…ä¸å†æ˜¾ç¤º
        localStorage.setItem('exitPopupShown', Date.now());
        
        // Google Analytics è¿½è¸ª
        if (typeof gtag !== 'undefined') {
            gtag('event', 'exit_intent_shown', {
                'event_category': 'engagement'
            });
        }
    }
}

function closeExitPopup() {
    const popup = document.getElementById('exit-popup');
    if (popup) {
        popup.style.display = 'none';
    }
}

async function handleExitEmail(e) {
    e.preventDefault();
    const email = document.getElementById('exit-email').value;
    
    // è¿™é‡Œåº”è¯¥å‘é€åˆ°åç«¯API
    // await fetch('/api/send-discount', { method: 'POST', body: JSON.stringify({email}) });
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    document.getElementById('exit-email-form').style.display = 'none';
    document.getElementById('exit-success').style.display = 'block';
    
    // Google Analytics è¿½è¸ª
    if (typeof gtag !== 'undefined') {
        gtag('event', 'exit_email_captured', {
            'event_category': 'lead_generation',
            'event_label': email
        });
    }
    
    // Facebook Pixel
    if (typeof fbq !== 'undefined') {
        fbq('track', 'Lead');
    }
    
    // 3ç§’åè‡ªåŠ¨å…³é—­å¹¶è·³è½¬åˆ°æ³¨å†Œé¡µ
    setTimeout(() => {
        closeExitPopup();
        window.location.href = 'auth.html?discount=EXIT20';
    }, 3000);
}

// æ¸…ç†è¿‡æœŸçš„localStorage
const popupTime = localStorage.getItem('exitPopupShown');
if (popupTime && (Date.now() - popupTime > 24 * 60 * 60 * 1000)) {
    localStorage.removeItem('exitPopupShown');
}
</script>