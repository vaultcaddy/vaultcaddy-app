# 📚 逐頁處理策略 - 支持 100+ 頁的大型 PDF

## 🎯 **核心問題**

### **DeepSeek-Chat 的限制：**

| 限制項 | 值 | 影響 |
|--------|-----|------|
| **上下文長度** | 128K tokens | ✅ 足夠（可以輸入100頁內容） |
| **輸出長度** | **最大 8K tokens** | ❌ **瓶頸**（100頁交易會超限） |

### **問題場景：**

**100 頁銀行對帳單：**
- 每頁 10 筆交易
- 總計 1000 筆交易
- 輸出 JSON 大小：~30K tokens
- **超出 DeepSeek 輸出限制 3.75 倍！** ❌

---

## ✅ **解決方案：逐頁處理**

### **處理流程：**

```
頁 1: OCR → 過濾 → DeepSeek → 提取10筆交易 → 保存
頁 2: OCR → 過濾 → DeepSeek → 提取10筆交易 → 保存
頁 3: OCR → 過濾 → DeepSeek → 提取10筆交易 → 保存
...
頁100: OCR → 過濾 → DeepSeek → 提取10筆交易 → 保存

最後：合併所有頁數據 → 生成完整報表（1000筆交易）
```

###人 **優勢：**

1. ✅ **支持任意頁數**
   - 100 頁 ✅
   - 1000 頁 ✅
   - 理論無限制

2. ✅ **不受輸出長度限制**
   - 每頁單獨處理
   - 輸出固定（~200 tokens/頁）

3. ✅ **失敗重試靈活**
   - 某頁失敗不影響其他頁
   - 可以單獨重試失敗的頁

4. ✅ **進度可視化**
   - 顯示：處理第 47/100 頁
   - 預估剩餘時間

### **劣勢：**

1. ❌ **調用次數多**
   - 100 頁 = 100 次 DeepSeek 調用
   - 成本：100 × ¥0.0003 = ¥0.03

2. ❌ **總處理時間長**
   - 100 頁 × 15 秒 = 25 分鐘
   - 需要異步處理 + 進度顯示

3. ❌ **網絡請求多**
   - 100 次 HTTP 請求
   - 網絡不穩定時風險高

---

## 🔄 **兩種處理策略對比**

### **策略 A：批量 OCR + 單次 DeepSeek（當前方案）**

**流程：**
```
OCR 頁1 → OCR 頁2 → OCR 頁3 → 合併 → DeepSeek（1次）
```

**特點：**
- ✅ DeepSeek 調用少（1次）
- ✅ 成本低
- ✅ 處理快
- ❌ **受輸出長度限制（最多 ~30 頁）**
- ❌ **不適合大型 PDF**

**適用場景：**
- 3-10 頁的銀行對帳單
- 1-5 頁的發票
- 小型文檔

---

### **策略 B：逐頁處理（新方案）**

**流程：**
```
頁1: OCR → DeepSeek
頁2: OCR → DeepSeek
頁3: OCR → DeepSeek
...
頁100: OCR → DeepSeek
→ 合併所有結果
```

**特點：**
- ✅ **支持任意頁數**
- ✅ **不受輸出限制**
- ✅ 失敗重試靈活
- ✅ 進度可視化
- ❌ DeepSeek 調用多（100次）
- ❌ 成本較高
- ❌ 處理時間長

**適用場景：**
- 10+ 頁的銀行對帳單
- 100+ 頁的交易記錄
- 大型文檔

---

## 💡 **智能選擇策略**

### **自動判斷：**

```javascript
function selectProcessingStrategy(pageCount, documentType) {
    // 小型文檔：批量處理
    if (pageCount <= 10) {
        return 'batch';  // 策略 A
    }
    
    // 中型文檔：批量處理（可能需要分批）
    if (pageCount <= 30) {
        return 'batch-split';  // 策略 A（分批）
    }
    
    // 大型文檔：逐頁處理
    if (pageCount > 30) {
        return 'sequential';  // 策略 B
    }
}
```

### **分批處理（策略 A+）：**

對於 11-30 頁的文檔，可以分批處理：

```
批次 1: 頁 1-10 → OCR → 合併 → DeepSeek → 提取數據
批次 2: 頁 11-20 → OCR → 合併 → DeepSeek → 提取數據
批次 3: 頁 21-30 → OCR → 合併 → DeepSeek → 提取數據
→ 合併所有批次的數據
```

**優勢：**
- 平衡成本和性能
- DeepSeek 調用：30 頁 = 3 次（而非 30 次）
- 不超出輸出限制

---

## 🚀 **實施計劃**

### **階段 1：實現逐頁處理（立即）**

**修改內容：**
1. 重寫 `processMultiPageDocument` 方法
2. 添加逐頁處理邏輯
3. 添加數據合併邏輯

**代碼位置：** `hybrid-vision-deepseek.js`

---

### **階段 2：添加智能選擇（短期）**

**功能：**
- 根據頁數自動選擇策略
- 3-10 頁：批量處理（策略 A）
- 10-30 頁：分批處理（策略 A+）
- 30+ 頁：逐頁處理（策略 B）

---

### **階段 3：優化用戶體驗（中期）**

**功能：**
1. **進度顯示**
   - 顯示：正在處理第 47/100 頁
   - 顯示：預估剩餘時間 15 分鐘

2. **後台處理**
   - 異步處理 + 輪詢狀態
   - 用戶可以關閉頁面，稍後查看結果

3. **失敗重試**
   - 自動重試失敗的頁面
   - 顯示失敗頁面列表

---

## 📊 **成本分析**

### **100 頁銀行對帳單：**

| 項目 | 策略 A（批量） | 策略 B（逐頁） |
|------|----------------|----------------|
| OCR 調用 | 100 次 | 100 次 |
| DeepSeek 調用 | **失敗**（超出限制） | 100 次 |
| Vision API 成本 | ¥0（免費 1000 次/月） | ¥0 |
| DeepSeek 成本 | - | ¥0.03 |
| 處理時間 | - | 25 分鐘 |
| **總成本** | **無法處理** ❌ | **¥0.03** ✅ |

### **結論：**

對於大型 PDF（30+ 頁），**逐頁處理是唯一可行的方案**！

---

## 🔧 **技術細節**

### **數據合併邏輯：**

#### **銀行對帳單：**
```javascript
合併規則：
- 基本信息：從第一頁提取（bankName, accountNumber, statementDate）
- 開始餘額：第一頁的 openingBalance
- 結束餘額：最後一頁的 closingBalance
- 交易記錄：合併所有頁的 transactions 數組
```

#### **發票：**
```javascript
合併規則：
- 基本信息：從第一頁提取（invoiceNumber, vendor, date）
- 項目列表：合併所有頁的 items 數組
- 總金額：重新計算（sum of all items）
```

---

### **進度顯示（前端）：**

```javascript
// 前端輪詢進度
async function uploadLargePDF(file) {
    // 1. 創建文檔
    const docId = await createDocument(file);
    
    // 2. 啟動後台處理
    await startProcessing(docId);
    
    // 3. 輪詢進度
    const interval = setInterval(async () => {
        const doc = await getDocument(docId);
        
        // 更新進度條
        updateProgress(doc.processedPages, doc.totalPages);
        
        // 完成或失敗，停止輪詢
        if (doc.status === 'completed' || doc.status === 'failed') {
            clearInterval(interval);
            showResult(doc);
        }
    }, 5000);  // 每 5 秒檢查一次
}
```

---

## 💰 **成本優化建議**

### **1. 批量折扣（未來）**

聯繫 DeepSeek，申請批量調用折扣：
- 單次調用：¥0.0003
- 批量調用（100+ 次）：¥0.0002（折扣 33%）

### **2. 緩存機制**

對於重複上傳的同一 PDF：
- 緩存 OCR 結果
- 緩存 DeepSeek 結果
- 避免重複處理

### **3. 增量處理**

對於更新的對帳單（如新增一頁）：
- 只處理新增的頁
- 不重新處理已處理的頁

---

## 🎯 **下一步行動**

1. **立即實施**：逐頁處理邏輯
2. **測試**：100 頁 PDF
3. **優化**：進度顯示
4. **文檔**：用戶指南

---

## 📞 **需要討論的問題**

1. **成本**：100 頁 = ¥0.03，用戶是否接受？
2. **時間**：25 分鐘處理時間，是否需要異步處理？
3. **失敗處理**：某頁失敗時，是否繼續處理其他頁？
4. **進度顯示**：是否需要實時進度條？

請告訴我您的想法！🚀

