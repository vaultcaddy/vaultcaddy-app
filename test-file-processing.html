<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VaultCaddy 文件處理測試</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .model-selector {
            margin-bottom: 2rem;
        }
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .model-card {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .model-card.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .model-card:hover {
            border-color: #3b82f6;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
        }
        .btn:hover {
            background: #2563eb;
        }
        .results {
            margin-top: 2rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            display: none;
        }
        .log {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-file-contract"></i> VaultCaddy 文件處理測試</h1>
        
        <div class="model-selector">
            <h3>選擇文檔類型</h3>
            <div class="model-grid">
                <div class="model-card active" data-model="bank-statement">
                    <i class="fas fa-university" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                    <h4>銀行對帳單</h4>
                </div>
                <div class="model-card" data-model="invoice">
                    <i class="fas fa-file-invoice" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                    <h4>發票</h4>
                </div>
                <div class="model-card" data-model="receipt">
                    <i class="fas fa-receipt" style="font-size: 2rem; color: #059669; margin-bottom: 0.5rem;"></i>
                    <h4>收據</h4>
                </div>
                <div class="model-card" data-model="general">
                    <i class="fas fa-file-alt" style="font-size: 2rem; color: #f59e0b; margin-bottom: 0.5rem;"></i>
                    <h4>一般文檔</h4>
                </div>
            </div>
        </div>
        
        <div class="upload-area" id="upload-area">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #6b7280; margin-bottom: 1rem;"></i>
            <h3>拖放文件到這裡或點擊選擇</h3>
            <p style="color: #6b7280;">支援 PDF, JPG, PNG 格式，最大 10MB</p>
            <input type="file" id="file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
        </div>
        
        <div style="text-align: center; margin-top: 1rem;">
            <button class="btn" onclick="testWithSampleData()">
                <i class="fas fa-play"></i> 使用範例數據測試
            </button>
            <button class="btn" onclick="clearLog()">
                <i class="fas fa-trash"></i> 清除日誌
            </button>
        </div>
        
        <div class="results" id="results">
            <h3>處理結果</h3>
            <div id="result-content"></div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="config.js"></script>
    <script src="enhanced-file-processor.js"></script>
    
    <script>
        // 初始化用戶Credits
        if (!localStorage.getItem('userCredits')) {
            localStorage.setItem('userCredits', '50');
        }
        
        // 日誌函數
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#3b82f6',
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b'
            };
            
            logElement.innerHTML += `<div style="color: ${colors[type]};">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 模型選擇
        document.querySelectorAll('.model-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.model-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                log(`已選擇文檔類型: ${this.getAttribute('data-model')}`, 'info');
            });
        });
        
        // 文件上傳處理
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#3b82f6';
            uploadArea.style.background = '#eff6ff';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#d1d5db';
            uploadArea.style.background = '#f9fafb';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#d1d5db';
            uploadArea.style.background = '#f9fafb';
            
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
        
        // 處理文件
        async function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            const selectedModel = document.querySelector('.model-card.active');
            const documentType = selectedModel.getAttribute('data-model');
            
            log(`開始處理 ${files.length} 個文件 (${documentType})`, 'info');
            
            // 監聽進度事件
            window.addEventListener('batchProgress', (event) => {
                const { progress, processed, total } = event.detail;
                log(`處理進度: ${processed}/${total} (${progress}%)`, 'info');
            });
            
            window.addEventListener('documentProcessed', (event) => {
                const { file, result } = event.detail;
                log(`文件 ${file} 處理${result.status === 'success' ? '成功' : '失敗'}`, result.status === 'success' ? 'success' : 'error');
            });
            
            try {
                const result = await window.VaultCaddyProcessor.batchProcess(files, documentType);
                showResults(result);
                log(`批次處理完成！成功: ${result.successfulFiles}/${result.totalFiles}`, 'success');
            } catch (error) {
                log(`處理失敗: ${error.message}`, 'error');
            }
        }
        
        // 顯示結果
        function showResults(result) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('result-content');
            
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 6px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #059669;">${result.successfulFiles}</div>
                        <div>成功處理</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #fef2f2; border-radius: 6px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">${result.totalFiles - result.successfulFiles}</div>
                        <div>處理失敗</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 6px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">${Math.round((result.successfulFiles / result.totalFiles) * 100)}%</div>
                        <div>成功率</div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn" onclick="downloadCSV()">下載 CSV</button>
                    <button class="btn" onclick="downloadJSON()">下載 JSON</button>
                    ${result.documentType === 'bank-statement' ? '<button class="btn" onclick="downloadQBO()">下載 QBO</button>' : ''}
                </div>
                
                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; font-weight: bold;">查看詳細結果</summary>
                    <pre style="background: #f3f4f6; padding: 1rem; border-radius: 6px; overflow-x: auto; margin-top: 0.5rem;">${JSON.stringify(result, null, 2)}</pre>
                </details>
            `;
            
            resultsDiv.style.display = 'block';
            window.lastResult = result;
        }
        
        // 下載功能
        function downloadCSV() {
            if (!window.lastResult) return;
            const content = window.VaultCaddyProcessor.exportToCSV(window.lastResult.results, window.lastResult.documentType);
            window.VaultCaddyProcessor.downloadFile(content, `test_${window.lastResult.documentType}.csv`, 'text/csv');
            log('CSV 文件已下載', 'success');
        }
        
        function downloadJSON() {
            if (!window.lastResult) return;
            const content = window.VaultCaddyProcessor.exportToJSON(window.lastResult.results);
            window.VaultCaddyProcessor.downloadFile(content, `test_${window.lastResult.documentType}.json`, 'application/json');
            log('JSON 文件已下載', 'success');
        }
        
        function downloadQBO() {
            if (!window.lastResult) return;
            const content = window.VaultCaddyProcessor.exportToQuickBooks(window.lastResult.results, window.lastResult.documentType);
            window.VaultCaddyProcessor.downloadFile(content, `test_${window.lastResult.documentType}.qbo`, 'application/vnd.intu.qbo');
            log('QBO 文件已下載', 'success');
        }
        
        // 使用範例數據測試
        async function testWithSampleData() {
            log('開始範例數據測試...', 'info');
            
            // 創建模擬文件
            const mockFile = new File(['mock pdf content'], 'sample-bank-statement.pdf', {
                type: 'application/pdf'
            });
            
            await handleFiles([mockFile]);
        }
        
        // 初始化日誌
        log('VaultCaddy 文件處理測試頁面已載入', 'success');
        log(`當前用戶Credits: ${localStorage.getItem('userCredits')}`, 'info');
    </script>
</body>
</html>
