# ğŸ” æ£€æŸ¥ç”¨æˆ·è®¢é˜…æ•°æ®

## ğŸ¯ éœ€è¦ç¡®è®¤çš„é—®é¢˜

`reportUsageToStripe` è°ƒç”¨çš„æ¡ä»¶ï¼š
```javascript
const hasSubscription = userData?.subscription?.stripeSubscriptionId;
const isTestMode = userData?.isTestMode || false;

if (hasSubscription || isTestMode) {
    await reportUsageToStripe(userId, amount);
}
```

å¦‚æœä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œ`reportUsageToStripe` å°±ä¸ä¼šè¢«è°ƒç”¨ã€‚

---

## ğŸ“‹ æ£€æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæ‰“å¼€ Firestore
1. è®¿é—®ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore
2. è¿›å…¥ `users` é›†åˆ
3. æ‰¾åˆ°ä½ çš„ç”¨æˆ·æ–‡æ¡£ï¼ˆ`3bLhZuU9H0b3ExhwFCJuN4vZeGb2`ï¼‰

### æ­¥éª¤2ï¼šæ£€æŸ¥å­—æ®µ
æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹å­—æ®µï¼š

#### âœ… subscription.stripeSubscriptionId
```
subscription: {
    stripeSubscriptionId: "sub_xxxxx",
    status: "canceled" æˆ– "active",
    ...
}
```

#### âœ… isTestMode
```
isTestMode: true
```

å¦‚æœ**ä¸¤ä¸ªéƒ½æ²¡æœ‰**ï¼Œé‚£å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼

---

## ğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœä½ çš„ç”¨æˆ·æ•°æ®ä¸­æ²¡æœ‰è¿™ä¸¤ä¸ªå­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

### æ–¹æ¡ˆAï¼šæ·»åŠ  isTestMode
åœ¨ Firestore ä¸­æ‰‹åŠ¨æ·»åŠ ï¼š
```
users/3bLhZuU9H0b3ExhwFCJuN4vZeGb2
  isTestMode: true
```

### æ–¹æ¡ˆBï¼šä¿®æ”¹ä»£ç é€»è¾‘
ä¿®æ”¹åç«¯ä»£ç ï¼Œå…è®¸æ‰€æœ‰ç”¨æˆ·æŠ¥å‘Šä½¿ç”¨é‡ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰

---

## ğŸš¨ è¯·å…ˆæˆªå›¾ Firestore æ•°æ®

è¯·æˆªå›¾ Firestore ä¸­ä½ çš„ç”¨æˆ·æ–‡æ¡£ï¼Œè®©æˆ‘çœ‹çœ‹ï¼š
1. æ˜¯å¦æœ‰ `subscription` å¯¹è±¡
2. `subscription.stripeSubscriptionId` çš„å€¼
3. æ˜¯å¦æœ‰ `isTestMode` å­—æ®µ
4. `isTestMode` çš„å€¼

è¿™æ ·æˆ‘æ‰èƒ½ç¡®å®šé—®é¢˜æ‰€åœ¨ï¼


