# ğŸš¨ ä¸‰ä¸ªå…³é”®é—®é¢˜ - å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ“‹ **é—®é¢˜æ±‡æ€»**

ä»æœ€æ–°çš„æµ‹è¯•å’Œæ—¥å¿—ä¸­ï¼Œå‘ç°äº† 3 ä¸ªä¸¥é‡é—®é¢˜ï¼š

---

## âŒ **é—®é¢˜ 1ï¼šStripe æµ‹è¯•äº§å“ Metadata æœªæ­£ç¡®é…ç½®**

### **æ—¥å¿—è¯æ®**
```
âš ï¸ ç”¢å“ VaultCaddy æœˆè²» test (prod_TZsmHUx2KVga8H) æ²’æœ‰é…ç½® creditsï¼Œè·³éæ·»åŠ 
ğŸ“Š è¨‚é–±è©³æƒ…: { planType: 'monthly', monthlyCredits: 0, status: 'active' }
```

### **åŸå› **
Stripe æµ‹è¯•æ¨¡å¼äº§å“çš„ metadata ä¸­ï¼š
- `monthly_credits` ä¸º 0 æˆ–æœªé…ç½®
- `credits` ä¸º 0 æˆ–æœªé…ç½®

### **âœ… è§£å†³æ–¹æ¡ˆ**

1. æ‰“å¼€ Stripe Dashboardï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
   https://dashboard.stripe.com/test/products/prod_TZsmHUx2KVga8H

2. ç‚¹å‡»äº§å“åç§°è¿›å…¥è¯¦æƒ…é¡µé¢

3. æ‰¾åˆ° **"Metadata"** éƒ¨åˆ†

4. æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹ Metadataï¼š
   - **é”®**: `monthly_credits`
   - **å€¼**: `100`

5. ç‚¹å‡» **"ä¿å­˜"**

---

## âŒ **é—®é¢˜ 2ï¼šæ—¶é—´æˆ³è½¬æ¢é”™è¯¯**

### **æ—¥å¿—è¯æ®**
```
âŒ å¤„ç†webhookäº‹ä»¶æ—¶å‘ç”Ÿé”™è¯¯: Error: Value for argument "seconds" is not a valid integer.
```

### **åŸå› **
`handleSubscriptionChange` å‡½æ•°ä¸­ä½¿ç”¨äº† `new Date()` å¯¹è±¡ï¼Œæ— æ³•ç›´æ¥ä¿å­˜åˆ° Firestoreã€‚

### **âœ… è§£å†³æ–¹æ¡ˆ**

**çŠ¶æ€**: âœ… **å·²ä¿®å¤å¹¶éƒ¨ç½²**

ä¿®å¤ä»£ç ï¼š
```javascript
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
currentPeriodStart: new Date(subscription.current_period_start * 1000),

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
currentPeriodStart: admin.firestore.Timestamp.fromMillis(subscription.current_period_start * 1000),
```

---

## âŒ **é—®é¢˜ 3ï¼šæ–°ç”¨æˆ·çš„ Firestore æ–‡æ¡£æœªåˆ›å»º**

### **æ—¥å¿—è¯æ®**
```
ğŸ” é–‹å§‹æŸ¥æ‰¾ç”¨æˆ¶: kt13partyroom@gmail.com
ğŸ“Š æŸ¥æ‰¾çµæœ: æ‰¾åˆ° 0 å€‹ç”¨æˆ¶
âŒ æ‰¾ä¸åˆ°ç”¨æˆ¶: kt13partyroom@gmail.com
```

### **åŸå› **
ç”¨æˆ·æ³¨å†Œæ—¶ï¼ŒFirestore ç”¨æˆ·æ–‡æ¡£æ²¡æœ‰æˆåŠŸåˆ›å»ºã€‚

**å¯èƒ½çš„åŸå› ï¼š**
1. æµè§ˆå™¨ä½¿ç”¨äº†ç¼“å­˜çš„æ—§ç‰ˆ `simple-auth.js`
2. Firestore å®‰å…¨è§„åˆ™é˜»æ­¢äº†åˆ›å»ºæ“ä½œ
3. æ³¨å†Œæ—¶å‡ºç°äº†é”™è¯¯ï¼ˆè¢«æ•è·ï¼Œæ²¡æœ‰æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰

### **âœ… è§£å†³æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨ä¸ºç°æœ‰ç”¨æˆ·æ·»åŠ  email å­—æ®µï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰**

**å¯¹äºç”¨æˆ·**: `PxOIosAk2nUmi6x647YIdniiuFC3`ï¼ˆvaultcaddy@gmail.comï¼‰

1. åœ¨ Firebase Console ä¸­æ‰“å¼€è¯¥ç”¨æˆ·æ–‡æ¡£
2. ç‚¹å‡» **"æ·»åŠ å­—æ®µ"**
3. æ·»åŠ ï¼š
   - **å­—æ®µåç§°**: `email`
   - **ç±»å‹**: `string`
   - **å€¼**: `vaultcaddy@gmail.com`
4. ä¿å­˜

**å¯¹äºç”¨æˆ·**: `kt13partyroom@gmail.com`

éœ€è¦å…ˆæ‰¾åˆ°è¯¥ç”¨æˆ·çš„ Firebase Auth UIDï¼Œç„¶åæ‰‹åŠ¨åˆ›å»º Firestore æ–‡æ¡£ã€‚

### **âœ… è§£å†³æ–¹æ¡ˆ Bï¼šé‡æ–°æ³¨å†Œæ–°ç”¨æˆ·ï¼ˆæµ‹è¯•ä¿®å¤åçš„ä»£ç ï¼‰**

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - æŒ‰ `Ctrl+Shift+Delete`ï¼ˆWindowsï¼‰æˆ– `Cmd+Shift+Delete`ï¼ˆMacï¼‰
   - é€‰æ‹© **"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"**
   - ç‚¹å‡» **"æ¸…é™¤æ•°æ®"**

2. **å¼ºåˆ¶åˆ·æ–°é¡µé¢**
   - æŒ‰ `Ctrl+F5`ï¼ˆWindowsï¼‰æˆ– `Cmd+Shift+R`ï¼ˆMacï¼‰

3. **é‡æ–°æ³¨å†Œæ–°ç”¨æˆ·**
   - è®¿é—® https://vaultcaddy.com/auth.html
   - ä½¿ç”¨ä¸€ä¸ªæ–°çš„ emailï¼ˆå¦‚ `test456@gmail.com`ï¼‰
   - æ³¨å†Œ

4. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**
   - æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹ Console æ ‡ç­¾
   
   **é¢„æœŸæ—¥å¿—ï¼š**
   ```
   ğŸ“ æ­£åœ¨è¨»å†Š... test456@gmail.com
   ğŸ“ æ­£åœ¨å‰µå»º Firestore ç”¨æˆ¶æ–‡æª”...
      ç”¨æˆ¶ ID: xxxxx
      Email: test456@gmail.com
   âœ… Firestore ç”¨æˆ¶æ–‡æª”å·²å‰µå»º
   âœ… ç”¨æˆ¶æ–‡æª”é©—è­‰æˆåŠŸï¼Œemail å­—æ®µ: test456@gmail.com
   âœ… è¨»å†ŠæˆåŠŸ
   ```

5. **åœ¨ Firebase Console ä¸­éªŒè¯**
   - æ‰“å¼€ Firestore Database
   - æŸ¥æ‰¾æ–°åˆ›å»ºçš„ç”¨æˆ·
   - ç¡®è®¤æœ‰ `email` å­—æ®µ

---

## ğŸ§ª **å®Œæ•´æµ‹è¯•æµç¨‹**

### **æ­¥éª¤ 1ï¼šä¿®å¤ Stripe äº§å“ Metadata**

1. æ‰“å¼€ Stripe Dashboardï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
2. æ‰¾åˆ°äº§å“ **"VaultCaddy æœˆè²» test"**
3. æ·»åŠ  Metadataï¼š`monthly_credits` = `100`
4. ä¿å­˜

---

### **æ­¥éª¤ 2ï¼šé‡æ–°æ³¨å†Œæ–°ç”¨æˆ·ï¼ˆæ¨èï¼‰**

1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. å¼ºåˆ¶åˆ·æ–° https://vaultcaddy.com/auth.html
3. ä½¿ç”¨æ–° email æ³¨å†Œï¼ˆå¦‚ `test789@gmail.com`ï¼‰
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤ Firestore æ–‡æ¡£åˆ›å»ºæˆåŠŸ

---

### **æ­¥éª¤ 3ï¼šéªŒè¯ Email**

1. æ£€æŸ¥æ”¶ä»¶ç®±ï¼Œè·å–éªŒè¯ç 
2. åœ¨éªŒè¯é¡µé¢è¾“å…¥éªŒè¯ç 
3. æŸ¥çœ‹ Firebase Consoleï¼Œç¡®è®¤ Credits ä» 0 å¢åŠ åˆ° 20

---

### **æ­¥éª¤ 4ï¼šæµ‹è¯• Stripe æ”¯ä»˜**

1. ç™»å½•æ–°ç”¨æˆ·
2. è®¿é—® https://vaultcaddy.com/billing.html
3. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
4. ä½¿ç”¨æµ‹è¯•å¡ï¼š**4242 4242 4242 4242**
5. å®Œæˆæ”¯ä»˜

---

### **æ­¥éª¤ 5ï¼šç¡®è®¤ Credits å¢åŠ **

1. åˆ·æ–° Firebase Console
2. æŸ¥çœ‹ç”¨æˆ·çš„ `credits` å’Œ `currentCredits` å­—æ®µ
3. åº”è¯¥ä» 20 å¢åŠ åˆ° 120
4. å‰ç«¯åº”è¯¥æ˜¾ç¤º `Credits: 120`

---

## ğŸ“Š **ä¿®å¤æ¸…å•**

### **Firebase Functions** âœ…
- âœ… `addCredits` å‡½æ•°åŒæ—¶æ›´æ–° `credits` å’Œ `currentCredits`
- âœ… `handleSubscriptionChange` æ—¶é—´æˆ³è½¬æ¢é”™è¯¯å·²ä¿®å¤
- âœ… `verifyCode` å‡½æ•°åŒæ—¶æ›´æ–° `credits` å’Œ `currentCredits`
- âœ… å·²é‡æ–°éƒ¨ç½²

### **Frontend** âœ…
- âœ… `simple-auth.js` æ³¨å†Œæ—¶åˆ›å»º `email` å­—æ®µ
- âœ… Email ç»Ÿä¸€è½¬æ¢ä¸ºå°å†™
- âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### **Stripe Metadata** âŒ
- âŒ **éœ€è¦æ‰‹åŠ¨é…ç½®**: `monthly_credits` = `100`

---

## ğŸ“ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

**è¯·æŒ‰é¡ºåºæ‰§è¡Œï¼š**

1. **ä¿®å¤ Stripe Metadata**ï¼ˆ2 åˆ†é’Ÿï¼‰
   - æ‰“å¼€ Stripe Dashboard æµ‹è¯•æ¨¡å¼
   - äº§å“ï¼šVaultCaddy æœˆè²» test
   - æ·»åŠ  Metadataï¼š`monthly_credits` = `100`

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°æ³¨å†Œæ–°ç”¨æˆ·**ï¼ˆ3 åˆ†é’Ÿï¼‰
   - æ¸…é™¤ç¼“å­˜
   - å¼ºåˆ¶åˆ·æ–°é¡µé¢
   - ä½¿ç”¨æ–° email æ³¨å†Œ

3. **éªŒè¯ Email å¹¶æµ‹è¯•æ”¯ä»˜**ï¼ˆ5 åˆ†é’Ÿï¼‰
   - éªŒè¯ email
   - ç¡®è®¤ Credits å¢åŠ åˆ° 20
   - æµ‹è¯•æ”¯ä»˜
   - ç¡®è®¤ Credits å¢åŠ åˆ° 120

**å®Œæˆåå‘Šè¯‰æˆ‘æ¯ä¸€æ­¥çš„ç»“æœï¼** ğŸ™

---

## ğŸ¯ **é¢„æœŸç»“æœ**

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼š
1. âœ… æ³¨å†ŒæˆåŠŸï¼ŒFirestore ä¸­æœ‰ `email` å­—æ®µ
2. âœ… Email éªŒè¯åï¼ŒCredits ä» 0 å¢åŠ åˆ° 20
3. âœ… Stripe æ”¯ä»˜åï¼ŒCredits ä» 20 å¢åŠ åˆ° 120
4. âœ… å‰ç«¯æ­£ç¡®æ˜¾ç¤º Credits

