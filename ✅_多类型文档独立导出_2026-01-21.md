# ✅ 多类型文档独立导出修复

## 📋 用户需求
当用户同时选择**银行对账单**和**发票**时，点击导出（如Excel或QBO），应该导出**2个独立的文件**：
1. `BankStatement_YYYY-MM-DD.xlsx` / `.qbo` - 银行对账单
2. `Invoice_YYYY-MM-DD.xlsx` / `.qbo` - 发票

**之前的行为**：
- Excel: 导出1个文件，包含2个工作表（Bank Statements 和 Invoices）
- QBO: 只导出1个文件（要么银行对账单，要么发票）

**期望的行为**：
- Excel: 导出2个独立的 `.xlsx` 文件
- QBO: 导出2个独立的 `.qbo` 文件

---

## ✅ 已完成的更改

### 修改文件
`firstproject.html`

### 修改位置
1. **Excel导出**: 第 4449-4505 行 → 修改为独立文件导出
2. **QBO导出**: 第 4678-4701 行 → 修改为独立文件导出

---

## 🔧 技术实现

### 1️⃣ Excel 导出修复（第 4449-4505 行）

#### **修改前**：
```javascript
case 'excel':
    const wb = XLSX.utils.book_new();
    
    // 银行对账单工作表
    if (groupedDocs.bank_statements.length > 0) {
        XLSX.utils.book_append_sheet(wb, ws, "Bank Statements");
    }
    
    // 发票工作表
    if (groupedDocs.invoices.length > 0) {
        XLSX.utils.book_append_sheet(wb, ws, "Invoices");
    }
    
    // 导出为单个文件
    fileName = `VaultCaddy_Export_${dateStr}.xlsx`;
    XLSX.writeFile(wb, fileName);
```

**问题**：所有数据都添加到同一个工作簿（workbook），导出为1个文件。

#### **修改后**：
```javascript
case 'excel':
    const dateStr = new Date().toISOString().split('T')[0];
    let exportedCount = 0;
    
    // 1️⃣ 导出银行对账单为独立文件
    if (groupedDocs.bank_statements.length > 0) {
        const wb = XLSX.utils.book_new(); // 新建独立工作簿
        const excelData = [['Date', 'Type', 'Description', 'Payee', 'Reference', 'Amount', 'Balance']];
        // ... 添加数据 ...
        XLSX.utils.book_append_sheet(wb, ws, "Bank Statements");
        
        fileName = `BankStatement_${dateStr}.xlsx`; // 独立文件名
        XLSX.writeFile(wb, fileName);
        exportedCount++;
    }
    
    // 2️⃣ 导出发票为独立文件
    if (groupedDocs.invoices.length > 0) {
        const wb = XLSX.utils.book_new(); // 新建独立工作簿
        const excelData = [['Invoice Number', 'Date', 'Supplier', 'Amount', 'Status']];
        // ... 添加数据 ...
        XLSX.utils.book_append_sheet(wb, ws, "Invoices");
        
        fileName = `Invoice_${dateStr}.xlsx`; // 独立文件名
        XLSX.writeFile(wb, fileName);
        exportedCount++;
    }
    
    alert(`✅ 導出成功！\n已下載 ${exportedCount} 個 Excel 文件`);
```

**改进**：
- ✅ 每种类型创建独立的工作簿
- ✅ 使用不同的文件名（`BankStatement_` 和 `Invoice_`）
- ✅ 显示导出文件数量

---

### 2️⃣ QBO 导出修复（第 4678-4723 行）

#### **修改前**：
```javascript
case 'qbo':
    const qboBankDocs = docsToExport.filter(d => 
        (d.documentType || d.type || '').toLowerCase().includes('bank')
    );
    const qboInvoiceDocs = docsToExport.filter(d => 
        (d.documentType || d.type || '').toLowerCase().includes('invoice')
    );
    
    // 只导出一种类型
    if (qboBankDocs.length > 0) {
        exportContent = generateQBO(qboBankDocs);
        fileName = `BankStatement_${dateStr}.qbo`;
    } else if (qboInvoiceDocs.length > 0) {
        exportContent = generateQBO(qboInvoiceDocs);
        fileName = `Invoice_${dateStr}.qbo`;
    }
    mimeType = 'application/vnd.intu.qbo;charset=utf-8;';
    break;
    
// 通用下载代码（在 switch 之外）
const blob = new Blob([exportContent], { type: mimeType });
const link = document.createElement('a');
link.href = URL.createObjectURL(blob);
link.download = fileName;
link.click();
```

**问题**：使用 `if...else if` 只导出一种类型，优先导出银行对账单。

#### **修改后**：
```javascript
case 'qbo':
    const dateStr = new Date().toISOString().split('T')[0];
    let exportedCount = 0;
    
    // 1️⃣ 导出银行对账单 QBO
    if (groupedDocs.bank_statements.length > 0) {
        const qboContent = generateQBO(groupedDocs.bank_statements);
        const blob = new Blob([qboContent], { type: 'application/vnd.intu.qbo;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `BankStatement_${dateStr}.qbo`;
        link.click();
        exportedCount++;
    }
    
    // 2️⃣ 导出发票 QBO
    if (groupedDocs.invoices.length > 0) {
        const qboContent = window.InvoiceExport && window.InvoiceExport.generateQBO ? 
            window.InvoiceExport.generateQBO(groupedDocs.invoices) :
            generateQBO(groupedDocs.invoices);
        const blob = new Blob([qboContent], { type: 'application/vnd.intu.qbo;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Invoice_${dateStr}.qbo`;
        link.click();
        exportedCount++;
    }
    
    alert(`✅ 導出成功！\n已下載 ${exportedCount} 個 QBO 文件`);
    return; // 直接返回，不执行通用下载代码
```

**改进**：
- ✅ 使用独立的 `if` 语句，而不是 `if...else if`
- ✅ 每种类型独立生成 Blob 和下载链接
- ✅ 使用 `return` 退出，避免执行通用下载代码
- ✅ 显示导出文件数量

---

## 🎯 导出逻辑对比

### 修改前：
| 格式 | 选中银行对账单 | 选中发票 | 同时选中两者 |
|------|-------------|---------|------------|
| Excel | 1个文件（1个工作表） | 1个文件（1个工作表） | **1个文件（2个工作表）** ❌ |
| QBO | 1个文件 | 1个文件 | **1个文件（优先银行对账单）** ❌ |

### 修改后：
| 格式 | 选中银行对账单 | 选中发票 | 同时选中两者 |
|------|-------------|---------|------------|
| Excel | 1个文件（1个工作表） | 1个文件（1个工作表） | **2个文件** ✅ |
| QBO | 1个文件 | 1个文件 | **2个文件** ✅ |

---

## 📁 导出文件命名规则

### Excel：
- **银行对账单**: `BankStatement_YYYY-MM-DD.xlsx`
- **发票**: `Invoice_YYYY-MM-DD.xlsx`

### QBO：
- **银行对账单**: `BankStatement_YYYY-MM-DD.qbo`
- **发票**: `Invoice_YYYY-MM-DD.qbo`

---

## 🧪 测试步骤

### 步骤 1: 打开项目页面
```
https://vaultcaddy.com/firstproject.html?project=SJJkhY7CFdqh8zyVAM6B
```

### 步骤 2: 选择多个文档
1. 勾选至少1个**银行对账单**
2. 勾选至少1个**发票**
3. 确认两种类型都已选中

### 步骤 3: 导出 Excel
1. 点击 **Export** 按钮
2. 选择 **Excel (.xlsx)**
3. 等待下载

**预期结果**：
- ✅ 下载2个文件：
  - `BankStatement_2026-01-21.xlsx`
  - `Invoice_2026-01-21.xlsx`
- ✅ 弹出消息："✅ 導出成功！已下載 2 個 Excel 文件"

### 步骤 4: 导出 QBO
1. 点击 **Export** 按钮
2. 选择 **QBO 文件**
3. 等待下载

**预期结果**：
- ✅ 下载2个文件：
  - `BankStatement_2026-01-21.qbo`
  - `Invoice_2026-01-21.qbo`
- ✅ 弹出消息："✅ 導出成功！已下載 2 個 QBO 文件"

---

## 📊 文件内容验证

### BankStatement_2026-01-21.xlsx
- **工作表**: Bank Statements
- **列**: Date, Type, Description, Payee, Reference, Amount, Balance
- **数据**: 所有选中的银行对账单的交易记录

### Invoice_2026-01-21.xlsx
- **工作表**: Invoices
- **列**: Invoice Number, Date, Supplier, Amount, Status
- **数据**: 所有选中的发票的基本信息

### BankStatement_2026-01-21.qbo
- **格式**: OFX (QBO)
- **交易类型**: DEBIT / CREDIT
- **数据**: 所有选中的银行对账单的交易记录

### Invoice_2026-01-21.qbo
- **格式**: OFX (QBO)
- **交易类型**: INVOICE
- **数据**: 所有选中的发票的交易记录

---

## ✅ 优点

### 1️⃣ **更清晰的文件组织**
- 银行对账单和发票分别存储
- 文件名明确标识内容类型

### 2️⃣ **更好的会计软件兼容性**
- QuickBooks Online 可以分别导入银行对账单和发票
- 避免混淆不同类型的数据

### 3️⃣ **更灵活的数据管理**
- 用户可以选择只打开某一类型的文件
- 便于分类存档和备份

### 4️⃣ **向后兼容**
- 如果只选择一种类型，行为与之前一致
- 只影响同时选择多种类型的情况

---

## 🔗 相关文档
- `✅_Excel导出分类和日期优化_2026-01-21.md` - Excel导出格式优化
- `✅_document-detail启用QBO导出_2026-01-21.md` - QBO导出功能启用

---

**创建时间**: 2026-01-21  
**作者**: VaultCaddy AI Assistant  
**相关文件**: `firstproject.html`

