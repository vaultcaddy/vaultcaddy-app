<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VaultCaddy è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .diagnostic-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .code-block {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 0.5rem 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        button:hover { background: #0056b3; }
        .clear-btn { background: #dc3545; }
        .clear-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>ğŸ”§ VaultCaddy ç³»çµ±è¨ºæ–·å·¥å…·</h1>
    
    <div class="diagnostic-section">
        <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
        <div id="system-status">æ­£åœ¨æª¢æŸ¥...</div>
        <button onclick="checkSystemStatus()">é‡æ–°æª¢æŸ¥</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>ğŸ”‘ API Key ç‹€æ…‹</h2>
        <div id="api-status">æ­£åœ¨æª¢æŸ¥...</div>
        <input type="text" id="api-key-input" placeholder="è¼¸å…¥ Google AI API Key" style="width: 300px; padding: 0.5rem;">
        <button onclick="setApiKey()">è¨­ç½® API Key</button>
        <button onclick="testApiKey()">æ¸¬è©¦ API Key</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>ğŸ’¾ å­˜å„²ç‹€æ…‹æª¢æŸ¥</h2>
        <div id="storage-status">æ­£åœ¨æª¢æŸ¥...</div>
        <button onclick="checkStorage()">æª¢æŸ¥å­˜å„²</button>
        <button onclick="clearAllStorage()" class="clear-btn">æ¸…ç†æ‰€æœ‰å­˜å„²</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>ğŸ§ª æ¸¬è©¦æ–‡ä»¶è™•ç†</h2>
        <div id="processing-status">ç­‰å¾…æ¸¬è©¦...</div>
        <input type="file" id="test-file-input" accept="image/*,.pdf">
        <button onclick="testFileProcessing()">æ¸¬è©¦è™•ç†</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>ğŸ“‹ è©³ç´°æ—¥èªŒ</h2>
        <div id="detailed-log" class="code-block">ç­‰å¾…æ“ä½œ...</div>
        <button onclick="clearLog()">æ¸…ç†æ—¥èªŒ</button>
    </div>

    <script src="config.js"></script>
    <script src="google-ai-integration.js"></script>
    <script src="unified-document-processor.js"></script>
    
    <script>
        let logMessages = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push(logEntry);
            
            const logElement = document.getElementById('detailed-log');
            logElement.textContent = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }
        
        function clearLog() {
            logMessages = [];
            document.getElementById('detailed-log').textContent = 'æ—¥èªŒå·²æ¸…ç†';
        }
        
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let status = '';
            
            // æª¢æŸ¥é…ç½®
            if (window.VaultCaddyConfig) {
                status += '<div class="status-good">âœ… VaultCaddyConfig å·²è¼‰å…¥</div>';
                const config = window.VaultCaddyConfig.getConfig();
                status += `<div>ç’°å¢ƒ: ${config.environment}</div>`;
            } else {
                status += '<div class="status-error">âŒ VaultCaddyConfig æœªè¼‰å…¥</div>';
            }
            
            // æª¢æŸ¥Google AIè™•ç†å™¨
            if (window.GoogleAIProcessor) {
                status += '<div class="status-good">âœ… GoogleAIProcessor å·²è¼‰å…¥</div>';
            } else {
                status += '<div class="status-error">âŒ GoogleAIProcessor æœªè¼‰å…¥</div>';
            }
            
            // æª¢æŸ¥çµ±ä¸€è™•ç†å™¨
            if (window.UnifiedDocumentProcessor) {
                status += '<div class="status-good">âœ… UnifiedDocumentProcessor å·²è¼‰å…¥</div>';
            } else {
                status += '<div class="status-error">âŒ UnifiedDocumentProcessor æœªè¼‰å…¥</div>';
            }
            
            statusDiv.innerHTML = status;
            log('ç³»çµ±ç‹€æ…‹æª¢æŸ¥å®Œæˆ');
        }
        
        async function checkApiStatus() {
            const statusDiv = document.getElementById('api-status');
            let status = '';
            
            const apiKey = localStorage.getItem('google_ai_api_key');
            if (apiKey) {
                status += '<div class="status-good">âœ… API Key å·²è¨­ç½®</div>';
                status += `<div>Key: ${apiKey.substring(0, 10)}...</div>`;
                
                // é©—è­‰æ ¼å¼
                if (apiKey.startsWith('AIza') && apiKey.length > 20) {
                    status += '<div class="status-good">âœ… API Key æ ¼å¼æ­£ç¢º</div>';
                } else {
                    status += '<div class="status-warning">âš ï¸ API Key æ ¼å¼å¯èƒ½ä¸æ­£ç¢º</div>';
                }
            } else {
                status += '<div class="status-error">âŒ æœªè¨­ç½® API Key</div>';
            }
            
            statusDiv.innerHTML = status;
        }
        
        function setApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                localStorage.setItem('google_ai_api_key', apiKey);
                log(`API Key å·²è¨­ç½®: ${apiKey.substring(0, 10)}...`);
                checkApiStatus();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key');
            }
        }
        
        async function testApiKey() {
            const apiKey = localStorage.getItem('google_ai_api_key');
            if (!apiKey) {
                alert('è«‹å…ˆè¨­ç½® API Key');
                return;
            }
            
            log('æ­£åœ¨æ¸¬è©¦ API Key...');
            
            try {
                // ç°¡å–®çš„ API æ¸¬è©¦
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                
                if (response.ok) {
                    log('âœ… API Key æ¸¬è©¦æˆåŠŸ - Google AI é€£æ¥æ­£å¸¸');
                    const data = await response.json();
                    log(`å¯ç”¨æ¨¡å‹: ${data.models?.length || 0} å€‹`);
                } else {
                    log(`âŒ API Key æ¸¬è©¦å¤±æ•— - HTTP ${response.status}`);
                    const errorText = await response.text();
                    log(`éŒ¯èª¤è©³æƒ…: ${errorText}`);
                }
            } catch (error) {
                log(`âŒ API Key æ¸¬è©¦å¤±æ•— - ç¶²çµ¡éŒ¯èª¤: ${error.message}`);
            }
        }
        
        function checkStorage() {
            const statusDiv = document.getElementById('storage-status');
            let status = '';
            
            const storageKeys = Object.keys(localStorage).filter(key => 
                key.includes('vaultcaddy')
            );
            
            status += `<div>æ‰¾åˆ° ${storageKeys.length} å€‹ç›¸é—œå­˜å„²é …ç›®:</div>`;
            
            storageKeys.forEach(key => {
                const data = localStorage.getItem(key);
                const size = new Blob([data]).size;
                status += `<div>ğŸ“ ${key}: ${size} bytes</div>`;
                
                try {
                    const parsed = JSON.parse(data);
                    if (Array.isArray(parsed)) {
                        status += `<div>   â””â”€ ${parsed.length} å€‹é …ç›®</div>`;
                    }
                } catch (e) {
                    status += `<div>   â””â”€ éJSONæ ¼å¼</div>`;
                }
            });
            
            statusDiv.innerHTML = status;
            log(`å­˜å„²æª¢æŸ¥å®Œæˆ - æ‰¾åˆ° ${storageKeys.length} å€‹é …ç›®`);
        }
        
        function clearAllStorage() {
            if (confirm('ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰ VaultCaddy å­˜å„²æ•¸æ“šå—ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰ä¸Šå‚³çš„æ–‡ä»¶è¨˜éŒ„ï¼')) {
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('vaultcaddy')) {
                        localStorage.removeItem(key);
                    }
                });
                log('âœ… æ‰€æœ‰å­˜å„²æ•¸æ“šå·²æ¸…ç†');
                checkStorage();
            }
        }
        
        async function testFileProcessing() {
            const fileInput = document.getElementById('test-file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è«‹é¸æ“‡ä¸€å€‹æ–‡ä»¶');
                return;
            }
            
            log(`é–‹å§‹æ¸¬è©¦æ–‡ä»¶è™•ç†: ${file.name} (${file.type})`);
            
            try {
                if (window.UnifiedDocumentProcessor) {
                    log('ä½¿ç”¨çµ±ä¸€è™•ç†å™¨è™•ç†æ–‡ä»¶...');
                    const result = await window.UnifiedDocumentProcessor.processFile(file, 'receipt');
                    log('âœ… çµ±ä¸€è™•ç†å™¨è™•ç†æˆåŠŸ');
                    log(`çµæœ: ${JSON.stringify(result, null, 2)}`);
                } else if (window.GoogleAIProcessor) {
                    log('ä½¿ç”¨Google AIè™•ç†å™¨è™•ç†æ–‡ä»¶...');
                    const result = await window.GoogleAIProcessor.processDocument(file, 'receipt');
                    log('âœ… Google AIè™•ç†å™¨è™•ç†æˆåŠŸ');
                    log(`çµæœ: ${JSON.stringify(result, null, 2)}`);
                } else {
                    log('âŒ æ²’æœ‰å¯ç”¨çš„è™•ç†å™¨');
                }
            } catch (error) {
                log(`âŒ æ–‡ä»¶è™•ç†å¤±æ•—: ${error.message}`);
                log(`éŒ¯èª¤å †æ£§: ${error.stack}`);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            log('è¨ºæ–·å·¥å…·å·²è¼‰å…¥');
            checkSystemStatus();
            checkApiStatus();
            checkStorage();
        });
    </script>
</body>
</html>
