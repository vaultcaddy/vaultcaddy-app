<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VaultCaddy 診斷工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .diagnostic-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .code-block {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 0.5rem 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        button:hover { background: #0056b3; }
        .clear-btn { background: #dc3545; }
        .clear-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>🔧 VaultCaddy 系統診斷工具</h1>
    
    <div class="diagnostic-section">
        <h2>📊 系統狀態檢查</h2>
        <div id="system-status">正在檢查...</div>
        <button onclick="checkSystemStatus()">重新檢查</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>🔑 API Key 狀態</h2>
        <div id="api-status">正在檢查...</div>
        <input type="text" id="api-key-input" placeholder="輸入 Google AI API Key" style="width: 300px; padding: 0.5rem;">
        <button onclick="setApiKey()">設置 API Key</button>
        <button onclick="testApiKey()">測試 API Key</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>💾 存儲狀態檢查</h2>
        <div id="storage-status">正在檢查...</div>
        <button onclick="checkStorage()">檢查存儲</button>
        <button onclick="clearAllStorage()" class="clear-btn">清理所有存儲</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>🧪 測試文件處理</h2>
        <div id="processing-status">等待測試...</div>
        <input type="file" id="test-file-input" accept="image/*,.pdf">
        <button onclick="testFileProcessing()">測試處理</button>
    </div>
    
    <div class="diagnostic-section">
        <h2>📋 詳細日誌</h2>
        <div id="detailed-log" class="code-block">等待操作...</div>
        <button onclick="clearLog()">清理日誌</button>
    </div>

    <script src="config.js"></script>
    <script src="google-ai-integration.js"></script>
    <script src="unified-document-processor.js"></script>
    
    <script>
        let logMessages = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push(logEntry);
            
            const logElement = document.getElementById('detailed-log');
            logElement.textContent = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }
        
        function clearLog() {
            logMessages = [];
            document.getElementById('detailed-log').textContent = '日誌已清理';
        }
        
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let status = '';
            
            // 檢查配置
            if (window.VaultCaddyConfig) {
                status += '<div class="status-good">✅ VaultCaddyConfig 已載入</div>';
                const config = window.VaultCaddyConfig.getConfig();
                status += `<div>環境: ${config.environment}</div>`;
            } else {
                status += '<div class="status-error">❌ VaultCaddyConfig 未載入</div>';
            }
            
            // 檢查Google AI處理器
            if (window.GoogleAIProcessor) {
                status += '<div class="status-good">✅ GoogleAIProcessor 已載入</div>';
            } else {
                status += '<div class="status-error">❌ GoogleAIProcessor 未載入</div>';
            }
            
            // 檢查統一處理器
            if (window.UnifiedDocumentProcessor) {
                status += '<div class="status-good">✅ UnifiedDocumentProcessor 已載入</div>';
            } else {
                status += '<div class="status-error">❌ UnifiedDocumentProcessor 未載入</div>';
            }
            
            statusDiv.innerHTML = status;
            log('系統狀態檢查完成');
        }
        
        async function checkApiStatus() {
            const statusDiv = document.getElementById('api-status');
            let status = '';
            
            const apiKey = localStorage.getItem('google_ai_api_key');
            if (apiKey) {
                status += '<div class="status-good">✅ API Key 已設置</div>';
                status += `<div>Key: ${apiKey.substring(0, 10)}...</div>`;
                
                // 驗證格式
                if (apiKey.startsWith('AIza') && apiKey.length > 20) {
                    status += '<div class="status-good">✅ API Key 格式正確</div>';
                } else {
                    status += '<div class="status-warning">⚠️ API Key 格式可能不正確</div>';
                }
            } else {
                status += '<div class="status-error">❌ 未設置 API Key</div>';
            }
            
            statusDiv.innerHTML = status;
        }
        
        function setApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                localStorage.setItem('google_ai_api_key', apiKey);
                log(`API Key 已設置: ${apiKey.substring(0, 10)}...`);
                checkApiStatus();
            } else {
                alert('請輸入有效的 API Key');
            }
        }
        
        async function testApiKey() {
            const apiKey = localStorage.getItem('google_ai_api_key');
            if (!apiKey) {
                alert('請先設置 API Key');
                return;
            }
            
            log('正在測試 API Key...');
            
            try {
                // 簡單的 API 測試
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                
                if (response.ok) {
                    log('✅ API Key 測試成功 - Google AI 連接正常');
                    const data = await response.json();
                    log(`可用模型: ${data.models?.length || 0} 個`);
                } else {
                    log(`❌ API Key 測試失敗 - HTTP ${response.status}`);
                    const errorText = await response.text();
                    log(`錯誤詳情: ${errorText}`);
                }
            } catch (error) {
                log(`❌ API Key 測試失敗 - 網絡錯誤: ${error.message}`);
            }
        }
        
        function checkStorage() {
            const statusDiv = document.getElementById('storage-status');
            let status = '';
            
            const storageKeys = Object.keys(localStorage).filter(key => 
                key.includes('vaultcaddy')
            );
            
            status += `<div>找到 ${storageKeys.length} 個相關存儲項目:</div>`;
            
            storageKeys.forEach(key => {
                const data = localStorage.getItem(key);
                const size = new Blob([data]).size;
                status += `<div>📁 ${key}: ${size} bytes</div>`;
                
                try {
                    const parsed = JSON.parse(data);
                    if (Array.isArray(parsed)) {
                        status += `<div>   └─ ${parsed.length} 個項目</div>`;
                    }
                } catch (e) {
                    status += `<div>   └─ 非JSON格式</div>`;
                }
            });
            
            statusDiv.innerHTML = status;
            log(`存儲檢查完成 - 找到 ${storageKeys.length} 個項目`);
        }
        
        function clearAllStorage() {
            if (confirm('確定要清理所有 VaultCaddy 存儲數據嗎？這將刪除所有上傳的文件記錄！')) {
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('vaultcaddy')) {
                        localStorage.removeItem(key);
                    }
                });
                log('✅ 所有存儲數據已清理');
                checkStorage();
            }
        }
        
        async function testFileProcessing() {
            const fileInput = document.getElementById('test-file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('請選擇一個文件');
                return;
            }
            
            log(`開始測試文件處理: ${file.name} (${file.type})`);
            
            try {
                if (window.UnifiedDocumentProcessor) {
                    log('使用統一處理器處理文件...');
                    const result = await window.UnifiedDocumentProcessor.processFile(file, 'receipt');
                    log('✅ 統一處理器處理成功');
                    log(`結果: ${JSON.stringify(result, null, 2)}`);
                } else if (window.GoogleAIProcessor) {
                    log('使用Google AI處理器處理文件...');
                    const result = await window.GoogleAIProcessor.processDocument(file, 'receipt');
                    log('✅ Google AI處理器處理成功');
                    log(`結果: ${JSON.stringify(result, null, 2)}`);
                } else {
                    log('❌ 沒有可用的處理器');
                }
            } catch (error) {
                log(`❌ 文件處理失敗: ${error.message}`);
                log(`錯誤堆棧: ${error.stack}`);
            }
        }
        
        // 頁面載入時自動檢查
        document.addEventListener('DOMContentLoaded', () => {
            log('診斷工具已載入');
            checkSystemStatus();
            checkApiStatus();
            checkStorage();
        });
    </script>
</body>
</html>
