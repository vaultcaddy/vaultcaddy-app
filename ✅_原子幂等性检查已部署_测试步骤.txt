# âœ… åŸå­å¹‚ç­‰æ€§æ£€æŸ¥å·²éƒ¨ç½²ï¼

## ğŸ‰ **ä¿®å¤å®Œæˆï¼**

---

## ğŸ” **é—®é¢˜åŸå› **

**ä¹‹å‰çš„å¹‚ç­‰æ€§æ£€æŸ¥æœ‰å¹¶å‘æ¼æ´**ï¼š

```javascript
// âŒ æ—§çš„æ–¹å¼ï¼šæœ‰å¹¶å‘é—®é¢˜
const doc = await ref.get();
if (doc.exists) {
    return; // è·³è¿‡
}
await ref.set({...});  // å¦‚æœ 2 ä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾ï¼Œéƒ½ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
```

**é—®é¢˜**ï¼š
- è¯·æ±‚ A å’Œè¯·æ±‚ B åŒæ—¶åˆ°è¾¾
- éƒ½é€šè¿‡äº† `doc.exists` æ£€æŸ¥ï¼ˆå› ä¸ºéƒ½è¿˜æ²¡æœ‰å†™å…¥ï¼‰
- ç„¶åéƒ½æ‰§è¡Œäº† `ref.set()` å’Œåç»­çš„ `addCredits()`
- å¯¼è‡´ Credits è¢«æ·»åŠ  2 æ¬¡ï¼

---

## âœ… **æ–°çš„è§£å†³æ–¹æ¡ˆ**

**ä½¿ç”¨ Firestore çš„åŸå­æ“ä½œ**ï¼š

```javascript
// âœ… æ–°çš„æ–¹å¼ï¼šä½¿ç”¨åŸå­æ“ä½œ
try {
    await ref.create({...});  // å¦‚æœæ–‡æ¡£å·²å­˜åœ¨ä¼šæŠ›å‡ºé”™è¯¯
    // åªæœ‰ç¬¬ä¸€ä¸ªè¯·æ±‚èƒ½åˆ°è¾¾è¿™é‡Œ
    await handleCheckoutCompleted(...);
} catch (error) {
    if (error.code === 6) { // ALREADY_EXISTS
        // ç¬¬äºŒä¸ªè¯·æ±‚ä¼šåˆ°è¾¾è¿™é‡Œï¼Œè·³è¿‡å¤„ç†
        return res.status(200).json({ skipped: true });
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… **åŸå­æ€§**ï¼šFirestore ä¿è¯åªæœ‰ä¸€ä¸ªè¯·æ±‚èƒ½æˆåŠŸåˆ›å»ºæ–‡æ¡£
- âœ… **æ— å¹¶å‘é—®é¢˜**ï¼šå³ä½¿ 100 ä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾ï¼Œä¹Ÿåªæœ‰ 1 ä¸ªèƒ½å¤„ç†
- âœ… **å¯é æ€§é«˜**ï¼šä¸ä¾èµ–åº”ç”¨å±‚çš„å¹¶å‘æ§åˆ¶

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

### **âš ï¸ é‡è¦ï¼šå¿…é¡»å…ˆæ¸…ç†æ•°æ®ï¼**

### **æ­¥éª¤ 1ï¼šæ¸…ç† Firestore æ•°æ®**

1. å‰å¾€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. **æ¸…ç†ç”¨æˆ· Credits**ï¼š
   - æ‰¾åˆ° `users` é›†åˆ
   - æ‰¾åˆ°æµ‹è¯•ç”¨æˆ·ï¼ˆ`vaultcaddy@gmail.com`ï¼‰
   - ç‚¹å‡»æ–‡æ¡£
   - å°†ä»¥ä¸‹å­—æ®µè®¾ä¸º **0**ï¼š
     - `credits: 0`
     - `currentCredits: 0`
   - ç‚¹å‡»"æ›´æ–°"

3. **æ¸…ç†å·²å¤„ç†äº‹ä»¶è®°å½•**ï¼š
   - æ‰¾åˆ° `processedStripeEvents` é›†åˆ
   - **åˆ é™¤æ‰€æœ‰æ–‡æ¡£**
   - æˆ–è€…ç›´æ¥åˆ é™¤æ•´ä¸ªé›†åˆ

4. **æ¸…ç†è´­ä¹°è®°å½•ï¼ˆå¯é€‰ï¼‰**ï¼š
   - è¿›å…¥æµ‹è¯•ç”¨æˆ·çš„ `purchaseHistory` å­é›†åˆ
   - åˆ é™¤æ‰€æœ‰æµ‹è¯•è´­ä¹°è®°å½•

---

### **æ­¥éª¤ 2ï¼šé‡æ–°æµ‹è¯•æ”¯ä»˜**

1. **ç­‰å¾… 3-5 åˆ†é’Ÿ**ï¼ˆç¡®ä¿ Firebase Functions éƒ¨ç½²å®Œæˆï¼‰

2. **å‰å¾€æ”¯ä»˜é¡µé¢**ï¼š
   https://vaultcaddy.com/billing.html

3. **ç‚¹å‡» "ğŸ§ª æ¸¬è©¦ Get Started"**

4. **å®Œæˆæ”¯ä»˜**ï¼š
   - æµ‹è¯•å¡å·ï¼š`4242 4242 4242 4242`
   - ä»»æ„æœªæ¥æ—¥æœŸ
   - ä»»æ„ CVC

5. **ç­‰å¾… 10-20 ç§’**

6. **åˆ·æ–°é¡µé¢æˆ–å‰å¾€è´¦æˆ·é¡µé¢**ï¼š
   https://vaultcaddy.com/account.html

7. **ç¡®è®¤ Credits**ï¼š
   - âœ… åº”è¯¥åªå¢åŠ  **100 Credits**
   - âŒ ä¸åº”è¯¥æ˜¯ 200 æˆ–æ›´å¤š

---

### **æ­¥éª¤ 3ï¼šéªŒè¯ç»“æœ**

#### **éªŒè¯ 1ï¼šæ£€æŸ¥ Credits æ•°é‡**

åœ¨è´¦æˆ·é¡µé¢ç¡®è®¤ï¼š
- **é¢„æœŸ**ï¼š100 Credits
- **ä¸åº”è¯¥**ï¼š200 æˆ–æ›´å¤š

---

#### **éªŒè¯ 2ï¼šæ£€æŸ¥ Stripe Webhook æ—¥å¿—**

1. å‰å¾€ï¼šhttps://dashboard.stripe.com/test/workbench/vaultcaddy

2. ç‚¹å‡»æœ€æ–°çš„æ”¯ä»˜äº‹ä»¶

3. æŸ¥çœ‹ Webhook äº‹ä»¶ï¼š
   - âœ… `checkout.session.completed` - **200 OK**
   - âœ… `customer.subscription.created` - **200 OK**
   - âœ… `customer.subscription.updated` - **200 OK**

4. **æ‰€æœ‰äº‹ä»¶éƒ½åº”è¯¥æ˜¯ 200 OK**

---

#### **éªŒè¯ 3ï¼šæ£€æŸ¥ Firebase Functions æ—¥å¿—**

1. å‰å¾€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/functions

2. ç‚¹å‡» `stripeWebhook` å‡½æ•°

3. ç‚¹å‡»"æ—¥å¿—"æ ‡ç­¾

4. æŸ¥æ‰¾æœ€æ–°çš„æ”¯ä»˜è®°å½•

5. **åº”è¯¥çœ‹åˆ°**ï¼š
   ```
   âœ… äº‹ä»¶ evt_xxxxx å·²æ ‡è®°ä¸ºå¤„ç†ä¸­ï¼ˆé¦–æ¬¡å¤„ç†ï¼‰
   âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼): cs_test_xxxxx
   ğŸ’° æº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ xxxxx
   âœ… æˆåŠŸæ·»åŠ  100 Credits
   ```

6. **åº”è¯¥åªçœ‹åˆ° 1 æ¬¡ "å‡†å¤‡æ·»åŠ " å’Œ "æˆåŠŸæ·»åŠ "**

7. **å¦‚æœæœ‰é‡å¤è¯·æ±‚ï¼Œåº”è¯¥çœ‹åˆ°**ï¼š
   ```
   âš ï¸ äº‹ä»¶ evt_xxxxx å·²ç»å¤„ç†è¿‡ï¼Œè·³è¿‡å¤„ç†
   ```

---

#### **éªŒè¯ 4ï¼šæ£€æŸ¥ processedStripeEvents é›†åˆ**

1. å‰å¾€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. æ‰“å¼€ `processedStripeEvents` é›†åˆ

3. **åº”è¯¥çœ‹åˆ°**ï¼š
   - æœ‰ä¸€ä¸ªæ–‡æ¡£ï¼ŒID ä¸ºäº‹ä»¶ IDï¼ˆå¦‚ `evt_xxxxx`ï¼‰
   - åŒ…å« `eventId`, `eventType`, `processedAt`, `isTestMode`, `timestamp` å­—æ®µ

4. **åº”è¯¥åªæœ‰ 1 ä¸ª checkout.session.completed äº‹ä»¶**

---

## ğŸ“Š **é¢„æœŸç»“æœæ€»ç»“**

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| Credits å¢åŠ  | 200ï¼ˆé‡å¤ï¼‰ | **100**ï¼ˆæ­£ç¡®ï¼‰ âœ… |
| å¹¶å‘å¤„ç† | å¯èƒ½é‡å¤ | **åŸå­æ“ä½œ** âœ… |
| Firebase æ—¥å¿— | å¤šæ¬¡å¤„ç† | **åªå¤„ç†ä¸€æ¬¡** âœ… |
| Webhook çŠ¶æ€ | 200 OK | **200 OK** âœ… |

---

## ğŸ” **å¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜**

### **é—®é¢˜ 1ï¼šè¿˜æ˜¯åŠ äº† 200 Credits**

**å¯èƒ½åŸå› **ï¼š
1. æœ‰å¤šä¸ª Webhook ç«¯ç‚¹éƒ½åœ¨ç›‘å¬
2. Stripe å‘é€äº† 2 ä¸ªä¸åŒçš„ `checkout.session.completed` äº‹ä»¶

**æ£€æŸ¥æ–¹æ³•**ï¼š
1. å‰å¾€ï¼šhttps://dashboard.stripe.com/test/webhooks
2. ç¡®è®¤åªæœ‰ **1 ä¸ª** Webhook ç«¯ç‚¹
3. å¦‚æœæœ‰å¤šä¸ªï¼Œåˆ é™¤æ‰€æœ‰æ—§çš„ï¼Œåªä¿ç•™ä¸€ä¸ª

---

### **é—®é¢˜ 2ï¼šCredits å®Œå…¨æ²¡æœ‰å¢åŠ **

**å¯èƒ½åŸå› **ï¼š
1. Firebase Functions è¿˜åœ¨éƒ¨ç½²ä¸­ï¼ˆç­‰å¾… 3-5 åˆ†é’Ÿï¼‰
2. äº§å“ metadata é…ç½®é”™è¯¯

**æ£€æŸ¥æ–¹æ³•**ï¼š
1. æ£€æŸ¥ Firebase Functions æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
2. æ£€æŸ¥ Stripe äº§å“çš„ metadata æ˜¯å¦åŒ…å« `monthly_credits: 100`

---

### **é—®é¢˜ 3ï¼šçœ‹åˆ°é”™è¯¯æ—¥å¿—**

**å¦‚æœ Firebase Functions æ—¥å¿—ä¸­æœ‰é”™è¯¯**ï¼š
- æˆªå›¾é”™è¯¯æ—¥å¿—
- å‘Šè¯‰æˆ‘é”™è¯¯ä¿¡æ¯
- æˆ‘ä¼šç«‹å³ä¿®å¤

---

## ğŸ’¡ **ä¸ºä»€ä¹ˆè¿™æ¬¡åº”è¯¥æˆåŠŸï¼Ÿ**

**Firestore çš„ create() æ–¹æ³•æ˜¯åŸå­æ“ä½œ**ï¼š

```
æ—¶é—´è½´ï¼š
T0: è¯·æ±‚ A å’Œè¯·æ±‚ B åŒæ—¶åˆ°è¾¾
T1: è¯·æ±‚ A è°ƒç”¨ create() â†’ æˆåŠŸ âœ…
T2: è¯·æ±‚ B è°ƒç”¨ create() â†’ å¤±è´¥ âŒ (æ–‡æ¡£å·²å­˜åœ¨)
T3: è¯·æ±‚ A å¤„ç†äº‹ä»¶ï¼Œæ·»åŠ  100 Credits âœ…
T4: è¯·æ±‚ B è·³è¿‡å¤„ç†ï¼Œè¿”å› 200 âœ…
```

**ç»“æœ**ï¼šCredits åªè¢«æ·»åŠ  1 æ¬¡ï¼

---

## ğŸ™ **è¯·æŒ‰ç…§æ­¥éª¤æµ‹è¯•**

1. âœ… æ¸…ç† Firestore æ•°æ®ï¼ˆå°† Credits è®¾ä¸º 0ï¼‰
2. âœ… åˆ é™¤ `processedStripeEvents` é›†åˆ
3. âœ… ç­‰å¾… 3-5 åˆ†é’Ÿ
4. âœ… é‡æ–°æµ‹è¯•æ”¯ä»˜
5. âœ… ç¡®è®¤ Credits **åªå¢åŠ  100**

---

**å®Œæˆæµ‹è¯•åï¼Œå‘Šè¯‰æˆ‘ç»“æœï¼** ğŸ’ª

**å¦‚æœè¿™æ¬¡è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œè¯·æä¾›**ï¼š
1. Webhook ç«¯ç‚¹æ•°é‡æˆªå›¾
2. Firebase Functions æ—¥å¿—æˆªå›¾
3. æœ€ç»ˆçš„ Credits æ•°é‡

æˆ‘ä»¬ä¸€å®šä¼šè§£å†³è¿™ä¸ªé—®é¢˜ï¼ ğŸ”¥

