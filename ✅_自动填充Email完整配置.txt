âœ… è‡ªåŠ¨å¡«å…… Email å®Œæ•´é…ç½®æŒ‡å—
================================
æ›´æ–°æ—¶é—´ï¼š2025å¹´12æœˆ9æ—¥

## ğŸ¯ **ä½ çš„é—®é¢˜éå¸¸é‡è¦ï¼**

**é—®é¢˜ï¼š** ç”¨æˆ·åœ¨ç½‘ç«™å·²ç™»å½•ï¼ˆæœ‰emailï¼‰ï¼Œä½†ç‚¹å‡»"Get Started"åï¼ŒStripeæ”¯ä»˜é¡µé¢è¿˜éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥emailã€‚

**å›ç­”ï¼š** è¿™æ˜¯å› ä¸ºä¹‹å‰ä½¿ç”¨çš„æ˜¯å›ºå®šçš„ Payment Linkï¼Œæ— æ³•ä¼ é€’ç”¨æˆ·ä¿¡æ¯ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** âœ… å·²ä¿®æ”¹ä¸ºåŠ¨æ€åˆ›å»º Checkout Sessionï¼Œç°åœ¨å¯ä»¥è‡ªåŠ¨å¡«å……emailäº†ï¼

---

## ğŸ“ **å·²å®Œæˆçš„ä»£ç ä¿®æ”¹**

### **1ï¸âƒ£ billing.htmlï¼ˆå·²ä¿®æ”¹ï¼‰**

**ä¿®æ”¹å‰ï¼ˆå›ºå®šé“¾æ¥ï¼‰ï¼š**
```html
<a href="https://buy.stripe.com/xxxxx">é–‹å§‹ä½¿ç”¨</a>
```

**ä¿®æ”¹åï¼ˆåŠ¨æ€åˆ›å»ºï¼‰ï¼š**
```html
<button onclick="createCheckoutSession('monthly')">é–‹å§‹ä½¿ç”¨</button>
<button onclick="createCheckoutSession('yearly')">é–‹å§‹ä½¿ç”¨</button>
```

**æ–°å¢ JavaScript å‡½æ•°ï¼ˆç¬¬ 1824-1873 è¡Œï¼‰ï¼š**
```javascript
async function createCheckoutSession(planType) {
    // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
    if (!window.simpleAuth || !window.simpleAuth.isLoggedIn()) {
        alert('è«‹å…ˆç™»éŒ„');
        window.location.href = 'auth.html';
        return;
    }
    
    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    const currentUser = window.simpleAuth.getCurrentUser();
    const userEmail = currentUser.email;  // â† è‡ªåŠ¨è·å–email
    const userId = currentUser.uid;       // â† è‡ªåŠ¨è·å–userId
    
    // 3. è°ƒç”¨ Firebase Function åˆ›å»ºæ”¯ä»˜ä¼šè¯
    const createSession = firebase.functions().httpsCallable('createStripeCheckoutSession');
    
    const result = await createSession({
        planType: planType,
        userId: userId,    // â† ä¼ é€’userId
        email: userEmail   // â† ä¼ é€’email
    });
    
    // 4. è·³è½¬åˆ° Stripe Checkout
    window.location.href = result.data.url;
}
```

---

### **2ï¸âƒ£ firebase-functions/index.jsï¼ˆå·²æ·»åŠ ï¼‰**

**æ–°å¢å‡½æ•°ï¼šcreateStripeCheckoutSessionï¼ˆç¬¬ 1071-1149 è¡Œï¼‰**

```javascript
exports.createStripeCheckoutSession = functions.https.onCall(async (data, context) => {
    const { planType, userId, email } = data;
    
    // å®šä¹‰ä»·æ ¼ID
    const priceMapping = {
        monthly: {
            basePriceId: 'price_xxxxx',   // æœˆè´¹åŸºç¡€ä»·æ ¼ $58
            usagePriceId: 'price_xxxxx'   // æœˆè´¹ç”¨é‡è®¡è´¹
        },
        yearly: {
            basePriceId: 'price_xxxxx',   // å¹´è´¹åŸºç¡€ä»·æ ¼ $552
            usagePriceId: 'price_xxxxx'   // å¹´è´¹ç”¨é‡è®¡è´¹
        }
    };
    
    // åˆ›å»º Checkout Session
    const session = await stripe.checkout.sessions.create({
        mode: 'subscription',
        line_items: [
            {
                price: selectedPlan.basePriceId,  // åŸºç¡€è®¢é˜…è´¹
                quantity: 1
            },
            {
                price: selectedPlan.usagePriceId,  // ç”¨é‡è®¡è´¹
                quantity: 1
            }
        ],
        customer_email: email,      // â† è‡ªåŠ¨å¡«å……emailï¼
        client_reference_id: userId, // â† ä¼ é€’userId
        metadata: {
            userId: userId,          // â† ä¼ é€’userIdï¼ˆåŒé‡ä¿é™©ï¼‰
            planType: planType
        },
        success_url: 'https://vaultcaddy.com/billing.html?success=true',
        cancel_url: 'https://vaultcaddy.com/billing.html?canceled=true'
    });
    
    return { url: session.url };
});
```

---

## âš ï¸ **éœ€è¦ä½ å®Œæˆçš„æœ€åä¸€æ­¥ï¼ˆ5åˆ†é’Ÿï¼‰**

### **æ‰¾åˆ°å¹¶æ›´æ–° Price ID**

ä»£ç ä¸­æœ‰ 4 ä¸ª Price ID éœ€è¦å¡«å†™ï¼ˆç”¨å®é™…çš„IDæ›¿æ¢ `price_xxxxx`ï¼‰ï¼š

#### **æ­¥éª¤1ï¼šè·å–æœˆè´¹çš„ Price ID**

1. è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/products/prod_TZbMNtOqFBHfjl

2. åœ¨"ä»·æ ¼"éƒ¨åˆ†ï¼Œæ‰¾åˆ°ä¸¤ä¸ªä»·æ ¼ï¼š
   - **HK$58.00 æ¯æœˆ** â†’ å¤åˆ¶å³ä¾§çš„ Price IDï¼ˆç±»ä¼¼ `price_xxxxx`ï¼‰
   - **èµ·ä»·ä¸ºHK$0.00 æ¯1å•ä½ æ¯1ä¸ªæœˆ** â†’ å¤åˆ¶è¿™ä¸ªçš„ Price ID

3. è®°å½•ä¸‹æ¥ï¼š
   ```
   æœˆè´¹åŸºç¡€ä»·æ ¼ID: price_xxxxx
   æœˆè´¹ç”¨é‡è®¡è´¹ID: price_xxxxx
   ```

#### **æ­¥éª¤2ï¼šè·å–å¹´è´¹çš„ Price ID**

1. è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/products/prod_TZbKe7oIo0TX8L

2. æ‰¾åˆ°ä¸¤ä¸ªä»·æ ¼ï¼š
   - **HK$552.00 æ¯å¹´** â†’ å¤åˆ¶ Price ID
   - **èµ·ä»·ä¸ºHK$0.00 æ¯1å•ä½ æ¯1å¹´** â†’ å¤åˆ¶ Price ID

3. è®°å½•ï¼š
   ```
   å¹´è´¹åŸºç¡€ä»·æ ¼ID: price_xxxxx
   å¹´è´¹ç”¨é‡è®¡è´¹ID: price_xxxxx
   ```

#### **æ­¥éª¤3ï¼šæŠŠ4ä¸ªPrice IDå‘ç»™æˆ‘**

æŠŠ4ä¸ªPrice IDç²˜è´´ç»™æˆ‘ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
```
æœˆè´¹åŸºç¡€: price_xxxxx
æœˆè´¹ç”¨é‡: price_xxxxx
å¹´è´¹åŸºç¡€: price_xxxxx
å¹´è´¹ç”¨é‡: price_xxxxx
```

æˆ‘ä¼šç«‹å³æ›´æ–°ä»£ç å¹¶éƒ¨ç½²ã€‚

---

## ğŸ“Š **ä¿®æ”¹å‰åå¯¹æ¯”**

### **ä¿®æ”¹å‰ï¼ˆå›¾4ï¼‰ï¼š**
```
ç”¨æˆ·ç‚¹å‡»"Get Started"
    â†“
è·³è½¬åˆ°å›ºå®šçš„ Payment Link
    â†“
ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¾“å…¥ email âŒ
    â†“
å®¹æ˜“è¾“é”™
```

### **ä¿®æ”¹åï¼š**
```
ç”¨æˆ·åœ¨ç½‘ç«™å·²ç™»å½•ï¼ˆå›¾3æ˜¾ç¤º vaultcaddy@gmail.comï¼‰
    â†“
ç”¨æˆ·ç‚¹å‡»"Get Started"
    â†“
JavaScript è‡ªåŠ¨è·å–ç”¨æˆ·çš„ email å’Œ userId
    â†“
è°ƒç”¨ Firebase Function åˆ›å»º Checkout Session
    â†“
è·³è½¬åˆ° Stripe Checkout
    â†“
email å·²è‡ªåŠ¨å¡«å……å¹¶é”å®š âœ…
    â†“
ç”¨æˆ·åªéœ€è¾“å…¥æ”¯ä»˜ä¿¡æ¯
    â†“
å®Œæˆæ”¯ä»˜
    â†“
Webhook æºå¸¦ userId å’Œ email
    â†“
Firebase Functions è‡ªåŠ¨æ·»åŠ  Credits âœ…
```

---

## âœ… **ä¼˜åŠ¿**

### **1. æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**
- âœ… Email è‡ªåŠ¨å¡«å……
- âœ… å‡å°‘ç”¨æˆ·è¾“å…¥
- âœ… é¿å…è¾“å…¥é”™è¯¯

### **2. æ›´å‡†ç¡®çš„ç”¨æˆ·åŒ¹é…**
- âœ… userId ç›´æ¥ä¼ é€’
- âœ… ä¸ä¾èµ– email åŒ¹é…
- âœ… 100% å‡†ç¡®

### **3. æ›´å¥½çš„æ•°æ®è¿½è¸ª**
- âœ… çŸ¥é“æ˜¯å“ªä¸ªç”¨æˆ·è®¢é˜…
- âœ… å¯ä»¥å‡†ç¡®æ·»åŠ  Credits
- âœ… å¯ä»¥è¿½è¸ªè½¬åŒ–ç‡

---

## ğŸ” **å¦‚ä½•æ‰¾åˆ° Price IDï¼Ÿ**

### **æ–¹æ³•1ï¼šåœ¨äº§å“é¡µé¢æŸ¥çœ‹**

1. æ‰“å¼€äº§å“é¡µé¢ï¼ˆå¦‚ä½ çš„å›¾1æˆ–å›¾2ï¼‰
2. æ¯ä¸ªä»·æ ¼æ—è¾¹ä¼šæ˜¾ç¤º Price ID
3. å¤åˆ¶å³å¯

### **æ–¹æ³•2ï¼šåœ¨ä»·æ ¼åˆ—è¡¨é¡µé¢**

1. è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/prices
2. æœç´¢ "VaultCaddy"
3. æ‰¾åˆ°4ä¸ªä»·æ ¼ï¼Œå¤åˆ¶å®ƒä»¬çš„ID

### **Price ID æ ¼å¼ï¼š**
```
price_1ScSATJmiQ31C0GTv5nR9h2e  â† ç±»ä¼¼è¿™æ ·çš„æ ¼å¼
```

---

## ğŸ“‹ **å®Œæ•´é…ç½®æ¸…å•**

### **å·²å®Œæˆï¼š**
- âœ… Stripe äº§å“ Metadata å·²é…ç½®
  - monthly_credits: 100ï¼ˆæœˆè´¹ï¼‰æˆ– 1200ï¼ˆå¹´è´¹ï¼‰
  - plan_type: monthly æˆ– yearly
- âœ… billing.html å·²ä¿®æ”¹ä¸ºåŠ¨æ€æŒ‰é’®
- âœ… Firebase Functions å·²æ·»åŠ åˆ›å»º Checkout Session å‡½æ•°
- âœ… æ”¯æŒè‡ªåŠ¨å¡«å…… email

### **å¾…å®Œæˆï¼š**
- âš ï¸ è·å– 4 ä¸ª Price ID
- âš ï¸ æ›´æ–° firebase-functions/index.js ä¸­çš„ Price ID
- âš ï¸ é‡æ–°éƒ¨ç½² Functions

---

## ğŸš€ **ä¸‹ä¸€æ­¥**

1. **åœ¨ Stripe Dashboard æ‰¾åˆ° 4 ä¸ª Price ID**
2. **æŠŠ Price ID å‘ç»™æˆ‘**
3. **æˆ‘ç«‹å³æ›´æ–°ä»£ç å¹¶éƒ¨ç½²**
4. **æµ‹è¯•å®Œæ•´æµç¨‹**

å‡†å¤‡å¥½äº†å—ï¼ŸæŠŠ 4 ä¸ª Price ID å‘ç»™æˆ‘ï¼ğŸ¯

