# âœ… å¹‚ç­‰æ€§æ£€æŸ¥å·²æ·»åŠ  - é˜²æ­¢é‡å¤æ·»åŠ  Credits

## ğŸ¯ **é—®é¢˜è¯Šæ–­**

### **é—®é¢˜ 1ï¼šStripe Workbench äº‹ä»¶è¿˜æ˜¯ 14 ä»¶**
- âŒ Stripe Webhook é…ç½®è¿˜æ²¡æœ‰ä¼˜åŒ–
- âŒ è¿˜åœ¨ç›‘å¬ 14+ ä¸ªäº‹ä»¶ï¼ŒåŒ…æ‹¬å¾ˆå¤šä¸éœ€è¦çš„äº‹ä»¶

### **é—®é¢˜ 2ï¼šCredits å¢åŠ äº† 200ï¼ˆåº”è¯¥åªå¢åŠ  100ï¼‰**
- âŒ å•æ¬¡æ”¯ä»˜è§¦å‘äº†å¤šä¸ªäº‹ä»¶
- âŒ æ¯ä¸ªäº‹ä»¶éƒ½è°ƒç”¨äº† `addCredits`ï¼Œå¯¼è‡´é‡å¤æ·»åŠ 

---

## âœ… **å·²å®Œæˆçš„ä¿®å¤**

### **1. æ·»åŠ äº†å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆä»£ç çº§é˜²æŠ¤ï¼‰**

**ä¿®æ”¹æ–‡ä»¶**ï¼š`/Users/cavlinyeung/ai-bank-parser/firebase-functions/index.js`

**ä¿®æ”¹å†…å®¹**ï¼š
```javascript
// ğŸ”’ å¹‚ç­‰æ€§æ£€æŸ¥ï¼šé˜²æ­¢é‡å¤å¤„ç†åŒä¸€ä¸ªäº‹ä»¶
const processedEventsRef = db.collection('processedStripeEvents').doc(event.id);
const processedEventDoc = await processedEventsRef.get();

if (processedEventDoc.exists) {
    console.log(`âš ï¸ äº‹ä»¶ ${event.id} å·²ç»å¤„ç†è¿‡ï¼Œè·³è¿‡å¤„ç†`);
    return res.status(200).json({ received: true, skipped: true, reason: 'already_processed' });
}

// è¨˜éŒ„äº‹ä»¶å·²è™•ç†ï¼ˆå…ˆè®°å½•ï¼Œé˜²æ­¢å¹¶å‘ï¼‰
await processedEventsRef.set({
    eventId: event.id,
    eventType: event.type,
    processedAt: admin.firestore.FieldValue.serverTimestamp(),
    isTestMode: isTestMode
});
```

**å·¥ä½œåŸç†**ï¼š
1. åœ¨å¤„ç† Stripe Webhook äº‹ä»¶ä¹‹å‰ï¼Œæ£€æŸ¥è¯¥äº‹ä»¶ ID æ˜¯å¦å·²ç»å¤„ç†è¿‡
2. å¦‚æœå·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å› 200 OKï¼Œè·³è¿‡å¤„ç†
3. å¦‚æœæ˜¯æ–°äº‹ä»¶ï¼Œå…ˆè®°å½•åˆ° Firestore `processedStripeEvents` é›†åˆ
4. å¤„ç†äº‹ä»¶åï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ é™¤è®°å½•ï¼Œå…è®¸é‡è¯•

**æ•ˆæœ**ï¼š
- âœ… å³ä½¿ Stripe å‘é€é‡å¤äº‹ä»¶ï¼Œä¹Ÿåªä¼šå¤„ç†ä¸€æ¬¡
- âœ… é˜²æ­¢ Credits é‡å¤æ·»åŠ 
- âœ… å¦‚æœå¤„ç†å¤±è´¥ï¼Œä¼šè‡ªåŠ¨æ¸…ç†æ ‡è®°ï¼Œå…è®¸é‡è¯•

### **2. é‡æ–°éƒ¨ç½²äº† Firebase Functions**

âœ… Firebase Functions å·²æˆåŠŸéƒ¨ç½²
âœ… æ–°çš„å¹‚ç­‰æ€§æ£€æŸ¥å·²ç”Ÿæ•ˆ

---

## â³ **ä¸‹ä¸€æ­¥ï¼šæ‰‹åŠ¨é…ç½® Stripe Webhook**

**âš ï¸ é‡è¦ï¼å³ä½¿æ·»åŠ äº†å¹‚ç­‰æ€§æ£€æŸ¥ï¼Œæ‚¨è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨é…ç½® Stripe Webhookï¼Œå‡å°‘ä¸å¿…è¦çš„äº‹ä»¶ï¼**

### **ä¸ºä»€ä¹ˆè¿˜è¦é…ç½® Webhookï¼Ÿ**

1. **å‡å°‘ Firebase Functions æ‰§è¡Œæ¬¡æ•°**
   - æ¯æ¬¡äº‹ä»¶è§¦å‘éƒ½ä¼šè°ƒç”¨ Firebase Function
   - å³ä½¿è¢«å¹‚ç­‰æ€§æ£€æŸ¥è·³è¿‡ï¼Œä¹Ÿä¼šæ¶ˆè€—èµ„æºå’Œè´¹ç”¨

2. **æå‡æ€§èƒ½**
   - å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
   - å‡å°‘ Firestore å†™å…¥æ¬¡æ•°

3. **é™ä½é”™è¯¯ç‡**
   - Stripe Dashboard æ˜¾ç¤ºé”™è¯¯ç‡ 79%
   - è¿™æ˜¯å› ä¸ºå¾ˆå¤šä¸éœ€è¦çš„äº‹ä»¶è¢« Webhook æ¥æ”¶åæ²¡æœ‰æ­£ç¡®å¤„ç†

---

## ğŸ”§ **æ‰‹åŠ¨é…ç½® Stripe Webhookï¼ˆåªéœ€ 3 åˆ†é’Ÿï¼ï¼‰**

### **æ­¥éª¤ 1ï¼šæ‰“å¼€ Webhook é…ç½®**
1. å‰å¾€ï¼šhttps://dashboard.stripe.com/test/webhooks
2. ç‚¹å‡» `charismatic-serenity` Webhook

### **æ­¥éª¤ 2ï¼šç¼–è¾‘ç›‘å¬çš„äº‹ä»¶**
1. å‘ä¸‹æ»šåŠ¨åˆ° **"ç›‘å¬çš„äº‹ä»¶"** æˆ– **"Events to send"** éƒ¨åˆ†
2. ç‚¹å‡» **"ç¼–è¾‘"** æˆ– **"Edit"** æŒ‰é’®

### **æ­¥éª¤ 3ï¼šåªä¿ç•™ 4 ä¸ªå¿…è¦äº‹ä»¶**

**å–æ¶ˆå‹¾é€‰æ‰€æœ‰äº‹ä»¶ï¼Œåªä¿ç•™ï¼š**
- âœ… `checkout.session.completed`
- âœ… `customer.subscription.created`
- âœ… `customer.subscription.updated`
- âœ… `customer.subscription.deleted`

**éœ€è¦ç§»é™¤çš„äº‹ä»¶ï¼ˆå…± 10+ ä¸ªï¼‰ï¼š**
- âŒ `invoice.payment_paid`
- âŒ `invoice.payment_succeeded`
- âŒ `invoice.paid`
- âŒ `invoice.updated`
- âŒ `invoice.finalized`
- âŒ `invoice.created`
- âŒ `payment_intent.succeeded`
- âŒ `payment_intent.created`
- âŒ `payment_method.attached`
- âŒ `charge.succeeded`
- âŒ `customer.updated`
- âŒ `customer.created`

### **æ­¥éª¤ 4ï¼šä¿å­˜é…ç½®**
ç‚¹å‡» **"ä¿å­˜"** æˆ– **"Update endpoint"**

---

## ğŸ§ª **æµ‹è¯•éªŒè¯**

é…ç½®å®Œæˆåï¼Œè¯·è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### **1. è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**
1. å‰å¾€ï¼šhttps://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. ä½¿ç”¨æµ‹è¯•å¡å®Œæˆæ”¯ä»˜ï¼š`4242 4242 4242 4242`

### **2. æŸ¥çœ‹ Stripe Workbench**
1. æ‰“å¼€ï¼šhttps://dashboard.stripe.com/test/workbench/events
2. **åº”è¯¥åªçœ‹åˆ° 4 ä¸ªäº‹ä»¶**ï¼ˆè€Œä¸æ˜¯ 14+ ä¸ªï¼‰ï¼š
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`ï¼ˆå¦‚æœæœ‰è®¢é˜…å˜æ›´ï¼‰

### **3. æŸ¥çœ‹ Credits**
1. åˆ·æ–° https://vaultcaddy.com/billing.html
2. **Credits åº”è¯¥åªå¢åŠ  100**ï¼ˆè€Œä¸æ˜¯ 200 æˆ– 300ï¼‰

### **4. æŸ¥çœ‹ Firebase Functions æ—¥å¿—**
```bash
firebase functions:log | grep "å¹‚ç­‰æ€§æ£€æŸ¥" | head -20
```

**åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—**ï¼š
```
âœ… äº‹ä»¶ evt_xxxxx å·²æ ‡è®°ä¸ºå¤„ç†ä¸­
ğŸ’° æº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ xxxxx
âœ… å·²æˆåŠŸæ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ xxxxx
```

---

## ğŸ“Š **é¢„æœŸä¼˜åŒ–æ•ˆæœ**

### **ä¼˜åŒ–å‰**
| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ¯æ¬¡æ”¯ä»˜è§¦å‘çš„äº‹ä»¶æ•° | 14+ ä¸ª |
| Firebase Functions æ‰§è¡Œæ¬¡æ•° | 14+ æ¬¡ |
| Credits å¢åŠ  | 200-300ï¼ˆé”™è¯¯ï¼‰ |
| Webhook é”™è¯¯ç‡ | 79% |

### **ä¼˜åŒ–å**
| æŒ‡æ ‡ | æ•°å€¼ | æå‡ |
|------|------|------|
| æ¯æ¬¡æ”¯ä»˜è§¦å‘çš„äº‹ä»¶æ•° | 4 ä¸ª | **-71%** |
| Firebase Functions æ‰§è¡Œæ¬¡æ•° | 4 æ¬¡ | **-71%** |
| Credits å¢åŠ  | 100ï¼ˆæ­£ç¡®ï¼‰ | **âœ… ä¿®å¤** |
| Webhook é”™è¯¯ç‡ | < 5% | **-74%** |

---

## ğŸ¯ **æ€»ç»“**

### **âœ… å·²å®Œæˆ**
1. âœ… æ·»åŠ äº†å¹‚ç­‰æ€§æ£€æŸ¥ï¼Œé˜²æ­¢é‡å¤æ·»åŠ  Credits
2. âœ… é‡æ–°éƒ¨ç½²äº† Firebase Functions

### **â³ å¾…å®Œæˆï¼ˆéœ€è¦æ‚¨æ‰‹åŠ¨æ“ä½œï¼‰**
1. â³ æ‰‹åŠ¨é…ç½® Stripe Webhookï¼Œåªä¿ç•™ 4 ä¸ªå¿…è¦äº‹ä»¶
2. â³ è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜ï¼ŒéªŒè¯ Credits åªå¢åŠ  100

### **ğŸ’¡ å»ºè®®**
- è¯·å°½å¿«å®Œæˆ Stripe Webhook é…ç½®ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—
- é…ç½®å®Œæˆåï¼Œè®°å¾—è¿›è¡Œæµ‹è¯•éªŒè¯

---

## ğŸ™ **éœ€è¦å¸®åŠ©å—ï¼Ÿ**

å¦‚æœåœ¨é…ç½® Stripe Webhook æˆ–æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼

