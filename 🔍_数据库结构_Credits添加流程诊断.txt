# ğŸ” æ•°æ®åº“ç»“æ„ä¸ Credits æ·»åŠ æµç¨‹è¯Šæ–­

## âœ… **å›ç­”æ‚¨çš„é—®é¢˜**

### **é—®é¢˜ï¼š`verificationCodes` ä¸­æ²¡æœ‰ creditsï¼Œcredits åœ¨ `users` ä¸­ï¼Œéœ€è¦åˆå¹¶å—ï¼Ÿ**

**ç­”æ¡ˆï¼šâŒ ä¸éœ€è¦ï¼è¿™æ˜¯æ­£ç¡®çš„æ•°æ®åº“è®¾è®¡ï¼**

---

## ğŸ“Š **å½“å‰æ•°æ®åº“ç»“æ„ï¼ˆæ­£ç¡®çš„è®¾è®¡ï¼‰**

### **1. `verificationCodes` é›†åˆ**
```
â”œâ”€â”€ do.someeething@gmail.com
â”œâ”€â”€ osclin2002@gmail.com
â”œâ”€â”€ test@example.com
â””â”€â”€ vaultcaddy@gmail.com
    â”œâ”€â”€ code: "121306"
    â”œâ”€â”€ attempts: 0
    â”œâ”€â”€ verified: true
    â”œâ”€â”€ email: "vaultcaddy@gmail.com"
    â”œâ”€â”€ createdAt: 2025å¹´12æœˆ10æ—¥ UTC+8 13:00:41
    â”œâ”€â”€ expiresAt: 2025å¹´12æœˆ10æ—¥ UTC+8 13:10:40
    â””â”€â”€ verifiedAt: 2025å¹´12æœˆ10æ—¥ UTC+8 13:01:09
```

**ç”¨é€”ï¼š** ä»…ç”¨äºå­˜å‚¨å’ŒéªŒè¯ email éªŒè¯ç 
**âœ… ä¸éœ€è¦ credits å­—æ®µ**

---

### **2. `users` é›†åˆ**
```
users/
â”œâ”€â”€ AZ55k5FJBofAeKE09AYbGVIEoDy1/
â”‚   â”œâ”€â”€ credits: 79970
â”‚   â”œâ”€â”€ currentCredits: 79970
â”‚   â”œâ”€â”€ email: "???" (éœ€è¦ç¡®è®¤)
â”‚   â”œâ”€â”€ createdAt: 2025å¹´11æœˆ2æ—¥ UTC+8 15:40:14
â”‚   â”œâ”€â”€ updatedAt: 2025å¹´12æœˆ8æ—¥ UTC+8 20:35:39
â”‚   â””â”€â”€ creditsHistory/ (å­é›†åˆ)
â”‚
â”œâ”€â”€ MRT3Qt923hnaMK4v26Y6LKR.../
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ (å…¶ä»–ç”¨æˆ·)
```

**ç”¨é€”ï¼š** å­˜å‚¨ç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ credits
**âœ… è¿™æ˜¯ credits åº”è¯¥å­˜å‚¨çš„åœ°æ–¹**

---

## ğŸ” **å…³é”®é—®é¢˜è¯Šæ–­**

### **é—®é¢˜ 1ï¼š`vaultcaddy@gmail.com` çš„ç”¨æˆ· ID æ˜¯ä»€ä¹ˆï¼Ÿ**

ä»æˆªå›¾ä¸­çœ‹åˆ°ï¼š
- `AZ55k5FJBofAeKE09AYbGVIEoDy1` æœ‰ 79970 Credits

**â“ è¿™ä¸ªç”¨æˆ·çš„ email æ˜¯ `vaultcaddy@gmail.com` å—ï¼Ÿ**

---

### **é—®é¢˜ 2ï¼šStripe Webhook å¦‚ä½•æŸ¥æ‰¾ç”¨æˆ·ï¼Ÿ**

å½“æ”¯ä»˜æˆåŠŸåï¼ŒStripe Webhook çš„æµç¨‹ï¼š

```javascript
// 1. ä» Stripe Checkout Session è·å– customer email
const customerEmail = session.customer_email;  // "vaultcaddy@gmail.com"

// 2. åœ¨ Firestore ä¸­æŸ¥æ‰¾ç”¨æˆ·
const usersRef = admin.firestore().collection('users');
const snapshot = await usersRef
    .where('email', '==', customerEmail)
    .limit(1)
    .get();

// 3. å¦‚æœæ‰¾åˆ°ç”¨æˆ·ï¼Œæ›´æ–° credits
if (!snapshot.empty) {
    const userId = snapshot.docs[0].id;
    await addCredits(userId, 100, {...});
} else {
    // âŒ æœªæ‰¾åˆ°ç”¨æˆ· - Credits ä¸ä¼šå¢åŠ ï¼
    console.error('âŒ ç„¡æ³•ç²å–ç”¨æˆ¶ ID');
}
```

---

## ğŸ§ª **è¯Šæ–­æ­¥éª¤**

### **æ­¥éª¤ 1ï¼šç¡®è®¤ç”¨æˆ·å­˜åœ¨**

è¯·åœ¨ Firebase Console ä¸­ï¼š
1. æ‰“å¼€ `users` é›†åˆ
2. æŸ¥æ‰¾åŒ…å« `email: "vaultcaddy@gmail.com"` çš„æ–‡æ¡£
3. è®°å½•è¯¥æ–‡æ¡£çš„ ID

**é¢„æœŸï¼š**
- âœ… æ‰¾åˆ°ç”¨æˆ·ï¼Œè®°å½• ID
- âŒ æœªæ‰¾åˆ°ç”¨æˆ· = **è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨**

---

### **æ­¥éª¤ 2ï¼šç¡®è®¤ç”¨æˆ·çš„å½“å‰ Credits**

æ‰¾åˆ°ç”¨æˆ·åï¼š
1. æŸ¥çœ‹ `credits` å­—æ®µçš„å€¼
2. æŸ¥çœ‹ `currentCredits` å­—æ®µçš„å€¼

**é¢„æœŸï¼š**
- å¦‚æœæ˜¯ 0ï¼Œè¯´æ˜ Credits ä»æœªè¢«æ·»åŠ 
- å¦‚æœå¤§äº 0ï¼Œè¯´æ˜ä¹‹å‰æœ‰æ·»åŠ æˆåŠŸè¿‡

---

### **æ­¥éª¤ 3ï¼šè¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**

**â— é‡è¦ï¼šå¿…é¡»åœ¨ä»£ç éƒ¨ç½²åè¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**

1. æ‰“å¼€ https://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. ä½¿ç”¨æµ‹è¯•å¡ï¼š**4242 4242 4242 4242**
4. å®Œæˆæ”¯ä»˜

---

### **æ­¥éª¤ 4ï¼šæŸ¥çœ‹ Webhook æ—¥å¿—**

æ”¯ä»˜å®Œæˆåï¼Œè¿è¡Œï¼š

```bash
firebase functions:log --only stripeWebhook 2>&1 | tail -100
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
âœ… è¨‚é–±è®Šæ›´ (æ¸¬è©¦æ¨¡å¼): sub_xxx
ğŸ“‹ Subscription è©³æƒ…: {...}
ğŸ” å˜—è©¦é€šé Stripe Customer æŸ¥æ‰¾ç”¨æˆ¶: cus_xxx
ğŸ” Customer email: vaultcaddy@gmail.com
âœ… é€šé customer email æ‰¾åˆ°ç”¨æˆ¶: <ç”¨æˆ¶ID>
ğŸ‰ è¨‚é–±å·²æ¿€æ´»ï¼Œæº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ <ç”¨æˆ¶ID>
âœ… å·²æˆåŠŸæ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ <ç”¨æˆ¶ID>
```

---

### **æ­¥éª¤ 5ï¼šå†æ¬¡ç¡®è®¤ Credits**

åœ¨ Firebase Console ä¸­ï¼š
1. åˆ·æ–° `users` é›†åˆ
2. æŸ¥çœ‹ `vaultcaddy@gmail.com` ç”¨æˆ·çš„ `credits` å­—æ®µ
3. ç¡®è®¤æ˜¯å¦å¢åŠ äº† 100

---

## ğŸš¨ **å¯èƒ½çš„é—®é¢˜**

### **é—®é¢˜ Aï¼š`vaultcaddy@gmail.com` ç”¨æˆ·ä¸å­˜åœ¨äº `users` é›†åˆ**

**ç—‡çŠ¶ï¼š**
- åªåœ¨ `verificationCodes` ä¸­æ‰¾åˆ° `vaultcaddy@gmail.com`
- `users` é›†åˆä¸­æ²¡æœ‰å¯¹åº”çš„ç”¨æˆ·æ–‡æ¡£

**è§£å†³æ–¹æ¡ˆï¼š**
åœ¨æ³¨å†Œæ—¶åˆ›å»ºç”¨æˆ·æ–‡æ¡£ï¼š

```javascript
// åœ¨ auth.html æ³¨å†Œæ—¶
const userDoc = {
    email: email,
    credits: 0,
    currentCredits: 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
};
await db.collection('users').doc(userId).set(userDoc);
```

---

### **é—®é¢˜ Bï¼š`users` é›†åˆä¸­çš„ç”¨æˆ· email å­—æ®µä¸åŒ¹é…**

**ç—‡çŠ¶ï¼š**
- `users` é›†åˆä¸­æœ‰ç”¨æˆ·ï¼Œä½† `email` å­—æ®µçš„å€¼ä¸æ˜¯ "vaultcaddy@gmail.com"
- å¯èƒ½æ˜¯ "Vaultcaddy@gmail.com" (å¤§å°å†™ä¸åŒ)

**è§£å†³æ–¹æ¡ˆï¼š**
ç»Ÿä¸€ email ä¸ºå°å†™ï¼š

```javascript
const email = userEmail.toLowerCase();
```

---

### **é—®é¢˜ Cï¼šç”¨æˆ·æœªè¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**

**ç—‡çŠ¶ï¼š**
- Webhook æ—¥å¿—ä¸­æ²¡æœ‰æ–°çš„äº‹ä»¶
- Firebase Functions æ²¡æœ‰è¢«è°ƒç”¨

**è§£å†³æ–¹æ¡ˆï¼š**
è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜ï¼ˆå¿…é¡»åœ¨ä»£ç éƒ¨ç½²åï¼‰

---

## ğŸ“ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

è¯·æ‚¨ï¼š

1. **ç¡®è®¤ç”¨æˆ· ID**
   - åœ¨ Firebase Console ä¸­æŸ¥æ‰¾ `email: "vaultcaddy@gmail.com"` çš„ç”¨æˆ·
   - å‘Šè¯‰æˆ‘è¯¥ç”¨æˆ·çš„ ID å’Œå½“å‰ Credits

2. **è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜**
   - åœ¨ https://vaultcaddy.com/billing.html ç‚¹å‡» "ğŸ§ª æ¸¬è©¦ Get Started"
   - ä½¿ç”¨æµ‹è¯•å¡å®Œæˆæ”¯ä»˜

3. **åˆ†äº«æ—¥å¿—**
   - è¿è¡Œ `firebase functions:log --only stripeWebhook 2>&1 | tail -100`
   - å‘Šè¯‰æˆ‘è¾“å‡ºå†…å®¹

**åªæœ‰è¿™æ ·æˆ‘æ‰èƒ½å‡†ç¡®è¯Šæ–­é—®é¢˜ï¼** ğŸ™

