# âœ… 500 é”™è¯¯å·²ä¿®å¤ - Stripe å®¢æˆ·ç«¯é€‰æ‹©é—®é¢˜

## ğŸ¯ **é—®é¢˜æ ¹æº**

### æ‚¨çš„è¯Šæ–­å®Œå…¨æ­£ç¡®ï¼

**é—®é¢˜1ï¼šå¯†é’¥ä¸åŒ¹é…** âœ… **å·²ä¿®å¤**
- æµ‹è¯• Webhook ç­¾åå¯†é’¥é…ç½®é”™è¯¯
- æ­£ç¡®å¯†é’¥ï¼š`whsec_hK6JuCnJTKmB4CD6q9ohYzrQbXhjGYpa`
- é”™è¯¯å¯†é’¥ï¼š`whsec_5I0RUCi0eEkDGBvaNy8nGmVb80gp6eAL`

**é—®é¢˜2ï¼šStripe å®¢æˆ·ç«¯é€‰æ‹©é”™è¯¯** âœ… **å·²ä¿®å¤**
- æµ‹è¯•æ¨¡å¼çš„ Webhook äº‹ä»¶éœ€è¦ä½¿ç”¨ **æµ‹è¯•æ¨¡å¼çš„ Stripe å®¢æˆ·ç«¯** (`stripeTest`) æ¥è®¿é—® Stripe API
- ä¹‹å‰çš„ä»£ç åœ¨ `handleCheckoutCompleted` å’Œ `handleSubscriptionChange` å‡½æ•°ä¸­ä½¿ç”¨äº†å…¨å±€çš„ `stripe` å¯¹è±¡ï¼ˆç”Ÿäº§æ¨¡å¼å®¢æˆ·ç«¯ï¼‰
- å½“å°è¯•ä½¿ç”¨ç”Ÿäº§å®¢æˆ·ç«¯è®¿é—®æµ‹è¯•æ¨¡å¼çš„èµ„æºæ—¶ï¼ŒStripe API è¿”å› 404 Not Found é”™è¯¯

---

## ğŸ” **é”™è¯¯æ—¥å¿—åˆ†æ**

### Stripe API 404 é”™è¯¯ï¼š
```
doc_url: 'https://stripe.com/docs/error-codes/resource-missing',
param: 'session',
statusCode: 404
```

### åŸå› ï¼š
```javascript
// âŒ é”™è¯¯çš„ä»£ç ï¼ˆä¹‹å‰ï¼‰
async function handleCheckoutCompleted(session) {
    // ... 
    const lineItems = await stripe.checkout.sessions.listLineItems(session.id);  // ä½¿ç”¨ç”Ÿäº§å®¢æˆ·ç«¯
    const product = await stripe.products.retrieve(productId);  // ä½¿ç”¨ç”Ÿäº§å®¢æˆ·ç«¯
}
```

ç”Ÿäº§æ¨¡å¼çš„ Stripe å®¢æˆ·ç«¯æ— æ³•è®¿é—®æµ‹è¯•æ¨¡å¼çš„ Session/Productï¼Œå¯¼è‡´ 404 é”™è¯¯ã€‚

---

## âœ… **ä¿®å¤æ–¹æ¡ˆ**

### ä¿®æ”¹ `handleCheckoutCompleted` å‡½æ•°ï¼š

```javascript
// âœ… ä¿®å¤åçš„ä»£ç 
async function handleCheckoutCompleted(session, isTestMode = false) {
    console.log(`âœ… çµå¸³å®Œæˆ (${isTestMode ? 'æ¸¬è©¦æ¨¡å¼' : 'ç”Ÿç”¢æ¨¡å¼'}):`, session.id);
    
    // é¸æ“‡æ­£ç¢ºçš„ Stripe å®¢æˆ¶ç«¯
    const stripeClient = isTestMode ? stripeTest : stripeLive;
    if (!stripeClient) {
        console.error(`âŒ Stripe å®¢æˆ¶ç«¯æœªé…ç½® (${isTestMode ? 'æ¸¬è©¦æ¨¡å¼' : 'ç”Ÿç”¢æ¨¡å¼'})`);
        throw new Error('Stripe client not configured');
    }
    
    // ... å…¶ä»–ä»£ç  ...
    
    // ä½¿ç”¨æ­£ç¢ºçš„å®¢æˆ¶ç«¯
    const lineItems = await stripeClient.checkout.sessions.listLineItems(session.id);
    const product = await stripeClient.products.retrieve(productId);
}
```

### åŒæ ·ä¿®å¤äº† `handleSubscriptionChange` å‡½æ•°ï¼š

```javascript
async function handleSubscriptionChange(subscription, isTestMode = false) {
    console.log(`âœ… è¨‚é–±è®Šæ›´ (${isTestMode ? 'æ¸¬è©¦æ¨¡å¼' : 'ç”Ÿç”¢æ¨¡å¼'}):`, subscription.id);
    
    // é¸æ“‡æ­£ç¢ºçš„ Stripe å®¢æˆ¶ç«¯
    const stripeClient = isTestMode ? stripeTest : stripeLive;
    
    // ä½¿ç”¨æ­£ç¢ºçš„å®¢æˆ¶ç«¯
    const customer = await stripeClient.customers.retrieve(subscription.customer);
    const product = await stripeClient.products.retrieve(subscription.items.data[0].price.product);
}
```

---

## ğŸ“ **å·²å®Œæˆçš„ä¿®å¤**

1. âœ… **æ›´æ–°äº†æµ‹è¯• Webhook ç­¾åå¯†é’¥**ï¼ˆä¿®å¤ 403 é”™è¯¯ï¼‰
2. âœ… **ä¿®å¤äº† Stripe å®¢æˆ·ç«¯é€‰æ‹©é€»è¾‘**ï¼ˆä¿®å¤ 500 é”™è¯¯ï¼‰
3. âœ… **é‡æ–°éƒ¨ç½²äº† Firebase Functions**

---

## ğŸ§ª **ä¸‹ä¸€æ­¥æµ‹è¯•**

**ç°åœ¨è¯·è¿›è¡Œæ–°çš„æµ‹è¯•æ”¯ä»˜ï¼š**

1. æ‰“å¼€ï¼šhttps://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"** æŒ‰é’®
3. ä½¿ç”¨æµ‹è¯•å¡ï¼š**4242 4242 4242 4242**
4. å®Œæˆæ”¯ä»˜

**é¢„æœŸç»“æœï¼š**
- âœ… 1200 Credits åº”è¯¥æˆåŠŸæ·»åŠ åˆ°æ‚¨çš„è´¦æˆ·
- âœ… è®¡åˆ’åº”è¯¥ä» "Free Plan" æ›´æ–°ä¸º "Pro Plan"
- âœ… Stripe Webhook åº”è¯¥æ˜¾ç¤º âœ… æˆåŠŸçŠ¶æ€

---

## ğŸ“Š **é—®é¢˜å›ç­”**

### **é—®é¢˜1ï¼šç­¾åä¸åŒ¹é…ï¼Œæ˜¯å¦ç”¨äº†æ­£å¼ç‰ˆçš„ä¸æ˜¯testç‰ˆçš„ï¼Ÿ**

**æ˜¯çš„ï¼** æ‚¨çš„è¯Šæ–­å®Œå…¨æ­£ç¡®ï¼š
- æµ‹è¯• Webhook ç­¾åå¯†é’¥é…ç½®é”™è¯¯ âœ… **å·²ä¿®å¤**

### **é—®é¢˜2ï¼štestç‰ˆä¸­æœ‰è¿™äº›å¤šé—®é¢˜ï¼Œå¦‚ä½•çŸ¥é“æ­£å¼ç‰ˆçš„æ­£ç¡®å¯ç”¨ï¼Ÿ**

**æ­£å¼ç‰ˆï¼ˆLive Modeï¼‰é…ç½®æ˜¯æ­£ç¡®çš„ï¼** 

#### æµ‹è¯•ç‰ˆå’Œæ­£å¼ç‰ˆçš„åšæ³•å®Œå…¨ç›¸åŒï¼š

| æ­¥éª¤ | æµ‹è¯•æ¨¡å¼ | æ­£å¼æ¨¡å¼ | è¯´æ˜ |
|------|---------|---------|------|
| **Webhook ç­¾åéªŒè¯** | `whsec_hK6J...` (Test) | `whsec_MNrl...` (Live) | âœ… ä¸¤è€…éƒ½æ­£ç¡®é…ç½® |
| **Stripe å®¢æˆ·ç«¯** | `stripeTest` | `stripeLive` | âœ… å·²ä¿®å¤ï¼Œæ ¹æ®æ¨¡å¼åŠ¨æ€é€‰æ‹© |
| **Price IDs** | `price_1Scj13...` (Test) | `price_1ScS9Q...` (Live) | âœ… ä¸¤è€…åˆ†åˆ«é…ç½® |
| **Firebase Function** | åŒä¸€ä¸ª `stripeWebhook` | åŒä¸€ä¸ª `stripeWebhook` | âœ… åŒä¸€ä»£ç ï¼Œè‡ªåŠ¨è¯†åˆ«æ¨¡å¼ |

#### æµ‹è¯•ç‰ˆçš„é—®é¢˜ä¸ä¼šå½±å“æ­£å¼ç‰ˆï¼š
- âœ… æµ‹è¯•ç‰ˆå’Œæ­£å¼ç‰ˆä½¿ç”¨ **ç‹¬ç«‹çš„å¯†é’¥**
- âœ… æµ‹è¯•ç‰ˆå’Œæ­£å¼ç‰ˆä½¿ç”¨ **ç‹¬ç«‹çš„äº§å“/ä»·æ ¼**
- âœ… Firebase Function è‡ªåŠ¨æ ¹æ® Webhook ç­¾åé€‰æ‹©æ­£ç¡®çš„æ¨¡å¼
- âœ… æ­£å¼ç‰ˆçš„ Webhook å¯†é’¥ä»ä¸€å¼€å§‹å°±æ˜¯æ­£ç¡®çš„

---

## ğŸ‰ **æ€»ç»“**

**æ‰€æœ‰é—®é¢˜çš„æ ¹æºï¼š**
1. âœ… æµ‹è¯• Webhook ç­¾åå¯†é’¥ä¸åŒ¹é…ï¼ˆå¯¼è‡´ 403ï¼‰
2. âœ… Stripe å®¢æˆ·ç«¯é€‰æ‹©é”™è¯¯ï¼ˆå¯¼è‡´ 500ï¼‰

**ç°åœ¨ä¸¤ä¸ªé—®é¢˜éƒ½å·²ä¿®å¤ï¼æµ‹è¯•æ”¯ä»˜åº”è¯¥å¯ä»¥æˆåŠŸæ·»åŠ  Credits äº†ï¼** ğŸš€

