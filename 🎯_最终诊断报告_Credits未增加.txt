# ğŸ¯ æœ€ç»ˆè¯Šæ–­æŠ¥å‘Šï¼šCredits æœªå¢åŠ 

## ğŸ“Š **é—®é¢˜ç°çŠ¶**

1. âœ… Stripe Workbench æ˜¾ç¤º `checkout.session.completed` äº‹ä»¶è¿”å› **200 OK**
2. âœ… æµ‹è¯•æ”¯ä»˜æˆåŠŸï¼ŒStripe ç¡®è®¤æ”¶åˆ°æ¬¾é¡¹
3. âœ… äº§å“ Metadata é…ç½®æ­£ç¡®ï¼š
   - `monthly_credits`: `100`
   - `plan_type`: `monthly`
4. âŒ **Credits ä»ç„¶æ˜¯ 0**
5. âš ï¸ Webhook é”™è¯¯ç‡ **83%**

---

## ğŸ” **æ ¹æœ¬åŸå› **

é€šè¿‡åˆ†æ Firebase Functions æ—¥å¿—ï¼Œæˆ‘å‘ç°ï¼š

### **Firebase Functions æ²¡æœ‰å¤„ç† `checkout.session.completed` äº‹ä»¶ï¼**

**è¯æ®ï¼š**

1. Firebase æ—¥å¿—ä¸­åªæœ‰ `customer.subscription.created/updated` äº‹ä»¶çš„è®°å½•
2. è®¢é˜…çŠ¶æ€æ˜¾ç¤ºä¸º `"status": "incomplete"`
3. æ²¡æœ‰ä»»ä½•å…³äº `checkout.session.completed` äº‹ä»¶çš„æ—¥å¿—è¾“å‡º
4. æ²¡æœ‰ "ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: checkout.session.completed" çš„æ—¥å¿—

**è¿™è¯´æ˜ï¼š**
- Stripe å‘é€äº† `checkout.session.completed` äº‹ä»¶åˆ° Firebase Functions
- Firebase Functions è¿”å›äº† 200 OKï¼ˆæ‰€ä»¥ Stripe è®¤ä¸ºæˆåŠŸï¼‰
- ä½†æ˜¯ä»£ç å†…éƒ¨æ²¡æœ‰æ‰§è¡Œ `handleCheckoutCompleted` å‡½æ•°æ¥æ·»åŠ  Credits

---

## ğŸ’¡ **å¯èƒ½çš„åŸå› **

### **åŸå›  1ï¼šWebhook äº‹ä»¶ç±»å‹æ˜ å°„é—®é¢˜**

åœ¨ Firebase Functions çš„ `stripeWebhook` å‡½æ•°ä¸­ï¼Œå¯èƒ½ `checkout.session.completed` äº‹ä»¶æ²¡æœ‰è¢«æ­£ç¡®åŒ¹é…åˆ° `handleCheckoutCompleted` å‡½æ•°ã€‚

```javascript
switch (event.type) {
    case 'checkout.session.completed':
        await handleCheckoutCompleted(event.data.object, isTestMode);
        break;
    // ...
}
```

å¦‚æœ `event.type` ä¸å®Œå…¨ç­‰äº `'checkout.session.completed'`ï¼Œè¿™ä¸ª case å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚

### **åŸå›  2ï¼šæ—¥å¿—ä»£ç æœªç”Ÿæ•ˆ**

æˆ‘ä»¬ä¹‹å‰æ·»åŠ çš„è¯¦ç»†æ—¥å¿—ä»£ç å¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®éƒ¨ç½²ï¼Œæˆ–è€…è¢« Firebase Functions çš„é…ç½®è¿‡æ»¤æ‰äº†ã€‚

---

## âœ… **è§£å†³æ–¹æ¡ˆ**

### **æ­¥éª¤ 1ï¼šéªŒè¯ä»£ç é€»è¾‘**

è¯·æ£€æŸ¥ `/Users/cavlinyeung/ai-bank-parser/firebase-functions/index.js` æ–‡ä»¶ä¸­çš„ `stripeWebhook` å‡½æ•°ï¼Œç¡®è®¤ï¼š

1. `switch (event.type)` è¯­å¥ä¸­åŒ…å« `case 'checkout.session.completed'`
2. è¯¥ case è°ƒç”¨äº† `await handleCheckoutCompleted(event.data.object, isTestMode);`

### **æ­¥éª¤ 2ï¼šæ·»åŠ æ›´å¤šæ—¥å¿—**

åœ¨ `stripeWebhook` å‡½æ•°çš„å¼€å¤´ï¼Œæ·»åŠ ä»¥ä¸‹æ—¥å¿—ï¼š

```javascript
console.log('========== WEBHOOK START ==========');
console.log('Event Type:', event.type);
console.log('Event ID:', event.id);
console.log('Is Test Mode:', isTestMode);
console.log('========================================');
```

åœ¨ `switch (event.type)` çš„ `default` åˆ†æ”¯ä¸­æ·»åŠ ï¼š

```javascript
default:
    console.log(`âš ï¸ æœªå¤„ç†çš„äº‹ä»¶ç±»å‹: ${event.type}`);
    console.log('Event Object:', JSON.stringify(event, null, 2));
```

### **æ­¥éª¤ 3ï¼šé‡æ–°éƒ¨ç½²**

```bash
cd /Users/cavlinyeung/ai-bank-parser
firebase deploy --only functions:stripeWebhook
```

### **æ­¥éª¤ 4ï¼šé‡æ–°æµ‹è¯•**

1. æ‰“å¼€ https://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. ä½¿ç”¨æµ‹è¯•å¡ï¼š**4242 4242 4242 4242**
4. å®Œæˆæ”¯ä»˜

### **æ­¥éª¤ 5ï¼šæŸ¥çœ‹è¯¦ç»†æ—¥å¿—**

```bash
firebase functions:log --only stripeWebhook 2>&1 | tail -100
```

æŸ¥æ‰¾ï¼š
- `========== WEBHOOK START ==========`
- `Event Type: checkout.session.completed`
- `âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼)`

---

## ğŸ¯ **é¢„æœŸç»“æœ**

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

1. Firebase æ—¥å¿—ä¸­å‡ºç° `Event Type: checkout.session.completed`
2. æ—¥å¿—ä¸­å‡ºç° `âœ… çµå¸³å®Œæˆ (æ¸¬è©¦æ¨¡å¼)`
3. æ—¥å¿—ä¸­å‡ºç° `ğŸ’° æº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶`
4. ç”¨æˆ·çš„ Credits ä» 0 å¢åŠ åˆ° 100

---

## ğŸ“ **å¦‚æœä»ç„¶ä¸æˆåŠŸ**

å¦‚æœä»¥ä¸Šæ­¥éª¤åä»ç„¶å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ï¼š

1. æ£€æŸ¥ Stripe Test Mode Webhook é…ç½®ï¼Œç¡®è®¤å®ƒç›‘å¬äº† `checkout.session.completed` äº‹ä»¶
2. æ£€æŸ¥ Firebase Functions çš„ç¯å¢ƒå˜é‡é…ç½®
3. æ£€æŸ¥ Firestore å®‰å…¨è§„åˆ™æ˜¯å¦é˜»æ­¢äº† Credits çš„æ›´æ–°

**ç«‹å³æ‰§è¡Œæ­¥éª¤ 1-5ï¼Œç„¶åå‘Šè¯‰æˆ‘ç»“æœï¼** ğŸ™

