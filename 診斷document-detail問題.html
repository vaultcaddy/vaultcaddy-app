<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Detail è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.6;
        }
        .status-box {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        .status-box h3 {
            margin-top: 0;
            color: #374151;
        }
        .success { border-color: #10b981; background: #d1fae5; }
        .error { border-color: #ef4444; background: #fee2e2; }
        .warning { border-color: #f59e0b; background: #fef3c7; }
        .loading { border-color: #3b82f6; background: #dbeafe; }
        pre {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }
        .button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Document Detail å•é¡Œè¨ºæ–·</h1>
    <p>é€™å€‹å·¥å…·æœƒæª¢æŸ¥ document-detail.html é é¢ç„¡æ³•è¼‰å…¥çš„åŸå› ã€‚</p>
    
    <div id="diagnostics">
        <div class="status-box loading">
            <h3>æ­£åœ¨æª¢æŸ¥...</h3>
            <p>è«‹ç¨å€™ï¼Œæ­£åœ¨è¨ºæ–·å•é¡Œ...</p>
        </div>
    </div>
    
    <button class="button" onclick="window.location.reload()">ğŸ”„ é‡æ–°è¨ºæ–·</button>
    <button class="button" onclick="window.location.href='dashboard.html'" style="background: #6b7280;">ğŸ“Š è¿”å› Dashboard</button>
    
    <script defer src="config.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script defer src="simple-auth.js"></script>
    <script defer src="simple-data-manager.js"></script>
    
    <script>
        const results = [];
        
        function addResult(title, status, details) {
            results.push({ title, status, details });
            updateDisplay();
        }
        
        function updateDisplay() {
            const container = document.getElementById('diagnostics');
            container.innerHTML = results.map(r => `
                <div class="status-box ${r.status}">
                    <h3>${r.status === 'success' ? 'âœ…' : r.status === 'error' ? 'âŒ' : r.status === 'warning' ? 'âš ï¸' : 'â³'} ${r.title}</h3>
                    ${r.details ? `<pre>${r.details}</pre>` : ''}
                </div>
            `).join('');
        }
        
        async function runDiagnostics() {
            // æª¢æŸ¥ 1: URL åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            const documentId = urlParams.get('id');
            
            if (!projectId | !documentId) {
                addResult('URL åƒæ•¸æª¢æŸ¥', 'warning', 
                    `âš ï¸ ç¼ºå°‘URLåƒæ•¸\nè«‹è¨ªå•: https://vaultcaddy.com/document-detail.html?project=YOUR_PROJECT&id=YOUR_DOC`);
            } else {
                addResult('URL åƒæ•¸æª¢æŸ¥', 'success', 
                    `Project ID: ${projectId}\nDocument ID: ${documentId}`);
            }
            
            // æª¢æŸ¥ 2: Firebase é…ç½®
            await new Promise(resolve => setTimeout(resolve, 500));
            if (typeof firebase !== 'undefined') {
                addResult('Firebase SDK', 'success', 'Firebase SDK å·²è¼‰å…¥');
            } else {
                addResult('Firebase SDK', 'error', 'Firebase SDK æœªè¼‰å…¥');
                return;
            }
            
            // æª¢æŸ¥ 3: SimpleAuth
            let attempts = 0;
            while ((!window.simpleAuth | !window.simpleAuth.initialized) && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.simpleAuth && window.simpleAuth.initialized) {
                if (window.simpleAuth.currentUser) {
                    addResult('SimpleAuth èªè­‰', 'success', 
                        `âœ… å·²ç™»å…¥\nç”¨æˆ¶: ${window.simpleAuth.currentUser.email}`);
                } else {
                    addResult('SimpleAuth èªè­‰', 'error', 
                        'âŒ æœªç™»å…¥\nè«‹å…ˆç™»å…¥ VaultCaddy');
                    return;
                }
            } else {
                addResult('SimpleAuth èªè­‰', 'error', 
                    `âŒ SimpleAuth åˆå§‹åŒ–å¤±æ•—\nç­‰å¾…äº† ${attempts * 100}ms`);
                return;
            }
            
            // æª¢æŸ¥ 4: SimpleDataManager
            attempts = 0;
            while ((!window.simpleDataManager | !window.simpleDataManager.initialized) && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.simpleDataManager && window.simpleDataManager.initialized) {
                addResult('SimpleDataManager', 'success', 'SimpleDataManager å·²å°±ç·’');
            } else {
                addResult('SimpleDataManager', 'error', 
                    `âŒ SimpleDataManager åˆå§‹åŒ–å¤±æ•—\nç­‰å¾…äº† ${attempts * 100}ms`);
                return;
            }
            
            // æª¢æŸ¥ 5: æ–‡æª”æ•¸æ“šç²å–
            if (projectId && documentId) {
                try {
                    const doc = await window.simpleDataManager.getDocument(projectId, documentId);
                    if (doc) {
                        addResult('æ–‡æª”æ•¸æ“šç²å–', 'success', 
                            `âœ… æ–‡æª”å­˜åœ¨\nåç¨±: ${doc.name | doc.fileName | 'æœªå‘½å'}\nç‹€æ…‹: ${doc.status | 'æœªçŸ¥'}\nè™•ç†é€²åº¦: ${doc.processingProgress | 0}%`);
                        
                        // æª¢æŸ¥è™•ç†æ•¸æ“š
                        if (doc.processedData) {
                            const transCount = doc.processedData.transactions?.length | 0;
                            addResult('è™•ç†æ•¸æ“šæª¢æŸ¥', 'success', 
                                `âœ… æœ‰è™•ç†æ•¸æ“š\näº¤æ˜“è¨˜éŒ„: ${transCount} ç­†`);
                        } else {
                            addResult('è™•ç†æ•¸æ“šæª¢æŸ¥', 'warning', 
                                'âš ï¸ æ–‡æª”å°šæœªè™•ç†æˆ–è™•ç†å¤±æ•—');
                        }
                    } else {
                        addResult('æ–‡æª”æ•¸æ“šç²å–', 'error', 
                            'âŒ æ‰¾ä¸åˆ°æ–‡æª”\nå¯èƒ½å·²è¢«åˆªé™¤æˆ–æ²’æœ‰æ¬Šé™');
                    }
                } catch (error) {
                    addResult('æ–‡æª”æ•¸æ“šç²å–', 'error', 
                        `âŒ ç²å–æ–‡æª”å¤±æ•—\nError: ${error.message}\nStack: ${error.stack}`);
                }
            }
            
            // æª¢æŸ¥ 6: Console éŒ¯èª¤
            const errors = [];
            const originalError = console.error;
            console.error = function(...args) {
                errors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            if (errors.length > 0) {
                addResult('Console éŒ¯èª¤', 'error', 
                    `ç™¼ç¾ ${errors.length} å€‹éŒ¯èª¤:\n${errors.join('\n')}`);
            } else {
                addResult('Console éŒ¯èª¤', 'success', 'âœ… ç„¡ Console éŒ¯èª¤');
            }
            
            // ç¸½çµ
            const hasError = results.some(r => r.status === 'error');
            if (hasError) {
                addResult('è¨ºæ–·çµæœ', 'error', 
                    'âŒ ç™¼ç¾å•é¡Œï¼Œè«‹æ ¹æ“šä¸Šé¢çš„éŒ¯èª¤ä¿¡æ¯ä¿®å¾©');
            } else {
                addResult('è¨ºæ–·çµæœ', 'success', 
                    'âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼\nå¦‚æœé é¢ä»ç„¡æ³•é¡¯ç¤ºï¼Œè«‹æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·(F12)æŸ¥çœ‹ Console éŒ¯èª¤');
            }
        }
        
        // ç­‰å¾…æ‰€æœ‰è…³æœ¬è¼‰å…¥å¾Œé–‹å§‹è¨ºæ–·
        window.addEventListener('load', () => {
            setTimeout(runDiagnostics, 1000);
        });
    </script>

    <!-- Google Analytics äº‹ä»¶è·Ÿè¸ª -->
    <script src="/ga-event-tracking.js"></script>
</body>
</html>








