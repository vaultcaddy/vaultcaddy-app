# ⚠️ 重要发现：数据被修改的原因

**发现时间**: 2026-01-09  
**问题**: 图3中原始数据与页面显示不一致

---

## 🔍 问题分析

### 用户反馈的问题

1. **图3（PDF原始数据）**: 25,823.00
2. **图1（页面显示）**: 25,823.00（但之前可能被修改过）
3. **疑问**: 是否因为做了加减计算导致无法回到正确内容？

---

## 💡 根本原因

### 发现的计算代码

在 `document-detail-new.js` 中发现了**修改原始数据**的代码：

```javascript
// ❌ 问题代码：toggleTransactionType 函数
function toggleTransactionType(index) {
    const transaction = currentDocument.processedData.transactions[index];
    
    // ⚠️ 这行代码会永久修改原始数据！
    transaction.amount = -parseFloat(transaction.amount || 0);
    
    // 更新 UI
    displayDocumentContent();
    
    // 标记为有未保存更改
    markAsChanged();
}
```

### 问题说明

当用户点击 +/- 按钮时：
1. ✅ 数据会在内存中反转正负号
2. ❌ **如果保存，会永久改变 Firebase 中的原始数据**
3. ❌ 无法恢复到PDF原始值（除非重新上传）

---

## 🎯 我们应该做什么

### VaultCaddy 的核心目标

根据用户的说明：
> "我們要做的只是將pdf／圖片中的內容分類放在正確的地方中"

**核心原则**：
- ✅ **提取** PDF/图片中的内容
- ✅ **分类** 到正确的字段
- ✅ **显示** 原始数据
- ❌ **不应该** 进行任何计算或修改
- ❌ **不应该** 改变金额正负
- ❌ **不应该** 重新计算余额

---

## 🔧 已实施的修复

### 1. ✅ 修复金额换行问题（图2）

**问题**: 25,823.00 分成了两行显示

**原因**: 列宽不足 + 缺少 `white-space: nowrap`

**修复**:
```javascript
// 金额单元格
style="... white-space: nowrap; min-width: 90px; ..."

// 余额单元格
style="... white-space: nowrap; ..."
```

**效果**: 
- ✅ 金额始终在一行显示
- ✅ 不会换行

---

### 2. ✅ 添加导出提示（图1）

**新提示内容**:
```
💡 精簡模式：已隱藏次要欄位（類型、參考編號、支票號、附件）。
📊 如需查看完整數據（包括備注、附件等），請點擊頂部「Export」按鈕導出。
```

**目的**:
- 告知用户隐藏的字段在哪里查看
- 引导用户使用 Export 功能
- 减少用户困惑

---

## ⚠️ 当前数据状态评估

### 问题：数据是否已被修改？

**检查方法**:

1. **比对 PDF 和页面显示**
   ```
   PDF原始: 25,823.00（支出）
   页面显示: 25,823.00（红色，有 - 号）
   结论: ✅ 如果符号一致，数据未被修改
   ```

2. **检查 Firebase 数据**
   - 打开浏览器开发者工具（F12）
   - Console 标签页执行：
   ```javascript
   console.log(currentDocument.processedData.transactions);
   ```
   - 查看每笔交易的 `amount` 值
   - 对比 PDF 原始值

### 判断标准

| PDF原始 | 页面显示 | Firebase值 | 状态 |
|---------|---------|-----------|------|
| -25,823 | [-] 25,823 | -25823 | ✅ 正确 |
| -25,823 | [+] 25,823 | 25823 | ❌ 被反转 |
| 59,417.89 | [+] 59,417.89 | 59417.89 | ✅ 正确 |

---

## 🔄 是否需要重新上传？

### 情况1: 数据未被修改 ✅

**判断标准**:
- PDF 和页面显示的金额、正负号完全一致
- 从未点击过 +/- 按钮（或点击了但未保存）

**结论**: 
- ✅ **不需要重新上传**
- ✅ 数据是正确的
- ✅ 只需刷新页面验证修复效果

---

### 情况2: 数据已被修改 ❌

**判断标准**:
- PDF 和页面显示的正负号不一致
- 点击过 +/- 按钮并保存了

**解决方案**:
1. **方案A: 重新上传文档** （推荐）
   - ✅ 最简单
   - ✅ 数据100%准确
   - ✅ 重新让AI提取

2. **方案B: 手动修正**
   - 逐笔点击 +/- 按钮恢复正确符号
   - 保存修改
   - ❌ 容易出错
   - ❌ 费时费力

---

## 📋 用户操作指南

### 立即测试步骤

1. **清除缓存**
   ```bash
   Cmd/Ctrl + Shift + R
   ```

2. **验证金额显示**
   - [ ] 25,823.00 在一行显示（不换行）
   - [ ] 59,417.89 在一行显示
   - [ ] 所有金额都在一行

3. **查看提示信息**
   - [ ] 页面顶部显示蓝色提示框
   - [ ] 提示中提到 "Export" 按钮
   - [ ] 提示内容清晰易懂

4. **验证数据准确性**
   - [ ] 打开 PDF 文件
   - [ ] 逐笔对比金额和正负号
   - [ ] 记录不一致的交易

---

## 🔮 未来建议：如何避免数据被修改

### 方案1: 禁用 +/- 按钮的计算功能

```javascript
// ✅ 改进方案：只改变显示，不改变数据
function toggleTransactionType(index) {
    // 只在UI层面切换显示
    // 不修改 currentDocument.processedData
    // 用一个临时状态变量存储UI状态
}
```

### 方案2: 添加"恢复原始值"功能

```javascript
function restoreOriginalAmount(index) {
    // 从 originalData 恢复
    const original = originalDocument.processedData.transactions[index];
    currentDocument.processedData.transactions[index].amount = original.amount;
}
```

### 方案3: 数据不可变性

```javascript
// 使用只读模式
// 所有编辑在临时副本中进行
// 明确的"应用更改"按钮
```

---

## ✅ 本次修复总结

### 已修复问题

1. ✅ 金额换行问题（添加 `white-space: nowrap`）
2. ✅ 添加 Export 提示说明
3. ✅ 增加最小宽度防止挤压

### 待确认问题

1. ⚠️ 当前数据是否已被修改？
   - 需要用户对比 PDF 验证
   
2. ⚠️ 是否需要重新上传？
   - 取决于数据准确性验证结果

### 不建议修改的功能

1. ❌ **不建议删除 +/- 按钮**
   - 用户明确表示需要（以防AI出错）
   
2. ❌ **不建议删除切换功能**
   - 但应该添加警告提示
   
3. ✅ **建议添加确认对话框**
   ```javascript
   if (confirm('切換收入/支出會修改原始數據，確定繼續嗎？')) {
       // 执行切换
   }
   ```

---

## 📝 用户决策清单

请用户确认以下问题：

### 问题1: 数据准确性
- [ ] 我已对比 PDF，所有金额和正负号都正确
- [ ] 我发现有错误，需要重新上传文档
- [ ] 我不确定，需要帮助验证

### 问题2: +/- 按钮功能
- [ ] 保留切换功能（当前方案）
- [ ] 添加确认对话框（防止误操作）
- [ ] 改为只显示，不修改数据

### 问题3: 是否需要其他说明
- [ ] Export 说明已足够
- [ ] 需要添加更多使用指引
- [ ] 需要添加字段说明（如"类型"、"参考编号"的用途）

---

**请用户先刷新页面验证修复效果，然后告知数据准确性情况！** ✅

