# ğŸ” è¯·æ£€æŸ¥è´­ä¹°è®°å½•æ•°é‡

## ğŸ“‹ **è¯Šæ–­æ­¥éª¤**

ä»æ‚¨çš„æˆªå›¾çœ‹ï¼š
- âœ… Stripe åªæœ‰ **1 ä¸ª** Webhook
- âœ… `processedStripeEvents` é›†åˆå­˜åœ¨

**ä½† Credits è¿˜æ˜¯å¢åŠ äº† 200ï¼**

---

## ğŸ” **è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹**

### **æ£€æŸ¥ 1ï¼šè´­ä¹°è®°å½•æ•°é‡**

1. å‰å¾€ï¼šhttps://vaultcaddy.com/account.html

2. å‘ä¸‹æ»šåŠ¨åˆ° **"è³¼è²·è¨˜éŒ„"** éƒ¨åˆ†

3. **æŸ¥çœ‹æœ€è¿‘çš„è´­ä¹°è®°å½•**ï¼š
   - æ˜¯å¦æœ‰ **2 æ¡** `VaultCaddy æœˆè²» test` è®°å½•ï¼Ÿ
   - è¿˜æ˜¯åªæœ‰ **1 æ¡**ï¼Ÿ

**å¦‚æœæœ‰ 2 æ¡è´­ä¹°è®°å½•**ï¼š
- è¯´æ˜ `handleCheckoutCompleted` è¢«è°ƒç”¨äº† 2 æ¬¡
- éœ€è¦æ£€æŸ¥ä¸ºä»€ä¹ˆ

**å¦‚æœåªæœ‰ 1 æ¡è´­ä¹°è®°å½•**ï¼š
- è¯´æ˜é—®é¢˜å¯èƒ½åœ¨ `addCredits` å‡½æ•°å†…éƒ¨
- å¯èƒ½æ˜¯ Credits è¢«æ·»åŠ äº† 2 æ¬¡ï¼ˆ100 + 100 = 200ï¼‰

---

### **æ£€æŸ¥ 2ï¼šprocessedStripeEvents ä¸­çš„æ‰€æœ‰æ–‡æ¡£**

1. å‰å¾€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. ç‚¹å‡» `processedStripeEvents` é›†åˆ

3. **æŸ¥çœ‹æ‰€æœ‰æ–‡æ¡£**

4. **ç­›é€‰ checkout.session.completed ç±»å‹çš„æ–‡æ¡£**ï¼š
   - æœ‰å¤šå°‘ä¸ªï¼Ÿ
   - eventId åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

**è¯·æˆªå›¾æˆ–å‘Šè¯‰æˆ‘**ï¼š
```
æ–‡æ¡£ 1: eventId = evt_1SdlLNJmiQ31C0GT20GrlpqW, eventType = checkout.session.completed
æ–‡æ¡£ 2: eventId = evt_xxxxxx, eventType = checkout.session.completed ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
```

---

### **æ£€æŸ¥ 3ï¼šæŸ¥çœ‹ Firestore ç”¨æˆ·æ–‡æ¡£çš„å®Œæ•´å†…å®¹**

1. å‰å¾€ï¼šhttps://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore

2. ç‚¹å‡» `users` é›†åˆ

3. æ‰¾åˆ°æµ‹è¯•ç”¨æˆ·ï¼ˆ`vaultcaddy@gmail.com` æˆ– ID ä¸º `AZ55k5FJBofAeKE09AYbGVlEoDy1`ï¼‰

4. **æŸ¥çœ‹ä»¥ä¸‹å­—æ®µ**ï¼š
   - `credits`: å½“å‰å€¼æ˜¯å¤šå°‘ï¼Ÿ
   - `currentCredits`: å½“å‰å€¼æ˜¯å¤šå°‘ï¼Ÿ
   - `planType`: æ˜¯å¦ä¸º "Pro Plan"ï¼Ÿ
   - `resetDate`: æ˜¯å¦è®¾ç½®æ­£ç¡®ï¼Ÿ

5. **è¿›å…¥ `purchaseHistory` å­é›†åˆ**ï¼š
   - æœ‰å¤šå°‘æ¡è´­ä¹°è®°å½•ï¼Ÿ
   - æ¯æ¡è®°å½•çš„ Credits æ˜¯å¤šå°‘ï¼Ÿ

---

## ğŸ’¡ **ç®€åŒ–çš„è¯Šæ–­æ–¹æ³•**

### **æ–¹æ³• 1ï¼šæŸ¥çœ‹è´­ä¹°è®°å½•é¡µé¢**

1. è®¿é—®ï¼šhttps://vaultcaddy.com/account.html

2. å‘ä¸‹æ»šåŠ¨åˆ°"è³¼è²·è¨˜éŒ„"

3. **å‘Šè¯‰æˆ‘çœ‹åˆ°äº†ä»€ä¹ˆ**ï¼š
   - æœ‰å‡ æ¡ `VaultCaddy æœˆè²» test` è®°å½•ï¼Ÿ
   - æ¯æ¡è®°å½•æ˜¾ç¤º +100 è¿˜æ˜¯ +200ï¼Ÿ

---

### **æ–¹æ³• 2ï¼šæŸ¥çœ‹ processedStripeEvents æ•°é‡**

1. åœ¨ Firestore ä¸­æ‰“å¼€ `processedStripeEvents` é›†åˆ

2. **å‘Šè¯‰æˆ‘**ï¼š
   - æ€»å…±æœ‰å‡ ä¸ªæ–‡æ¡£ï¼Ÿ
   - æœ‰å‡ ä¸ªæ–‡æ¡£çš„ `eventType` æ˜¯ `checkout.session.completed`ï¼Ÿ

---

## ğŸ¯ **å¯èƒ½çš„é—®é¢˜**

åŸºäºç›®å‰çš„ä¿¡æ¯ï¼Œæˆ‘çŒœæµ‹å¯èƒ½æ˜¯ä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š

### **å¯èƒ½æ€§ 1ï¼šæœ‰ 2 ä¸ªä¸åŒçš„ checkout.session.completed äº‹ä»¶**

è™½ç„¶åªæœ‰ 1 ä¸ª Webhookï¼Œä½† Stripe å¯èƒ½å‘é€äº† 2 ä¸ªä¸åŒçš„ `checkout.session.completed` äº‹ä»¶ï¼ˆæ¯ä¸ªæœ‰ä¸åŒçš„ event IDï¼‰ã€‚

### **å¯èƒ½æ€§ 2ï¼šaddCredits å‡½æ•°è¢«è°ƒç”¨äº† 2 æ¬¡**

è™½ç„¶ `handleCheckoutCompleted` åªè¢«è°ƒç”¨äº† 1 æ¬¡ï¼Œä½†å†…éƒ¨çš„ `addCredits` å¯èƒ½è¢«è°ƒç”¨äº† 2 æ¬¡ï¼ˆä¾‹å¦‚ï¼šäº§å“æœ‰ 2 ä¸ª line itemsï¼‰ã€‚

### **å¯èƒ½æ€§ 3ï¼šæ—§çš„ä»£ç è¿˜åœ¨è¿è¡Œ**

Firebase Functions çš„éƒ¨ç½²å¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨ç”Ÿæ•ˆï¼Œè¿˜åœ¨ä½¿ç”¨æ—§çš„ä»£ç ã€‚

---

## ğŸ™ **è¯·æä¾›ä»¥ä¸‹ç®€å•ä¿¡æ¯**

1. **è´­ä¹°è®°å½•æœ‰å‡ æ¡ï¼Ÿ**ï¼ˆ1 æ¡è¿˜æ˜¯ 2 æ¡ï¼Ÿï¼‰
2. **processedStripeEvents ä¸­æœ‰å‡ ä¸ª checkout.session.completed æ–‡æ¡£ï¼Ÿ**ï¼ˆ1 ä¸ªè¿˜æ˜¯ 2 ä¸ªï¼Ÿï¼‰
3. **å½“å‰ Credits æ€»æ•°æ˜¯å¤šå°‘ï¼Ÿ**ï¼ˆ200 è¿˜æ˜¯å…¶ä»–ï¼Ÿï¼‰

æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥å‡†ç¡®æ‰¾åˆ°é—®é¢˜ï¼ ğŸ’ª

