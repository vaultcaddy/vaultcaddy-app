# ✅ Stripe 新价格创建指南

**日期**: 2026-01-08  
**任务**: 为现有产品创建新价格（复制所有设置，只更新价格）

---

## 📋 重要说明

**⚠️ Stripe 不允许直接修改现有 Price 的价格**

解决方案：
1. **复制现有价格的所有设置**（billing_scheme, tiers, metadata 等）
2. **只更新价格金额**
3. **创建新价格**

---

## 🚀 使用方法

### 步骤 1: 为产品 1 创建新价格

```bash
node create-new-prices-copy-existing.js <stripe_secret_key> prod_Tb2443GvCbe4Pp
```

### 步骤 2: 为产品 2 创建新价格

```bash
node create-new-prices-copy-existing.js <stripe_secret_key> prod_Tb24SiE4usHRDS
```

**示例**:
```bash
# 为 VaultCaddy Monthly 创建新价格
node create-new-prices-copy-existing.js sk_live_xxx prod_Tb2443GvCbe4Pp

# 为 VaultCaddy Yearly 创建新价格
node create-new-prices-copy-existing.js sk_live_xxx prod_Tb24SiE4usHRDS
```

---

## 📊 新价格配置

脚本会为每个产品创建以下新价格：

| 货币 | 月付 | 年付 |
|------|------|------|
| HKD | $28.00/月 | $264.00/年 ($22/月) |
| USD | $3.88/月 | $34.56/年 ($2.88/月) |
| JPY | ¥599/月 | ¥5,748/年 (¥479/月) |
| KRW | ₩5,588/월 | ₩53,616/년 (₩4,468/월) |

**每个产品会创建 8 个新价格**（4 种货币 × 2 种周期）

---

## 🔍 脚本功能

### 1. 查看现有价格
- 显示产品的所有现有价格
- 按货币和周期分组显示
- 显示价格状态（激活/停用）

### 2. 复制现有设置
脚本会复制以下所有设置：
- ✅ `recurring` 配置（interval, usage_type, meter 等）
- ✅ `billing_scheme`（如果有）
- ✅ `tiers` 和 `tiers_mode`（如果有）
- ✅ `transform_quantity`（如果有）
- ✅ `metadata`（保留原有，添加新标记）
- ✅ `nickname`（如果有）
- ✅ `tax_behavior`（如果有）

### 3. 只更新价格
- 使用新价格金额替换 `unit_amount`
- 保持所有其他设置不变

---

## 📝 输出示例

脚本运行后会输出：

```
📦 产品: VaultCaddy Monthly
   Product ID: prod_Tb2443GvCbe4Pp

💰 找到 4 个价格

📋 现有价格分组：

   hkd:
     month: 1 个价格
       1. ✅ price_xxx: 58.00 HKD (激活)
     year: 1 个价格
       1. ✅ price_xxx: 552.00 HKD (激活)
   usd:
     month: 1 个价格
       1. ✅ price_xxx: 5.00 USD (激活)
     year: 1 个价格
       1. ✅ price_xxx: 50.00 USD (激活)

🆕 创建新价格: HKD month
   基于: price_xxx
   新金额: 28.00 HKD
✅ 新价格创建成功！
   Price ID: price_NEW_ID
   金额: 28.00 HKD
   周期: month

...

✅ 完成！新价格已创建
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📦 共创建 8 个新价格:

1. price_NEW_HKD_MONTHLY
   金额: 28.00 HKD/month
   货币: HKD
2. price_NEW_HKD_YEARLY
   金额: 264.00 HKD/year
   货币: HKD
...
```

---

## 📝 更新代码

创建新价格后，需要更新以下文件：

### 1. `firebase-functions/index.js`

更新 `createStripeCheckoutSession` 函数中的价格映射：

```javascript
const productionPriceMapping = {
    monthly: {
        basePriceId: 'price_NEW_HKD_MONTHLY_ID',  // 新的 HKD 月付 Price ID
        usagePriceId: 'price_EXISTING_USAGE_ID'  // 保持现有的用量计费 Price ID
    },
    yearly: {
        basePriceId: 'price_NEW_HKD_YEARLY_ID',  // 新的 HKD 年付 Price ID
        usagePriceId: 'price_EXISTING_USAGE_ID'  // 保持现有的用量计费 Price ID
    }
};
```

### 2. 多货币支持

如果需要支持多货币，可以添加：

```javascript
const priceMappingByCurrency = {
    hkd: {
        monthly: 'price_NEW_HKD_MONTHLY_ID',
        yearly: 'price_NEW_HKD_YEARLY_ID'
    },
    usd: {
        monthly: 'price_NEW_USD_MONTHLY_ID',
        yearly: 'price_NEW_USD_YEARLY_ID'
    },
    jpy: {
        monthly: 'price_NEW_JPY_MONTHLY_ID',
        yearly: 'price_NEW_JPY_YEARLY_ID'
    },
    krw: {
        monthly: 'price_NEW_KRW_MONTHLY_ID',
        yearly: 'price_NEW_KRW_YEARLY_ID'
    }
};
```

---

## ⚠️ 注意事项

1. **保留旧价格**: 不要删除旧价格，保留用于历史记录和现有订阅
2. **测试新价格**: 创建后先在测试环境测试支付流程
3. **更新文档**: 记录新的 Price ID，方便后续维护
4. **监控订阅**: 确保现有订阅不受影响
5. **验证设置**: 确认新价格的所有设置与旧价格一致

---

## 🔍 验证新价格

在 Stripe Dashboard 中验证：

1. 进入产品页面
2. 查看价格列表
3. 确认新价格已创建
4. 检查所有设置是否正确

---

## 📞 需要帮助

如果遇到问题：

1. **检查 Stripe Secret Key**: 确保使用的是正确的密钥
2. **检查产品 ID**: 确认产品 ID 正确
3. **查看错误信息**: 脚本会显示详细的错误信息
4. **参考 Stripe 文档**: https://stripe.com/docs/api/prices/create

---

**创建时间**: 2026-01-08  
**最后更新**: 2026-01-08

