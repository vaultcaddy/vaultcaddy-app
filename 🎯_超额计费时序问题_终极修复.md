# ğŸ¯ è¶…é¢è®¡è´¹æ—¶åºé—®é¢˜ - ç»ˆæä¿®å¤

## ğŸ› é—®é¢˜æ ¹æº

**å‘ç°æ—¶é—´ï¼š** 2025-12-17 ä¸‹åˆ7:24  
**ä¸¥é‡ç¨‹åº¦ï¼š** ğŸ”´ ä¸¥é‡ - æ—¶åºé—®é¢˜å¯¼è‡´æ— æ³•æ­£ç¡®æ”¶å–è¶…é¢è´¹ç”¨

---

## ğŸ“Š é—®é¢˜æœ¬è´¨

### âŒ é”™è¯¯çš„æ—¶åº

```
ç”¨æˆ·ç‚¹å‡»å–æ¶ˆè®¢é˜…
    â†“
Stripe ç«‹å³æ‰§è¡Œï¼ˆå‡ æ¯«ç§’å†…ï¼‰ï¼š
  1. æŸ¥è¯¢å·²æŠ¥å‘Šçš„ usage records
  2. ç”Ÿæˆæœ€ç»ˆå‘ç¥¨ï¼ˆåŒ…å«å·²æœ‰çš„ usageï¼‰
  3. å®Œæˆå‘ç¥¨ï¼ˆfinalizeï¼‰
  4. æ”¯ä»˜å‘ç¥¨ï¼ˆpaidï¼‰âœ…
    â†“
è§¦å‘ customer.subscription.deleted webhook
    â†“
æˆ‘ä»¬çš„ä»£ç è¿è¡Œ
    â†“
å°è¯•æŠ¥å‘Š usage record
    â†“
âŒ é”™è¯¯ï¼šCannot create usage record (è®¢é˜…å·²å–æ¶ˆ)
    â†“
å°è¯•åˆ›å»ºæ–°å‘ç¥¨
    â†“
âŒ é”™è¯¯ï¼šInvoice is already paidï¼ˆåŒä¸€è®¡è´¹å‘¨æœŸå·²æœ‰å‘ç¥¨ï¼‰
```

### æ ¹æœ¬é—®é¢˜

**Stripe åœ¨è§¦å‘ webhook ä¹‹å‰å°±å·²ç»å®Œæˆäº†å‘ç¥¨ï¼** 

æˆ‘ä»¬çš„ä»£ç è¿è¡Œæ—¶ï¼Œå·²ç»å¤ªæ™šäº†ã€‚æ— æ³•ï¼š
- âŒ æŠ¥å‘Š usage recordï¼ˆè®¢é˜…å·²å–æ¶ˆï¼‰
- âŒ åˆ›å»ºæ–°å‘ç¥¨ï¼ˆåŒä¸€è®¡è´¹å‘¨æœŸå·²æœ‰å‘ç¥¨ï¼‰
- âŒ ä¿®æ”¹å·²å®Œæˆçš„å‘ç¥¨ï¼ˆå‘ç¥¨å·²æ”¯ä»˜ï¼‰

---

## âœ… æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

ç”¨æˆ·çš„å»ºè®®**å®Œå…¨æ­£ç¡®**ï¼š

> "ä¿®æ”¹ stripe åœ¨ç”¨æˆ·å–æ¶ˆè®¢é˜…/ç»­è®¢æ—¶ï¼Œå¿…é¡»å…ˆå‘æˆ‘ä»¬æå–è¶…é¢å‘ç¥¨åæ‰å‘ç”¨æˆ·æ”¶å–è¶…é¢æ”¶è´¹"

### æ­£ç¡®çš„æ—¶åº

```
ç”¨æˆ·ç‚¹å‡»å–æ¶ˆè®¢é˜…
    â†“
Stripe å¼€å§‹åˆ›å»ºå‘ç¥¨
    â†“
è§¦å‘ invoice.created webhook â† å‘ç¥¨è¿˜æœªå®Œæˆï¼
    â†“
æˆ‘ä»¬çš„ä»£ç è¿è¡Œï¼š
  1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¶…é¢ä½¿ç”¨ï¼ˆcredits < 0ï¼‰
  2. å¦‚æœæœ‰è¶…é¢ï¼Œç«‹å³æŠ¥å‘Š usage record
    â†“
Stripe å°† usage æ·»åŠ åˆ°å‘ç¥¨ä¸­
    â†“
Stripe å®Œæˆå¹¶æ”¯ä»˜å‘ç¥¨ï¼ˆåŒ…å«è¶…é¢è´¹ç”¨ï¼‰âœ…
    â†“
è§¦å‘ invoice.finalized webhook
    â†“
è§¦å‘ invoice.paid webhook
    â†“
è§¦å‘ customer.subscription.deleted webhook
    â†“
æˆ‘ä»¬åªéœ€è¦é‡ç½® creditsï¼Œä¸éœ€è¦åˆ›å»ºå‘ç¥¨
```

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. æ·»åŠ  `invoice.created` Webhook å¤„ç†

**æ–°å¢å‡½æ•°ï¼š`handleInvoiceCreated`**

```javascript
async function handleInvoiceCreated(invoice, isTestMode = false) {
    // 1. åªå¤„ç†è®¢é˜…ç›¸å…³çš„å‘ç¥¨
    if (!invoice.subscription) {
        return;
    }
    
    // 2. é€šè¿‡ customer ID æŸ¥æ‰¾ç”¨æˆ·
    const customerId = invoice.customer;
    const usersSnapshot = await admin.firestore().collection('users')
        .where('stripeCustomerId', '==', customerId)
        .limit(1)
        .get();
    
    if (usersSnapshot.empty) {
        return;
    }
    
    const userId = usersSnapshot.docs[0].id;
    const userData = usersSnapshot.docs[0].data();
    
    // 3. æ£€æŸ¥æ˜¯å¦æœ‰è¶…é¢ä½¿ç”¨
    const currentCredits = userData.currentCredits || 0;
    
    if (currentCredits >= 0) {
        console.log(`âœ… æ²¡æœ‰è¶…é¢ä½¿ç”¨ï¼Œæ— éœ€æŠ¥å‘Š`);
        return;
    }
    
    // 4. æœ‰è¶…é¢ä½¿ç”¨ï¼ŒæŠ¥å‘Šç»™ Stripe
    const overageAmount = Math.abs(currentCredits);
    const monthlyCredits = userData?.subscription?.monthlyCredits || 100;
    const totalUsage = monthlyCredits + overageAmount;
    
    const meteredItemId = userData?.subscription?.meteredSubscriptionItemId;
    
    // 5. æŠ¥å‘Šæ€»ä½¿ç”¨é‡ï¼ˆè®© Stripe è‡ªåŠ¨è®¡ç®—æ¢¯åº¦å®šä»·ï¼‰
    const stripeClient = isTestMode ? stripeTest : stripeLive;
    const usageRecord = await stripeClient.subscriptionItems.createUsageRecord(
        meteredItemId,
        {
            quantity: totalUsage,
            timestamp: Math.floor(Date.now() / 1000),
            action: 'set'
        }
    );
    
    console.log(`âœ… æˆåŠŸæŠ¥å‘Šæ€»ä½¿ç”¨é‡ç»™ Stripe: ${totalUsage}`);
    console.log(`ğŸ’µ Stripe ä¼šåœ¨æ­¤å‘ç¥¨ä¸­æ”¶å–è¶…é¢è´¹ç”¨: HK$${(overageAmount * 0.5).toFixed(2)}`);
}
```

### 2. ç®€åŒ– `customer.subscription.deleted` å¤„ç†

**ä¿®æ”¹åçš„ `handleSubscriptionCancelled`**ï¼š

```javascript
async function handleSubscriptionCancelled(subscription) {
    // ... (æŸ¥æ‰¾ç”¨æˆ·é€»è¾‘)
    
    // â„¹ï¸ è¶…é¢ä½¿ç”¨çš„æŠ¥å‘Šç°åœ¨åœ¨ invoice.created webhook ä¸­å¤„ç†
    if (currentCredits < 0) {
        const overageAmount = Math.abs(currentCredits);
        console.log(`ğŸ’° è®¢é˜…å–æ¶ˆæ—¶æ£€æµ‹åˆ°è¶…é¢ä½¿ç”¨: ${overageAmount} Credits`);
        console.log(`â„¹ï¸ è¶…é¢è´¹ç”¨åº”è¯¥å·²ç»åœ¨ invoice.created webhook ä¸­æŠ¥å‘Šç»™ Stripe`);
        console.log(`ğŸ“‹ Stripe ä¼šåœ¨æœ€ç»ˆå‘ç¥¨ä¸­åŒ…å«è¿™äº›è¶…é¢è´¹ç”¨`);
    }
    
    // ğŸ”¥ é‡è¦ï¼šé‡ç½® creditsï¼ˆä¿ç•™ä¸Šé™ 50ï¼‰
    const MAX_FREE_CREDITS = 50;
    let finalCredits = currentCredits;
    let clearedCredits = 0;
    
    if (currentCredits > MAX_FREE_CREDITS) {
        clearedCredits = currentCredits - MAX_FREE_CREDITS;
        finalCredits = MAX_FREE_CREDITS;
    } else if (currentCredits < 0) {
        finalCredits = 0;
    }
    
    // æ›´æ–°ç”¨æˆ·æ•°æ®
    await db.collection('users').doc(userId).update({
        credits: finalCredits,
        currentCredits: finalCredits,
        planType: 'Free Plan',
        subscription: admin.firestore.FieldValue.delete(),
        updatedAt: admin.firestore.FieldValue.serverTimestamp()
    });
}
```

### 3. æ·»åŠ  Webhook äº‹ä»¶ç›‘å¬

åœ¨ `stripeWebhook` å‡½æ•°çš„ switch è¯­å¥ä¸­æ·»åŠ ï¼š

```javascript
switch (event.type) {
    case 'invoice.created':  // â† æ–°å¢
        try {
            await handleInvoiceCreated(event.data.object, isTestMode);
        } catch (invoiceCreatedError) {
            console.error('âŒ å¤„ç†å‘ç¥¨åˆ›å»ºå¤±è´¥:', invoiceCreatedError);
        }
        break;
    
    // ... å…¶ä»–äº‹ä»¶å¤„ç†
}
```

---

## ğŸ”§ Stripe Dashboard é…ç½®

### âš ï¸ é‡è¦ï¼šæ·»åŠ  `invoice.created` Webhook

**æ­¥éª¤ï¼š**

1. **æ‰“å¼€ Stripe Dashboard - Webhooksï¼š**
   ```
   æµ‹è¯•æ¨¡å¼ï¼šhttps://dashboard.stripe.com/test/webhooks
   ç”Ÿäº§æ¨¡å¼ï¼šhttps://dashboard.stripe.com/webhooks
   ```

2. **æ‰¾åˆ°ç°æœ‰çš„ Webhook endpointï¼š**
   ```
   https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook
   ```

3. **ç‚¹å‡»ã€Œ...ã€â†’ã€Œç¼–è¾‘ã€**

4. **åœ¨ã€Œç›‘å¬çš„äº‹ä»¶ã€ä¸­æ·»åŠ ï¼š**
   ```
   âœ… invoice.created        â† æ–°å¢ï¼
   âœ… invoice.paid
   âœ… checkout.session.completed
   âœ… customer.subscription.created
   âœ… customer.subscription.updated
   âœ… customer.subscription.deleted
   ```

5. **ä¿å­˜æ›´æ”¹**

6. **æµ‹è¯• webhookï¼š**
   - ç‚¹å‡»ã€Œå‘é€æµ‹è¯• webhookã€
   - é€‰æ‹© `invoice.created`
   - æŸ¥çœ‹ Firebase Functions æ—¥å¿—

---

## ğŸ“Š å®Œæ•´å·¥ä½œæµç¨‹

### åœºæ™¯ 1ï¼šç”¨æˆ·å–æ¶ˆè®¢é˜…ï¼ˆæœ‰è¶…é¢ä½¿ç”¨ï¼‰

```
ç”¨æˆ·: Credits = -50ï¼ˆè¶…é¢ 50 ä¸ªï¼‰
    â†“
ç”¨æˆ·ç‚¹å‡»å–æ¶ˆè®¢é˜…
    â†“
ã€1. invoice.created webhookã€‘
    â”œâ”€ Stripe å¼€å§‹åˆ›å»ºæœ€ç»ˆå‘ç¥¨
    â”œâ”€ è§¦å‘æˆ‘ä»¬çš„ handleInvoiceCreated
    â”œâ”€ æ£€æµ‹åˆ° credits = -50
    â”œâ”€ æŠ¥å‘Š totalUsage = 150ï¼ˆ100 + 50ï¼‰
    â””â”€ Stripe å°†è¶…é¢è´¹ç”¨æ·»åŠ åˆ°å‘ç¥¨
    â†“
ã€2. invoice.finalizedã€‘
    â””â”€ Stripe å®Œæˆå‘ç¥¨ï¼ˆåŒ…å«è¶…é¢è´¹ç”¨ï¼‰
    â†“
ã€3. invoice.paidã€‘
    â””â”€ Stripe æ”¯ä»˜å‘ç¥¨
    â””â”€ é‡‘é¢ï¼šHK$58.00ï¼ˆè®¢é˜…ï¼‰+ HK$25.00ï¼ˆè¶…é¢ï¼‰= HK$83.00 âœ…
    â†“
ã€4. customer.subscription.deletedã€‘
    â”œâ”€ è§¦å‘æˆ‘ä»¬çš„ handleSubscriptionCancelled
    â”œâ”€ æ£€æµ‹åˆ° credits = -50
    â”œâ”€ è®°å½•ï¼šè¶…é¢è´¹ç”¨å·²åœ¨å‘ç¥¨ä¸­å¤„ç†
    â””â”€ é‡ç½® credits ä¸º 0
```

### åœºæ™¯ 2ï¼šç”¨æˆ·å–æ¶ˆè®¢é˜…ï¼ˆæ— è¶…é¢ä½¿ç”¨ï¼‰

```
ç”¨æˆ·: Credits = 20
    â†“
ç”¨æˆ·ç‚¹å‡»å–æ¶ˆè®¢é˜…
    â†“
ã€1. invoice.created webhookã€‘
    â”œâ”€ Stripe å¼€å§‹åˆ›å»ºæœ€ç»ˆå‘ç¥¨
    â”œâ”€ è§¦å‘æˆ‘ä»¬çš„ handleInvoiceCreated
    â”œâ”€ æ£€æµ‹åˆ° credits = 20ï¼ˆæ— è¶…é¢ï¼‰
    â””â”€ æ— éœ€æŠ¥å‘Š
    â†“
ã€2. invoice.paidã€‘
    â””â”€ é‡‘é¢ï¼šHK$58.00ï¼ˆä»…è®¢é˜…è´¹ç”¨ï¼‰âœ…
    â†“
ã€3. customer.subscription.deletedã€‘
    â”œâ”€ è§¦å‘æˆ‘ä»¬çš„ handleSubscriptionCancelled
    â”œâ”€ credits = 20 > 0ï¼ˆä¿ç•™ä¸Šé™ 50ï¼‰
    â””â”€ ä¿ç•™ 20 ä¸ª credits
```

### åœºæ™¯ 3ï¼šæœˆåº•è‡ªåŠ¨ç»­è´¹ï¼ˆæœ‰è¶…é¢ä½¿ç”¨ï¼‰

```
è®¡è´¹å‘¨æœŸç»“æŸ
    â†“
ã€1. invoice.createdã€‘
    â”œâ”€ æ£€æµ‹è¶…é¢ä½¿ç”¨
    â””â”€ æŠ¥å‘Šç»™ Stripe
    â†“
ã€2. invoice.paidã€‘
    â”œâ”€ æ”¯ä»˜åŒ…å«è¶…é¢è´¹ç”¨çš„å‘ç¥¨
    â””â”€ é‡‘é¢ï¼šHK$58.00 + è¶…é¢è´¹ç”¨ âœ…
    â†“
ã€3. customer.subscription.updatedã€‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    â””â”€ æ›´æ–°è®¢é˜…ä¿¡æ¯
    â†“
ã€æ²¡æœ‰ subscription.deletedã€‘
    â””â”€ ç”¨æˆ·ç»§ç»­è®¢é˜…ï¼Œcredits ä¿æŒå½“å‰çŠ¶æ€
```

---

## ğŸ¯ å…³é”®æ”¹è¿›

### ä¹‹å‰çš„é—®é¢˜ âŒ

```
1. âŒ åœ¨ customer.subscription.deleted ä¸­å¤„ç†è¶…é¢
2. âŒ æ—¶åºé”™è¯¯ï¼šStripe å·²ç»å®Œæˆå‘ç¥¨
3. âŒ æ— æ³•æŠ¥å‘Š usage recordï¼ˆè®¢é˜…å·²å–æ¶ˆï¼‰
4. âŒ æ— æ³•åˆ›å»ºæ–°å‘ç¥¨ï¼ˆå·²æœ‰å‘ç¥¨ï¼‰
5. âŒ å¯¼è‡´è¶…é¢è´¹ç”¨æ— æ³•æ”¶å–
```

### ç°åœ¨çš„è§£å†³æ–¹æ¡ˆ âœ…

```
1. âœ… åœ¨ invoice.created ä¸­å¤„ç†è¶…é¢
2. âœ… æ—¶åºæ­£ç¡®ï¼šåœ¨å‘ç¥¨åˆ›å»ºæ—¶æŠ¥å‘Š
3. âœ… æˆåŠŸæŠ¥å‘Š usage recordï¼ˆè®¢é˜…ä»æ´»è·ƒï¼‰
4. âœ… Stripe è‡ªåŠ¨å°†è¶…é¢æ·»åŠ åˆ°å‘ç¥¨
5. âœ… è¶…é¢è´¹ç”¨è‡ªåŠ¨æ”¶å–
6. âœ… æ— éœ€åˆ›å»ºç‹¬ç«‹å‘ç¥¨
7. âœ… é€‚ç”¨äºå–æ¶ˆå’Œç»­è´¹åœºæ™¯
```

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šé…ç½® Webhook

```bash
1. æ‰“å¼€ Stripe Dashboard
   https://dashboard.stripe.com/test/webhooks

2. ç¼–è¾‘ webhook endpoint

3. æ·»åŠ  invoice.created äº‹ä»¶

4. ä¿å­˜
```

### æ­¥éª¤ 2ï¼šå‡†å¤‡æµ‹è¯•æ•°æ®

```bash
1. åœ¨ Firestore ä¸­æ‰‹åŠ¨ä¿®æ”¹æµ‹è¯•ç”¨æˆ·çš„ creditsï¼š
   users â†’ 1234@gmail.com
   - currentCredits: -50
   - credits: -50

2. è®°å½•ç”¨æˆ·çš„ï¼š
   - stripeCustomerId
   - subscription.meteredSubscriptionItemId
   - subscription.stripeSubscriptionId
```

### æ­¥éª¤ 3ï¼šåœ¨ Stripe ä¸­å–æ¶ˆè®¢é˜…

```bash
1. æ‰“å¼€è®¢é˜…é¡µé¢ï¼š
   https://dashboard.stripe.com/test/subscriptions/sub_xxxxx

2. ç‚¹å‡»ã€Œå–æ¶ˆè®¢é˜…ã€

3. é€‰æ‹©ã€Œç«‹å³å–æ¶ˆã€

4. ç¡®è®¤å–æ¶ˆ
```

### æ­¥éª¤ 4ï¼šæŸ¥çœ‹ Firebase æ—¥å¿—

```bash
æ‰“å¼€ Google Cloud Logs Explorerï¼š
https://console.cloud.google.com/logs/

æœç´¢ï¼šinvoice.created

é¢„æœŸæ—¥å¿—ï¼š
âœ… ğŸ“ ç™¼ç¥¨å‰µå»º (æ¸¬è©¦æ¨¡å¼): in_xxxxx
âœ… ğŸ” æŸ¥æ‰¾å®¢æˆ¶: cus_xxxxx
âœ… âœ… æ‰¾åˆ°ç”¨æˆ¶: 1234@gmail.com
âœ… âš ï¸ æª¢æ¸¬åˆ°è¶…é¡ä½¿ç”¨: 50 Credits
âœ… âœ… æˆåŠŸå ±å‘Šç¸½ä½¿ç”¨é‡çµ¦ Stripe: 150
âœ… ğŸ’µ Stripe æœƒåœ¨æ­¤ç™¼ç¥¨ä¸­æ”¶å–è¶…é¡è²»ç”¨: HK$25.00
```

### æ­¥éª¤ 5ï¼šéªŒè¯ Stripe å‘ç¥¨

```bash
1. æ‰“å¼€å‘ç¥¨é¡µé¢ï¼š
   https://dashboard.stripe.com/test/invoices

2. æŸ¥æ‰¾æœ€æ–°çš„å‘ç¥¨

3. éªŒè¯ï¼š
   âœ… çŠ¶æ€ï¼šPaid
   âœ… é‡‘é¢ï¼šHK$83.00
      - HK$58.00ï¼ˆè®¢é˜…è´¹ç”¨ï¼‰
      - HK$25.00ï¼ˆè¶…é¢ 50 ä¸ª Ã— HK$0.50ï¼‰
   âœ… å‘ç¥¨é¡¹ç›®åŒ…å« "VaultCaddy Monthly" çš„è¶…é¢ä½¿ç”¨
```

### æ­¥éª¤ 6ï¼šéªŒè¯ Firestore æ•°æ®

```bash
1. æ‰“å¼€ Firestore
2. æŸ¥çœ‹ users â†’ 1234@gmail.com
3. éªŒè¯ï¼š
   âœ… currentCredits: 0ï¼ˆå·²é‡ç½®ï¼‰
   âœ… credits: 0ï¼ˆå·²é‡ç½®ï¼‰
   âœ… planType: "Free Plan"
   âœ… subscription: ï¼ˆå·²åˆ é™¤ï¼‰
4. æŸ¥çœ‹ creditsHistory é›†åˆ
5. åº”è¯¥æœ‰æ–°çš„è®°å½•ï¼š
   - type: "overage_reported_on_invoice"
   - description: "åœ¨ç™¼ç¥¨å‰µå»ºæ™‚å ±å‘Šè¶…é¡ä½¿ç”¨: 50 Credits"
```

---

## ğŸ’¡ é‡è¦è¯´æ˜

### 1. ä¸ºä»€ä¹ˆè¦åœ¨ `invoice.created` ä¸­å¤„ç†ï¼Ÿ

**invoice.created** æ˜¯ Stripe åœ¨å‘ç¥¨åˆ›å»ºæ—¶è§¦å‘çš„ webhookï¼Œ**åœ¨å‘ç¥¨å®Œæˆä¹‹å‰**ã€‚

è¿™æ˜¯æˆ‘ä»¬æŠ¥å‘Š usage records çš„**æœ€åæœºä¼š**ï¼ŒStripe ä¼šè‡ªåŠ¨å°†è¿™äº› usage æ·»åŠ åˆ°æ­£åœ¨åˆ›å»ºçš„å‘ç¥¨ä¸­ã€‚

### 2. ä¸ºä»€ä¹ˆä¸åœ¨ `customer.subscription.deleted` ä¸­å¤„ç†ï¼Ÿ

å› ä¸ºå½“ `customer.subscription.deleted` è§¦å‘æ—¶ï¼š
- âœ… è®¢é˜…å·²ç»è¢«å–æ¶ˆ
- âœ… æœ€ç»ˆå‘ç¥¨å·²ç»ç”Ÿæˆå¹¶æ”¯ä»˜
- âŒ æ— æ³•å†æŠ¥å‘Š usage record
- âŒ æ— æ³•å†ä¿®æ”¹å‘ç¥¨

### 3. è¿™ä¸ªæ–¹æ¡ˆé€‚ç”¨äºå“ªäº›åœºæ™¯ï¼Ÿ

âœ… **é€‚ç”¨äºï¼š**
- ç”¨æˆ·å–æ¶ˆè®¢é˜…
- æœˆåº•è‡ªåŠ¨ç»­è´¹
- è®¢é˜…å‡çº§/é™çº§
- ä»»ä½•ä¼šç”Ÿæˆå‘ç¥¨çš„åœºæ™¯

### 4. å¦‚æœç”¨æˆ·åœ¨æ²¡æœ‰è¶…é¢çš„æƒ…å†µä¸‹å–æ¶ˆè®¢é˜…ï¼Ÿ

æ²¡æœ‰é—®é¢˜ï¼`handleInvoiceCreated` ä¼šæ£€æµ‹ `currentCredits >= 0`ï¼Œä¸ä¼šæŠ¥å‘Š usageï¼ŒStripe åªä¼šæ”¶å–æ­£å¸¸çš„è®¢é˜…è´¹ç”¨ã€‚

### 5. å¦‚æœåŒæ—¶æœ‰å¤šä¸ªå‘ç¥¨ï¼Ÿ

æ¯ä¸ªå‘ç¥¨éƒ½ä¼šè§¦å‘ç‹¬ç«‹çš„ `invoice.created` webhookï¼Œæˆ‘ä»¬ä¼šä¸ºæ¯ä¸ªå‘ç¥¨åˆ†åˆ«æ£€æŸ¥å¹¶æŠ¥å‘Šè¶…é¢ä½¿ç”¨ã€‚

---

## ğŸ“… éƒ¨ç½²ä¿¡æ¯

```
éƒ¨ç½²æ—¶é—´ï¼š2025-12-17 ä¸‹åˆ7:26
Git commitï¼šbb2410d
éƒ¨ç½²å‘½ä»¤ï¼šfirebase deploy --only functions:stripeWebhook
éƒ¨ç½²çŠ¶æ€ï¼šâœ… æˆåŠŸ

æ›´æ–°çš„å‡½æ•°ï¼š
âœ… stripeWebhookï¼ˆæ–°å¢ invoice.created å¤„ç†ï¼‰

æ›´æ–°çš„ webhook å¤„ç†å‡½æ•°ï¼š
âœ… handleInvoiceCreatedï¼ˆæ–°å¢ï¼‰
âœ… handleSubscriptionCancelledï¼ˆç®€åŒ–ï¼‰
```

---

## ğŸ‰ æ€»ç»“

âœ… **é—®é¢˜å·²å®Œå…¨è§£å†³**  
âœ… **ä»£ç å·²éƒ¨ç½²**  
âœ… **éœ€è¦åœ¨ Stripe Dashboard ä¸­æ·»åŠ  invoice.created webhook**  

**å…³é”®æ”¹è¿›ï¼š**
- âœ… åœ¨æ­£ç¡®çš„æ—¶æœºï¼ˆinvoice.createdï¼‰æŠ¥å‘Šè¶…é¢ä½¿ç”¨
- âœ… è®© Stripe åœ¨ç”Ÿæˆå‘ç¥¨æ—¶è‡ªåŠ¨åŒ…å«è¶…é¢è´¹ç”¨
- âœ… ä¸å†éœ€è¦åˆ›å»ºç‹¬ç«‹å‘ç¥¨
- âœ… é¿å…æ—¶åºé—®é¢˜
- âœ… é€‚ç”¨äºæ‰€æœ‰è®¡è´¹åœºæ™¯

**ä¸‹ä¸€æ­¥ï¼š**
1. åœ¨ Stripe Dashboard ä¸­æ·»åŠ  `invoice.created` webhook
2. æŒ‰ç…§æµ‹è¯•æ­¥éª¤éªŒè¯åŠŸèƒ½
3. ç¡®è®¤è¶…é¢è´¹ç”¨è¢«æ­£ç¡®æ”¶å–

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-12-17 ä¸‹åˆ7:26  
**çŠ¶æ€ï¼š** âœ… å®Œæˆï¼Œç­‰å¾… Stripe webhook é…ç½®å’Œæµ‹è¯•




