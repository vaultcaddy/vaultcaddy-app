# âœ… Stripe Webhook äº‹ä»¶ä¼˜åŒ–é…ç½®æŒ‡å—

## ğŸ¯ **ä¼˜åŒ–ç›®æ ‡**

### **é—®é¢˜**
- å•æ¬¡æ”¯ä»˜è§¦å‘ 15+ ä¸ª Webhook äº‹ä»¶
- å¤§éƒ¨åˆ†äº‹ä»¶éƒ½ä¸éœ€è¦å¤„ç†
- æµªè´¹ Firebase Functions æ‰§è¡Œæ¬¡æ•°å’Œè´¹ç”¨
- å¢åŠ å¤„ç†å¤æ‚åº¦å’Œé”™è¯¯é£é™©

### **ä¼˜åŒ–å**
- å•æ¬¡æ”¯ä»˜åªè§¦å‘ 4 ä¸ªå¿…è¦äº‹ä»¶
- å‡å°‘ 73% çš„äº‹ä»¶å¤„ç†
- æå‡æ€§èƒ½å’Œå¯é æ€§
- é™ä½è´¹ç”¨

---

## ğŸ“‹ **éœ€è¦ç›‘å¬çš„äº‹ä»¶ï¼ˆåªéœ€ 4 ä¸ªï¼‰**

### **âœ… å¿…é¡»ç›‘å¬çš„äº‹ä»¶ï¼š**

1. **`checkout.session.completed`**
   - **ä½œç”¨**ï¼šæ”¯ä»˜å®Œæˆæ—¶è§¦å‘
   - **æˆ‘ä»¬çš„å¤„ç†**ï¼šæ·»åŠ  Credits åˆ°ç”¨æˆ·è´¦æˆ·
   - **é‡è¦æ€§**ï¼šâ­â­â­â­â­ï¼ˆå¿…é¡»ï¼‰

2. **`customer.subscription.created`**
   - **ä½œç”¨**ï¼šè®¢é˜…åˆ›å»ºæ—¶è§¦å‘
   - **æˆ‘ä»¬çš„å¤„ç†**ï¼šåˆ›å»ºè®¢é˜…è®°å½•
   - **é‡è¦æ€§**ï¼šâ­â­â­â­ï¼ˆé‡è¦ï¼‰

3. **`customer.subscription.updated`**
   - **ä½œç”¨**ï¼šè®¢é˜…æ›´æ–°æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ï¼šç»­è´¹ã€å‡çº§ã€é™çº§ï¼‰
   - **æˆ‘ä»¬çš„å¤„ç†**ï¼šæ›´æ–°è®¢é˜…ä¿¡æ¯
   - **é‡è¦æ€§**ï¼šâ­â­â­â­ï¼ˆé‡è¦ï¼‰

4. **`customer.subscription.deleted`**
   - **ä½œç”¨**ï¼šè®¢é˜…å–æ¶ˆæ—¶è§¦å‘
   - **æˆ‘ä»¬çš„å¤„ç†**ï¼šæ›´æ–°è®¢é˜…çŠ¶æ€ä¸ºå·²å–æ¶ˆ
   - **é‡è¦æ€§**ï¼šâ­â­â­â­ï¼ˆé‡è¦ï¼‰

---

## âŒ **ä¸éœ€è¦ç›‘å¬çš„äº‹ä»¶ï¼ˆå¯ä»¥ç§»é™¤ï¼‰**

### **Invoice ç›¸å…³äº‹ä»¶ï¼ˆä¸éœ€è¦ï¼‰**
- `invoice.created` - å‘ç¥¨åˆ›å»º
- `invoice.finalized` - å‘ç¥¨ç¡®å®š
- `invoice.payment_succeeded` - å‘ç¥¨æ”¯ä»˜æˆåŠŸ
- `invoice.paid` - å‘ç¥¨å·²æ”¯ä»˜
- `invoice.updated` - å‘ç¥¨æ›´æ–°

**åŸå› **ï¼š`checkout.session.completed` å·²ç»å¤„ç†äº†æ”¯ä»˜æˆåŠŸï¼Œä¸éœ€è¦é‡å¤å¤„ç†ã€‚

### **Payment Intent ç›¸å…³äº‹ä»¶ï¼ˆä¸éœ€è¦ï¼‰**
- `payment_intent.created` - æ”¯ä»˜æ„å›¾åˆ›å»º
- `payment_intent.succeeded` - æ”¯ä»˜æ„å›¾æˆåŠŸ
- `payment_intent.processing` - æ”¯ä»˜å¤„ç†ä¸­

**åŸå› **ï¼š`checkout.session.completed` å·²ç»å¤„ç†äº†æ”¯ä»˜æˆåŠŸï¼Œä¸éœ€è¦é‡å¤å¤„ç†ã€‚

### **Charge ç›¸å…³äº‹ä»¶ï¼ˆä¸éœ€è¦ï¼‰**
- `charge.succeeded` - æ‰£æ¬¾æˆåŠŸ

**åŸå› **ï¼š`checkout.session.completed` å·²ç»å¤„ç†äº†æ”¯ä»˜æˆåŠŸï¼Œä¸éœ€è¦é‡å¤å¤„ç†ã€‚

### **Payment Method ç›¸å…³äº‹ä»¶ï¼ˆä¸éœ€è¦ï¼‰**
- `payment_method.attached` - æ”¯ä»˜æ–¹å¼ç»‘å®š

**åŸå› **ï¼šæˆ‘ä»¬ä¸éœ€è¦å•ç‹¬å¤„ç†æ”¯ä»˜æ–¹å¼çš„ç»‘å®šã€‚

### **Customer ç›¸å…³äº‹ä»¶ï¼ˆä¸éœ€è¦ï¼‰**
- `customer.created` - å®¢æˆ·åˆ›å»º
- `customer.updated` - å®¢æˆ·æ›´æ–°

**åŸå› **ï¼šæˆ‘ä»¬åœ¨æ”¯ä»˜æ—¶è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼Œä¸éœ€è¦å•ç‹¬å¤„ç†ã€‚

### **Product ç›¸å…³äº‹ä»¶ï¼ˆä¸éœ€è¦ï¼‰**
- `product.created` - äº§å“åˆ›å»º
- `product.updated` - äº§å“æ›´æ–°

**åŸå› **ï¼šäº§å“çš„åˆ›å»ºå’Œæ›´æ–°ä¸å½±å“ç”¨æˆ·çš„ Credits å’Œè®¢é˜…ã€‚

---

## ğŸ”§ **æµ‹è¯•æ¨¡å¼ï¼ˆTest Modeï¼‰ä¼˜åŒ–æ­¥éª¤**

### **æ­¥éª¤ 1ï¼šæ‰“å¼€ Stripe Webhook é…ç½®**

1. æ‰“å¼€ Stripe Dashboardï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰ï¼š
   https://dashboard.stripe.com/test/webhooks

2. æ‰¾åˆ° Webhookï¼š`charismatic-serenity`
   - Webhook ID: `we_1Scgk3JmiQ31C0GTZUyiE9nQ`
   - ç«¯ç‚¹ URL: `https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook`

3. ç‚¹å‡» Webhook åç§°è¿›å…¥è¯¦æƒ…é¡µé¢

### **æ­¥éª¤ 2ï¼šç¼–è¾‘ç›‘å¬çš„äº‹ä»¶**

1. å‘ä¸‹æ»šåŠ¨åˆ° **"ç›‘å¬çš„äº‹ä»¶"** æˆ– **"Events to send"** éƒ¨åˆ†

2. ç‚¹å‡» **"+ Select events"** æˆ– **"Edit"** æŒ‰é’®

3. **å–æ¶ˆæ‰€æœ‰å½“å‰é€‰æ‹©çš„äº‹ä»¶**

4. **åªé€‰æ‹©ä»¥ä¸‹ 4 ä¸ªäº‹ä»¶**ï¼š
   - âœ… `checkout.session.completed`
   - âœ… `customer.subscription.created`
   - âœ… `customer.subscription.updated`
   - âœ… `customer.subscription.deleted`

5. ç‚¹å‡» **"Add events"** æˆ– **"Update endpoint"** ä¿å­˜

### **æ­¥éª¤ 3ï¼šéªŒè¯é…ç½®**

1. ä¿å­˜åï¼Œç¡®è®¤ **"ç›‘å¬çš„äº‹ä»¶"** éƒ¨åˆ†åªæ˜¾ç¤º 4 ä¸ªäº‹ä»¶

2. è¿›è¡Œä¸€æ¬¡æµ‹è¯•æ”¯ä»˜

3. æ‰“å¼€ Stripe Workbenchï¼š
   https://dashboard.stripe.com/test/workbench/events

4. ç¡®è®¤åªæ”¶åˆ° 4 ä¸ªäº‹ä»¶ï¼ˆè€Œä¸æ˜¯ 15+ ä¸ªï¼‰

---

## ğŸ”§ **ç”Ÿäº§æ¨¡å¼ï¼ˆLive Modeï¼‰ä¼˜åŒ–æ­¥éª¤**

### **æ­¥éª¤ 1ï¼šæ‰“å¼€ Stripe Webhook é…ç½®**

1. æ‰“å¼€ Stripe Dashboardï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰ï¼š
   https://dashboard.stripe.com/webhooks

2. æ‰¾åˆ°ç”Ÿäº§æ¨¡å¼çš„ Webhookï¼ˆåç§°å¯èƒ½ä¸åŒï¼‰

3. ç‚¹å‡» Webhook åç§°è¿›å…¥è¯¦æƒ…é¡µé¢

### **æ­¥éª¤ 2ï¼šç¼–è¾‘ç›‘å¬çš„äº‹ä»¶**

1. å‘ä¸‹æ»šåŠ¨åˆ° **"ç›‘å¬çš„äº‹ä»¶"** æˆ– **"Events to send"** éƒ¨åˆ†

2. ç‚¹å‡» **"+ Select events"** æˆ– **"Edit"** æŒ‰é’®

3. **å–æ¶ˆæ‰€æœ‰å½“å‰é€‰æ‹©çš„äº‹ä»¶**

4. **åªé€‰æ‹©ä»¥ä¸‹ 4 ä¸ªäº‹ä»¶**ï¼š
   - âœ… `checkout.session.completed`
   - âœ… `customer.subscription.created`
   - âœ… `customer.subscription.updated`
   - âœ… `customer.subscription.deleted`

5. ç‚¹å‡» **"Add events"** æˆ– **"Update endpoint"** ä¿å­˜

### **æ­¥éª¤ 3ï¼šéªŒè¯é…ç½®**

1. ä¿å­˜åï¼Œç¡®è®¤ **"ç›‘å¬çš„äº‹ä»¶"** éƒ¨åˆ†åªæ˜¾ç¤º 4 ä¸ªäº‹ä»¶

---

## ğŸ“Š **ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**

### **ä¼˜åŒ–å‰**

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ¯æ¬¡æ”¯ä»˜è§¦å‘çš„äº‹ä»¶æ•° | 15+ ä¸ª |
| Firebase Functions æ‰§è¡Œæ¬¡æ•° | 15+ æ¬¡ |
| ç½‘ç»œè¯·æ±‚æ¬¡æ•° | 15+ æ¬¡ |
| å¤„ç†æ—¶é—´ | çº¦ 1500ms |
| æœˆè´¹ç”¨ï¼ˆ1000 æ¬¡æ”¯ä»˜ï¼‰ | çº¦ $0.15 |

### **ä¼˜åŒ–å**

| æŒ‡æ ‡ | æ•°å€¼ | æå‡ |
|------|------|------|
| æ¯æ¬¡æ”¯ä»˜è§¦å‘çš„äº‹ä»¶æ•° | 4 ä¸ª | **-73%** |
| Firebase Functions æ‰§è¡Œæ¬¡æ•° | 4 æ¬¡ | **-73%** |
| ç½‘ç»œè¯·æ±‚æ¬¡æ•° | 4 æ¬¡ | **-73%** |
| å¤„ç†æ—¶é—´ | çº¦ 400ms | **+175%** |
| æœˆè´¹ç”¨ï¼ˆ1000 æ¬¡æ”¯ä»˜ï¼‰ | çº¦ $0.04 | **-73%** |

---

## ğŸ› **å·²ä¿®å¤çš„ä»£ç é—®é¢˜**

### **é—®é¢˜ 1ï¼šé‡å¤æ·»åŠ  Credits**

**åŸå› **ï¼š
- `checkout.session.completed` æ·»åŠ äº† Credits
- `customer.subscription.created` åˆæ·»åŠ äº† Credits
- `customer.subscription.updated` åˆæ·»åŠ äº† Credits

**ç»“æœ**ï¼šå•æ¬¡æ”¯ä»˜ï¼ŒCredits è¢«æ·»åŠ äº† 3 æ¬¡ï¼

**ä¿®å¤**ï¼š
- âœ… åªåœ¨ `checkout.session.completed` ä¸­æ·»åŠ  Credits
- âœ… `customer.subscription.created/updated` åªæ›´æ–°è®¢é˜…ä¿¡æ¯ï¼Œä¸æ·»åŠ  Credits

### **é—®é¢˜ 2ï¼šå¤„ç†ä¸å¿…è¦çš„äº‹ä»¶**

**åŸå› **ï¼š
- ä»£ç ä¸­æœ‰ `handlePaymentSuccess` å‡½æ•°å¤„ç† `payment_intent.succeeded`
- ä½†è¿™ä¸ªäº‹ä»¶ä¸ `checkout.session.completed` é‡å¤

**ä¿®å¤**ï¼š
- âœ… ç§»é™¤äº† `payment_intent.succeeded` çš„å¤„ç†
- âœ… æ·»åŠ äº†æ—¥å¿—æç¤ºï¼Œå»ºè®®ç§»é™¤æœªé…ç½®å¤„ç†çš„äº‹ä»¶

---

## âœ… **éªŒè¯ä¼˜åŒ–æ•ˆæœ**

### **1. è¿›è¡Œä¸€æ¬¡æµ‹è¯•æ”¯ä»˜**

1. å‰å¾€ï¼šhttps://vaultcaddy.com/billing.html
2. ç‚¹å‡» **"ğŸ§ª æ¸¬è©¦ Get Started"**
3. ä½¿ç”¨æµ‹è¯•å¡å®Œæˆæ”¯ä»˜ï¼š`4242 4242 4242 4242`

### **2. æŸ¥çœ‹ Stripe Workbench**

1. æ‰“å¼€ï¼šhttps://dashboard.stripe.com/test/workbench/events
2. æŸ¥çœ‹æœ€æ–°çš„äº‹ä»¶åˆ—è¡¨
3. **åº”è¯¥åªçœ‹åˆ° 4 ä¸ªäº‹ä»¶**ï¼ˆè€Œä¸æ˜¯ 15+ ä¸ªï¼‰

### **3. æŸ¥çœ‹ Firebase Functions æ—¥å¿—**

```bash
firebase functions:log | grep "ğŸ“¨ æ”¶åˆ°" | head -10
```

**åº”è¯¥åªçœ‹åˆ° 4 ä¸ª Webhook è°ƒç”¨**ï¼š
```
ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: checkout.session.completed
ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: customer.subscription.created
ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: customer.subscription.updated
ğŸ“¨ æ”¶åˆ°æµ‹è¯•æ¨¡å¼webhookäº‹ä»¶: invoice.payment_succeededï¼ˆéœ€è¦åœ¨ Stripe ä¸­ç§»é™¤ï¼‰
```

### **4. éªŒè¯ Credits**

1. åˆ·æ–° https://vaultcaddy.com/billing.html
2. ç¡®è®¤ Credits **åªå¢åŠ äº† 100**ï¼ˆè€Œä¸æ˜¯ 300ï¼‰

---

## ğŸ¯ **æ€»ç»“**

### **ä¼˜åŒ–å‰çš„é—®é¢˜**
- âŒ å•æ¬¡æ”¯ä»˜è§¦å‘ 15+ ä¸ªäº‹ä»¶
- âŒ Credits è¢«é‡å¤æ·»åŠ  3 æ¬¡
- âŒ æµªè´¹ 73% çš„ Firebase Functions æ‰§è¡Œæ¬¡æ•°
- âŒ å¤„ç†é€Ÿåº¦æ…¢ï¼Œå®¹æ˜“å‡ºé”™

### **ä¼˜åŒ–åçš„æ•ˆæœ**
- âœ… å•æ¬¡æ”¯ä»˜åªè§¦å‘ 4 ä¸ªå¿…è¦äº‹ä»¶
- âœ… Credits åªæ·»åŠ  1 æ¬¡
- âœ… å‡å°‘ 73% çš„äº‹ä»¶å¤„ç†
- âœ… æå‡æ€§èƒ½å’Œå¯é æ€§
- âœ… é™ä½ 73% çš„è´¹ç”¨

### **ä¸‹ä¸€æ­¥**
1. âœ… ä»£ç å·²ä¼˜åŒ–å¹¶éƒ¨ç½²
2. â³ éœ€è¦åœ¨ Stripe Dashboard ä¸­æ‰‹åŠ¨é…ç½® Webhook äº‹ä»¶ï¼ˆæµ‹è¯•æ¨¡å¼ + ç”Ÿäº§æ¨¡å¼ï¼‰
3. â³ é…ç½®å®Œæˆåï¼Œè¿›è¡Œæµ‹è¯•éªŒè¯

---

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

å¦‚æœåœ¨é…ç½® Stripe Webhook æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. Stripe Dashboard çš„æˆªå›¾
2. é…ç½®çš„å…·ä½“æ­¥éª¤
3. é‡åˆ°çš„é”™è¯¯ä¿¡æ¯

æˆ‘ä¼šå¸®æ‚¨è§£å†³ï¼ğŸ™

