# âœ… æµ‹è¯•æ¨¡å¼é…ç½®å®ŒæˆæŠ¥å‘Š

## ğŸ‰ å·²å®Œæˆçš„æ‰€æœ‰é…ç½®

### 1ï¸âƒ£ Stripe æµ‹è¯•å¯†é’¥é…ç½®
- âœ… ä» Stripe Dashboard è·å–äº†æµ‹è¯•æ¨¡å¼ Secret Key
- âœ… é…ç½®åˆ° Firebase Functions ç¯å¢ƒå˜é‡ï¼š`stripe.test_secret_key`
- âœ… ä¿æŒç”Ÿäº§æ¨¡å¼å¯†é’¥ï¼š`stripe.secret_key`

### 2ï¸âƒ£ Firebase Functions æ›´æ–°
- âœ… æ”¯æŒåŒæ¨¡å¼ï¼šåŒæ—¶åˆå§‹åŒ–ç”Ÿäº§å’Œæµ‹è¯• Stripe å®¢æˆ·ç«¯
- âœ… åŠ¨æ€é€‰æ‹©ï¼šæ ¹æ® `isTest` å‚æ•°è‡ªåŠ¨é€‰æ‹©å¯¹åº”å®¢æˆ·ç«¯
- âœ… æ™ºèƒ½é”™è¯¯æç¤ºï¼šæ¸…æ™°åŒºåˆ†æµ‹è¯•/ç”Ÿäº§æ¨¡å¼çš„é…ç½®é”™è¯¯
- âœ… å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### 3ï¸âƒ£ Billing é¡µé¢æ›´æ–°
- âœ… æ·»åŠ æµ‹è¯•æç¤ºä¿¡æ¯åŒºåŸŸï¼ˆé»„è‰²èƒŒæ™¯ï¼‰
- âœ… æ˜¾ç¤ºæµ‹è¯•å¡å·ï¼š`4242 4242 4242 4242`
- âœ… æœˆè´¹æ–¹æ¡ˆï¼šæ·»åŠ é»„è‰² "ğŸ§ª æ¸¬è©¦ Get Started" æŒ‰é’®
- âœ… å¹´è´¹æ–¹æ¡ˆï¼šæ·»åŠ ç°è‰² "ğŸ§ª æ¸¬è©¦ Get Started (å°šæœªé…ç½®)" æŒ‰é’®ï¼ˆç¦ç”¨ï¼‰
- âœ… JavaScript é€»è¾‘ï¼šä¼ é€’ `isTest: true` å‚æ•°

### 4ï¸âƒ£ æµ‹è¯•æŒ‡å—æ–‡æ¡£
- âœ… åˆ›å»ºäº†è¯¦ç»†çš„æµ‹è¯•æŒ‡å—ï¼š`ğŸ¯_å¿«é€Ÿå›ç­”_Stripeæµ‹è¯•.txt`
- âœ… åŒ…å«æµ‹è¯•å¡å·ã€æ­¥éª¤ã€å¸¸è§é—®é¢˜ç­‰

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### Firebase Functions (index.js)

**Stripe å®¢æˆ·ç«¯åˆå§‹åŒ–**ï¼š
```javascript
// ğŸ¯ åˆå§‹åŒ–ç”Ÿäº§æ¨¡å¼å’Œæµ‹è¯•æ¨¡å¼çš„ Stripe å®¢æˆ·ç«¯
const stripeLive = stripeConfig && stripeConfig.secret_key 
    ? require('stripe')(stripeConfig.secret_key) 
    : null;
const stripeTest = stripeConfig && stripeConfig.test_secret_key 
    ? require('stripe')(stripeConfig.test_secret_key) 
    : null;
```

**åŠ¨æ€é€‰æ‹©å®¢æˆ·ç«¯**ï¼š
```javascript
// ğŸ¯ æ ¹æ“š isTest é¸æ“‡ä½¿ç”¨çš„ Stripe å®¢æˆ¶ç«¯
const stripeClient = isTest ? stripeTest : stripeLive;

if (!stripeClient || !stripeConfig) {
    const mode = isTest ? 'æ¸¬è©¦' : 'ç”Ÿç”¢';
    throw new functions.https.HttpsError(
        'unavailable', 
        `Stripe ${mode}æ¨¡å¼æœªé…ç½®ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡`
    );
}
```

**æµ‹è¯• Price IDs**ï¼š
```javascript
const testPriceMapping = {
    monthly: {
        basePriceId: 'price_1Scj13JmiQ31C0GT4TJsWzFg',  // æ¸¬è©¦æœˆè²»åŸºç¤ $58
        usagePriceId: 'price_1Scj1UJmiQ31C0GTXDsN6TFh'  // æ¸¬è©¦æœˆè²»ç”¨é‡è¨ˆè²»
    },
    yearly: {
        basePriceId: '',  // æ¸¬è©¦å¹´è²»åŸºç¤ï¼ˆå°šæœªå‰µå»ºï¼‰
        usagePriceId: ''  // æ¸¬è©¦å¹´è²»ç”¨é‡è¨ˆè²»ï¼ˆå°šæœªå‰µå»ºï¼‰
    }
};
```

### Billing.html

**JavaScript è°ƒç”¨**ï¼š
```javascript
async function createCheckoutSession(planType, event, isTest = false) {
    // ...
    const result = await createSession({
        planType: planType,
        userId: userId,
        email: userEmail,
        isTest: isTest  // ğŸ§ª å‚³éæ¸¬è©¦æ¨¡å¼æ¨™è¨˜
    });
    // ...
}
```

**HTML æµ‹è¯•æŒ‰é’®**ï¼š
```html
<!-- æœˆè´¹æµ‹è¯•æŒ‰é’® -->
<button onclick="createCheckoutSession('monthly', event, true)" 
        style="background: #fbbf24; color: #78350f; ...">
    ğŸ§ª æ¸¬è©¦ Get Started
</button>

<!-- å¹´è´¹æµ‹è¯•æŒ‰é’®ï¼ˆç¦ç”¨ï¼‰ -->
<button onclick="alert('âš ï¸ å¹´è²»æ¸¬è©¦æ–¹æ¡ˆå°šæœªå‰µå»º...')" 
        style="background: #e5e7eb; cursor: not-allowed; opacity: 0.6;">
    ğŸ§ª æ¸¬è©¦ Get Started (å°šæœªé…ç½®)
</button>
```

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨æµ‹è¯•æ¨¡å¼

### æ­¥éª¤ 1ï¼šè®¿é—® Billing é¡µé¢
```
https://vaultcaddy.com/billing.html
```

### æ­¥éª¤ 2ï¼šç¡®è®¤ç™»å½•
ç¡®ä¿æ‚¨å·²ç™»å½• VaultCaddy è´¦æˆ·

### æ­¥éª¤ 3ï¼šç‚¹å‡»æµ‹è¯•æŒ‰é’®
1. åœ¨**æœˆè´¹æ–¹æ¡ˆ**ä¸‹æ–¹æ‰¾åˆ°é»„è‰²çš„ **"ğŸ§ª æ¸¬è©¦ Get Started"** æŒ‰é’®
2. ç‚¹å‡»æŒ‰é’®
3. è‡ªåŠ¨è·³è½¬åˆ° Stripe Checkoutï¼ˆ**æ‚¨çš„ email å·²è‡ªåŠ¨å¡«å……**ï¼‰
4. ä½¿ç”¨æµ‹è¯•å¡å·å®Œæˆæ”¯ä»˜

### æ­¥éª¤ 4ï¼šä½¿ç”¨æµ‹è¯•å¡å·
```
å¡å·:     4242 4242 4242 4242
æœ‰æ•ˆæœŸ:   ä»»æ„æœªæ¥æ—¥æœŸ (å¦‚ 12/34)
CVC:      ä»»æ„ 3 ä½æ•°å­— (å¦‚ 123)
éƒµç·¨:     ä»»æ„é‚®ç¼– (å¦‚ 12345)
```

**é‡è¦**ï¼šæµ‹è¯•æ¨¡å¼ä¸‹ä½¿ç”¨æµ‹è¯•å¡å· **å®Œå…¨å…è´¹**ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•è´¹ç”¨ï¼

---

## ğŸ†š æµ‹è¯•æ¨¡å¼ vs æ­£å¼ç‰ˆå¯¹æ¯”

| åŠŸèƒ½ | ğŸ§ª æµ‹è¯• Get Started | ğŸ’° å¼€å§‹ä½¿ç”¨ï¼ˆæ­£å¼ï¼‰ |
|------|---------------------|---------------------|
| **æŒ‰é’®é¢œè‰²** | ğŸŸ¡ é»„è‰² | ğŸŸ£ ç´«è‰² |
| **Stripe å¯†é’¥** | `sk_test_...` | `sk_live_...` |
| **Price IDs** | æµ‹è¯• Price IDs | ç”Ÿäº§ Price IDs |
| **æ”¯ä»˜å¡å·** | æµ‹è¯•å¡ (4242...) | çœŸå®ä¿¡ç”¨å¡ |
| **æ˜¯å¦æ‰£é’±** | âŒ ä¸æ‰£é’±ï¼ˆæ¨¡æ‹Ÿï¼‰ | âœ… çœŸå®æ‰£æ¬¾ |
| **Email è‡ªåŠ¨å¡«å……** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **ä¼ é€’ userId** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **Webhook è§¦å‘** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **ç”¨é€”** | å¼€å‘æµ‹è¯• | çœŸå®ç”¨æˆ· |

---

## ğŸ“ æµ‹è¯• Price IDs

### å·²é…ç½®ï¼ˆæœˆè´¹ï¼‰
- **åŸºç¡€ä»·æ ¼** ($58/æœˆ): `price_1Scj13JmiQ31C0GT4TJsWzFg`
- **ç”¨é‡è®¡è´¹** ($0 èµ·æ­¥): `price_1Scj1UJmiQ31C0GTXDsN6TFh`

### å¾…é…ç½®ï¼ˆå¹´è´¹ï¼‰
- **åŸºç¡€ä»·æ ¼**: *å°šæœªåˆ›å»º*
- **ç”¨é‡è®¡è´¹**: *å°šæœªåˆ›å»º*

å¦‚éœ€æµ‹è¯•å¹´è´¹ï¼Œè¯·åœ¨ Stripe æµ‹è¯•æ¨¡å¼ä¸‹åˆ›å»ºå¹´è´¹äº§å“ï¼Œç„¶åæ›´æ–°ä»£ç ä¸­çš„ `testPriceMapping.yearly`ã€‚

---

## ğŸ” æµ‹è¯•éªŒè¯æ¸…å•

### å‰ç«¯æµ‹è¯•
- [ ] è®¿é—® `https://vaultcaddy.com/billing.html`
- [ ] ç¡®è®¤é»„è‰²æµ‹è¯•æç¤ºä¿¡æ¯æ˜¾ç¤º
- [ ] ç‚¹å‡»æœˆè´¹çš„ "ğŸ§ª æ¸¬è©¦ Get Started" æŒ‰é’®
- [ ] ç¡®è®¤è·³è½¬åˆ° Stripe Checkout
- [ ] ç¡®è®¤ Email å·²è‡ªåŠ¨å¡«å……
- [ ] ä½¿ç”¨æµ‹è¯•å¡å· `4242 4242 4242 4242` å®Œæˆæ”¯ä»˜
- [ ] ç¡®è®¤æ”¯ä»˜æˆåŠŸï¼Œè·³è½¬å› `billing.html?success=true&test=true`

### åç«¯æµ‹è¯•
- [ ] å‰å¾€ **Stripe Dashboard > æµ‹è¯•æ¨¡å¼ > Payments**
- [ ] æŸ¥çœ‹æµ‹è¯•æ”¯ä»˜è®°å½•
- [ ] å‰å¾€ **Stripe Dashboard > æµ‹è¯•æ¨¡å¼ > Webhooks**
- [ ] æŸ¥çœ‹ Webhook è§¦å‘æ—¥å¿—ï¼Œç¡®è®¤çŠ¶æ€ç  200
- [ ] å‰å¾€ **Firebase Console > Functions > Logs**
- [ ] æŸ¥çœ‹ `createStripeCheckoutSession` æ—¥å¿—
- [ ] ç¡®è®¤æ—¥å¿—ä¸­æ˜¾ç¤º "æ¨¡å¼: æ¸¬è©¦"
- [ ] å‰å¾€ **Firebase Console > Firestore**
- [ ] æ£€æŸ¥ç”¨æˆ·è®¢é˜…ä¿¡æ¯æ˜¯å¦æ­£ç¡®æ›´æ–°
- [ ] æ£€æŸ¥ Credits ä½™é¢æ˜¯å¦æ­£ç¡®

---

## ğŸ’¡ å…³é”®é…ç½®ä¿¡æ¯

### Firebase Functions ç¯å¢ƒå˜é‡
```bash
# ç”Ÿäº§æ¨¡å¼å¯†é’¥
firebase functions:config:set stripe.secret_key="sk_live_..."

# æµ‹è¯•æ¨¡å¼å¯†é’¥ï¼ˆå·²é…ç½®ï¼‰
firebase functions:config:set stripe.test_secret_key="sk_test_YOUR_TEST_SECRET_KEY"

# Webhook Signing Secret
firebase functions:config:set stripe.webhook_secret="whsec_..."
```

### éƒ¨ç½²å‘½ä»¤
```bash
# éƒ¨ç½²æ‰€æœ‰ Functions
firebase deploy --only functions

# ä»…éƒ¨ç½²ç‰¹å®š Function
firebase deploy --only functions:createStripeCheckoutSession
```

---

## âš ï¸ é‡è¦æé†’

### å…³äºæµ‹è¯•æ¨¡å¼
1. **å®Œå…¨å…è´¹**ï¼šæµ‹è¯•æ¨¡å¼ä¸‹çš„æ‰€æœ‰æ”¯ä»˜éƒ½æ˜¯æ¨¡æ‹Ÿçš„ï¼Œä¸æ¶‰åŠçœŸå®é‡‘é’±
2. **æ— é™æ¬¡æµ‹è¯•**ï¼šæ‚¨å¯ä»¥æ— é™æ¬¡ä½¿ç”¨æµ‹è¯•å¡å·è¿›è¡Œæµ‹è¯•
3. **å’Œæ­£å¼ç‰ˆä¸€æ ·**ï¼šæµ‹è¯•æ¨¡å¼ä½¿ç”¨ç›¸åŒçš„ä»£ç é€»è¾‘ï¼Œåªæ˜¯å¯†é’¥å’Œ Price IDs ä¸åŒ
4. **æ•°æ®éš”ç¦»**ï¼šæµ‹è¯•æ•°æ®å’Œç”Ÿäº§æ•°æ®å®Œå…¨éš”ç¦»

### å…³äºå¹´è´¹æµ‹è¯•
- å¹´è´¹æµ‹è¯•æ–¹æ¡ˆå°šæœªåˆ›å»º
- æŒ‰é’®æ˜¾ç¤ºä¸ºç°è‰²ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰
- å¦‚éœ€æµ‹è¯•å¹´è´¹ï¼Œéœ€è¦å…ˆåœ¨ Stripe æµ‹è¯•æ¨¡å¼ä¸‹åˆ›å»ºå¹´è´¹äº§å“
- åˆ›å»ºåæ›´æ–°ä»£ç ä¸­çš„ `testPriceMapping.yearly` å¹¶é‡æ–°éƒ¨ç½²

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. âœ… **ç«‹å³æµ‹è¯•**ï¼šä½¿ç”¨æœˆè´¹æµ‹è¯•æŒ‰é’®è¿›è¡Œå®Œæ•´çš„æ”¯ä»˜æµç¨‹æµ‹è¯•
2. âœ… **éªŒè¯ Webhook**ï¼šç¡®è®¤ Stripe Webhook æ­£ç¡®è§¦å‘å¹¶å¤„ç†æµ‹è¯•æ”¯ä»˜
3. âœ… **æ£€æŸ¥æ•°æ®**ï¼šç¡®è®¤ Firebase Firestore ä¸­çš„è®¢é˜…å’Œ Credits æ•°æ®æ­£ç¡®
4. â³ **åˆ›å»ºå¹´è´¹æµ‹è¯•äº§å“**ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚éœ€æµ‹è¯•å¹´è´¹ï¼Œåœ¨ Stripe æµ‹è¯•æ¨¡å¼ä¸‹åˆ›å»º
5. â³ **ç”Ÿäº§æµ‹è¯•**ï¼ˆè°¨æ…ï¼‰ï¼šç¡®è®¤æµ‹è¯•æ¨¡å¼æ— è¯¯åï¼Œç”¨å°é‡‘é¢åœ¨ç”Ÿäº§æ¨¡å¼è¿›è¡Œæœ€ç»ˆéªŒè¯

---

## ğŸ“Š æµ‹è¯•æµç¨‹å›¾

```
1. ç”¨æˆ·è®¿é—® billing.html
   â†“
2. ç”¨æˆ·ç™»å½•
   â†“
3. ç‚¹å‡» "ğŸ§ª æ¸¬è©¦ Get Started"ï¼ˆé»„è‰²æŒ‰é’®ï¼‰
   â†“
4. å‰ç«¯è°ƒç”¨ Firebase Functions
   ä¼ é€’: { planType: 'monthly', userId, email, isTest: true }
   â†“
5. Firebase Functions åˆ›å»º Stripe Checkout Session
   ä½¿ç”¨: stripeTest å®¢æˆ·ç«¯ï¼ˆæµ‹è¯•å¯†é’¥ï¼‰
   ä½¿ç”¨: æµ‹è¯• Price IDs
   â†“
6. è·³è½¬åˆ° Stripe Checkout
   Email å·²è‡ªåŠ¨å¡«å……
   â†“
7. è¾“å…¥æµ‹è¯•å¡å·: 4242 4242 4242 4242
   â†“
8. æ”¯ä»˜æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼Œä¸æ‰£é’±ï¼‰
   â†“
9. Stripe è§¦å‘ Webhook
   â†“
10. Firebase Functions å¤„ç† Webhook
    æ·»åŠ  Credits åˆ°ç”¨æˆ·è´¦æˆ·
    â†“
11. è·³è½¬å› billing.html?success=true&test=true
    â†“
12. æµ‹è¯•å®Œæˆï¼ ğŸ‰
```

---

## ğŸ‰ æ€»ç»“

æ‚¨ç°åœ¨æ‹¥æœ‰ï¼š
- âœ… **å®Œæ•´çš„æµ‹è¯•ç¯å¢ƒ**ï¼šç‹¬ç«‹çš„æµ‹è¯• Stripe å¯†é’¥å’Œ Price IDs
- âœ… **ä¾¿æ·çš„æµ‹è¯•æŒ‰é’®**ï¼šé»„è‰²æµ‹è¯•æŒ‰é’®ï¼Œç‚¹å‡»å³ç”¨
- âœ… **å’Œæ­£å¼ç‰ˆä¸€è‡´çš„é€»è¾‘**ï¼šç›¸åŒçš„ä»£ç è·¯å¾„ï¼Œåªæ˜¯ä½¿ç”¨ä¸åŒçš„é…ç½®
- âœ… **å®Œå…¨å…è´¹çš„æµ‹è¯•**ï¼šä½¿ç”¨æµ‹è¯•å¡å·ï¼Œä¸æ¶‰åŠçœŸå®é‡‘é’±
- âœ… **è¯¦ç»†çš„æµ‹è¯•æŒ‡å—**ï¼šå®Œæ•´çš„æ­¥éª¤è¯´æ˜å’Œæ•…éšœæ’é™¤

**è®°ä½**ï¼š
- ğŸŸ¡ **é»„è‰²æŒ‰é’®** = æµ‹è¯•æ¨¡å¼ï¼ˆå…è´¹ï¼‰
- ğŸŸ£ **ç´«è‰²æŒ‰é’®** = ç”Ÿäº§æ¨¡å¼ï¼ˆçœŸå®æ”¯ä»˜ï¼‰

**æµ‹è¯•æ¨¡å¼æ˜¯æ‚¨çš„æœ‹å‹ï¼å°½æƒ…æµ‹è¯•ï¼Œæ— éœ€æ‹…å¿ƒè´¹ç”¨ï¼** ğŸ‰

---

**é…ç½®å®Œæˆæ—¶é—´**: 2025-01-XX
**é…ç½®äººå‘˜**: AI Assistant
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éƒ¨ç½²

