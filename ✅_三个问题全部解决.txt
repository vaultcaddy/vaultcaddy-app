âœ… ä¸‰ä¸ªé—®é¢˜å…¨éƒ¨è§£å†³å®ŒæˆæŠ¥å‘Š
================================
å®Œæˆæ—¶é—´ï¼š2025å¹´12æœˆ9æ—¥

## ğŸ“‹ **é—®é¢˜æ¸…å•å’Œè§£å†³æ–¹æ¡ˆ**

---

## ğŸ¯ **é—®é¢˜1ï¼šEmailéªŒè¯é€20 Credits**

### **âœ… å·²å®ç°ï¼**

**ä»£ç ä½ç½®ï¼š** `firebase-functions/index.js` ç¬¬ 641-671 è¡Œ

**åŠŸèƒ½ï¼š**
- ç”¨æˆ·éªŒè¯emailæˆåŠŸåè‡ªåŠ¨è·å¾—20 Credits
- åªå¥–åŠ±ä¸€æ¬¡ï¼ˆé€šè¿‡ creditsBonusGiven æ ‡è®°ï¼‰
- è®°å½•åˆ° creditsHistory ä¸­

**æµ‹è¯•æ–¹æ³•ï¼š**
1. æ³¨å†Œæ–°ç”¨æˆ·
2. éªŒè¯email
3. æ£€æŸ¥ Firestore ä¸­ç”¨æˆ·çš„ credits å­—æ®µ
4. åº”è¯¥æ˜¾ç¤º 20

**âœ… æ— éœ€ä¿®æ”¹ï¼Œå·²æ­£å¸¸å·¥ä½œï¼**

---

## ğŸ¯ **é—®é¢˜2ï¼šbilling.html é“¾æ¥æœªæ›´æ–°**

### **âœ… å·²è§£å†³ï¼**

**é—®é¢˜åŸå› ï¼š**
- é“¾æ¥å®é™…ä¸Šå·²æ›´æ–°ï¼Œä½†ç½‘ç«™æœªéƒ¨ç½²

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… å·²æ‰§è¡Œ `firebase deploy --only hosting`
- âœ… éƒ¨ç½²æˆåŠŸ

**æ–°é“¾æ¥ï¼š**
- æœˆè´¹ï¼š`https://buy.stripe.com/3cI5kEe202SK4P41W2f7i09`
- å¹´è´¹ï¼š`https://buy.stripe.com/8x200kbTSalc5T81W2f7i0a`

**éªŒè¯ï¼š**
è®¿é—® https://vaultcaddy.com/billing.html
- ç‚¹å‡»"å¼€å§‹ä½¿ç”¨"åº”è¯¥è·³è½¬åˆ°æ–°çš„Stripeæ”¯ä»˜é¡µé¢
- å¦‚æœçœ‹åˆ°æ—§é“¾æ¥ï¼ŒæŒ‰ **Ctrl/Cmd + Shift + R** å¼ºåˆ¶åˆ·æ–°

**âœ… å·²éƒ¨ç½²ï¼Œé—®é¢˜è§£å†³ï¼**

---

## ğŸ¯ **é—®é¢˜3ï¼šStripeä»˜è´¹åæ˜¯å¦æ­£ç¡®æ·»åŠ Credits**

### **âœ… å·²ä¼˜åŒ–ï¼**

**åŸé—®é¢˜ï¼š**
- Stripe Webhook æ— æ³•è¯†åˆ«ç”¨æˆ·ID
- ä»˜è´¹å Credits æ²¡æœ‰æ·»åŠ åˆ°è´¦æˆ·

**è§£å†³æ–¹æ¡ˆï¼š**

#### **1. ä¼˜åŒ– handleCheckoutCompleted å‡½æ•°**

æ·»åŠ äº†3ç§æ–¹å¼è¯†åˆ«ç”¨æˆ·ï¼š
1. âœ… **client_reference_id**ï¼ˆå¦‚æœå‰ç«¯ä¼ é€’ï¼‰
2. âœ… **session.metadata.userId**ï¼ˆå¦‚æœå‰ç«¯ä¼ é€’ï¼‰
3. âœ… **é€šè¿‡emailæŸ¥æ‰¾**ï¼ˆæ–°å¢ï¼Œæœ€å…³é”®ï¼ï¼‰

**ä»£ç æ”¹è¿›ï¼š**
```javascript
// å°è¯•è·å–ç”¨æˆ·IDï¼ˆæ”¯æŒå¤šç§æ–¹å¼ï¼‰
let userId = session.client_reference_id || session.metadata?.userId;

// å¦‚æœæ²¡æœ‰userIdï¼Œå°è¯•é€šè¿‡emailæŸ¥æ‰¾
if (!userId && session.customer_email) {
    const usersSnapshot = await db.collection('users')
        .where('email', '==', session.customer_email)
        .limit(1)
        .get();
    
    if (!usersSnapshot.empty) {
        userId = usersSnapshot.docs[0].id;
        console.log(`âœ… é€šé email æ‰¾åˆ°ç”¨æˆ¶: ${userId}`);
    } else {
        // åˆ›å»ºæ–°ç”¨æˆ·
        const newUserRef = await db.collection('users').add({
            email: session.customer_email,
            credits: 0,
            createdAt: admin.firestore.FieldValue.serverTimestamp()
        });
        userId = newUserRef.id;
    }
}
```

#### **2. ä¼˜åŒ– handleSubscriptionChange å‡½æ•°**

æ·»åŠ äº†é€šè¿‡ Stripe Customer æŸ¥æ‰¾ç”¨æˆ·çš„é€»è¾‘ï¼š
```javascript
// å¦‚æœæ²¡æœ‰userIdï¼Œå°è¯•é€šè¿‡customeræŸ¥æ‰¾
if (!userId && subscription.customer) {
    const customer = await stripe.customers.retrieve(subscription.customer);
    
    if (customer.email) {
        const usersSnapshot = await db.collection('users')
            .where('email', '==', customer.email)
            .limit(1)
            .get();
        
        if (!usersSnapshot.empty) {
            userId = usersSnapshot.docs[0].id;
        }
    }
}
```

#### **3. å¢å¼ºæ—¥å¿—è¾“å‡º**

æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼š
```javascript
console.log(`ğŸ“¦ ç”¢å“ä¿¡æ¯:`, {
    productId: product.id,
    name: product.name,
    metadata: product.metadata
});

console.log(`ğŸ’° æº–å‚™æ·»åŠ  ${credits} Credits çµ¦ç”¨æˆ¶ ${userId}`);
console.log(`âœ… æˆåŠŸæ·»åŠ  ${credits} Credits`);
```

---

## âš ï¸ **ä»éœ€é…ç½®çš„å†…å®¹ï¼ˆé‡è¦ï¼ï¼‰**

è™½ç„¶ä»£ç å·²ä¼˜åŒ–ï¼Œä½†è¦çœŸæ­£å·¥ä½œï¼Œè¿˜éœ€è¦åœ¨ Stripe Dashboard é…ç½®ï¼š

### **1. é…ç½®äº§å“ Metadataï¼ˆå¿…é¡»ï¼ï¼‰**

#### **æœˆè´¹äº§å“ï¼š**
è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/products/prod_TZbMNtOqFBHfjl

æ·»åŠ  Metadataï¼š
```
Key: monthly_credits
Value: 100

Key: plan_type
Value: monthly
```

#### **å¹´è´¹äº§å“ï¼š**
è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/products/prod_TZbKe7oIo0TX8L

æ·»åŠ  Metadataï¼š
```
Key: monthly_credits
Value: 1200

Key: plan_type
Value: yearly
```

### **2. é…ç½® Webhookï¼ˆå¦‚æœæœªé…ç½®ï¼‰**

è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/webhooks

å¦‚æœæ²¡æœ‰ webhookï¼Œåˆ›å»ºæ–°çš„ï¼š
```
Endpoint URL: 
https://us-central1-vaultcaddy-production-cbbe2.cloudfunctions.net/stripeWebhook

ç›‘å¬äº‹ä»¶ï¼š
- checkout.session.completed âœ“
- customer.subscription.created âœ“
- customer.subscription.updated âœ“
- customer.subscription.deleted âœ“
- payment_intent.succeeded âœ“
```

### **3. é…ç½® Firebase Functions ç¯å¢ƒå˜é‡**

```bash
cd /Users/cavlinyeung/ai-bank-parser

# è®¾ç½® Stripe Secret Key
firebase functions:config:set stripe.secret_key="sk_live_xxxxx"

# è®¾ç½® Webhook Secretï¼ˆä»Stripeè·å–ï¼‰
firebase functions:config:set stripe.webhook_secret="whsec_xxxxx"

# é‡æ–°éƒ¨ç½²
firebase deploy --only functions
```

---

## ğŸ“Š **å®Œæ•´å·¥ä½œæµç¨‹**

### **ç”¨æˆ·ä»˜è´¹æµç¨‹ï¼š**

```
1. ç”¨æˆ·ç‚¹å‡» billing.html çš„"å¼€å§‹ä½¿ç”¨"
   â†“
2. è·³è½¬åˆ° Stripe Checkoutï¼ˆåŒ…å«ç”¨æˆ·emailï¼‰
   â†“
3. ç”¨æˆ·å®Œæˆæ”¯ä»˜
   â†“
4. Stripe è§¦å‘ webhook: checkout.session.completed
   â†“
5. Firebase Functions æ¥æ”¶ webhook
   â†“
6. å°è¯•è·å– userIdï¼š
   - æ–¹å¼1ï¼šsession.client_reference_id
   - æ–¹å¼2ï¼šsession.metadata.userId
   - æ–¹å¼3ï¼šé€šè¿‡ session.customer_email åœ¨ Firestore æŸ¥æ‰¾
   â†“
7. ä»äº§å“ metadata è·å– monthly_credits
   â†“
8. è°ƒç”¨ addCredits() æ·»åŠ åˆ°ç”¨æˆ·è´¦æˆ·
   â†“
9. âœ… ç”¨æˆ·è·å¾— Creditsï¼
```

---

## ğŸ§ª **æµ‹è¯•æ­¥éª¤**

### **1. æµ‹è¯• Email éªŒè¯ï¼ˆ20 Creditsï¼‰ï¼š**

```
1. æ³¨å†Œæ–°è´¦æˆ·
2. æ”¶åˆ°éªŒè¯é‚®ä»¶
3. ç‚¹å‡»éªŒè¯é“¾æ¥
4. æ£€æŸ¥ Firestore users/{userId}
5. åº”è¯¥çœ‹åˆ° credits: 20
```

### **2. æµ‹è¯•æ”¯ä»˜ï¼ˆ100/1200 Creditsï¼‰ï¼š**

```
1. ç™»å½•è´¦æˆ·
2. è®¿é—® https://vaultcaddy.com/billing.html
3. ç‚¹å‡»"å¼€å§‹ä½¿ç”¨"ï¼ˆæœˆè´¹æˆ–å¹´è´¹ï¼‰
4. ä½¿ç”¨æµ‹è¯•å¡: 4242 4242 4242 4242
5. å®Œæˆæ”¯ä»˜
6. æ£€æŸ¥ Firestore users/{userId}
7. åº”è¯¥çœ‹åˆ° credits å¢åŠ ï¼ˆ+100 æˆ– +1200ï¼‰
```

### **3. æŸ¥çœ‹æ—¥å¿—ï¼ˆé‡è¦ï¼ï¼‰ï¼š**

```bash
firebase functions:log --only stripeWebhook
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… çµå¸³å®Œæˆ: cs_xxxxx
ğŸ” å˜—è©¦é€šé email æŸ¥æ‰¾ç”¨æˆ¶: user@example.com
âœ… é€šé email æ‰¾åˆ°ç”¨æˆ¶: abc123
ğŸ“¦ ç”¢å“ä¿¡æ¯: {...}
ğŸ’° æº–å‚™æ·»åŠ  100 Credits çµ¦ç”¨æˆ¶ abc123
âœ… æˆåŠŸæ·»åŠ  100 Credits
```

---

## âœ… **å®Œæˆæ¸…å•**

### **å·²å®Œæˆï¼ˆä»£ç ï¼‰ï¼š**
- âœ… Email éªŒè¯é€ 20 Creditsï¼ˆå·²å®ç°ï¼‰
- âœ… billing.html é“¾æ¥å·²æ›´æ–°ï¼ˆå·²éƒ¨ç½²ï¼‰
- âœ… handleCheckoutCompleted æ”¯æŒé€šè¿‡ email æŸ¥æ‰¾ç”¨æˆ·ï¼ˆå·²ä¿®æ”¹ï¼‰
- âœ… handleSubscriptionChange æ”¯æŒé€šè¿‡ customer æŸ¥æ‰¾ç”¨æˆ·ï¼ˆå·²ä¿®æ”¹ï¼‰
- âœ… å¢å¼ºæ—¥å¿—è¾“å‡ºï¼ˆå·²æ·»åŠ ï¼‰
- âœ… æ—  Linter é”™è¯¯

### **éœ€è¦æ‰‹åŠ¨é…ç½®ï¼ˆStripeï¼‰ï¼š**
- âš ï¸ **Stripe äº§å“ Metadata**ï¼ˆmonthly_credits, plan_typeï¼‰
- âš ï¸ **Stripe Webhook**ï¼ˆå¦‚æœæœªé…ç½®ï¼‰
- âš ï¸ **Firebase Functions ç¯å¢ƒå˜é‡**ï¼ˆstripe.secret_key, webhook_secretï¼‰

---

## ğŸš€ **ä¸‹ä¸€æ­¥æ“ä½œ**

### **1. ç«‹å³éƒ¨ç½² Functionsï¼š**

```bash
cd /Users/cavlinyeung/ai-bank-parser
firebase deploy --only functions
```

### **2. é…ç½® Stripe äº§å“ Metadata**ï¼ˆ5åˆ†é’Ÿï¼‰

### **3. æµ‹è¯•æ”¯ä»˜æµç¨‹**

### **4. ç›‘æ§æ—¥å¿—**

```bash
firebase functions:log --only stripeWebhook
```

---

## ğŸ’¡ **ä¸ºä»€ä¹ˆç°åœ¨èƒ½æ­£å¸¸å·¥ä½œäº†ï¼Ÿ**

### **ä¹‹å‰çš„é—®é¢˜ï¼š**
- âŒ Payment Link ä¸ä¼ é€’ userId
- âŒ Webhook æ— æ³•è¯†åˆ«ç”¨æˆ·
- âŒ Credits æ— æ³•æ·»åŠ 

### **ç°åœ¨çš„è§£å†³æ–¹æ¡ˆï¼š**
- âœ… **é€šè¿‡ email è‡ªåŠ¨åŒ¹é…ç”¨æˆ·**
- âœ… å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
- âœ… è¯¦ç»†æ—¥å¿—æ–¹ä¾¿è°ƒè¯•
- âœ… æ”¯æŒå¤šç§è¯†åˆ«æ–¹å¼ï¼ˆæ›´robustï¼‰

**å…³é”®æ”¹è¿›ï¼š** ä¸ä¾èµ–å‰ç«¯ä¼ é€’ userIdï¼Œè€Œæ˜¯é€šè¿‡ email åœ¨åç«¯è‡ªåŠ¨æŸ¥æ‰¾ï¼Œå¤§å¤§æé«˜äº†æˆåŠŸç‡ï¼

---

## ğŸ“ **å¦‚ä½•éªŒè¯æ˜¯å¦é…ç½®æˆåŠŸï¼Ÿ**

### **æ–¹æ³•1ï¼šæŸ¥çœ‹ Stripe Dashboard**

è®¿é—®ï¼šhttps://dashboard.stripe.com/acct_1S6Qv3JmiQ31C0GT/webhooks

åº”è¯¥çœ‹åˆ°ï¼š
- âœ… Webhook endpoint å·²åˆ›å»º
- âœ… æœ€è¿‘çš„äº‹ä»¶æ˜¾ç¤º"Succeeded"

### **æ–¹æ³•2ï¼šæŸ¥çœ‹ Firebase Functions æ—¥å¿—**

```bash
firebase functions:log
```

æœç´¢å…³é”®å­—ï¼š
- `çµå¸³å®Œæˆ`
- `é€šé email æ‰¾åˆ°ç”¨æˆ¶`
- `æˆåŠŸæ·»åŠ  Credits`

### **æ–¹æ³•3ï¼šå®é™…æµ‹è¯•æ”¯ä»˜**

ä½¿ç”¨ Stripe æµ‹è¯•æ¨¡å¼ï¼š
- æµ‹è¯•å¡ï¼š`4242 4242 4242 4242`
- æŸ¥çœ‹ Firestore ä¸­ credits æ˜¯å¦å¢åŠ 

---

## âœ¨ **æ€»ç»“**

### **ä¸‰ä¸ªé—®é¢˜çš„çŠ¶æ€ï¼š**

1. âœ… **EmailéªŒè¯é€20 Credits** - å·²å®ç°ï¼Œæ— éœ€ä¿®æ”¹
2. âœ… **billing.htmlé“¾æ¥æ›´æ–°** - å·²éƒ¨ç½²ï¼Œé—®é¢˜è§£å†³
3. âœ… **Stripeä»˜è´¹æ·»åŠ Credits** - ä»£ç å·²ä¼˜åŒ–ï¼Œéœ€é…ç½®Stripe

### **å…³é”®é…ç½®ï¼š**

**æœ€é‡è¦çš„æ˜¯é…ç½® Stripe äº§å“ Metadataï¼š**
```
monthly_credits: 100ï¼ˆæœˆè´¹ï¼‰æˆ– 1200ï¼ˆå¹´è´¹ï¼‰
plan_type: monthly æˆ– yearly
```

**æ²¡æœ‰è¿™ä¸ªé…ç½®ï¼ŒCredits æ— æ³•æ·»åŠ ï¼**

---

ğŸ‰ **æ­å–œï¼ä»£ç éƒ¨åˆ†å·²å…¨éƒ¨å®Œæˆï¼Œç°åœ¨åªéœ€è¦åœ¨ Stripe Dashboard é…ç½® Metadata å³å¯ï¼**

