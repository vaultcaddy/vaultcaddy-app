<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe è®¡è´¹é…ç½®è¯Šæ–­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .section {
            background: #f8f9fa;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .issue {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .comparison-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .comparison-item h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .comparison-item.wrong {
            border-color: #dc3545;
        }

        .comparison-item.correct {
            border-color: #28a745;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        .button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 0.5rem 0;
            padding-left: 2rem;
            position: relative;
        }

        .checklist li::before {
            content: 'â˜';
            position: absolute;
            left: 0;
            font-size: 1.2rem;
        }

        .checklist li.checked::before {
            content: 'âœ“';
            color: #28a745;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .highlight {
            background: #fff3cd;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Stripe è®¡è´¹é…ç½®è¯Šæ–­</h1>
        
        <div class="error">
            <strong>ğŸš¨ å‘ç°å…³é”®é—®é¢˜ï¼</strong><br>
            ä½ çš„ Stripe é…ç½®å¯èƒ½ä½¿ç”¨äº†<strong>æ–°çš„ Billing Meters API</strong>ï¼Œ<br>
            ä½†æˆ‘ä»¬çš„ä»£ç ä½¿ç”¨çš„æ˜¯<strong>æ—§çš„ Usage Records API</strong>ï¼<br>
            ä¸¤è€…<strong>ä¸å…¼å®¹</strong>ï¼Œè¿™å°±æ˜¯è¶…é¢è´¹ç”¨æ²¡æœ‰è¢«æ”¶å–çš„åŸå› ã€‚
        </div>

        <div class="section">
            <h2>ğŸ“Š Stripe çš„ä¸¤ç§è®¡é‡è®¡è´¹æ–¹å¼</h2>
            
            <div class="comparison">
                <div class="comparison-item wrong">
                    <h3>âŒ æ–°æ–¹å¼ï¼šBilling Metersï¼ˆä½ å¯èƒ½åœ¨ç”¨ï¼‰</h3>
                    <div class="code-block">
# å›¾5ä¸­çš„ä»£ç 
POST /v1/billing/meter_events
event_name: vaultcaddy_credit_usage
payload[value]: 1
                    </div>
                    <strong>é—®é¢˜ï¼š</strong> æˆ‘ä»¬çš„ä»£ç ä¸æ”¯æŒè¿™ä¸ªï¼
                </div>

                <div class="comparison-item correct">
                    <h3>âœ… æ—§æ–¹å¼ï¼šUsage Recordsï¼ˆæˆ‘ä»¬æ”¯æŒï¼‰</h3>
                    <div class="code-block">
# æˆ‘ä»¬çš„ä»£ç ä½¿ç”¨
POST /v1/subscription_items/{id}/usage_records
quantity: 150
action: set
                    </div>
                    <strong>å…¼å®¹ï¼š</strong> ä»£ç å·²å®Œå…¨æ”¯æŒï¼
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ” å¦‚ä½•æ£€æŸ¥ä½ çš„é…ç½®</h2>
            
            <h3>æ­¥éª¤ 1ï¼šæ‰“å¼€ä½ çš„äº§å“é¡µé¢</h3>
            <a href="https://dashboard.stripe.com/test/products" class="button" target="_blank">
                æ‰“å¼€ Stripe äº§å“
            </a>

            <h3 style="margin-top: 1rem;">æ­¥éª¤ 2ï¼šæ‰¾åˆ° "VaultCaddy Monthly" äº§å“</h3>
            
            <h3 style="margin-top: 1rem;">æ­¥éª¤ 3ï¼šæŸ¥çœ‹ä»·æ ¼é…ç½®ï¼Œå¯¹ç…§ä¸‹è¡¨ï¼š</h3>

            <table>
                <thead>
                    <tr>
                        <th>é…ç½®é¡¹</th>
                        <th>âŒ æ–°æ–¹å¼ï¼ˆä¸å…¼å®¹ï¼‰</th>
                        <th>âœ… æ—§æ–¹å¼ï¼ˆå…¼å®¹ï¼‰</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>è®¡è´¹æ¨¡å‹</strong></td>
                        <td><span class="highlight">Usage-based with meters</span></td>
                        <td><span class="highlight">Usage-based / Standard pricing</span></td>
                    </tr>
                    <tr>
                        <td><strong>Meter</strong></td>
                        <td>âœ“ æ˜¾ç¤º Meter name</td>
                        <td>âœ— ä¸æ˜¾ç¤º Meter</td>
                    </tr>
                    <tr>
                        <td><strong>Event name</strong></td>
                        <td><code>vaultcaddy_credit_usage</code></td>
                        <td>âœ— æ²¡æœ‰è¿™ä¸ªå­—æ®µ</td>
                    </tr>
                    <tr>
                        <td><strong>Aggregation</strong></td>
                        <td>é€šè¿‡ Meter é…ç½®</td>
                        <td>Sum of usage values</td>
                    </tr>
                    <tr>
                        <td><strong>Pricing tiers</strong></td>
                        <td>åœ¨ Meter ä¸­é…ç½®</td>
                        <td>åœ¨ Price ä¸­é…ç½®</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>âœ… è§£å†³æ–¹æ¡ˆ Aï¼šåˆ‡æ¢åˆ°æ—§æ–¹å¼ï¼ˆæ¨èï¼‰</h2>
            
            <div class="success">
                <strong>âœ“ ä¼˜ç‚¹ï¼š</strong><br>
                â€¢ æ— éœ€ä¿®æ”¹ä»£ç <br>
                â€¢ ç«‹å³å¯ç”¨<br>
                â€¢ æ›´æˆç†Ÿç¨³å®š<br>
                â€¢ æˆ‘ä»¬çš„ä»£ç å·²å®Œå…¨æ”¯æŒ
            </div>

            <h3>è¯¦ç»†æ­¥éª¤ï¼š</h3>

            <ol style="padding-left: 2rem; line-height: 2;">
                <li><strong>åˆ›å»ºæ–°çš„ä»·æ ¼ï¼š</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 2rem;">
                        <li>æ‰“å¼€äº§å“ "VaultCaddy Monthly"</li>
                        <li>ç‚¹å‡»ã€ŒAdd another priceã€</li>
                        <li>é€‰æ‹©é…ç½®ï¼š</li>
                    </ul>
                    <div class="code-block">
äº§å“ï¼šVaultCaddy Monthly
ä»·æ ¼æ¨¡å‹ï¼šRecurring
è®¡è´¹å‘¨æœŸï¼šMonthly  
åŸºç¡€ä»·æ ¼ï¼šHK$58.00

â˜‘ï¸ å¯ç”¨ç”¨é‡è®¡è´¹ï¼ˆUsage is meteredï¼‰
Aggregationï¼šSum of usage values
Pricing modelï¼šGraduated pricing

å®šä»·å±‚çº§ï¼š
â€¢ ç¬¬ 1 å±‚ï¼š0 - 100 å•ä½ = HK$0.00
â€¢ ç¬¬ 2 å±‚ï¼š101 - 500 å•ä½ = HK$0.50 per unit
â€¢ ç¬¬ 3 å±‚ï¼š501 - 1000 å•ä½ = HK$0.45 per unit  
â€¢ ç¬¬ 4 å±‚ï¼š1001+ å•ä½ = HK$0.40 per unit
                    </div>
                </li>

                <li><strong>æ›´æ–°æµ‹è¯•è®¢é˜…ï¼š</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 2rem;">
                        <li>æ‰“å¼€å®¢æˆ· 1234@gmail.com çš„è®¢é˜…</li>
                        <li>ç‚¹å‡»ã€ŒUpdate subscriptionã€</li>
                        <li>æ›¿æ¢ä¸ºæ–°åˆ›å»ºçš„ä»·æ ¼</li>
                        <li>ä¿å­˜</li>
                    </ul>
                </li>

                <li><strong>éªŒè¯é…ç½®ï¼š</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 2rem;">
                        <li>è®¢é˜…åº”è¯¥åŒ…å«ä¸¤ä¸ªé¡¹ç›®ï¼š
                            <ul style="padding-left: 2rem;">
                                <li>1. å›ºå®šè®¢é˜…è´¹ç”¨ï¼ˆHK$58/æœˆï¼‰</li>
                                <li>2. æŒ‰é‡è®¡è´¹é¡¹ç›®ï¼ˆMetered usageï¼‰</li>
                            </ul>
                        </li>
                    </ul>
                </li>

                <li><strong>é‡æ–°æµ‹è¯•ï¼š</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 2rem;">
                        <li>è®¾ç½® credits = -50</li>
                        <li>å–æ¶ˆè®¢é˜…</li>
                        <li>æŸ¥çœ‹æ—¥å¿—å’Œå‘ç¥¨</li>
                    </ul>
                </li>
            </ol>

            <a href="https://dashboard.stripe.com/test/products" class="button" target="_blank">
                å¼€å§‹é…ç½®
            </a>
        </div>

        <div class="section">
            <h2>ğŸ”§ è§£å†³æ–¹æ¡ˆ Bï¼šæ›´æ–°ä»£ç æ”¯æŒæ–°çš„ Billing Meters</h2>
            
            <div class="issue">
                <strong>âš ï¸ æ³¨æ„ï¼š</strong><br>
                è¿™éœ€è¦ä¿®æ”¹ä»£ç ï¼Œå¹¶ä¸”æ–°çš„ Billing Meters API è¿˜åœ¨ Beta é˜¶æ®µï¼Œ<br>
                <strong>å¼ºçƒˆå»ºè®®å…ˆå°è¯•æ–¹æ¡ˆ A</strong>ã€‚
            </div>

            <p>å¦‚æœä½ åšæŒä½¿ç”¨æ–°çš„ Billing Metersï¼Œéœ€è¦ï¼š</p>

            <ol style="padding-left: 2rem; line-height: 2;">
                <li>ä¿®æ”¹ <code>handleInvoiceCreated</code> å‡½æ•°</li>
                <li>æ›¿æ¢ <code>subscriptionItems.createUsageRecord()</code></li>
                <li>æ”¹ç”¨ <code>billing.meterEvents.create()</code></li>
                <li>æ›´æ–°æ‰€æœ‰ç›¸å…³é€»è¾‘</li>
            </ol>

            <p><strong>å‘Šè¯‰æˆ‘å¦‚æœä½ éœ€è¦è¿™ä¸ªæ–¹æ¡ˆï¼Œæˆ‘å¯ä»¥å¸®ä½ å®ç°ã€‚</strong></p>
        </div>

        <div class="section">
            <h2>ğŸ“‹ è¯Šæ–­æ£€æŸ¥æ¸…å•</h2>
            
            <ul class="checklist">
                <li>æ‰“å¼€ Stripe Dashboard - Products</li>
                <li>æ‰¾åˆ° VaultCaddy Monthly äº§å“</li>
                <li>æ£€æŸ¥ä»·æ ¼é…ç½®ç±»å‹</li>
                <li>ç¡®è®¤æ˜¯å¦ä½¿ç”¨äº† "Billing Meters"</li>
                <li>å¦‚æœæ˜¯ï¼ŒæŒ‰ç…§æ–¹æ¡ˆ A åˆ›å»ºæ–°ä»·æ ¼</li>
                <li>æ›´æ–°æµ‹è¯•è®¢é˜…åˆ°æ–°ä»·æ ¼</li>
                <li>è®¾ç½® Firestore credits = -50</li>
                <li>é‡æ–°æµ‹è¯•å–æ¶ˆè®¢é˜…</li>
                <li>æŸ¥çœ‹ Firebase æ—¥å¿—</li>
                <li>éªŒè¯ Stripe å‘ç¥¨åŒ…å«è¶…é¢è´¹ç”¨</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ¯ å¿«é€Ÿè¯Šæ–­</h2>
            
            <p><strong>æ£€æŸ¥ä½ çš„ Firestore æ•°æ®ï¼ˆå›¾2ï¼‰ï¼š</strong></p>
            <div class="code-block">
subscription:
  meteredSubscriptionItemId: "si_TcYeJnOgjEw9lM"  â† å¦‚æœæœ‰è¿™ä¸ªï¼Œè¯´æ˜ä½¿ç”¨æ—§æ–¹å¼
  stripeSubscriptionId: "sub_1SfJXEJmiQ31C0GT..."
            </div>

            <p style="margin-top: 1rem;"><strong>å¦‚æœä½ æœ‰ <code>meteredSubscriptionItemId</code>ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨æ—§æ–¹å¼ï¼</strong></p>

            <div class="success">
                <strong>âœ“ å¥½æ¶ˆæ¯ï¼š</strong> ä»å›¾2çœ‹åˆ°ä½ æœ‰ <code>meteredSubscriptionItemId</code>ï¼Œ<br>
                è¯´æ˜ä½ çš„è®¢é˜…é…ç½®æ˜¯æ­£ç¡®çš„ï¼ˆæ—§æ–¹å¼ï¼‰ï¼<br><br>
                <strong>é—®é¢˜å¯èƒ½æ˜¯ï¼š</strong>
                <ul style="margin: 0.5rem 0 0 2rem;">
                    <li>Webhook æ—¶åºé—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰</li>
                    <li>æ—¥å¿—ä¸­ç¼ºå°‘å…³é”®æ£€æµ‹æ­¥éª¤</li>
                    <li>éœ€è¦é‡æ–°æµ‹è¯•éªŒè¯ä¿®å¤</li>
                </ul>
            </div>

            <a href="https://console.firebase.google.com/project/vaultcaddy-production-cbbe2/firestore/data/~2Fusers~2F3bLhZuU9H0b3ExhwFCJuN4vZeGb2" 
               class="button" target="_blank">
                æŸ¥çœ‹ Firestore æ•°æ®
            </a>
            
            <a href="https://console.cloud.google.com/logs/query;query=resource.type%3D%22cloud_function%22%0Aresource.labels.function_name%3D%22stripeWebhook%22%0Atextpayload%3D~%22invoice.created%22%20OR%20textpayload%3D~%22è¶…é¢%22?project=vaultcaddy-production-cbbe2" 
               class="button" target="_blank">
                æŸ¥çœ‹æœ€æ–°æ—¥å¿—
            </a>
        </div>

        <div class="error">
            <h3>ğŸ”¥ ä¸‹ä¸€æ­¥å»ºè®®</h3>
            <ol style="padding-left: 2rem; line-height: 1.8;">
                <li><strong>ç«‹å³é‡æ–°æµ‹è¯•ï¼š</strong>
                    <ul style="padding-left: 2rem;">
                        <li>ä»£ç å·²ä¿®å¤ï¼ˆä½¿ç”¨ totalCreditsUsedï¼‰</li>
                        <li>è®¾ç½® credits = -50, totalCreditsUsed = 150</li>
                        <li>å–æ¶ˆè®¢é˜…</li>
                        <li>æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æ˜¾ç¤ºï¼š
                            <div class="code-block" style="font-size: 0.85rem;">
âœ… ä» totalCreditsUsed æ£€æµ‹åˆ°è¶…é¢: 50 Credits
âœ… æˆåŠŸæŠ¥å‘Šæ€»ä½¿ç”¨é‡ç»™ Stripe: 150
ğŸ’µ é¢„æœŸæ”¶è´¹: HK$25.00
                            </div>
                        </li>
                    </ul>
                </li>
                <li><strong>å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼š</strong>
                    <ul style="padding-left: 2rem;">
                        <li>æˆªå›¾ç»™æˆ‘çœ‹ Stripe äº§å“é…ç½®</li>
                        <li>æˆªå›¾ç»™æˆ‘çœ‹æœ€æ–°çš„ Firebase æ—¥å¿—</li>
                        <li>æˆ‘ä¼šå¸®ä½ è¿›ä¸€æ­¥è¯Šæ–­</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        console.log('ğŸ” Stripe è®¡è´¹é…ç½®è¯Šæ–­å·¥å…·å·²åŠ è½½');
        
        // é«˜äº®æ˜¾ç¤ºå…³é”®ä¿¡æ¯
        document.querySelectorAll('.highlight').forEach(el => {
            el.style.animation = 'pulse 2s ease-in-out infinite';
        });

        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.6; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

