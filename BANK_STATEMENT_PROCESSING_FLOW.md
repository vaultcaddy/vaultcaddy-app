# ğŸ¦ éŠ€è¡Œå°å¸³å–®è™•ç†æµç¨‹åˆ†æ

## ğŸ“Š ç¾æœ‰è™•ç†æµç¨‹ï¼ˆ3é  PDFï¼‰

### æ­¥é©Ÿæ¦‚è¦½
```
ç”¨æˆ¶ä¸Šå‚³ PDF (3 é )
    â†“
PDF â†’ åœ–ç‰‡è½‰æ› (3 å¼µåœ–)
    â†“
ä¸Šå‚³åˆ° Storage (3 å€‹ URL)
    â†“
å‰µå»ºæ–‡æª”è¨˜éŒ„
    â†“
æ‰£é™¤ 3 Credits
    â†“
ã€é–‹å§‹è™•ç†æ¯ä¸€é ã€‘
    â†“
ç¬¬ 1 é : Vision OCR â†’ éæ¿¾ â†’ DeepSeek åˆ†æ
ç¬¬ 2 é : Vision OCR â†’ éæ¿¾ â†’ DeepSeek åˆ†æ  
ç¬¬ 3 é : Vision OCR â†’ éæ¿¾ â†’ DeepSeek åˆ†æ
    â†“
åˆä½µ 3 é çµæœ
    â†“
æ›´æ–°æ–‡æª”ç‹€æ…‹
```

---

## ğŸ” è©³ç´°æ­¥é©Ÿåˆ†æ

### éšæ®µ 1ï¼šPDF è½‰æ›å’Œä¸Šå‚³ï¼ˆå®¢æˆ¶ç«¯ï¼‰

**åŸ·è¡Œä½ç½®ï¼š** `firstproject.html` â†’ `uploadFileDirect()`

```javascript
// 1. PDF è½‰æ›ç‚ºåœ–ç‰‡
const imageFiles = await pdfToImageConverter.convertPDFToImages(file);
// çµæœï¼š[page1.jpg, page2.jpg, page3.jpg]

// 2. ä¸Šå‚³æ‰€æœ‰åœ–ç‰‡åˆ° Storage
const uploadPromises = filesToProcess.map(f => 
    simpleDataManager.uploadFile(currentProjectId, f)
);
const imageUrls = await Promise.all(uploadPromises);
// çµæœï¼š[url1, url2, url3]

// 3. å‰µå»ºæ–‡æª”è¨˜éŒ„
const docData = {
    name: file.name,
    documentType: 'bank_statement',
    status: 'processing',
    pages: 3,
    imageUrls: [url1, url2, url3]
};
const docId = await simpleDataManager.createDocument(currentProjectId, docData);

// 4. æ‰£é™¤ Creditsï¼ˆ3 é ï¼‰
await creditsManager.deductCredits(3);
```

**ç¸½è€—æ™‚ï¼š** ~3-5 ç§’  
**API èª¿ç”¨ï¼š** 3 æ¬¡ Storage ä¸Šå‚³ + 1 æ¬¡ Firestore å¯«å…¥

---

### éšæ®µ 2ï¼šå¤šé  AI è™•ç†ï¼ˆå¾Œå°ï¼‰

**åŸ·è¡Œä½ç½®ï¼š** `firstproject.html` â†’ `processMultiPageFileWithAI()`

```javascript
for (let i = 0; i < 3; i++) {  // å°æ¯ä¸€é 
    console.log(`ğŸ“„ è™•ç†ç¬¬ ${i + 1}/3 é ...`);
    
    // === ç¬¬ ${i+1} é çš„è™•ç†æµç¨‹ ===
    
    // æ­¥é©Ÿ 1ï¼šVision API OCR
    const ocrText = await processor.extractTextWithVision(files[i]);
    // è¼¸å…¥ï¼špage${i}.jpg
    // è¼¸å‡ºï¼š2521 å­—ç¬¦çš„æ–‡æœ¬
    // è€—æ™‚ï¼š~2 ç§’
    // æˆæœ¬ï¼šå…è²»ï¼ˆVision APIï¼‰
    
    // æ­¥é©Ÿ 2ï¼šæ™ºèƒ½éæ¿¾
    const filteredText = processor.filterRelevantText(ocrText, 'bank_statement');
    // è¼¸å…¥ï¼š2521 å­—ç¬¦
    // è¼¸å‡ºï¼š179 å­—ç¬¦ï¼ˆæ¸›å°‘ 93%ï¼‰
    // è€—æ™‚ï¼š<0.1 ç§’
    // æˆæœ¬ï¼šå…è²»ï¼ˆæœ¬åœ°è™•ç†ï¼‰
    
    // æ­¥é©Ÿ 3ï¼šDeepSeek åˆ†æï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
    for (let attempt = 1; attempt <= 3; attempt++) {
        try {
            const result = await deepseek.analyze(filteredText);
            // è¼¸å…¥ï¼š179 å­—ç¬¦
            // è¼¸å‡ºï¼šJSON çµæ§‹åŒ–æ•¸æ“š
            // è€—æ™‚ï¼š~5 ç§’ï¼ˆç¬¬ 1 æ¬¡å˜—è©¦ï¼‰
            // æˆæœ¬ï¼š~$0.0003
            break; // æˆåŠŸå‰‡è·³å‡ºé‡è©¦
        } catch (error) {
            // å¤±æ•—å‰‡é‡è©¦ï¼ˆç­‰å¾… 2 ç§’ â†’ 4 ç§’ï¼‰
        }
    }
    
    allResults.push(result);
}
```

**æ¯é è€—æ™‚ï¼š** ~7 ç§’ï¼ˆ2ç§’ OCR + 5ç§’ DeepSeekï¼‰  
**ç¸½è€—æ™‚ï¼š** ~21 ç§’ï¼ˆ3 é ï¼‰  
**API èª¿ç”¨ï¼š** 3 æ¬¡ Vision API + 3 æ¬¡ DeepSeek API

---

### éšæ®µ 3ï¼šçµæœåˆä½µ

**åŸ·è¡Œä½ç½®ï¼š** `firstproject.html` â†’ `mergeMultiPageResults()`

```javascript
// æ ¹æ“šæ–‡æª”é¡å‹é¸æ“‡åˆä½µç­–ç•¥
if (documentType === 'bank_statement') {
    return mergeBankStatementPages(allResults);
}

function mergeBankStatementPages(pageResults) {
    // 1. æå–ç¬¬ 1 é çš„è³¬æˆ¶ä¿¡æ¯
    const accountInfo = {
        bankName: pageResults[0].bankName,
        accountNumber: pageResults[0].accountNumber,
        statementDate: pageResults[0].statementDate
    };
    
    // 2. åˆä½µæ‰€æœ‰é çš„äº¤æ˜“è¨˜éŒ„
    const allTransactions = [];
    pageResults.forEach(page => {
        if (page.transactions) {
            allTransactions.push(...page.transactions);
        }
    });
    
    // 3. æå–æœ€å¾Œä¸€é çš„æœŸæœ«é¤˜é¡
    const closingBalance = pageResults[pageResults.length - 1].closingBalance;
    
    return {
        ...accountInfo,
        transactions: allTransactions,
        closingBalance: closingBalance
    };
}
```

**è€—æ™‚ï¼š** <0.1 ç§’  
**API èª¿ç”¨ï¼š** 0

---

## ğŸ“Š ç¸½é«”æ€§èƒ½åˆ†æ

### è™•ç† 3 é éŠ€è¡Œå°å¸³å–®

| éšæ®µ | æ“ä½œ | è€—æ™‚ | API èª¿ç”¨ | æˆæœ¬ |
|-----|------|------|---------|------|
| **1. PDF è½‰æ›** | PDF â†’ 3 å¼µåœ– | 1 ç§’ | 0 | å…è²» |
| **2. ä¸Šå‚³ Storage** | ä¸Šå‚³ 3 å¼µåœ– | 2 ç§’ | 3 æ¬¡ | å…è²» |
| **3. å‰µå»ºæ–‡æª”** | Firestore å¯«å…¥ | 0.5 ç§’ | 1 æ¬¡ | å…è²» |
| **4. OCRï¼ˆç¬¬ 1 é ï¼‰** | Vision API | 2 ç§’ | 1 æ¬¡ | å…è²» |
| **5. éæ¿¾ï¼ˆç¬¬ 1 é ï¼‰** | æœ¬åœ°è™•ç† | 0.1 ç§’ | 0 | å…è²» |
| **6. DeepSeekï¼ˆç¬¬ 1 é ï¼‰** | API èª¿ç”¨ | 5 ç§’ | 1 æ¬¡ | $0.0003 |
| **7. OCRï¼ˆç¬¬ 2 é ï¼‰** | Vision API | 2 ç§’ | 1 æ¬¡ | å…è²» |
| **8. éæ¿¾ï¼ˆç¬¬ 2 é ï¼‰** | æœ¬åœ°è™•ç† | 0.1 ç§’ | 0 | å…è²» |
| **9. DeepSeekï¼ˆç¬¬ 2 é ï¼‰** | API èª¿ç”¨ | 5 ç§’ | 1 æ¬¡ | $0.0003 |
| **10. OCRï¼ˆç¬¬ 3 é ï¼‰** | Vision API | 2 ç§’ | 1 æ¬¡ | å…è²» |
| **11. éæ¿¾ï¼ˆç¬¬ 3 é ï¼‰** | æœ¬åœ°è™•ç† | 0.1 ç§’ | 0 | å…è²» |
| **12. DeepSeekï¼ˆç¬¬ 3 é ï¼‰** | API èª¿ç”¨ | 5 ç§’ | 1 æ¬¡ | $0.0003 |
| **13. åˆä½µçµæœ** | æœ¬åœ°è™•ç† | 0.1 ç§’ | 0 | å…è²» |
| **14. æ›´æ–°ç‹€æ…‹** | Firestore å¯«å…¥ | 0.5 ç§’ | 1 æ¬¡ | å…è²» |
| **ç¸½è¨ˆ** | | **25.4 ç§’** | **11 æ¬¡** | **$0.0009** |

---

## âš ï¸ ç™¼ç¾çš„å•é¡Œ

### å•é¡Œ 1ï¼šé‡è¤‡çš„ API èª¿ç”¨ âŒ
**ç¾è±¡ï¼š** åœ– 3-5 ä¸­çœ‹åˆ°å¤šæ¬¡ã€Œéšæ®µ 1ã€ã€ã€Œéšæ®µ 2ã€ã€ã€Œéšæ®µ 3ã€

**åŸå› ï¼š** æ¯ä¸€é éƒ½ç¨ç«‹åŸ·è¡Œå®Œæ•´çš„è™•ç†æµç¨‹

```
ç¬¬ 1 é ï¼šéšæ®µ 1 â†’ éšæ®µ 2 â†’ éšæ®µ 3 â†’ DeepSeek
ç¬¬ 2 é ï¼šéšæ®µ 1 â†’ éšæ®µ 2 â†’ éšæ®µ 3 â†’ DeepSeek â† é‡è¤‡ï¼
ç¬¬ 3 é ï¼šéšæ®µ 1 â†’ éšæ®µ 2 â†’ éšæ®µ 3 â†’ DeepSeek â† é‡è¤‡ï¼
```

### å•é¡Œ 2ï¼šDeepSeek è¶…æ™‚é‡è©¦ âŒ
**ç¾è±¡ï¼š** åœ– 5 ä¸­çœ‹åˆ° `signal is aborted without reason`

**åŸå› ï¼š** å³ä½¿éæ¿¾å¾Œï¼ŒDeepSeek ä»ç„¶å¯èƒ½è¶…æ™‚

### å•é¡Œ 3ï¼šéåº¦è™•ç† âŒ
**å•é¡Œï¼š** å°æ–¼éŠ€è¡Œå°å¸³å–®ï¼Œæˆ‘å€‘æ˜¯å¦éœ€è¦è™•ç†**æ‰€æœ‰ 3 é **ï¼Ÿ

**åˆ†æï¼š**
- ç¬¬ 1 é ï¼šè³¬æˆ¶ä¿¡æ¯ + éƒ¨åˆ†äº¤æ˜“ âœ… **å¿…é ˆè™•ç†**
- ç¬¬ 2 é ï¼šäº¤æ˜“è¨˜éŒ„ âš ï¸ **å¯èƒ½ä¸éœ€è¦**
- ç¬¬ 3 é ï¼šæœ€å¾Œå¹¾ç­†äº¤æ˜“ + æœŸæœ«é¤˜é¡ âœ… **å¿…é ˆè™•ç†**

---

## ğŸ’¡ å„ªåŒ–å»ºè­°

### æ–¹æ¡ˆ 1ï¼šæ™ºèƒ½é é¢é¸æ“‡ï¼ˆæ¨è–¦ï¼‰â­

**æ ¸å¿ƒæ€è·¯ï¼š** åªè™•ç†é—œéµé é¢

```javascript
function selectKeyPages(totalPages) {
    if (totalPages === 1) {
        return [0];  // è™•ç†ç¬¬ 1 é 
    } else if (totalPages === 2) {
        return [0, 1];  // è™•ç†ç¬¬ 1ã€2 é 
    } else if (totalPages >= 3) {
        return [0, totalPages - 1];  // åªè™•ç†ç¬¬ 1 é å’Œæœ€å¾Œ 1 é 
    }
}

// è™•ç† 3 é  PDF
const keyPages = selectKeyPages(3);  // [0, 2]
// åªè™•ç†ç¬¬ 1 é å’Œç¬¬ 3 é 
// è·³éç¬¬ 2 é ï¼ˆä¸­é–“çš„äº¤æ˜“è¨˜éŒ„ï¼‰
```

**å„ªå‹¢ï¼š**
- âœ… æ¸›å°‘ 33% çš„ API èª¿ç”¨ï¼ˆ3 é  â†’ 2 é ï¼‰
- âœ… æ¸›å°‘ 33% çš„è™•ç†æ™‚é–“ï¼ˆ25 ç§’ â†’ 17 ç§’ï¼‰
- âœ… æ¸›å°‘ 33% çš„æˆæœ¬ï¼ˆ$0.0009 â†’ $0.0006ï¼‰
- âœ… ä»ç„¶èƒ½æå–åˆ°æ‰€æœ‰é—œéµä¿¡æ¯

**åŠ£å‹¢ï¼š**
- âš ï¸ ä¸­é–“é é¢çš„äº¤æ˜“è¨˜éŒ„æœƒéºæ¼

---

### æ–¹æ¡ˆ 2ï¼šå–®é å®Œæ•´è™•ç†ï¼ˆæœ€ç°¡å–®ï¼‰â­â­

**æ ¸å¿ƒæ€è·¯ï¼š** åªè™•ç†ç¬¬ 1 é 

```javascript
// åªè™•ç†ç¬¬ 1 é 
const result = await processor.processDocument(files[0], documentType);

// å¾ç¬¬ 1 é æå–æ‰€æœ‰ä¿¡æ¯
const data = {
    bankName: result.bankName,
    accountNumber: result.accountNumber,
    statementDate: result.statementDate,
    closingBalance: result.closingBalance,  // å¾æ‘˜è¦è¡¨æ ¼æå–
    transactions: result.transactions  // åªæå–ç¬¬ 1 é çš„äº¤æ˜“
};
```

**å„ªå‹¢ï¼š**
- âœ… æ¸›å°‘ 67% çš„ API èª¿ç”¨ï¼ˆ3 é  â†’ 1 é ï¼‰
- âœ… æ¸›å°‘ 67% çš„è™•ç†æ™‚é–“ï¼ˆ25 ç§’ â†’ 8 ç§’ï¼‰
- âœ… æ¸›å°‘ 67% çš„æˆæœ¬ï¼ˆ$0.0009 â†’ $0.0003ï¼‰
- âœ… é‚è¼¯æœ€ç°¡å–®

**åŠ£å‹¢ï¼š**
- âŒ åªèƒ½æå–ç¬¬ 1 é çš„äº¤æ˜“è¨˜éŒ„
- âŒ æœŸæœ«é¤˜é¡å¯èƒ½ä¸æº–ç¢ºï¼ˆé™¤éç¬¬ 1 é æœ‰æ‘˜è¦ï¼‰

---

### æ–¹æ¡ˆ 3ï¼šæ‰¹é‡ OCR + å–®æ¬¡ DeepSeekï¼ˆæœ€é«˜æ•ˆï¼‰â­â­â­

**æ ¸å¿ƒæ€è·¯ï¼š** åˆä½µæ‰€æœ‰é é¢çš„æ–‡æœ¬ï¼ŒDeepSeek åªèª¿ç”¨ 1 æ¬¡

```javascript
// æ­¥é©Ÿ 1ï¼šå°æ‰€æœ‰é é¢åŸ·è¡Œ OCR
const ocrTexts = [];
for (let i = 0; i < files.length; i++) {
    const text = await processor.extractTextWithVision(files[i]);
    const filtered = processor.filterRelevantText(text, documentType);
    ocrTexts.push(filtered);
}

// æ­¥é©Ÿ 2ï¼šåˆä½µæ‰€æœ‰æ–‡æœ¬
const combinedText = ocrTexts.join('\n\n=== ä¸‹ä¸€é  ===\n\n');

// æ­¥é©Ÿ 3ï¼šDeepSeek åªèª¿ç”¨ 1 æ¬¡
const result = await deepseek.analyze(combinedText);
```

**å„ªå‹¢ï¼š**
- âœ… æ¸›å°‘ 67% çš„ DeepSeek èª¿ç”¨ï¼ˆ3 æ¬¡ â†’ 1 æ¬¡ï¼‰
- âœ… æ¸›å°‘ 40% çš„è™•ç†æ™‚é–“ï¼ˆ25 ç§’ â†’ 15 ç§’ï¼‰
- âœ… æ¸›å°‘ 67% çš„ DeepSeek æˆæœ¬ï¼ˆ$0.0009 â†’ $0.0003ï¼‰
- âœ… æå–å®Œæ•´çš„äº¤æ˜“è¨˜éŒ„

**åŠ£å‹¢ï¼š**
- âš ï¸ åˆä½µå¾Œçš„æ–‡æœ¬å¯èƒ½ä»ç„¶å¾ˆé•·
- âš ï¸ DeepSeek éœ€è¦ä¸€æ¬¡è™•ç†æ›´å¤šæ•¸æ“š

---

## ğŸ¯ æ¨è–¦æ–¹æ¡ˆ

### **æ–¹æ¡ˆ 2ï¼ˆå–®é å®Œæ•´è™•ç†ï¼‰+ æ–¹æ¡ˆ 1ï¼ˆæ™ºèƒ½é é¢é¸æ“‡ï¼‰æ··åˆ**

```javascript
function selectKeyPages(totalPages, documentType) {
    if (documentType === 'bank_statement') {
        // éŠ€è¡Œå°å¸³å–®ï¼šåªè™•ç†ç¬¬ 1 é ï¼ˆåŒ…å«è³¬æˆ¶ä¿¡æ¯å’Œæ‘˜è¦ï¼‰
        return [0];
    } else {
        // ç™¼ç¥¨/æ”¶æ“šï¼šè™•ç†æ‰€æœ‰é é¢
        return Array.from({length: totalPages}, (_, i) => i);
    }
}
```

**ç†ç”±ï¼š**
1. **éŠ€è¡Œå°å¸³å–®çš„ç¬¬ 1 é é€šå¸¸åŒ…å«ï¼š**
   - âœ… è³¬æˆ¶ä¿¡æ¯ï¼ˆéŠ€è¡Œåç¨±ã€å¸³è™Ÿï¼‰
   - âœ… æœŸæœ«é¤˜é¡ï¼ˆACCOUNT SUMMARY è¡¨æ ¼ï¼‰
   - âœ… éƒ¨åˆ†äº¤æ˜“è¨˜éŒ„
   - âœ… å°å¸³å–®æ—¥æœŸ

2. **ä¸­é–“é é¢çš„äº¤æ˜“è¨˜éŒ„ä¸æ˜¯å¿…é ˆçš„**
   - ç”¨æˆ¶ä¸»è¦é—œå¿ƒï¼šé¤˜é¡ã€è³¬æˆ¶ä¿¡æ¯
   - å®Œæ•´äº¤æ˜“è¨˜éŒ„å¯ä»¥å¾éŠ€è¡Œä¸‹è¼‰ CSV

3. **å¤§å¹…æå‡æ€§èƒ½**
   - è™•ç†æ™‚é–“ï¼š25 ç§’ â†’ **8 ç§’**ï¼ˆæå‡ 70%ï¼‰
   - API èª¿ç”¨ï¼š11 æ¬¡ â†’ **5 æ¬¡**ï¼ˆæ¸›å°‘ 55%ï¼‰
   - æˆæœ¬ï¼š$0.0009 â†’ **$0.0003**ï¼ˆæ¸›å°‘ 67%ï¼‰

---

## ğŸ“ å»ºè­°çš„æ–°æµç¨‹

```
ç”¨æˆ¶ä¸Šå‚³ PDF (3 é )
    â†“
PDF â†’ åœ–ç‰‡è½‰æ› (3 å¼µåœ–)
    â†“
ä¸Šå‚³åˆ° Storage (3 å€‹ URL)
    â†“
å‰µå»ºæ–‡æª”è¨˜éŒ„
    â†“
æ‰£é™¤ 1 Creditï¼ˆåªè™•ç†ç¬¬ 1 é ï¼‰â† âœ¨ å„ªåŒ–
    â†“
ã€åªè™•ç†ç¬¬ 1 é ã€‘â† âœ¨ å„ªåŒ–
    â†“
ç¬¬ 1 é : Vision OCR â†’ éæ¿¾ â†’ DeepSeek åˆ†æ
    â†“
æå–å®Œæ•´æ•¸æ“šï¼ˆåŒ…å«æ‘˜è¦è¡¨æ ¼ï¼‰
    â†“
æ›´æ–°æ–‡æª”ç‹€æ…‹
```

**å„ªå‹¢ï¼š**
- âœ… ç”¨æˆ¶é«”é©—æ›´å¿«ï¼ˆ8 ç§’ vs 25 ç§’ï¼‰
- âœ… æˆæœ¬æ›´ä½ï¼ˆ1 Credit vs 3 Creditsï¼‰
- âœ… æˆåŠŸç‡æ›´é«˜ï¼ˆåªéœ€ 1 æ¬¡ DeepSeek èª¿ç”¨ï¼‰
- âœ… æ•¸æ“šå®Œæ•´æ€§è¶³å¤ ï¼ˆè³¬æˆ¶ä¿¡æ¯ + é¤˜é¡ï¼‰

---

## ğŸ¤” ç”¨æˆ¶é¸æ“‡

è«‹å‘Šè¨´æˆ‘æ‚¨å¸Œæœ›ä½¿ç”¨å“ªå€‹æ–¹æ¡ˆï¼š

### é¸é … Aï¼šæ–¹æ¡ˆ 2ï¼ˆåªè™•ç†ç¬¬ 1 é ï¼‰â­â­â­ æ¨è–¦
- æœ€å¿«é€Ÿï¼ˆ8 ç§’ï¼‰
- æœ€ä¾¿å®œï¼ˆ1 Creditï¼‰
- æœ€ç°¡å–®
- æ•¸æ“šè¶³å¤ 

### é¸é … Bï¼šæ–¹æ¡ˆ 1ï¼ˆç¬¬ 1 é  + æœ€å¾Œ 1 é ï¼‰
- ä¸­ç­‰é€Ÿåº¦ï¼ˆ17 ç§’ï¼‰
- ä¸­ç­‰æˆæœ¬ï¼ˆ2 Creditsï¼‰
- æ•¸æ“šæ›´å®Œæ•´

### é¸é … Cï¼šä¿æŒç¾æœ‰é‚è¼¯ï¼ˆè™•ç†æ‰€æœ‰ 3 é ï¼‰
- è¼ƒæ…¢ï¼ˆ25 ç§’ï¼‰
- è¼ƒè²´ï¼ˆ3 Creditsï¼‰
- æ•¸æ“šæœ€å®Œæ•´

**æˆ‘å»ºè­°é¸æ“‡æ–¹æ¡ˆ Aï¼ˆåªè™•ç†ç¬¬ 1 é ï¼‰ï¼Œå› ç‚ºéŠ€è¡Œå°å¸³å–®çš„ç¬¬ 1 é é€šå¸¸åŒ…å«æ‰€æœ‰é—œéµä¿¡æ¯ã€‚**

