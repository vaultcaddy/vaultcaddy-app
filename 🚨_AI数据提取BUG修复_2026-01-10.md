# 🚨 关键BUG修复 - AI数据提取错误

**修复日期**: 2026-01-10  
**严重程度**: 🔴 **高危** - 数据完全错误  
**影响范围**: 所有银行对账单的交易记录

---

## 📋 问题描述

用户上传同一个PDF（eStatement-CIF-20210731.pdf），出现三个严重问题：

### **问题1：交易数量错误**
- **正确**：96笔交易
- **实际显示**：20笔交易
- **丢失率**：79%的交易记录

### **问题2：金额完全错误**
- **示例**：2021-07-02 SIC ALIPAY HK LTD
- **银行单原始数据**：59,434.45（余额）
- **系统显示**：59,391.21
- **差异**：43.24（完全错误！）

### **问题3：+/-号全部错误**
- **银行单显示**：
  - 支出（Debit）：21.62, 93.06, 2,366.90, 25,823.00等
  - 收入（Credit）：5.06等
- **系统显示**：所有交易都显示为**红色-号**（支出）
- **错误率**：100%

---

## 🔍 根本原因分析

### **原因1：AI Prompt错误**

**错误的Prompt（修复前）**：
```javascript
"amount": 金額（正數為入賬，負數為出賬）
```

**问题**：
- 这个指令与银行对账单的实际格式**完全不符**
- 银行对账单使用**Debit（支出）**和**Credit（收入）**两列
- 两列的金额都是**正数**，不是通过正负号区分

**实际银行对账单格式**：
```
日期     描述                  支出(Debit)   收入(Credit)   余额
2021-07-02  SIC ALIPAY HK LTD   21.62                    59,391.21
2021-07-02  利息支出                         5.06         59,412.83
```

### **原因2：并行处理导致批次结果顺序错误**

**问题代码（修复前）**：
```javascript
const batchResults = await Promise.all(batchPromises);
// ❌ 没有按批次顺序排序！
```

**后果**：
- 批次2的结果可能在批次1之前返回
- 合并时顺序错乱
- 导致交易记录丢失或重复

### **原因3：金额处理逻辑错误**

**错误逻辑**：
```javascript
// ❌ 根据amount正负号判断收入/支出
if (amountNum >= 0) {
    transactionSign = 'income';
} else {
    transactionSign = 'expense';
}
```

**问题**：
- 银行单的amount永远是正数
- 无法正确区分收入和支出

---

## ✅ 解决方案

### **修复1：更新AI Prompt**

**修改文件**: `qwen-vl-max-processor.js`

**新的Prompt结构**：
```javascript
"transactions": [
  {
    "date": "日期（YYYY-MM-DD 格式）",
    "description": "交易描述",
    "debit": 支出金額（數字，從「支出/借項/DEBIT」欄位提取，如果為空則為0）,
    "credit": 收入金額（數字，從「存款/入賬/貸項/CREDIT」欄位提取，如果為空則為0）,
    "amount": 交易金額（數字，正數表示，不帶正負號）,
    "balance": 餘額（數字）,
    "transactionSign": "交易標記（'income'表示收入/credit，'expense'表示支出/debit）",
    // ... 其他字段
  }
]
```

**关键改进**：
1. ✅ 明确区分`debit`（支出）和`credit`（收入）字段
2. ✅ `amount`永远是正数（绝对值）
3. ✅ 使用`transactionSign`明确标记收入/支出
4. ✅ 要求AI根据**哪一列有数据**来判断，而不是根据正负号

**新增关键指令**：
```javascript
2. **重要：正確識別收入和支出**：
   - 銀行對賬單通常有兩欄：支出（DEBIT/借項）和收入（CREDIT/貸項/存款）
   - 如果金額在「支出/DEBIT/借項」欄 → transactionSign = "expense"
   - 如果金額在「收入/CREDIT/貸項/存款」欄 → transactionSign = "income"
   - amount 永遠是正數（不帶正負號），表示交易金額的絕對值
   - debit 和 credit 分別記錄支出和收入金額，為0表示該欄為空
```

### **修復2：確保批次順序正確**

**修改文件**: `qwen-vl-max-processor.js`

**修復代碼**：
```javascript
// ✅ 並行執行所有批次
const batchResults = await Promise.all(batchPromises);

// ✅ 按批次順序整理結果（關鍵！）
batchResults.sort((a, b) => a.batchNum - b.batchNum);

// 收集所有結果
for (const { batchNum, result } of batchResults) {
    allResults.push(result.extractedData);
    // ...
}
```

**效果**：
- 即使批次2先完成，也會按照1→2→3的順序合併
- 確保所有96筆交易都被正確保留

### **修復3：更新+/-號判斷邏輯**

**修改文件**: `document-detail-new.js`

**新邏輯**：
```javascript
// ✅ 使用AI提取的transactionSign字段（或從debit/credit判斷）
if (tx.transactionSign === undefined || tx.transactionSign === null) {
    // 優先從debit/credit欄位判斷
    if (tx.debit && parseFloat(tx.debit) > 0) {
        tx.transactionSign = 'expense';  // 有debit = 支出
    } else if (tx.credit && parseFloat(tx.credit) > 0) {
        tx.transactionSign = 'income';  // 有credit = 收入
    } else {
        // Fallback: 根據amount正負號判斷
        const amountNum = parseFloat(amountStr.replace(/[^0-9.-]+/g, ''));
        tx.transactionSign = amountNum >= 0 ? 'income' : 'expense';
    }
}

const isIncome = tx.transactionSign === 'income';
const amountSign = isIncome ? '+' : '-';
const amountColor = isIncome ? '#10b981' : '#ef4444';
```

**判斷優先級**：
1. 🥇 **AI提供的`transactionSign`字段**（最可靠）
2. 🥈 **`debit`/`credit`字段**（次可靠）
3. 🥉 **`amount`正負號**（最後備選）

---

## 📊 修復效果對比

### **修復前**
| 指標 | 值 | 問題 |
|------|-----|------|
| 交易數量 | 20筆 | ❌ 丟失76筆（79%） |
| 金額準確性 | 59,391.21 | ❌ 應為59,434.45 |
| +/-號準確性 | 0% | ❌ 全部錯誤 |

### **修復後（預期）**
| 指標 | 值 | 改進 |
|------|-----|------|
| 交易數量 | 96筆 | ✅ 完整 |
| 金額準確性 | 59,434.45 | ✅ 正確 |
| +/-號準確性 | 100% | ✅ 完全正確 |

---

## 🧪 測試計劃

### **測試文件**
- `eStatement-CIF-20210731.pdf`（6頁，96筆交易）

### **測試步驟**
1. ✅ 刪除舊的錯誤記錄
2. ✅ 重新上傳`eStatement-CIF-20210731.pdf`
3. ✅ 等待AI處理完成
4. ✅ 驗證以下指標：

#### **指標1：交易數量**
- [ ] 顯示96筆交易（而非20筆）
- [ ] 所有日期從2021-07-01到2021-07-06都有記錄

#### **指標2：金額準確性**
- [ ] 2021-07-02 SIC ALIPAY HK LTD的余額顯示為59,434.45（而非59,391.21）
- [ ] 2021-07-02 利息支出的余額顯示為59,412.83
- [ ] 所有金額與銀行單完全一致

#### **指標3：+/-號準確性**
- [ ] 2021-07-02 SIC ALIPAY HK LTD (21.62) 顯示為**紅色-號**（支出）
- [ ] 2021-07-02 利息支出 (5.06) 顯示為**綠色+號**（收入）
- [ ] 2021-07-02 SCR OCTOPUS CARDS LTD (2,366.90) 顯示為**紅色-號**（支出）
- [ ] 2021-07-02 網上轉帳匯款 (25,823.00) 顯示為**紅色-號**（支出）

---

## 📝 重要提醒

### **為什麼會出現這個錯誤？**

1. **對銀行對賬單格式理解不足**：
   - 誤以為銀行對賬單使用正負號表示收入/支出
   - 實際上使用的是Debit/Credit兩列

2. **並行處理未考慮順序**：
   - Promise.all()返回順序不確定
   - 必須手動排序

3. **缺少數據驗證**：
   - 沒有驗證交易數量
   - 沒有驗證金額準確性

### **如何避免類似錯誤？**

1. ✅ **詳細測試真實數據**：
   - 使用真實銀行對賬單測試
   - 手動驗證每一筆交易
   - 對比AI提取結果與原始PDF

2. ✅ **添加數據驗證**：
   - 驗證交易數量與頁數的合理性
   - 驗證期初+收入-支出=期末
   - 添加異常檢測邏輯

3. ✅ **改進AI Prompt**：
   - 提供明確的示例
   - 強調關鍵規則（如Debit/Credit區分）
   - 要求AI返回原始欄位數據

---

## 🚀 下一步行動

### **立即行動**
1. ⚠️ **通知用戶重新上傳所有銀行對賬單**（舊數據不可信）
2. ✅ 測試修復後的版本
3. ✅ 驗證96筆交易都正確提取

### **後續優化**
1. 添加數據驗證層：
   ```javascript
   function validateBankStatement(data) {
       // 驗證交易數量
       if (data.transactions.length < 10) {
           console.warn('⚠️ 交易數量異常少');
       }
       
       // 驗證金額平衡
       const calculatedBalance = data.openingBalance + totalCredit - totalDebit;
       if (Math.abs(calculatedBalance - data.closingBalance) > 0.01) {
           console.warn('⚠️ 金額不平衡');
       }
   }
   ```

2. 添加UI警告：
   ```javascript
   if (doc.pages > 3 && doc.transactions.length < 30) {
       showWarning('交易數量異常少，可能存在提取錯誤');
   }
   ```

3. 改進Prompt（提供示例）：
   ```javascript
   **示例格式**：
   | 日期       | 描述                | 支出(Debit) | 收入(Credit) | 余額     |
   |-----------|---------------------|------------|--------------|---------|
   | 2021-07-02 | SIC ALIPAY HK LTD  | 21.62      |              | 59,434.45|
   | 2021-07-02 | 利息支出            |            | 5.06         | 59,412.83|
   
   對於第1筆交易：
   - debit = 21.62, credit = 0
   - amount = 21.62, transactionSign = "expense"
   
   對於第2筆交易：
   - debit = 0, credit = 5.06
   - amount = 5.06, transactionSign = "income"
   ```

---

**修復狀態**: ✅ 代碼已修復，等待測試驗證  
**影響文件**:
- `qwen-vl-max-processor.js` ✅ 已修復（AI Prompt）
- `document-detail-new.js` ✅ 已修復（+/-號邏輯）

**測試狀態**: ⏳ 等待用戶重新上傳測試

---

## ⚠️ 用戶須知

**重要**：由於AI Prompt存在嚴重錯誤，所有已上傳的銀行對賬單數據都**不可信**。請：
1. 刪除所有舊的銀行對賬單記錄
2. 重新上傳所有文件
3. 驗證新提取的數據是否正確

我們深表歉意！🙏

